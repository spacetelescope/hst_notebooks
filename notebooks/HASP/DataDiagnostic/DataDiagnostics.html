

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>HASP Data Diagnostic Notebook &#8212; HST Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/table.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/HASP/DataDiagnostic/DataDiagnostics';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Wavelength Adjustments for Running the Hubble Advanced Spectral Products (HASP) Script" href="../WavelengthAdjustment/WavelengthAdjustment.html" />
    <link rel="prev" title="Scaling Flux while using the Hubble Advanced Spectral Products Script" href="../FluxScaleTutorial/FluxScaleTutorial.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="HST Notebooks - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="HST Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../index.html">
                    STScI HST Notebook Repository HQ
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">ACS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../ACS/README.html">ACS Notebooks</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_findsat_mrt/acs_findsat_mrt_example.html">Satellite trail detection in ACS/WFC data using acstools.findsat_mrt</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_saturation_trails/acs_saturation_trails.html">ACS Linearity with Saturated Stars</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_cte_forward_model/acs_cte_forward_model_example.html">Pixel-based ACS/WFC CTE Forward Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_subarrays/acs_subarrays.html">ACS Image Reduction for Subarray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_sbc_dark_analysis/acs_sbc_dark_analysis.html">SBC Dark Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_reduction/acs_reduction.html">ACS/WFC Image Reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_pixel_area_maps/acs_pixel_area_maps.html">Obtaining Pixel Area Maps for ACS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_polarization_tools/acs_polarization_tools.html">Using ACS Polarization Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_focus_diverse_epsfs/acs_focus_diverse_epsfs.html">Focus Diverse ePSFs for ACS/WFC</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">COS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../COS/README.html">COS Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../COS/Setup/Setup.html">Setting up your computer environment for working with COS data</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/DataDl/DataDl.html">Downloading COS Data</a></li>




<li class="toctree-l1"><a class="reference internal" href="../../COS/ViewData/ViewData.html">Viewing COS Data</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/AsnFile/AsnFile.html">Modifying or Creating an Association File</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/CalCOS/CalCOS.html">Running the COS Data Pipeline (<code class="docutils literal notranslate"><span class="pre">CalCOS</span></code>)</a></li>






<li class="toctree-l1"><a class="reference internal" href="../../COS/SplitTag/SplitTag.html">Splitting COS Exposures into sub-exposures with <code class="docutils literal notranslate"><span class="pre">splittag</span></code></a></li>







<li class="toctree-l1"><a class="reference internal" href="../../COS/DayNight/DayNight.html">Filtering out COS Data taken during the Day or Night</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../COS/LSF/LSF.html">Working with the COS Line Spread Function (LSF)</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../COS/Extract/Extract.html">Editing the extraction boxes in a spectral extraction file (<code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>)</a></li>







<li class="toctree-l1"><a class="reference internal" href="../../COS/ExceptionReport/ExceptionReport.html">What to do when you get an Exception Report for COS</a></li>







</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">DrizzlePac</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/README.html">DrizzlePac Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/using_updated_astrometry_solutions/using_updated_astrometry_solutions.html">Improving Astrometry Using Alternate WCS Solutions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_to_catalogs/align_to_catalogs.html">Aligning HST images to an Absolute Reference Catalog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_sparse_fields/align_sparse_fields.html">Aligning Deep Exposures of Sparse Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_multiple_visits/align_multiple_visits.html">Optimizing Image Alignment for Multiple HST Visits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/use_ds9_regions_in_tweakreg/use_ds9_regions_in_tweakreg.html">TWEAKREG Tips - Using DS9 Regions for Source Inclusion/Exclusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/optimize_image_sampling/optimize_image_sampling.html">Optimizing the Image Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_mosaics/align_mosaics.html">Aligning HST Mosaics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/sky_matching/sky_matching.html">Sky Matching for HST Mosaics <a id="top"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/mask_satellite/mask_satellite.html">Satellite Trail Masking Techniques</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">HASP</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Setup/Setup.html">Installing the Hubble Advanced Spectral Products Script</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CoaddTutorial/CoaddTutorial.html">Inputting User Data using the Hubble Advanced Spectral Products Script</a></li>

<li class="toctree-l1"><a class="reference internal" href="../FluxScaleTutorial/FluxScaleTutorial.html">Scaling Flux while using the Hubble Advanced Spectral Products Script</a></li>

<li class="toctree-l1 current active"><a class="current reference internal" href="#">HASP Data Diagnostic Notebook</a></li>




<li class="toctree-l1"><a class="reference internal" href="../WavelengthAdjustment/WavelengthAdjustment.html">Wavelength Adjustments for Running the Hubble Advanced Spectral Products (HASP) Script</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NICMOS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NICMOS/nicmos_unit_conversion/nicmos_unit_conversion.html">Programmatic Replacements for NICMOS Units Conversion Form</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">STIS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../STIS/README.html">STIS-Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/cross-correlation/cross-correlation.html">Correcting for Missing Wavecals with Cross-Correlation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/custom_ccd_darks/custom_ccd_darks.html">Custom CCD Darks <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/drizpac_notebook/STIS_DrizzlePac_Tutorial.html">STIS DrizzlePac Tutorial <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/CoronagraphyViz/STIS_Coronagraphy_Visualization_v2.html">STIS Coronagraphy Visualization Tool (v2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/calstis/calstis_2d_ccd.html">Calstis 2-D CCD Data Reduction <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/target_acquisition/target_acquisition.html">Evaluating STIS Target Acquisitions <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/view_data/view_data.html">Viewing STIS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/extraction/1D_Extraction.html">1D Spectra Extraction <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/low_count_uncertainties/Low_Count_Uncertainties.html">Low Count Uncertainties in STIS <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/contrast_sensitivity/STIS_Coronagraphic_Observation_Feasibility.html">STIS Coronagraphic Observation Feasibility</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">WFC3</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/README.html">WFC3 Notebooks</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../WFC3/general_tools.html">General Tools</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/image_displayer_analyzer/wfc3_image_displayer_analyzer.html">WFC3 Image Displayer &amp; Analyzer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/exception_report/wfc3_exception_report.html">Exception Report Checklist - WFC3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/calwf3_v1.0_cte/calwf3_with_v1.0_PCTE.html">Processing WFC3/UVIS Data with <code class="docutils literal notranslate"><span class="pre">calwf3</span></code> Using the v1.0 CTE-Correction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/persistence/wfc3_ir_persistence.html">Masking Persistence in WFC3/IR Images</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../WFC3/ir_tvb.html">WFC3/IR Time Variable Background (TVB)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/ir_ima_visualization/IR_IMA_Visualization_with_an_Example_of_Time_Variable_Background.html">WFC3/IR IMA Visualization Tools with An Example of Time Variable Background</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/calwf3_recalibration/calwf3_recal_tvb.html">Manual Recalibration with calwf3: Turning off the IR Linear Ramp Fit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/tvb_flattenramp/TVB_flattenramp_notebook.html">Correcting for Helium Line Emission Background in IR Exposures using the “Flatten-Ramp” Technique</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/ir_scattered_light_calwf3_corrections/Correcting_for_Scattered_Light_in_IR_Exposures_Using_calwf3_to_Mask_Bad_Reads.html">Correcting for Scattered Light in WFC3/IR Exposures: Using <code class="docutils literal notranslate"><span class="pre">calwf3</span></code> to Mask Bad Reads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/ir_scattered_light_manual_corrections/Correcting_for_Scattered_Light_in_IR_Exposures_by_Manually_Subtracting_Bad_Reads.html">Correcting for Scattered Light in WFC3/IR Exposures: Manually Subtracting Bad Reads</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../WFC3/photometry.html">Photometry</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/filter_transformations/filter_transformations.html">WFC3/UVIS Filter Transformations with stsynphot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/flux_conversion_tool/flux_conversion_tool.html">Flux Unit Conversions with synphot and stsynphot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/photometry_examples/phot_examples.html">Synthetic Photometry Examples for WFC3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/uvis_time_dependent_photometry/uvis_timedep_phot.html">WFC3/UVIS Time-dependent Photometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/zeropoints/zeropoints.html">Calculating WFC3 Zeropoints with STSynphot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/uvis_pam_corrections/WFC3_UVIS_Pixel_Area_Map_Corrections_for_Subarrays.html">WFC3/UVIS Pixel Area Map Corrections for Subarrays</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../WFC3/point_spread_function.html">Point Spread Function (PSF)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/point_spread_function/hst_point_spread_function.html">HST WFC3 Point Spread Function Modeling   </a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/mast_api_psf/download_psf_cutouts.html">Downloading WFC3 and WFPC2 PSF Cutouts from MAST</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/spacetelescope/hst_notebooks/blob/main/notebooks/HASP/DataDiagnostic/DataDiagnostics.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/hst_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/hst_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/HASP/DataDiagnostic/DataDiagnostics.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/HASP/DataDiagnostic/DataDiagnostics.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>HASP Data Diagnostic Notebook</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">HASP Data Diagnostic Notebook</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#this-notebook-will-walk-you-through-how-to-examine-the-input-spectra-for-the-hasp-coadd-code-and-determine-what-was-and-was-not-included-in-the-co-added-data-product-output">This notebook will walk you through how to examine the input spectra for the HASP <code class="docutils literal notranslate"><span class="pre">coadd</span></code> code and determine what was and was not included in the co-added data product output.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">0. Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1-two-cos-datasets-rejected-for-different-reasons">Example 1: Two COS datasets rejected for different reasons</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#obtaining-data-products">1.1 Obtaining Data Products</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#examining-output-logs-and-headers">1.2 Examining Output Logs and Headers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-constituent-and-co-added-spectra">1.3 Plotting Constituent and Co-added Spectra</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#re-running-coadd">1.4 Re-running <code class="docutils literal notranslate"><span class="pre">coadd</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#replot-the-co-added-data">Replot the co-added data</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2-a-stis-dataset-with-postarg-offsets">Example 2: A STIS dataset with POSTARG offsets</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">2.1 Obtaining Data Products</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">2.2 Examining Output Logs and Headers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-coadd">2.3 Running <code class="docutils literal notranslate"><span class="pre">coadd</span></code></a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#example-3-a-stis-dataset-with-flux-rejection">Example 3: A STIS dataset with flux rejection</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">3.1 Obtaining Data Products</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#examining-output-logs">3.2 Examining Output Logs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">3.3 Running <code class="docutils literal notranslate"><span class="pre">coadd</span></code></a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#happy-co-adding">Happy co-adding!</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#there-are-more-tutorial-notebooks-for-custom-co-addition-cases-in-this-repo-check-them-out">There are more tutorial notebooks for custom co-addition cases in this repo, check them out!</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#citations">Citations</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="hasp-data-diagnostic-notebook">
<h1>HASP Data Diagnostic Notebook<a class="headerlink" href="#hasp-data-diagnostic-notebook" title="Permalink to this heading">#</a></h1>
<hr class="docutils" />
<section id="this-notebook-will-walk-you-through-how-to-examine-the-input-spectra-for-the-hasp-coadd-code-and-determine-what-was-and-was-not-included-in-the-co-added-data-product-output">
<h2>This notebook will walk you through how to examine the input spectra for the HASP <code class="docutils literal notranslate"><span class="pre">coadd</span></code> code and determine what was and was not included in the co-added data product output.<a class="headerlink" href="#this-notebook-will-walk-you-through-how-to-examine-the-input-spectra-for-the-hasp-coadd-code-and-determine-what-was-and-was-not-included-in-the-co-added-data-product-output" title="Permalink to this heading">#</a></h2>
</section>
<section id="learning-goals">
<h2>Learning Goals<a class="headerlink" href="#learning-goals" title="Permalink to this heading">#</a></h2>
<p>By the end of this tutorial, you will:</p>
<ul class="simple">
<li><p>Understand the reasons an input spectrum may be rejected from a co-added data product</p></li>
<li><p>Learn how to examine output logs from <code class="docutils literal notranslate"><span class="pre">coadd</span></code> and header keywords from COS and STIS data products to determine which datasets were rejected</p></li>
<li><p>Know how to plot co-added spectra and the constituent datasets</p></li>
<li><p>Be able to re-run <code class="docutils literal notranslate"><span class="pre">coadd</span></code> with the default rejection criteria turned off to create custom co-additions</p></li>
</ul>
</section>
<section id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Permalink to this heading">#</a></h2>
<p><strong>0. <span class="xref myst">Introduction</span></strong></p>
<p><strong>1. <span class="xref myst">Example 1: Two COS datasets rejected for different reasons</span></strong></p>
<p>- 1.1 <span class="xref myst">Obtaining Data Products</span></p>
<p>- 1.2 <span class="xref myst">Examining Output Logs</span></p>
<p>- 1.3 <span class="xref myst">Plotting Constituent Spectra</span></p>
<p>- 1.4 <span class="xref myst">Running <code class="docutils literal notranslate"><span class="pre">coadd</span></code></span></p>
<p><strong>2. <span class="xref myst">Example 2: A STIS dataset with <code class="docutils literal notranslate"><span class="pre">POSTARG</span></code> offsets</span></strong></p>
<p>- 2.1 <span class="xref myst">Obtaining Data Products</span></p>
<p>- 2.2 <span class="xref myst">Examining Output Logs</span></p>
<p>- 2.3 <span class="xref myst">Running <code class="docutils literal notranslate"><span class="pre">coadd</span></code></span></p>
<p><strong>3. <span class="xref myst">Example 3: A STIS dataset with rejected flux</span></strong></p>
<p>- 3.1 <span class="xref myst">Obtaining Data Products</span></p>
<p>- 3.2 <span class="xref myst">Examining Output Logs</span></p>
<p>- 3.3 <span class="xref myst">Running <code class="docutils literal notranslate"><span class="pre">coadd</span></code></span></p>
<p><a id = introduction></a></p>
</section>
<section id="introduction">
<h2>0. Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p>The <a class="reference external" href="https://github.com/spacetelescope/hasp">Hubble Advanced Spectral Products (HASP) <code class="docutils literal notranslate"><span class="pre">coadd</span></code> code</a> is a script that co-adds spectra of the same target within a program. This software is able to co-add data taken with the spectrographs onboard the <a class="reference external" href="https://www.stsci.edu/hst">Hubble Space Telescope (HST)</a>; the <a class="reference external" href="https://www.stsci.edu/hst/instrumentation/stis">Space Telescope Imaging Spectrograph (STIS)</a> and the <a class="reference external" href="https://www.stsci.edu/hst/instrumentation/cos">Cosmic Origins Spectrograph (COS)</a>. The <a class="reference external" href="https://archive.stsci.edu/missions-and-data/hst/hasp">Hubble Spectroscopic Legacy Archive (HSLA)</a> uses this script to co-add these instruments’ data from <a class="reference external" href="https://archive.stsci.edu/">The Mikulski Archive for Space Telescopes (MAST)</a> to create high-quality spectra with a broad wavelength coverage (whenever possible from the ultraviolet to the near-infrared) that is publicly available for the scientific community. The script first co-adds the observations for each grating for a given visit, then it combines all gratings for the observation set. Finally, it co-adds the spectra of each observation set in the program to produce a fully co-added spectra for each target in a program. <a class="reference external" href="https://www.stsci.edu/files/live/sites/www/files/home/hst/instrumentation/cos/documentation/instrument-science-reports-isrs/_documents/ISR2024-01.pdf">Check out the COS 2024-1 ISR for more information about the HASP script and products</a>.</p>
<p>The data fed into the <code class="docutils literal notranslate"><span class="pre">coadd</span></code> code from each program are selected via a MAST archive search query. This query performs some filtering at the same time and rejects certain bad quality datasets. Then, the <code class="docutils literal notranslate"><span class="pre">coadd</span></code> script itself performs another series of checks on the input spectra before computing the co-added data products. Lastly, while <code class="docutils literal notranslate"><span class="pre">coadd</span></code> is running, it will check the flux of the input data in each wavelength bin for a given mode against an initial coadd that includes all input data. If the median flux of an input spectrum is lower than a given threshold against the co-add, it will be removed. <code class="docutils literal notranslate"><span class="pre">coadd</span></code> will iterate until no more spectra are rejected.</p>
<p>There are several different reasons an exposure could be rejected before the co-addition is running. These fall into three categories. First, the data in a given program may have quality issues that lead to its removal. Second, there are some observation configurations that <code class="docutils literal notranslate"><span class="pre">coadd</span></code> is not equipped to handle. Last, the target itself may pose an issue, such as for moving targets, or the target flux may be intrinsically variable, making the <code class="docutils literal notranslate"><span class="pre">coadd</span></code> flux filter reject good spectra. Finer details of these rejection criteria are summarized below:</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Reason</p></th>
<th class="head"><p>Modes Effected</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Observing Issues</strong></p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p>Guide star acquisition failures</p></td>
<td><p>Any</p></td>
</tr>
<tr class="row-even"><td><p>Observatory or detector failure events</p></td>
<td><p>Any</p></td>
</tr>
<tr class="row-odd"><td><p>EXPFLAG (exposure data quality flag) header keyword is anything other than ‘NORMAL’</p></td>
<td><p>Any</p></td>
</tr>
<tr class="row-even"><td><p>EXPTIME (exposure time) is zero seconds</p></td>
<td><p>Any</p></td>
</tr>
<tr class="row-odd"><td><p>Actual exposure time is less than 80% of the planned exposure time</p></td>
<td><p>Any</p></td>
</tr>
<tr class="row-even"><td><p>FGSLOCK (fine guidance system lock) is not ‘FINE’, i.e., guide star tracking was not locked</p></td>
<td><p>Any</p></td>
</tr>
<tr class="row-odd"><td><p>SHUTTER is closed</p></td>
<td><p>COS</p></td>
</tr>
<tr class="row-even"><td><p><strong>Observation Parameters</strong></p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p>POSTARG1 != 0.0, i.e., there is a pointing offset</p></td>
<td><p>Any</p></td>
</tr>
<tr class="row-even"><td><p>POSTARG2 != 0.0 and P1_PURPS != ‘DITHER’, i.e., there is a pointing offset not in the disperson direction</p></td>
<td><p>STIS</p></td>
</tr>
<tr class="row-odd"><td><p>PATTERN1 = STIS-PERP-TO-SLIT and P1_FRAME = POS-TARG, i.e., there is a cross-dispersion direction pointing pattern</p></td>
<td><p>STIS</p></td>
</tr>
<tr class="row-even"><td><p>P1_PURPS = MOSAIC, i.e., there is a mosaic pointing offset pattern</p></td>
<td><p>STIS</p></td>
</tr>
<tr class="row-odd"><td><p>OPT_ELEM (grating) = PRISM</p></td>
<td><p>STIS</p></td>
</tr>
<tr class="row-even"><td><p>APERTURE = BOA (Bright Object Aperture)</p></td>
<td><p>COS</p></td>
</tr>
<tr class="row-odd"><td><p>For the COS/NUV grating G230L, stripe C spectra are rejected due to vignetting</p></td>
<td><p>COS/NUV</p></td>
</tr>
<tr class="row-even"><td><p><strong>Target Parameters</strong></p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p>Moving targets (MTFLAG = True)</p></td>
<td><p>Any</p></td>
</tr>
<tr class="row-even"><td><p>Variable targets*</p></td>
<td><p>Any</p></td>
</tr>
<tr class="row-odd"><td><p>Extended targets*</p></td>
<td><p>Any</p></td>
</tr>
</tbody>
</table>
</div>
<p>*These are not rejected by default, but some exposures may be removed by the code’s flux checking routine.</p>
<p>The HSLA team chose to reject these cases after careful analysis, but understand there are always some exceptions to these rules that we do not handle. This custom co-addition notebook will show users how to find out why a dataset was rejected and how to produce their own co-adds in cases where the data are still valuable.</p>
<p><em>Please note that the format and text in the log file may change slightly as new code builds are released. This notebook was last updated in Fall 2024 to reflect such text changes in the logs.</em></p>
<section id="imports">
<h3>Imports<a class="headerlink" href="#imports" title="Permalink to this heading">#</a></h3>
<p>We will be using multiple libraries to retrieve and analyze data. We will use:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">astroquery.mast</span> <span class="pre">Observations</span></code> to download COS and STIS data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pathlib.Path</span></code> to create product and data directories</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">matplotlib.pyplot</span></code> to plot spectra</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">numpy</span></code> to perform calculations and array manipulation</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">astropy.io</span> <span class="pre">fits</span></code> to work with FITS files</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">astropy.table</span> <span class="pre">Table</span></code> to work with FITS tables</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">glob</span></code> to work with multiple files in our directories</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">os</span></code> to interact with the operating system</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">shutil</span></code> to perform directory and file operations</p></li>
</ul>
<p>We recommend creating a HASP-specific <code class="docutils literal notranslate"><span class="pre">conda</span></code> environment when co-adding spectra. You can checkout our <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/tree/main/notebooks/HASP/Setup">Setup.ipynb</a> notebook to create such an environment. Alternatively, you can also download the required dependencies to run this notebook with the terminal command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<p>This will download the dependencies that are necessary to run this current notebook. Let’s import all of our packages that we will use in this notebook and print our <code class="docutils literal notranslate"><span class="pre">conda</span></code> environment by running the next cell:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">vstack</span>
<span class="kn">from</span> <span class="nn">astroquery.mast</span> <span class="kn">import</span> <span class="n">Observations</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> widget

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">6</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-colorblind&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Currently active conda environment:&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CONDA_PREFIX&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Please make sure the environment that contains the HASP script dependencies is activated or you download the dependencies listed in the <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> file, otherwise <strong>you will NOT be able to run the co-add code.</strong></p>
<p>We will define a function that will be utilized throughout the notebook when downloading MAST data using <code class="docutils literal notranslate"><span class="pre">astroquery</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">consolidate_files</span><span class="p">(</span><span class="n">data_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Consolidate all files to single directory; necessary for HASP script run.</span>
<span class="sd">    ---------------</span>
<span class="sd">    Input:</span>
<span class="sd">    str data_path : ./mastDownload/HST folders paths; files to be moved here</span>
<span class="sd">    ---------------</span>
<span class="sd">    Output:</span>
<span class="sd">    None. Files moved to data_path and data_path/products.</span>
<span class="sd">    The ./mastDownload/HST directory is deleted.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># The path to all obs_id folders</span>
    <span class="n">mast_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s2">/mastDownload/HST/&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Check if mastDownload exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mast_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Directory </span><span class="si">{</span><span class="n">mast_path</span><span class="si">}</span><span class="s2"> doesn&#39;t exist.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># Get a list of the obs_id paths in mastDownload</span>
        <span class="n">obs_id_dirs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">mast_path</span><span class="p">)</span>
        <span class="c1"># Iterate through each obs_id folder and move the files</span>
        <span class="k">for</span> <span class="n">obs_id</span> <span class="ow">in</span> <span class="n">obs_id_dirs</span><span class="p">:</span>
            <span class="n">obs_id_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mast_path</span><span class="p">,</span> <span class="n">obs_id</span><span class="p">)</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">obs_id_path</span> <span class="o">+</span> <span class="s2">&quot;/*fits&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                <span class="n">new_path</span> <span class="o">=</span> <span class="n">data_path</span> <span class="o">/</span> <span class="n">file_path</span><span class="o">.</span><span class="n">name</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">new_path</span><span class="p">)</span>
        <span class="c1"># Now we can remove the mastDownload directory</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mast_path</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s2">/mastDownload&quot;</span><span class="p">)</span>
        <span class="c1"># Now moving all coadd products to /data_path/products</span>
        <span class="n">product_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s2">/products/&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">product_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Directory </span><span class="si">{</span><span class="n">product_path</span><span class="si">}</span><span class="s2"> doesn&#39;t exist.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">coadd_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s2">/*cspec.fits&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">coadd_files</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">new_path</span> <span class="o">=</span> <span class="n">product_path</span> <span class="o">/</span> <span class="n">file_path</span><span class="o">.</span><span class="n">name</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">new_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<p><a id = cosweirddata></a></p>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="example-1-two-cos-datasets-rejected-for-different-reasons">
<h1>Example 1: Two COS datasets rejected for different reasons<a class="headerlink" href="#example-1-two-cos-datasets-rejected-for-different-reasons" title="Permalink to this heading">#</a></h1>
<p><a id = data1></a></p>
<section id="obtaining-data-products">
<h2>1.1 Obtaining Data Products<a class="headerlink" href="#obtaining-data-products" title="Permalink to this heading">#</a></h2>
<p>For this example, we will be looking at Program ID 12715, which observed four flux standard white dwarf stars with COS.
We will use <code class="docutils literal notranslate"><span class="pre">astroquery</span></code> to download the calibrated and coadded datasets for this program. For a more in-depth tutorial on downloading this data, please check out the <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/tree/main/notebooks/HASP/CoaddTutorial">CoaddTutorial.ipynb</a> notebook in this repository.</p>
<p>We will create a folder for the <code class="docutils literal notranslate"><span class="pre">X1D</span></code> and <code class="docutils literal notranslate"><span class="pre">X1DSUM</span></code> products, called <code class="docutils literal notranslate"><span class="pre">./12715</span></code>, and a subfolder called <code class="docutils literal notranslate"><span class="pre">products</span></code>, which will store the coadded data. The log file for this coadd is also available for download on MAST, but a static version has been provided in this repository for convenience. This log file is located in <code class="docutils literal notranslate"><span class="pre">./logfiles</span></code> and is called <code class="docutils literal notranslate"><span class="pre">HASP_12715.out</span></code>. Log files are text files that can be opened and viewed in any text editor.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Creating directories for our data and coadded products</span>
<span class="n">datadir_ex1</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./12715/&quot;</span><span class="p">)</span>
<span class="n">productsdir_ex1</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./12715/products/&quot;</span><span class="p">)</span>

<span class="n">datadir_ex1</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">productsdir_ex1</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s download our datasets for this program by running the cell below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span> output

<span class="c1"># Querying and downloading calibrated products</span>
<span class="n">query_ex1</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span>
    <span class="n">proposal_id</span><span class="o">=</span><span class="mi">12715</span><span class="p">,</span> 
    <span class="n">provenance_name</span><span class="o">=</span><span class="s2">&quot;CALCOS&quot;</span>
<span class="p">)</span>

<span class="n">prodlist_ex1</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span>
    <span class="n">query_ex1</span>
<span class="p">)</span>

<span class="n">prodlist_ex1</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">filter_products</span><span class="p">(</span>
    <span class="n">prodlist_ex1</span><span class="p">,</span>
    <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CALCOS&quot;</span><span class="p">],</span>
    <span class="n">productSubGroupDescription</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X1D&quot;</span><span class="p">,</span> <span class="s2">&quot;X1DSUM&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Querying and downloading coadded products</span>
<span class="n">query_ex1_coadds</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span>
    <span class="n">proposal_id</span><span class="o">=</span><span class="mi">12715</span><span class="p">,</span> 
    <span class="n">provenance_name</span><span class="o">=</span><span class="s2">&quot;HASP&quot;</span>
<span class="p">)</span>

<span class="n">prodlist_ex1_coadds</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span>
    <span class="n">query_ex1_coadds</span>
<span class="p">)</span>

<span class="n">prodlist_ex1_coadds</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">filter_products</span><span class="p">(</span>
    <span class="n">prodlist_ex1_coadds</span><span class="p">,</span> 
    <span class="n">productType</span><span class="o">=</span><span class="s2">&quot;SCIENCE&quot;</span><span class="p">,</span>
    <span class="n">productSubGroupDescription</span><span class="o">=</span><span class="s2">&quot;CSPEC&quot;</span>
<span class="p">)</span>

<span class="c1"># Combining the two product lists</span>
<span class="n">combined_ex1</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">([</span><span class="n">prodlist_ex1</span><span class="p">,</span> <span class="n">prodlist_ex1_coadds</span><span class="p">])</span>

<span class="c1"># Downloading the products</span>
<span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span>
    <span class="n">combined_ex1</span><span class="p">,</span>
    <span class="n">download_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">datadir_ex1</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Organizing the files </span>
<span class="n">consolidate_files</span><span class="p">(</span><span class="n">datadir_ex1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;output.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we will use <code class="docutils literal notranslate"><span class="pre">glob</span></code> to make a list of every <code class="docutils literal notranslate"><span class="pre">X1D</span></code> file available in MAST for this PID. We will print out a table of some table information on the program:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">allfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir_ex1</span><span class="p">,</span> <span class="s1">&#39;*_x1d.fits&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;rootname  target  visit  grating&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">x1d</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">allfiles</span><span class="p">):</span>
    <span class="n">hdr0</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">x1d</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;rootname&#39;</span><span class="p">],</span> <span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;targname&#39;</span><span class="p">],</span>
          <span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;obset_id&#39;</span><span class="p">],</span> <span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;opt_elem&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------------------------------&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;N files from MAST = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">allfiles</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a id = logs1></a></p>
</section>
<section id="examining-output-logs-and-headers">
<h2>1.2 Examining Output Logs and Headers<a class="headerlink" href="#examining-output-logs-and-headers" title="Permalink to this heading">#</a></h2>
<p>Now lets open the <code class="docutils literal notranslate"><span class="pre">coadd</span></code> output log to see which files were used in the coadd.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up path to the coadd log file</span>
<span class="n">logfile</span> <span class="o">=</span> <span class="s1">&#39;./logfiles/HASP_12715.out&#39;</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<p>As stated in the introduction, files can be removed from the co-added products in three steps. First, some files are excluded via a MAST archive query before they are even fed into <code class="docutils literal notranslate"><span class="pre">coadd</span></code>. Everything in the log file above the line that states <code class="docutils literal notranslate"><span class="pre">HASP</span> <span class="pre">version</span> <span class="pre">X.X</span></code> is output from this query. So, in this example, we can see that all but one of the files from MAST were fed into the <code class="docutils literal notranslate"><span class="pre">coadd</span></code> script. The rootname of the file (<code class="docutils literal notranslate"><span class="pre">lbui11faq</span></code>) and the reason for its removal by MAST are shown and we will take a closer look at the reason later. The rest of the log file gives the output from <code class="docutils literal notranslate"><span class="pre">coadd</span></code> itself. The <code class="docutils literal notranslate"><span class="pre">coadd</span></code> script output will indicate when a file is removed, giving both the filename and the reason, below the line that states <code class="docutils literal notranslate"><span class="pre">Ullyses</span> <span class="pre">version</span> <span class="pre">X.X.X</span></code>. Typically, data with observing issues are removed by the MAST query, while observation or target parameter issues are removed in <code class="docutils literal notranslate"><span class="pre">coadd</span></code>. Looking through the log file, we can see 9 other files were removed by <code class="docutils literal notranslate"><span class="pre">coadd</span></code> in this program:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">File</span> <span class="o">...</span><span class="n">lbui51l6q_x1d</span><span class="o">.</span><span class="n">fits</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">products</span> <span class="n">because</span> <span class="n">FGSLOCK</span> <span class="o">=</span> <span class="n">FINE</span><span class="o">/</span><span class="n">GYRO</span> 
<span class="n">File</span> <span class="o">...</span><span class="n">lbui51lcq_x1d</span><span class="o">.</span><span class="n">fits</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">products</span> <span class="n">because</span> <span class="n">FGSLOCK</span> <span class="o">=</span> <span class="n">FINE</span><span class="o">/</span><span class="n">GYRO</span> 
<span class="n">File</span> <span class="o">...</span><span class="n">lbui51lrq_x1d</span><span class="o">.</span><span class="n">fits</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">products</span> <span class="n">because</span> <span class="n">FGSLOCK</span> <span class="o">=</span> <span class="n">FINE</span><span class="o">/</span><span class="n">GYRO</span> 
<span class="n">File</span> <span class="o">...</span><span class="n">lbui51ltq_x1d</span><span class="o">.</span><span class="n">fits</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">products</span> <span class="n">because</span> <span class="n">FGSLOCK</span> <span class="o">=</span> <span class="n">FINE</span><span class="o">/</span><span class="n">GYRO</span> 
<span class="n">File</span> <span class="o">...</span><span class="n">lbui51lvq_x1d</span><span class="o">.</span><span class="n">fits</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">products</span> <span class="n">because</span> <span class="n">FGSLOCK</span> <span class="o">=</span> <span class="n">FINE</span><span class="o">/</span><span class="n">GYRO</span> 
<span class="n">File</span> <span class="o">...</span><span class="n">lbui51m5q_x1d</span><span class="o">.</span><span class="n">fits</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">products</span> <span class="n">because</span> <span class="n">FGSLOCK</span> <span class="o">=</span> <span class="n">FINE</span><span class="o">/</span><span class="n">GYRO</span> 
<span class="n">File</span> <span class="o">...</span><span class="n">lbui51m7q_x1d</span><span class="o">.</span><span class="n">fits</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">products</span> <span class="n">because</span> <span class="n">FGSLOCK</span> <span class="o">=</span> <span class="n">FINE</span><span class="o">/</span><span class="n">GYRO</span> 
<span class="n">File</span> <span class="o">...</span><span class="n">lbui51mbq_x1d</span><span class="o">.</span><span class="n">fits</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">products</span> <span class="n">because</span> <span class="n">FGSLOCK</span> <span class="o">=</span> <span class="n">FINE</span><span class="o">/</span><span class="n">GYRO</span> 
<span class="n">File</span> <span class="o">...</span><span class="n">lbui51mdq_x1d</span><span class="o">.</span><span class="n">fits</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">products</span> <span class="n">because</span> <span class="n">FGSLOCK</span> <span class="o">=</span> <span class="n">FINE</span><span class="o">/</span><span class="n">GYR0</span> 
</pre></div>
</div>
<p>This program does not have any data that is removed by the <code class="docutils literal notranslate"><span class="pre">coadd</span></code> flux checker. If a dataset is removed, it will be printed with lines such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Using</span> <span class="n">a</span> <span class="n">maximum</span> <span class="n">SNR</span> <span class="n">of</span> <span class="mi">20</span> <span class="ow">in</span> <span class="n">flux</span><span class="o">-</span><span class="n">based</span> <span class="n">filtering</span> \
<span class="n">Segment</span> <span class="c1">#1 from file ...lede16w8q_x1d.fits has scaled median = -54.04932196288165 \</span>
<span class="n">Removing</span> <span class="n">file</span> <span class="o">...</span><span class="n">lede16w8q_x1d</span><span class="o">.</span><span class="n">fits</span> <span class="kn">from</span> <span class="nn">product</span>
</pre></div>
</div>
<p>Next, we will write a function to parse the output logs and return lists of the files that were rejected.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">find_rejects</span><span class="p">(</span><span class="n">logpath</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">listofallfiles</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function parses the coadd output log file to make a list of files that</span>
<span class="sd">    were input to the coadd script. The function uses the PID to find the lines</span>
<span class="sd">    that are listed like so in the log file:</span>
<span class="sd">        Creating list of unique modes from these files:</span>
<span class="sd">        ...lbui01e7s_x1d.fits WD0947+857 COS FUV G140L PSA 12715 (12715, &#39;01&#39;)</span>
<span class="sd">        ...</span>
<span class="sd">        ...lbui50r5q_x1d.fits WD0308-565 COS FUV G140L PSA 12715 (12715, &#39;50&#39;)</span>
<span class="sd">    Then, it compares that to the list of every file from the program that you</span>
<span class="sd">    download from MAST. The difference in the two lists are the rejected files.</span>

<span class="sd">    It looks through the log for files that were rejected by the flux checker.</span>
<span class="sd">    This searches for lines that are printed like so in the log file:</span>
<span class="sd">        Removing file ...lede16w8q_x1d.fits from product</span>
<span class="sd">    Because a file can be removed more than once in the creation of different</span>
<span class="sd">    level data products, the list returned will only include unique entries.</span>

<span class="sd">    Args:</span>
<span class="sd">        logname (string): Path to the coadd output log file</span>
<span class="sd">        pid (string): Proposal ID of the program</span>
<span class="sd">        listofallfiles (list of strings): list of every path+filename program</span>

<span class="sd">    Returns:</span>
<span class="sd">        prerejectedfiles (list of str): list of files rejected by MAST query</span>
<span class="sd">                                        or coadd before computations began</span>
<span class="sd">        fluxrejectedfiles (list of str): list of files rejected by flux checker</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Open output log and make a list of rootnames that were used in the coadd</span>
    <span class="c1"># Also search for rootnames that were rejected by the flux checker</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">logpath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">coaddedfiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fluxrejectedfiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;...&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="o">+</span><span class="n">pid</span><span class="o">+</span><span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
            <span class="n">coaddedfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;Removing file&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">fluxrejectedfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Compare coadd list against list of all files in PID downloaded from MAST</span>
    <span class="n">prerejectedfiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">listofallfiles</span><span class="p">:</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">root</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">coaddedfiles</span><span class="p">:</span>
            <span class="n">prerejectedfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">prerejectedfiles</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">fluxrejectedfiles</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run find_rejects and print the output</span>
<span class="n">listofprerejects</span><span class="p">,</span> <span class="n">listoffluxrejects</span> <span class="o">=</span> <span class="n">find_rejects</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;12715&#39;</span><span class="p">,</span> <span class="n">allfiles</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Files removed before co-addition:&#39;</span><span class="p">)</span>
<span class="p">[</span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">listofprerejects</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Files removed by flux checker: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">listoffluxrejects</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of files removed before co-addition = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">listofprerejects</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of files removed by flux checker = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">listoffluxrejects</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can see 10 files were removed before the co-addition computations were started, and none were removed during the run by the flux checker. We already knew the files in Visit 51 were removed by <code class="docutils literal notranslate"><span class="pre">coadd</span></code> (and why) by looking at the output log above. The file from Visit 11 (<code class="docutils literal notranslate"><span class="pre">lbui11faq_x1d.fits</span></code>) was removed by the MAST query due to “low quality.” We can investigate the rejections from both visits further by inspecting the header keywords of the input spectra.</p>
<p>In the following cell, we make a function to read the file headers for each input spectrum. Most of the reasons for rejection that are listed in the <span class="xref myst">Introduction</span> section can be found either in the primary or first extension headers. This function can be used to inspect both COS and STIS extracted data, both <code class="docutils literal notranslate"><span class="pre">x1d</span></code> or <code class="docutils literal notranslate"><span class="pre">sx1</span></code> files. Note that some keywords, such as those describing the offset patterns, are only included in STIS files.</p>
<p>There are a few other keywords not listed in the <span class="xref myst">Introduction</span> that are useful to assess as well. These include the quality comments (<code class="docutils literal notranslate"><span class="pre">QUALCOM1</span></code>, <code class="docutils literal notranslate"><span class="pre">QUALCOM2</span></code>, <code class="docutils literal notranslate"><span class="pre">QUALCOM3</span></code>), the file date (<code class="docutils literal notranslate"><span class="pre">DATE</span></code>), and calibration software version (<code class="docutils literal notranslate"><span class="pre">CAL_VER</span></code>).</p>
<p>The quality comments can hold information about the quality of a dataset. For example, they may have phrases like <code class="docutils literal notranslate"><span class="pre">Guide</span> <span class="pre">star</span> <span class="pre">acquisition</span> <span class="pre">failed.</span> <span class="pre">Actual</span> <span class="pre">guide</span> <span class="pre">mode</span> <span class="pre">is</span> <span class="pre">gyro</span></code> or <code class="docutils literal notranslate"><span class="pre">COS</span> <span class="pre">internal</span> <span class="pre">shutter</span> <span class="pre">closed.</span> <span class="pre">No</span> <span class="pre">counts</span> <span class="pre">in</span> <span class="pre">exposure</span></code>. If there is nothing to note for the dataset, the quality comments will be blank, but note that sometimes this can be inaccurate, as it relies on PIs to file problem reports. For STIS, these keys are in the <code class="docutils literal notranslate"><span class="pre">x1d</span></code> or <code class="docutils literal notranslate"><span class="pre">sx1</span></code> file headers. For COS, they are located in the <code class="docutils literal notranslate"><span class="pre">x1dsum</span></code> files that CalCOS creates, which are the sum of <code class="docutils literal notranslate"><span class="pre">FP-POS</span></code> exposures for a given observing mode in each visit. While these keywords do exist in COS <code class="docutils literal notranslate"><span class="pre">x1d</span></code> files, they will only be populated with comments in the <code class="docutils literal notranslate"><span class="pre">x1dsums</span></code>. To find the <code class="docutils literal notranslate"><span class="pre">x1dsum</span></code> file for these observations, we can use the <code class="docutils literal notranslate"><span class="pre">ASN_ID</span></code> keyword from the <code class="docutils literal notranslate"><span class="pre">x1ds</span></code>.</p>
<p>The date the file was written and the version of the software used for calibration are useful for finding datasets that are archived “statically” in MAST, meaning they are always excluded from re-calibration because doing so will crash the latest versions of the calibration pipeline. There are only a handful of statically archived datasets for COS and STIS. The reasons they need to be designated as such are usually due to detector or spacecraft issues that need very specialized processing, and this is not always captured in the quality comments. Therefore, we do not recommend using these datasets in co-adds.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">readheaders</span><span class="p">(</span><span class="n">prerejectedfiles</span><span class="p">,</span> <span class="n">datadir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function goes through a list of the pre-rejected files and prints the </span>
<span class="sd">    x1d header information about data quality. Some of these quality comments </span>
<span class="sd">    can describe issues that might have occured during the observation. </span>
<span class="sd">    Args:</span>
<span class="sd">        prerejectedfiles (list of strings): list of rejected filenames</span>
<span class="sd">        datadir (str): path to x1d/sx1/x1dsum files</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">badfile</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">prerejectedfiles</span><span class="p">):</span>
        <span class="n">badfilepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">badfile</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">badfilepath</span><span class="p">)</span>
        <span class="c1"># Open the 0th and 1st ext. headers to get data quality info</span>
        <span class="n">hdr0</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">badfilepath</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">hdr1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">badfilepath</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Note that header keywords differ between COS and STIS</span>
        <span class="n">ins</span> <span class="o">=</span> <span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;INSTRUME&#39;</span><span class="p">]</span>

        <span class="c1"># print lots of keywords</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exposure time = </span><span class="si">{</span><span class="n">hdr1</span><span class="p">[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># These keywords doesn&#39;t exist in STIS data</span>
        <span class="k">if</span> <span class="n">ins</span> <span class="o">==</span> <span class="s1">&#39;COS&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Planned exposure time = </span><span class="si">{</span><span class="n">hdr1</span><span class="p">[</span><span class="s1">&#39;PLANTIME&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shutter = </span><span class="si">{</span><span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;SHUTTER&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Aperture used = </span><span class="si">{</span><span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;APERTURE&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grating used = </span><span class="si">{</span><span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;OPT_ELEM&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exposure flag = </span><span class="si">{</span><span class="n">hdr1</span><span class="p">[</span><span class="s1">&#39;EXPFLAG&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fine guiding lock = </span><span class="si">{</span><span class="n">hdr1</span><span class="p">[</span><span class="s1">&#39;FGSLOCK&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;POSTARG1 / POSTARG2 = </span><span class="si">{</span><span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;POSTARG1&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;POSTARG2&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># These keywords are not present in COS x1d data</span>
        <span class="k">if</span> <span class="n">ins</span> <span class="o">==</span> <span class="s1">&#39;STIS&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Offset pattern = </span><span class="si">{</span><span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;PATTERN1&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;P1 frame = </span><span class="si">{</span><span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;P1_FRAME&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;P1 purpose = </span><span class="si">{</span><span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;P1_PURPS&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Quality comments&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    COM1 = </span><span class="si">{</span><span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;QUALCOM1&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    COM2 = </span><span class="si">{</span><span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;QUALCOM2&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    COM3 = </span><span class="si">{</span><span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;QUALCOM3&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Find the x1dsum for the COS data to get the quality comments</span>
        <span class="k">if</span> <span class="n">ins</span> <span class="o">==</span> <span class="s1">&#39;COS&#39;</span><span class="p">:</span>
            <span class="n">asn_id</span> <span class="o">=</span> <span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;ASN_ID&#39;</span><span class="p">]</span>
            <span class="n">x1dsum</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">asn_id</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;_x1dsum.fits&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">x1dsum</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Quality comments from </span><span class="si">{</span><span class="n">x1dsum</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    COM1 = &#39;</span> <span class="o">+</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">x1dsum</span><span class="p">,</span> <span class="s1">&#39;QUALCOM1&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    COM2 = &#39;</span> <span class="o">+</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">x1dsum</span><span class="p">,</span> <span class="s1">&#39;QUALCOM2&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    COM3 = &#39;</span> <span class="o">+</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">x1dsum</span><span class="p">,</span> <span class="s1">&#39;QUALCOM3&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Quality comments: No x1dsum available&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;MTFLAG&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Moving target? No&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Moving target? Yes&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Date file was written = </span><span class="si">{</span><span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;DATE&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Version of calibration software = </span><span class="si">{</span><span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;OPUS_VER&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">readheaders</span><span class="p">(</span><span class="n">listofprerejects</span><span class="p">,</span> <span class="n">datadir_ex1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Inspecting the output from the header keywords printed above, we see there is no <code class="docutils literal notranslate"><span class="pre">x1dsum</span></code> to inspect for <code class="docutils literal notranslate"><span class="pre">lbui11faq_x1d.fits</span></code>. This is unusual for COS data! We can also see that the date the file was written was in 2012, and that the version of the calibration software used to calibrate this data was from 2012. All together, this indicates that this dataset is statically archived in MAST, and so we don’t recommend using it in a co-add. To see the latest versions of the calibration pipeline software, see the <a class="reference external" href="https://github.com/astroconda/astroconda-releases/tree/master/caldp">HST Data Processing (HSTDP) github page</a>.</p>
<p>We can also see that the quality comments are all blank for the Visit 51 datasets. We know from the output log file that these data were rejected because some of the exposure was observed using gyro guiding, which is less accurate than fine guiding that tracks targets with guide stars. Because there are no quality comments listed to indicate a target acquisition failure, this data may still be useable, and we’ll explore that next. This data is of target <code class="docutils literal notranslate"><span class="pre">WD0308-565</span></code>, which was also observed in Visit 50 with the same observing setup. We can compare the fluxes of the two visits to see if Visit 51’s data is alright for co-addition.</p>
<p><a id = plots1></a></p>
</section>
<section id="plotting-constituent-and-co-added-spectra">
<h2>1.3 Plotting Constituent and Co-added Spectra<a class="headerlink" href="#plotting-constituent-and-co-added-spectra" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define a function to bin the data so it will plot more clearly</span>
<span class="k">def</span> <span class="nf">downsample_1d</span><span class="p">(</span><span class="n">myarr</span><span class="p">,</span> <span class="n">factor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Downsample a 1D array by averaging over *factor* pixels.</span>
<span class="sd">    Crops right side if the shape is not a multiple of factor.</span>
<span class="sd">    Got this specific function from &quot;Adam Ginsburg&#39;s python codes&quot; on agpy</span>

<span class="sd">    myarr : numpy array</span>
<span class="sd">    factor : how much you want to rebin the array by</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">myarr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">crarr</span> <span class="o">=</span> <span class="n">myarr</span><span class="p">[:</span><span class="n">xs</span><span class="o">-</span><span class="p">(</span><span class="n">xs</span> <span class="o">%</span> <span class="n">factor</span><span class="p">)]</span>
    <span class="n">dsarr</span> <span class="o">=</span> <span class="n">crarr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">factor</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dsarr</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;hst_12715_cos_wd0308-565_cg140l-g130m-g160m_lbui50_cspec.fits&#39;</span>

<span class="c1"># Set up a path to the visit 50 level co-added data product for this target</span>
<span class="n">coaddfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir_ex1</span><span class="p">,</span> <span class="s1">&#39;products&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
<span class="n">coadddata</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">coaddfile</span><span class="p">)</span>

<span class="c1"># Proactively set sample factor to 6, which is size of COS resolution element</span>
<span class="c1"># For STIS, this is 2</span>
<span class="n">samplefactor</span> <span class="o">=</span> <span class="mi">6</span>

<span class="c1"># The visit we want to plot</span>
<span class="n">visit_to_plot</span> <span class="o">=</span> <span class="s2">&quot;51&quot;</span>

<span class="c1"># Get the wavelength and flux data for the co-added file</span>
<span class="n">wavelength</span> <span class="o">=</span> <span class="n">coadddata</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">flux</span> <span class="o">=</span> <span class="n">coadddata</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Set up the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Plot the constiuent spectra</span>
<span class="k">for</span> <span class="n">x1d</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">allfiles</span><span class="p">):</span>
    <span class="c1"># First check that the file is for the correct visit</span>
    <span class="n">visit_id</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">x1d</span><span class="p">,</span> <span class="s1">&#39;obset_id&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">visit_id</span> <span class="o">==</span> <span class="n">visit_to_plot</span><span class="p">:</span>
        <span class="n">x1ddata</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">x1d</span><span class="p">)</span>
        <span class="n">subwave</span> <span class="o">=</span> <span class="n">x1ddata</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">subflux</span> <span class="o">=</span> <span class="n">x1ddata</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">downsample_1d</span><span class="p">(</span><span class="n">subwave</span><span class="p">,</span> <span class="n">samplefactor</span><span class="p">),</span>
                 <span class="n">downsample_1d</span><span class="p">(</span><span class="n">subflux</span><span class="p">,</span> <span class="n">samplefactor</span><span class="p">),</span>
                 <span class="n">label</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">x1d</span><span class="p">,</span> <span class="s1">&#39;rootname&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                 <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="c1"># Overplot the co-add</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">downsample_1d</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">samplefactor</span><span class="p">),</span>
         <span class="n">downsample_1d</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="n">samplefactor</span><span class="p">),</span>
         <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;visit 50 co-add&#39;</span><span class="p">,</span>
         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="c1"># Format the plot by adding titles</span>
<span class="n">targ</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">coaddfile</span><span class="p">,</span> <span class="s1">&#39;TARGNAME&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">pid</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">coaddfile</span><span class="p">,</span> <span class="s1">&#39;PROPOSID&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ins</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">coaddfile</span><span class="p">,</span> <span class="s1">&#39;INSTRUME&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">targ</span><span class="si">}</span><span class="s1"> - </span><span class="si">{</span><span class="n">ins</span><span class="si">}</span><span class="s1"> - PID </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength [$\AA$]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Flux [$erg\ s^{-1}\ cm^{-2}\ \AA^{-1}$]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Show the plot below</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Use the interactive features in the top left corner to zoom in on a region of continuum in the plot above. The zoom button looks like a square and allows you to select a rectangular region on the plot to enlarge. We see no systematic difference in the data from Visit 51 compared to the co-added data in Visit 50, so let’s add the Visit 51 data into the co-add.</p>
<p><a id = coadd1></a></p>
</section>
<section id="re-running-coadd">
<h2>1.4 Re-running <code class="docutils literal notranslate"><span class="pre">coadd</span></code><a class="headerlink" href="#re-running-coadd" title="Permalink to this heading">#</a></h2>
<p>Now that we know which data we want to use in the custom co-add, we must create a new directory with all the data from Visits 50 and 51. We will feed <code class="docutils literal notranslate"><span class="pre">coadd</span></code> the data from this new directory from its <code class="docutils literal notranslate"><span class="pre">wrapper</span></code> script. Running <code class="docutils literal notranslate"><span class="pre">coadd</span></code> this way essentially skips the filtering that the MAST query applies, but <code class="docutils literal notranslate"><span class="pre">coadd</span></code> itself still has some internal data quality checks, as mentioned above, so we will need to turn those off. If there is data you still want <code class="docutils literal notranslate"><span class="pre">coadd</span></code> exclude that was filtered before, be sure to not put those in the data directory!</p>
<p>The following cell is the call to <code class="docutils literal notranslate"><span class="pre">coadd</span></code> via its <code class="docutils literal notranslate"><span class="pre">wrapper</span></code>. The <code class="docutils literal notranslate"><span class="pre">-i</span></code> parameter is the input directory you just made. <code class="docutils literal notranslate"><span class="pre">-o</span></code> is the directory that will contain the newly created co-added products. The <code class="docutils literal notranslate"><span class="pre">-k</span></code> turns off the data quality filtering. There is more information about this in our <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/tree/main/notebooks/HASP/Setup">Setup.ipynb</a> notebook.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up the path to your new data directory</span>
<span class="n">finaldatadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir_ex1</span><span class="p">,</span> <span class="s1">&#39;newcoadddata&#39;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">finaldatadir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Copy all the data from visits 50 and 51 into it</span>
<span class="n">filestocopy</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir_ex1</span><span class="p">,</span> <span class="s1">&#39;*50*_x1d.fits&#39;</span><span class="p">))</span>\
            <span class="o">+</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir_ex1</span><span class="p">,</span> <span class="s1">&#39;*51*_x1d.fits&#39;</span><span class="p">))</span>

<span class="p">[</span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">finaldatadir</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">filestocopy</span><span class="p">]</span>

<span class="c1"># Make an output directory</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir_ex1</span><span class="p">,</span> <span class="s1">&#39;newcoadddata&#39;</span><span class="p">,</span> <span class="s1">&#39;products&#39;</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>To call <code class="docutils literal notranslate"><span class="pre">coadd</span></code>, we use the <code class="docutils literal notranslate"><span class="pre">!</span></code> to run from the command line. The directories here must be printed out in full - don’t use variable names:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%capture output

!swrapper -i ./12715/newcoadddata -o ./12715/newcoadddata/products -k
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;output.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="replot-the-co-added-data">
<h3>Replot the co-added data<a class="headerlink" href="#replot-the-co-added-data" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Clear the older plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">coadd_filename</span> <span class="o">=</span> <span class="s1">&#39;hst_12715_cos_wd0308-565_cg140l-g130m-g160m_lbui_cspec.fits&#39;</span>

<span class="c1"># Plot the old coadd</span>
<span class="n">oldcoaddfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir_ex1</span><span class="p">,</span> <span class="s1">&#39;products&#39;</span><span class="p">,</span> <span class="n">coadd_filename</span><span class="p">)</span>
<span class="n">oldcoadddata</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">oldcoaddfile</span><span class="p">)</span>
<span class="n">oldwavelength</span> <span class="o">=</span> <span class="n">oldcoadddata</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">oldflux</span> <span class="o">=</span> <span class="n">oldcoadddata</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">downsample_1d</span><span class="p">(</span><span class="n">oldwavelength</span><span class="p">,</span> <span class="n">samplefactor</span><span class="p">),</span>
         <span class="n">downsample_1d</span><span class="p">(</span><span class="n">oldflux</span><span class="p">,</span> <span class="n">samplefactor</span><span class="p">),</span>
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;old coadd&#39;</span><span class="p">,</span>
         <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="c1"># Plot the new coadd</span>
<span class="n">newcoaddfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">finaldatadir</span><span class="p">,</span> <span class="s1">&#39;products&#39;</span><span class="p">,</span> <span class="n">coadd_filename</span><span class="p">)</span>
<span class="n">newcoadddata</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">newcoaddfile</span><span class="p">)</span>
<span class="n">newwavelength</span> <span class="o">=</span> <span class="n">newcoadddata</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">newflux</span> <span class="o">=</span> <span class="n">newcoadddata</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">downsample_1d</span><span class="p">(</span><span class="n">newwavelength</span><span class="p">,</span> <span class="n">samplefactor</span><span class="p">),</span>
         <span class="n">downsample_1d</span><span class="p">(</span><span class="n">newflux</span><span class="p">,</span> <span class="n">samplefactor</span><span class="p">),</span>
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;new coadd&#39;</span><span class="p">,</span>
         <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="n">targ</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">coaddfile</span><span class="p">,</span> <span class="s1">&#39;TARGNAME&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">pid</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">coaddfile</span><span class="p">,</span> <span class="s1">&#39;PROPOSID&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ins</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">coaddfile</span><span class="p">,</span> <span class="s1">&#39;INSTRUME&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">targ</span><span class="si">}</span><span class="s1"> - </span><span class="si">{</span><span class="n">ins</span><span class="si">}</span><span class="s1"> - PID </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength [$\AA$]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Flux [$erg\ s^{-1}\ cm^{-2}\ \AA^{-1}$]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Show the plot below</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s also plot the signal-to-noise to see the improvement.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Clear the older plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="c1"># Plot the old coadd SNR</span>
<span class="n">oldsnr</span> <span class="o">=</span> <span class="n">oldcoadddata</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">downsample_1d</span><span class="p">(</span><span class="n">oldwavelength</span><span class="p">,</span> <span class="n">samplefactor</span><span class="p">),</span>
         <span class="n">downsample_1d</span><span class="p">(</span><span class="n">oldsnr</span><span class="p">,</span> <span class="n">samplefactor</span><span class="p">),</span>
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;old coadd&#39;</span><span class="p">,</span>
         <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="c1"># Plot the new coadd SNR</span>
<span class="n">newsnr</span> <span class="o">=</span> <span class="n">newcoadddata</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">downsample_1d</span><span class="p">(</span><span class="n">newwavelength</span><span class="p">,</span> <span class="n">samplefactor</span><span class="p">),</span>
         <span class="n">downsample_1d</span><span class="p">(</span><span class="n">newsnr</span><span class="p">,</span> <span class="n">samplefactor</span><span class="p">),</span>
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;new coadd&#39;</span><span class="p">,</span>
         <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">targ</span><span class="si">}</span><span class="s1"> - </span><span class="si">{</span><span class="n">ins</span><span class="si">}</span><span class="s1"> - PID </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength [$\AA$]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Signal-to-Noise&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Show the plot below</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We can tell from the plot above that the SNR is much improved by adding the Visit 51 data into the co-add!</p>
<p><a id = stisdithers></a></p>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="example-2-a-stis-dataset-with-postarg-offsets">
<h1>Example 2: A STIS dataset with POSTARG offsets<a class="headerlink" href="#example-2-a-stis-dataset-with-postarg-offsets" title="Permalink to this heading">#</a></h1>
<p><a id = data2></a></p>
<section id="id1">
<h2>2.1 Obtaining Data Products<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h2>
<p>For the next example, we will look at Program ID 16655, a STIS program that observed the star <a class="reference external" href="http://simbad.cds.unistra.fr/simbad/sim-basic?Ident=Betelgeuse&amp;submit=SIMBAD+search">Betelgeuse</a> with the <code class="docutils literal notranslate"><span class="pre">E230M</span></code> grating centered on the target and at <code class="docutils literal notranslate"><span class="pre">POSTARGs</span></code> <code class="docutils literal notranslate"><span class="pre">+/-0.25</span> <span class="pre">mas</span></code> and <code class="docutils literal notranslate"><span class="pre">+/-</span> <span class="pre">0.5</span> <span class="pre">mas</span></code>. Each visit in the programs contains the same spatial scan in the pattern <code class="docutils literal notranslate"><span class="pre">+0.5</span> <span class="pre">mas</span></code>, <code class="docutils literal notranslate"><span class="pre">-0.5</span> <span class="pre">mas</span></code>, <code class="docutils literal notranslate"><span class="pre">centered</span></code>, <code class="docutils literal notranslate"><span class="pre">+0.25</span> <span class="pre">mas</span></code>, <code class="docutils literal notranslate"><span class="pre">-0.25</span> <span class="pre">mas</span></code>. <code class="docutils literal notranslate"><span class="pre">coadd</span></code> will co-add the centered datasets in each visit, but will reject the other datasets with <code class="docutils literal notranslate"><span class="pre">POSTARGs</span></code>.</p>
<p>We will again use <code class="docutils literal notranslate"><span class="pre">astroquery</span></code> to download the dataproducts for this program. We will create a folder for the <code class="docutils literal notranslate"><span class="pre">X1D</span></code> products, called <code class="docutils literal notranslate"><span class="pre">./16655</span></code>, and a subfolder called <code class="docutils literal notranslate"><span class="pre">products</span></code>, which will store the downloaded coadded data. The log file for this program is named <code class="docutils literal notranslate"><span class="pre">HASP_16655.out</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Creating directories for our data and coadded products</span>
<span class="n">datadir_ex2</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./16655/&quot;</span><span class="p">)</span>
<span class="n">productsdir_ex2</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./16655/products/&quot;</span><span class="p">)</span>

<span class="n">datadir_ex2</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">productsdir_ex2</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span> output

<span class="c1"># Querying and downloading calibrated products</span>
<span class="n">query_ex2</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span>
    <span class="n">proposal_id</span><span class="o">=</span><span class="mi">16655</span><span class="p">,</span> 
    <span class="n">provenance_name</span><span class="o">=</span><span class="s2">&quot;CALSTIS&quot;</span><span class="p">,</span>
    <span class="n">filters</span><span class="o">=</span><span class="s2">&quot;E230M&quot;</span><span class="p">,</span>
    <span class="n">target_name</span><span class="o">=</span><span class="s2">&quot;HD39801&quot;</span>
<span class="p">)</span>

<span class="n">prodlist_ex2</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span>
    <span class="n">query_ex2</span>
<span class="p">)</span>

<span class="n">prodlist_ex2</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">filter_products</span><span class="p">(</span>
    <span class="n">prodlist_ex2</span><span class="p">,</span>
    <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CALSTIS&quot;</span><span class="p">],</span>
    <span class="n">productSubGroupDescription</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X1D&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Querying and downloading coadded products</span>
<span class="n">query_ex2_coadds</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span>
    <span class="n">proposal_id</span><span class="o">=</span><span class="mi">16655</span><span class="p">,</span> 
    <span class="n">provenance_name</span><span class="o">=</span><span class="s2">&quot;HASP&quot;</span><span class="p">,</span>
    <span class="n">filters</span><span class="o">=</span><span class="s2">&quot;E230M&quot;</span><span class="p">,</span>
    <span class="n">target_name</span><span class="o">=</span><span class="s2">&quot;HD39801&quot;</span>
<span class="p">)</span>

<span class="n">prodlist_ex2_coadds</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span>
    <span class="n">query_ex2_coadds</span>
<span class="p">)</span>

<span class="n">prodlist_ex2_coadds</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">filter_products</span><span class="p">(</span>
    <span class="n">prodlist_ex2_coadds</span><span class="p">,</span> 
    <span class="n">productType</span><span class="o">=</span><span class="s2">&quot;SCIENCE&quot;</span><span class="p">,</span>
    <span class="n">productSubGroupDescription</span><span class="o">=</span><span class="s2">&quot;CSPEC&quot;</span>
<span class="p">)</span>

<span class="c1"># Combining the two product lists</span>
<span class="n">combined_ex2</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">([</span><span class="n">prodlist_ex2</span><span class="p">,</span> <span class="n">prodlist_ex2_coadds</span><span class="p">])</span>

<span class="c1"># Downloading the products</span>
<span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span>
    <span class="n">combined_ex2</span><span class="p">,</span>
    <span class="n">download_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">datadir_ex2</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Organizing the files </span>
<span class="n">consolidate_files</span><span class="p">(</span><span class="n">datadir_ex2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;output.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s print some table information from our datasets:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">allfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir_ex2</span><span class="p">,</span> <span class="s1">&#39;*_x1d.fits&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;rootname  target  visit  grating&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">x1d</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">allfiles</span><span class="p">):</span>
    <span class="n">hdr0</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">x1d</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;rootname&#39;</span><span class="p">],</span> <span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;targname&#39;</span><span class="p">],</span>
          <span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;obset_id&#39;</span><span class="p">],</span> <span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;opt_elem&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------------------------------&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;N files from MAST = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">allfiles</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a id = logs2></a></p>
</section>
<section id="id2">
<h2>2.2 Examining Output Logs and Headers<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h2>
<p>Let’s look at the log next.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up path to the coadd log file</span>
<span class="n">logfile</span> <span class="o">=</span> <span class="s1">&#39;./logfiles/HASP_16655.out&#39;</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<p>We can see that two files were removed by the MAST query and that many other files were removed from the co-add because of <code class="docutils literal notranslate"><span class="pre">POSTARG</span></code> offsets, as expected. There are also some files that were removed later by the flux checker. Let’s see which files, and how many were rejected next.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use the find_rejects function to make list of pre-rejected files</span>
<span class="n">listofprerejects</span><span class="p">,</span> <span class="n">listoffluxrejects</span> <span class="o">=</span> <span class="n">find_rejects</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;16655&#39;</span><span class="p">,</span> <span class="n">allfiles</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Files removed before co-addition: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">listofprerejects</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Files removed by flux checker: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">listoffluxrejects</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of files removed before co-addition = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">listofprerejects</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of files removed by flux checker = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">listoffluxrejects</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, look in the <code class="docutils literal notranslate"><span class="pre">x1d</span></code> headers to find the exposure information and quality comments.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">readheaders</span><span class="p">(</span><span class="n">listofprerejects</span><span class="p">,</span> <span class="n">datadir_ex2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Looking through this output, we can see there are two datasets from Visit 01 (oen701030_x1d.fits and oen701040_x1d.fits) that had failed target acquisitions and were removed from the co-add. The quality comments tell us the aperture door was closed through the whole exposure, so no useful data was taken. The rest of the datasets were rejected because of the <code class="docutils literal notranslate"><span class="pre">POSTARG</span></code> offsets, as we already knew, and there are no other quality issues.</p>
<p>This leaves only five datasets that were included in the call to create the default versions of the data products: <code class="docutils literal notranslate"><span class="pre">oen702030_x1d.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">oen703030_x1d.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">oen704030_x1d.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">oen705030_x1d.fits</span></code>, and <code class="docutils literal notranslate"><span class="pre">oen751030_x1d.fits</span></code>. However, the data in Visits 2, 3, 4, and 5 were later removed by the flux checker. Since this program was designed to probe Betelgeuse’s recent flux variability, it makes sense that some of the fluxes may indeed be flagged for removal. In the custom co-add runs we perform next, we can set flags to ignore the <code class="docutils literal notranslate"><span class="pre">POSTARG</span></code> and flux filtering.</p>
<p><a id = coadd1></a></p>
</section>
<section id="running-coadd">
<h2>2.3 Running <code class="docutils literal notranslate"><span class="pre">coadd</span></code><a class="headerlink" href="#running-coadd" title="Permalink to this heading">#</a></h2>
<p>The structure of the program is such that each visit observed Betelgeuse at many <code class="docutils literal notranslate"><span class="pre">POSTARG</span></code> positions using the same gratings. The spatial scanning pattern is uniform, and so a user may wish to create co-adds of the spectra observed at each pointing position across all the visits. To co-add these, we can follow the same steps as in <span class="xref myst">Section 1.4</span>, but set up five different directories for each pointing position. We’ll create the directories:</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Directory</p></th>
<th class="head"><p>Contains Datasets</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">newcoadddata_p50</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">oen702010_x1d.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">oen703010_x1d.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">oen704010_x1d.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">oen705010_x1d.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">oen751010_x1d.fits</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">newcoadddata_p25</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">oen702040_x1d.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">oen703040_x1d.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">oen704040_x1d.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">oen705040_x1d.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">oen751040_x1d.fits</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">newcoadddata_p0.0</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">oen702030_x1d.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">oen703030_x1d.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">oen704030_x1d.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">oen705030_x1d.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">oen751030_x1d.fits</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">newcoadddata_p-25</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">oen702050_x1d.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">oen703050_x1d.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">oen704050_x1d.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">oen705050_x1d.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">oen751050_x1d.fits</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">newcoadddata_p-50</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">oen702020_x1d.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">oen703020_x1d.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">oen704020_x1d.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">oen705020_x1d.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">oen751020_x1d.fits</span></code></p></td>
</tr>
</tbody>
</table>
</div>
<p>Note that we’ll still need to exclude the Visit 01 data that was rejected from the MAST query, as that step is bypassed when we run <code class="docutils literal notranslate"><span class="pre">coadd</span></code> from a local folder. Like in the first example, we add the flag <code class="docutils literal notranslate"><span class="pre">-k</span></code> to the call to turn off the <code class="docutils literal notranslate"><span class="pre">POSTARG</span></code> filtering. This time, we’ll also add <code class="docutils literal notranslate"><span class="pre">-t</span> <span class="pre">-99999</span></code> to set the flux checking threshold. Setting this to a very large negative number will essentially override the flux filtering that <code class="docutils literal notranslate"><span class="pre">coadd</span></code> performs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get a list of all files in the directory</span>
<span class="n">allfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir_ex2</span><span class="p">,</span> <span class="s1">&#39;*.fits&#39;</span><span class="p">))</span>

<span class="c1"># Sort through all the files based on POSTARG value</span>
<span class="n">postvals</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-0.05&#39;</span><span class="p">,</span> <span class="s1">&#39;-0.025&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0&#39;</span><span class="p">,</span> <span class="s1">&#39;0.025&#39;</span><span class="p">,</span> <span class="s1">&#39;0.05&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">postvals</span><span class="p">:</span>
    <span class="c1"># Make a list of files all with the same POSTARG values</span>
    <span class="n">postarglist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">myfile</span> <span class="ow">in</span> <span class="n">allfiles</span><span class="p">:</span>
        <span class="n">postarg</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">myfile</span><span class="p">,</span> <span class="s1">&#39;POSTARG1&#39;</span><span class="p">)</span>
        <span class="n">visitid</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">myfile</span><span class="p">,</span> <span class="s1">&#39;OBSET_ID&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">postarg</span><span class="p">)</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">visitid</span> <span class="o">!=</span> <span class="s1">&#39;01&#39;</span><span class="p">):</span>
            <span class="n">postarglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">myfile</span><span class="p">)</span>

    <span class="c1"># Make new directories for each list</span>
    <span class="n">finaldatadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir_ex2</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;newcoadddata_p</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">finaldatadir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Copy this list into a new directory to coadd from</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">postarglist</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Copying </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">finaldatadir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">finaldatadir</span><span class="p">)</span>

    <span class="c1"># Create output directories for the new coadds</span>
    <span class="n">productdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir_ex2</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;newcoadddata_p</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;products&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">productdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Run <code class="docutils literal notranslate"><span class="pre">coadd</span></code> for all the new directories:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%capture output

!swrapper -i ./16655/newcoadddata_p-0.05 -o ./16655/newcoadddata_p-0.05/products -k -t -999
!swrapper -i ./16655/newcoadddata_p-0.025 -o ./16655/newcoadddata_p-0.025/products -k -t -999
!swrapper -i ./16655/newcoadddata_p0.0 -o ./16655/newcoadddata_p0.0/products -k -t -999
!swrapper -i ./16655/newcoadddata_p0.025 -o ./16655/newcoadddata_p0.025/products -k -t -999
!swrapper -i ./16655/newcoadddata_p0.05 -o ./16655/newcoadddata_p0.05/products -k -t -999
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;output.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now that data products have been made for all the datasets, we can plot the results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Clear the older plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="c1"># Set sample factor to 2, which is size of STIS resolution element</span>
<span class="n">samplefactor</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># Plot the coadds</span>
<span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">postvals</span><span class="p">:</span>
    <span class="n">coadd_filename</span> <span class="o">=</span> <span class="s1">&#39;hst_16655_stis_hd39801_e230m_oen7_cspec.fits&#39;</span>
    <span class="n">coaddfile</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datadir_ex2</span><span class="si">}</span><span class="s2">/newcoadddata_p</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">/products/</span><span class="si">{</span><span class="n">coadd_filename</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="si">}</span><span class="s2"> mas&quot;</span>

    <span class="n">coadddata</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">coaddfile</span><span class="p">)</span>
    <span class="n">wavelength</span> <span class="o">=</span> <span class="n">coadddata</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">coadddata</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">downsample_1d</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">samplefactor</span><span class="p">),</span>
             <span class="n">downsample_1d</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="n">samplefactor</span><span class="p">),</span>
             <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
             <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

    <span class="n">targ</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">coaddfile</span><span class="p">,</span> <span class="s1">&#39;TARGNAME&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">coaddfile</span><span class="p">,</span> <span class="s1">&#39;PROPOSID&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ins</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">coaddfile</span><span class="p">,</span> <span class="s1">&#39;INSTRUME&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">targ</span><span class="si">}</span><span class="s1"> - </span><span class="si">{</span><span class="n">ins</span><span class="si">}</span><span class="s1"> - PID </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength [$\AA$]&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Flux [$erg\ s^{-1}\ cm^{-2}\ \AA^{-1}$]&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Show the plot below</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Also plot the SNR</span>
<span class="c1"># Clear the older plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Plot the coadds</span>
<span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">postvals</span><span class="p">:</span>
    <span class="n">coadd_filename</span> <span class="o">=</span> <span class="s1">&#39;hst_16655_stis_hd39801_e230m_oen7_cspec.fits&#39;</span>
    <span class="n">coaddfile</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datadir_ex2</span><span class="si">}</span><span class="s2">/newcoadddata_p</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">/products/</span><span class="si">{</span><span class="n">coadd_filename</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="si">}</span><span class="s2"> mas&quot;</span>

    <span class="n">coadddata</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">coaddfile</span><span class="p">)</span>
    <span class="n">wavelength</span> <span class="o">=</span> <span class="n">coadddata</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">snr</span> <span class="o">=</span> <span class="n">coadddata</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">downsample_1d</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">samplefactor</span><span class="p">),</span>
             <span class="n">downsample_1d</span><span class="p">(</span><span class="n">snr</span><span class="p">,</span> <span class="n">samplefactor</span><span class="p">),</span>
             <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

    <span class="n">targ</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">coaddfile</span><span class="p">,</span> <span class="s1">&#39;TARGNAME&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">coaddfile</span><span class="p">,</span> <span class="s1">&#39;PROPOSID&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ins</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">coaddfile</span><span class="p">,</span> <span class="s1">&#39;INSTRUME&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Betelgeuse - </span><span class="si">{</span><span class="n">ins</span><span class="si">}</span><span class="s1"> - PID </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength [$\AA$]&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Signal-to-Noise&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Show the plot below</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We can see from these plots that the flux and SNR decrease the further away from the center of the star you get.</p>
<p><a id = stisflux></a></p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="example-3-a-stis-dataset-with-flux-rejection">
<h1>Example 3: A STIS dataset with flux rejection<a class="headerlink" href="#example-3-a-stis-dataset-with-flux-rejection" title="Permalink to this heading">#</a></h1>
<p><a id = data3></a></p>
<section id="id3">
<h2>3.1 Obtaining Data Products<a class="headerlink" href="#id3" title="Permalink to this heading">#</a></h2>
<p>For the next example, we will at Program ID 16196, a COS and STIS program that observed <a class="reference external" href="https://simbad.cds.unistra.fr/simbad/sim-basic?Ident=mrk+817&amp;submit=SIMBAD+search">MRK-817</a>.</p>
<p>We will again use <code class="docutils literal notranslate"><span class="pre">astroquery</span></code> to download the dataproducts for this program. We will create a folder called <code class="docutils literal notranslate"><span class="pre">./16655</span></code> for the 1D extracted COS and STIS spectra (<code class="docutils literal notranslate"><span class="pre">x1ds</span></code> and <code class="docutils literal notranslate"><span class="pre">sx1s</span></code>) for all visits in this program, as well as the <code class="docutils literal notranslate"><span class="pre">x1dsums</span></code> for the COS data. We will also create a subfolder called <code class="docutils literal notranslate"><span class="pre">products</span></code>, which will store the downloaded coadded data. The log file for this program is named <code class="docutils literal notranslate"><span class="pre">HASP_16196.out</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Creating directories for our data and coadded products</span>
<span class="n">datadir_ex3</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./16196/&quot;</span><span class="p">)</span>
<span class="n">productsdir_ex3</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./16196/products/&quot;</span><span class="p">)</span>

<span class="n">datadir_ex3</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">productsdir_ex3</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span> output

<span class="c1"># Querying and downloading calibrated products</span>
<span class="n">query_ex3</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span>
    <span class="n">proposal_id</span><span class="o">=</span><span class="mi">16196</span><span class="p">,</span> 
    <span class="n">provenance_name</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CALSTIS&quot;</span><span class="p">,</span> <span class="s2">&quot;CALCOS&quot;</span><span class="p">],</span>
    <span class="n">target_name</span><span class="o">=</span><span class="s2">&quot;MRK-817&quot;</span>
<span class="p">)</span>

<span class="n">prodlist_ex3</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span>
    <span class="n">query_ex3</span>
<span class="p">)</span>

<span class="n">prodlist_ex3</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">filter_products</span><span class="p">(</span>
    <span class="n">prodlist_ex3</span><span class="p">,</span>
    <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CALSTIS&quot;</span><span class="p">,</span> <span class="s2">&quot;CALCOS&quot;</span><span class="p">],</span>
    <span class="n">productSubGroupDescription</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X1D&quot;</span><span class="p">,</span> <span class="s2">&quot;X1DSUM&quot;</span><span class="p">,</span> <span class="s2">&quot;SX1&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Querying and downloading coadded products</span>
<span class="n">query_ex3_coadds</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span>
    <span class="n">proposal_id</span><span class="o">=</span><span class="mi">16196</span><span class="p">,</span> 
    <span class="n">provenance_name</span><span class="o">=</span><span class="s2">&quot;HASP&quot;</span><span class="p">,</span>
    <span class="n">target_name</span><span class="o">=</span><span class="s2">&quot;MRK-817&quot;</span>
<span class="p">)</span>

<span class="n">prodlist_ex3_coadds</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span>
    <span class="n">query_ex3_coadds</span>
<span class="p">)</span>

<span class="n">prodlist_ex3_coadds</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">filter_products</span><span class="p">(</span>
    <span class="n">prodlist_ex3_coadds</span><span class="p">,</span> 
    <span class="n">productType</span><span class="o">=</span><span class="s2">&quot;SCIENCE&quot;</span><span class="p">,</span>
    <span class="n">productSubGroupDescription</span><span class="o">=</span><span class="s2">&quot;CSPEC&quot;</span>
<span class="p">)</span>

<span class="c1"># Combining the two product lists</span>
<span class="n">combined_ex3</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">([</span><span class="n">prodlist_ex3</span><span class="p">,</span> <span class="n">prodlist_ex3_coadds</span><span class="p">])</span>

<span class="c1"># Downloading the products</span>
<span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span>
    <span class="n">combined_ex3</span><span class="p">,</span>
    <span class="n">download_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">datadir_ex3</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Organizing the files </span>
<span class="n">consolidate_files</span><span class="p">(</span><span class="n">datadir_ex3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;output.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use `glob` to make a list of every x1d file available in MAST for this PID</span>
<span class="c1"># Then print out a table of some table info on the program</span>
<span class="c1"># Note that this program has both x1d and sx1 extracted data products!</span>
<span class="n">allfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir_ex3</span><span class="p">,</span> <span class="s1">&#39;*_x1d.fits&#39;</span><span class="p">))</span>\
         <span class="o">+</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir_ex3</span><span class="p">,</span> <span class="s1">&#39;*_sx1.fits&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;rootname  target  visit  grating&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">myfile</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">allfiles</span><span class="p">):</span>
    <span class="n">hdr0</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">myfile</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;rootname&#39;</span><span class="p">],</span> <span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;targname&#39;</span><span class="p">],</span>
          <span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;obset_id&#39;</span><span class="p">],</span> <span class="n">hdr0</span><span class="p">[</span><span class="s1">&#39;opt_elem&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;N files from MAST = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">allfiles</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a id = logs3></a></p>
</section>
<section id="examining-output-logs">
<h2>3.2 Examining Output Logs<a class="headerlink" href="#examining-output-logs" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up path to the coadd log file</span>
<span class="n">logfile</span> <span class="o">=</span> <span class="s1">&#39;./logfiles/HASP_16196.out&#39;</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use find_rejects function from first example to make a list of rejected files</span>
<span class="n">listofprerejects</span><span class="p">,</span> <span class="n">listoffluxrejects</span> <span class="o">=</span> <span class="n">find_rejects</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;16196&#39;</span><span class="p">,</span> <span class="n">allfiles</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Files removed before co-addition:&#39;</span><span class="p">)</span>
<span class="p">[</span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">listofprerejects</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Files removed by flux checker: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">listoffluxrejects</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of files removed before co-addition = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">listofprerejects</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of files removed by flux checker = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">listoffluxrejects</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>As you can see, many files were removed before the co-add began, and many more were removed by the flux checker! If you’re curious, we can also look through the headers for the rejected files too.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check out the headers of the files for quality</span>
<span class="n">readheaders</span><span class="p">(</span><span class="n">listofprerejects</span><span class="p">,</span> <span class="n">datadir_ex3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Taking a glance at the output in the cell above, we can see that many files have data quality issues. We can create a co-add with the data quality filtering left on, but the flux checker turned off. These types of data products can be useful in cases where the science doesn’t depend on the accuracy of the data’s absolute flux.</p>
<p><a id = coadd3></a></p>
</section>
<section id="id4">
<h2>3.3 Running <code class="docutils literal notranslate"><span class="pre">coadd</span></code><a class="headerlink" href="#id4" title="Permalink to this heading">#</a></h2>
<p>Since we want to co-add everything again, just without the flux filtering, we don’t need to make a new data sub-directory. We should change the output directory name so that the original co-adds are not overwritten. We run <code class="docutils literal notranslate"><span class="pre">coadd</span></code> similarly to <span class="xref myst">Section 1.4</span>, but this time with just the <code class="docutils literal notranslate"><span class="pre">-t</span> <span class="pre">-999</span></code> flag.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up the path to your data directory</span>
<span class="n">finaldatadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir_ex3</span><span class="p">,</span> <span class="s1">&#39;products_nofluxfilter&#39;</span><span class="p">)</span>

<span class="c1"># Make on output directory</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">finaldatadir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And now we run <code class="docutils literal notranslate"><span class="pre">coadd</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%capture output

!swrapper -i ./16196/ -o ./16196/products_nofluxfilter -t -999
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;output.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Because of the number of datasets, this co-add takes much longer to compute. Once it’s done, we can plot the results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Clear the older plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

<span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;hst_16196_cos-stis_mrk-817_g130m-g160m-sg230l-g430l-g750l_lede_cspec.fits&#39;</span>

<span class="c1"># Plot the old coadd</span>
<span class="n">oldcoaddfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir_ex3</span><span class="p">,</span> <span class="s1">&#39;products&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
<span class="n">oldcoadddata</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">oldcoaddfile</span><span class="p">)</span>
<span class="n">oldwavelength</span> <span class="o">=</span> <span class="n">oldcoadddata</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">oldflux</span> <span class="o">=</span> <span class="n">oldcoadddata</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">downsample_1d</span><span class="p">(</span><span class="n">oldwavelength</span><span class="p">,</span> <span class="n">samplefactor</span><span class="p">),</span>
         <span class="n">downsample_1d</span><span class="p">(</span><span class="n">oldflux</span><span class="p">,</span> <span class="n">samplefactor</span><span class="p">),</span>
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;coadd w/ flux filter&#39;</span><span class="p">,</span>
         <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="c1"># Plot the new coadd</span>
<span class="n">newcoaddfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir_ex3</span><span class="p">,</span> <span class="s1">&#39;products_nofluxfilter&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
<span class="n">newcoadddata</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">newcoaddfile</span><span class="p">)</span>
<span class="n">newwavelength</span> <span class="o">=</span> <span class="n">newcoadddata</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">newflux</span> <span class="o">=</span> <span class="n">newcoadddata</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">downsample_1d</span><span class="p">(</span><span class="n">newwavelength</span><span class="p">,</span> <span class="n">samplefactor</span><span class="p">),</span>
         <span class="n">downsample_1d</span><span class="p">(</span><span class="n">newflux</span><span class="p">,</span> <span class="n">samplefactor</span><span class="p">),</span>
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;coadd w/o flux filter&#39;</span><span class="p">,</span>
         <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="n">targ</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">coaddfile</span><span class="p">,</span> <span class="s1">&#39;TARGNAME&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">pid</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">coaddfile</span><span class="p">,</span> <span class="s1">&#39;PROPOSID&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ins</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">coaddfile</span><span class="p">,</span> <span class="s1">&#39;INSTRUME&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">targ</span><span class="si">}</span><span class="s1"> - </span><span class="si">{</span><span class="n">ins</span><span class="si">}</span><span class="s1"> - PID </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength [$\AA$]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Flux [$erg\ s^{-1}\ cm^{-2}\ \AA^{-1}$]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Show the plot below</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The plot above shows that the flux is lower in the dataset made without the flux checker on. This means that the previously-rejected datasets were of lower flux. However, zooming in on some of the absorption features, we can see that the wings of some lines are broader in the dataset with no flux rejection, which can be useful in some science cases where these features are faint.</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="happy-co-adding">
<h1>Happy co-adding!<a class="headerlink" href="#happy-co-adding" title="Permalink to this heading">#</a></h1>
<section id="there-are-more-tutorial-notebooks-for-custom-co-addition-cases-in-this-repo-check-them-out">
<h2>There are more tutorial notebooks for custom co-addition cases in <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/tree/main/notebooks/HASP/Setup">this repo</a>, check them out!<a class="headerlink" href="#there-are-more-tutorial-notebooks-for-custom-co-addition-cases-in-this-repo-check-them-out" title="Permalink to this heading">#</a></h2>
</section>
<section id="about-this-notebook">
<h2>About this Notebook<a class="headerlink" href="#about-this-notebook" title="Permalink to this heading">#</a></h2>
<p><strong>Authors:</strong> Elaine Frazer (efrazer&#64;stsci.edu), Sierra Gomez (sigomez&#64;stsci.edu), Debopam Som (dsom&#64;stsci.edu), Anna Payne (apayne&#64;stsci.edu)</p>
<p><strong>Updated on:</strong> 10/20/2024</p>
<p><em>This tutorial was generated to be in compliance with the <a class="reference external" href="https://github.com/spacetelescope/style-guides">STScI style guides</a> and would like to cite the <a class="reference external" href="https://github.com/spacetelescope/style-guides/blob/master/templates/example_notebook.ipynb">Jupyter guide</a> in particular.</em></p>
</section>
<section id="citations">
<h2>Citations<a class="headerlink" href="#citations" title="Permalink to this heading">#</a></h2>
<p>If you use <code class="docutils literal notranslate"><span class="pre">astropy</span></code>, <code class="docutils literal notranslate"><span class="pre">astroquery</span></code>, <code class="docutils literal notranslate"><span class="pre">numpy</span></code>, or <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code>, for published research, please cite the authors. Follow these links for more information about citations:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.astropy.org/en/stable/index.html">Citing <code class="docutils literal notranslate"><span class="pre">astropy</span></code></a></p></li>
<li><p><a class="reference external" href="https://astroquery.readthedocs.io/en/latest/">Citing <code class="docutils literal notranslate"><span class="pre">astroquery</span></code></a></p></li>
<li><p><a class="reference external" href="https://matplotlib.org/stable/users/project/citing.html">Citing <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code></a></p></li>
<li><p><a class="reference external" href="https://numpy.org/citing-numpy/">Citing <code class="docutils literal notranslate"><span class="pre">numpy</span></code></a></p></li>
</ul>
<hr class="docutils" />
<p><span class="xref myst">Top of Page</span>
<a class="reference internal" href="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png"><img alt="Space Telescope Logo" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="width: 200px;" /></a></p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/hst_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/HASP/DataDiagnostic"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../FluxScaleTutorial/FluxScaleTutorial.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Scaling Flux while using the Hubble Advanced Spectral Products Script</p>
      </div>
    </a>
    <a class="right-next"
       href="../WavelengthAdjustment/WavelengthAdjustment.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Wavelength Adjustments for Running the Hubble Advanced Spectral Products (HASP) Script</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">HASP Data Diagnostic Notebook</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#this-notebook-will-walk-you-through-how-to-examine-the-input-spectra-for-the-hasp-coadd-code-and-determine-what-was-and-was-not-included-in-the-co-added-data-product-output">This notebook will walk you through how to examine the input spectra for the HASP <code class="docutils literal notranslate"><span class="pre">coadd</span></code> code and determine what was and was not included in the co-added data product output.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">0. Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1-two-cos-datasets-rejected-for-different-reasons">Example 1: Two COS datasets rejected for different reasons</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#obtaining-data-products">1.1 Obtaining Data Products</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#examining-output-logs-and-headers">1.2 Examining Output Logs and Headers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-constituent-and-co-added-spectra">1.3 Plotting Constituent and Co-added Spectra</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#re-running-coadd">1.4 Re-running <code class="docutils literal notranslate"><span class="pre">coadd</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#replot-the-co-added-data">Replot the co-added data</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2-a-stis-dataset-with-postarg-offsets">Example 2: A STIS dataset with POSTARG offsets</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">2.1 Obtaining Data Products</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">2.2 Examining Output Logs and Headers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-coadd">2.3 Running <code class="docutils literal notranslate"><span class="pre">coadd</span></code></a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#example-3-a-stis-dataset-with-flux-rejection">Example 3: A STIS dataset with flux rejection</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">3.1 Obtaining Data Products</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#examining-output-logs">3.2 Examining Output Logs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">3.3 Running <code class="docutils literal notranslate"><span class="pre">coadd</span></code></a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#happy-co-adding">Happy co-adding!</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#there-are-more-tutorial-notebooks-for-custom-co-addition-cases-in-this-repo-check-them-out">There are more tutorial notebooks for custom co-addition cases in this repo, check them out!</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#citations">Citations</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>