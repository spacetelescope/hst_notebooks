

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Wavelength Adjustments for Running the Hubble Advanced Spectral Products (HASP) Script &#8212; HST Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/table.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/HASP/WavelengthAdjustment/WavelengthAdjustment';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Combining COS Data from Multiple Lifetime Positions and Central Wavelengths" href="../COSLifetimePositions/COSLifetimePositions.html" />
    <link rel="prev" title="HASP Data Diagnostic Notebook" href="../DataDiagnostic/DataDiagnostics.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="HST Notebooks - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="HST Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../index.html">
                    STScI HST Notebook Repository HQ
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">ACS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../ACS/README.html">ACS Notebooks</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_findsat_mrt/acs_findsat_mrt_example.html">Satellite trail detection in ACS/WFC data using acstools.findsat_mrt</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_saturation_trails/acs_saturation_trails.html">ACS Linearity with Saturated Stars</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_cte_forward_model/acs_cte_forward_model_example.html">Pixel-based ACS/WFC CTE Forward Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_subarrays/acs_subarrays.html">ACS Image Reduction for Subarray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_sbc_dark_analysis/acs_sbc_dark_analysis.html">SBC Dark Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_reduction/acs_reduction.html">ACS/WFC Image Reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_pixel_area_maps/acs_pixel_area_maps.html">Obtaining Pixel Area Maps for ACS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_polarization_tools/acs_polarization_tools.html">Using ACS Polarization Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_focus_diverse_epsfs/acs_focus_diverse_epsfs.html">Focus Diverse ePSFs for ACS/WFC</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_exception_report/exception_report_checks.html">HST Exception Report - Investigate your ACS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/hst_orbits_ephem/hst_orbits_ephem.html">Getting HST Ephemeris and Related Data for an Observation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">COS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../COS/README.html">COS Notebooks</a></li>



<li class="toctree-l1"><a class="reference internal" href="../../COS/Setup/Setup.html">Setting up your computer environment for working with COS data</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/DataDl/DataDl.html">Downloading COS Data</a></li>




<li class="toctree-l1"><a class="reference internal" href="../../COS/ViewData/ViewData.html">Viewing COS Data</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/AsnFile/AsnFile.html">Modifying or Creating an Association File</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/CalCOS/CalCOS.html">Running the COS Data Pipeline (<code class="docutils literal notranslate"><span class="pre">CalCOS</span></code>)</a></li>






<li class="toctree-l1"><a class="reference internal" href="../../COS/SplitTag/SplitTag.html">Splitting COS Exposures into sub-exposures with <code class="docutils literal notranslate"><span class="pre">splittag</span></code></a></li>







<li class="toctree-l1"><a class="reference internal" href="../../COS/DayNight/DayNight.html">Filtering out COS Data taken during the Day or Night</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../COS/LSF/LSF.html">Working with the COS Line Spread Function (LSF)</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../COS/Extract/Extract.html">Editing the extraction boxes in a spectral extraction file (<code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>)</a></li>







<li class="toctree-l1"><a class="reference internal" href="../../COS/ExceptionReport/ExceptionReport.html">What to do when you get an Exception Report for COS</a></li>







</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">DrizzlePac</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/README.html">DrizzlePac Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/using_updated_astrometry_solutions/using_updated_astrometry_solutions.html">Improving Astrometry Using Alternate WCS Solutions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_to_catalogs/align_to_catalogs.html">Aligning HST images to an Absolute Reference Catalog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_sparse_fields/align_sparse_fields.html">Aligning Deep Exposures of Sparse Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_multiple_visits/align_multiple_visits.html">Optimizing Image Alignment for Multiple HST Visits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/use_ds9_regions_in_tweakreg/use_ds9_regions_in_tweakreg.html">TWEAKREG Tips - Using DS9 Regions for Source Inclusion/Exclusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/optimize_image_sampling/optimize_image_sampling.html">Optimizing the Image Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_mosaics/align_mosaics.html">Aligning HST Mosaics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/sky_matching/sky_matching.html">Sky Matching for HST Mosaics <a id="top"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/mask_satellite/mask_satellite.html">Satellite Trail Masking Techniques</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/drizzle_wfpc2/drizzle_wfpc2.html">Drizzling new WFPC2 FLT data products with chip-normalization   </a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">HASP</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Setup/Setup.html">Installing the Hubble Advanced Spectral Products Script</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CoaddTutorial/CoaddTutorial.html">Inputting User Data using the Hubble Advanced Spectral Products Script</a></li>

<li class="toctree-l1"><a class="reference internal" href="../FluxScaleTutorial/FluxScaleTutorial.html">Scaling Flux while using the Hubble Advanced Spectral Products Script</a></li>

<li class="toctree-l1"><a class="reference internal" href="../DataDiagnostic/DataDiagnostics.html">HASP Data Diagnostic Notebook</a></li>




<li class="toctree-l1 current active"><a class="current reference internal" href="#">Wavelength Adjustments for Running the Hubble Advanced Spectral Products (HASP) Script</a></li>

<li class="toctree-l1"><a class="reference internal" href="../COSLifetimePositions/COSLifetimePositions.html">Combining COS Data from Multiple Lifetime Positions and Central Wavelengths</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NICMOS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NICMOS/nicmos_unit_conversion/nicmos_unit_conversion.html">Programmatic Replacements for NICMOS Units Conversion Form</a></li>


</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">STIS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../STIS/README.html">STIS-Notebooks</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../STIS/cross-correlation/cross-correlation.html">Correcting for Missing Wavecals with Cross-Correlation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/custom_ccd_darks/custom_ccd_darks.html">Custom CCD Darks <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/drizpac_notebook/STIS_DrizzlePac_Tutorial.html">STIS DrizzlePac Tutorial <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/CoronagraphyViz/STIS_Coronagraphy_Visualization_v2.html">STIS Coronagraphy Visualization Tool (v2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/calstis/calstis_2d_ccd.html">Calstis 2-D CCD Data Reduction <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/target_acquisition/target_acquisition.html">Evaluating STIS Target Acquisitions <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/view_data/view_data.html">Viewing STIS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/extraction/1D_Extraction.html">1D Spectra Extraction <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/low_count_uncertainties/Low_Count_Uncertainties.html">Low Count Uncertainties in STIS <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/contrast_sensitivity/STIS_Coronagraphic_Observation_Feasibility.html">STIS Coronagraphic Observation Feasibility</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">WFC3</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/README.html">WFC3 Notebooks</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../WFC3/general_tools.html">General Tools</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/image_displayer_analyzer/wfc3_image_displayer_analyzer.html">WFC3 Image Displayer &amp; Analyzer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/exception_report/wfc3_exception_report.html">Exception Report Checklist - WFC3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/calwf3_v1.0_cte/calwf3_with_v1.0_PCTE.html">Processing WFC3/UVIS Data with <code class="docutils literal notranslate"><span class="pre">calwf3</span></code> Using the v1.0 CTE-Correction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/persistence/wfc3_ir_persistence.html">Masking Persistence in WFC3/IR Images</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/uvis_g280_transit/G280_Exoplanet_Transits.html">Analyzing WFC3/UVIS G280 Exoplanet Transit Observations</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../WFC3/ir_tvb.html">WFC3/IR Time Variable Background (TVB)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/ir_ima_visualization/IR_IMA_Visualization_with_an_Example_of_Time_Variable_Background.html">WFC3/IR IMA Visualization Tools with An Example of Time Variable Background</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/calwf3_recalibration/calwf3_recal_tvb.html">Manual Recalibration with calwf3: Turning off the IR Linear Ramp Fit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/tvb_flattenramp/TVB_flattenramp_notebook.html">Correcting for Helium Line Emission Background in IR Exposures using the “Flatten-Ramp” Technique</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/ir_scattered_light_calwf3_corrections/Correcting_for_Scattered_Light_in_IR_Exposures_Using_calwf3_to_Mask_Bad_Reads.html">Correcting for Scattered Light in WFC3/IR Exposures: Using <code class="docutils literal notranslate"><span class="pre">calwf3</span></code> to Mask Bad Reads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/ir_scattered_light_manual_corrections/Correcting_for_Scattered_Light_in_IR_Exposures_by_Manually_Subtracting_Bad_Reads.html">Correcting for Scattered Light in WFC3/IR Exposures: Manually Subtracting Bad Reads</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../WFC3/photometry.html">Photometry</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/filter_transformations/filter_transformations.html">WFC3/UVIS Filter Transformations with stsynphot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/flux_conversion_tool/flux_conversion_tool.html">Flux Unit Conversions with synphot and stsynphot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/photometry_examples/phot_examples.html">Synthetic Photometry Examples for WFC3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/uvis_time_dependent_photometry/uvis_timedep_phot.html">WFC3/UVIS Time-dependent Photometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/zeropoints/zeropoints.html">Calculating WFC3 Zeropoints with STSynphot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/uvis_pam_corrections/WFC3_UVIS_Pixel_Area_Map_Corrections_for_Subarrays.html">WFC3/UVIS Pixel Area Map Corrections for Subarrays</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../WFC3/point_spread_function.html">Point Spread Function (PSF)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/point_spread_function/hst_point_spread_function.html">HST WFC3 Point Spread Function Modeling   </a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/mast_api_psf/download_psf_cutouts.html">Downloading WFC3 and WFPC2 PSF Cutouts from MAST</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/spacetelescope/hst_notebooks/blob/main/notebooks/HASP/WavelengthAdjustment/WavelengthAdjustment.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/hst_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/hst_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/HASP/WavelengthAdjustment/WavelengthAdjustment.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/HASP/WavelengthAdjustment/WavelengthAdjustment.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Wavelength Adjustments for Running the Hubble Advanced Spectral Products (HASP) Script</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Wavelength Adjustments for Running the Hubble Advanced Spectral Products (HASP) Script</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-font-weight-normal-this-notebook-is-designed-to-walk-you-through-making-wavelength-adjustments-to-cos-stis-data-when-running-the-hubble-advanced-spectral-products-hasp-coadd-script-span"><span style="font-weight:normal">This Notebook is designed to walk you through making wavelength adjustments to COS &amp; STIS data when running the <strong>Hubble Advanced Spectral Products (HASP)</strong> coadd script.</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">0. Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#performing-wavelength-adjustments-on-cos-data">1. Performing Wavelength Adjustments on COS Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-and-organizing-cos-data-using-astroquery">1.1 Downloading and Organizing COS Data using <code class="docutils literal notranslate"><span class="pre">Astroquery</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-hasp-script-on-cos-data">1.2 Running the HASP Script on COS Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#identifying-a-wavelength-shift-in-cos-data">1.3 Identifying a Wavelength Shift in COS Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#performing-cross-correlation-on-x1d-cos-data-to-calculate-lag">1.4 Performing Cross-Correlation on <code class="docutils literal notranslate"><span class="pre">X1D</span></code> COS Data to Calculate Lag</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#applying-shifts-to-cos-data-and-re-creating-coadd">1.5 Applying Shifts to COS data and Re-creating Coadd</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-non-shifted-and-shifted-cos-coadds">1.6 Comparing Non-Shifted and Shifted COS Coadds</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#performing-wavelength-adjustments-on-stis-data">2. Performing Wavelength Adjustments on STIS Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-and-organizing-stis-data-using-astroquery">2.1 Downloading and Organizing STIS Data using <code class="docutils literal notranslate"><span class="pre">Astroquery</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-hasp-script-on-stis-data">2.2 Running the HASP Script on STIS Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#performing-cross-correlation-on-stis-data-and-calculating-lag">2.3 Performing Cross-Correlation on STIS data and Calculating Lag</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#applying-shifts-to-raw-stis-data-and-re-creating-coadd">2.4 Applying Shifts to Raw STIS data and Re-creating Coadd</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-non-adjusted-and-adjusted-stis-coadds">2.5 Comparing Non-Adjusted and Adjusted STIS Coadds</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#congrats-on-completing-the-notebook">Congrats on completing the notebook!</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#there-are-more-tutorial-notebooks-for-custom-coaddition-cases-in-this-repo-check-them-out">There are more tutorial notebooks for custom coaddition cases in this repo, check them out!</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#citations">Citations</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="wavelength-adjustments-for-running-the-hubble-advanced-spectral-products-hasp-script">
<h1>Wavelength Adjustments for Running the Hubble Advanced Spectral Products (HASP) Script<a class="headerlink" href="#wavelength-adjustments-for-running-the-hubble-advanced-spectral-products-hasp-script" title="Permalink to this heading">#</a></h1>
<section id="span-style-font-weight-normal-this-notebook-is-designed-to-walk-you-through-making-wavelength-adjustments-to-cos-stis-data-when-running-the-hubble-advanced-spectral-products-hasp-coadd-script-span">
<h2><span style="font-weight:normal">This Notebook is designed to walk you through making wavelength adjustments to COS &amp; STIS data when running the <strong>Hubble Advanced Spectral Products (HASP)</strong> coadd script.</span><a class="headerlink" href="#span-style-font-weight-normal-this-notebook-is-designed-to-walk-you-through-making-wavelength-adjustments-to-cos-stis-data-when-running-the-hubble-advanced-spectral-products-hasp-coadd-script-span" title="Permalink to this heading">#</a></h2>
</section>
<section id="learning-goals">
<h2>Learning Goals:<a class="headerlink" href="#learning-goals" title="Permalink to this heading">#</a></h2>
<p>By the end of this tutorial, you will learn how to:</p>
<ul class="simple">
<li><p>Determine if you must make wavelength adjustments based on your coadded product</p></li>
<li><p>Perform cross-correlation on <code class="docutils literal notranslate"><span class="pre">X1D</span></code> and <code class="docutils literal notranslate"><span class="pre">SX1</span></code> files to determine the wavelength offset between datasets</p></li>
<li><p>Perform wavelength shifts on COS and STIS data using each instrument’s adjustment methods</p></li>
<li><p>Run the coadd code on new data and compare pre- and post-shift coadded spectra</p></li>
</ul>
</section>
<section id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Permalink to this heading">#</a></h2>
<p><strong>0. <span class="xref myst">Introduction</span></strong></p>
<p><strong>1. <span class="xref myst">Performing Wavelength Adjustments on COS Data</span></strong></p>
<p>- 1.1 <span class="xref myst">Downloading and Organizing COS Data using <code class="docutils literal notranslate"><span class="pre">Astroquery</span></code></span></p>
<p>- 1.2 <span class="xref myst">Running the HASP Script on COS Data</span></p>
<p>- 1.3 <span class="xref myst">Identifying a Wavelength Shift in COS Data</span></p>
<p>- 1.4 <span class="xref myst">Performing Cross-Correlation on <code class="docutils literal notranslate"><span class="pre">X1D</span></code> COS data and Calculating Lag</span></p>
<p>- 1.5 <span class="xref myst">Applying Shifts to COS data and Re-creating Coadd</span></p>
<p>- 1.6 <span class="xref myst">Comparing Non-Shifted and Shifted COS Coadds</span></p>
<p><strong>2. <span class="xref myst">Performing Wavelength Adjustments on STIS data</span></strong></p>
<p>- 2.1 <span class="xref myst">Downloading and Organizing STIS Data using <code class="docutils literal notranslate"><span class="pre">Astroquery</span></code></span></p>
<p>- 2.2 <span class="xref myst">Running the HASP Script on STIS Data</span></p>
<p>- 2.3 <span class="xref myst">Performing Cross-Correlation on STIS data and Calculating Lag</span></p>
<p>- 2.4 <span class="xref myst">Applying Shifts to Raw STIS data and Re-creating Coadd</span></p>
<p>- 2.5 <span class="xref myst">Comparing Non-Adjusted and Adjusted STIS Coadds</span></p>
<p><a id = introduction></a></p>
</section>
<section id="introduction">
<h2>0. Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p>The <a class="reference external" href="https://github.com/spacetelescope/hasp">Hubble Advanced Spectral Products (HASP) <code class="docutils literal notranslate"><span class="pre">coadd</span></code> code</a> is a script that coadds spectra of the same target within a program. This software can coadd data taken with the spectrographs onboard the <a class="reference external" href="https://www.stsci.edu/hst">Hubble Space Telescope (HST)</a>: the <a class="reference external" href="https://www.stsci.edu/hst/instrumentation/stis">Space Telescope Imaging Spectrograph (STIS)</a> and the <a class="reference external" href="https://www.stsci.edu/hst/instrumentation/cos">Cosmic Origins Spectrograph (COS)</a>. The <a class="reference external" href="https://archive.stsci.edu/missions-and-data/hst/hasp">Hubble Spectroscopic Legacy Archive (HSLA)</a> uses this script to coadd these instruments’ data from <a class="reference external" href="https://archive.stsci.edu/">The Mikulski Archive for Space Telescopes (MAST)</a> to create high-quality spectra with a broad wavelength coverage that is publicly available for the scientific community. The script first coadds the observations for each grating for a given visit, then it combines all gratings for the observation set. Finally, it coadds the spectra of each observation set in the program to produce a fully coadded spectrum for each target in a program. <a class="reference external" href="https://www.stsci.edu/files/live/sites/www/files/home/hst/instrumentation/cos/documentation/instrument-science-reports-isrs/_documents/ISR2024-01.pdf">Check out the COS 2024-1 ISR for more information about the HASP script and products</a>.</p>
<p>Wavelength alignment between exposures is crucial for performing accurate spectroscopic analysis on your data. Wavelength offsets can occur for a variety of reasons, such as poor centering during target acquisition or thermal fluctuations in between exposures. In addition to inaccurate measurements and the misidentification of spectral features, incorrect wavelength registration can result in the wrong flux sensitivity being applied at each wavelength. For COS in particular, the wavelength throughput decreases for low-resolution spectra and rapidly at shorter wavelengths, thus being more affected by incorrect flux sensitivity applications. It is sometimes necessary for users to manually apply shifts to their raw data to ensure wavelength alignment between files. More information about the wavelength accuracies for the instruments can be found in <a class="reference external" href="https://hst-docs.stsci.edu/cosihb/chapter-5-spectroscopy-with-cos/5-1-the-capabilities-of-cos#id-5.1TheCapabilitiesofCOS-Section5.1.115.1.11WavelengthAccuracy">Chapter 5</a> of the COS Instrument Handbook and <a class="reference external" href="https://hst-docs.stsci.edu/stisdhb/chapter-4-stis-error-sources/4-2-summary-of-accuracies">Chapter 4</a> in the STIS Instrument Handbook.</p>
<p>This notebook will show users how to recognize if their data needs wavelength adjustments, and how to perform these corrections for both COS and STIS data. The example datasets that are used in this tutorial are abnormal – most cases of wavelength shifts are small. It assumes that the user knows how to download MAST data and how to run the coadd code. Check out our <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/tree/main/notebooks/HASP/CoaddTutorial">CoaddTutorial.ipynb</a> notebook for a detailed explanation of how to do both of these things.</p>
<p><strong>Please check out our <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/tree/main/notebooks/HASP/Setup">Setup.ipynb</a> notebook before running this tutorial to learn how to install and run the coadd code.</strong></p>
<section id="imports">
<h3>Imports<a class="headerlink" href="#imports" title="Permalink to this heading">#</a></h3>
<p>We will be using multiple libraries to retrieve and analyze data. We will use:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">os</span></code>, <code class="docutils literal notranslate"><span class="pre">shutil</span></code>, <code class="docutils literal notranslate"><span class="pre">Path.pathlib</span></code>, and <code class="docutils literal notranslate"><span class="pre">glob</span></code> to work with our system’s directories and filepaths</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">matplotlib.pyplot</span></code> to plot our data and shifts</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">numpy</span></code> to perform analysis on our data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">astroquery.mast</span></code> to download our STIS and COS datasets for the exercises</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">astropy.io</span> <span class="pre">fits</span></code> to read the corresponding <code class="docutils literal notranslate"><span class="pre">FITS</span></code> files</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">calcos</span></code> and <code class="docutils literal notranslate"><span class="pre">stistools</span></code> to run the COS and STIS calibration pipelines, respectively</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">scipy.optimize</span></code> to fit a Gaussian when determining the radial velocity</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">astropy.modeling</span></code> and <code class="docutils literal notranslate"><span class="pre">scipy.signal</span></code> to help us fit a quadratic when calculating our shifts</p></li>
</ul>
<p>We recommend creating a HASP-specific <code class="docutils literal notranslate"><span class="pre">conda</span></code> environment when coadding spectra. You can check out our <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/tree/main/notebooks/HASP/Setup">Setup.ipynb</a> notebook to create such an environment. Alternatively, you can also download the required dependencies to run this notebook with the terminal command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<p>This will download the dependencies that are necessary to run this current notebook. You will also need to install <code class="docutils literal notranslate"><span class="pre">hstcal</span></code> to run the STIS portion of this notebook. You can run the command below in your terminal after you’ve activated your <code class="docutils literal notranslate"><span class="pre">conda</span></code> environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conda</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="o">-</span><span class="n">c</span> <span class="n">conda</span><span class="o">-</span><span class="n">forge</span> <span class="n">hstcal</span><span class="o">==</span><span class="mf">3.0.3</span>
</pre></div>
</div>
<p>Or, similar to the <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> file, you can run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bash</span> <span class="n">pre</span><span class="o">-</span><span class="n">requirements</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>Let’s import all of the packages that we will use in this notebook and print our <code class="docutils literal notranslate"><span class="pre">conda</span></code> environment by running the next cell:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.mast</span><span class="w"> </span><span class="kn">import</span> <span class="n">Observations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">calcos</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">stistools</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.modeling</span><span class="w"> </span><span class="kn">import</span> <span class="n">fitting</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.modeling.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Polynomial1D</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.signal</span><span class="w"> </span><span class="kn">import</span> <span class="n">correlate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.signal</span><span class="w"> </span><span class="kn">import</span> <span class="n">correlation_lags</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">optimize</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">clear_output</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Currently active conda environment:&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CONDA_PREFIX&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/runner/micromamba/envs/hstcal/lib/python3.12/site-packages/stsci/tools/nmpfit.py:8: UserWarning: NMPFIT is deprecated - stsci.tools v 3.5 is the last version to contain it.
  warnings.warn(&quot;NMPFIT is deprecated - stsci.tools v 3.5 is the last version to contain it.&quot;)
/home/runner/micromamba/envs/hstcal/lib/python3.12/site-packages/stsci/tools/gfit.py:18: UserWarning: GFIT is deprecated - stsci.tools v 3.4.12 is the last version to contain it.Use astropy.modeling instead.
  warnings.warn(&quot;GFIT is deprecated - stsci.tools v 3.4.12 is the last version to contain it.&quot;
/home/runner/micromamba/envs/hstcal/lib/python3.12/site-packages/stistools/defringe/prepspec.py:68: SyntaxWarning: invalid escape sequence &#39;\.&#39;
  sci_root = re.split(&#39;\.fits.*&#39;, os.path.basename(science_data),
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/runner/micromamba/envs/hstcal/lib/python3.12/site-packages/stistools/defringe/defringe.py:69: SyntaxWarning: invalid escape sequence &#39;\.&#39;
  sci_root = re.split(&#39;\.fits.*&#39;, sci_filename, flags=re.IGNORECASE)[0].rsplit(&#39;_&#39;,1)[0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The following tasks in the stistools package can be run with TEAL:
   basic2d      calstis     ocrreject     wavecal        x1d          x2d
Currently active conda environment: /home/runner/micromamba/envs/hstcal
</pre></div>
</div>
</div>
</div>
<p>Since we will be running both <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> and <code class="docutils literal notranslate"><span class="pre">CalSTIS</span></code>, we will need to set up environment variables for when we use the <a class="reference external" href="https://hst-crds.stsci.edu/">Calibration Reference Data System</a>. Much of this is gone in detail in the COS notebook, <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/blob/main/notebooks/COS/Setup/Setup.ipynb">Setup.ipynb</a> notebook. We will download the STIS reference files in a later cell since we’ll need the data downloaded.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We will set the CRDS_PATH environment_variable</span>
<span class="c1"># Creating path to where the files are saved</span>
<span class="n">crds_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;HOME&quot;</span><span class="p">],</span> <span class="s2">&quot;crds_cache&quot;</span><span class="p">)</span>

<span class="c1"># Setting the environment variable CRDS_PATH to our CRDS path</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CRDS_PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crds_path</span>

<span class="c1"># URL for the STScI CRDS page</span>
<span class="n">crds_server_url</span> <span class="o">=</span> <span class="s2">&quot;https://hst-crds.stsci.edu&quot;</span>

<span class="c1"># Setting env variable to URL</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CRDS_SERVER_URL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crds_server_url</span>

<span class="c1"># Set the lref environment variable (COS)</span>
<span class="n">lref</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">crds_path</span><span class="p">,</span> <span class="s2">&quot;references/hst/cos&quot;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;lref&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lref</span>

<span class="o">!</span>crds<span class="w"> </span>sync<span class="w"> </span>--contexts<span class="w"> </span>hst_cos_0374.imap<span class="w"> </span>--fetch-references
<span class="n">clear_output</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We will create a function to consolidate and organize our data since we will be utilizing it for two datasets in the tutorial. The coadd script requires all <code class="docutils literal notranslate"><span class="pre">X1D</span></code> and <code class="docutils literal notranslate"><span class="pre">SX1</span></code> files to be in a single directory to be coadded. When downloading data from MAST, it creates multiple directories: <code class="docutils literal notranslate"><span class="pre">./mastDownload/HST</span></code> and within this directory are sub-directories for each observation set. We will move all of the files in these sub-directories to the respective STIS/COS directory.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">consolidate_files</span><span class="p">(</span><span class="n">data_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Consolidate all files to single directory; necessary for HASP script run.</span>
<span class="sd">    ---------------</span>
<span class="sd">    Input:</span>
<span class="sd">    Path data_path: Path object to the directory where the files should be moved.</span>
<span class="sd">    ---------------</span>
<span class="sd">    Output:</span>
<span class="sd">    None. Files moved to data_path. ./mastDownload/HST directory is deleted.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># The path to all obs_id folders</span>
    <span class="n">mast_path</span> <span class="o">=</span> <span class="n">data_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;mastDownload/HST/&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">obs_id_path</span> <span class="ow">in</span> <span class="n">mast_path</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">obs_id_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*fits&quot;</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="p">),</span> <span class="n">data_path</span> <span class="o">/</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">mast_path</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a id = maincos></a></p>
</section>
</section>
<section id="performing-wavelength-adjustments-on-cos-data">
<h2>1. Performing Wavelength Adjustments on COS Data<a class="headerlink" href="#performing-wavelength-adjustments-on-cos-data" title="Permalink to this heading">#</a></h2>
<p>During science exposures, the wavelength calibration aperture is illuminated by two Pt-Ne lamps, which are used as a template by <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> to assign wavelengths to positions on the COS detector. A zero-point shift is then applied to the science data to align the wavelength calibration exposure and the science exposure. These wavelength calibration exposures are taken simultaneously with science exposures (except LP6 exposures; more information about LP6 wavecals in <a class="reference external" href="https://hst-docs.stsci.edu/cosihb/chapter-5-spectroscopy-with-cos/5-7-internal-wavelength-calibration-exposures#id-5.7InternalWavelengthCalibrationExposures-Section5.7.65.7.6SPLITWavecals(defaultnon-concurrentwavelengthcalibrationatLP6)">Chapter 5.7.6</a> of the COS Instrument Handbook). Information about COS wavelength accuracies can be found in <a class="reference external" href="https://hst-docs.stsci.edu/cosihb/chapter-5-spectroscopy-with-cos/5-1-the-capabilities-of-cos#id-5.1TheCapabilitiesofCOS-Section5.1.115.1.11WavelengthAccuracy">Chapter 5.1.11</a> of the COS Instrument Handbook.</p>
<p>We will create a few different directories for our COS example.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To hold all of our COS example&#39;s output and data</span>
<span class="n">cos_ex</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./cos_ex/&quot;</span><span class="p">)</span>

<span class="c1"># Contains the RAWTAG and ASN files</span>
<span class="n">cos_data</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./cos_ex/cos_data/&quot;</span><span class="p">)</span>

<span class="c1"># Holds the unshifted X1Ds and the respective coadd</span>
<span class="n">cos_unshifted</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./cos_ex/cos_unshifted/&quot;</span><span class="p">)</span>
<span class="n">cos_unshifted_coadd</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./cos_ex/cos_unshifted/coadd/&quot;</span><span class="p">)</span>

<span class="c1"># Will contain the X1Ds created with the shift applied, and respective coadd</span>
<span class="n">cos_shifted</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./cos_ex/cos_shifted/&quot;</span><span class="p">)</span>
<span class="n">cos_shifted_coadd</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./cos_ex/cos_shifted/coadd/&quot;</span><span class="p">)</span>

<span class="c1"># If the directory doesn&#39;t exist, then create it</span>
<span class="n">cos_ex</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">cos_data</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">cos_unshifted</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cos_unshifted_coadd</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">cos_shifted</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cos_shifted_coadd</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We will be shifting COS FUV spectra of the target <a class="reference external" href="http://simbad.cds.unistra.fr/simbad/sim-id?Ident=%409822397&amp;Name=%5bM2002%5d%20LMC%20%2071747&amp;submit=submit">LMC079-1</a>, a <a class="reference external" href="https://en.wikipedia.org/wiki/Wolf%E2%80%93Rayet_star">Wolf-Rayet star</a> observed in the first visit of Program 15824. We will download the dataset from the first visit of this program, <code class="docutils literal notranslate"><span class="pre">LE2701010</span></code>, which observes the target at <code class="docutils literal notranslate"><span class="pre">LP4</span></code> using the grating and central wavelength <code class="docutils literal notranslate"><span class="pre">G160M/1577</span></code>.</p>
<p><a id = cosdownload></a></p>
<section id="downloading-and-organizing-cos-data-using-astroquery">
<h3>1.1 Downloading and Organizing COS Data using <code class="docutils literal notranslate"><span class="pre">Astroquery</span></code><a class="headerlink" href="#downloading-and-organizing-cos-data-using-astroquery" title="Permalink to this heading">#</a></h3>
<p>We will start by downloading our dataset using <code class="docutils literal notranslate"><span class="pre">astroquery.mast</span> <span class="pre">Observations</span></code> module; we will go through this <em>very</em> briefly, so if you are unfamiliar with downloading MAST data using <code class="docutils literal notranslate"><span class="pre">astroquery</span></code>, please check out our <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/tree/main/notebooks/HASP/CoaddTutorial">CoaddTutorial.ipynb</a> notebook.</p>
<p>To run the coadd script, we will need to download the <code class="docutils literal notranslate"><span class="pre">X1D</span></code> files. To perform our wavelength adjustments, we will need to download the <code class="docutils literal notranslate"><span class="pre">RAWTAG</span></code> and <code class="docutils literal notranslate"><span class="pre">ASN</span></code> files since we will be calculating the pixel offset between the <code class="docutils literal notranslate"><span class="pre">X1D</span></code> files and re-running the COS calibration pipeline (<code class="docutils literal notranslate"><span class="pre">CalCOS</span></code>). Let’s do so in the cell below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Querying MAST for our dataset</span>
<span class="n">cos_query</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span>
    <span class="n">obs_id</span><span class="o">=</span><span class="s2">&quot;LE2701010&quot;</span>
<span class="p">)</span>

<span class="c1"># Getting a list of products for this dataset</span>
<span class="n">cos_products</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span>
    <span class="n">cos_query</span>
<span class="p">)</span>

<span class="c1"># A list of files that we need to run the coadd script and CalCOS</span>
<span class="n">necessary_filetypes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;X1D&quot;</span><span class="p">,</span> <span class="s2">&quot;RAWTAG_A&quot;</span><span class="p">,</span> <span class="s2">&quot;RAWTAG_B&quot;</span><span class="p">,</span> <span class="s2">&quot;ASN&quot;</span><span class="p">]</span>

<span class="c1"># Downloading the products</span>
<span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span>
    <span class="n">cos_products</span><span class="p">,</span>
    <span class="n">download_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cos_data</span><span class="p">),</span>
    <span class="n">productSubGroupDescription</span><span class="o">=</span><span class="n">necessary_filetypes</span>
<span class="p">)</span>

<span class="c1"># Moving all files to single directory and deleting mastDownload</span>
<span class="n">consolidate_files</span><span class="p">(</span><span class="n">cos_data</span><span class="p">)</span>

<span class="c1"># Now moving all of the original X1Ds to cos_unshifted</span>
<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">cos_data</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*x1d*&quot;</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="p">),</span> <span class="n">cos_unshifted</span> <span class="o">/</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/le2701010_asn.fits to cos_ex/cos_data/mastDownload/HST/le2701010/le2701010_asn.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/le2701q0q_rawtag_a.fits to cos_ex/cos_data/mastDownload/HST/le2701q0q/le2701q0q_rawtag_a.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/le2701q0q_rawtag_b.fits to cos_ex/cos_data/mastDownload/HST/le2701q0q/le2701q0q_rawtag_b.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/le2701q0q_x1d.fits to cos_ex/cos_data/mastDownload/HST/le2701q0q/le2701q0q_x1d.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/le2701q2q_rawtag_a.fits to cos_ex/cos_data/mastDownload/HST/le2701q2q/le2701q2q_rawtag_a.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/le2701q2q_rawtag_b.fits to cos_ex/cos_data/mastDownload/HST/le2701q2q/le2701q2q_rawtag_b.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/le2701q2q_x1d.fits to cos_ex/cos_data/mastDownload/HST/le2701q2q/le2701q2q_x1d.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/le2701q4q_rawtag_a.fits to cos_ex/cos_data/mastDownload/HST/le2701q4q/le2701q4q_rawtag_a.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/le2701q4q_rawtag_b.fits to cos_ex/cos_data/mastDownload/HST/le2701q4q/le2701q4q_rawtag_b.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/le2701q4q_x1d.fits to cos_ex/cos_data/mastDownload/HST/le2701q4q/le2701q4q_x1d.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/le2701q6q_rawtag_a.fits to cos_ex/cos_data/mastDownload/HST/le2701q6q/le2701q6q_rawtag_a.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/le2701q6q_rawtag_b.fits to cos_ex/cos_data/mastDownload/HST/le2701q6q/le2701q6q_rawtag_b.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/le2701q6q_x1d.fits to cos_ex/cos_data/mastDownload/HST/le2701q6q/le2701q6q_x1d.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
</div>
</div>
<p><a id = scriptrun1_cos></a></p>
</section>
<section id="running-the-hasp-script-on-cos-data">
<h3>1.2 Running the HASP Script on COS Data<a class="headerlink" href="#running-the-hasp-script-on-cos-data" title="Permalink to this heading">#</a></h3>
<p>Now that we’ve downloaded our data, we can run our coadd code. We can run the HASP coadd script, saving our coadded data products to the <code class="docutils literal notranslate"><span class="pre">./cos_ex/cos_unshifted/coadd/</span></code> directory:</p>
<p><strong>Note: Again, this notebook will not go into specifics about running the script and analyzing the output files. Please check out our <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/tree/main/notebooks/HASP/CoaddTutorial">CoaddTutorial.ipynb</a> to learn more about running the script.</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>swrapper<span class="w"> </span>-i<span class="w"> </span>./cos_ex/cos_unshifted<span class="w"> </span>-o<span class="w"> </span>./cos_ex/cos_unshifted/coadd
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>HASP version 1.2.3
Ullyses version 4.1.0
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Creating list of unique modes from these files:
./cos_ex/cos_unshifted/le2701q0q_x1d.fits LMC079-1 COS FUV G160M PSA 4 15824 (15824, &#39;01&#39;)
./cos_ex/cos_unshifted/le2701q2q_x1d.fits LMC079-1 COS FUV G160M PSA 4 15824 (15824, &#39;01&#39;)
./cos_ex/cos_unshifted/le2701q4q_x1d.fits LMC079-1 COS FUV G160M PSA 4 15824 (15824, &#39;01&#39;)
./cos_ex/cos_unshifted/le2701q6q_x1d.fits LMC079-1 COS FUV G160M PSA 4 15824 (15824, &#39;01&#39;)
Looping over visits
Processing product (15824, &#39;01&#39;)
Targets in visit (15824, &#39;01&#39;): [&#39;LMC079-1&#39;]
Processing target LMC079-1 in visit (15824, &#39;01&#39;)
Processing grating COS/G160M
Importing files [&#39;./cos_ex/cos_unshifted/le2701q0q_x1d.fits&#39;, &#39;./cos_ex/cos_unshifted/le2701q2q_x1d.fits&#39;, &#39;./cos_ex/cos_unshifted/le2701q4q_x1d.fits&#39;, &#39;./cos_ex/cos_unshifted/le2701q6q_x1d.fits&#39;]
Processing file ./cos_ex/cos_unshifted/le2701q0q_x1d.fits
Processing file ./cos_ex/cos_unshifted/le2701q2q_x1d.fits
Processing file ./cos_ex/cos_unshifted/le2701q4q_x1d.fits
Processing file ./cos_ex/cos_unshifted/le2701q6q_x1d.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/runner/micromamba/envs/hstcal/lib/python3.12/site-packages/ullyses/coadd.py:563: RuntimeWarning: invalid value encountered in divide
  thru_nans = segment.data[&#39;net&#39;] / segment.data[&#39;flux&#39;]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Using a maximum SNR of 20.0 in flux-based filtering
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Yellow">WARNING</span>: VerifyWarning: Card is too long, comment will be truncated. [astropy.io.fits.card]
   Wrote ./cos_ex/cos_unshifted/coadd/hst_15824_cos_lmc079-1_g160m_le2701_cspec.fits
Only 1 grating to abut, skipping abutment
Looping over proposals
Processing product 15824
Targets in proposal 15824: [&#39;LMC079-1&#39;]
Processing target LMC079-1 in proposal 15824
Processing grating COS/G160M
Importing files [&#39;./cos_ex/cos_unshifted/le2701q0q_x1d.fits&#39;, &#39;./cos_ex/cos_unshifted/le2701q2q_x1d.fits&#39;, &#39;./cos_ex/cos_unshifted/le2701q4q_x1d.fits&#39;, &#39;./cos_ex/cos_unshifted/le2701q6q_x1d.fits&#39;]
Processing file ./cos_ex/cos_unshifted/le2701q0q_x1d.fits
Processing file ./cos_ex/cos_unshifted/le2701q2q_x1d.fits
Processing file ./cos_ex/cos_unshifted/le2701q4q_x1d.fits
Processing file ./cos_ex/cos_unshifted/le2701q6q_x1d.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/runner/micromamba/envs/hstcal/lib/python3.12/site-packages/ullyses/coadd.py:563: RuntimeWarning: invalid value encountered in divide
  thru_nans = segment.data[&#39;net&#39;] / segment.data[&#39;flux&#39;]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Using a maximum SNR of 20.0 in flux-based filtering
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   Wrote ./cos_ex/cos_unshifted/coadd/hst_15824_cos_lmc079-1_g160m_le27_cspec.fits
Only 1 grating to abut, skipping abutment
</pre></div>
</div>
</div>
</div>
<p>We have created two different coadded files by running our script. The file <code class="docutils literal notranslate"><span class="pre">hst_15824_cos_lmc079-1_g160m_le27_cspec.fits</span></code> is our fully coadded spectrum for this program. The other file, <code class="docutils literal notranslate"><span class="pre">hst_15824_cos_lmc079-1_g160m_le2701_cspec.fits</span></code> is the visit-level coadd; if we were to include other visits’ <code class="docutils literal notranslate"><span class="pre">X1D</span></code> files then there would be a similar file created for each visit. Each <code class="docutils literal notranslate"><span class="pre">X1D</span></code> was taken at a different grating offset (<code class="docutils literal notranslate"><span class="pre">FPPOS</span></code>), more information about <code class="docutils literal notranslate"><span class="pre">FPPOS</span></code> is in <a class="reference external" href="https://hst-docs.stsci.edu/cosihb/chapter-5-spectroscopy-with-cos/5-8-fixed-pattern-noise">Section 5.8.2</a> of the COS Instrument Handbook. Let’s plot the coadd in the cell below with the <code class="docutils literal notranslate"><span class="pre">X1D</span></code> files:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Coadd filename</span>
<span class="n">coadd_cos</span> <span class="o">=</span> <span class="s2">&quot;hst_15824_cos_lmc079-1_g160m_le27_cspec.fits&quot;</span>

<span class="c1"># List of X1D files</span>
<span class="n">x1ds</span> <span class="o">=</span> <span class="n">cos_unshifted</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*x1d*&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;cyan&quot;</span><span class="p">,</span> <span class="s2">&quot;orange&quot;</span><span class="p">]</span>

<span class="c1"># Plotting each X1D file</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x1ds</span><span class="p">)):</span>
    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>

        <span class="n">wl</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;WAVELENGTH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FLUX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span>
                 <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                 <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;FPPOS </span><span class="si">{</span><span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FPPOS&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                 <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                 <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

<span class="c1"># Plotting the coadd</span>
<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cos_unshifted_coadd</span> <span class="o">/</span> <span class="n">coadd_cos</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>

    <span class="n">wl_coadd</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;WAVELENGTH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">flux_coadd</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FLUX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wl_coadd</span><span class="p">,</span> <span class="n">flux_coadd</span><span class="p">,</span>
             <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Coadd&quot;</span><span class="p">,</span>
             <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
             <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

<span class="c1"># Formatting and titles</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Coadd and X1D files - LMC079-1 G160M&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength [$\AA$]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Flux [$erg\ s^{-1}\ cm^{-2}\ \AA^{-1}$]&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5e-13</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p><a id = id_shift></a></p>
</section>
<section id="identifying-a-wavelength-shift-in-cos-data">
<h3>1.3 Identifying a Wavelength Shift in COS Data<a class="headerlink" href="#identifying-a-wavelength-shift-in-cos-data" title="Permalink to this heading">#</a></h3>
<p>It is up to the user to determine if their data needs to be shifted, and there are multiple different ways to determine if you need to calculate and apply shifts. It can sometimes be visually apparent that there is a wavelength offset when looking at spectral features as you’ll see misalignment, but a more absolute method of determining if your data needs to be shifted is if you compare the coadd’s radial velocity to the literature value. In our COS example, we will compare the coadd’s radial velocity to the <a class="reference external" href="https://ullyses.stsci.edu/">ULLYSES</a> High-Level Science Product’s (HLSP) radial velocity. We will do a rough, quick calculation to demonstrate that there’s an actual shift between the datasets; there are more accurate methods of determining the radial velocity but it is outside the scope of this notebook. The ULLYSES team has created <a class="reference external" href="https://github.com/spacetelescope/ullyses/blob/main/notebooks/ullyses-getrawdata.ipynb">tutorial notebooks</a> that detail how to download this data via <code class="docutils literal notranslate"><span class="pre">astroquery</span></code>. We will download the HLSP for our target, specifically the file <code class="docutils literal notranslate"><span class="pre">hlsp_ullyses_hst_cos_lmc079-1_g160m_dr7_cspec.fits</span></code>, which is the HLSP for the <code class="docutils literal notranslate"><span class="pre">G160M</span></code> grating.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ullyses_query</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span>
    <span class="n">target_name</span><span class="o">=</span><span class="s2">&quot;LMC079-1&quot;</span><span class="p">,</span>
    <span class="n">provenance_name</span><span class="o">=</span><span class="s2">&quot;ULLYSES&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ullyses_prodlist</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span>
    <span class="n">ullyses_query</span>
<span class="p">)</span>

<span class="n">ullyses_prodlist</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">filter_products</span><span class="p">(</span>
    <span class="n">ullyses_prodlist</span><span class="p">,</span>
    <span class="n">productFilename</span><span class="o">=</span><span class="s2">&quot;hlsp_ullyses_hst_cos_lmc079-1_g160m_dr7_cspec.fits&quot;</span>
<span class="p">)</span>

<span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span>
    <span class="n">ullyses_prodlist</span><span class="p">,</span>
    <span class="n">download_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cos_ex</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">download_dir</span> <span class="o">=</span> <span class="n">cos_ex</span> <span class="o">/</span> <span class="s2">&quot;mastDownload&quot;</span>
<span class="n">hlsp_dir</span> <span class="o">=</span> <span class="n">download_dir</span> <span class="o">/</span> <span class="s2">&quot;HLSP/hlsp_ullyses_hst_cos_lmc079-1_uv&quot;</span>
<span class="n">target_filename</span> <span class="o">=</span> <span class="s2">&quot;hlsp_ullyses_hst_cos_lmc079-1_g160m_dr7_cspec.fits&quot;</span>

<span class="n">source_path</span> <span class="o">=</span> <span class="n">hlsp_dir</span> <span class="o">/</span> <span class="n">target_filename</span>
<span class="n">hlsp_path</span> <span class="o">=</span> <span class="n">cos_ex</span> <span class="o">/</span> <span class="n">target_filename</span>

<span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">source_path</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">hlsp_path</span><span class="p">))</span>

<span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">cos_ex</span> <span class="o">/</span> <span class="s2">&quot;mastDownload&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HLSP/ullyses/lmc079-1/dr7/hlsp_ullyses_hst_cos_lmc079-1_g160m_dr7_cspec.fits to cos_ex/mastDownload/HLSP/hlsp_ullyses_hst_cos_lmc079-1_uv/hlsp_ullyses_hst_cos_lmc079-1_g160m_dr7_cspec.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
</div>
</div>
<p>Now we can plot our coadd with the ULLYSES HLSP. We will zoom in on two different spectral features: <code class="docutils literal notranslate"><span class="pre">SiII</span></code> at <code class="docutils literal notranslate"><span class="pre">1526</span> <span class="pre">Å</span></code> and <code class="docutils literal notranslate"><span class="pre">FeII</span></code> at <code class="docutils literal notranslate"><span class="pre">1608</span> <span class="pre">Å</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">wavelength_range</span> <span class="o">=</span> <span class="p">([</span><span class="mi">1607</span><span class="p">,</span> <span class="mi">1611</span><span class="p">],</span> <span class="p">[</span><span class="mi">1525</span><span class="p">,</span> <span class="mi">1530</span><span class="p">])</span>

<span class="c1"># Plotting the coadd</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wl_coadd</span><span class="p">,</span> <span class="n">flux_coadd</span><span class="p">,</span>
         <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
         <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Coadd&quot;</span><span class="p">,</span>
         <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

<span class="c1"># Plotting the ULLYSES HLSP</span>
<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">hlsp_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>

    <span class="n">wl_hlsp</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;WAVELENGTH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">flux_hlsp</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FLUX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wl_hlsp</span><span class="p">,</span> <span class="n">flux_hlsp</span><span class="p">,</span>
         <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
         <span class="n">label</span><span class="o">=</span><span class="s2">&quot;ULLYSES HLSP&quot;</span><span class="p">,</span>
         <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Coadd and ULLYSES HLSP - LMC079-1 G160M&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength [$\AA$]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Flux [$erg\ s^{-1}\ cm^{-2}\ \AA^{-1}$]&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Zooming in on two spectral features</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="k">for</span> <span class="n">subplot</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">ravel</span><span class="p">():</span>

    <span class="c1"># Plotting the coadd</span>
    <span class="n">subplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wl_coadd</span><span class="p">,</span> <span class="n">flux_coadd</span><span class="p">,</span>
                 <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                 <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                 <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

    <span class="c1"># Plotting the HLSP</span>
    <span class="n">subplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wl_hlsp</span><span class="p">,</span> <span class="n">flux_hlsp</span><span class="p">,</span>
                 <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                 <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                 <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

    <span class="n">subplot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength [$\AA$]&#39;</span><span class="p">)</span>
    <span class="n">subplot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Flux [$erg\ s^{-1}\ cm^{-2}\ \AA^{-1}$]&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">wavelength_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FUVA - ZOOMED </span><span class="si">{</span><span class="n">wavelength_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> Å&quot;</span><span class="p">,</span>
                <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">wavelength_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FUVB - ZOOMED </span><span class="si">{</span><span class="n">wavelength_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> Å&quot;</span><span class="p">,</span>
                <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We can see visually that there is a slight wavelength shift between the two data products. We will do a very rough estimate of the radial velocity using the <code class="docutils literal notranslate"><span class="pre">SiII</span></code> line at <code class="docutils literal notranslate"><span class="pre">1526.71</span> <span class="pre">Å</span></code>.</p>
<p>We will first fit a Gaussian to our spectral feature to determine the model fit parameters of the absorption feature. Let’s define the function below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">fit_gaussian</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">stddev</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Fit a Gaussian to the data.</span>
<span class="sd">    Gaussian is defined as:</span>
<span class="sd">    f(x) = c + amplitude * np.exp(-(((wavelength - mean) / stddev)**2)/2)</span>
<span class="sd">    ----------</span>
<span class="sd">    Input:</span>
<span class="sd">    arr wavelength : Data of the independent variable (wl in our context)</span>
<span class="sd">    float amplitude : Amplitude of Gaussian. Represents the peak of the data</span>
<span class="sd">    float mean : Mean wl of Gaussian. Represents central wavelength of feature</span>
<span class="sd">    float stddev : Standard deviation of Gaussian. Represents function&#39;s width</span>
<span class="sd">    ----------</span>
<span class="sd">    Output:</span>
<span class="sd">    The value of flux at each wavelength using the fit.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># An estimate of the continuum flux value</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mf">6.5e-14</span>
    <span class="k">return</span> <span class="n">c</span> <span class="o">+</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(((</span><span class="n">wavelength</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">stddev</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We will use <code class="docutils literal notranslate"><span class="pre">scipy.optimize</span></code> to help fit our model to the absorption feature by optimizing the parameters of the <code class="docutils literal notranslate"><span class="pre">fit_gaussian</span></code> function. We’ll calculate the radial velocity of the HLSP first. This will allow us to determine the exact wavelength corresponding to the peak of the fitted Gaussian, which we’ll use to calculate the radial velocity of the HLSP.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Getting the indicies within the wavelength range</span>
<span class="n">indicies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">wl_hlsp</span> <span class="o">&gt;=</span> <span class="mf">1525.1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wl_hlsp</span> <span class="o">&lt;=</span> <span class="mf">1526.8</span><span class="p">))</span>

<span class="n">trimmed_flux</span> <span class="o">=</span> <span class="n">flux_hlsp</span><span class="p">[</span><span class="n">indicies</span><span class="p">]</span>
<span class="n">trimmed_wl</span> <span class="o">=</span> <span class="n">wl_hlsp</span><span class="p">[</span><span class="n">indicies</span><span class="p">]</span>

<span class="c1"># We need to make an initial guess for the parameter values</span>
<span class="c1"># The array is in form [PEAK OF GAUSSIAN, CENTRAL WAVELENGTH, WIDTH OF LINE]</span>
<span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="mf">.8e-14</span><span class="p">,</span> <span class="mf">1526.7</span><span class="p">,</span> <span class="mf">0.0053</span><span class="p">]</span>

<span class="n">popt_hlsp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">curve_fit</span><span class="p">(</span><span class="n">fit_gaussian</span><span class="p">,</span>
                                  <span class="n">trimmed_wl</span><span class="p">,</span>
                                  <span class="n">trimmed_flux</span><span class="p">,</span>
                                  <span class="n">p0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The SiII peak is fitted to be </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">popt_hlsp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2"> Å&quot;</span><span class="p">)</span>

<span class="c1"># Plotting the absorption feature of the HLSP with our fit</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Plotting the actual data</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">wl_hlsp</span><span class="p">,</span>
    <span class="n">flux_hlsp</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;HLSP Data&quot;</span>
<span class="p">)</span>

<span class="c1"># Plotting our fit</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">wl_hlsp</span><span class="p">,</span>
    <span class="n">fit_gaussian</span><span class="p">(</span><span class="n">wl_hlsp</span><span class="p">,</span> <span class="o">*</span><span class="n">popt_hlsp</span><span class="p">),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Model Fit&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span>
<span class="p">)</span>

<span class="c1"># Adding vertical lines to show fitted &quot;peak&quot;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">popt_hlsp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Model</span><span class="se">\&#39;</span><span class="s1">s Peak&#39;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">wavelength_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength [$\AA$]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Flux [$erg\ s^{-1}\ cm^{-2}\ \AA^{-1}$]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;HLSP of LMC079-1 with Modeled Fit&quot;</span><span class="p">,</span>
          <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The SiII peak is fitted to be 1526.619 Å
</pre></div>
</div>
</div>
</div>
<p>Now that we’ve determined the observed wavelength of the <code class="docutils literal notranslate"><span class="pre">SiII</span></code> line, we can calculate the radial velocity. The rest wavelength of this line is <code class="docutils literal notranslate"><span class="pre">1526.71</span> <span class="pre">Å</span></code>. We will use the equation below to calculate the radial velocity:</p>
<p><span class="math notranslate nohighlight">\( v_r = c \left( \frac{\lambda - \lambda_0}{\lambda_0} \right) \)</span></p>
<p>Where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\( v_r \)</span> is the radial velocity,</p></li>
<li><p><span class="math notranslate nohighlight">\( c \)</span> is the speed of light (<span class="math notranslate nohighlight">\( \approx 2.99 * 10^5 \)</span> km/s),</p></li>
<li><p><span class="math notranslate nohighlight">\( \lambda \)</span> is the observed wavelength of the spectral line,</p></li>
<li><p><span class="math notranslate nohighlight">\( \lambda_0 \)</span> is the rest wavelength of the spectral line.</p></li>
</ul>
<p>Let’s calculate it for the HLSP below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Speed of light (in km/s)</span>
<span class="n">c</span> <span class="o">=</span> <span class="mf">2.99e5</span>

<span class="c1"># Getting the observed wavelength of our HLSP</span>
<span class="n">observed_wavelength</span> <span class="o">=</span> <span class="n">popt_hlsp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Rest wavelength of SiII</span>
<span class="n">rest_wavelength</span> <span class="o">=</span> <span class="mf">1526.71</span>

<span class="n">v_r</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="p">((</span><span class="n">observed_wavelength</span> <span class="o">-</span> <span class="n">rest_wavelength</span><span class="p">)</span> <span class="o">/</span> <span class="n">rest_wavelength</span><span class="p">)</span>
<span class="n">v_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">v_r</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The radial velocity of LMC079-1 using the HLSP is roughly </span><span class="si">{</span><span class="n">v_r</span><span class="si">}</span><span class="s2"> km/s&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The radial velocity of LMC079-1 using the HLSP is roughly -17.78 km/s
</pre></div>
</div>
</div>
</div>
<p>Now let’s calculate the radial velocity of our coadd using the same process.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Getting the indicies within the wavelength range</span>
<span class="n">indicies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">wl_coadd</span> <span class="o">&gt;=</span> <span class="mf">1525.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wl_coadd</span> <span class="o">&lt;=</span> <span class="mf">1526.8</span><span class="p">))</span>

<span class="n">trimmed_flux</span> <span class="o">=</span> <span class="n">flux_coadd</span><span class="p">[</span><span class="n">indicies</span><span class="p">]</span>
<span class="n">trimmed_wl</span> <span class="o">=</span> <span class="n">wl_coadd</span><span class="p">[</span><span class="n">indicies</span><span class="p">]</span>

<span class="c1"># We need to make an initial guess for the parameter values</span>
<span class="c1"># The array is in form [PEAK OF GAUSSIAN, CENTRAL WAVELENGTH, WIDTH OF LINE]</span>
<span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="mf">.75e-14</span><span class="p">,</span> <span class="mf">1526.7</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">]</span>

<span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">curve_fit</span><span class="p">(</span><span class="n">fit_gaussian</span><span class="p">,</span>
                             <span class="n">trimmed_wl</span><span class="p">,</span>
                             <span class="n">trimmed_flux</span><span class="p">,</span>
                             <span class="n">p0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The SiII peak is fitted to be </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2"> Å&quot;</span><span class="p">)</span>

<span class="c1"># Plotting the absorption feature of the HLSP with our fit</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Plotting the actual data</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">wl_coadd</span><span class="p">,</span>
    <span class="n">flux_coadd</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Coadd Data&quot;</span>
<span class="p">)</span>

<span class="c1"># Plotting our fit</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">wl_coadd</span><span class="p">,</span>
    <span class="n">fit_gaussian</span><span class="p">(</span><span class="n">wl_coadd</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Model Fit&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span>
<span class="p">)</span>

<span class="c1"># Adding vertical lines to show fitted &quot;peak&quot;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Coadd Model</span><span class="se">\&#39;</span><span class="s1">s Peak&#39;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">)</span>

<span class="c1"># Adding vertical line to show observed wl of HLSP</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">popt_hlsp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;HLSP Model</span><span class="se">\&#39;</span><span class="s1">s Peak&#39;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">wavelength_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength [$\AA$]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Flux [$erg\ s^{-1}\ cm^{-2}\ \AA^{-1}$]&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Coadd of LMC079-1 with Modeled Fit&quot;</span><span class="p">,</span>
          <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Getting the observed wavelength of our HLSP</span>
<span class="n">observed_wavelength</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">v_r</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="p">((</span><span class="n">observed_wavelength</span> <span class="o">-</span> <span class="n">rest_wavelength</span><span class="p">)</span> <span class="o">/</span> <span class="n">rest_wavelength</span><span class="p">)</span>
<span class="n">v_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">v_r</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The radial velocity of LMC079-1 using the coadd is roughly </span><span class="si">{</span><span class="n">v_r</span><span class="si">}</span><span class="s2"> km/s&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The SiII peak is fitted to be 1526.663 Å
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The radial velocity of LMC079-1 using the coadd is roughly -9.17 km/s
</pre></div>
</div>
</div>
</div>
<p>We can see that there is a very significant difference between the target’s calculated radial velocity using the HLSP (roughly <code class="docutils literal notranslate"><span class="pre">-17.78</span> <span class="pre">km/s</span></code>) and the coadd (roughly <code class="docutils literal notranslate"><span class="pre">-3.5</span> <span class="pre">km/s</span></code>). This is an indicator that there is a wavelength offset between the coadd’s constituent <code class="docutils literal notranslate"><span class="pre">X1D</span></code> files. We will need to determine this wavelength offset between the <code class="docutils literal notranslate"><span class="pre">X1D</span></code> files, apply this shift when running <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code>, and redo the coadd.</p>
<p><a id = cc_cos></a></p>
</section>
<section id="performing-cross-correlation-on-x1d-cos-data-to-calculate-lag">
<h3>1.4 Performing Cross-Correlation on <code class="docutils literal notranslate"><span class="pre">X1D</span></code> COS Data to Calculate Lag<a class="headerlink" href="#performing-cross-correlation-on-x1d-cos-data-to-calculate-lag" title="Permalink to this heading">#</a></h3>
<p>We will determine the shift of our spectrum by cross-correlating one of the <code class="docutils literal notranslate"><span class="pre">X1D</span></code> files to the other files, determining the lag with the greatest cross-correlation coefficient, and then inputting this lag into <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> to re-generate the <code class="docutils literal notranslate"><span class="pre">X1D</span></code> files. We will need to calculate the shift, in pixels, for both the <code class="docutils literal notranslate"><span class="pre">FUVA</span></code> and <code class="docutils literal notranslate"><span class="pre">FUVB</span></code> segments of each <code class="docutils literal notranslate"><span class="pre">X1D</span></code>. Users will want to cross-correlate along a wavelength range that captures absorption features unique to the target and is free of instrumental effects. Additionally, cross-correlating across a unique feature of the spectrum rather than the entire spectrum greatly improves the cross-correlation accuracy.</p>
<p>We will cross-correlate along the ranges <code class="docutils literal notranslate"><span class="pre">1525</span> <span class="pre">-</span> <span class="pre">1530</span> <span class="pre">Å</span></code> for Segment <code class="docutils literal notranslate"><span class="pre">FUVB</span></code> and <code class="docutils literal notranslate"><span class="pre">1607</span> <span class="pre">-</span> <span class="pre">1611</span> <span class="pre">Å</span></code> for Segment <code class="docutils literal notranslate"><span class="pre">FUVA</span></code>, which capture <code class="docutils literal notranslate"><span class="pre">SiII</span></code> and <code class="docutils literal notranslate"><span class="pre">FeII</span></code> absorption features of this spectrum, respectively. Let’s take a closer look at these spectra:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>

<span class="n">x1ds</span> <span class="o">=</span> <span class="n">cos_unshifted</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*x1d*&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x1ds</span><span class="p">)):</span>

    <span class="c1"># Getting the flux and wavelength for our dataset</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">wavelength</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;WAVELENGTH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;FLUX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="n">fppos</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FPPOS&quot;</span><span class="p">]</span>

    <span class="c1"># ax[0] is plot with total spectrum, ax[1] is FUVB, ax[2] is FUVA</span>
    <span class="k">for</span> <span class="n">subplot</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
        <span class="c1"># Plotting the spectrum</span>
        <span class="n">subplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span>
                     <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                     <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
                     <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                     <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;FP-POS </span><span class="si">{</span><span class="n">fppos</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">subplot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength [$\AA$]&#39;</span><span class="p">)</span>
        <span class="n">subplot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Flux [$erg\ s^{-1}\ cm^{-2}\ \AA^{-1}$]&#39;</span><span class="p">)</span>

        <span class="n">subplot</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5e-13</span><span class="p">)</span>

        <span class="n">subplot</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Adding formatting to the subplots</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Flux vs Wavelength, LMC079-1, both segments&quot;</span><span class="p">,</span>
                <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Flux vs Wavelength, </span><span class="si">{</span><span class="n">wavelength_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> Å, Seg FUVB&#39;</span><span class="p">,</span>
                <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Flux vs Wavelength, </span><span class="si">{</span><span class="n">wavelength_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> Å, Seg FUVA&#39;</span><span class="p">,</span>
                <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">wavelength_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">wavelength_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We can see an apparent shift between the <code class="docutils literal notranslate"><span class="pre">X1D</span></code> files, especially between the <code class="docutils literal notranslate"><span class="pre">FPPOS</span> <span class="pre">1+2</span></code> and <code class="docutils literal notranslate"><span class="pre">FPPOS</span> <span class="pre">3+4</span></code> exposures.</p>
<p>We will now determine which <code class="docutils literal notranslate"><span class="pre">X1D</span></code> file will be the reference file. Users have different methods for determining the reference file best suited for your dataset. For this example, we will choose the reference file to be the <code class="docutils literal notranslate"><span class="pre">X1D</span></code> with a model peak closest to the HLSP’s peak of the <code class="docutils literal notranslate"><span class="pre">SiII</span></code> absorption feature.</p>
<p>We’ll define a function to help us fit the peaks:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">fit_model</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">wavelength_range</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Fit the Gaussian to the feature, return the &quot;peak&quot; wavelength</span>
<span class="sd">    ----------</span>
<span class="sd">    arr i : The wavelength range to trim flux/wl to</span>
<span class="sd">    arr p0 : The initial guess for the Gaussian fit</span>
<span class="sd">    plt.subplot ax : A specific subplot, used for plotting each X1D</span>
<span class="sd">    arr wavelength_range : Wavelength range for the plot</span>
<span class="sd">    str file : Path to the X1D file</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
        <span class="n">wl</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;WAVELENGTH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FLUX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="c1"># Getting the indicies within the wavelength range</span>
    <span class="n">indicies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">wl</span> <span class="o">&gt;=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wl</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">trimmed_flux</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="n">indicies</span><span class="p">]</span>
    <span class="n">trimmed_wl</span> <span class="o">=</span> <span class="n">wl</span><span class="p">[</span><span class="n">indicies</span><span class="p">]</span>

    <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">curve_fit</span><span class="p">(</span><span class="n">fit_gaussian</span><span class="p">,</span>
                                 <span class="n">trimmed_wl</span><span class="p">,</span>
                                 <span class="n">trimmed_flux</span><span class="p">,</span>
                                 <span class="n">p0</span><span class="p">)</span>

    <span class="c1"># Plotting the X1D&#39;s data</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">wl</span><span class="p">,</span>
        <span class="n">flux</span>
    <span class="p">)</span>

    <span class="c1"># Plotting the fit</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">wl</span><span class="p">,</span>
        <span class="n">fit_gaussian</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">),</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Modeled Fit&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;purple&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Adding vertical line to show peak wl of HLSP</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">popt_hlsp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
               <span class="n">label</span><span class="o">=</span><span class="s1">&#39;HLSP Model</span><span class="se">\&#39;</span><span class="s1">s Peak&#39;</span><span class="p">,</span>
               <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
               <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">)</span>

    <span class="c1"># Adding vertical line to show peak wl of X1D</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
               <span class="n">label</span><span class="o">=</span><span class="s1">&#39;X1D Model</span><span class="se">\&#39;</span><span class="s1">s Peak&#39;</span><span class="p">,</span>
               <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
               <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">wavelength_range</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5e-13</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">fppos</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;FPPOS&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Flux vs Wavelength with Fit, FPPOS </span><span class="si">{</span><span class="n">fppos</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                 <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength [$\AA$]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Flux [$erg\ s^{-1}\ cm^{-2}\ \AA^{-1}$]&#39;</span><span class="p">)</span>

    <span class="n">peak_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">popt_hlsp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">wavelength_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.35</span><span class="p">,</span>
            <span class="mf">1.2e-13</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;Difference in peak wavelength = </span><span class="si">{</span><span class="n">peak_diff</span><span class="si">}</span><span class="s1"> Å&#39;</span><span class="p">,</span>
            <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">peak_diff</span>
</pre></div>
</div>
</div>
</div>
<p>Now we will determine the file to be used as a reference, which will be the file that has the smallest difference in peak wavelength for the <code class="docutils literal notranslate"><span class="pre">SiII</span></code> feature compared to the HLSP peak.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

<span class="n">x1ds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cos_unshifted</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*x1d*&quot;</span><span class="p">))</span>

<span class="c1"># A placeholder reference file</span>
<span class="n">ref_file</span> <span class="o">=</span> <span class="n">x1ds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># A placeholder value for the smallest peak</span>
<span class="n">smallest_peak</span> <span class="o">=</span> <span class="mi">10000</span>

<span class="k">for</span> <span class="n">file</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x1ds</span><span class="p">),</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()):</span>
    <span class="n">fppos</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;FPPOS&quot;</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1525.</span><span class="p">,</span> <span class="mf">1525.8</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">fppos</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">6e-14</span><span class="p">,</span> <span class="mf">1526.75</span><span class="p">,</span> <span class="mf">0.13</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">fppos</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">6e-14</span><span class="p">,</span> <span class="mf">1526.75</span><span class="p">,</span> <span class="mf">0.125</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">fppos</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">5.75e-14</span><span class="p">,</span> <span class="mf">1526.65</span><span class="p">,</span> <span class="mf">0.125</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">fppos</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">5.8e-14</span><span class="p">,</span> <span class="mf">1526.62</span><span class="p">,</span> <span class="mf">0.13</span><span class="p">]</span>

    <span class="n">curr_peak</span> <span class="o">=</span> <span class="n">fit_model</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">wavelength_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">file</span><span class="p">)</span>

    <span class="c1"># Is the current iteration&#39;s file closer to the HLSP?</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">curr_peak</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">smallest_peak</span><span class="p">:</span>
        <span class="n">smallest_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">curr_peak</span><span class="p">)</span>
        <span class="n">ref_file</span> <span class="o">=</span> <span class="n">file</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">fppos</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">ref_file</span><span class="p">,</span> <span class="s2">&quot;FPPOS&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The file to be used as reference was taken at FPPOS </span><span class="si">{</span><span class="n">fppos</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The file to be used as reference was taken at FPPOS 3
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_2818/1408116224.py:21: OptimizeWarning: Covariance of the parameters could not be estimated
  popt, _ = optimize.curve_fit(fit_gaussian,
</pre></div>
</div>
</div>
</div>
<p>As we can see, the file that is closest to the HLSP is the observation taken at <code class="docutils literal notranslate"><span class="pre">FPPOS</span> <span class="pre">4</span></code>.</p>
<p>We will now define a function to determine the lag and cross-correlation coefficient between our reference and shifted spectra. We will use the <code class="docutils literal notranslate"><span class="pre">correlation_lags</span></code> function from <code class="docutils literal notranslate"><span class="pre">scipy.signal</span></code> to compute the cross-correlation coefficient for each lag. The lag is the displacement (in pixels) between the reference and current spectra. The cross-correlation coefficient is in the range <code class="docutils literal notranslate"><span class="pre">[-1,</span> <span class="pre">1]</span></code>, a value of <code class="docutils literal notranslate"><span class="pre">1</span></code> being perfectly correlated, <code class="docutils literal notranslate"><span class="pre">0</span></code> being no correlation, and <code class="docutils literal notranslate"><span class="pre">-1</span></code> being inversely correlated. The shift that we will input to <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> is going to be the lag at the maximum cross-correlation coefficient value. We will define the function to calculate the lag and cross-correlation coefficient in the cell below (this function is from the <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/blob/main/notebooks/STIS/cross-correlation/cross-correlation.ipynb">STIS Cross Correlation Notebook</a>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># From the STIS cross correlation notebook</span>
<span class="k">def</span><span class="w"> </span><span class="nf">cross_correlate</span><span class="p">(</span><span class="n">ref_flux</span><span class="p">,</span> <span class="n">shifted_flux</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">shifted_flux</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_flux</span><span class="p">),</span> <span class="s2">&quot;Arrays must be same size&quot;</span>

    <span class="c1"># Normalize inputs:</span>
    <span class="n">shifted_flux</span> <span class="o">=</span> <span class="n">shifted_flux</span> <span class="o">-</span> <span class="n">shifted_flux</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">shifted_flux</span> <span class="o">/=</span> <span class="n">shifted_flux</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">ref_flux</span> <span class="o">=</span> <span class="n">ref_flux</span> <span class="o">-</span> <span class="n">ref_flux</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">ref_flux</span> <span class="o">/=</span> <span class="n">ref_flux</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

    <span class="c1"># centered at the median of len(a)</span>
    <span class="n">lag</span> <span class="o">=</span> <span class="n">correlation_lags</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shifted_flux</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_flux</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)</span>
    <span class="c1"># find the cross-correlation coefficient</span>
    <span class="n">cc</span> <span class="o">=</span> <span class="n">correlate</span><span class="p">(</span><span class="n">shifted_flux</span><span class="p">,</span> <span class="n">ref_flux</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ref_flux</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">lag</span><span class="p">,</span> <span class="n">cc</span>
</pre></div>
</div>
</div>
</div>
<p>Now we will define a function to calculate the shift between our reference file (<code class="docutils literal notranslate"><span class="pre">FPPOS</span> <span class="pre">4</span></code>) and the <code class="docutils literal notranslate"><span class="pre">FPPOS</span> <span class="pre">1+2+3</span></code> exposures. We will plot the correlation coefficient vs lag as well. We will have to get shift values for each segment; for <code class="docutils literal notranslate"><span class="pre">FUVA</span></code> we will correlate to the wavelength range <code class="docutils literal notranslate"><span class="pre">[1607,</span> <span class="pre">1611]</span></code>, and for <code class="docutils literal notranslate"><span class="pre">FUVB</span></code> we will correlate to the wavelength range <code class="docutils literal notranslate"><span class="pre">[1525,</span> <span class="pre">1530]</span></code>. Since our <code class="docutils literal notranslate"><span class="pre">cross_correlate</span></code> function returns only discrete value shifts, we will need to fit a curve to the correlation lag plot; the shift we will apply with <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> is at the maxima of this curve.</p>
<p><strong>Note: You will need to experiment with different fits for your dataset.</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">find_shift_normalized</span><span class="p">(</span><span class="n">ref_file</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">wl_range</span><span class="p">,</span> <span class="n">segment</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">plot</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Determine shift amount in pixels between the reference file and the file.</span>
<span class="sd">    Can also plot wavelength range and the correlation coeff. vs lag as well.</span>
<span class="sd">    ----------</span>
<span class="sd">    Input:</span>
<span class="sd">    Pathlib path ref_file : Path to reference file&#39;s spectrum to shift to.</span>
<span class="sd">    Pathlib path file : Path to file of spectrum to apply shifts to</span>
<span class="sd">    arr wl_range : Wavelength range to correlate to. Form: [START_WL, END_WL]</span>
<span class="sd">    str segment : The segment that is being correlated. Either &#39;FUVA&#39; or &#39;FUVB&#39;</span>
<span class="sd">    int width : Width of fit, needs to be greater than 2</span>
<span class="sd">    bool plot : Do you want to show plots?</span>
<span class="sd">    ----------</span>
<span class="sd">    Output:</span>
<span class="sd">    float shift : Calculated lag [px] between ref and current spectrum</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Grabbing the reference spectrum&#39;s data</span>
    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ref_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
        <span class="n">seg_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;SEGMENT&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">segment</span><span class="p">)</span>

        <span class="n">ref_wl</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;WAVELENGTH&quot;</span><span class="p">][</span><span class="n">seg_i</span><span class="p">]</span>
        <span class="n">ref_flux</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FLUX&quot;</span><span class="p">][</span><span class="n">seg_i</span><span class="p">]</span>

    <span class="c1"># Getting the flux data for the current FPPOS file</span>
    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
        <span class="n">seg_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;SEGMENT&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">segment</span><span class="p">)</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FLUX&quot;</span><span class="p">][</span><span class="n">seg_i</span><span class="p">]</span>

    <span class="n">range_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">ref_wl</span> <span class="o">&gt;=</span> <span class="n">wl_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ref_wl</span> <span class="o">&lt;=</span> <span class="n">wl_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="c1"># Trimming the flux and wavelength ranges to match the user inputted range</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="n">range_i</span><span class="p">]</span>
    <span class="n">ref_flux</span> <span class="o">=</span> <span class="n">ref_flux</span><span class="p">[</span><span class="n">range_i</span><span class="p">]</span>

    <span class="n">wavelength</span> <span class="o">=</span> <span class="n">ref_wl</span><span class="p">[</span><span class="n">range_i</span><span class="p">]</span>

    <span class="c1"># Calculating lag and correlation coeff. using STIS notebook&#39;s function</span>
    <span class="n">lag</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">cross_correlate</span><span class="p">(</span><span class="n">ref_flux</span><span class="p">,</span> <span class="n">flux</span><span class="p">)</span>

    <span class="c1"># Fitting a quadratic to the peak to find pixel shift</span>
    <span class="n">fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LinearLSQFitter</span><span class="p">()</span>

    <span class="c1"># Getting the points near the peak</span>
    <span class="n">low</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="o">-</span> <span class="n">width</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="o">+</span> <span class="n">width</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">Polynomial1D</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">x</span><span class="o">=</span><span class="n">lag</span><span class="p">[</span><span class="n">low</span><span class="p">:</span><span class="n">hi</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">cc</span><span class="p">[</span><span class="n">low</span><span class="p">:</span><span class="n">hi</span><span class="p">])</span>

    <span class="n">x_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lag</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lag</span><span class="p">),</span> <span class="mf">0.01</span><span class="p">)</span>

    <span class="c1"># Determining the shift, in pixels</span>
    <span class="n">shift1</span> <span class="o">=</span> <span class="o">-</span><span class="n">fit</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">fit</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">segment</span> <span class="o">==</span> <span class="s2">&quot;FUVA&quot;</span><span class="p">:</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">shift1</span> <span class="o">+</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;SHIFT1A&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">shift1</span> <span class="o">+</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;SHIFT1B&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># If not plotting, then just return the shift</span>
    <span class="k">if</span> <span class="n">plot</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">shift</span>

    <span class="n">fppos</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;FPPOS&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shift for </span><span class="si">{</span><span class="n">segment</span><span class="si">}</span><span class="s2"> between ref and FPPOS </span><span class="si">{</span><span class="n">fppos</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">shift1</span><span class="si">}</span><span class="s2"> px&quot;</span><span class="p">)</span>

    <span class="c1"># Setting up the subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">wavelength</span><span class="p">,</span>
        <span class="n">ref_flux</span><span class="p">,</span>
        <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Reference File&quot;</span>
    <span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">wavelength</span><span class="p">,</span>
        <span class="n">flux</span><span class="p">,</span>
        <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;FPPOS </span><span class="si">{</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;FPPOS&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">lag</span><span class="p">,</span>
        <span class="n">cc</span><span class="p">,</span>
        <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span>
    <span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">x_c</span><span class="p">,</span>
        <span class="n">fit</span><span class="p">(</span><span class="n">x_c</span><span class="p">),</span>
        <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fitted quadratic&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span>
    <span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
        <span class="n">shift1</span><span class="p">,</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Maxima&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">shift1</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="n">shift1</span><span class="o">+</span><span class="mi">100</span><span class="p">)</span>

    <span class="c1"># Adjusting formatting + adding titles</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Wavelength&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Flux [$erg\ s^{-1}\ cm^{-2}\ \AA^{-1}$]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Flux vs Wavelength, FPPOS </span><span class="si">{</span><span class="n">fppos</span><span class="si">}</span><span class="s1"> &amp; Ref, </span><span class="si">{</span><span class="n">segment</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Lags (px)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Correlation Coeff.&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;CC vs Lags (px), FPPOS </span><span class="si">{</span><span class="n">fppos</span><span class="si">}</span><span class="s1"> &amp; Ref, </span><span class="si">{</span><span class="n">segment</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s calculate the shift of both segments for the <code class="docutils literal notranslate"><span class="pre">FPPOS</span> <span class="pre">1</span></code> exposure:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fppos1</span> <span class="o">=</span> <span class="n">cos_unshifted</span> <span class="o">/</span> <span class="s2">&quot;le2701q0q_x1d.fits&quot;</span>

<span class="n">widths1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">]</span>

<span class="n">find_shift_normalized</span><span class="p">(</span><span class="n">ref_file</span><span class="p">,</span>
                      <span class="n">fppos1</span><span class="p">,</span>
                      <span class="n">wavelength_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                      <span class="s2">&quot;FUVA&quot;</span><span class="p">,</span>
                      <span class="n">width</span><span class="o">=</span><span class="n">widths1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">find_shift_normalized</span><span class="p">(</span><span class="n">ref_file</span><span class="p">,</span>
                      <span class="n">fppos1</span><span class="p">,</span>
                      <span class="n">wavelength_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                      <span class="s2">&quot;FUVB&quot;</span><span class="p">,</span>
                      <span class="n">width</span><span class="o">=</span><span class="n">widths1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                      <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shift for FUVA between ref and FPPOS 1 is 12.703590036864584 px
Shift for FUVB between ref and FPPOS 1 is 9.856078839633527 px
</pre></div>
</div>
</div>
</div>
<p>Now we can do the same for our <code class="docutils literal notranslate"><span class="pre">FPPOS</span> <span class="pre">2</span></code> exposure:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fppos2</span> <span class="o">=</span> <span class="n">cos_unshifted</span> <span class="o">/</span> <span class="s2">&quot;le2701q2q_x1d.fits&quot;</span>

<span class="n">widths2</span> <span class="o">=</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">35</span><span class="p">]</span>

<span class="n">find_shift_normalized</span><span class="p">(</span><span class="n">ref_file</span><span class="p">,</span>
                      <span class="n">fppos2</span><span class="p">,</span>
                      <span class="n">wavelength_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                      <span class="s2">&quot;FUVA&quot;</span><span class="p">,</span>
                      <span class="n">width</span><span class="o">=</span><span class="n">widths2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">find_shift_normalized</span><span class="p">(</span><span class="n">ref_file</span><span class="p">,</span>
                      <span class="n">fppos2</span><span class="p">,</span>
                      <span class="n">wavelength_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                      <span class="s2">&quot;FUVB&quot;</span><span class="p">,</span>
                      <span class="n">width</span><span class="o">=</span><span class="n">widths2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                      <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shift for FUVA between ref and FPPOS 2 is 11.2470918848302 px
Shift for FUVB between ref and FPPOS 2 is 9.713869743192598 px
</pre></div>
</div>
</div>
</div>
<p>And finally, let’s calculate the shift for our <code class="docutils literal notranslate"><span class="pre">FPPOS</span> <span class="pre">3</span></code> exposure:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fppos3</span> <span class="o">=</span> <span class="n">cos_unshifted</span> <span class="o">/</span> <span class="s2">&quot;le2701q4q_x1d.fits&quot;</span>

<span class="n">widths3</span> <span class="o">=</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span>

<span class="n">find_shift_normalized</span><span class="p">(</span><span class="n">ref_file</span><span class="p">,</span>
                      <span class="n">fppos3</span><span class="p">,</span>
                      <span class="n">wavelength_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                      <span class="s2">&quot;FUVA&quot;</span><span class="p">,</span>
                      <span class="n">width</span><span class="o">=</span><span class="n">widths3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">find_shift_normalized</span><span class="p">(</span><span class="n">ref_file</span><span class="p">,</span>
                      <span class="n">fppos3</span><span class="p">,</span>
                      <span class="n">wavelength_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                      <span class="s2">&quot;FUVB&quot;</span><span class="p">,</span>
                      <span class="n">width</span><span class="o">=</span><span class="n">widths3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                      <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shift for FUVA between ref and FPPOS 3 is 0.0 px
Shift for FUVB between ref and FPPOS 3 is 0.0 px
</pre></div>
</div>
</div>
</div>
<p><a id = apply_shifts_cos></a></p>
</section>
<section id="applying-shifts-to-cos-data-and-re-creating-coadd">
<h3>1.5 Applying Shifts to COS data and Re-creating Coadd<a class="headerlink" href="#applying-shifts-to-cos-data-and-re-creating-coadd" title="Permalink to this heading">#</a></h3>
<p>Now that we’ve determined the shift in pixels, we will re-calibrate our data using <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code>. There are two ways that we can apply our shifts: we can either modify the <code class="docutils literal notranslate"><span class="pre">corrtag</span></code> files, or we can put them in a <code class="docutils literal notranslate"><span class="pre">.txt</span></code> file and feed that into <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code>. We will do the latter option in this tutorial. The shift value that we will write in the <code class="docutils literal notranslate"><span class="pre">.txt</span></code> file is the sum of the shift we calculated using the above function and the value of the <code class="docutils literal notranslate"><span class="pre">SHIFT1A</span></code> header keyword of the <code class="docutils literal notranslate"><span class="pre">X1D</span></code> file (<code class="docutils literal notranslate"><span class="pre">SHIFT1A</span></code> for <code class="docutils literal notranslate"><span class="pre">FUVA</span></code>, <code class="docutils literal notranslate"><span class="pre">SHIFT1B</span></code> for <code class="docutils literal notranslate"><span class="pre">FUVB</span></code>).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">shifts.txt</span></code> file must have the following columns:</p>
<p>- <code class="docutils literal notranslate"><span class="pre">ROOTNAME</span></code></p>
<p>- <code class="docutils literal notranslate"><span class="pre">FPOFFSET</span></code></p>
<p>- <code class="docutils literal notranslate"><span class="pre">FLASH/STRIPE/SEGMENT</span></code></p>
<p>- New <code class="docutils literal notranslate"><span class="pre">SHIFT1</span></code> value in pixels (dispersion direction shift)</p>
<p>- New <code class="docutils literal notranslate"><span class="pre">SHIFT2</span></code> value in pixels (cross-dispersion direction shift)**</p>
<p><em>**Note: including the <code class="docutils literal notranslate"><span class="pre">SHIFT2</span></code> value is optional</em></p>
<p>If the <code class="docutils literal notranslate"><span class="pre">ROOTNAME</span></code> is not the association’s rootname, then you can specify <code class="docutils literal notranslate"><span class="pre">FPOFFSET</span></code> as <code class="docutils literal notranslate"><span class="pre">any</span></code> in the file. This goes for <code class="docutils literal notranslate"><span class="pre">FLASH/STRIPE/SEGMENT</span></code> as well, but we will be specifying the segment in our example because we had to calculate the shifts for each segment. More information about running <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> when applying the shifts can be found in <a class="reference external" href="https://hst-docs.stsci.edu/cosdhb/chapter-5-cos-data-analysis/5-3-working-with-extracted-spectra">Section 5.3.2 of the COS Data Handbook</a>.</p>
<p>Running the cell below will create a <code class="docutils literal notranslate"><span class="pre">shifts.txt</span></code> file, which will be inputted into <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> to apply the new shifts to the datasets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cos_data</span> <span class="o">/</span> <span class="s2">&quot;shifts.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">shift_file</span><span class="p">:</span>
    <span class="n">widths</span> <span class="o">=</span> <span class="p">(</span><span class="n">widths1</span><span class="p">,</span> <span class="n">widths2</span><span class="p">,</span> <span class="n">widths3</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">file</span><span class="p">,</span> <span class="n">width</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">fppos1</span><span class="p">,</span> <span class="n">fppos2</span><span class="p">,</span> <span class="n">fppos3</span><span class="p">],</span> <span class="n">widths</span><span class="p">):</span>

        <span class="n">rootname</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;ROOTNAME&quot;</span><span class="p">)</span>

        <span class="n">shift_fuva</span> <span class="o">=</span> <span class="n">find_shift_normalized</span><span class="p">(</span><span class="n">ref_file</span><span class="p">,</span>
                                           <span class="n">file</span><span class="p">,</span>
                                           <span class="n">wavelength_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                           <span class="s2">&quot;FUVA&quot;</span><span class="p">,</span>
                                           <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                           <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">shift_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rootname</span><span class="si">}</span><span class="s1"> any any FUVA </span><span class="si">{</span><span class="n">shift_fuva</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">shift_fuvb</span> <span class="o">=</span> <span class="n">find_shift_normalized</span><span class="p">(</span><span class="n">ref_file</span><span class="p">,</span>
                                           <span class="n">file</span><span class="p">,</span>
                                           <span class="n">wavelength_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                           <span class="s2">&quot;FUVB&quot;</span><span class="p">,</span>
                                           <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                           <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">shift_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rootname</span><span class="si">}</span><span class="s1"> any any FUVB </span><span class="si">{</span><span class="n">shift_fuvb</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can run <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> on our data to perform the shift. Check out the COS team’s <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/blob/main/notebooks/COS/CalCOS/CalCOS.ipynb"><code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> notebook</a> for a tutorial on how to run <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span> cap --no-stderr
<span class="k">try</span><span class="p">:</span>
    <span class="n">calcos</span><span class="o">.</span><span class="n">calcos</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cos_data</span><span class="si">}</span><span class="s2">/le2701010_asn.fits&quot;</span><span class="p">,</span>
                  <span class="n">outdir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cos_shifted</span><span class="p">),</span>
                  <span class="n">shift_file</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cos_data</span><span class="si">}</span><span class="s2">/shifts.txt&quot;</span><span class="p">)</span>
    
<span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;An error occured&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s compare the pre-shifted and shifted wavelength ranges of our observations for both segments:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Plotting the unshifted data on the top row</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">cos_unshifted</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*x1d.fits*&quot;</span><span class="p">))):</span>

    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
        <span class="n">wavelength</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;WAVELENGTH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FLUX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">wavelength</span><span class="p">,</span>
            <span class="n">flux</span><span class="p">,</span>
            <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;FPPOS </span><span class="si">{</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;FPPOS&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="p">)</span>

<span class="c1"># Now plotting the shifted data on the bottom row</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">cos_shifted</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*x1d.fits*&quot;</span><span class="p">))):</span>
    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>

        <span class="n">wavelength</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;WAVELENGTH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FLUX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">wavelength</span><span class="p">,</span>
            <span class="n">flux</span><span class="p">,</span>
            <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;FPPOS </span><span class="si">{</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;FPPOS&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="p">)</span>

<span class="c1"># Adding titles</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Flux vs Wavelength, Pre-shifted (top) and Shifted (bottom)&quot;</span><span class="p">,</span>
             <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
             <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pre-shifted, FUVA, </span><span class="si">{</span><span class="n">wavelength_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pre-shifted, FUVB, </span><span class="si">{</span><span class="n">wavelength_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shifted, FUVA, </span><span class="si">{</span><span class="n">wavelength_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shifted, FUVB, </span><span class="si">{</span><span class="n">wavelength_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Setting xlimits</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">wavelength_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">wavelength_range</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">wavelength_range</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">wavelength_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">wavelength_range</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">wavelength_range</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># Adding a legend and setting ylim</span>
<span class="k">for</span> <span class="n">subplot</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
    <span class="n">subplot</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">subplot</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5e-13</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We can visually see a clear improvement in the spectral features when we applied our shifts to <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> as the two absorption features have lined up for all <code class="docutils literal notranslate"><span class="pre">FPPOS</span></code>.</p>
<p><a id = compare_shifted_cos></a></p>
</section>
<section id="comparing-non-shifted-and-shifted-cos-coadds">
<h3>1.6 Comparing Non-Shifted and Shifted COS Coadds<a class="headerlink" href="#comparing-non-shifted-and-shifted-cos-coadds" title="Permalink to this heading">#</a></h3>
<p>Now that we’ve successfully shifted our data, let’s re-create our coadd. We will calculate the radial velocity of the new coadd as well and compare it with our values from the earlier section.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>swrapper<span class="w"> </span>-i<span class="w"> </span>./cos_ex/cos_shifted<span class="w"> </span>-o<span class="w"> </span>./cos_ex/cos_shifted/coadd
<span class="n">clear_output</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s see the flux and SNR of our coadd now that we’ve recalibrated:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coadd</span> <span class="o">=</span> <span class="s2">&quot;hst_15824_cos_lmc079-1_g160m_le27_cspec.fits&quot;</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cos_unshifted_coadd</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cos_shifted_coadd</span><span class="p">):</span>
    
    <span class="c1"># The paths to both of our coadds</span>
    <span class="n">preshift</span> <span class="o">=</span> <span class="n">cos_unshifted_coadd</span> <span class="o">/</span> <span class="n">coadd</span>
    <span class="n">shifted</span> <span class="o">=</span> <span class="n">cos_shifted_coadd</span> <span class="o">/</span> <span class="n">coadd</span>

    <span class="c1"># Getting the data for our pre- and post-shifted coadd</span>
    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">preshift</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
        <span class="n">pre_wl</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;WAVELENGTH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">pre_flux</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FLUX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">pre_snr</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;SNR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">shifted</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
        <span class="n">shifted_wl</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;WAVELENGTH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">shifted_flux</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FLUX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">shifted_snr</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;SNR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

    <span class="c1"># Interpolating flux and SNR arrays since difference shapes from pre-shifted</span>
    <span class="n">shifted_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">pre_wl</span><span class="p">,</span> <span class="n">shifted_wl</span><span class="p">,</span> <span class="n">shifted_flux</span><span class="p">)</span>
    <span class="n">shifted_snr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">pre_wl</span><span class="p">,</span> <span class="n">shifted_wl</span><span class="p">,</span> <span class="n">shifted_snr</span><span class="p">)</span>

    <span class="c1"># Plotting flux vs wavelength</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">pre_wl</span><span class="p">,</span>
        <span class="n">pre_flux</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Unshifted&quot;</span><span class="p">,</span>
        <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span>
    <span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">pre_wl</span><span class="p">,</span>
        <span class="n">shifted_flux</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Shifted&quot;</span><span class="p">,</span>
        <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Plotting SNR vs wavelength</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">pre_wl</span><span class="p">,</span>
        <span class="n">pre_snr</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Unshifted&quot;</span><span class="p">,</span>
        <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span>
    <span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">pre_wl</span><span class="p">,</span>
        <span class="n">shifted_snr</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Shifted&quot;</span><span class="p">,</span>
        <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Plotting flux residuals</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">pre_wl</span><span class="p">,</span>
        <span class="n">shifted_flux</span><span class="o">-</span><span class="n">pre_flux</span><span class="p">,</span>
        <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span>
    <span class="p">)</span>

    <span class="c1"># Plotting snr residuals</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">pre_wl</span><span class="p">,</span>
        <span class="n">shifted_snr</span><span class="o">-</span><span class="n">pre_snr</span><span class="p">,</span>
        <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">subplot</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">ravel</span><span class="p">():</span>
        <span class="n">subplot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength [$\AA$]&#39;</span><span class="p">)</span>
        <span class="n">subplot</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Flux [$erg\ s^{-1}\ cm^{-2}\ \AA^{-1}$]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Flux [$erg\ s^{-1}\ cm^{-2}\ \AA^{-1}$]&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;SNR&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;SNR&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Flux vs Wavelength, Unshifted and Shifted&quot;</span><span class="p">,</span>
                       <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Flux Residuals&quot;</span><span class="p">,</span>
                       <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;SNR vs Wavelength, Unshifted and Shifted&quot;</span><span class="p">,</span>
                       <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;SNR Residuals&quot;</span><span class="p">,</span>
                       <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File not found: You need to run previous cells to generate the data.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_2818/802807213.py:84: UserWarning: No artists with labels found to put in legend.  Note that artists whose label start with an underscore are ignored when legend() is called with no argument.
  subplot.legend()
</pre></div>
</div>
</div>
</div>
<p>While you won’t necessarily see a big improvement in the SNR with a shift, we will see that our coadd has a better wavelength solution by calculating the radial velocity below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_coadd</span> <span class="o">=</span> <span class="n">cos_shifted_coadd</span> <span class="o">/</span> <span class="s2">&quot;hst_15824_cos_lmc079-1_g160m_le27_cspec.fits&quot;</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cos_shifted_coadd</span><span class="p">):</span>

    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">new_coadd</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
        <span class="n">data_new_coadd</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">wl_new_coadd</span> <span class="o">=</span> <span class="n">data_new_coadd</span><span class="p">[</span><span class="s2">&quot;WAVELENGTH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">flux_new_coadd</span> <span class="o">=</span> <span class="n">data_new_coadd</span><span class="p">[</span><span class="s2">&quot;FLUX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="c1"># Getting the indicies within the wavelength range</span>
    <span class="n">indicies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">wl_new_coadd</span> <span class="o">&gt;=</span> <span class="mf">1525.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wl_new_coadd</span> <span class="o">&lt;=</span> <span class="mf">1525.75</span><span class="p">))</span>

    <span class="n">trimmed_flux</span> <span class="o">=</span> <span class="n">flux_new_coadd</span><span class="p">[</span><span class="n">indicies</span><span class="p">]</span>
    <span class="n">trimmed_wl</span> <span class="o">=</span> <span class="n">wl_new_coadd</span><span class="p">[</span><span class="n">indicies</span><span class="p">]</span>

    <span class="c1"># We need to make an initial guess for the parameter values</span>
    <span class="c1"># The array is in form [PEAK OF GAUSSIAN, CENTRAL WAVELENGTH, WIDTH OF LINE]</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.58e-13</span><span class="p">,</span> <span class="mf">1526.63</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">]</span>

    <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">curve_fit</span><span class="p">(</span><span class="n">fit_gaussian</span><span class="p">,</span>
                                 <span class="n">trimmed_wl</span><span class="p">,</span>
                                 <span class="n">trimmed_flux</span><span class="p">,</span>
                                 <span class="n">p0</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The SiII peak is fitted to be </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2"> Å&quot;</span><span class="p">)</span>

    <span class="c1"># Plotting the absorption feature of the HLSP with our fit</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="c1"># Plotting the actual data</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">wl_new_coadd</span><span class="p">,</span>
        <span class="n">flux_new_coadd</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Coadd Data&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Plotting our fit</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">wl_new_coadd</span><span class="p">,</span>
        <span class="n">fit_gaussian</span><span class="p">(</span><span class="n">wl_new_coadd</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">),</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Model Fit&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span>
    <span class="p">)</span>

    <span class="c1"># Adding vertical lines to show fitted &quot;peak&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Coadd Model</span><span class="se">\&#39;</span><span class="s1">s Peak&#39;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">)</span>

    <span class="c1"># Adding vertical line to show observed wl of HLSP</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">popt_hlsp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;HLSP Model</span><span class="se">\&#39;</span><span class="s1">s Peak&#39;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">wavelength_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength [$\AA$]&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Flux [$erg\ s^{-1}\ cm^{-2}\ \AA^{-1}$]&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Coadd of LMC079-1 with Modeled Fit&quot;</span><span class="p">,</span>
              <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Getting the observed wavelength of our HLSP</span>
    <span class="n">observed_wavelength</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">v_r</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="p">((</span><span class="n">observed_wavelength</span> <span class="o">-</span> <span class="n">rest_wavelength</span><span class="p">)</span> <span class="o">/</span> <span class="n">rest_wavelength</span><span class="p">)</span>
    <span class="n">v_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">v_r</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The radial velocity of LMC079-1 using the coadd is roughly </span><span class="si">{</span><span class="n">v_r</span><span class="si">}</span><span class="s2"> km/s&quot;</span><span class="p">)</span>
    
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File not found: You need to run previous cells to generate the data.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The SiII peak is fitted to be 1526.63 Å
The radial velocity of LMC079-1 using the coadd is roughly -15.67 km/s
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_2818/3560258067.py:20: OptimizeWarning: Covariance of the parameters could not be estimated
  popt, _ = optimize.curve_fit(fit_gaussian,
</pre></div>
</div>
</div>
</div>
<p>The radial velocity of the coadd created with the shifted <code class="docutils literal notranslate"><span class="pre">X1D</span></code> files (<code class="docutils literal notranslate"><span class="pre">-15.67</span> <span class="pre">km/s</span></code>) is a lot closer to the HLSP’s radial velocity (<code class="docutils literal notranslate"><span class="pre">-17.78</span> <span class="pre">km/s</span></code>) compared to the radial velocity of the pre-shifted coadd (<code class="docutils literal notranslate"><span class="pre">-3.5</span> <span class="pre">km/s</span></code>). We can now move on to the STIS example.</p>
<p><a id = mainstis></a></p>
</section>
</section>
<section id="performing-wavelength-adjustments-on-stis-data">
<h2>2. Performing Wavelength Adjustments on STIS Data<a class="headerlink" href="#performing-wavelength-adjustments-on-stis-data" title="Permalink to this heading">#</a></h2>
<p>At the beginning of a science exposure, two Pt-Cr/Ne line lamps are flashed to obtain wavelength calibration exposures and assign a zero-point for the wavelength scale. These wavecals are taken at the beginning of virtually every exposure and are automatically taken at each <code class="docutils literal notranslate"><span class="pre">2300sec</span></code> interval thereafter. Similar to COS, shifts between exposures can occur due to imperfect target acquisitions, repositioning of the grating, and thermal flexure. In these instances, users will need to manually shift their spectra to ensure the correct wavelength and flux calibrations are being performed. Echelle data and low-resolution spectra are suspectable to rapid sensitivity changes with wavelength, which makes accurate wavelength solutions even more important. Information about STIS wavelength accuracies can be found in <a class="reference external" href="https://hst-docs.stsci.edu/stisdhb/chapter-4-stis-error-sources/4-2-summary-of-accuracies">Chapter 4.2</a> of the STIS Instrument Handbook.</p>
<p>We will be shifting data taken with the <code class="docutils literal notranslate"><span class="pre">STIS/CCD</span></code>, using the <code class="docutils literal notranslate"><span class="pre">52X2</span></code> aperture. There is a small pixel shift between data taken at the nominal position and data taken at the <code class="docutils literal notranslate"><span class="pre">E1</span></code> pseudo-aperture position for this STIS mode (mentioned in <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2018MNRAS.481.2361J/abstract">Joyce 2018</a>). We will download our data using <code class="docutils literal notranslate"><span class="pre">astroquery</span></code>, run the HASP script, cross-correlate the spectra in the dataset to the brightest observation to calculate the wavelength shift, and then apply this shift using <code class="docutils literal notranslate"><span class="pre">CalSTIS</span></code>.</p>
<p><strong>Note: many of the cross-correlation steps outlined in this notebook are detailed in the <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/blob/main/notebooks/STIS/cross-correlation/cross-correlation.ipynb">STIS Cross-Correlation Jupyter Notebook</a></strong></p>
<p><a id = downloadstis></a></p>
<section id="downloading-and-organizing-stis-data-using-astroquery">
<h3>2.1 Downloading and Organizing STIS Data using <code class="docutils literal notranslate"><span class="pre">Astroquery</span></code><a class="headerlink" href="#downloading-and-organizing-stis-data-using-astroquery" title="Permalink to this heading">#</a></h3>
<p>We will be downloading <code class="docutils literal notranslate"><span class="pre">STIS/CCD</span> <span class="pre">G430L</span></code> data for the object, <code class="docutils literal notranslate"><span class="pre">AGK+81D266</span></code>, a spectrophotometric target taken in Program 14423. Let’s create a few directories for our investigation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To hold all of our STIS example&#39;s output and data</span>
<span class="n">stis_ex</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./stis_ex&quot;</span><span class="p">)</span>

<span class="c1"># To contain the raw files necessary to run CalSTIS</span>
<span class="n">stis_data</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./stis_ex/stis_data/&quot;</span><span class="p">)</span>

<span class="c1"># To hold the unshifted data products and coadds</span>
<span class="n">stis_unshifted</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./stis_ex/stis_unshifted/&quot;</span><span class="p">)</span>
<span class="n">stis_unshifted_coadd</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./stis_ex/stis_unshifted/coadd/&quot;</span><span class="p">)</span>

<span class="c1"># To contain the shifted data products and coadds</span>
<span class="n">stis_shifted</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./stis_ex/stis_shifted/&quot;</span><span class="p">)</span>
<span class="n">stis_shifted_coadd</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./stis_ex/stis_shifted/coadd/&quot;</span><span class="p">)</span>

<span class="c1"># If the directory doesn&#39;t exist then create it</span>
<span class="n">stis_ex</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">stis_data</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">stis_unshifted</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">stis_unshifted_coadd</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">stis_shifted</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">stis_shifted_coadd</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can use <code class="docutils literal notranslate"><span class="pre">astroquery</span></code> to query our datasets, get a list of associated products, and download the data to our <code class="docutils literal notranslate"><span class="pre">./stis_data</span></code> directory. This is similar to how we downloaded the COS data in the previous example.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Querying our datasets</span>
<span class="n">stis_query</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span>
    <span class="n">proposal_id</span><span class="o">=</span><span class="mi">14423</span><span class="p">,</span>
    <span class="n">instrument_name</span><span class="o">=</span><span class="s2">&quot;STIS/CCD&quot;</span><span class="p">,</span>
    <span class="n">filters</span><span class="o">=</span><span class="s2">&quot;G430L&quot;</span><span class="p">,</span>
    <span class="n">target_name</span><span class="o">=</span><span class="s2">&quot;AGK+81D266&quot;</span>
<span class="p">)</span>

<span class="c1"># Getting the list of products for our datasets</span>
<span class="n">stis_prodlist</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span>
    <span class="n">stis_query</span>
<span class="p">)</span>

<span class="c1"># Some of the files aren&#39;t coadded by default because POSTARG != 0</span>
<span class="c1"># We won&#39;t download these to save memory space</span>
<span class="n">bad_obsids</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;od1am1090&quot;</span><span class="p">,</span>
    <span class="s2">&quot;od1am10a0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;od1am10c0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;od1am10d0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;od1am10f0&quot;</span>
<span class="p">]</span>

<span class="n">stis_prodlist</span> <span class="o">=</span> <span class="n">stis_prodlist</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">stis_prodlist</span><span class="p">[</span><span class="s2">&quot;obs_id&quot;</span><span class="p">],</span> <span class="n">bad_obsids</span><span class="p">)]</span>

<span class="c1"># Filtering the product list to only get the required files</span>
<span class="n">stis_prodlist</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">filter_products</span><span class="p">(</span>
    <span class="n">stis_prodlist</span><span class="p">,</span>
    <span class="n">productSubGroupDescription</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;SX1&quot;</span><span class="p">,</span> <span class="s2">&quot;RAW&quot;</span><span class="p">,</span> <span class="s2">&quot;ASN&quot;</span><span class="p">,</span> <span class="s2">&quot;FLT&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Downloading them to ./stis_data</span>
<span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span>
    <span class="n">stis_prodlist</span><span class="p">,</span>
    <span class="n">download_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">stis_data</span><span class="p">),</span>
<span class="p">)</span>

<span class="c1"># Moving all sub-folders to stis_data and deleting mastDownload folder</span>
<span class="n">consolidate_files</span><span class="p">(</span><span class="n">stis_data</span><span class="p">)</span>

<span class="c1"># Moving all sx1 to stis_unshifted</span>
<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">stis_data</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*sx1.fits*&quot;</span><span class="p">):</span>
    <span class="c1"># New path for file</span>
    <span class="n">newpath</span> <span class="o">=</span> <span class="n">stis_unshifted</span> <span class="o">/</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;FILENAME&#39;</span><span class="p">)</span>

    <span class="c1"># Moving the actual file</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">newpath</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1al1030_asn.fits to stis_ex/stis_data/mastDownload/HST/od1al1030/od1al1030_asn.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1al1030_flt.fits to stis_ex/stis_data/mastDownload/HST/od1al1030/od1al1030_flt.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1al1030_raw.fits to stis_ex/stis_data/mastDownload/HST/od1al1030/od1al1030_raw.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1al1030_sx1.fits to stis_ex/stis_data/mastDownload/HST/od1al1030/od1al1030_sx1.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1al1040_asn.fits to stis_ex/stis_data/mastDownload/HST/od1al1040/od1al1040_asn.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1al1040_flt.fits to stis_ex/stis_data/mastDownload/HST/od1al1040/od1al1040_flt.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1al1040_raw.fits to stis_ex/stis_data/mastDownload/HST/od1al1040/od1al1040_raw.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1al1040_sx1.fits to stis_ex/stis_data/mastDownload/HST/od1al1040/od1al1040_sx1.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1al2030_asn.fits to stis_ex/stis_data/mastDownload/HST/od1al2030/od1al2030_asn.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1al2030_flt.fits to stis_ex/stis_data/mastDownload/HST/od1al2030/od1al2030_flt.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1al2030_raw.fits to stis_ex/stis_data/mastDownload/HST/od1al2030/od1al2030_raw.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1al2030_sx1.fits to stis_ex/stis_data/mastDownload/HST/od1al2030/od1al2030_sx1.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1al2040_asn.fits to stis_ex/stis_data/mastDownload/HST/od1al2040/od1al2040_asn.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1al2040_flt.fits to stis_ex/stis_data/mastDownload/HST/od1al2040/od1al2040_flt.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1al2040_raw.fits to stis_ex/stis_data/mastDownload/HST/od1al2040/od1al2040_raw.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1al2040_sx1.fits to stis_ex/stis_data/mastDownload/HST/od1al2040/od1al2040_sx1.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1al4030_asn.fits to stis_ex/stis_data/mastDownload/HST/od1al4030/od1al4030_asn.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1al4030_flt.fits to stis_ex/stis_data/mastDownload/HST/od1al4030/od1al4030_flt.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1al4030_raw.fits to stis_ex/stis_data/mastDownload/HST/od1al4030/od1al4030_raw.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1al4030_sx1.fits to stis_ex/stis_data/mastDownload/HST/od1al4030/od1al4030_sx1.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1al4040_asn.fits to stis_ex/stis_data/mastDownload/HST/od1al4040/od1al4040_asn.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1al4040_flt.fits to stis_ex/stis_data/mastDownload/HST/od1al4040/od1al4040_flt.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1al4040_raw.fits to stis_ex/stis_data/mastDownload/HST/od1al4040/od1al4040_raw.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1al4040_sx1.fits to stis_ex/stis_data/mastDownload/HST/od1al4040/od1al4040_sx1.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1am10b0_asn.fits to stis_ex/stis_data/mastDownload/HST/od1am10b0/od1am10b0_asn.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1am10b0_flt.fits to stis_ex/stis_data/mastDownload/HST/od1am10b0/od1am10b0_flt.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1am10b0_raw.fits to stis_ex/stis_data/mastDownload/HST/od1am10b0/od1am10b0_raw.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1am10b0_sx1.fits to stis_ex/stis_data/mastDownload/HST/od1am10b0/od1am10b0_sx1.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1am10e0_asn.fits to stis_ex/stis_data/mastDownload/HST/od1am10e0/od1am10e0_asn.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1am10e0_flt.fits to stis_ex/stis_data/mastDownload/HST/od1am10e0/od1am10e0_flt.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1am10e0_raw.fits to stis_ex/stis_data/mastDownload/HST/od1am10e0/od1am10e0_raw.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/od1am10e0_sx1.fits to stis_ex/stis_data/mastDownload/HST/od1am10e0/od1am10e0_sx1.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
</div>
</div>
<p>Now we will go and download the reference files needed for running <code class="docutils literal notranslate"><span class="pre">CalSTIS</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We will set the CRDS_PATH environment_variable</span>
<span class="c1"># Creating path to where the files are saved</span>
<span class="n">crds_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;HOME&quot;</span><span class="p">],</span> <span class="s2">&quot;crds_cache&quot;</span><span class="p">)</span>

<span class="c1"># Setting the environment variable CRDS_PATH to our CRDS path</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CRDS_PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crds_path</span>

<span class="c1"># URL for the STScI CRDS page</span>
<span class="n">crds_server_url</span> <span class="o">=</span> <span class="s2">&quot;https://hst-crds.stsci.edu&quot;</span>

<span class="c1"># Setting env variable to URL</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CRDS_SERVER_URL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crds_server_url</span>

<span class="c1"># Set the oref environment variable (STIS)</span>
<span class="n">oref</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">crds_path</span><span class="p">,</span> <span class="s2">&quot;references/hst/stis/&quot;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;oref&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oref</span>

<span class="o">!</span>crds<span class="w"> </span>bestrefs<span class="w"> </span>--update-bestrefs<span class="w"> </span>--sync-references<span class="o">=</span><span class="m">1</span><span class="w"> </span>--files<span class="w"> </span>./stis_ex/stis_data/*_raw.fits
<span class="n">clear_output</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p><a id = initial_coadd_stis></a></p>
</section>
<section id="running-the-hasp-script-on-stis-data">
<h3>2.2 Running the HASP Script on STIS Data<a class="headerlink" href="#running-the-hasp-script-on-stis-data" title="Permalink to this heading">#</a></h3>
<p>Now that we have our data downloaded, we can run the coadd script and create abutted products. Check out our <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/tree/main/notebooks/HASP/CoaddTutorial">CoaddTutorial.ipynb</a> notebook for a more detailed look as to how to run the script and change the flag parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>swrapper<span class="w"> </span>-i<span class="w"> </span>./stis_ex/stis_unshifted<span class="w"> </span>-o<span class="w"> </span>./stis_ex/stis_unshifted/coadd
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>HASP version 1.2.3
Ullyses version 4.1.0
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Creating list of unique modes from these files:
./stis_ex/stis_unshifted/od1al1030_sx1.fits AGK+81D266 STIS CCD G430L 52X2 0 14423 (14423, &#39;l1&#39;)
./stis_ex/stis_unshifted/od1al1040_sx1.fits AGK+81D266 STIS CCD G430L 52X2E1 0 14423 (14423, &#39;l1&#39;)
./stis_ex/stis_unshifted/od1al2030_sx1.fits AGK+81D266 STIS CCD G430L 52X2 0 14423 (14423, &#39;l2&#39;)
./stis_ex/stis_unshifted/od1al2040_sx1.fits AGK+81D266 STIS CCD G430L 52X2E1 0 14423 (14423, &#39;l2&#39;)
./stis_ex/stis_unshifted/od1al4030_sx1.fits AGK+81D266 STIS CCD G430L 52X2 0 14423 (14423, &#39;l4&#39;)
./stis_ex/stis_unshifted/od1al4040_sx1.fits AGK+81D266 STIS CCD G430L 52X2E1 0 14423 (14423, &#39;l4&#39;)
./stis_ex/stis_unshifted/od1am10b0_sx1.fits AGK+81D266 STIS CCD G430L 52X2 0 14423 (14423, &#39;m1&#39;)
./stis_ex/stis_unshifted/od1am10e0_sx1.fits AGK+81D266 STIS CCD G430L 52X2E1 0 14423 (14423, &#39;m1&#39;)
Looping over visits
Processing product (14423, &#39;l1&#39;)
Targets in visit (14423, &#39;l1&#39;): [&#39;AGK+81D266&#39;]
Processing target AGK+81D266 in visit (14423, &#39;l1&#39;)
Processing grating STIS/G430L
Importing files [&#39;./stis_ex/stis_unshifted/od1al1030_sx1.fits&#39;, &#39;./stis_ex/stis_unshifted/od1al1040_sx1.fits&#39;]
Processing file ./stis_ex/stis_unshifted/od1al1030_sx1.fits
Processing file ./stis_ex/stis_unshifted/od1al1040_sx1.fits
Using a maximum SNR of 20.0 in flux-based filtering
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Yellow">WARNING</span>: VerifyWarning: Card is too long, comment will be truncated. [astropy.io.fits.card]
   Wrote ./stis_ex/stis_unshifted/coadd/hst_14423_stis_agkp81d266_g430l_od1al1_cspec.fits
Only 1 grating to abut, skipping abutment
Processing product (14423, &#39;l2&#39;)
Targets in visit (14423, &#39;l2&#39;): [&#39;AGK+81D266&#39;]
Processing target AGK+81D266 in visit (14423, &#39;l2&#39;)
Processing grating STIS/G430L
Importing files [&#39;./stis_ex/stis_unshifted/od1al2030_sx1.fits&#39;, &#39;./stis_ex/stis_unshifted/od1al2040_sx1.fits&#39;]
Processing file ./stis_ex/stis_unshifted/od1al2030_sx1.fits
Processing file ./stis_ex/stis_unshifted/od1al2040_sx1.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Using a maximum SNR of 20.0 in flux-based filtering
   Wrote ./stis_ex/stis_unshifted/coadd/hst_14423_stis_agkp81d266_g430l_od1al2_cspec.fits
Only 1 grating to abut, skipping abutment
Processing product (14423, &#39;l4&#39;)
Targets in visit (14423, &#39;l4&#39;): [&#39;AGK+81D266&#39;]
Processing target AGK+81D266 in visit (14423, &#39;l4&#39;)
Processing grating STIS/G430L
Importing files [&#39;./stis_ex/stis_unshifted/od1al4030_sx1.fits&#39;, &#39;./stis_ex/stis_unshifted/od1al4040_sx1.fits&#39;]
Processing file ./stis_ex/stis_unshifted/od1al4030_sx1.fits
Processing file ./stis_ex/stis_unshifted/od1al4040_sx1.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Using a maximum SNR of 20.0 in flux-based filtering
   Wrote ./stis_ex/stis_unshifted/coadd/hst_14423_stis_agkp81d266_g430l_od1al4_cspec.fits
Only 1 grating to abut, skipping abutment
Processing product (14423, &#39;m1&#39;)
Targets in visit (14423, &#39;m1&#39;): [&#39;AGK+81D266&#39;]
Processing target AGK+81D266 in visit (14423, &#39;m1&#39;)
Processing grating STIS/G430L
Importing files [&#39;./stis_ex/stis_unshifted/od1am10b0_sx1.fits&#39;, &#39;./stis_ex/stis_unshifted/od1am10e0_sx1.fits&#39;]
Processing file ./stis_ex/stis_unshifted/od1am10b0_sx1.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Processing file ./stis_ex/stis_unshifted/od1am10e0_sx1.fits
Using a maximum SNR of 20.0 in flux-based filtering
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   Wrote ./stis_ex/stis_unshifted/coadd/hst_14423_stis_agkp81d266_g430l_od1am1_cspec.fits
Only 1 grating to abut, skipping abutment
Looping over proposals
Processing product 14423
Targets in proposal 14423: [&#39;AGK+81D266&#39;]
Processing target AGK+81D266 in proposal 14423
Processing grating STIS/G430L
Importing files [&#39;./stis_ex/stis_unshifted/od1al1030_sx1.fits&#39;, &#39;./stis_ex/stis_unshifted/od1al1040_sx1.fits&#39;, &#39;./stis_ex/stis_unshifted/od1al2030_sx1.fits&#39;, &#39;./stis_ex/stis_unshifted/od1al2040_sx1.fits&#39;, &#39;./stis_ex/stis_unshifted/od1al4030_sx1.fits&#39;, &#39;./stis_ex/stis_unshifted/od1al4040_sx1.fits&#39;, &#39;./stis_ex/stis_unshifted/od1am10b0_sx1.fits&#39;, &#39;./stis_ex/stis_unshifted/od1am10e0_sx1.fits&#39;]
Processing file ./stis_ex/stis_unshifted/od1al1030_sx1.fits
Processing file ./stis_ex/stis_unshifted/od1al1040_sx1.fits
Processing file ./stis_ex/stis_unshifted/od1al2030_sx1.fits
Processing file ./stis_ex/stis_unshifted/od1al2040_sx1.fits
Processing file ./stis_ex/stis_unshifted/od1al4030_sx1.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Processing file ./stis_ex/stis_unshifted/od1al4040_sx1.fits
Processing file ./stis_ex/stis_unshifted/od1am10b0_sx1.fits
Processing file ./stis_ex/stis_unshifted/od1am10e0_sx1.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Using a maximum SNR of 20.0 in flux-based filtering
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   Wrote ./stis_ex/stis_unshifted/coadd/hst_14423_stis_agkp81d266_g430l_od1a_cspec.fits
Only 1 grating to abut, skipping abutment
</pre></div>
</div>
</div>
</div>
<p>We will plot the coadd over our current <code class="docutils literal notranslate"><span class="pre">SX1</span></code> files; the aperture used is also listed in the legend. Observations that were taken at the <code class="docutils literal notranslate"><span class="pre">E1</span></code> position have the value <code class="docutils literal notranslate"><span class="pre">52X2E1</span></code> for the <code class="docutils literal notranslate"><span class="pre">PROPAPER</span></code> header keyword (and are dotted on the plot), whereas observations taken at the nominal position have the value <code class="docutils literal notranslate"><span class="pre">52X2</span></code>. Notice the area around <code class="docutils literal notranslate"><span class="pre">4860Å</span></code> in the second plot shows a visible shift between datasets taken at the nominal and <code class="docutils literal notranslate"><span class="pre">E1</span></code> positions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coadd_stis</span> <span class="o">=</span> <span class="s2">&quot;hst_14423_stis_agkp81d266_g430l_od1a_cspec.fits&quot;</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stis_unshifted</span><span class="p">):</span>

    <span class="c1"># A list of the SX1 files for our data</span>
    <span class="n">sx1s</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">stis_unshifted</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*sx1*&quot;</span><span class="p">))</span>

    <span class="c1"># Creating a figure with two subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">curr_plot</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
        <span class="c1"># Plotting each SX1 file</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">sx1s</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
                <span class="n">wl</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;WAVELENGTH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">flux</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FLUX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

                <span class="n">aperture</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PROPAPER&#39;</span><span class="p">]</span>

                <span class="c1"># Differentiating between nominal and E1 position via linestyle</span>
                <span class="k">if</span> <span class="n">aperture</span> <span class="o">==</span> <span class="s2">&quot;52X2&quot;</span><span class="p">:</span>
                    <span class="n">linestyle</span> <span class="o">=</span> <span class="s2">&quot;solid&quot;</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ROOTNAME&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - nom.&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">linestyle</span> <span class="o">=</span> <span class="s2">&quot;dotted&quot;</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ROOTNAME&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - E1&quot;</span>

                <span class="c1"># Plotting the actual data</span>
                <span class="n">curr_plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span>
                               <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                               <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
                               <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                               <span class="n">linestyle</span><span class="o">=</span><span class="n">linestyle</span><span class="p">)</span>

        <span class="c1"># Plotting the coadd in black</span>
        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">stis_unshifted_coadd</span> <span class="o">/</span> <span class="n">coadd_stis</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
            <span class="n">wl</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;WAVELENGTH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FLUX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

            <span class="n">curr_plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Coadd&quot;</span><span class="p">,</span>
                           <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
                           <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                           <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Adding labels, formatting, xlim</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;SX1 Files against Coadd - AGK+81D266&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength [$\AA$]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Flux [$erg\ s^{-1}\ cm^{-2}\ \AA^{-1}$]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Flux [$erg\ s^{-1}\ cm^{-2}\ \AA^{-1}$]&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">4825</span><span class="p">,</span> <span class="mi">4900</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.4e-13</span><span class="p">,</span> <span class="mf">1.5e-13</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File not found: You need to run previous cells to generate the data.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Since we see a consistent shift in the data between the observations that used the <code class="docutils literal notranslate"><span class="pre">E1</span></code> aperture and the nominal, we need to determine the actual shift in pixels and re-run <code class="docutils literal notranslate"><span class="pre">CalSTIS</span></code> on our data. We will not be calculating the radial velocity and comparing it to the literature value to reduce notebook length, and because the shift is known to be relative to the nominal position.</p>
<p><a id = cross_correlate_stis></a></p>
</section>
<section id="performing-cross-correlation-on-stis-data-and-calculating-lag">
<h3>2.3 Performing Cross-Correlation on STIS data and Calculating Lag<a class="headerlink" href="#performing-cross-correlation-on-stis-data-and-calculating-lag" title="Permalink to this heading">#</a></h3>
<p>There are multiple ways to determine the best observation to set as the reference, and that is up to the user to do so. Since we are shifting all the <code class="docutils literal notranslate"><span class="pre">E1</span></code> observations to the nominal positions, we will use the brightest nominal observation as our reference. We are using the brightest because we are making the assumption that it is the observation most centered in the aperture, but you will need to use other methods when determining the file to reference to. Let’s determine the brightest nominal file below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># A variable for the brightest filename, arbitrarily</span>
<span class="n">ref_file</span> <span class="o">=</span> <span class="n">sx1s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">sx1s</span><span class="p">:</span>
    <span class="c1"># Getting flux data for current interation&#39;s file + current brightest file</span>
    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
        <span class="n">curr_flux</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FLUX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">aperture</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;PROPAPER&quot;</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ref_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">ref_hdul</span><span class="p">:</span>
        <span class="n">ref_flux</span> <span class="o">=</span> <span class="n">ref_hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FLUX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="c1"># If current file&#39;s mean flux &gt; ref file, replace ref file</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">curr_flux</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ref_flux</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">aperture</span> <span class="o">==</span> <span class="s2">&quot;52X2&quot;</span><span class="p">)):</span>
        <span class="n">ref_file</span> <span class="o">=</span> <span class="n">file</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">continue</span>

<span class="c1"># Printing out our file</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The brightest file is </span><span class="si">{</span><span class="n">ref_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The brightest file is od1al2030_sx1.fits.
</pre></div>
</div>
</div>
</div>
<p>We’ve now determined that <code class="docutils literal notranslate"><span class="pre">od1al2030_sx1.fits</span></code> is the brightest spectra of our data. We will go through each <code class="docutils literal notranslate"><span class="pre">SX1</span></code> file taken at the <code class="docutils literal notranslate"><span class="pre">E1</span></code> position in our data and cross-correlate it to our <code class="docutils literal notranslate"><span class="pre">od1al2030_sx1.fits</span></code> file. We will calculate the shifts for a single file first (to better illustrate each step), then define a function to perform these same steps for the rest of the files.</p>
<p>We will be cross-correlating similarly to how we did our COS example in the previous section, but this section will mainly follow the steps in the official <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/blob/main/notebooks/STIS/cross-correlation/cross-correlation.ipynb">STIS Cross-Correlation Notebook</a>.</p>
<p>We will need to calculate the mean plate scale, i.e. the dispersion per pixel, for our reference dataset. This will be used to determine the shift in pixels later on in the tutorial.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Getting a list of files taken at E1 position</span>
<span class="n">e1_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">sx1s</span> <span class="k">if</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;PROPAPER&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;52X2&quot;</span><span class="p">]</span>

<span class="c1"># Example file</span>
<span class="n">stis_file</span> <span class="o">=</span> <span class="n">e1_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Getting the data for the reference file</span>
<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ref_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
    <span class="n">ref_wl</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;WAVELENGTH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">ref_flux</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FLUX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">stis_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
    <span class="n">ex_wl</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;WAVELENGTH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">ex_flux</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FLUX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="c1"># Interpolating the example spectra</span>
<span class="n">ex_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">ref_wl</span><span class="p">,</span> <span class="n">ex_wl</span><span class="p">,</span> <span class="n">ex_flux</span><span class="p">)</span>

<span class="c1"># Getting the dispersion per pixel</span>
<span class="n">mean_plate_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ref_wl</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">ref_wl</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The dispersion per pixel is </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">mean_plate_scale</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> Å/pixel&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The dispersion per pixel is 2.75 Å/pixel
</pre></div>
</div>
</div>
</div>
<p>Now we will use our cross-correlation function defined in the COS section to determine the lag and cross-correlation coefficient. We can determine the shift by getting the lag value with the highest corresponding cross-correlation coefficient. Our lags are discrete pixel integer values, so we will need to fit a quadratic curve using <code class="docutils literal notranslate"><span class="pre">fitting</span></code> and <code class="docutils literal notranslate"><span class="pre">Polynomial1D</span></code> from the <code class="docutils literal notranslate"><span class="pre">astropy.modeling</span></code> module. The lag at the maxima of our fit is the pixel shift that we will use when re-calibrating with <code class="docutils literal notranslate"><span class="pre">CalSTIS</span></code>.</p>
<p><strong>Note: you will need to experiment with different fits when determining your lag; there is no single function that will work in all scenarios</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculating the lag and cc coeff using the earlier defined function</span>
<span class="n">lag</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">cross_correlate</span><span class="p">(</span><span class="n">ref_flux</span><span class="p">,</span> <span class="n">ex_flux</span><span class="p">)</span>

<span class="c1"># Fitting a quadratic to the peak to find pixel shift</span>
<span class="n">fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LinearLSQFitter</span><span class="p">()</span>

<span class="c1"># Getting the 8 points near the peak</span>
<span class="n">width</span> <span class="o">=</span> <span class="mi">8</span>

<span class="n">low</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="o">-</span> <span class="n">width</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="o">+</span> <span class="n">width</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">fit</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">Polynomial1D</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">x</span><span class="o">=</span><span class="n">lag</span><span class="p">[</span><span class="n">low</span><span class="p">:</span><span class="n">hi</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">cc</span><span class="p">[</span><span class="n">low</span><span class="p">:</span><span class="n">hi</span><span class="p">])</span>

<span class="n">x_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lag</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lag</span><span class="p">),</span> <span class="mf">0.01</span><span class="p">)</span>

<span class="c1"># Determining the shift, in pixels</span>
<span class="n">shift1</span> <span class="o">=</span> <span class="o">-</span><span class="n">fit</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">fit</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The shift, in pixels, is </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">shift1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> pixels&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The shift, in angstroms, is </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">shift1</span><span class="o">*</span><span class="n">mean_plate_scale</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">Å&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">lag</span><span class="p">,</span>
    <span class="n">cc</span><span class="p">,</span>
    <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">x_c</span><span class="p">,</span>
    <span class="n">fit</span><span class="p">(</span><span class="n">x_c</span><span class="p">),</span>
    <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fitted Quadratic&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="n">shift1</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Maxima of fit&quot;</span>
<span class="p">)</span>

<span class="c1"># Adding title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Lag (px) vs Cross Correlation Coeff, with fitted curve and ZOOMED&quot;</span><span class="p">,</span>
          <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Lag (px)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cross Correlation Coeff.&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">shift1</span> <span class="o">-</span> <span class="mi">25</span><span class="p">,</span> <span class="n">shift1</span> <span class="o">+</span> <span class="mi">25</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The shift, in pixels, is 1.17 pixels
The shift, in angstroms, is 3.21Å
</pre></div>
</div>
</div>
</div>
<p><a id = run_calstis></a></p>
</section>
<section id="applying-shifts-to-raw-stis-data-and-re-creating-coadd">
<h3>2.4 Applying Shifts to Raw STIS data and Re-creating Coadd<a class="headerlink" href="#applying-shifts-to-raw-stis-data-and-re-creating-coadd" title="Permalink to this heading">#</a></h3>
<p>Now that we’ve calculated the shift, we need to alter the header keywords of our data and then re-calibrate the spectrum using <code class="docutils literal notranslate"><span class="pre">CalSTIS</span></code>. We will extract the <code class="docutils literal notranslate"><span class="pre">SHIFTA1</span></code> and <code class="docutils literal notranslate"><span class="pre">SHIFTA2</span></code> keywords from the corresponding <code class="docutils literal notranslate"><span class="pre">FLT</span></code> file, add our calculated shift value to the value of this keyword, then set the <code class="docutils literal notranslate"><span class="pre">WAVECORR</span></code> calibration switch in the <code class="docutils literal notranslate"><span class="pre">RAW</span></code> file to <code class="docutils literal notranslate"><span class="pre">OMIT</span></code> and re-run <code class="docutils literal notranslate"><span class="pre">CalSTIS</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Path to the FLT for our example file</span>
<span class="n">flt_file</span> <span class="o">=</span> <span class="n">stis_data</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">stis_file</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ROOTNAME&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_flt.fits&quot;</span>

<span class="c1"># Extracting the shift from the FLT file</span>
<span class="n">SHIFTA1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">flt_file</span><span class="p">,</span> <span class="s2">&quot;SHIFTA1&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">SHIFTA2</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">flt_file</span><span class="p">,</span> <span class="s2">&quot;SHIFTA2&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Update SHIFTA1 (spectral direction) to take into account the calculated shift</span>
<span class="n">SHIFTA1</span> <span class="o">+=</span> <span class="n">shift1</span>

<span class="c1"># Path to the raw file</span>
<span class="n">raw_file</span> <span class="o">=</span> <span class="n">stis_data</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">stis_file</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ROOTNAME&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_raw.fits&quot;</span>

<span class="c1"># Updating the header to reflect updated shift + FLT SHIFTA2 value</span>
<span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="n">raw_file</span><span class="p">,</span> <span class="n">keyword</span><span class="o">=</span><span class="s2">&quot;SHIFTA1&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">SHIFTA1</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="n">raw_file</span><span class="p">,</span> <span class="n">keyword</span><span class="o">=</span><span class="s2">&quot;SHIFTA2&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">SHIFTA2</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Set WAVECORR to OMIT since we&#39;re applying the shift</span>
<span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="n">raw_file</span><span class="p">,</span> <span class="s2">&quot;WAVECORR&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;OMIT&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can run <code class="docutils literal notranslate"><span class="pre">CalSTIS</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">stistools</span><span class="o">.</span><span class="n">calstis</span><span class="o">.</span><span class="n">calstis</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">raw_file</span><span class="p">),</span>
                              <span class="n">outroot</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">stis_shifted</span><span class="p">))</span>
    
<span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;An error occured&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>*** CALSTIS-0 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:00 UTC

Input    stis_ex/stis_data/od1al1040_raw.fits
Outroot  stis_ex/stis_shifted

*** CALSTIS-1 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:00 UTC
Input    stis_ex/stis_data/od1al1040_raw.fits
Output   stis_ex/stis_shifted_blv_tmp.fits
OBSMODE  ACCUM
APERTURE 52X2
OPT_ELEM G430L
DETECTOR CCD

Imset 1  Begin 15:45:00 UTC
Epcfile  od1al1b1j_epc.fits
Warning  EPCTAB `od1al1b1j_epc.fits&#39; not found.

CCDTAB   oref$16j1600do_ccd.fits
CCDTAB   PEDIGREE=INFLIGHT 01/05/2009 01/05/2009
CCDTAB   DESCRIP =Updated amp=D gain=4 atodgain and corresponding readnoise values---
CCDTAB   DESCRIP =Proposal 8057, by I. Dashevsky &amp; P. Goudfrooij

DQICORR  PERFORM
DQITAB   oref$h1v11475o_bpx.fits
DQITAB   PEDIGREE=GROUND
DQITAB   DESCRIP =Prel. Ground Calib
DQICORR  COMPLETE

ATODCORR OMIT

BLEVCORR PERFORM
         Bias level from overscan has been subtracted; \
         mean of bias levels subtracted was 1450.05.
BLEVCORR COMPLETE
         Uncertainty array initialized, readnoise=6.24, gain=1

BIASCORR PERFORM
BIASFILE oref$02a1919to_bia.fits
BIASFILE PEDIGREE=INFLIGHT 08/11/2015 16/11/2015
BIASFILE DESCRIP =Weekly gain=1 bias for STIS CCD data taken after Nov 08 2015-------
BIASCORR COMPLETE

DARKCORR OMIT

FLATCORR OMIT

SHADCORR OMIT

PHOTCORR OMIT
Imset 1  End 15:45:00 UTC

Imset 2  Begin 15:45:00 UTC
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epcfile  od1al1b2j_epc.fits
Warning  EPCTAB `od1al1b2j_epc.fits&#39; not found.

DQICORR  PERFORM
DQICORR  COMPLETE

ATODCORR OMIT

BLEVCORR PERFORM
         Bias level from overscan has been subtracted; \
         mean of bias levels subtracted was 1451.58.
BLEVCORR COMPLETE
         Uncertainty array initialized, readnoise=6.24, gain=1

BIASCORR PERFORM
BIASCORR COMPLETE

DARKCORR OMIT

FLATCORR OMIT

SHADCORR OMIT
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Imset 2  End 15:45:00 UTC

End      05-Sep-2025 15:45:00 UTC

*** CALSTIS-1 complete ***

*** CALSTIS-2 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:00 UTC
Input    stis_ex/stis_shifted_blv_tmp.fits
Output   stis_ex/stis_shifted_crj_tmp.fits

CRCORR   PERFORM
Total number of input image sets = 2
CRREJTAB oref$j3m1403io_crr.fits
CRCORR   COMPLETE

End      05-Sep-2025 15:45:00 UTC

*** CALSTIS-2 complete ***

*** CALSTIS-1 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:00 UTC
Input    stis_ex/stis_shifted_crj_tmp.fits
Output   stis_ex/stis_shifted_crj.fits
OBSMODE  ACCUM
APERTURE 52X2
OPT_ELEM G430L
DETECTOR CCD

Imset 1  Begin 15:45:00 UTC

CCDTAB   oref$16j1600do_ccd.fits
CCDTAB   PEDIGREE=INFLIGHT 01/05/2009 01/05/2009
CCDTAB   DESCRIP =Updated amp=D gain=4 atodgain and corresponding readnoise values---
CCDTAB   DESCRIP =Proposal 8057, by I. Dashevsky &amp; P. Goudfrooij

DQICORR  OMIT

ATODCORR OMIT

BLEVCORR OMIT

BIASCORR OMIT

DARKCORR PERFORM
DARKFILE oref$02a1920ao_drk.fits
DARKFILE PEDIGREE=INFLIGHT 07/11/2015 16/11/2015
DARKFILE DESCRIP =Weekly gain=1 dark for STIS CCD data taken after Nov 07 2015-------
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DARKCORR COMPLETE

FLATCORR PERFORM
PFLTFILE oref$x6417094o_pfl.fits
PFLTFILE PEDIGREE=INFLIGHT 24/10/2011 24/06/2012
PFLTFILE DESCRIP =REVISED ON-ORBIT STIS SPECTROSCOPIC CCD P-FLAT FOR L-MODES---------
LFLTFILE oref$pcc2026jo_lfl.fits
LFLTFILE PEDIGREE=INFLIGHT 27/05/1997 03/08/2004
LFLTFILE DESCRIP =CCD G430L Low-Order Flat
FLATCORR COMPLETE

SHADCORR OMIT

PHOTCORR OMIT

STATFLAG PERFORM
STATFLAG COMPLETE
Imset 1  End 15:45:00 UTC

End      05-Sep-2025 15:45:00 UTC

*** CALSTIS-1 complete ***

*** CALSTIS-1 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:00 UTC
Input    stis_ex/stis_shifted_blv_tmp.fits
Output   stis_ex/stis_shifted_flt.fits
OBSMODE  ACCUM
APERTURE 52X2
OPT_ELEM G430L
DETECTOR CCD

Imset 1  Begin 15:45:00 UTC
Epcfile  od1al1b1j_epc.fits
Warning  EPCTAB `od1al1b1j_epc.fits&#39; not found.

CCDTAB   oref$16j1600do_ccd.fits
CCDTAB   PEDIGREE=INFLIGHT 01/05/2009 01/05/2009
CCDTAB   DESCRIP =Updated amp=D gain=4 atodgain and corresponding readnoise values---
CCDTAB   DESCRIP =Proposal 8057, by I. Dashevsky &amp; P. Goudfrooij

DQICORR  OMIT

ATODCORR OMIT

BLEVCORR OMIT

BIASCORR OMIT

DARKCORR PERFORM
DARKFILE oref$02a1920ao_drk.fits
DARKFILE PEDIGREE=INFLIGHT 07/11/2015 16/11/2015
DARKFILE DESCRIP =Weekly gain=1 dark for STIS CCD data taken after Nov 07 2015-------
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DARKCORR COMPLETE

FLATCORR PERFORM
PFLTFILE oref$x6417094o_pfl.fits
PFLTFILE PEDIGREE=INFLIGHT 24/10/2011 24/06/2012
PFLTFILE DESCRIP =REVISED ON-ORBIT STIS SPECTROSCOPIC CCD P-FLAT FOR L-MODES---------
LFLTFILE oref$pcc2026jo_lfl.fits
LFLTFILE PEDIGREE=INFLIGHT 27/05/1997 03/08/2004
LFLTFILE DESCRIP =CCD G430L Low-Order Flat
FLATCORR COMPLETE

SHADCORR OMIT

PHOTCORR OMIT

STATFLAG PERFORM
STATFLAG COMPLETE
Imset 1  End 15:45:00 UTC

Imset 2  Begin 15:45:00 UTC
Epcfile  od1al1b2j_epc.fits
Warning  EPCTAB `od1al1b2j_epc.fits&#39; not found.

DQICORR  OMIT

ATODCORR OMIT

BLEVCORR OMIT

BIASCORR OMIT

DARKCORR PERFORM
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DARKCORR COMPLETE

FLATCORR PERFORM
FLATCORR COMPLETE

SHADCORR OMIT

STATFLAG PERFORM
STATFLAG COMPLETE
Imset 2  End 15:45:00 UTC

End      05-Sep-2025 15:45:00 UTC

*** CALSTIS-1 complete ***

*** CALSTIS-7 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:00 UTC
Input    stis_ex/stis_shifted_crj.fits
Output   stis_ex/stis_shifted_sx2.fits
OBSMODE  ACCUM
APERTURE 52X2E1
OPT_ELEM G430L
DETECTOR CCD
Imset 1  Begin 15:45:00 UTC
Warning  Wavecal processing has not been performed.

HELCORR  PERFORM
HELCORR  COMPLETE

Order 1  Begin 15:45:01 UTC

X2DCORR  PERFORM
DISPCORR PERFORM
APDESTAB oref$16j16005o_apd.fits
APDESTAB PEDIGREE=INFLIGHT 01/03/1997 13/06/2017
APDESTAB DESCRIP =Aligned long-slit bar positions for single-bar cases.--------------
APDESTAB DESCRIP =Offset relative to row 900
SDCTAB   oref$16j16006o_sdc.fits
SDCTAB   PEDIGREE=INFLIGHT 27/05/1997 13/06/2017
SDCTAB   DESCRIP =Co-aligned fiducial bars via an update to the CDELT2 plate scales.-
SDCTAB   DESCRIP =CDELT2 updated with inflight data, others Lindler/prelaunch
DISPTAB  oref$l2j0137to_dsp.fits
DISPTAB  PEDIGREE=INFLIGHT 27/02/1997 24/11/1999
DISPTAB  DESCRIP =Lindler, May 2000
DISPTAB  DESCRIP =Lindler Postlaunch, May 2000
INANGTAB oref$h5s11397o_iac.fits
INANGTAB PEDIGREE=GROUND
INANGTAB DESCRIP =Model/C. Bowers May 6, 1997
INANGTAB DESCRIP =Model/C. Bowers
SPTRCTAB oref$qa31608go_1dt.fits
SPTRCTAB PEDIGREE=INFLIGHT 13/02/1998
SPTRCTAB DESCRIP =New traces to account for angle change with time
SPTRCTAB DESCRIP =Lindler/Bohlin/Dressel/Holfeltz postlaunch calibration

FLUXCORR PERFORM
PHOTTAB  oref$95118575o_pht.fits
PHOTTAB  PEDIGREE=INFLIGHT 27/02/1997 14/04/1998
PHOTTAB  DESCRIP =Fullerton 2025 calibration
PHOTTAB  DESCRIP =Updated Sensitivities 2022
APERTAB  oref$y2r1559to_apt.fits
APERTAB  PEDIGREE=MODEL
APERTAB  DESCRIP =Added/updated values for 31X0.05NDA,31X0.05NDB,31X0.05NDC apertures
APERTAB  DESCRIP =Bohlin/Hartig TIM Models Nov. 1998
PCTAB    oref$q541740no_pct.fits
PCTAB    PEDIGREE=INFLIGHT 18/5/1997 19/12/1998
PCTAB    DESCRIP =Sensitivity for diff. extractions heights
PCTAB    DESCRIP =12 STIS observations averaged
TDSTAB   oref$8712049eo_tds.fits
TDSTAB   PEDIGREE=INFLIGHT 01/04/1997 06/03/2024
TDSTAB   DESCRIP =Updated time sensitivities for MIRVIS, G230LB, and G230MB
FLUXCORR COMPLETE
X2DCORR  COMPLETE
DISPCORR COMPLETE
Order 1  End 15:45:01 UTC
Imset 1  End 15:45:01 UTC

End      05-Sep-2025 15:45:01 UTC

*** CALSTIS-7 complete ***

*** CALSTIS-6 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:01 UTC

INFO     &#39;E1&#39; has been appended to aperture
Input    stis_ex/stis_shifted_crj.fits
Output   stis_ex/stis_shifted_sx1.fits
Rootname od1al1040
OBSMODE  ACCUM
APERTURE 52X2E1
OPT_ELEM G430L
DETECTOR CCD

XTRACTAB oref$n7p1031qo_1dx.fits
XTRACTAB PEDIGREE=INFLIGHT 18/05/97
XTRACTAB DESCRIP =Analysis from prop. 7094
XTRACTAB DESCRIP =Analysis from prop. 7094
SPTRCTAB oref$qa31608go_1dt.fits
SPTRCTAB PEDIGREE=INFLIGHT 02/09/1997 13/02/1998
SPTRCTAB DESCRIP =New traces to account for angle change with time

Imset 1  Begin 15:45:01 UTC
         Input read into memory.
Order 1  Begin 15:45:01 UTC
X1DCORR  PERFORM
BACKCORR PERFORM
******** Calling Slfit ***********BACKCORR COMPLETE
X1DCORR  COMPLETE
         Spectrum extracted at y position = 892.684

DISPCORR PERFORM
DISPTAB  oref$l2j0137to_dsp.fits
DISPTAB  PEDIGREE=INFLIGHT 27/02/1997 24/11/1999
DISPTAB  DESCRIP =Lindler, May 2000
DISPTAB  DESCRIP =Lindler Postlaunch, May 2000
APDESTAB oref$16j16005o_apd.fits
APDESTAB PEDIGREE=INFLIGHT 01/03/1997 13/06/2017
APDESTAB DESCRIP =Aligned long-slit bar positions for single-bar cases.--------------
APDESTAB DESCRIP =Offset relative to row 900
INANGTAB oref$h5s11397o_iac.fits
INANGTAB DESCRIP =Model/C. Bowers May 6, 1997
DISPCORR COMPLETE

HELCORR  PERFORM
HELCORR  COMPLETE

PHOTTAB  oref$95118575o_pht.fits
PHOTTAB  PEDIGREE=INFLIGHT 27/02/1997 16/03/2021
PHOTTAB  DESCRIP =Fullerton 2025 calibration
APERTAB  oref$y2r1559to_apt.fits
APERTAB  PEDIGREE=MODEL
APERTAB  DESCRIP =Added/updated values for 31X0.05NDA,31X0.05NDB,31X0.05NDC apertures
APERTAB  DESCRIP =Bohlin/Hartig TIM Models Nov. 1998
GACTAB   oref$p9r19203o_gac.fits
GACTAB   PEDIGREE=INFLIGHT 03/04/2002 03/08/2004
GACTAB   DESCRIP =X1D flux corr for grating/aper combos
GACTAB   DESCRIP =Grating-Aperture Throughput Correction
PCTAB    oref$q541740no_pct.fits
PCTAB    PEDIGREE=INFLIGHT 18/05/1997 19/12/1998
PCTAB    DESCRIP =Sensitivity for diff. extractions heights
TDSTAB   oref$8712049eo_tds.fits
TDSTAB   PEDIGREE=INFLIGHT 01/04/1997 06/03/2024
TDSTAB   DESCRIP =Updated time sensitivities for MIRVIS, G230LB, and G230MB
FLUXCORR PERFORM
CTECORR  PERFORM
CCDTAB   oref$16j1600do_ccd.fits
CCDTAB   PEDIGREE=INFLIGHT 01/05/2009 01/05/2009
CCDTAB   DESCRIP =Updated amp=D gain=4 atodgain and corresponding readnoise values---
CCDTAB   DESCRIP =Proposal 8057, by I. Dashevsky &amp; P. Goudfrooij
         GACTAB correction applied for G430L 52X2E1 4300
CTECORR  COMPLETE
FLUXCORR COMPLETE
SGEOCORR OMIT

         Row 1 written to disk.
Order 1  End 15:45:01 UTC

         trace was rotated by = 0.0493412 degree.
Imset 1  End 15:45:01 UTC

Warning  Keyword `XTRACALG&#39; is being added to header.
End      05-Sep-2025 15:45:01 UTC

*** CALSTIS-6 complete ***

End      05-Sep-2025 15:45:01 UTC

*** CALSTIS-0 complete ***
</pre></div>
</div>
</div>
</div>
<p>We will now define a function to calculate and perform shifts on the rest of the <code class="docutils literal notranslate"><span class="pre">E1</span></code> position datasets. We have three remaining files to shift, so we will define a function to calculate the fit, plot, and run <code class="docutils literal notranslate"><span class="pre">CalSTIS</span></code>.</p>
<p><strong>Note that you will need to experiment with different fits/functions for your dataset.</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">shift_stis</span><span class="p">(</span><span class="n">ref_file</span><span class="p">,</span> <span class="n">stis_file</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">run_calstis</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Determing the shift, in pixels, between the file and the reference.</span>
<span class="sd">    Update the RAW file with the new shift and run CalSTIS.</span>
<span class="sd">    ----------</span>
<span class="sd">    Input:</span>
<span class="sd">    pathlib.Path or str ref_file : Path to the reference file</span>
<span class="sd">    pathlib.Path or str stis_file : Path to the file that needs to be shifted</span>
<span class="sd">    int width : Number points to fit at the peak of the function, must be &gt; 2</span>
<span class="sd">    bool plot : Do you want to plot the cc function and the fit?</span>
<span class="sd">    bool run_calstis : True if you want to run CalSTIS on the shifted dataset</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Getting the data for the reference file</span>
    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ref_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
        <span class="n">ref_wl</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;WAVELENGTH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">ref_flux</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FLUX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">stis_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
        <span class="n">ex_wl</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;WAVELENGTH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">ex_flux</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FLUX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="c1"># Interpolating the example spectra</span>
    <span class="n">ex_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">ref_wl</span><span class="p">,</span> <span class="n">ex_wl</span><span class="p">,</span> <span class="n">ex_flux</span><span class="p">)</span>

    <span class="c1"># Getting the dispersion per pixel</span>
    <span class="n">mean_plate_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ref_wl</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">ref_wl</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dispersion per pixel is </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">mean_plate_scale</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> Å/pixel&quot;</span><span class="p">)</span>

    <span class="c1"># Calculating the lag and cc coeff using the earlier defined function</span>
    <span class="n">lag</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">cross_correlate</span><span class="p">(</span><span class="n">ref_flux</span><span class="p">,</span> <span class="n">ex_flux</span><span class="p">)</span>

    <span class="c1"># Fitting a quadratic to the peak to find pixel shift</span>
    <span class="n">fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LinearLSQFitter</span><span class="p">()</span>

    <span class="n">low</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="o">-</span> <span class="n">width</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="o">+</span> <span class="n">width</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">Polynomial1D</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">x</span><span class="o">=</span><span class="n">lag</span><span class="p">[</span><span class="n">low</span><span class="p">:</span><span class="n">hi</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">cc</span><span class="p">[</span><span class="n">low</span><span class="p">:</span><span class="n">hi</span><span class="p">])</span>

    <span class="n">x_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lag</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lag</span><span class="p">),</span> <span class="mf">0.01</span><span class="p">)</span>

    <span class="c1"># Determining the shift, in pixels</span>
    <span class="n">shift1</span> <span class="o">=</span> <span class="o">-</span><span class="n">fit</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">fit</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The shift, in pixels, is </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">shift1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> pixels&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The shift, in Å, is </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">shift1</span><span class="o">*</span><span class="n">mean_plate_scale</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">Å&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">lag</span><span class="p">,</span>
            <span class="n">cc</span><span class="p">,</span>
            <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">x_c</span><span class="p">,</span>
            <span class="n">fit</span><span class="p">(</span><span class="n">x_c</span><span class="p">),</span>
            <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fitted Quadratic&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
            <span class="n">shift1</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Maxima of fit&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Adding title</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Lag (px) vs Cross Correlation Coeff, with fitted curve&quot;</span><span class="p">,</span>
                  <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Lag (px)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cross Correlation Coeff.&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">shift1</span> <span class="o">-</span> <span class="mi">25</span><span class="p">,</span> <span class="n">shift1</span> <span class="o">+</span> <span class="mi">25</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">run_calstis</span><span class="p">:</span>
        <span class="c1"># Path to the FLT for our example file</span>
        <span class="n">flt_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stis_data</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">stis_file</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ROOTNAME&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_flt.fits&quot;</span>

        <span class="c1"># Extracting the shift from the FLT file</span>
        <span class="n">SHIFTA1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">flt_file</span><span class="p">,</span> <span class="s2">&quot;SHIFTA1&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">SHIFTA2</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">flt_file</span><span class="p">,</span> <span class="s2">&quot;SHIFTA2&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Update SHIFTA1 (spectral direction) to include the calculated shift</span>
        <span class="n">SHIFTA1</span> <span class="o">+=</span> <span class="n">shift1</span>

        <span class="c1"># Path to the raw file</span>
        <span class="n">raw_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stis_data</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">stis_file</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ROOTNAME&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_raw.fits&quot;</span>

        <span class="c1"># Updating the header to reflect updated shift + FLT SHIFTA2 value</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="n">raw_file</span><span class="p">,</span> <span class="n">keyword</span><span class="o">=</span><span class="s2">&quot;SHIFTA1&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">SHIFTA1</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="n">raw_file</span><span class="p">,</span> <span class="n">keyword</span><span class="o">=</span><span class="s2">&quot;SHIFTA2&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">SHIFTA2</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Set WAVECORR to OMIT since we&#39;re applying the shift</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="n">raw_file</span><span class="p">,</span> <span class="s2">&quot;WAVECORR&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;OMIT&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">stistools</span><span class="o">.</span><span class="n">calstis</span><span class="o">.</span><span class="n">calstis</span><span class="p">(</span><span class="n">raw_file</span><span class="p">,</span>
                                  <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">outroot</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">stis_shifted</span><span class="p">)</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s shift <code class="docutils literal notranslate"><span class="pre">od1al4040_sx1.fits</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">width</span> <span class="o">=</span> <span class="mi">7</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">shift_stis</span><span class="p">(</span><span class="n">ref_file</span><span class="p">,</span> <span class="n">e1_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">run_calstis</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;An error occured&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dispersion per pixel is 2.75 Å/pixel
The shift, in pixels, is 0.73 pixels
The shift, in Å, is 2.01Å

*** CALSTIS-0 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:01 UTC

Input    stis_ex/stis_data/od1al2040_raw.fits
Outroot  stis_ex/stis_shifted/od1al2040_raw.fits

*** CALSTIS-1 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:01 UTC
Input    stis_ex/stis_data/od1al2040_raw.fits
Output   stis_ex/stis_shifted/od1al2040_blv_tmp.fits
OBSMODE  ACCUM
APERTURE 52X2
OPT_ELEM G430L
DETECTOR CCD

Imset 1  Begin 15:45:01 UTC
Epcfile  od1al2yrj_epc.fits
Warning  EPCTAB `od1al2yrj_epc.fits&#39; not found.

CCDTAB   oref$16j1600do_ccd.fits
CCDTAB   PEDIGREE=INFLIGHT 01/05/2009 01/05/2009
CCDTAB   DESCRIP =Updated amp=D gain=4 atodgain and corresponding readnoise values---
CCDTAB   DESCRIP =Proposal 8057, by I. Dashevsky &amp; P. Goudfrooij

DQICORR  PERFORM
DQITAB   oref$h1v11475o_bpx.fits
DQITAB   PEDIGREE=GROUND
DQITAB   DESCRIP =Prel. Ground Calib
DQICORR  COMPLETE

ATODCORR OMIT

BLEVCORR PERFORM
         Bias level from overscan has been subtracted; \
         mean of bias levels subtracted was 1442.79.
BLEVCORR COMPLETE
         Uncertainty array initialized, readnoise=6.24, gain=1

BIASCORR PERFORM
BIASFILE oref$05314032o_bia.fits
BIASFILE PEDIGREE=INFLIGHT 27/03/2016 04/04/2016
BIASFILE DESCRIP =Weekly gain=1 bias for STIS CCD data taken after Mar 27 2016-------
BIASCORR COMPLETE

DARKCORR OMIT

FLATCORR OMIT

SHADCORR OMIT

PHOTCORR OMIT
Imset 1  End 15:45:01 UTC

Imset 2  Begin 15:45:01 UTC
Epcfile  od1al2ysj_epc.fits
Warning  EPCTAB `od1al2ysj_epc.fits&#39; not found.

DQICORR  PERFORM
DQICORR  COMPLETE

ATODCORR OMIT

BLEVCORR PERFORM
         Bias level from overscan has been subtracted; \
         mean of bias levels subtracted was 1444.06.
BLEVCORR COMPLETE
         Uncertainty array initialized, readnoise=6.24, gain=1

BIASCORR PERFORM
BIASCORR COMPLETE

DARKCORR OMIT

FLATCORR OMIT

SHADCORR OMIT
Imset 2  End 15:45:01 UTC

End      05-Sep-2025 15:45:01 UTC

*** CALSTIS-1 complete ***

*** CALSTIS-2 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:01 UTC
Input    stis_ex/stis_shifted/od1al2040_blv_tmp.fits
Output   stis_ex/stis_shifted/od1al2040_crj_tmp.fits

CRCORR   PERFORM
Total number of input image sets = 2
CRREJTAB oref$j3m1403io_crr.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CRCORR   COMPLETE

End      05-Sep-2025 15:45:01 UTC

*** CALSTIS-2 complete ***

*** CALSTIS-1 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:01 UTC
Input    stis_ex/stis_shifted/od1al2040_crj_tmp.fits
Output   stis_ex/stis_shifted/od1al2040_crj.fits
OBSMODE  ACCUM
APERTURE 52X2
OPT_ELEM G430L
DETECTOR CCD

Imset 1  Begin 15:45:01 UTC

CCDTAB   oref$16j1600do_ccd.fits
CCDTAB   PEDIGREE=INFLIGHT 01/05/2009 01/05/2009
CCDTAB   DESCRIP =Updated amp=D gain=4 atodgain and corresponding readnoise values---
CCDTAB   DESCRIP =Proposal 8057, by I. Dashevsky &amp; P. Goudfrooij

DQICORR  OMIT

ATODCORR OMIT

BLEVCORR OMIT

BIASCORR OMIT

DARKCORR PERFORM
DARKFILE oref$0531403co_drk.fits
DARKFILE PEDIGREE=INFLIGHT 27/03/2016 04/04/2016
DARKFILE DESCRIP =Weekly gain=1 dark for STIS CCD data taken after Mar 27 2016-------
DARKCORR COMPLETE

FLATCORR PERFORM
PFLTFILE oref$x6417094o_pfl.fits
PFLTFILE PEDIGREE=INFLIGHT 24/10/2011 24/06/2012
PFLTFILE DESCRIP =REVISED ON-ORBIT STIS SPECTROSCOPIC CCD P-FLAT FOR L-MODES---------
LFLTFILE oref$pcc2026jo_lfl.fits
LFLTFILE PEDIGREE=INFLIGHT 27/05/1997 03/08/2004
LFLTFILE DESCRIP =CCD G430L Low-Order Flat
FLATCORR COMPLETE

SHADCORR OMIT

PHOTCORR OMIT

STATFLAG PERFORM
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>STATFLAG COMPLETE
Imset 1  End 15:45:01 UTC

End      05-Sep-2025 15:45:01 UTC

*** CALSTIS-1 complete ***

*** CALSTIS-1 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:01 UTC
Input    stis_ex/stis_shifted/od1al2040_blv_tmp.fits
Output   stis_ex/stis_shifted/od1al2040_flt.fits
OBSMODE  ACCUM
APERTURE 52X2
OPT_ELEM G430L
DETECTOR CCD

Imset 1  Begin 15:45:01 UTC
Epcfile  od1al2yrj_epc.fits
Warning  EPCTAB `od1al2yrj_epc.fits&#39; not found.

CCDTAB   oref$16j1600do_ccd.fits
CCDTAB   PEDIGREE=INFLIGHT 01/05/2009 01/05/2009
CCDTAB   DESCRIP =Updated amp=D gain=4 atodgain and corresponding readnoise values---
CCDTAB   DESCRIP =Proposal 8057, by I. Dashevsky &amp; P. Goudfrooij

DQICORR  OMIT

ATODCORR OMIT

BLEVCORR OMIT

BIASCORR OMIT

DARKCORR PERFORM
DARKFILE oref$0531403co_drk.fits
DARKFILE PEDIGREE=INFLIGHT 27/03/2016 04/04/2016
DARKFILE DESCRIP =Weekly gain=1 dark for STIS CCD data taken after Mar 27 2016-------
DARKCORR COMPLETE

FLATCORR PERFORM
PFLTFILE oref$x6417094o_pfl.fits
PFLTFILE PEDIGREE=INFLIGHT 24/10/2011 24/06/2012
PFLTFILE DESCRIP =REVISED ON-ORBIT STIS SPECTROSCOPIC CCD P-FLAT FOR L-MODES---------
LFLTFILE oref$pcc2026jo_lfl.fits
LFLTFILE PEDIGREE=INFLIGHT 27/05/1997 03/08/2004
LFLTFILE DESCRIP =CCD G430L Low-Order Flat
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>FLATCORR COMPLETE

SHADCORR OMIT

PHOTCORR OMIT

STATFLAG PERFORM
STATFLAG COMPLETE
Imset 1  End 15:45:01 UTC

Imset 2  Begin 15:45:01 UTC
Epcfile  od1al2ysj_epc.fits
Warning  EPCTAB `od1al2ysj_epc.fits&#39; not found.

DQICORR  OMIT

ATODCORR OMIT

BLEVCORR OMIT

BIASCORR OMIT

DARKCORR PERFORM
DARKCORR COMPLETE

FLATCORR PERFORM
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>FLATCORR COMPLETE

SHADCORR OMIT

STATFLAG PERFORM
STATFLAG COMPLETE
Imset 2  End 15:45:02 UTC

End      05-Sep-2025 15:45:02 UTC

*** CALSTIS-1 complete ***

*** CALSTIS-7 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:02 UTC
Input    stis_ex/stis_shifted/od1al2040_crj.fits
Output   stis_ex/stis_shifted/od1al2040_sx2.fits
OBSMODE  ACCUM
APERTURE 52X2E1
OPT_ELEM G430L
DETECTOR CCD
Imset 1  Begin 15:45:02 UTC
Warning  Wavecal processing has not been performed.

HELCORR  PERFORM
HELCORR  COMPLETE

Order 1  Begin 15:45:02 UTC

X2DCORR  PERFORM
DISPCORR PERFORM
APDESTAB oref$16j16005o_apd.fits
APDESTAB PEDIGREE=INFLIGHT 01/03/1997 13/06/2017
APDESTAB DESCRIP =Aligned long-slit bar positions for single-bar cases.--------------
APDESTAB DESCRIP =Offset relative to row 900
SDCTAB   oref$16j16006o_sdc.fits
SDCTAB   PEDIGREE=INFLIGHT 27/05/1997 13/06/2017
SDCTAB   DESCRIP =Co-aligned fiducial bars via an update to the CDELT2 plate scales.-
SDCTAB   DESCRIP =CDELT2 updated with inflight data, others Lindler/prelaunch
DISPTAB  oref$l2j0137to_dsp.fits
DISPTAB  PEDIGREE=INFLIGHT 27/02/1997 24/11/1999
DISPTAB  DESCRIP =Lindler, May 2000
DISPTAB  DESCRIP =Lindler Postlaunch, May 2000
INANGTAB oref$h5s11397o_iac.fits
INANGTAB PEDIGREE=GROUND
INANGTAB DESCRIP =Model/C. Bowers May 6, 1997
INANGTAB DESCRIP =Model/C. Bowers
SPTRCTAB oref$qa31608go_1dt.fits
SPTRCTAB PEDIGREE=INFLIGHT 13/02/1998
SPTRCTAB DESCRIP =New traces to account for angle change with time
SPTRCTAB DESCRIP =Lindler/Bohlin/Dressel/Holfeltz postlaunch calibration

FLUXCORR PERFORM
PHOTTAB  oref$95118575o_pht.fits
PHOTTAB  PEDIGREE=INFLIGHT 27/02/1997 14/04/1998
PHOTTAB  DESCRIP =Fullerton 2025 calibration
PHOTTAB  DESCRIP =Updated Sensitivities 2022
APERTAB  oref$y2r1559to_apt.fits
APERTAB  PEDIGREE=MODEL
APERTAB  DESCRIP =Added/updated values for 31X0.05NDA,31X0.05NDB,31X0.05NDC apertures
APERTAB  DESCRIP =Bohlin/Hartig TIM Models Nov. 1998
PCTAB    oref$q541740no_pct.fits
PCTAB    PEDIGREE=INFLIGHT 18/5/1997 19/12/1998
PCTAB    DESCRIP =Sensitivity for diff. extractions heights
PCTAB    DESCRIP =12 STIS observations averaged
TDSTAB   oref$8712049eo_tds.fits
TDSTAB   PEDIGREE=INFLIGHT 01/04/1997 06/03/2024
TDSTAB   DESCRIP =Updated time sensitivities for MIRVIS, G230LB, and G230MB
FLUXCORR COMPLETE
X2DCORR  COMPLETE
DISPCORR COMPLETE
Order 1  End 15:45:02 UTC
Imset 1  End 15:45:02 UTC

End      05-Sep-2025 15:45:02 UTC

*** CALSTIS-7 complete ***

*** CALSTIS-6 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:02 UTC

INFO     &#39;E1&#39; has been appended to aperture
Input    stis_ex/stis_shifted/od1al2040_crj.fits
Output   stis_ex/stis_shifted/od1al2040_sx1.fits
Rootname od1al2040
OBSMODE  ACCUM
APERTURE 52X2E1
OPT_ELEM G430L
DETECTOR CCD

XTRACTAB oref$n7p1031qo_1dx.fits
XTRACTAB PEDIGREE=INFLIGHT 18/05/97
XTRACTAB DESCRIP =Analysis from prop. 7094
XTRACTAB DESCRIP =Analysis from prop. 7094
SPTRCTAB oref$qa31608go_1dt.fits
SPTRCTAB PEDIGREE=INFLIGHT 02/09/1997 13/02/1998
SPTRCTAB DESCRIP =New traces to account for angle change with time

Imset 1  Begin 15:45:02 UTC
         Input read into memory.
Order 1  Begin 15:45:02 UTC
X1DCORR  PERFORM
BACKCORR PERFORM
******** Calling Slfit ***********BACKCORR COMPLETE
X1DCORR  COMPLETE
         Spectrum extracted at y position = 892.934

DISPCORR PERFORM
DISPTAB  oref$l2j0137to_dsp.fits
DISPTAB  PEDIGREE=INFLIGHT 27/02/1997 24/11/1999
DISPTAB  DESCRIP =Lindler, May 2000
DISPTAB  DESCRIP =Lindler Postlaunch, May 2000
APDESTAB oref$16j16005o_apd.fits
APDESTAB PEDIGREE=INFLIGHT 01/03/1997 13/06/2017
APDESTAB DESCRIP =Aligned long-slit bar positions for single-bar cases.--------------
APDESTAB DESCRIP =Offset relative to row 900
INANGTAB oref$h5s11397o_iac.fits
INANGTAB DESCRIP =Model/C. Bowers May 6, 1997
DISPCORR COMPLETE

HELCORR  PERFORM
HELCORR  COMPLETE

PHOTTAB  oref$95118575o_pht.fits
PHOTTAB  PEDIGREE=INFLIGHT 27/02/1997 16/03/2021
PHOTTAB  DESCRIP =Fullerton 2025 calibration
APERTAB  oref$y2r1559to_apt.fits
APERTAB  PEDIGREE=MODEL
APERTAB  DESCRIP =Added/updated values for 31X0.05NDA,31X0.05NDB,31X0.05NDC apertures
APERTAB  DESCRIP =Bohlin/Hartig TIM Models Nov. 1998
GACTAB   oref$p9r19203o_gac.fits
GACTAB   PEDIGREE=INFLIGHT 03/04/2002 03/08/2004
GACTAB   DESCRIP =X1D flux corr for grating/aper combos
GACTAB   DESCRIP =Grating-Aperture Throughput Correction
PCTAB    oref$q541740no_pct.fits
PCTAB    PEDIGREE=INFLIGHT 18/05/1997 19/12/1998
PCTAB    DESCRIP =Sensitivity for diff. extractions heights
TDSTAB   oref$8712049eo_tds.fits
TDSTAB   PEDIGREE=INFLIGHT 01/04/1997 06/03/2024
TDSTAB   DESCRIP =Updated time sensitivities for MIRVIS, G230LB, and G230MB
FLUXCORR PERFORM
CTECORR  PERFORM
CCDTAB   oref$16j1600do_ccd.fits
CCDTAB   PEDIGREE=INFLIGHT 01/05/2009 01/05/2009
CCDTAB   DESCRIP =Updated amp=D gain=4 atodgain and corresponding readnoise values---
CCDTAB   DESCRIP =Proposal 8057, by I. Dashevsky &amp; P. Goudfrooij
         GACTAB correction applied for G430L 52X2E1 4300
CTECORR  COMPLETE
FLUXCORR COMPLETE
SGEOCORR OMIT

         Row 1 written to disk.
Order 1  End 15:45:02 UTC

         trace was rotated by = 0.0508783 degree.
Imset 1  End 15:45:02 UTC

Warning  Keyword `XTRACALG&#39; is being added to header.
End      05-Sep-2025 15:45:02 UTC

*** CALSTIS-6 complete ***

End      05-Sep-2025 15:45:02 UTC

*** CALSTIS-0 complete ***
</pre></div>
</div>
</div>
</div>
<p>Now <code class="docutils literal notranslate"><span class="pre">od1am10e0_sx1.fits</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">width</span> <span class="o">=</span> <span class="mi">9</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">shift_stis</span><span class="p">(</span><span class="n">ref_file</span><span class="p">,</span> <span class="n">e1_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">run_calstis</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;An error occured&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dispersion per pixel is 2.75 Å/pixel
The shift, in pixels, is 0.86 pixels
The shift, in Å, is 2.37Å
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>*** CALSTIS-0 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:02 UTC

Input    stis_ex/stis_data/od1al4040_raw.fits
Outroot  stis_ex/stis_shifted/od1al4040_raw.fits

*** CALSTIS-1 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:02 UTC
Input    stis_ex/stis_data/od1al4040_raw.fits
Output   stis_ex/stis_shifted/od1al4040_blv_tmp.fits
OBSMODE  ACCUM
APERTURE 52X2
OPT_ELEM G430L
DETECTOR CCD

Imset 1  Begin 15:45:02 UTC
Epcfile  od1al4axj_epc.fits
Warning  EPCTAB `od1al4axj_epc.fits&#39; not found.

CCDTAB   oref$16j1600do_ccd.fits
CCDTAB   PEDIGREE=INFLIGHT 01/05/2009 01/05/2009
CCDTAB   DESCRIP =Updated amp=D gain=4 atodgain and corresponding readnoise values---
CCDTAB   DESCRIP =Proposal 8057, by I. Dashevsky &amp; P. Goudfrooij

DQICORR  PERFORM
DQITAB   oref$h1v11475o_bpx.fits
DQITAB   PEDIGREE=GROUND
DQITAB   DESCRIP =Prel. Ground Calib
DQICORR  COMPLETE

ATODCORR OMIT

BLEVCORR PERFORM
         Bias level from overscan has been subtracted; \
         mean of bias levels subtracted was 1451.76.
BLEVCORR COMPLETE
         Uncertainty array initialized, readnoise=6.24, gain=1

BIASCORR PERFORM
BIASFILE oref$09k14502o_bia.fits
BIASFILE PEDIGREE=INFLIGHT 18/08/2016 25/08/2016
BIASFILE DESCRIP =Weekly gain=1 bias for STIS CCD data taken after Aug 18 2016-------
BIASCORR COMPLETE

DARKCORR OMIT

FLATCORR OMIT

SHADCORR OMIT

PHOTCORR OMIT
Imset 1  End 15:45:02 UTC

Imset 2  Begin 15:45:02 UTC
Epcfile  od1al4ayj_epc.fits
Warning  EPCTAB `od1al4ayj_epc.fits&#39; not found.

DQICORR  PERFORM
DQICORR  COMPLETE

ATODCORR OMIT

BLEVCORR PERFORM
         Bias level from overscan has been subtracted; \
         mean of bias levels subtracted was 1454.25.
BLEVCORR COMPLETE
         Uncertainty array initialized, readnoise=6.24, gain=1

BIASCORR PERFORM
BIASCORR COMPLETE

DARKCORR OMIT

FLATCORR OMIT

SHADCORR OMIT
Imset 2  End 15:45:02 UTC

End      05-Sep-2025 15:45:02 UTC

*** CALSTIS-1 complete ***

*** CALSTIS-2 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:02 UTC
Input    stis_ex/stis_shifted/od1al4040_blv_tmp.fits
Output   stis_ex/stis_shifted/od1al4040_crj_tmp.fits

CRCORR   PERFORM
Total number of input image sets = 2
CRREJTAB oref$j3m1403io_crr.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CRCORR   COMPLETE

End      05-Sep-2025 15:45:02 UTC

*** CALSTIS-2 complete ***

*** CALSTIS-1 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:02 UTC
Input    stis_ex/stis_shifted/od1al4040_crj_tmp.fits
Output   stis_ex/stis_shifted/od1al4040_crj.fits
OBSMODE  ACCUM
APERTURE 52X2
OPT_ELEM G430L
DETECTOR CCD

Imset 1  Begin 15:45:02 UTC

CCDTAB   oref$16j1600do_ccd.fits
CCDTAB   PEDIGREE=INFLIGHT 01/05/2009 01/05/2009
CCDTAB   DESCRIP =Updated amp=D gain=4 atodgain and corresponding readnoise values---
CCDTAB   DESCRIP =Proposal 8057, by I. Dashevsky &amp; P. Goudfrooij

DQICORR  OMIT

ATODCORR OMIT

BLEVCORR OMIT

BIASCORR OMIT

DARKCORR PERFORM
DARKFILE oref$09k14506o_drk.fits
DARKFILE PEDIGREE=INFLIGHT 18/08/2016 25/08/2016
DARKFILE DESCRIP =Weekly gain=1 dark for STIS CCD data taken after Aug 18 2016-------
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DARKCORR COMPLETE

FLATCORR PERFORM
PFLTFILE oref$x6417094o_pfl.fits
PFLTFILE PEDIGREE=INFLIGHT 24/10/2011 24/06/2012
PFLTFILE DESCRIP =REVISED ON-ORBIT STIS SPECTROSCOPIC CCD P-FLAT FOR L-MODES---------
LFLTFILE oref$pcc2026jo_lfl.fits
LFLTFILE PEDIGREE=INFLIGHT 27/05/1997 03/08/2004
LFLTFILE DESCRIP =CCD G430L Low-Order Flat
FLATCORR COMPLETE

SHADCORR OMIT

PHOTCORR OMIT

STATFLAG PERFORM
STATFLAG COMPLETE
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Imset 1  End 15:45:02 UTC

End      05-Sep-2025 15:45:02 UTC

*** CALSTIS-1 complete ***

*** CALSTIS-1 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:02 UTC
Input    stis_ex/stis_shifted/od1al4040_blv_tmp.fits
Output   stis_ex/stis_shifted/od1al4040_flt.fits
OBSMODE  ACCUM
APERTURE 52X2
OPT_ELEM G430L
DETECTOR CCD

Imset 1  Begin 15:45:02 UTC
Epcfile  od1al4axj_epc.fits
Warning  EPCTAB `od1al4axj_epc.fits&#39; not found.

CCDTAB   oref$16j1600do_ccd.fits
CCDTAB   PEDIGREE=INFLIGHT 01/05/2009 01/05/2009
CCDTAB   DESCRIP =Updated amp=D gain=4 atodgain and corresponding readnoise values---
CCDTAB   DESCRIP =Proposal 8057, by I. Dashevsky &amp; P. Goudfrooij

DQICORR  OMIT

ATODCORR OMIT

BLEVCORR OMIT

BIASCORR OMIT

DARKCORR PERFORM
DARKFILE oref$09k14506o_drk.fits
DARKFILE PEDIGREE=INFLIGHT 18/08/2016 25/08/2016
DARKFILE DESCRIP =Weekly gain=1 dark for STIS CCD data taken after Aug 18 2016-------
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DARKCORR COMPLETE

FLATCORR PERFORM
PFLTFILE oref$x6417094o_pfl.fits
PFLTFILE PEDIGREE=INFLIGHT 24/10/2011 24/06/2012
PFLTFILE DESCRIP =REVISED ON-ORBIT STIS SPECTROSCOPIC CCD P-FLAT FOR L-MODES---------
LFLTFILE oref$pcc2026jo_lfl.fits
LFLTFILE PEDIGREE=INFLIGHT 27/05/1997 03/08/2004
LFLTFILE DESCRIP =CCD G430L Low-Order Flat
FLATCORR COMPLETE

SHADCORR OMIT

PHOTCORR OMIT

STATFLAG PERFORM
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>STATFLAG COMPLETE
Imset 1  End 15:45:02 UTC

Imset 2  Begin 15:45:02 UTC
Epcfile  od1al4ayj_epc.fits
Warning  EPCTAB `od1al4ayj_epc.fits&#39; not found.

DQICORR  OMIT

ATODCORR OMIT

BLEVCORR OMIT

BIASCORR OMIT

DARKCORR PERFORM
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DARKCORR COMPLETE

FLATCORR PERFORM
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>FLATCORR COMPLETE

SHADCORR OMIT

STATFLAG PERFORM
STATFLAG COMPLETE
Imset 2  End 15:45:03 UTC

End      05-Sep-2025 15:45:03 UTC

*** CALSTIS-1 complete ***

*** CALSTIS-7 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:03 UTC
Input    stis_ex/stis_shifted/od1al4040_crj.fits
Output   stis_ex/stis_shifted/od1al4040_sx2.fits
OBSMODE  ACCUM
APERTURE 52X2E1
OPT_ELEM G430L
DETECTOR CCD
Imset 1  Begin 15:45:03 UTC
Warning  Wavecal processing has not been performed.

HELCORR  PERFORM
HELCORR  COMPLETE

Order 1  Begin 15:45:03 UTC

X2DCORR  PERFORM
DISPCORR PERFORM
APDESTAB oref$16j16005o_apd.fits
APDESTAB PEDIGREE=INFLIGHT 01/03/1997 13/06/2017
APDESTAB DESCRIP =Aligned long-slit bar positions for single-bar cases.--------------
APDESTAB DESCRIP =Offset relative to row 900
SDCTAB   oref$16j16006o_sdc.fits
SDCTAB   PEDIGREE=INFLIGHT 27/05/1997 13/06/2017
SDCTAB   DESCRIP =Co-aligned fiducial bars via an update to the CDELT2 plate scales.-
SDCTAB   DESCRIP =CDELT2 updated with inflight data, others Lindler/prelaunch
DISPTAB  oref$l2j0137to_dsp.fits
DISPTAB  PEDIGREE=INFLIGHT 27/02/1997 24/11/1999
DISPTAB  DESCRIP =Lindler, May 2000
DISPTAB  DESCRIP =Lindler Postlaunch, May 2000
INANGTAB oref$h5s11397o_iac.fits
INANGTAB PEDIGREE=GROUND
INANGTAB DESCRIP =Model/C. Bowers May 6, 1997
INANGTAB DESCRIP =Model/C. Bowers
SPTRCTAB oref$qa31608go_1dt.fits
SPTRCTAB PEDIGREE=INFLIGHT 13/02/1998
SPTRCTAB DESCRIP =New traces to account for angle change with time
SPTRCTAB DESCRIP =Lindler/Bohlin/Dressel/Holfeltz postlaunch calibration

FLUXCORR PERFORM
PHOTTAB  oref$95118575o_pht.fits
PHOTTAB  PEDIGREE=INFLIGHT 27/02/1997 14/04/1998
PHOTTAB  DESCRIP =Fullerton 2025 calibration
PHOTTAB  DESCRIP =Updated Sensitivities 2022
APERTAB  oref$y2r1559to_apt.fits
APERTAB  PEDIGREE=MODEL
APERTAB  DESCRIP =Added/updated values for 31X0.05NDA,31X0.05NDB,31X0.05NDC apertures
APERTAB  DESCRIP =Bohlin/Hartig TIM Models Nov. 1998
PCTAB    oref$q541740no_pct.fits
PCTAB    PEDIGREE=INFLIGHT 18/5/1997 19/12/1998
PCTAB    DESCRIP =Sensitivity for diff. extractions heights
PCTAB    DESCRIP =12 STIS observations averaged
TDSTAB   oref$8712049eo_tds.fits
TDSTAB   PEDIGREE=INFLIGHT 01/04/1997 06/03/2024
TDSTAB   DESCRIP =Updated time sensitivities for MIRVIS, G230LB, and G230MB
FLUXCORR COMPLETE
X2DCORR  COMPLETE
DISPCORR COMPLETE
Order 1  End 15:45:03 UTC
Imset 1  End 15:45:03 UTC

End      05-Sep-2025 15:45:03 UTC

*** CALSTIS-7 complete ***

*** CALSTIS-6 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:03 UTC

INFO     &#39;E1&#39; has been appended to aperture
Input    stis_ex/stis_shifted/od1al4040_crj.fits
Output   stis_ex/stis_shifted/od1al4040_sx1.fits
Rootname od1al4040
OBSMODE  ACCUM
APERTURE 52X2E1
OPT_ELEM G430L
DETECTOR CCD

XTRACTAB oref$n7p1031qo_1dx.fits
XTRACTAB PEDIGREE=INFLIGHT 18/05/97
XTRACTAB DESCRIP =Analysis from prop. 7094
XTRACTAB DESCRIP =Analysis from prop. 7094
SPTRCTAB oref$qa31608go_1dt.fits
SPTRCTAB PEDIGREE=INFLIGHT 02/09/1997 13/02/1998
SPTRCTAB DESCRIP =New traces to account for angle change with time

Imset 1  Begin 15:45:03 UTC
         Input read into memory.
Order 1  Begin 15:45:03 UTC
X1DCORR  PERFORM
BACKCORR PERFORM
******** Calling Slfit ***********BACKCORR COMPLETE
X1DCORR  COMPLETE
         Spectrum extracted at y position = 892.751

DISPCORR PERFORM
DISPTAB  oref$l2j0137to_dsp.fits
DISPTAB  PEDIGREE=INFLIGHT 27/02/1997 24/11/1999
DISPTAB  DESCRIP =Lindler, May 2000
DISPTAB  DESCRIP =Lindler Postlaunch, May 2000
APDESTAB oref$16j16005o_apd.fits
APDESTAB PEDIGREE=INFLIGHT 01/03/1997 13/06/2017
APDESTAB DESCRIP =Aligned long-slit bar positions for single-bar cases.--------------
APDESTAB DESCRIP =Offset relative to row 900
INANGTAB oref$h5s11397o_iac.fits
INANGTAB DESCRIP =Model/C. Bowers May 6, 1997
DISPCORR COMPLETE

HELCORR  PERFORM
HELCORR  COMPLETE

PHOTTAB  oref$95118575o_pht.fits
PHOTTAB  PEDIGREE=INFLIGHT 27/02/1997 16/03/2021
PHOTTAB  DESCRIP =Fullerton 2025 calibration
APERTAB  oref$y2r1559to_apt.fits
APERTAB  PEDIGREE=MODEL
APERTAB  DESCRIP =Added/updated values for 31X0.05NDA,31X0.05NDB,31X0.05NDC apertures
APERTAB  DESCRIP =Bohlin/Hartig TIM Models Nov. 1998
GACTAB   oref$p9r19203o_gac.fits
GACTAB   PEDIGREE=INFLIGHT 03/04/2002 03/08/2004
GACTAB   DESCRIP =X1D flux corr for grating/aper combos
GACTAB   DESCRIP =Grating-Aperture Throughput Correction
PCTAB    oref$q541740no_pct.fits
PCTAB    PEDIGREE=INFLIGHT 18/05/1997 19/12/1998
PCTAB    DESCRIP =Sensitivity for diff. extractions heights
TDSTAB   oref$8712049eo_tds.fits
TDSTAB   PEDIGREE=INFLIGHT 01/04/1997 06/03/2024
TDSTAB   DESCRIP =Updated time sensitivities for MIRVIS, G230LB, and G230MB
FLUXCORR PERFORM
CTECORR  PERFORM
CCDTAB   oref$16j1600do_ccd.fits
CCDTAB   PEDIGREE=INFLIGHT 01/05/2009 01/05/2009
CCDTAB   DESCRIP =Updated amp=D gain=4 atodgain and corresponding readnoise values---
CCDTAB   DESCRIP =Proposal 8057, by I. Dashevsky &amp; P. Goudfrooij
         GACTAB correction applied for G430L 52X2E1 4300
CTECORR  COMPLETE
FLUXCORR COMPLETE
SGEOCORR OMIT

         Row 1 written to disk.
Order 1  End 15:45:03 UTC

         trace was rotated by = 0.0524527 degree.
Imset 1  End 15:45:03 UTC

Warning  Keyword `XTRACALG&#39; is being added to header.
End      05-Sep-2025 15:45:03 UTC

*** CALSTIS-6 complete ***

End      05-Sep-2025 15:45:03 UTC

*** CALSTIS-0 complete ***
</pre></div>
</div>
</div>
</div>
<p>And finally, <code class="docutils literal notranslate"><span class="pre">od1al1040_sx1.fits</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">width</span> <span class="o">=</span> <span class="mi">7</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">shift_stis</span><span class="p">(</span><span class="n">ref_file</span><span class="p">,</span> <span class="n">e1_pos</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">run_calstis</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;An error occured&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dispersion per pixel is 2.75 Å/pixel
The shift, in pixels, is 0.49 pixels
The shift, in Å, is 1.34Å
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>*** CALSTIS-0 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:03 UTC

Input    stis_ex/stis_data/od1am10e0_raw.fits
Outroot  stis_ex/stis_shifted/od1am10e0_raw.fits

*** CALSTIS-1 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:03 UTC
Input    stis_ex/stis_data/od1am10e0_raw.fits
Output   stis_ex/stis_shifted/od1am10e0_blv_tmp.fits
OBSMODE  ACCUM
APERTURE 52X2
OPT_ELEM G430L
DETECTOR CCD

Imset 1  Begin 15:45:03 UTC
Epcfile  od1am1hnj_epc.fits
Warning  EPCTAB `od1am1hnj_epc.fits&#39; not found.

CCDTAB   oref$16j1600do_ccd.fits
CCDTAB   PEDIGREE=INFLIGHT 01/05/2009 01/05/2009
CCDTAB   DESCRIP =Updated amp=D gain=4 atodgain and corresponding readnoise values---
CCDTAB   DESCRIP =Proposal 8057, by I. Dashevsky &amp; P. Goudfrooij

DQICORR  PERFORM
DQITAB   oref$h1v11475o_bpx.fits
DQITAB   PEDIGREE=GROUND
DQITAB   DESCRIP =Prel. Ground Calib
DQICORR  COMPLETE

ATODCORR OMIT

BLEVCORR PERFORM
         Bias level from overscan has been subtracted; \
         mean of bias levels subtracted was 1434.75.
BLEVCORR COMPLETE
         Uncertainty array initialized, readnoise=6.24, gain=1

BIASCORR PERFORM
BIASFILE oref$0531402qo_bia.fits
BIASFILE PEDIGREE=INFLIGHT 22/02/2016 01/03/2016
BIASFILE DESCRIP =Weekly gain=1 bias for STIS CCD data taken after Feb 22 2016-------
BIASCORR COMPLETE

DARKCORR OMIT

FLATCORR OMIT

SHADCORR OMIT

PHOTCORR OMIT
Imset 1  End 15:45:03 UTC

Imset 2  Begin 15:45:03 UTC
Epcfile  od1am1hoj_epc.fits
Warning  EPCTAB `od1am1hoj_epc.fits&#39; not found.

DQICORR  PERFORM
DQICORR  COMPLETE

ATODCORR OMIT

BLEVCORR PERFORM
         Bias level from overscan has been subtracted; \
         mean of bias levels subtracted was 1434.94.
BLEVCORR COMPLETE
         Uncertainty array initialized, readnoise=6.24, gain=1

BIASCORR PERFORM
BIASCORR COMPLETE

DARKCORR OMIT

FLATCORR OMIT

SHADCORR OMIT
Imset 2  End 15:45:03 UTC

End      05-Sep-2025 15:45:03 UTC

*** CALSTIS-1 complete ***

*** CALSTIS-2 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:03 UTC
Input    stis_ex/stis_shifted/od1am10e0_blv_tmp.fits
Output   stis_ex/stis_shifted/od1am10e0_crj_tmp.fits

CRCORR   PERFORM
Total number of input image sets = 2
CRREJTAB oref$j3m1403io_crr.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CRCORR   COMPLETE

End      05-Sep-2025 15:45:03 UTC

*** CALSTIS-2 complete ***

*** CALSTIS-1 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:03 UTC
Input    stis_ex/stis_shifted/od1am10e0_crj_tmp.fits
Output   stis_ex/stis_shifted/od1am10e0_crj.fits
OBSMODE  ACCUM
APERTURE 52X2
OPT_ELEM G430L
DETECTOR CCD

Imset 1  Begin 15:45:03 UTC

CCDTAB   oref$16j1600do_ccd.fits
CCDTAB   PEDIGREE=INFLIGHT 01/05/2009 01/05/2009
CCDTAB   DESCRIP =Updated amp=D gain=4 atodgain and corresponding readnoise values---
CCDTAB   DESCRIP =Proposal 8057, by I. Dashevsky &amp; P. Goudfrooij

DQICORR  OMIT

ATODCORR OMIT

BLEVCORR OMIT

BIASCORR OMIT

DARKCORR PERFORM
DARKFILE oref$05314034o_drk.fits
DARKFILE PEDIGREE=INFLIGHT 22/02/2016 01/03/2016
DARKFILE DESCRIP =Weekly gain=1 dark for STIS CCD data taken after Feb 22 2016-------
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DARKCORR COMPLETE

FLATCORR PERFORM
PFLTFILE oref$x6417094o_pfl.fits
PFLTFILE PEDIGREE=INFLIGHT 24/10/2011 24/06/2012
PFLTFILE DESCRIP =REVISED ON-ORBIT STIS SPECTROSCOPIC CCD P-FLAT FOR L-MODES---------
LFLTFILE oref$pcc2026jo_lfl.fits
LFLTFILE PEDIGREE=INFLIGHT 27/05/1997 03/08/2004
LFLTFILE DESCRIP =CCD G430L Low-Order Flat
FLATCORR COMPLETE

SHADCORR OMIT

PHOTCORR OMIT

STATFLAG PERFORM
STATFLAG COMPLETE
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Imset 1  End 15:45:03 UTC

End      05-Sep-2025 15:45:03 UTC

*** CALSTIS-1 complete ***

*** CALSTIS-1 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:03 UTC
Input    stis_ex/stis_shifted/od1am10e0_blv_tmp.fits
Output   stis_ex/stis_shifted/od1am10e0_flt.fits
OBSMODE  ACCUM
APERTURE 52X2
OPT_ELEM G430L
DETECTOR CCD

Imset 1  Begin 15:45:03 UTC
Epcfile  od1am1hnj_epc.fits
Warning  EPCTAB `od1am1hnj_epc.fits&#39; not found.

CCDTAB   oref$16j1600do_ccd.fits
CCDTAB   PEDIGREE=INFLIGHT 01/05/2009 01/05/2009
CCDTAB   DESCRIP =Updated amp=D gain=4 atodgain and corresponding readnoise values---
CCDTAB   DESCRIP =Proposal 8057, by I. Dashevsky &amp; P. Goudfrooij

DQICORR  OMIT

ATODCORR OMIT

BLEVCORR OMIT

BIASCORR OMIT

DARKCORR PERFORM
DARKFILE oref$05314034o_drk.fits
DARKFILE PEDIGREE=INFLIGHT 22/02/2016 01/03/2016
DARKFILE DESCRIP =Weekly gain=1 dark for STIS CCD data taken after Feb 22 2016-------
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DARKCORR COMPLETE

FLATCORR PERFORM
PFLTFILE oref$x6417094o_pfl.fits
PFLTFILE PEDIGREE=INFLIGHT 24/10/2011 24/06/2012
PFLTFILE DESCRIP =REVISED ON-ORBIT STIS SPECTROSCOPIC CCD P-FLAT FOR L-MODES---------
LFLTFILE oref$pcc2026jo_lfl.fits
LFLTFILE PEDIGREE=INFLIGHT 27/05/1997 03/08/2004
LFLTFILE DESCRIP =CCD G430L Low-Order Flat
FLATCORR COMPLETE

SHADCORR OMIT

PHOTCORR OMIT

STATFLAG PERFORM
STATFLAG COMPLETE
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Imset 1  End 15:45:03 UTC

Imset 2  Begin 15:45:03 UTC
Epcfile  od1am1hoj_epc.fits
Warning  EPCTAB `od1am1hoj_epc.fits&#39; not found.

DQICORR  OMIT

ATODCORR OMIT

BLEVCORR OMIT

BIASCORR OMIT

DARKCORR PERFORM
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DARKCORR COMPLETE

FLATCORR PERFORM
FLATCORR COMPLETE

SHADCORR OMIT

STATFLAG PERFORM
STATFLAG COMPLETE
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Imset 2  End 15:45:04 UTC

End      05-Sep-2025 15:45:04 UTC

*** CALSTIS-1 complete ***

*** CALSTIS-7 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:04 UTC
Input    stis_ex/stis_shifted/od1am10e0_crj.fits
Output   stis_ex/stis_shifted/od1am10e0_sx2.fits
OBSMODE  ACCUM
APERTURE 52X2E1
OPT_ELEM G430L
DETECTOR CCD
Imset 1  Begin 15:45:04 UTC
Warning  Wavecal processing has not been performed.

HELCORR  PERFORM
HELCORR  COMPLETE

Order 1  Begin 15:45:04 UTC

X2DCORR  PERFORM
DISPCORR PERFORM
APDESTAB oref$16j16005o_apd.fits
APDESTAB PEDIGREE=INFLIGHT 01/03/1997 13/06/2017
APDESTAB DESCRIP =Aligned long-slit bar positions for single-bar cases.--------------
APDESTAB DESCRIP =Offset relative to row 900
SDCTAB   oref$16j16006o_sdc.fits
SDCTAB   PEDIGREE=INFLIGHT 27/05/1997 13/06/2017
SDCTAB   DESCRIP =Co-aligned fiducial bars via an update to the CDELT2 plate scales.-
SDCTAB   DESCRIP =CDELT2 updated with inflight data, others Lindler/prelaunch
DISPTAB  oref$l2j0137to_dsp.fits
DISPTAB  PEDIGREE=INFLIGHT 27/02/1997 24/11/1999
DISPTAB  DESCRIP =Lindler, May 2000
DISPTAB  DESCRIP =Lindler Postlaunch, May 2000
INANGTAB oref$h5s11397o_iac.fits
INANGTAB PEDIGREE=GROUND
INANGTAB DESCRIP =Model/C. Bowers May 6, 1997
INANGTAB DESCRIP =Model/C. Bowers
SPTRCTAB oref$qa31608go_1dt.fits
SPTRCTAB PEDIGREE=INFLIGHT 13/02/1998
SPTRCTAB DESCRIP =New traces to account for angle change with time
SPTRCTAB DESCRIP =Lindler/Bohlin/Dressel/Holfeltz postlaunch calibration

FLUXCORR PERFORM
PHOTTAB  oref$95118575o_pht.fits
PHOTTAB  PEDIGREE=INFLIGHT 27/02/1997 14/04/1998
PHOTTAB  DESCRIP =Fullerton 2025 calibration
PHOTTAB  DESCRIP =Updated Sensitivities 2022
APERTAB  oref$y2r1559to_apt.fits
APERTAB  PEDIGREE=MODEL
APERTAB  DESCRIP =Added/updated values for 31X0.05NDA,31X0.05NDB,31X0.05NDC apertures
APERTAB  DESCRIP =Bohlin/Hartig TIM Models Nov. 1998
PCTAB    oref$q541740no_pct.fits
PCTAB    PEDIGREE=INFLIGHT 18/5/1997 19/12/1998
PCTAB    DESCRIP =Sensitivity for diff. extractions heights
PCTAB    DESCRIP =12 STIS observations averaged
TDSTAB   oref$8712049eo_tds.fits
TDSTAB   PEDIGREE=INFLIGHT 01/04/1997 06/03/2024
TDSTAB   DESCRIP =Updated time sensitivities for MIRVIS, G230LB, and G230MB
FLUXCORR COMPLETE
X2DCORR  COMPLETE
DISPCORR COMPLETE
Order 1  End 15:45:04 UTC
Imset 1  End 15:45:04 UTC

End      05-Sep-2025 15:45:04 UTC

*** CALSTIS-7 complete ***

*** CALSTIS-6 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:04 UTC

INFO     &#39;E1&#39; has been appended to aperture
Input    stis_ex/stis_shifted/od1am10e0_crj.fits
Output   stis_ex/stis_shifted/od1am10e0_sx1.fits
Rootname od1am10e0
OBSMODE  ACCUM
APERTURE 52X2E1
OPT_ELEM G430L
DETECTOR CCD

XTRACTAB oref$n7p1031qo_1dx.fits
XTRACTAB PEDIGREE=INFLIGHT 18/05/97
XTRACTAB DESCRIP =Analysis from prop. 7094
XTRACTAB DESCRIP =Analysis from prop. 7094
SPTRCTAB oref$qa31608go_1dt.fits
SPTRCTAB PEDIGREE=INFLIGHT 02/09/1997 13/02/1998
SPTRCTAB DESCRIP =New traces to account for angle change with time

Imset 1  Begin 15:45:04 UTC
         Input read into memory.
Order 1  Begin 15:45:04 UTC
X1DCORR  PERFORM
BACKCORR PERFORM
******** Calling Slfit ***********BACKCORR COMPLETE
X1DCORR  COMPLETE
         Spectrum extracted at y position = 892.867

DISPCORR PERFORM
DISPTAB  oref$l2j0137to_dsp.fits
DISPTAB  PEDIGREE=INFLIGHT 27/02/1997 24/11/1999
DISPTAB  DESCRIP =Lindler, May 2000
DISPTAB  DESCRIP =Lindler Postlaunch, May 2000
APDESTAB oref$16j16005o_apd.fits
APDESTAB PEDIGREE=INFLIGHT 01/03/1997 13/06/2017
APDESTAB DESCRIP =Aligned long-slit bar positions for single-bar cases.--------------
APDESTAB DESCRIP =Offset relative to row 900
INANGTAB oref$h5s11397o_iac.fits
INANGTAB DESCRIP =Model/C. Bowers May 6, 1997
DISPCORR COMPLETE

HELCORR  PERFORM
HELCORR  COMPLETE

PHOTTAB  oref$95118575o_pht.fits
PHOTTAB  PEDIGREE=INFLIGHT 27/02/1997 16/03/2021
PHOTTAB  DESCRIP =Fullerton 2025 calibration
APERTAB  oref$y2r1559to_apt.fits
APERTAB  PEDIGREE=MODEL
APERTAB  DESCRIP =Added/updated values for 31X0.05NDA,31X0.05NDB,31X0.05NDC apertures
APERTAB  DESCRIP =Bohlin/Hartig TIM Models Nov. 1998
GACTAB   oref$p9r19203o_gac.fits
GACTAB   PEDIGREE=INFLIGHT 03/04/2002 03/08/2004
GACTAB   DESCRIP =X1D flux corr for grating/aper combos
GACTAB   DESCRIP =Grating-Aperture Throughput Correction
PCTAB    oref$q541740no_pct.fits
PCTAB    PEDIGREE=INFLIGHT 18/05/1997 19/12/1998
PCTAB    DESCRIP =Sensitivity for diff. extractions heights
TDSTAB   oref$8712049eo_tds.fits
TDSTAB   PEDIGREE=INFLIGHT 01/04/1997 06/03/2024
TDSTAB   DESCRIP =Updated time sensitivities for MIRVIS, G230LB, and G230MB
FLUXCORR PERFORM
CTECORR  PERFORM
CCDTAB   oref$16j1600do_ccd.fits
CCDTAB   PEDIGREE=INFLIGHT 01/05/2009 01/05/2009
CCDTAB   DESCRIP =Updated amp=D gain=4 atodgain and corresponding readnoise values---
CCDTAB   DESCRIP =Proposal 8057, by I. Dashevsky &amp; P. Goudfrooij
         GACTAB correction applied for G430L 52X2E1 4300
CTECORR  COMPLETE
FLUXCORR COMPLETE
SGEOCORR OMIT

         Row 1 written to disk.
Order 1  End 15:45:04 UTC

         trace was rotated by = 0.050452 degree.
Imset 1  End 15:45:04 UTC

Warning  Keyword `XTRACALG&#39; is being added to header.
End      05-Sep-2025 15:45:04 UTC

*** CALSTIS-6 complete ***

End      05-Sep-2025 15:45:04 UTC

*** CALSTIS-0 complete ***
</pre></div>
</div>
</div>
</div>
<p>A file taken in the nominal position, <code class="docutils literal notranslate"><span class="pre">od1am10b0</span></code> is also shifted, so we will fix that too:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">width</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">filepath</span> <span class="o">=</span> <span class="n">stis_unshifted</span> <span class="o">/</span> <span class="s2">&quot;od1am10b0_sx1.fits&quot;</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">shift_stis</span><span class="p">(</span><span class="n">ref_file</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">run_calstis</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;An error occured&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dispersion per pixel is 2.75 Å/pixel
The shift, in pixels, is -0.49 pixels
The shift, in Å, is -1.35Å
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>*** CALSTIS-0 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:04 UTC

Input    stis_ex/stis_data/od1am10b0_raw.fits
Outroot  stis_ex/stis_shifted/od1am10b0_raw.fits

*** CALSTIS-1 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:04 UTC
Input    stis_ex/stis_data/od1am10b0_raw.fits
Output   stis_ex/stis_shifted/od1am10b0_blv_tmp.fits
OBSMODE  ACCUM
APERTURE 52X2
OPT_ELEM G430L
DETECTOR CCD

Imset 1  Begin 15:45:04 UTC
Epcfile  od1am1hgj_epc.fits
Warning  EPCTAB `od1am1hgj_epc.fits&#39; not found.

CCDTAB   oref$16j1600do_ccd.fits
CCDTAB   PEDIGREE=INFLIGHT 01/05/2009 01/05/2009
CCDTAB   DESCRIP =Updated amp=D gain=4 atodgain and corresponding readnoise values---
CCDTAB   DESCRIP =Proposal 8057, by I. Dashevsky &amp; P. Goudfrooij

DQICORR  PERFORM
DQITAB   oref$h1v11475o_bpx.fits
DQITAB   PEDIGREE=GROUND
DQITAB   DESCRIP =Prel. Ground Calib
DQICORR  COMPLETE

ATODCORR OMIT

BLEVCORR PERFORM
         Bias level from overscan has been subtracted; \
         mean of bias levels subtracted was 1434.32.
BLEVCORR COMPLETE
         Uncertainty array initialized, readnoise=6.24, gain=1

BIASCORR PERFORM
BIASFILE oref$0531402qo_bia.fits
BIASFILE PEDIGREE=INFLIGHT 22/02/2016 01/03/2016
BIASFILE DESCRIP =Weekly gain=1 bias for STIS CCD data taken after Feb 22 2016-------
BIASCORR COMPLETE

DARKCORR OMIT

FLATCORR OMIT

SHADCORR OMIT

PHOTCORR OMIT
Imset 1  End 15:45:04 UTC

Imset 2  Begin 15:45:04 UTC
Epcfile  od1am1hhj_epc.fits
Warning  EPCTAB `od1am1hhj_epc.fits&#39; not found.

DQICORR  PERFORM
DQICORR  COMPLETE

ATODCORR OMIT

BLEVCORR PERFORM
         Bias level from overscan has been subtracted; \
         mean of bias levels subtracted was 1435.35.
BLEVCORR COMPLETE
         Uncertainty array initialized, readnoise=6.24, gain=1

BIASCORR PERFORM
BIASCORR COMPLETE

DARKCORR OMIT

FLATCORR OMIT

SHADCORR OMIT
Imset 2  End 15:45:04 UTC

End      05-Sep-2025 15:45:04 UTC

*** CALSTIS-1 complete ***

*** CALSTIS-2 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:04 UTC
Input    stis_ex/stis_shifted/od1am10b0_blv_tmp.fits
Output   stis_ex/stis_shifted/od1am10b0_crj_tmp.fits

CRCORR   PERFORM
Total number of input image sets = 2
CRREJTAB oref$j3m1403io_crr.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CRCORR   COMPLETE

End      05-Sep-2025 15:45:04 UTC

*** CALSTIS-2 complete ***

*** CALSTIS-1 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:04 UTC
Input    stis_ex/stis_shifted/od1am10b0_crj_tmp.fits
Output   stis_ex/stis_shifted/od1am10b0_crj.fits
OBSMODE  ACCUM
APERTURE 52X2
OPT_ELEM G430L
DETECTOR CCD

Imset 1  Begin 15:45:04 UTC

CCDTAB   oref$16j1600do_ccd.fits
CCDTAB   PEDIGREE=INFLIGHT 01/05/2009 01/05/2009
CCDTAB   DESCRIP =Updated amp=D gain=4 atodgain and corresponding readnoise values---
CCDTAB   DESCRIP =Proposal 8057, by I. Dashevsky &amp; P. Goudfrooij

DQICORR  OMIT

ATODCORR OMIT

BLEVCORR OMIT

BIASCORR OMIT

DARKCORR PERFORM
DARKFILE oref$05314034o_drk.fits
DARKFILE PEDIGREE=INFLIGHT 22/02/2016 01/03/2016
DARKFILE DESCRIP =Weekly gain=1 dark for STIS CCD data taken after Feb 22 2016-------
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DARKCORR COMPLETE

FLATCORR PERFORM
PFLTFILE oref$x6417094o_pfl.fits
PFLTFILE PEDIGREE=INFLIGHT 24/10/2011 24/06/2012
PFLTFILE DESCRIP =REVISED ON-ORBIT STIS SPECTROSCOPIC CCD P-FLAT FOR L-MODES---------
LFLTFILE oref$pcc2026jo_lfl.fits
LFLTFILE PEDIGREE=INFLIGHT 27/05/1997 03/08/2004
LFLTFILE DESCRIP =CCD G430L Low-Order Flat
FLATCORR COMPLETE

SHADCORR OMIT

PHOTCORR OMIT

STATFLAG PERFORM
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>STATFLAG COMPLETE
Imset 1  End 15:45:04 UTC

End      05-Sep-2025 15:45:04 UTC

*** CALSTIS-1 complete ***

*** CALSTIS-1 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:04 UTC
Input    stis_ex/stis_shifted/od1am10b0_blv_tmp.fits
Output   stis_ex/stis_shifted/od1am10b0_flt.fits
OBSMODE  ACCUM
APERTURE 52X2
OPT_ELEM G430L
DETECTOR CCD

Imset 1  Begin 15:45:04 UTC
Epcfile  od1am1hgj_epc.fits
Warning  EPCTAB `od1am1hgj_epc.fits&#39; not found.

CCDTAB   oref$16j1600do_ccd.fits
CCDTAB   PEDIGREE=INFLIGHT 01/05/2009 01/05/2009
CCDTAB   DESCRIP =Updated amp=D gain=4 atodgain and corresponding readnoise values---
CCDTAB   DESCRIP =Proposal 8057, by I. Dashevsky &amp; P. Goudfrooij

DQICORR  OMIT

ATODCORR OMIT

BLEVCORR OMIT

BIASCORR OMIT

DARKCORR PERFORM
DARKFILE oref$05314034o_drk.fits
DARKFILE PEDIGREE=INFLIGHT 22/02/2016 01/03/2016
DARKFILE DESCRIP =Weekly gain=1 dark for STIS CCD data taken after Feb 22 2016-------
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DARKCORR COMPLETE

FLATCORR PERFORM
PFLTFILE oref$x6417094o_pfl.fits
PFLTFILE PEDIGREE=INFLIGHT 24/10/2011 24/06/2012
PFLTFILE DESCRIP =REVISED ON-ORBIT STIS SPECTROSCOPIC CCD P-FLAT FOR L-MODES---------
LFLTFILE oref$pcc2026jo_lfl.fits
LFLTFILE PEDIGREE=INFLIGHT 27/05/1997 03/08/2004
LFLTFILE DESCRIP =CCD G430L Low-Order Flat
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>FLATCORR COMPLETE

SHADCORR OMIT

PHOTCORR OMIT

STATFLAG PERFORM
STATFLAG COMPLETE
Imset 1  End 15:45:04 UTC

Imset 2  Begin 15:45:04 UTC
Epcfile  od1am1hhj_epc.fits
Warning  EPCTAB `od1am1hhj_epc.fits&#39; not found.

DQICORR  OMIT

ATODCORR OMIT

BLEVCORR OMIT

BIASCORR OMIT

DARKCORR PERFORM
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DARKCORR COMPLETE

FLATCORR PERFORM
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>FLATCORR COMPLETE

SHADCORR OMIT

STATFLAG PERFORM
STATFLAG COMPLETE
Imset 2  End 15:45:05 UTC

End      05-Sep-2025 15:45:05 UTC

*** CALSTIS-1 complete ***

*** CALSTIS-7 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:05 UTC
Input    stis_ex/stis_shifted/od1am10b0_crj.fits
Output   stis_ex/stis_shifted/od1am10b0_sx2.fits
OBSMODE  ACCUM
APERTURE 52X2
OPT_ELEM G430L
DETECTOR CCD
Imset 1  Begin 15:45:05 UTC
Warning  Wavecal processing has not been performed.

HELCORR  PERFORM
HELCORR  COMPLETE

Order 1  Begin 15:45:05 UTC

X2DCORR  PERFORM
DISPCORR PERFORM
APDESTAB oref$16j16005o_apd.fits
APDESTAB PEDIGREE=INFLIGHT 01/03/1997 13/06/2017
APDESTAB DESCRIP =Aligned long-slit bar positions for single-bar cases.--------------
APDESTAB DESCRIP =Microscope Meas./Hartig Post-launch Offsets
SDCTAB   oref$16j16006o_sdc.fits
SDCTAB   PEDIGREE=INFLIGHT 27/05/1997 13/06/2017
SDCTAB   DESCRIP =Co-aligned fiducial bars via an update to the CDELT2 plate scales.-
SDCTAB   DESCRIP =CDELT2 updated with inflight data, others Lindler/prelaunch
DISPTAB  oref$l2j0137to_dsp.fits
DISPTAB  PEDIGREE=INFLIGHT 27/02/1997 24/11/1999
DISPTAB  DESCRIP =Lindler, May 2000
DISPTAB  DESCRIP =Lindler Postlaunch, May 2000
INANGTAB oref$h5s11397o_iac.fits
INANGTAB PEDIGREE=GROUND
INANGTAB DESCRIP =Model/C. Bowers May 6, 1997
INANGTAB DESCRIP =Model/C. Bowers
SPTRCTAB oref$qa31608go_1dt.fits
SPTRCTAB PEDIGREE=INFLIGHT 13/02/1998
SPTRCTAB DESCRIP =New traces to account for angle change with time
SPTRCTAB DESCRIP =Lindler/Bohlin/Dressel/Holfeltz postlaunch calibration

FLUXCORR PERFORM
PHOTTAB  oref$95118575o_pht.fits
PHOTTAB  PEDIGREE=INFLIGHT 27/02/1997 14/04/1998
PHOTTAB  DESCRIP =Fullerton 2025 calibration
PHOTTAB  DESCRIP =Updated Sensitivities 2022
APERTAB  oref$y2r1559to_apt.fits
APERTAB  PEDIGREE=MODEL
APERTAB  DESCRIP =Added/updated values for 31X0.05NDA,31X0.05NDB,31X0.05NDC apertures
APERTAB  DESCRIP =Bohlin/Hartig TIM Models Nov. 1998
PCTAB    oref$q541740no_pct.fits
PCTAB    PEDIGREE=INFLIGHT 18/5/1997 19/12/1998
PCTAB    DESCRIP =Sensitivity for diff. extractions heights
PCTAB    DESCRIP =12 STIS observations averaged
TDSTAB   oref$8712049eo_tds.fits
TDSTAB   PEDIGREE=INFLIGHT 01/04/1997 06/03/2024
TDSTAB   DESCRIP =Updated time sensitivities for MIRVIS, G230LB, and G230MB
FLUXCORR COMPLETE
X2DCORR  COMPLETE
DISPCORR COMPLETE
Order 1  End 15:45:05 UTC
Imset 1  End 15:45:05 UTC

End      05-Sep-2025 15:45:05 UTC

*** CALSTIS-7 complete ***

*** CALSTIS-6 -- Version 3.4.2 (19-Jan-2018) ***
Begin    05-Sep-2025 15:45:05 UTC

Input    stis_ex/stis_shifted/od1am10b0_crj.fits
Output   stis_ex/stis_shifted/od1am10b0_sx1.fits
Rootname od1am10b0
OBSMODE  ACCUM
APERTURE 52X2
OPT_ELEM G430L
DETECTOR CCD

XTRACTAB oref$n7p1031qo_1dx.fits
XTRACTAB PEDIGREE=INFLIGHT 18/05/97
XTRACTAB DESCRIP =Analysis from prop. 7094
XTRACTAB DESCRIP =Analysis from prop. 7094
SPTRCTAB oref$qa31608go_1dt.fits
SPTRCTAB PEDIGREE=INFLIGHT 02/09/1997 13/02/1998
SPTRCTAB DESCRIP =New traces to account for angle change with time

Imset 1  Begin 15:45:05 UTC
         Input read into memory.
Order 1  Begin 15:45:05 UTC
X1DCORR  PERFORM
BACKCORR PERFORM
******** Calling Slfit ***********BACKCORR COMPLETE
X1DCORR  COMPLETE
         Spectrum extracted at y position = 509.434

DISPCORR PERFORM
DISPTAB  oref$l2j0137to_dsp.fits
DISPTAB  PEDIGREE=INFLIGHT 27/02/1997 24/11/1999
DISPTAB  DESCRIP =Lindler, May 2000
DISPTAB  DESCRIP =Lindler Postlaunch, May 2000
APDESTAB oref$16j16005o_apd.fits
APDESTAB PEDIGREE=INFLIGHT 01/03/1997 13/06/2017
APDESTAB DESCRIP =Aligned long-slit bar positions for single-bar cases.--------------
APDESTAB DESCRIP =Microscope Meas./Hartig Post-launch Offsets
INANGTAB oref$h5s11397o_iac.fits
INANGTAB DESCRIP =Model/C. Bowers May 6, 1997
DISPCORR COMPLETE

HELCORR  PERFORM
HELCORR  COMPLETE

PHOTTAB  oref$95118575o_pht.fits
PHOTTAB  PEDIGREE=INFLIGHT 27/02/1997 16/03/2021
PHOTTAB  DESCRIP =Fullerton 2025 calibration
APERTAB  oref$y2r1559to_apt.fits
APERTAB  PEDIGREE=MODEL
APERTAB  DESCRIP =Added/updated values for 31X0.05NDA,31X0.05NDB,31X0.05NDC apertures
APERTAB  DESCRIP =Bohlin/Hartig TIM Models Nov. 1998
PCTAB    oref$q541740no_pct.fits
PCTAB    PEDIGREE=INFLIGHT 18/05/1997 19/12/1998
PCTAB    DESCRIP =Sensitivity for diff. extractions heights
TDSTAB   oref$8712049eo_tds.fits
TDSTAB   PEDIGREE=INFLIGHT 01/04/1997 06/03/2024
TDSTAB   DESCRIP =Updated time sensitivities for MIRVIS, G230LB, and G230MB
FLUXCORR PERFORM
CTECORR  PERFORM
CCDTAB   oref$16j1600do_ccd.fits
CCDTAB   PEDIGREE=INFLIGHT 01/05/2009 01/05/2009
CCDTAB   DESCRIP =Updated amp=D gain=4 atodgain and corresponding readnoise values---
CCDTAB   DESCRIP =Proposal 8057, by I. Dashevsky &amp; P. Goudfrooij
CTECORR  COMPLETE
FLUXCORR COMPLETE
SGEOCORR OMIT

         Row 1 written to disk.
Order 1  End 15:45:05 UTC

         trace was rotated by = 0.0504519 degree.
Imset 1  End 15:45:05 UTC

Warning  Keyword `XTRACALG&#39; is being added to header.
End      05-Sep-2025 15:45:05 UTC

*** CALSTIS-6 complete ***

End      05-Sep-2025 15:45:05 UTC

*** CALSTIS-0 complete ***
</pre></div>
</div>
</div>
</div>
<p><a id = compare_shifted_stis></a></p>
</section>
</section>
<section id="comparing-non-adjusted-and-adjusted-stis-coadds">
<h2>2.5 Comparing Non-Adjusted and Adjusted STIS Coadds<a class="headerlink" href="#comparing-non-adjusted-and-adjusted-stis-coadds" title="Permalink to this heading">#</a></h2>
<p>Now that we’ve applied the shifts to our data, we will re-run the coadd code. To get a proper comparison, we will need to copy over the files taken at the nominal position to the <code class="docutils literal notranslate"><span class="pre">stis_shifted</span></code> directory since the coadd code needs all <code class="docutils literal notranslate"><span class="pre">X1D</span></code>/<code class="docutils literal notranslate"><span class="pre">SX1</span></code> files in the same directory.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">sx1s</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;od1am10b0_sx1.fits&quot;</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="k">if</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;PROPAPER&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;52X2&quot;</span><span class="p">:</span>
        <span class="n">new_path</span> <span class="o">=</span> <span class="n">stis_shifted</span> <span class="o">/</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">new_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And now we run the coadd script:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>swrapper<span class="w"> </span>-i<span class="w"> </span>./stis_ex/stis_shifted<span class="w"> </span>-o<span class="w"> </span>./stis_ex/stis_shifted/coadd
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>HASP version 1.2.3
Ullyses version 4.1.0
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Creating list of unique modes from these files:
./stis_ex/stis_shifted/od1al1030_sx1.fits AGK+81D266 STIS CCD G430L 52X2 0 14423 (14423, &#39;l1&#39;)
./stis_ex/stis_shifted/od1al2030_sx1.fits AGK+81D266 STIS CCD G430L 52X2 0 14423 (14423, &#39;l2&#39;)
./stis_ex/stis_shifted/od1al2040_sx1.fits AGK+81D266 STIS CCD G430L 52X2E1 0 14423 (14423, &#39;l2&#39;)
./stis_ex/stis_shifted/od1al4030_sx1.fits AGK+81D266 STIS CCD G430L 52X2 0 14423 (14423, &#39;l4&#39;)
./stis_ex/stis_shifted/od1al4040_sx1.fits AGK+81D266 STIS CCD G430L 52X2E1 0 14423 (14423, &#39;l4&#39;)
./stis_ex/stis_shifted/od1am10b0_sx1.fits AGK+81D266 STIS CCD G430L 52X2 0 14423 (14423, &#39;m1&#39;)
./stis_ex/stis_shifted/od1am10e0_sx1.fits AGK+81D266 STIS CCD G430L 52X2E1 0 14423 (14423, &#39;m1&#39;)
Looping over visits
Processing product (14423, &#39;l1&#39;)
Targets in visit (14423, &#39;l1&#39;): [&#39;AGK+81D266&#39;]
Processing target AGK+81D266 in visit (14423, &#39;l1&#39;)
Processing grating STIS/G430L
Importing files [&#39;./stis_ex/stis_shifted/od1al1030_sx1.fits&#39;]
Processing file ./stis_ex/stis_shifted/od1al1030_sx1.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Using a maximum SNR of 20.0 in flux-based filtering
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Yellow">WARNING</span>: VerifyWarning: Card is too long, comment will be truncated. [astropy.io.fits.card]
   Wrote ./stis_ex/stis_shifted/coadd/hst_14423_stis_agkp81d266_g430l_od1al1_cspec.fits
Only 1 grating to abut, skipping abutment
Processing product (14423, &#39;l2&#39;)
Targets in visit (14423, &#39;l2&#39;): [&#39;AGK+81D266&#39;]
Processing target AGK+81D266 in visit (14423, &#39;l2&#39;)
Processing grating STIS/G430L
Importing files [&#39;./stis_ex/stis_shifted/od1al2030_sx1.fits&#39;, &#39;./stis_ex/stis_shifted/od1al2040_sx1.fits&#39;]
Processing file ./stis_ex/stis_shifted/od1al2030_sx1.fits
Processing file ./stis_ex/stis_shifted/od1al2040_sx1.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Using a maximum SNR of 20.0 in flux-based filtering
   Wrote ./stis_ex/stis_shifted/coadd/hst_14423_stis_agkp81d266_g430l_od1al2_cspec.fits
Only 1 grating to abut, skipping abutment
Processing product (14423, &#39;l4&#39;)
Targets in visit (14423, &#39;l4&#39;): [&#39;AGK+81D266&#39;]
Processing target AGK+81D266 in visit (14423, &#39;l4&#39;)
Processing grating STIS/G430L
Importing files [&#39;./stis_ex/stis_shifted/od1al4030_sx1.fits&#39;, &#39;./stis_ex/stis_shifted/od1al4040_sx1.fits&#39;]
Processing file ./stis_ex/stis_shifted/od1al4030_sx1.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Processing file ./stis_ex/stis_shifted/od1al4040_sx1.fits
Using a maximum SNR of 20.0 in flux-based filtering
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   Wrote ./stis_ex/stis_shifted/coadd/hst_14423_stis_agkp81d266_g430l_od1al4_cspec.fits
Only 1 grating to abut, skipping abutment
Processing product (14423, &#39;m1&#39;)
Targets in visit (14423, &#39;m1&#39;): [&#39;AGK+81D266&#39;]
Processing target AGK+81D266 in visit (14423, &#39;m1&#39;)
Processing grating STIS/G430L
Importing files [&#39;./stis_ex/stis_shifted/od1am10b0_sx1.fits&#39;, &#39;./stis_ex/stis_shifted/od1am10e0_sx1.fits&#39;]
Processing file ./stis_ex/stis_shifted/od1am10b0_sx1.fits
Processing file ./stis_ex/stis_shifted/od1am10e0_sx1.fits
Using a maximum SNR of 20.0 in flux-based filtering
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   Wrote ./stis_ex/stis_shifted/coadd/hst_14423_stis_agkp81d266_g430l_od1am1_cspec.fits
Only 1 grating to abut, skipping abutment
Looping over proposals
Processing product 14423
Targets in proposal 14423: [&#39;AGK+81D266&#39;]
Processing target AGK+81D266 in proposal 14423
Processing grating STIS/G430L
Importing files [&#39;./stis_ex/stis_shifted/od1al1030_sx1.fits&#39;, &#39;./stis_ex/stis_shifted/od1al2030_sx1.fits&#39;, &#39;./stis_ex/stis_shifted/od1al2040_sx1.fits&#39;, &#39;./stis_ex/stis_shifted/od1al4030_sx1.fits&#39;, &#39;./stis_ex/stis_shifted/od1al4040_sx1.fits&#39;, &#39;./stis_ex/stis_shifted/od1am10b0_sx1.fits&#39;, &#39;./stis_ex/stis_shifted/od1am10e0_sx1.fits&#39;]
Processing file ./stis_ex/stis_shifted/od1al1030_sx1.fits
Processing file ./stis_ex/stis_shifted/od1al2030_sx1.fits
Processing file ./stis_ex/stis_shifted/od1al2040_sx1.fits
Processing file ./stis_ex/stis_shifted/od1al4030_sx1.fits
Processing file ./stis_ex/stis_shifted/od1al4040_sx1.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Processing file ./stis_ex/stis_shifted/od1am10b0_sx1.fits
Processing file ./stis_ex/stis_shifted/od1am10e0_sx1.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Using a maximum SNR of 20.0 in flux-based filtering
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   Wrote ./stis_ex/stis_shifted/coadd/hst_14423_stis_agkp81d266_g430l_od1a_cspec.fits
Only 1 grating to abut, skipping abutment
</pre></div>
</div>
</div>
</div>
<p>And we can now compare our pre-shifted and shifted data and their coadds.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coadd</span> <span class="o">=</span> <span class="s2">&quot;hst_14423_stis_agkp81d266_g430l_od1a_cspec.fits&quot;</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stis_unshifted</span><span class="p">):</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="n">stis_unshifted</span><span class="p">,</span> <span class="n">stis_shifted</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">is_shifted</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">types</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">is_shifted</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*sx1*&quot;</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
                <span class="n">wl</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;WAVELENGTH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">flux</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FLUX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

                <span class="n">aperture</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PROPAPER&#39;</span><span class="p">]</span>

                <span class="c1"># Differentiating between nominal and E1 position via linestyle</span>
                <span class="k">if</span> <span class="n">aperture</span> <span class="o">==</span> <span class="s2">&quot;52X2&quot;</span><span class="p">:</span>
                    <span class="n">linestyle</span> <span class="o">=</span> <span class="s2">&quot;solid&quot;</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ROOTNAME&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - nom.&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">linestyle</span> <span class="o">=</span> <span class="s2">&quot;dotted&quot;</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ROOTNAME&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - E1&quot;</span>

            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">wl</span><span class="p">,</span>
                <span class="n">flux</span><span class="p">,</span>
                <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="n">linestyle</span>
            <span class="p">)</span>

            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">wl</span><span class="p">,</span>
                <span class="n">flux</span><span class="p">,</span>
                <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="n">linestyle</span>
            <span class="p">)</span>

        <span class="c1"># Plotting the coadd</span>
        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">is_shifted</span><span class="si">}</span><span class="s2">/coadd/</span><span class="si">{</span><span class="n">coadd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
            <span class="n">wl</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;WAVELENGTH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FLUX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">wl</span><span class="p">,</span>
            <span class="n">flux</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Coadd&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span>
        <span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">wl</span><span class="p">,</span>
            <span class="n">flux</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Coadd&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span>
        <span class="p">)</span>

        <span class="c1"># All plots will have same labels</span>
        <span class="k">for</span> <span class="n">subplot</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">():</span>
            <span class="n">subplot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Flux [$erg\ s^{-1}\ cm^{-2}\ \AA^{-1}$]&#39;</span><span class="p">)</span>
            <span class="n">subplot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength [$\AA$]&#39;</span><span class="p">)</span>

        <span class="n">shifted</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Unshifted&#39;</span><span class="p">,</span> <span class="s1">&#39;Shifted&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Flux vs Wavelength, </span><span class="si">{</span><span class="n">shifted</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                           <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Flux vs Wavelength 4840-4900Å, </span><span class="si">{</span><span class="n">shifted</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                           <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">4840</span><span class="p">,</span> <span class="mi">4900</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.4e-13</span><span class="p">,</span> <span class="mf">1.5e-13</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File not found: You need to run previous cells to generate the data.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can see the offsets between the datasets taken at the nominal position and the <code class="docutils literal notranslate"><span class="pre">E1</span></code> position are reduced after we’ve applied our shifts and run <code class="docutils literal notranslate"><span class="pre">CalSTIS</span></code>. While we did a very rough estimate of the shift, users will want to verify that they have the correct wavelength solution through their own methods (e.g. checking expected wavelengths to observed wavelengths, comparing radial velocities, etc.).</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="congrats-on-completing-the-notebook">
<h1>Congrats on completing the notebook!<a class="headerlink" href="#congrats-on-completing-the-notebook" title="Permalink to this heading">#</a></h1>
<section id="there-are-more-tutorial-notebooks-for-custom-coaddition-cases-in-this-repo-check-them-out">
<h2>There are more tutorial notebooks for custom coaddition cases in <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/tree/main/notebooks/HASP">this</a> repo, check them out!<a class="headerlink" href="#there-are-more-tutorial-notebooks-for-custom-coaddition-cases-in-this-repo-check-them-out" title="Permalink to this heading">#</a></h2>
</section>
<section id="about-this-notebook">
<h2>About this Notebook<a class="headerlink" href="#about-this-notebook" title="Permalink to this heading">#</a></h2>
<p><strong>Author:</strong> Sierra Gomez (sigomez&#64;stsci.edu)</p>
<p><strong>Updated on:</strong> August 29, 2024</p>
<p><em>This tutorial was generated to be in compliance with the <a class="reference external" href="https://github.com/spacetelescope/style-guides">STScI style guides</a> and would like to cite the <a class="reference external" href="https://github.com/spacetelescope/style-guides/blob/master/templates/example_notebook.ipynb">Jupyter guide</a> in particular.</em></p>
</section>
<section id="citations">
<h2>Citations<a class="headerlink" href="#citations" title="Permalink to this heading">#</a></h2>
<p>If you use <code class="docutils literal notranslate"><span class="pre">astropy</span></code>, <code class="docutils literal notranslate"><span class="pre">astroquery</span></code>, or <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code>, <code class="docutils literal notranslate"><span class="pre">numpy</span></code> for published research, please cite the authors. Follow these links for more information about citations:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.astropy.org/en/stable/index.html">Citing <code class="docutils literal notranslate"><span class="pre">astropy</span></code></a></p></li>
<li><p><a class="reference external" href="https://astroquery.readthedocs.io/en/latest/">Citing <code class="docutils literal notranslate"><span class="pre">astroquery</span></code></a></p></li>
<li><p><a class="reference external" href="https://matplotlib.org/stable/users/project/citing.html">Citing <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code></a></p></li>
<li><p><a class="reference external" href="https://numpy.org/citing-numpy/">Citing <code class="docutils literal notranslate"><span class="pre">numpy</span></code></a></p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/hst_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/HASP/WavelengthAdjustment"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../DataDiagnostic/DataDiagnostics.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">HASP Data Diagnostic Notebook</p>
      </div>
    </a>
    <a class="right-next"
       href="../COSLifetimePositions/COSLifetimePositions.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Combining COS Data from Multiple Lifetime Positions and Central Wavelengths</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Wavelength Adjustments for Running the Hubble Advanced Spectral Products (HASP) Script</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-font-weight-normal-this-notebook-is-designed-to-walk-you-through-making-wavelength-adjustments-to-cos-stis-data-when-running-the-hubble-advanced-spectral-products-hasp-coadd-script-span"><span style="font-weight:normal">This Notebook is designed to walk you through making wavelength adjustments to COS &amp; STIS data when running the <strong>Hubble Advanced Spectral Products (HASP)</strong> coadd script.</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">0. Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#performing-wavelength-adjustments-on-cos-data">1. Performing Wavelength Adjustments on COS Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-and-organizing-cos-data-using-astroquery">1.1 Downloading and Organizing COS Data using <code class="docutils literal notranslate"><span class="pre">Astroquery</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-hasp-script-on-cos-data">1.2 Running the HASP Script on COS Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#identifying-a-wavelength-shift-in-cos-data">1.3 Identifying a Wavelength Shift in COS Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#performing-cross-correlation-on-x1d-cos-data-to-calculate-lag">1.4 Performing Cross-Correlation on <code class="docutils literal notranslate"><span class="pre">X1D</span></code> COS Data to Calculate Lag</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#applying-shifts-to-cos-data-and-re-creating-coadd">1.5 Applying Shifts to COS data and Re-creating Coadd</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-non-shifted-and-shifted-cos-coadds">1.6 Comparing Non-Shifted and Shifted COS Coadds</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#performing-wavelength-adjustments-on-stis-data">2. Performing Wavelength Adjustments on STIS Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-and-organizing-stis-data-using-astroquery">2.1 Downloading and Organizing STIS Data using <code class="docutils literal notranslate"><span class="pre">Astroquery</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-hasp-script-on-stis-data">2.2 Running the HASP Script on STIS Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#performing-cross-correlation-on-stis-data-and-calculating-lag">2.3 Performing Cross-Correlation on STIS data and Calculating Lag</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#applying-shifts-to-raw-stis-data-and-re-creating-coadd">2.4 Applying Shifts to Raw STIS data and Re-creating Coadd</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-non-adjusted-and-adjusted-stis-coadds">2.5 Comparing Non-Adjusted and Adjusted STIS Coadds</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#congrats-on-completing-the-notebook">Congrats on completing the notebook!</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#there-are-more-tutorial-notebooks-for-custom-coaddition-cases-in-this-repo-check-them-out">There are more tutorial notebooks for custom coaddition cases in this repo, check them out!</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#citations">Citations</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>