
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Pixel-based ACS/WFC CTE Forward Model &#8212; HST Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../../../_static/table.css?v=cd6c26fb" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js?v=afe5de03"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/ACS/acs_cte_forward_model/acs_cte_forward_model_example';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="ACS Image Reduction for Subarray Data" href="../acs_subarrays/acs_subarrays.html" />
    <link rel="prev" title="ACS Linearity with Saturated Stars" href="../acs_saturation_trails/acs_saturation_trails.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="HST Notebooks - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="HST Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../index.html">
                    STScI HST Notebook Repository HQ
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">ACS</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../README.html">ACS Notebooks</a></li>


<li class="toctree-l1"><a class="reference internal" href="../acs_findsat_mrt/acs_findsat_mrt_example.html">Satellite trail detection in ACS/WFC data using acstools.findsat_mrt</a></li>
<li class="toctree-l1"><a class="reference internal" href="../acs_saturation_trails/acs_saturation_trails.html">ACS Linearity with Saturated Stars</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Pixel-based ACS/WFC CTE Forward Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../acs_subarrays/acs_subarrays.html">ACS Image Reduction for Subarray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../acs_sbc_dark_analysis/acs_sbc_dark_analysis.html">SBC Dark Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../acs_reduction/acs_reduction.html">ACS/WFC Image Reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../acs_pixel_area_maps/acs_pixel_area_maps.html">Obtaining Pixel Area Maps for ACS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../acs_polarization_tools/acs_polarization_tools.html">Using ACS Polarization Tools</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">COS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../COS/README.html">COS Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../COS/Setup/Setup.html">Setting up your computer environment for working with COS data</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/DataDl/DataDl.html">Downloading COS Data</a></li>




<li class="toctree-l1"><a class="reference internal" href="../../COS/ViewData/ViewData.html">Viewing COS Data</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/AsnFile/AsnFile.html">Modifying or Creating an Association File</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/CalCOS/CalCOS.html">Running the COS Data Pipeline (<code class="docutils literal notranslate"><span class="pre">CalCOS</span></code>)</a></li>






<li class="toctree-l1"><a class="reference internal" href="../../COS/SplitTag/SplitTag.html">Splitting COS Exposures into sub-exposures with <code class="docutils literal notranslate"><span class="pre">splittag</span></code></a></li>







<li class="toctree-l1"><a class="reference internal" href="../../COS/DayNight/DayNight.html">Filtering out COS Data taken during the Day or Night</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../COS/LSF/LSF.html">Working with the COS Line Spread Function (LSF)</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../COS/Extract/Extract.html">Editing the extraction boxes in a spectral extraction file (<code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>)</a></li>







</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">DrizzlePac</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/README.html">DrizzlePac Jupyter Notebook Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/Initialization/Initialization.html">DrizzlePac Initialization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_to_catalogs/align_to_catalogs.html">Aligning HST images to an absolute reference catalog</a></li>



<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_multiple_visits/align_multiple_visits.html">Optimizing Image Alignment for Multiple HST Visits</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_sparse_fields/align_sparse_fields.html">Aligning Deep Exposures of Sparse Fields</a></li>








<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/drizzle_wfpc2/drizzle_wfpc2.html">Drizzling WFPC2 Images to use a Single Zeropoint</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/mask_satellite/mask_satellite.html">Satellite Trail Masking Techniques</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/optimize_image_sampling/optimize_image_sampling.html">Optimizing the Image Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/sky_matching/sky_matching.html">Sky Matching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/use_ds9_regions_in_tweakreg/use_ds9_regions_in_tweakreg.html">Using DS9 Regions to Include and Exclude Sources in HST Image Alignment with TWEAKREG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/using_updated_astrometry_solutions/using_updated_astrometry_solutions.html">Using updated astrometry solutions</a></li>


</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">HASP</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../HASP/Setup/Setup.html">Inputting User Data using the Hubble Advanced Spectral Products Script</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NICMOS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NICMOS/nicmos_unit_conversion/nicmos_unit_conversion.html">Programmatic Replacements for NICMOS Units Conversion Form</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">STIS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../STIS/README.html">STIS-Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/cross-correlation/cross-correlation.html">Correcting for Missing Wavecals with Cross-Correlation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/custom_ccd_darks/custom_ccd_darks.html">Custom CCD Darks <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/drizpac_notebook/STIS_DrizzlePac_Tutorial.html">STIS DrizzlePac Tutorial <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/CoronagraphyViz/STIS_Coronagraphy_Visualization_v2.html">STIS Coronagraphy Visualization Tool (v2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/calstis/calstis_2d_ccd.html">Calstis 2-D CCD Data Reduction <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/target_acquisition/target_acquisition.html">Evaluating STIS Target Acquisitions <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/view_data/view_data.html">Viewing STIS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/extraction/1D_Extraction.html">1D Spectra Extraction <a class="tocSkip"></a></a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">WFC3</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/README.html">WFC3 Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/calwf3_recalibration/calwf3_recal_tvb.html">Manual Recalibration with calwf3: Turning off the IR Linear Ramp Fit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/calwf3_v1.0_cte/calwf3_with_v1.0_PCTE.html">Processing WFC3/UVIS Data with <code class="docutils literal notranslate"><span class="pre">calwf3</span></code> Using the v1.0 CTE-Correction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/exception_report/wfc3_exception_report.html">Exception Report Checklist - WFC3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/image_displayer_analyzer/wfc3_image_displayer_analyzer.html">WFC3 Image Displayer &amp; Analyzer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/ir_ima_visualization/IR_IMA_Visualization_with_an_Example_of_Time_Variable_Background.html">WFC3/IR IMA Visualization Tools with An Example of Time Variable Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/ir_scattered_light_calwf3_corrections/Correcting_for_Scattered_Light_in_IR_Exposures_Using_calwf3_to_Mask_Bad_Reads.html">Correcting for Scattered Light in WFC3/IR Exposures: Using <code class="docutils literal notranslate"><span class="pre">calwf3</span></code> to Mask Bad Reads</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/ir_scattered_light_manual_corrections/Correcting_for_Scattered_Light_in_IR_Exposures_by_Manually_Subtracting_Bad_Reads.html">Correcting for Scattered Light in WFC3/IR Exposures: Manually Subtracting Bad Reads</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/persistence/wfc3_ir_persistence.html">Masking Persistence in WFC3/IR Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/tvb_flattenramp/TVB_flattenramp_notebook.html">Correcting for Helium Line Emission Background in IR Exposures using the “Flatten-Ramp” Technique</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/photometry_examples/phot_examples.html">Synthetic Photometry Examples for WFC3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/uvis_pam_corrections/WFC3_UVIS_Pixel_Area_Map_Corrections_for_Subarrays.html">WFC3/UVIS Pixel Area Map Corrections for Subarrays</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/uvis_time_dependent_photometry/uvis_timedep_phot.html">WFC3/UVIS Time-dependent Photometry</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/spacetelescope/hst_notebooks/blob/main/notebooks/ACS/acs_cte_forward_model/acs_cte_forward_model_example.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/hst_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/hst_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/ACS/acs_cte_forward_model/acs_cte_forward_model_example.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/ACS/acs_cte_forward_model/acs_cte_forward_model_example.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Pixel-based ACS/WFC CTE Forward Model</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#install-update-stenv">0. Install/update stenv</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#astroconda-is-no-longer-supported-and-is-superseded-by-stenv">*AstroConda is no longer supported and is superseded by stenv.</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">1. Imports</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#download-data-and-reference-files">2. Download data and reference files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-image-of-artificial-stars">3. Create image of artificial stars</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#option-a-start-with-an-observed-flc-image">Option A: Start with an observed FLC image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-add-artificial-stars">4A. Add artificial stars</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-reverse-the-flat-and-dark-correction">5A. Reverse the flat and dark correction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-run-cte-forward-model">6A. Run CTE forward model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-7a-run-cte-correction">(Optional) 7A. Run CTE correction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-apply-flat-and-dark-correction">8A. Apply flat and dark correction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#option-b-start-with-a-synthetic-image">Option B: Start with a synthetic image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-create-a-synthetic-image">4B. Create a synthetic image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-run-cte-forward-model">5B. Run CTE forward model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-optional-run-cte-correction">6B. (Optional) Run CTE correction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-apply-flat-and-dark-correction">7B. Apply flat and dark correction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#for-more-help">For more help:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><a id="title_ID"></a></p>
<section id="pixel-based-acs-wfc-cte-forward-model">
<h1>Pixel-based ACS/WFC CTE Forward Model<a class="headerlink" href="#pixel-based-acs-wfc-cte-forward-model" title="Link to this heading">#</a></h1>
<p>This notebook demonstrates preparing data for input into the ACS/WFC pixel-based CTE forward model and running the model.</p>
<section id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Link to this heading">#</a></h2>
<p><a class="reference internal" href="#intro_ID"><span class="xref myst">Introduction</span></a> <br>
<a class="reference internal" href="#update"><span class="xref myst">0. Install/update stenv</span></a> <br>
<a class="reference internal" href="#imports"><span class="xref myst">1. Imports</span></a> <br>
<a class="reference internal" href="#download"><span class="xref myst">2. Download data and reference files</span></a> <br>
<a class="reference internal" href="#stars"><span class="xref myst">3. Create an image of artificial stars</span></a> <br></p>
<p><a class="reference internal" href="#option-a"><span class="xref myst">Option A: Start with an observed FLC image</span></a></p>
<ul class="simple">
<li><p><a class="reference internal" href="#A4"><span class="xref myst">4. Add artificial stars</span></a></p></li>
<li><p><a class="reference internal" href="#A5"><span class="xref myst">5. Reverse the flat and dark correction</span></a></p></li>
<li><p><a class="reference internal" href="#A6"><span class="xref myst">6. Run CTE forward model</span></a></p></li>
<li><p><a class="reference internal" href="#A7"><span class="xref myst">7. (Optional) Run CTE correction</span></a></p></li>
<li><p><a class="reference internal" href="#A8"><span class="xref myst">8. Apply flat and dark correction</span></a> <br></p></li>
</ul>
<p><a class="reference internal" href="#option-b"><span class="xref myst">Option B: Start with a synthetic image</span></a></p>
<ul class="simple">
<li><p><a class="reference internal" href="#B4"><span class="xref myst">4. Create your image</span></a></p></li>
<li><p><a class="reference internal" href="#B5"><span class="xref myst">5. Run CTE forward model</span></a></p></li>
<li><p><a class="reference internal" href="#B6"><span class="xref myst">6. (Optional) Run CTE correction</span></a></p></li>
<li><p><a class="reference internal" href="#B7"><span class="xref myst">7. Apply flat and dark correction</span></a> <br></p></li>
</ul>
<p><a class="reference internal" href="#about_ID"><span class="xref myst">About this Notebook</span></a></p>
<p><font color="red">This notebook currently fails to execute, use as reference only</font></p>
<p><a id="intro_ID"></a></p>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>The charge transfer efficiency (CTE) of the Advanced Camera for Surveys (ACS) Wide Field Channel (WFC) has been decreasing over the lifetime of the instrument. Radiation damage from cosmic rays and other sources leads to charge traps within the detector. These traps remove electrons from charge packets as they are transferred between rows of the detector, and release the electrons in subsequent pixels. This causes flux to be removed from bright features and released into pixels behind the features (relative to the row closest to the amplifier), creating bright trails.</p>
<p>A pixel-based CTE correction model for the ACS/WFC detector is fully described in <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2010PASP..122.1035A/abstract">Anderson &amp; Bedin (2010)</a>, and a recent update to the model is presented in <a class="reference external" href="http://www.stsci.edu/files/live/sites/www/files/home/hst/instrumentation/acs/documentation/instrument-science-reports-isrs/_documents/isr1804.pdf">ACS ISR 2018-04</a>. The model is based on an empirical determination of the number and depth of charge traps distributed across the detector. It simulates detector readout of an input image, removes the result from the input, and iterates five times. In this way, a reverse model is successively approximated by the forward model. Electrons released in trails are removed and added back to the bright feature in which they originated.</p>
<p>The pixel-based correction was implemented in the calibration pipeline code for ACS (<code class="docutils literal notranslate"><span class="pre">CALACS</span></code>) in 2012 and the algorithm was updated and improved in 2018. The CTE correction step within <code class="docutils literal notranslate"><span class="pre">CALACS</span></code> runs on bias-corrected images, <code class="docutils literal notranslate"><span class="pre">blv_tmp</span></code> files, producing <code class="docutils literal notranslate"><span class="pre">blc_tmp</span></code> files, which lack the bright trails due to poor CTE. Further calibration, including dark correction and flat-fielding, produces <code class="docutils literal notranslate"><span class="pre">flt</span></code> and <code class="docutils literal notranslate"><span class="pre">flc</span></code> files from the <code class="docutils literal notranslate"><span class="pre">blv_tmp</span></code> and <code class="docutils literal notranslate"><span class="pre">blc_tmps</span></code> files, respectively. For more information on calibration of ACS/WFC data, see the <a class="reference external" href="http://www.stsci.edu/files/live/sites/www/files/home/hst/instrumentation/acs/documentation/other-documents/_documents/acs_dhb.pdf">ACS Data Handbook</a>.</p>
<p>Users desiring to more fully understand the effects of pixel-based CTE correction on their science may wish to run the forward model (i.e., the detector readout simulation) on data containing artificial stars. Here we demonstrate two methods for running the CTE forward model. In <a class="reference internal" href="#option-a"><span class="xref myst">Option A</span></a>, we begin with an observed <code class="docutils literal notranslate"><span class="pre">flc</span></code> image, whereas in <a class="reference internal" href="#option-b"><span class="xref myst">Option B</span></a>, we begin with a <code class="docutils literal notranslate"><span class="pre">raw</span></code> image and generate synthetic data on which to run the forward model.</p>
<p><strong>Note: The forward model, like the CTE correction step in <code class="docutils literal notranslate"><span class="pre">CALACS</span></code>, adds 10% of the difference between the input and output <code class="docutils literal notranslate"><span class="pre">SCI</span></code> extensions to the <code class="docutils literal notranslate"><span class="pre">ERR</span></code> extensions to account for uncertainty in the CTE model. Below, we provide guidance for properly repopulating the <code class="docutils literal notranslate"><span class="pre">ERR</span></code> extensions of forward-modeled data.</strong></p>
<p><a id="update"></a></p>
<section id="install-update-stenv">
<h3>0. Install/update stenv<a class="headerlink" href="#install-update-stenv" title="Link to this heading">#</a></h3>
<section id="astroconda-is-no-longer-supported-and-is-superseded-by-stenv">
<h4>*<a class="reference external" href="https://astroconda.readthedocs.io/en/latest/">AstroConda</a> is no longer supported and is superseded by stenv.<a class="headerlink" href="#astroconda-is-no-longer-supported-and-is-superseded-by-stenv" title="Link to this heading">#</a></h4>
<p><a class="reference external" href="https://stenv.readthedocs.io/en/latest/">stenv</a> will include most packages from AstroConda and is recommended to process and analyze data from the Hubble Space Telescope (HST) and James Webb Space Telescope (JWST). To install and activate stenv, please refer to the <a class="reference external" href="https://stenv.readthedocs.io/en/latest/getting_started.html">documentation</a>. NOTE: stenv requires Python 3.8 or greater.</p>
<p>If you already use stenv, make sure the versions of <code class="docutils literal notranslate"><span class="pre">hstcal</span></code> and <a class="reference external" href="https://acstools.readthedocs.io/en/latest/"><code class="docutils literal notranslate"><span class="pre">acstools</span></code></a> are both at least 2.1.0. The version of <code class="docutils literal notranslate"><span class="pre">CALACS</span></code> should be at least 10.1.0. Check the versions of all three on the command line:</p>
<p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">conda</span> <span class="pre">list</span> <span class="pre">hstcal</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">conda</span> <span class="pre">list</span> <span class="pre">acstools</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">calacs.e</span> <span class="pre">--version</span></code></p>
<p>It is recommended, however, that you use the most up-to-date versions of these packages. To update these packages, run the following via the command line:</p>
<p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">conda</span> <span class="pre">update</span> <span class="pre">hstcal</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">conda</span> <span class="pre">update</span> <span class="pre">acstools</span></code></p>
<p><a id="imports"></a></p>
</section>
</section>
<section id="imports">
<h3>1. Imports<a class="headerlink" href="#imports" title="Link to this heading">#</a></h3>
<p>Start by importing several packages:</p>
<ul class="simple">
<li><p><em>matplotlib notebook</em> for creating interactive plots</p></li>
<li><p><em>os</em> for setting environment variables</p></li>
<li><p><em>shutil</em> for managing directories</p></li>
<li><p><em>numpy</em> for math and array calculations</p></li>
<li><p><em>collections OrderedDict</em> for making dictionaries easily</p></li>
<li><p><em>matplotlib pyplot</em> for plotting</p></li>
<li><p><em>matplotlib.colors LogNorm</em> for scaling images</p></li>
<li><p><em>astropy.io fits</em> for working with FITS files</p></li>
<li><p><em>photutils datasets</em> for creating synthetic stars and images</p></li>
<li><p><em>astroquery.mast Observations</em> for downloading data from MAST</p></li>
<li><p><em>acstools acsccd</em> for performing bias correction</p></li>
<li><p><em>acstools acscte</em> for performing CTE correction (reversing CTE trailing)</p></li>
<li><p><em>acstools acs2d</em> for performing dark correction and flat-fielding</p></li>
<li><p><em>acstools acscteforwardmodel</em> for running CTE forward model (generating CTE trailing)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">photutils</span> <span class="kn">import</span> <span class="n">datasets</span>
<span class="kn">from</span> <span class="nn">astroquery.mast</span> <span class="kn">import</span> <span class="n">Observations</span>
<span class="kn">from</span> <span class="nn">acstools</span> <span class="kn">import</span> <span class="n">acsccd</span>
<span class="kn">from</span> <span class="nn">acstools</span> <span class="kn">import</span> <span class="n">acscte</span>
<span class="kn">from</span> <span class="nn">acstools</span> <span class="kn">import</span> <span class="n">acs2d</span>
<span class="kn">from</span> <span class="nn">acstools</span> <span class="kn">import</span> <span class="n">acscteforwardmodel</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference internal" href="#title_ID"><span class="xref myst">Top of Page</span></a></p>
<p><a id="download"></a></p>
</section>
<section id="download-data-and-reference-files">
<h3>2. Download data and reference files<a class="headerlink" href="#download-data-and-reference-files" title="Link to this heading">#</a></h3>
<p>Full-frame, new-mode subarray, and 2K old-mode subarray ACS/WFC images can be run through the CTE forward model. New-mode subarrays were added to the HST flight software at the beginning of Cycle 24. These subarrays have <code class="docutils literal notranslate"><span class="pre">APERTURE</span></code> keywords of the type <code class="docutils literal notranslate"><span class="pre">WFC1A-512,</span> <span class="pre">WFC1A-1K,</span> <span class="pre">WFC1A-2K</span></code>, etc. Old-mode subarrays have <code class="docutils literal notranslate"><span class="pre">APERTURE</span></code> keywords of the type <code class="docutils literal notranslate"><span class="pre">WFC1-512,</span> <span class="pre">WFC1-1K,</span> <span class="pre">WFC1-2K</span></code>, etc. WFC apertures are also listed in <a class="reference external" href="https://hst-docs.stsci.edu/display/ACSIHB/7.7+ACS+Apertures#id-7.7ACSApertures-table7.7">Table 7.7 of the ACS IHB</a>.</p>
<p>We recommend that the CTE forward model be run on data that has been bias-corrected, but not dark-corrected or flat-fielded. The flat and dark should be present in the image input into the CTE forward model because these features are present in the image when it is read out, and are therefore affected by CTE losses. The forward model can be run on <code class="docutils literal notranslate"><span class="pre">flc</span></code> files, but the results will technically be incorrect. Photometric tests of forward modeled data of both types show minor differences. Post-SM4 subarray data must be destriped with <a class="reference external" href="https://acstools.readthedocs.io/en/latest/acs_destripe_plus.html"><code class="docutils literal notranslate"><span class="pre">acs_destripe_plus</span></code></a>, which will also perform the other calibration steps. <strong>Note: At this time, <code class="docutils literal notranslate"><span class="pre">acs_destripe_plus</span></code> only produces <code class="docutils literal notranslate"><span class="pre">flt</span></code>/<code class="docutils literal notranslate"><span class="pre">flc</span></code> images.</strong></p>
<p>We download a full-frame 47 Tuc image, <code class="docutils literal notranslate"><span class="pre">jd0q14ctq</span></code>, from the ACS CCD Stability Monitor program (PI: Coe, 14402) from the Mikulski Archive for Space Telescopes (<a class="reference external" href="https://mast.stsci.edu/portal/Mashup/Clients/Mast/Portal.html">MAST</a>) using <a class="reference external" href="https://astroquery.readthedocs.io/en/latest/">astroquery</a>. This image was taken in March 2016, and so it is strongly affected by CTE losses. We download the <code class="docutils literal notranslate"><span class="pre">flc</span></code> image for <a class="reference internal" href="#option-a"><span class="xref myst">Option A</span></a> and the <code class="docutils literal notranslate"><span class="pre">raw</span></code> image for <a class="reference internal" href="#option-b"><span class="xref myst">Option B</span></a> into the current directory.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obs_table</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span><span class="n">obs_id</span><span class="o">=</span><span class="s1">&#39;jd0q14ctq&#39;</span><span class="p">)</span>

<span class="n">dl_table</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span><span class="n">obs_table</span><span class="p">[</span><span class="s1">&#39;obsid&#39;</span><span class="p">],</span> <span class="n">mrp_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="n">productSubGroupDescription</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FLC&#39;</span><span class="p">,</span> <span class="s1">&#39;RAW&#39;</span><span class="p">])</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dl_table</span><span class="p">:</span>
    <span class="n">oldfname</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Local Path&#39;</span><span class="p">]</span>
    <span class="n">unique_fname</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">oldfname</span><span class="p">)</span>
    <span class="n">newfname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">oldfname</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">oldfname</span><span class="p">,</span> <span class="n">newfname</span><span class="p">)</span>
    
<span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s1">&#39;mastDownload&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, update and download the correct flat and dark reference files for the <code class="docutils literal notranslate"><span class="pre">jd0q14ctq</span></code> dataset from the <a class="reference external" href="https://hst-crds.stsci.edu/">Calibration Reference Data System</a> (CRDS). We use the <a class="reference external" href="https://hst-crds.stsci.edu/static/users_guide/command_line_tools.html#crds-bestrefs">CRDS command line tools</a> to do this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_SERVER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;https://hst-crds.stsci.edu&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;./crds_cache&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;jref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;./crds_cache/references/hst/acs/&#39;</span>

<span class="o">!</span>crds<span class="w"> </span>bestrefs<span class="w"> </span>--update-bestrefs<span class="w"> </span>--sync-references<span class="o">=</span><span class="m">1</span><span class="w"> </span>--files<span class="w"> </span>jd0q14ctq_flc.fits
</pre></div>
</div>
</div>
</div>
<p>Next, we obtain the filenames of the flat (<code class="docutils literal notranslate"><span class="pre">PFLTFILE</span></code>), CTE-corrected dark (<code class="docutils literal notranslate"><span class="pre">DRKCFILE</span></code>), and superbias (<code class="docutils literal notranslate"><span class="pre">BIASFILE</span></code>) reference files from the image header. The flat will be used to add the effects of the flat field back into the image. If the data were post-flashed, then the flash file (<code class="docutils literal notranslate"><span class="pre">FLSHFILE</span></code>) is needed as well. This is shown in the commented line below. The CTE-corrected dark will be used to add dark current to the <code class="docutils literal notranslate"><span class="pre">flc</span></code> file and the synthetic data. The superbias will be used to repopulate the <code class="docutils literal notranslate"><span class="pre">ERR</span></code> extensions of the forward-modeled image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_flc.fits&#39;</span><span class="p">)</span>

<span class="n">flat</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;PFLTFILE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">dkc</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;DRKCFILE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">bias</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;BIASFILE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="c1"># flash = hdr[&#39;FLSHFILE&#39;].split(&#39;$&#39;)[-1]</span>
</pre></div>
</div>
</div>
</div>
<p>We open the flat and dark images and obtain the <code class="docutils literal notranslate"><span class="pre">SCI</span></code> extensions of both CCDs, which are extension 1 for WFC2 and extension 4 for WFC1. We open the superbias image and obtain the <code class="docutils literal notranslate"><span class="pre">ERR</span></code> extensions of both CCDs, which are extension 2 for WFC2 and extension 5 for WFC2. If the flash file is needed, obtain the <code class="docutils literal notranslate"><span class="pre">SCI</span></code> extensions for both CCDs. This is shown in the commented out lines below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The jref environment variable gives the directory containing the reference files</span>
<span class="n">flat_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;jref&#39;</span><span class="p">],</span> <span class="n">flat</span><span class="p">))</span>

<span class="n">flat_wfc1</span> <span class="o">=</span> <span class="n">flat_hdu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">flat_wfc2</span> <span class="o">=</span> <span class="n">flat_hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dkc_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;jref&#39;</span><span class="p">],</span> <span class="n">dkc</span><span class="p">))</span>

<span class="n">dkc_wfc1</span> <span class="o">=</span> <span class="n">dkc_hdu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">dkc_wfc2</span> <span class="o">=</span> <span class="n">dkc_hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="c1"># Darks can sometimes have negative pixels because they have been flash-corrected </span>
<span class="c1"># and CTE-corrected. Set all negative pixels to zero</span>
<span class="n">dkc_wfc1</span><span class="p">[</span><span class="n">dkc_wfc1</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="n">dkc_wfc2</span><span class="p">[</span><span class="n">dkc_wfc2</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bias_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;jref&#39;</span><span class="p">],</span> <span class="n">bias</span><span class="p">))</span>

<span class="n">err_bias_wfc1</span> <span class="o">=</span> <span class="n">bias_hdu</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">err_bias_wfc2</span> <span class="o">=</span> <span class="n">bias_hdu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="n">dq_bias_wfc1</span> <span class="o">=</span> <span class="n">bias_hdu</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">dq_bias_wfc2</span> <span class="o">=</span> <span class="n">bias_hdu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># flash_dhu = fits.open(&#39;{}/{}&#39;.format(os.environ[&#39;jref&#39;], flash))</span>

<span class="c1"># flash_wfc1 = flash_hdu[4].data</span>
<span class="c1"># flash_wfc2 = flash_hdu[1].data</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference internal" href="#title_ID"><span class="xref myst">Top of Page</span></a></p>
<p><a id="stars"></a></p>
</section>
<section id="create-image-of-artificial-stars">
<h3>3. Create image of artificial stars<a class="headerlink" href="#create-image-of-artificial-stars" title="Link to this heading">#</a></h3>
<p>We will need an image containing artificial stars on zero background for both options presented below. Artificial stars are typically generated using models that do not include the flat field, or are produced from data that have been flat-fielded. If this is the case, artificial stars should be added to the image at the <code class="docutils literal notranslate"><span class="pre">flc</span></code> stage.</p>
<p>Users of this notebook may have a preferred method for generating artificial stars and adding them to data, so here we simply add several Gaussians to the image using utilities within <code class="docutils literal notranslate"><span class="pre">photutils.datasets</span></code> in <code class="docutils literal notranslate"><span class="pre">astropy</span></code>. These Gaussians are not representative of the true ACS/WFC PSF, and are added here for illustrative purposes only. Please note that artificial sources with peak values approaching or exceeding the WFC CCD full well value of about 80,000 electrons are not recommended for simulated data. Blooming of charge from saturated pixels is not implemented in this example.</p>
<p>There are many tools for generating artificial stars, including <a class="reference external" href="http://www.stsci.edu/hst/instrumentation/focus-and-pointing/focus/tiny-tim-hst-psf-modeling">Tiny Tim</a>, <a class="reference external" href="http://www.stsci.edu/files/live/sites/www/files/home/hst/instrumentation/acs/documentation/instrument-science-reports-isrs/_documents/isr0601.pdf">effective PSFs</a>, or <a class="reference external" href="https://photutils.readthedocs.io/en/stable/epsf.html"><code class="docutils literal notranslate"><span class="pre">EPSFBuilder</span></code></a> in <code class="docutils literal notranslate"><span class="pre">photutils</span></code>. A recent study of PSF models for ACS/WFC can be found <a class="reference external" href="http://www.stsci.edu/files/live/sites/www/files/home/hst/instrumentation/acs/documentation/instrument-science-reports-isrs/_documents/isr1708.pdf">here</a>.</p>
<p>First, we generate a table of random Gaussian sources of typical brightness for our 47 Tuc field with $\mathrm{FWHM}\sim2.5$ pixels. Because $\mathrm{FWHM} = 2.355\sigma$, we will generate Gaussian sources with $\sigma \sim 1.06$ pixels in both $x$ and $y$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_sources</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">param_ranges</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;amplitude&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">30000</span><span class="p">]),</span>
                <span class="p">(</span><span class="s1">&#39;x_mean&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4095</span><span class="p">]),</span>
                <span class="p">(</span><span class="s1">&#39;y_mean&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2047</span><span class="p">]),</span>
                <span class="p">(</span><span class="s1">&#39;x_stddev&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.05</span><span class="p">,</span> <span class="mf">1.07</span><span class="p">]),</span>
                <span class="p">(</span><span class="s1">&#39;y_stddev&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.05</span><span class="p">,</span> <span class="mf">1.07</span><span class="p">]),</span>
                <span class="p">(</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">])]</span>

<span class="n">param_ranges</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">param_ranges</span><span class="p">)</span>

<span class="n">sources</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">make_random_gaussians_table</span><span class="p">(</span><span class="n">n_sources</span><span class="p">,</span> <span class="n">param_ranges</span><span class="p">,</span> 
                                               <span class="n">seed</span><span class="o">=</span><span class="mi">12345</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we get the shape of one of the <code class="docutils literal notranslate"><span class="pre">flc</span></code> image <code class="docutils literal notranslate"><span class="pre">SCI</span></code> extensions and make an image from the table of Gaussian sources. Note that this step may take a few minutes. Finally, we run the synthetic image through a Poisson sampler in order to simulate the Poisson noise of the scene.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wfc2</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_flc.fits&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">shape</span> <span class="o">=</span> <span class="n">wfc2</span><span class="o">.</span><span class="n">shape</span>

<span class="n">synth_stars_image</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">make_gaussian_sources_image</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">sources</span><span class="p">)</span>

<span class="n">synth_stars_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">synth_stars_image</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">synth_stars_image</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> 
          <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;x_mean&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;y_mean&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
        <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a id="option-a"></a></p>
</section>
<section id="option-a-start-with-an-observed-flc-image">
<h3>Option A: Start with an observed FLC image<a class="headerlink" href="#option-a-start-with-an-observed-flc-image" title="Link to this heading">#</a></h3>
<p>In this Option, we add synthetic stars to the scene in an <code class="docutils literal notranslate"><span class="pre">flc</span></code> image and process it appropriately for use with the forward model. We use the <code class="docutils literal notranslate"><span class="pre">flc</span></code> image because it is the closest approximation to a pristine image of the sky. Below we plot a portion of the downloaded 47 Tuc image. Stars of various magnitudes are visible, as well as cosmic rays.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flc</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_flc.fits&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">flc</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2800</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">1700</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference internal" href="#title_ID"><span class="xref myst">Top of Page</span></a></p>
<p><a id="A4"></a></p>
</section>
<section id="a-add-artificial-stars">
<h3>4A. Add artificial stars<a class="headerlink" href="#a-add-artificial-stars" title="Link to this heading">#</a></h3>
<p>Add the image of artificial stars generated above to both CCDs of the <code class="docutils literal notranslate"><span class="pre">flc</span></code> image, and save it as a new file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_flc.fits&#39;</span><span class="p">)</span>

<span class="n">wfc1</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">wfc2</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="n">wfc1</span> <span class="o">+=</span> <span class="n">synth_stars_image</span>
<span class="n">wfc2</span> <span class="o">+=</span> <span class="n">synth_stars_image</span>

<span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_stars_flc.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Below we plot a section of the <code class="docutils literal notranslate"><span class="pre">flc</span></code> image with a few artificial stars circled in red.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flc_stars</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_stars_flc.fits&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">flc_stars</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> 
          <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;x_mean&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;y_mean&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> 
        <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2800</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">1700</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference internal" href="#title_ID"><span class="xref myst">Top of Page</span></a></p>
<p><a id="A5"></a></p>
</section>
<section id="a-reverse-the-flat-and-dark-correction">
<h3>5A. Reverse the flat and dark correction<a class="headerlink" href="#a-reverse-the-flat-and-dark-correction" title="Link to this heading">#</a></h3>
<p>First, calculate the total exposure time of the 47 Tuc image by combining the exposure time, flash time (if any), and 3 seconds of extra dark time to approximate instrument commanding overheads.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_stars_flc.fits&#39;</span><span class="p">)</span>

<span class="n">hdr</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

<span class="n">exptime</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">]</span>
<span class="n">flashtime</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;FLASHDUR&#39;</span><span class="p">]</span>
<span class="n">darktime</span> <span class="o">=</span> <span class="n">exptime</span> <span class="o">+</span> <span class="n">flashtime</span> <span class="o">+</span> <span class="mi">3</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we open the 47 Tuc image and obtain the <code class="docutils literal notranslate"><span class="pre">SCI</span></code> extensions of both CCDs. We multiply by the flat and scale the CTE-corrected dark by the total exposure time. We also run the scaled dark image through a Poisson sampler to include Poisson noise in the dark scene. We then add the dark current to the image. We save the result, which is now effectively a <code class="docutils literal notranslate"><span class="pre">blc_tmp</span></code> file. If the data are post-flashed, we also need to reverse the flash correction. We do this by multiplying the flash file by the flash duration, running it through a Poisson sampler, and adding it to the 47 Tuc image. The lines for this are commented out below. <strong>Note: It is not recommended to use a simulated exposure time that scales pixels in the dark or flash image to or above the full well depth of ~80,000 electrons.</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wfc1</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">wfc2</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="n">wfc1</span> <span class="o">*=</span> <span class="n">flat_wfc1</span>
<span class="n">wfc2</span> <span class="o">*=</span> <span class="n">flat_wfc2</span>

<span class="n">wfc1</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">dkc_wfc1</span><span class="o">*</span><span class="n">darktime</span><span class="p">)</span>
<span class="n">wfc2</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">dkc_wfc2</span><span class="o">*</span><span class="n">darktime</span><span class="p">)</span>

<span class="c1"># wfc1 += np.random.poisson(flash_wfc1*flashtime)</span>
<span class="c1"># wfc2 += np.random.poisson(flash_wfc2*flashtime)</span>

<span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_stars_pfl_dkc.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we update the header keyword <code class="docutils literal notranslate"><span class="pre">PCTECORR</span></code> to <code class="docutils literal notranslate"><span class="pre">PERFORM</span></code>, which is necessary for running the forward model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_stars_pfl_dkc.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;PCTECORR&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;PERFORM&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference internal" href="#title_ID"><span class="xref myst">Top of Page</span></a></p>
<p><a id="A6"></a></p>
</section>
<section id="a-run-cte-forward-model">
<h3>6A. Run CTE forward model<a class="headerlink" href="#a-run-cte-forward-model" title="Link to this heading">#</a></h3>
<p>We are now ready to run the CTE forward model, which simulates the effects of CTE losses while reading out the detector. In this example, we will use the <code class="docutils literal notranslate"><span class="pre">acstools</span></code> module <code class="docutils literal notranslate"><span class="pre">acscteforwardmodel</span></code>. Note that this step may take a few minutes. The resulting filename will be <code class="docutils literal notranslate"><span class="pre">*_ctefmod.fits</span></code>. We rename the file to have the suffix <code class="docutils literal notranslate"><span class="pre">*_blv_tmp.fits</span></code> so that it can be processed by <code class="docutils literal notranslate"><span class="pre">CALACS</span></code> in a later step.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">acscteforwardmodel</span><span class="o">.</span><span class="n">acscteforwardmodel</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_stars_pfl_dkc.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_stars_pfl_dkc_ctefmod.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;jd0q14ctq_stars_ctefmod_blv_tmp.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>After the forward model is run, the <code class="docutils literal notranslate"><span class="pre">SCI</span></code> extensions of the image are equivalent to a <code class="docutils literal notranslate"><span class="pre">blv_tmp</span></code> file, in principle. However, the <code class="docutils literal notranslate"><span class="pre">ERR</span></code> extensions are the original <code class="docutils literal notranslate"><span class="pre">flc</span></code> <code class="docutils literal notranslate"><span class="pre">ERR</span></code> extensions plus 10% of the forward model correction. To ensure the <code class="docutils literal notranslate"><span class="pre">ERR</span></code> extensions are accurate for a <code class="docutils literal notranslate"><span class="pre">blv_tmp</span></code> file, we will set every pixel to zero and calculate new values for each pixel according to</p>
<p>$\mathrm{ERR} = \sqrt{\mathrm{SCI} + \mathrm{RN}^2 + (\mathrm{ERR}_{\mathrm{superbias}}g)^2}$,</p>
<p>where $\mathrm{SCI}$ is the pixel value in the <code class="docutils literal notranslate"><span class="pre">SCI</span></code> extension (all negative pixels are set to zero), $\mathrm{RN}$ is the readnoise, $\mathrm{ERR}_{\mathrm{superbias}}$ is the pixel value in the <code class="docutils literal notranslate"><span class="pre">ERR</span></code> extension of the superbias, and $g$ is the gain.</p>
<p>First, we access the header and <code class="docutils literal notranslate"><span class="pre">SCI</span></code> and <code class="docutils literal notranslate"><span class="pre">ERR</span></code> extensions of the forward-modeled data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_stars_ctefmod_blv_tmp.fits&#39;</span><span class="p">)</span>

<span class="n">sci_wfc1</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">sci_wfc2</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="n">err_wfc1</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">err_wfc2</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="n">hdr</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we take the readnoise and gain values for each quadrant from the header.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rn_A</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;READNSEA&#39;</span><span class="p">]</span>
<span class="n">rn_B</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;READNSEB&#39;</span><span class="p">]</span>
<span class="n">rn_C</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;READNSEC&#39;</span><span class="p">]</span>
<span class="n">rn_D</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;READNSED&#39;</span><span class="p">]</span>

<span class="n">gain_A</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;ATODGNA&#39;</span><span class="p">]</span>
<span class="n">gain_B</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;ATODGNB&#39;</span><span class="p">]</span>
<span class="n">gain_C</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;ATODGNC&#39;</span><span class="p">]</span>
<span class="n">gain_D</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;ATODGND&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we make copies of the <code class="docutils literal notranslate"><span class="pre">SCI</span></code> extensions in which to set all negative values to zero. We calculate the appropriate error for each quadrant and save them to the <code class="docutils literal notranslate"><span class="pre">ERR</span></code> extensions of the forward-modeled image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sci_wfc1_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sci_wfc1</span><span class="p">)</span>
<span class="n">sci_wfc2_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sci_wfc2</span><span class="p">)</span>

<span class="n">sci_wfc1_pos</span><span class="p">[</span><span class="n">sci_wfc1_pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">sci_wfc2_pos</span><span class="p">[</span><span class="n">sci_wfc2_pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">err_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sci_wfc1_pos</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2048</span><span class="p">]</span> <span class="o">+</span> <span class="n">rn_A</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">err_bias_wfc1</span><span class="p">[</span><span class="mi">20</span><span class="p">:,</span> <span class="mi">24</span><span class="p">:</span><span class="mi">2072</span><span class="p">]</span><span class="o">*</span><span class="n">gain_A</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">err_B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sci_wfc1_pos</span><span class="p">[:,</span> <span class="mi">2048</span><span class="p">:]</span> <span class="o">+</span> <span class="n">rn_B</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">err_bias_wfc1</span><span class="p">[</span><span class="mi">20</span><span class="p">:,</span> <span class="mi">2072</span><span class="p">:</span><span class="o">-</span><span class="mi">24</span><span class="p">]</span><span class="o">*</span><span class="n">gain_B</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">err_C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sci_wfc2_pos</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2048</span><span class="p">]</span> <span class="o">+</span> <span class="n">rn_C</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">err_bias_wfc2</span><span class="p">[:</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">24</span><span class="p">:</span><span class="mi">2072</span><span class="p">]</span><span class="o">*</span><span class="n">gain_C</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">err_D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sci_wfc2_pos</span><span class="p">[:,</span> <span class="mi">2048</span><span class="p">:]</span> <span class="o">+</span> <span class="n">rn_D</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">err_bias_wfc2</span><span class="p">[:</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">2072</span><span class="p">:</span><span class="o">-</span><span class="mi">24</span><span class="p">]</span><span class="o">*</span><span class="n">gain_D</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="n">err_wfc1</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">err_A</span><span class="p">,</span> <span class="n">err_B</span><span class="p">))</span>
<span class="n">err_wfc2</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">err_C</span><span class="p">,</span> <span class="n">err_D</span><span class="p">))</span>

<span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_stars_ctefmod_blv_tmp.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference internal" href="#title_ID"><span class="xref myst">Top of Page</span></a></p>
<p><a id="A7"></a></p>
</section>
<section id="optional-7a-run-cte-correction">
<h3>(Optional) 7A. Run CTE correction<a class="headerlink" href="#optional-7a-run-cte-correction" title="Link to this heading">#</a></h3>
<p>If desired, we now CTE correct the forward-modeled image. To do this, we need to update the <code class="docutils literal notranslate"><span class="pre">PCTECORR</span></code> keyword to <code class="docutils literal notranslate"><span class="pre">PERFORM</span></code> again and update the <code class="docutils literal notranslate"><span class="pre">NEXTEND</span></code> keyword to 6, the number of extensions left after running the forward model.  (This is because the forward model strips the distortion-related extensions from the input file, but does not update <code class="docutils literal notranslate"><span class="pre">NEXTEND</span></code>.) Finally, run <code class="docutils literal notranslate"><span class="pre">acscte</span></code> on the image. The resulting filename will be <code class="docutils literal notranslate"><span class="pre">*_blc_tmp.fits</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_stars_ctefmod_blv_tmp.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;PCTECORR&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;PERFORM&#39;</span><span class="p">)</span>
<span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_stars_ctefmod_blv_tmp.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;NEXTEND&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

<span class="n">acscte</span><span class="o">.</span><span class="n">acscte</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_stars_ctefmod_blv_tmp.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a id="A8"></a></p>
</section>
<section id="a-apply-flat-and-dark-correction">
<h3>8A. Apply flat and dark correction<a class="headerlink" href="#a-apply-flat-and-dark-correction" title="Link to this heading">#</a></h3>
<p>Finally, we flat-field and dark-correct the forward-modeled image using <code class="docutils literal notranslate"><span class="pre">acs2d</span></code> to produce an <code class="docutils literal notranslate"><span class="pre">flt</span></code>-like image. First, we update the keywords <code class="docutils literal notranslate"><span class="pre">DARKCORR</span></code> and <code class="docutils literal notranslate"><span class="pre">FLATCORR</span></code> to <code class="docutils literal notranslate"><span class="pre">PERFORM</span></code>. All other relevant <code class="docutils literal notranslate"><span class="pre">CALACS</span></code> header keyword switches are set to <code class="docutils literal notranslate"><span class="pre">COMPLETE</span></code> because the original data was an <code class="docutils literal notranslate"><span class="pre">flc</span></code> image. The resulting filename will be <code class="docutils literal notranslate"><span class="pre">*_flt.fits</span></code>. <strong>Note:</strong> If the data were post-flashed, and the flash background was added back in during an earlier step, we must also set <code class="docutils literal notranslate"><span class="pre">FLSHCORR</span></code> equal to <code class="docutils literal notranslate"><span class="pre">PERFORM</span></code>. This option is shown below in a commented out line.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_stars_ctefmod_blv_tmp.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;DARKCORR&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;PERFORM&#39;</span><span class="p">)</span>
<span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_stars_ctefmod_blv_tmp.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;FLATCORR&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;PERFORM&#39;</span><span class="p">)</span>
<span class="c1"># fits.setval(&#39;jd0q14ctq_stars_ctefmod_blv_tmp.fits&#39;, &#39;FLSHCORR&#39;, value=&#39;PERFORM&#39;)</span>

<span class="n">acs2d</span><span class="o">.</span><span class="n">acs2d</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_stars_ctefmod_blv_tmp.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>If the forward-modeled image was CTE-corrected in <a class="reference internal" href="#A7"><span class="xref myst">Step 7A</span></a>, we run <code class="docutils literal notranslate"><span class="pre">acs2d</span></code> on the CTE-corrected image. The resulting filename will be <code class="docutils literal notranslate"><span class="pre">*_flc.fits</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_stars_ctefmod_blc_tmp.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;DARKCORR&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;PERFORM&#39;</span><span class="p">)</span>
<span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_stars_ctefmod_blc_tmp.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;FLATCORR&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;PERFORM&#39;</span><span class="p">)</span>
<span class="c1"># fits.setval(&#39;jd0q14ctq_stars_ctefmod_blv_tmp.fits&#39;, &#39;FLSHCORR&#39;, value=&#39;PERFORM&#39;)</span>

<span class="n">acs2d</span><span class="o">.</span><span class="n">acs2d</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_stars_ctefmod_blc_tmp.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The 47 Tuc image(s) are now prepared for further analysis appropriate for the user’s science. The cells below plot a portion of the final images, the <code class="docutils literal notranslate"><span class="pre">flt</span></code> and, if produced, the <code class="docutils literal notranslate"><span class="pre">flc</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flt_stars</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_stars_ctefmod_flt.fits&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">flt_stars</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> 
          <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;x_mean&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;y_mean&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> 
        <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2800</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">1700</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flc_stars</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_stars_ctefmod_flc.fits&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">flc_stars</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> 
          <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;x_mean&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;y_mean&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> 
        <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2800</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">1700</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference internal" href="#title_ID"><span class="xref myst">Top of Page</span></a></p>
<p><a id="option-b"></a></p>
</section>
<section id="option-b-start-with-a-synthetic-image">
<h3>Option B: Start with a synthetic image<a class="headerlink" href="#option-b-start-with-a-synthetic-image" title="Link to this heading">#</a></h3>
<p>In this Option, we start with the <code class="docutils literal notranslate"><span class="pre">raw</span></code> file from the <code class="docutils literal notranslate"><span class="pre">jd0q14ctq</span></code> dataset and process the <code class="docutils literal notranslate"><span class="pre">SCI</span></code> extensions to make a completely synthetic dataset. We then process it appropriately for use in the forward model.</p>
<p><a id="B4"></a></p>
</section>
<section id="b-create-a-synthetic-image">
<h3>4B. Create a synthetic image<a class="headerlink" href="#b-create-a-synthetic-image" title="Link to this heading">#</a></h3>
<p>We will create an image that is equivalent to a <code class="docutils literal notranslate"><span class="pre">blc_tmp</span></code> file. This means that the image is not flat-fielded and includes sky background, Poisson noise from the sky, artificial stars or other sources, Poisson noise from the sources, dark current, and dark noise.</p>
<p>We first process the data with <code class="docutils literal notranslate"><span class="pre">acsccd</span></code> within <code class="docutils literal notranslate"><span class="pre">acstools</span></code> to create a <code class="docutils literal notranslate"><span class="pre">blv_tmp</span></code>. This ensures that the error (<code class="docutils literal notranslate"><span class="pre">ERR</span></code>) and data quality (<code class="docutils literal notranslate"><span class="pre">DQ</span></code>) extensions are created and the header keywords for every extension are initially populated, which is necessary for the CTE forward model to run.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">acsccd</span><span class="o">.</span><span class="n">acsccd</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_raw.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we obtain the <code class="docutils literal notranslate"><span class="pre">SCI</span></code> extensions from the <code class="docutils literal notranslate"><span class="pre">blv_tmp</span></code> file, and set the pixels to zero.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;jd0q14ctq_blv_tmp.fits&#39;</span><span class="p">)</span>
    
<span class="n">wfc1</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">wfc2</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="n">wfc1</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
<span class="n">wfc2</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We then generate an image containing a user-selected sky background level (here we choose 40 electrons arbitrarily) and Poisson noise. Finally, we sum the noise image and the artificial star image, and save the result as a new file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">noise_image</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">make_noise_image</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">distribution</span><span class="o">=</span><span class="s1">&#39;poisson&#39;</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">12345</span><span class="p">)</span>

<span class="n">wfc1</span> <span class="o">+=</span> <span class="n">noise_image</span> <span class="o">+</span> <span class="n">synth_stars_image</span>
<span class="n">wfc2</span> <span class="o">+=</span> <span class="n">noise_image</span> <span class="o">+</span> <span class="n">synth_stars_image</span>

<span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s1">&#39;synth.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Below we plot a portion of the synthetic image, with sources circled in red.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">synth</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="s1">&#39;synth.fits&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">synth</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> 
          <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;x_mean&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;y_mean&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> 
        <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2800</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">1700</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>In order to properly remove the dark current after the forward model is run, we update the exposure time and flash duration header keywords, <code class="docutils literal notranslate"><span class="pre">EXPTIME</span></code> and <code class="docutils literal notranslate"><span class="pre">FLASHDUR</span></code>, with the desired simulated exposure time. The total exposure time used for the dark correction is the combination of exposure time, flash duration, and overhead (which depends on whether the data are post-flashed or not). Here we set <code class="docutils literal notranslate"><span class="pre">EXPTIME</span></code> to 300 seconds and <code class="docutils literal notranslate"><span class="pre">FLASHDUR</span></code> to 0 seconds. In principle one should retrieve the overheads from CCDTAB, but we provide a simpler approach here. Please note that the overhead times may change.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exptime</span> <span class="o">=</span> <span class="mf">300.</span>
<span class="n">flashdur</span> <span class="o">=</span> <span class="mf">0.</span>

<span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;synth.fits&#39;</span><span class="p">)</span>

<span class="n">hdr</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

<span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exptime</span>
<span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;FLASHDUR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flashdur</span>

<span class="k">if</span> <span class="n">flashdur</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">overhead</span> <span class="o">=</span> <span class="mf">2.43</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">overhead</span> <span class="o">=</span> <span class="mf">0.21</span>

<span class="n">darktime</span> <span class="o">=</span> <span class="n">exptime</span> <span class="o">+</span> <span class="n">flashdur</span> <span class="o">+</span> <span class="n">overhead</span>
</pre></div>
</div>
</div>
</div>
<p>We need to update the FITS header with the correct dark time for use in a later step. <strong>However, we leave off the overhead, because ACSCCD (run in a later step) will automatically append the overhead to the dark time in the header.</strong> We still use the darktime variable with overhead to manually add the dark current to our model below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;DARKTIME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">darktime</span> <span class="o">-</span> <span class="n">overhead</span>
</pre></div>
</div>
</div>
</div>
<p>Next, obtain the <code class="docutils literal notranslate"><span class="pre">SCI</span></code> extensions of both CCDs. We then multiply by the flat and scale the CTE-corrected dark by a chosen exposure time. We also run the scaled dark image through a Poisson sampler to include Poisson noise in the dark scene. We then add the dark current to the image. If post-flash is desired, multiply the flash reference file by the flash duration, run it through a Poisson sampler, and add to the synthetic data. This is shown in the commented out lines below. We save the result, which is now effectively a <code class="docutils literal notranslate"><span class="pre">blc_tmp</span></code> file. <strong>Note: It is not recommended to use a simulated exposure time that scales pixels in the dark or flash image to or above the full well depth of ~80,000 electrons.</strong></p>
<p>Note that these reference files are specific to the anneal cycle in which these data were taken. If an observation date other than that listed in the <code class="docutils literal notranslate"><span class="pre">DATE-OBS</span></code> header keyword is desired for the synthetic data, different reference files will be needed. These can be found by updating the <code class="docutils literal notranslate"><span class="pre">DATE-OBS</span></code> header keyword in the synthetic image to the desired observation date, and rerunning the cell in <a class="reference internal" href="#download"><span class="xref myst">Step 2</span></a> which uses <code class="docutils literal notranslate"><span class="pre">CRDS</span> <span class="pre">bestrefs</span></code> to download the correct reference files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wfc1</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">wfc2</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="n">wfc1</span> <span class="o">*=</span> <span class="n">flat_wfc1</span>
<span class="n">wfc2</span> <span class="o">*=</span> <span class="n">flat_wfc2</span>

<span class="n">wfc1</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">dkc_wfc1</span><span class="o">*</span><span class="n">darktime</span><span class="p">)</span>
<span class="n">wfc2</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">dkc_wfc2</span><span class="o">*</span><span class="n">darktime</span><span class="p">)</span>

<span class="c1"># wfc1 += np.random.poisson(flash_wfc1*flashdur)</span>
<span class="c1"># wfc2 += np.random.poisson(flash_wfc2*flashdur)</span>

<span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s1">&#39;synth_blc_tmp.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference internal" href="#title_ID"><span class="xref myst">Top of Page</span></a></p>
<p><a id="B5"></a></p>
</section>
<section id="b-run-cte-forward-model">
<h3>5B. Run CTE forward model<a class="headerlink" href="#b-run-cte-forward-model" title="Link to this heading">#</a></h3>
<p>We are now ready to run the CTE forward model, which simulates the effects of CTE losses while reading out the detector. In this example, we will use the <code class="docutils literal notranslate"><span class="pre">acstools</span></code> module <code class="docutils literal notranslate"><span class="pre">acscteforwardmodel</span></code>. Note that this step may take a few minutes. The resulting filename will be <code class="docutils literal notranslate"><span class="pre">*_ctefmod.fits</span></code>. We rename this to <code class="docutils literal notranslate"><span class="pre">*_blv_tmp.fits</span></code> in order to ensure the correct behavior from <code class="docutils literal notranslate"><span class="pre">acs2d</span></code> in a later step.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">acscteforwardmodel</span><span class="o">.</span><span class="n">acscteforwardmodel</span><span class="p">(</span><span class="s1">&#39;synth_blc_tmp.fits&#39;</span><span class="p">)</span>

<span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;synth_blc_tmp_ctefmod.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;synth_ctefmod_blv_tmp.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>At this point, we also add readnoise to the forward-modeled <code class="docutils literal notranslate"><span class="pre">SCI</span></code> extensions to complete the readout simulation. We find the readnoise values for each quadrant of the image from the header keywords <code class="docutils literal notranslate"><span class="pre">READNSEA</span></code>, <code class="docutils literal notranslate"><span class="pre">READNSEB</span></code>, etc. We make a noise image for each quadrant, concatenate quadrants A and B and quadrants C and D, and add them to the synthetic image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rn_A</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;READNSEA&#39;</span><span class="p">]</span>
<span class="n">rn_B</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;READNSEB&#39;</span><span class="p">]</span>
<span class="n">rn_C</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;READNSEC&#39;</span><span class="p">]</span>
<span class="n">rn_D</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;READNSED&#39;</span><span class="p">]</span>

<span class="n">img_rn_A</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">make_noise_image</span><span class="p">((</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)),</span> <span class="n">distribution</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> 
                                     <span class="n">mean</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="n">rn_A</span><span class="p">)</span>
<span class="n">img_rn_B</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">make_noise_image</span><span class="p">((</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)),</span> <span class="n">distribution</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> 
                                     <span class="n">mean</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="n">rn_B</span><span class="p">)</span>
<span class="n">img_rn_C</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">make_noise_image</span><span class="p">((</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)),</span> <span class="n">distribution</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> 
                                     <span class="n">mean</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="n">rn_C</span><span class="p">)</span>
<span class="n">img_rn_D</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">make_noise_image</span><span class="p">((</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)),</span> <span class="n">distribution</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> 
                                     <span class="n">mean</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="n">rn_D</span><span class="p">)</span>

<span class="n">wfc1_rn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">img_rn_A</span><span class="p">,</span> <span class="n">img_rn_B</span><span class="p">))</span>
<span class="n">wfc2_rn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">img_rn_C</span><span class="p">,</span> <span class="n">img_rn_D</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;synth_ctefmod_blv_tmp.fits&#39;</span><span class="p">)</span>

<span class="n">wfc1</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">wfc2</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="n">wfc1</span> <span class="o">+=</span> <span class="n">wfc1_rn</span>
<span class="n">wfc2</span> <span class="o">+=</span> <span class="n">wfc2_rn</span>

<span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s1">&#39;synth_ctefmod_rn_blv_tmp.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">SCI</span></code> extensions of this image are now equivalent to a <code class="docutils literal notranslate"><span class="pre">blv_tmp</span></code> file, in principle. However, the <code class="docutils literal notranslate"><span class="pre">ERR</span></code> extensions are the original <code class="docutils literal notranslate"><span class="pre">blv_tmp</span></code> <code class="docutils literal notranslate"><span class="pre">ERR</span></code> extensions plus 10% of the forward model correction. To ensure the <code class="docutils literal notranslate"><span class="pre">ERR</span></code> extensions are accurate, we will calculate new values for each pixel according to</p>
<p>$\mathrm{ERR} = \sqrt{\mathrm{SCI} + \mathrm{RN}^2 + (\mathrm{ERR}_{\mathrm{superbias}}g)^2}$,</p>
<p>where $\mathrm{SCI}$ is the pixel value in the <code class="docutils literal notranslate"><span class="pre">SCI</span></code> extension (all negative pixels are set to zero), $\mathrm{RN}$ is the readnoise, $\mathrm{ERR}_{\mathrm{superbias}}$ is the pixel value in the <code class="docutils literal notranslate"><span class="pre">ERR</span></code> extension of the superbias, and $g$ is the gain.</p>
<p>First, we access the header and <code class="docutils literal notranslate"><span class="pre">SCI</span></code> and <code class="docutils literal notranslate"><span class="pre">ERR</span></code> extensions of the forward-modeled data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;synth_ctefmod_rn_blv_tmp.fits&#39;</span><span class="p">)</span>

<span class="n">sci_wfc1</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">sci_wfc2</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="n">err_wfc1</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">err_wfc2</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="n">hdr</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we take the readnoise and gain values for each quadrant from the header.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rn_A</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;READNSEA&#39;</span><span class="p">]</span>
<span class="n">rn_B</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;READNSEB&#39;</span><span class="p">]</span>
<span class="n">rn_C</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;READNSEC&#39;</span><span class="p">]</span>
<span class="n">rn_D</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;READNSED&#39;</span><span class="p">]</span>

<span class="n">gain_A</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;ATODGNA&#39;</span><span class="p">]</span>
<span class="n">gain_B</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;ATODGNB&#39;</span><span class="p">]</span>
<span class="n">gain_C</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;ATODGNC&#39;</span><span class="p">]</span>
<span class="n">gain_D</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;ATODGND&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we make copies of the <code class="docutils literal notranslate"><span class="pre">SCI</span></code> extensions in which to set all negative values to zero. We calculate the appropriate error for each quadrant and save them to the <code class="docutils literal notranslate"><span class="pre">ERR</span></code> extensions of the forward-modeled image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sci_wfc1_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sci_wfc1</span><span class="p">)</span>
<span class="n">sci_wfc2_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sci_wfc2</span><span class="p">)</span>

<span class="n">sci_wfc1_pos</span><span class="p">[</span><span class="n">sci_wfc1_pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">sci_wfc2_pos</span><span class="p">[</span><span class="n">sci_wfc2_pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># The superbias ERR arrays contain 20 rows of virtual overscan at the edge of </span>
<span class="c1"># each CCD furthest from the amplifier and 24 columns of physical prescan on the</span>
<span class="c1"># left and right edges.</span>
<span class="n">err_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sci_wfc1_pos</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2048</span><span class="p">]</span> <span class="o">+</span> <span class="n">rn_A</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">err_bias_wfc1</span><span class="p">[</span><span class="mi">20</span><span class="p">:,</span> <span class="mi">24</span><span class="p">:</span><span class="mi">2072</span><span class="p">]</span><span class="o">*</span><span class="n">gain_A</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">err_B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sci_wfc1_pos</span><span class="p">[:,</span> <span class="mi">2048</span><span class="p">:]</span> <span class="o">+</span> <span class="n">rn_B</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">err_bias_wfc1</span><span class="p">[</span><span class="mi">20</span><span class="p">:,</span> <span class="mi">2072</span><span class="p">:</span><span class="o">-</span><span class="mi">24</span><span class="p">]</span><span class="o">*</span><span class="n">gain_B</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">err_C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sci_wfc2_pos</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2048</span><span class="p">]</span> <span class="o">+</span> <span class="n">rn_C</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">err_bias_wfc2</span><span class="p">[:</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">24</span><span class="p">:</span><span class="mi">2072</span><span class="p">]</span><span class="o">*</span><span class="n">gain_C</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">err_D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sci_wfc2_pos</span><span class="p">[:,</span> <span class="mi">2048</span><span class="p">:]</span> <span class="o">+</span> <span class="n">rn_D</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">err_bias_wfc2</span><span class="p">[:</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">2072</span><span class="p">:</span><span class="o">-</span><span class="mi">24</span><span class="p">]</span><span class="o">*</span><span class="n">gain_D</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="n">err_wfc1</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">err_A</span><span class="p">,</span> <span class="n">err_B</span><span class="p">))</span>
<span class="n">err_wfc2</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">err_C</span><span class="p">,</span> <span class="n">err_D</span><span class="p">))</span>

<span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s1">&#39;synth_ctefmod_rn_blv_tmp.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We also repopulate the DQ extensions because they reflect the processing of the original <code class="docutils literal notranslate"><span class="pre">blv_tmp</span></code> <code class="docutils literal notranslate"><span class="pre">SCI</span></code> extensions. To do this, we reprocess the data with <code class="docutils literal notranslate"><span class="pre">DQICORR</span></code> and <code class="docutils literal notranslate"><span class="pre">SINKCORR</span></code>, both within <code class="docutils literal notranslate"><span class="pre">acsccd</span></code>, and add in the DQ extensions of the appropriate superbias file. First, we rename the synthetic image to have a filename <code class="docutils literal notranslate"><span class="pre">*_raw.fits</span></code>, or <code class="docutils literal notranslate"><span class="pre">acsccd</span></code> will fail. Then, we update the <code class="docutils literal notranslate"><span class="pre">DQICORR</span></code> and <code class="docutils literal notranslate"><span class="pre">SINKCORR</span></code> header keywords to <code class="docutils literal notranslate"><span class="pre">PERFORM</span></code> and run <code class="docutils literal notranslate"><span class="pre">acsccd</span></code>. The output will be <code class="docutils literal notranslate"><span class="pre">*_blv_tmp.fits</span></code> again.</p>
<p>This step will also add the proper overhead to <code class="docutils literal notranslate"><span class="pre">DARKTIME</span></code> header keyword, but only if using CALACS v10.3.3 or later. We first check the version.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;calacs.e --version&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>If your version of CALCACS is prior to v10.3.3, please update. Now let’s run ACSCCD.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;synth_ctefmod_rn_blv_tmp.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;synth_ctefmod_rn_raw.fits&#39;</span><span class="p">)</span>

<span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="s1">&#39;synth_ctefmod_rn_raw.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;DQICORR&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;PERFORM&#39;</span><span class="p">)</span>
<span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="s1">&#39;synth_ctefmod_rn_raw.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;SINKCORR&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;PERFORM&#39;</span><span class="p">)</span>

<span class="n">acsccd</span><span class="o">.</span><span class="n">acsccd</span><span class="p">(</span><span class="s1">&#39;synth_ctefmod_rn_raw.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, obtain the DQ extensions of the superbias file, and add them to the new DQ extensions of the synthetic data with a <code class="docutils literal notranslate"><span class="pre">bitwise_or</span></code> operator.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;synth_ctefmod_rn_blv_tmp.fits&#39;</span><span class="p">)</span>

<span class="n">dq_wfc1</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">dq_wfc2</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="n">dq_wfc1</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_or</span><span class="p">(</span><span class="n">dq_wfc1</span><span class="p">,</span> <span class="n">dq_bias_wfc1</span><span class="p">[</span><span class="mi">20</span><span class="p">:,</span> <span class="mi">24</span><span class="p">:</span><span class="o">-</span><span class="mi">24</span><span class="p">])</span>
<span class="n">dq_wfc2</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_or</span><span class="p">(</span><span class="n">dq_wfc2</span><span class="p">,</span> <span class="n">dq_bias_wfc2</span><span class="p">[:</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">24</span><span class="p">:</span><span class="o">-</span><span class="mi">24</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Also, acsccd assumes the input image is in DN and converts it to counts by multiplying by the gain. We defined our model in electrons though, so the acsccd conversion to electrons was unnecessary. We divide by the gains to fix this and replace the image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sci_wfc1</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">sci_wfc2</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="n">sci_wfc1</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2048</span><span class="p">]</span> <span class="o">/=</span> <span class="n">gain_A</span>
<span class="n">sci_wfc1</span><span class="p">[:,</span> <span class="mi">2048</span><span class="p">:]</span> <span class="o">/=</span> <span class="n">gain_B</span>
<span class="n">sci_wfc2</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2048</span><span class="p">]</span> <span class="o">/=</span> <span class="n">gain_C</span>
<span class="n">sci_wfc2</span><span class="p">[:,</span> <span class="mi">2048</span><span class="p">:]</span> <span class="o">/=</span> <span class="n">gain_D</span>

<span class="n">err_wfc1</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">err_wfc2</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="n">err_wfc1</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2048</span><span class="p">]</span> <span class="o">/=</span> <span class="n">gain_A</span>
<span class="n">err_wfc1</span><span class="p">[:,</span> <span class="mi">2048</span><span class="p">:]</span> <span class="o">/=</span> <span class="n">gain_B</span>
<span class="n">err_wfc2</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2048</span><span class="p">]</span> <span class="o">/=</span> <span class="n">gain_C</span>
<span class="n">err_wfc2</span><span class="p">[:,</span> <span class="mi">2048</span><span class="p">:]</span> <span class="o">/=</span> <span class="n">gain_D</span>

<span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s1">&#39;synth_ctefmod_rn_blv_tmp.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference internal" href="#title_ID"><span class="xref myst">Top of Page</span></a></p>
<p><a id="B6"></a></p>
</section>
<section id="b-optional-run-cte-correction">
<h3>6B. (Optional) Run CTE correction<a class="headerlink" href="#b-optional-run-cte-correction" title="Link to this heading">#</a></h3>
<p>If desired, we now CTE correct the forward-modeled image. To do this, we need to update the <code class="docutils literal notranslate"><span class="pre">PCTECORR</span></code> keyword to <code class="docutils literal notranslate"><span class="pre">PERFORM</span></code> again, and run <code class="docutils literal notranslate"><span class="pre">acscte</span></code> on the image. The resulting filename will be <code class="docutils literal notranslate"><span class="pre">*_blc_tmp.fits</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="s1">&#39;synth_ctefmod_rn_blv_tmp.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;PCTECORR&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;PERFORM&#39;</span><span class="p">)</span>

<span class="n">acscte</span><span class="o">.</span><span class="n">acscte</span><span class="p">(</span><span class="s1">&#39;synth_ctefmod_rn_blv_tmp.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a id="B7"></a></p>
</section>
<section id="b-apply-flat-and-dark-correction">
<h3>7B. Apply flat and dark correction<a class="headerlink" href="#b-apply-flat-and-dark-correction" title="Link to this heading">#</a></h3>
<p>Finally, we flat-field and dark-correct the forward-modeled image using <code class="docutils literal notranslate"><span class="pre">acs2d</span></code> to produce an <code class="docutils literal notranslate"><span class="pre">flt</span></code>-like image. We first ensure that the <code class="docutils literal notranslate"><span class="pre">DARKCORR</span></code>, <code class="docutils literal notranslate"><span class="pre">FLATCORR</span></code>, and if necessary, <code class="docutils literal notranslate"><span class="pre">FLSHCORR</span></code> header keywords are set to <code class="docutils literal notranslate"><span class="pre">PERFORM</span></code>. The resulting filename will be <code class="docutils literal notranslate"><span class="pre">*_flt.fits</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="s1">&#39;synth_ctefmod_rn_blv_tmp.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;DARKCORR&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;PERFORM&#39;</span><span class="p">)</span>
<span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="s1">&#39;synth_ctefmod_rn_blv_tmp.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;FLATCORR&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;PERFORM&#39;</span><span class="p">)</span>
<span class="c1"># fits.setval(&#39;synth_ctefmod_rn_blv_tmp.fits&#39;, &#39;FLSHCORR&#39;, value=&#39;PERFORM&#39;)</span>

<span class="n">acs2d</span><span class="o">.</span><span class="n">acs2d</span><span class="p">(</span><span class="s1">&#39;synth_ctefmod_rn_blv_tmp.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>If the forward-modeled image was CTE-corrected in <a class="reference internal" href="#B6"><span class="xref myst">Step 6</span></a>, we run <code class="docutils literal notranslate"><span class="pre">acs2d</span></code> on the CTE-corrected image. The resulting filename will be <code class="docutils literal notranslate"><span class="pre">*_flc.fits</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="s1">&#39;synth_ctefmod_rn_blc_tmp.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;DARKCORR&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;PERFORM&#39;</span><span class="p">)</span>
<span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="s1">&#39;synth_ctefmod_rn_blc_tmp.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;FLATCORR&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;PERFORM&#39;</span><span class="p">)</span>
<span class="c1"># fits.setval(&#39;synth_ctefmod_rn_blc_tmp.fits&#39;, &#39;FLSHCORR&#39;, value=&#39;PERFORM&#39;)</span>

<span class="n">acs2d</span><span class="o">.</span><span class="n">acs2d</span><span class="p">(</span><span class="s1">&#39;synth_ctefmod_rn_blc_tmp.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The image(s) are now prepared for further analysis appropriate for the user’s science. The cells below plot a portion of the final images, the <code class="docutils literal notranslate"><span class="pre">flt</span></code> and, if produced, the <code class="docutils literal notranslate"><span class="pre">flc</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">synth_ctefmod</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="s1">&#39;synth_ctefmod_rn_flt.fits&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">synth_ctefmod</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> 
          <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;x_mean&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;y_mean&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> 
        <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2800</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">1700</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">synth_ctefmod_flc</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="s1">&#39;synth_ctefmod_rn_flc.fits&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">synth_ctefmod_flc</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> 
          <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;x_mean&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;y_mean&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> 
        <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2800</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">1700</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="for-more-help">
<h3>For more help:<a class="headerlink" href="#for-more-help" title="Link to this heading">#</a></h3>
<p>More details may be found on the <a class="reference external" href="http://www.stsci.edu/hst/instrumentation/acs">ACS website</a> and in the <a class="reference external" href="https://hst-docs.stsci.edu/display/ACSIHB">ACS Instrument</a> and <a class="reference external" href="http://www.stsci.edu/files/live/sites/www/files/home/hst/instrumentation/acs/documentation/other-documents/_documents/acs_dhb.pdf">Data Handbooks</a>.</p>
<p>Please visit the <a class="reference external" href="http://hsthelp.stsci.edu">HST Help Desk</a>. Through the help desk portal, you can explore the HST Knowledge Base and request additional help from experts.</p>
<p><a id="about_ID"></a></p>
</section>
<section id="about-this-notebook">
<h3>About this Notebook<a class="headerlink" href="#about-this-notebook" title="Link to this heading">#</a></h3>
<p><strong>Author:</strong> Jenna Ryon, ACS Instrument Team <br>
<strong>Updated On:</strong> 04/21/2022</p>
<hr class="docutils" />
<p><a class="reference internal" href="#title_ID"><span class="xref myst">Top of Page</span></a>
<a class="reference internal" href="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png"><img alt="Space Telescope Logo" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="width: 200px;" /></a>
<br></br>
<br></br></p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/hst_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/ACS/acs_cte_forward_model"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../acs_saturation_trails/acs_saturation_trails.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">ACS Linearity with Saturated Stars</p>
      </div>
    </a>
    <a class="right-next"
       href="../acs_subarrays/acs_subarrays.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">ACS Image Reduction for Subarray Data</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#install-update-stenv">0. Install/update stenv</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#astroconda-is-no-longer-supported-and-is-superseded-by-stenv">*AstroConda is no longer supported and is superseded by stenv.</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">1. Imports</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#download-data-and-reference-files">2. Download data and reference files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-image-of-artificial-stars">3. Create image of artificial stars</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#option-a-start-with-an-observed-flc-image">Option A: Start with an observed FLC image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-add-artificial-stars">4A. Add artificial stars</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-reverse-the-flat-and-dark-correction">5A. Reverse the flat and dark correction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-run-cte-forward-model">6A. Run CTE forward model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-7a-run-cte-correction">(Optional) 7A. Run CTE correction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-apply-flat-and-dark-correction">8A. Apply flat and dark correction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#option-b-start-with-a-synthetic-image">Option B: Start with a synthetic image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-create-a-synthetic-image">4B. Create a synthetic image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-run-cte-forward-model">5B. Run CTE forward model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-optional-run-cte-correction">6B. (Optional) Run CTE correction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-apply-flat-and-dark-correction">7B. Apply flat and dark correction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#for-more-help">For more help:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>