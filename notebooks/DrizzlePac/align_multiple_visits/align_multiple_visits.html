

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Optimizing Image Alignment for Multiple HST Visits &#8212; HST Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/table.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/DrizzlePac/align_multiple_visits/align_multiple_visits';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="TWEAKREG Tips - Using DS9 Regions for Source Inclusion/Exclusion" href="../use_ds9_regions_in_tweakreg/use_ds9_regions_in_tweakreg.html" />
    <link rel="prev" title="Aligning Deep Exposures of Sparse Fields" href="../align_sparse_fields/align_sparse_fields.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="HST Notebooks - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="HST Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../index.html">
                    STScI HST Notebook Repository HQ
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">ACS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../ACS/README.html">ACS Notebooks</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_findsat_mrt/acs_findsat_mrt_example.html">Satellite trail detection in ACS/WFC data using acstools.findsat_mrt</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_saturation_trails/acs_saturation_trails.html">ACS Linearity with Saturated Stars</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_cte_forward_model/acs_cte_forward_model_example.html">Pixel-based ACS/WFC CTE Forward Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_subarrays/acs_subarrays.html">ACS Image Reduction for Subarray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_sbc_dark_analysis/acs_sbc_dark_analysis.html">SBC Dark Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_reduction/acs_reduction.html">ACS/WFC Image Reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_pixel_area_maps/acs_pixel_area_maps.html">Obtaining Pixel Area Maps for ACS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_polarization_tools/acs_polarization_tools.html">Using ACS Polarization Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_focus_diverse_epsfs/acs_focus_diverse_epsfs.html">Focus Diverse ePSFs for ACS/WFC</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">COS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../COS/README.html">COS Notebooks</a></li>



<li class="toctree-l1"><a class="reference internal" href="../../COS/Setup/Setup.html">Setting up your computer environment for working with COS data</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/DataDl/DataDl.html">Downloading COS Data</a></li>




<li class="toctree-l1"><a class="reference internal" href="../../COS/ViewData/ViewData.html">Viewing COS Data</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/AsnFile/AsnFile.html">Modifying or Creating an Association File</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/CalCOS/CalCOS.html">Running the COS Data Pipeline (<code class="docutils literal notranslate"><span class="pre">CalCOS</span></code>)</a></li>






<li class="toctree-l1"><a class="reference internal" href="../../COS/SplitTag/SplitTag.html">Splitting COS Exposures into sub-exposures with <code class="docutils literal notranslate"><span class="pre">splittag</span></code></a></li>







<li class="toctree-l1"><a class="reference internal" href="../../COS/DayNight/DayNight.html">Filtering out COS Data taken during the Day or Night</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../COS/LSF/LSF.html">Working with the COS Line Spread Function (LSF)</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../COS/Extract/Extract.html">Editing the extraction boxes in a spectral extraction file (<code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>)</a></li>







<li class="toctree-l1"><a class="reference internal" href="../../COS/ExceptionReport/ExceptionReport.html">What to do when you get an Exception Report for COS</a></li>







</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">DrizzlePac</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../README.html">DrizzlePac Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_updated_astrometry_solutions/using_updated_astrometry_solutions.html">Improving Astrometry Using Alternate WCS Solutions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../align_to_catalogs/align_to_catalogs.html">Aligning HST images to an Absolute Reference Catalog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../align_sparse_fields/align_sparse_fields.html">Aligning Deep Exposures of Sparse Fields</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Optimizing Image Alignment for Multiple HST Visits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use_ds9_regions_in_tweakreg/use_ds9_regions_in_tweakreg.html">TWEAKREG Tips - Using DS9 Regions for Source Inclusion/Exclusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimize_image_sampling/optimize_image_sampling.html">Optimizing the Image Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../align_mosaics/align_mosaics.html">Aligning HST Mosaics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sky_matching/sky_matching.html">Sky Matching for HST Mosaics <a id="top"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../mask_satellite/mask_satellite.html">Satellite Trail Masking Techniques</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">HASP</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../HASP/Setup/Setup.html">Installing the Hubble Advanced Spectral Products Script</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../HASP/CoaddTutorial/CoaddTutorial.html">Inputting User Data using the Hubble Advanced Spectral Products Script</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../HASP/FluxScaleTutorial/FluxScaleTutorial.html">Scaling Flux while using the Hubble Advanced Spectral Products Script</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../HASP/DataDiagnostic/DataDiagnostics.html">HASP Data Diagnostic Notebook</a></li>




<li class="toctree-l1"><a class="reference internal" href="../../HASP/WavelengthAdjustment/WavelengthAdjustment.html">Wavelength Adjustments for Running the Hubble Advanced Spectral Products (HASP) Script</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NICMOS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NICMOS/nicmos_unit_conversion/nicmos_unit_conversion.html">Programmatic Replacements for NICMOS Units Conversion Form</a></li>


</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">STIS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../STIS/README.html">STIS-Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/cross-correlation/cross-correlation.html">Correcting for Missing Wavecals with Cross-Correlation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/custom_ccd_darks/custom_ccd_darks.html">Custom CCD Darks <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/drizpac_notebook/STIS_DrizzlePac_Tutorial.html">STIS DrizzlePac Tutorial <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/CoronagraphyViz/STIS_Coronagraphy_Visualization_v2.html">STIS Coronagraphy Visualization Tool (v2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/calstis/calstis_2d_ccd.html">Calstis 2-D CCD Data Reduction <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/target_acquisition/target_acquisition.html">Evaluating STIS Target Acquisitions <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/view_data/view_data.html">Viewing STIS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/extraction/1D_Extraction.html">1D Spectra Extraction <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/low_count_uncertainties/Low_Count_Uncertainties.html">Low Count Uncertainties in STIS <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/contrast_sensitivity/STIS_Coronagraphic_Observation_Feasibility.html">STIS Coronagraphic Observation Feasibility</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">WFC3</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/README.html">WFC3 Notebooks</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../WFC3/general_tools.html">General Tools</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/image_displayer_analyzer/wfc3_image_displayer_analyzer.html">WFC3 Image Displayer &amp; Analyzer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/exception_report/wfc3_exception_report.html">Exception Report Checklist - WFC3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/calwf3_v1.0_cte/calwf3_with_v1.0_PCTE.html">Processing WFC3/UVIS Data with <code class="docutils literal notranslate"><span class="pre">calwf3</span></code> Using the v1.0 CTE-Correction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/persistence/wfc3_ir_persistence.html">Masking Persistence in WFC3/IR Images</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../WFC3/ir_tvb.html">WFC3/IR Time Variable Background (TVB)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/ir_ima_visualization/IR_IMA_Visualization_with_an_Example_of_Time_Variable_Background.html">WFC3/IR IMA Visualization Tools with An Example of Time Variable Background</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/calwf3_recalibration/calwf3_recal_tvb.html">Manual Recalibration with calwf3: Turning off the IR Linear Ramp Fit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/tvb_flattenramp/TVB_flattenramp_notebook.html">Correcting for Helium Line Emission Background in IR Exposures using the “Flatten-Ramp” Technique</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/ir_scattered_light_calwf3_corrections/Correcting_for_Scattered_Light_in_IR_Exposures_Using_calwf3_to_Mask_Bad_Reads.html">Correcting for Scattered Light in WFC3/IR Exposures: Using <code class="docutils literal notranslate"><span class="pre">calwf3</span></code> to Mask Bad Reads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/ir_scattered_light_manual_corrections/Correcting_for_Scattered_Light_in_IR_Exposures_by_Manually_Subtracting_Bad_Reads.html">Correcting for Scattered Light in WFC3/IR Exposures: Manually Subtracting Bad Reads</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../WFC3/photometry.html">Photometry</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/filter_transformations/filter_transformations.html">WFC3/UVIS Filter Transformations with stsynphot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/flux_conversion_tool/flux_conversion_tool.html">Flux Unit Conversions with synphot and stsynphot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/photometry_examples/phot_examples.html">Synthetic Photometry Examples for WFC3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/uvis_time_dependent_photometry/uvis_timedep_phot.html">WFC3/UVIS Time-dependent Photometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/zeropoints/zeropoints.html">Calculating WFC3 Zeropoints with STSynphot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/uvis_pam_corrections/WFC3_UVIS_Pixel_Area_Map_Corrections_for_Subarrays.html">WFC3/UVIS Pixel Area Map Corrections for Subarrays</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../WFC3/point_spread_function.html">Point Spread Function (PSF)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/point_spread_function/hst_point_spread_function.html">HST WFC3 Point Spread Function Modeling   </a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/mast_api_psf/download_psf_cutouts.html">Downloading WFC3 and WFPC2 PSF Cutouts from MAST</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/spacetelescope/hst_notebooks/blob/main/notebooks/DrizzlePac/align_multiple_visits/align_multiple_visits.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/hst_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/hst_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/DrizzlePac/align_multiple_visits/align_multiple_visits.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/DrizzlePac/align_multiple_visits/align_multiple_visits.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Optimizing Image Alignment for Multiple HST Visits</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-a-id-intro-a">Introduction <a id="intro"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#download-the-observations-with-astroquery-a-id-download-a">1. Download the Observations with <code class="docutils literal notranslate"><span class="pre">astroquery</span></code> <a id="download"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-image-header-data-a-id-check-keywords-a">1.1 Check image header data <a id="check_keywords"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inspect-the-alignment-a-id-check-wcs-a">1.2 Inspect the Alignment <a id="check_wcs"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#align-with-tweakreg-a-id-tweakreg-a">2. Align with <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> <a id="tweakreg"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#first-test-use-default-parameters-a-id-default-a">2.1 First test: Use ‘default’ parameters. <a id="default"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#second-test-set-parameters-for-source-finding-a-id-sources-a">2.2 Second test: Set parameters for source finding <a id="sources"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inspect-the-quality-of-the-fit-a-id-fit-quality-a">2.3 Inspect the quality of the fit <a id="fit_quality"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fourth-test-adjust-the-fitgeometry-a-id-fit-geom-a">2.4 Fourth test: Adjust the <code class="docutils literal notranslate"><span class="pre">fitgeometry</span></code> <a id="fit_geom"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#overplot-matched-sources-on-the-image-a-id-overplot-a">2.5 Overplot Matched Sources on the Image <a id="overplot"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#update-header-once-optimal-parameters-are-found-a-id-updatehdr-a">2.6 Update header once optimal parameters are found  <a id="updatehdr"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#combine-the-images-using-astrodrizzle-a-id-adriz-a">3. Combine the Images using <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> <a id="adriz"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inspect-the-drizzled-science-image-a-id-science-a">3.1 Inspect the drizzled science image <a id="science"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inspect-the-final-weight-image-a-id-wht-a">3.2 Inspect the final weight image <a id="wht"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discussion-of-astrodrizzle-and-summary-a-id-discussion-a">3.3 Discussion of AstroDrizzle and Summary <a id="discussion"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-resources-a-id-add-a">Additional Resources <a id="add"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#citations-a-id-cite-a">Citations <a id="cite"></a></a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="optimizing-image-alignment-for-multiple-hst-visits">
<h1>Optimizing Image Alignment for Multiple HST Visits<a class="headerlink" href="#optimizing-image-alignment-for-multiple-hst-visits" title="Permalink to this heading">#</a></h1>
<div class="alert alert-block alert-warning" style="color:black" > <b> This notebook requires creating and activating a virtual environment using the requirements file in this notebook's repository. Please also review the README file before using the notebook.</b> <br> </div><p><a id="toc"></a></p>
<section id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Introduction</span> <br></p>
<p><span class="xref myst">1. Download the Observations with <code class="docutils literal notranslate"><span class="pre">astroquery</span></code></span> <br></p>
<p>    <span class="xref myst">1.1 Check image header data</span> <br>
    <span class="xref myst">1.2 Inspect the alignment</span> <br></p>
<p><span class="xref myst">2. Align with <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code></span> <br></p>
<p>    <span class="xref myst">2.1 First test: Use ‘default’ parameters</span> <br>
    <span class="xref myst">2.2 Second test: Set parameters for source finding</span> <br>
    <span class="xref myst">2.3 Inspect the quality of the fit</span> <br></p>
<p><span class="xref myst">3. Combine the Images using <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code></span> <br></p>
<p>    <span class="xref myst">3.1 Inspect the drizzled science image</span> <br>
    <span class="xref myst">3.2 Inspect the final weight image</span> <br>
    <span class="xref myst">3.3 Discussion of <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code></span> <br></p>
<p>The following Python packages are required to run the Jupyter Notebook:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.python.org/3/library/glob.html"><strong>glob</strong></a> - gather lists of filenames</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/os.html"><strong>os</strong></a> - change and make directories</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/shutil.html"><strong>shutil</strong></a> - perform high-level file operations</p></li>
<li><p><a class="reference external" href="https://ipython.readthedocs.io/en/stable/"><strong>iPython</strong></a> - interactive handling</p></li>
<li><p><a class="reference external" href="https://matplotlib.org"><strong>matplotlib</strong></a> - create graphics</p></li>
<li><p><a class="reference external" href="https://numpy.org"><strong>numpy</strong></a> - math and array functions</p></li>
<li><p><a class="reference external" href="https://www.astropy.org"><strong>astropy</strong></a> - FITS file handling and related operations</p></li>
<li><p><a class="reference external" href="https://astroquery.readthedocs.io/en/latest/"><strong>astroquery</strong></a> - download data and query databases</p></li>
<li><p><a class="reference external" href="https://drizzlepac.readthedocs.io/en/latest/"><strong>drizzlepac</strong></a> - align and combine HST images</p></li>
</ul>
</section>
<section id="introduction-a-id-intro-a">
<h2>Introduction <a id="intro"></a><a class="headerlink" href="#introduction-a-id-intro-a" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Table of Contents</span></p>
<p>This notebook demonstrates how to use <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> and <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> tasks to align and combine images. While this example focuses on ACS/WFC data, the procedure can be almost identically applied to WFC3/UVIS images. This notebook is based on <a class="reference external" href="http://documents.stsci.edu/hst/HST_overview/documents/DrizzlePac/ch75.html">a prior example</a> from the 2012 <a class="reference external" href="http://documents.stsci.edu/hst/HST_overview/documents/DrizzlePac/toc.html">DrizzlePac Handbook</a>, but has been updated for compatibility with the latest STScI software distribution.</p>
<p>There is a good deal of explanatory text in this notebook, and users new to DrizzlePac are encouraged to start with this tutorial. Additional <code class="docutils literal notranslate"><span class="pre">DrizzlePac</span></code> software documentation is available at the <a class="reference external" href="https://drizzlepac.readthedocs.io">readthedocs webpage</a>.</p>
<p>Before running the notebook, you will need to install the <code class="docutils literal notranslate"><span class="pre">astroquery</span></code> package, which is used to retrieve the data from the MAST archive.</p>
<p>Please also make sure to appropriately set your environment variables to allow Python to locate the appropriate reference files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span> 
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">clear_output</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.image</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpimg</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">ascii</span><span class="p">,</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">ZScaleInterval</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.mast</span><span class="w"> </span><span class="kn">import</span> <span class="n">Observations</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">drizzlepac</span><span class="w"> </span><span class="kn">import</span> <span class="n">tweakreg</span><span class="p">,</span> <span class="n">astrodrizzle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">drizzlepac.processInput</span><span class="w"> </span><span class="kn">import</span> <span class="n">getMdriztabPars</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format=&#39;retina&#39;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The following task in the stsci.skypac package can be run with TEAL:
                                    skymatch                                    
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The following tasks in the drizzlepac package can be run with TEAL:
    astrodrizzle       config_testbed      imagefindpars           mapreg       
       photeq            pixreplace           pixtopix            pixtosky      
  refimagefindpars       resetbits          runastrodriz          skytopix      
     tweakback            tweakreg           updatenpol
</pre></div>
</div>
</div>
</div>
<p>Along with the above imports, we also set up the required local reference files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set the locations of reference files to your local computer.</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_SERVER_URL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;https://hst-crds.stsci.edu&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_SERVER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;https://hst-crds.stsci.edu&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;./crds_cache&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;iref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;./crds_cache/references/hst/wfc3/&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;jref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;./crds_cache/references/hst/acs/&#39;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="download-the-observations-with-astroquery-a-id-download-a">
<h2>1. Download the Observations with <code class="docutils literal notranslate"><span class="pre">astroquery</span></code> <a id="download"></a><a class="headerlink" href="#download-the-observations-with-astroquery-a-id-download-a" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Table of Contents</span></p>
<hr class="docutils" />
<p>MAST queries may be done using <a href="https://astroquery.readthedocs.io/en/latest/mast/mast_obsquery.html#observation-criteria-queries"> <code class="docutils literal notranslate"><span class="pre">query_criteria</span></code></a>, where we specify: <br></p>
<p>    –&gt; obs_id, proposal_id, and filters</p>
<p>MAST data products may be downloaded by using <a href="https://astroquery.readthedocs.io/en/latest/mast/mast_obsquery.html#downloading-data"> <code class="docutils literal notranslate"><span class="pre">download_products</span></code></a>, where we specify:<br></p>
<p>    –&gt; products = calibrated (FLT, FLC) or drizzled (DRZ, DRC) files</p>
<p>    –&gt; type = standard products (CALxxx) or advanced products (HAP-SVM)</p>
<hr class="docutils" />
<p>In this example, we align three F606W full-frame 339 second ACS/WFC images of the globular cluster NGC 104 from ACS/CAL Program <a class="reference external" href="http://www.stsci.edu/cgi-bin/get-proposal-info?id=10737&amp;observatory=HST">10737</a>.  These observations were acquired over a 3-month period in separate visits and at different orientations. We will use calibrated, CTE-corrected <code class="docutils literal notranslate"><span class="pre">*_flc.fits</span></code> files.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>        j9irw3fwq_flc.fits
        j9irw4b1q_flc.fits
        j9irw5kaq_flc.fits
</pre></div>
</div>
<div class="alert alert-block alert-warning" style="color:black" >  Depending on your connection speed, this cell may take a few minutes to execute. </div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Because the second &#39;FLC&#39; file in visit W4 is part of a dithered association,</span>
<span class="c1"># the &#39;obs_id&#39; for that assocation will need to be used instead of the individual filename.</span>

<span class="n">obs_ids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;j9irw3fwq&quot;</span><span class="p">,</span> <span class="s2">&quot;j9irw4040&quot;</span><span class="p">,</span> <span class="s2">&quot;j9irw5kaq&quot;</span><span class="p">]</span>
<span class="n">props</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;10737&quot;</span><span class="p">]</span>
<span class="n">filts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;F606W&quot;</span><span class="p">]</span>

<span class="n">obsTable</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span><span class="n">obs_id</span><span class="o">=</span><span class="n">obs_ids</span><span class="p">,</span> <span class="n">proposal_id</span><span class="o">=</span><span class="n">props</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">filts</span><span class="p">)</span>
<span class="n">products</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span><span class="n">obsTable</span><span class="p">)</span>

<span class="n">data_prod</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FLC&quot;</span><span class="p">]</span>  <span class="c1"># [&#39;FLC&#39;,&#39;FLT&#39;,&#39;DRC&#39;,&#39;DRZ&#39;]</span>
<span class="n">data_type</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CALACS&quot;</span><span class="p">]</span>  <span class="c1"># [&#39;CALACS&#39;,&#39;CALWF3&#39;,&#39;CALWP2&#39;,&#39;HAP-SVM&#39;]</span>

<span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span>
    <span class="n">products</span><span class="p">,</span> <span class="n">productSubGroupDescription</span><span class="o">=</span><span class="n">data_prod</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/j9irw3fwq_flc.fits to ./mastDownload/HST/j9irw3fwq/j9irw3fwq_flc.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/j9irw4b1q_flc.fits to ./mastDownload/HST/j9irw4b1q/j9irw4b1q_flc.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/j9irw4b3q_flc.fits to ./mastDownload/HST/j9irw4b3q/j9irw4b3q_flc.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/j9irw5kaq_flc.fits to ./mastDownload/HST/j9irw5kaq/j9irw5kaq_flc.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output text_html"><div><i>Table length=4</i>
<table id="table139744586802512" class="table-striped table-bordered table-condensed">
<thead><tr><th>Local Path</th><th>Status</th><th>Message</th><th>URL</th></tr></thead>
<thead><tr><th>str47</th><th>str8</th><th>object</th><th>object</th></tr></thead>
<tr><td>./mastDownload/HST/j9irw3fwq/j9irw3fwq_flc.fits</td><td>COMPLETE</td><td>None</td><td>None</td></tr>
<tr><td>./mastDownload/HST/j9irw4b1q/j9irw4b1q_flc.fits</td><td>COMPLETE</td><td>None</td><td>None</td></tr>
<tr><td>./mastDownload/HST/j9irw4b3q/j9irw4b3q_flc.fits</td><td>COMPLETE</td><td>None</td><td>None</td></tr>
<tr><td>./mastDownload/HST/j9irw5kaq/j9irw5kaq_flc.fits</td><td>COMPLETE</td><td>None</td><td>None</td></tr>
</table></div></div></div>
</div>
<p>Move the files to the local working directory.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">flc</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;./mastDownload/HST/*/*flc.fits&quot;</span><span class="p">):</span>
    <span class="n">flc_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">flc</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">flc</span><span class="p">,</span> <span class="n">flc_name</span><span class="p">)</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;mastDownload/&quot;</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s2">&quot;mastDownload/&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Remove the second FLC file in the W4 visit to simplify the example.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;j9irw4b3q_flc.fits&quot;</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;j9irw4b3q_flc.fits&quot;</span><span class="p">)</span>
<span class="n">input_flcs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*flc.fits&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">input_flcs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;j9irw3fwq_flc.fits&#39;, &#39;j9irw4b1q_flc.fits&#39;, &#39;j9irw5kaq_flc.fits&#39;]
</pre></div>
</div>
</div>
</div>
<section id="check-image-header-data-a-id-check-keywords-a">
<h3>1.1 Check image header data <a id="check_keywords"></a><a class="headerlink" href="#check-image-header-data-a-id-check-keywords-a" title="Permalink to this heading">#</a></h3>
<p>Here we will look at important keywords in the image headers</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*flc.fits&quot;</span><span class="p">))</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># select desired keywords</span>

<span class="n">ext_0_kws</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;rootname&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ASN_ID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TARGNAME&quot;</span><span class="p">,</span>
    <span class="s2">&quot;detector&quot;</span><span class="p">,</span>
    <span class="s2">&quot;filter1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;exptime&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ra_targ&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dec_targ&quot;</span><span class="p">,</span>
    <span class="s2">&quot;date-obs&quot;</span><span class="p">,</span>
    <span class="s2">&quot;postarg1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;postarg2&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">ext_1_kws</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;orientat&quot;</span><span class="p">]</span>

<span class="c1">#grab keywords from data</span>

<span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
    <span class="n">path_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">ext_0_kws</span><span class="p">:</span>
        <span class="n">path_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">ext_1_kws</span><span class="p">:</span>
        <span class="n">path_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_data</span><span class="p">)</span>

<span class="c1"># assign keywords to Table</span>

<span class="n">keywords</span> <span class="o">=</span> <span class="n">ext_0_kws</span> <span class="o">+</span> <span class="n">ext_1_kws</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
    <span class="n">names</span><span class="o">=</span><span class="n">keywords</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;str&quot;</span><span class="p">,</span>
        <span class="s2">&quot;str&quot;</span><span class="p">,</span>
        <span class="s2">&quot;str&quot;</span><span class="p">,</span>
        <span class="s2">&quot;str&quot;</span><span class="p">,</span>
        <span class="s2">&quot;str&quot;</span><span class="p">,</span>
        <span class="s2">&quot;f8&quot;</span><span class="p">,</span>
        <span class="s2">&quot;f8&quot;</span><span class="p">,</span>
        <span class="s2">&quot;f8&quot;</span><span class="p">,</span>
        <span class="s2">&quot;str&quot;</span><span class="p">,</span>
        <span class="s2">&quot;f8&quot;</span><span class="p">,</span>
        <span class="s2">&quot;f8&quot;</span><span class="p">,</span>
        <span class="s2">&quot;f8&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>

<span class="n">table</span><span class="p">[</span><span class="s2">&quot;exptime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s2">&quot;7.1f&quot;</span>
<span class="n">table</span><span class="p">[</span><span class="s2">&quot;ra_targ&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;dec_targ&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s2">&quot;7.4f&quot;</span>
<span class="n">table</span><span class="p">[</span><span class="s2">&quot;postarg1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;postarg2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s2">&quot;7.3f&quot;</span>
<span class="n">table</span><span class="p">[</span><span class="s2">&quot;orientat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s2">&quot;7.2f&quot;</span>
<span class="n">table</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><i>Table length=3</i>
<table id="table139744587564816" class="table-striped table-bordered table-condensed">
<thead><tr><th>rootname</th><th>ASN_ID</th><th>TARGNAME</th><th>detector</th><th>filter1</th><th>exptime</th><th>ra_targ</th><th>dec_targ</th><th>date-obs</th><th>postarg1</th><th>postarg2</th><th>orientat</th></tr></thead>
<thead><tr><th>str32</th><th>str32</th><th>str32</th><th>str32</th><th>str32</th><th>float64</th><th>float64</th><th>float64</th><th>str32</th><th>float64</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>j9irw3fwq</td><td>NONE</td><td>NGC104-WFC</td><td>WFC</td><td>F606W</td><td>339.0</td><td>5.6604</td><td>-72.0678</td><td>2006-05-30</td><td>0.000</td><td>0.000</td><td>-125.24</td></tr>
<tr><td>j9irw4b1q</td><td>J9IRW4040</td><td>NGC104-WFC</td><td>WFC</td><td>F606W</td><td>339.0</td><td>5.6604</td><td>-72.0678</td><td>2006-07-08</td><td>0.000</td><td>0.000</td><td>-88.60</td></tr>
<tr><td>j9irw5kaq</td><td>NONE</td><td>NGC104-WFC</td><td>WFC</td><td>F606W</td><td>339.0</td><td>5.6604</td><td>-72.0678</td><td>2006-08-31</td><td>0.000</td><td>0.000</td><td>-31.45</td></tr>
</table></div></div></div>
</div>
</section>
<section id="inspect-the-alignment-a-id-check-wcs-a">
<h3>1.2 Inspect the Alignment <a id="check_wcs"></a><a class="headerlink" href="#inspect-the-alignment-a-id-check-wcs-a" title="Permalink to this heading">#</a></h3>
<p>Check the active WCS solution in the image header. If the image is aligned to a catalog, list the number of matches and the fit RMS in mas. <br>
Convert the fit RMS values to pixels for comparison with the alignment results performed later in this notebook.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># select keywords needed for alignment inspections</span>
<span class="n">ext_0_kws</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DETECTOR&quot;</span><span class="p">]</span>
<span class="n">ext_1_kws</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;WCSNAME&quot;</span><span class="p">,</span> <span class="s2">&quot;NMATCHES&quot;</span><span class="p">,</span> <span class="s2">&quot;RMS_RA&quot;</span><span class="p">,</span> <span class="s2">&quot;RMS_DEC&quot;</span><span class="p">]</span>

<span class="n">det_scale</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;IR&quot;</span><span class="p">:</span> <span class="mf">0.1283</span><span class="p">,</span> <span class="s2">&quot;UVIS&quot;</span><span class="p">:</span> <span class="mf">0.0396</span><span class="p">,</span> <span class="s2">&quot;WFC&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">}</span>  <span class="c1"># plate scale (arcsec/pixel)</span>

<span class="c1"># create dictionary to store alignment keywords</span>
<span class="n">format_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">col_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*fl?.fits&quot;</span><span class="p">)):</span>
    <span class="n">col_dict</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">hdr0</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">hdr1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">ext_0_kws</span><span class="p">:</span>  <span class="c1"># extension 0 keywords</span>
        <span class="n">col_dict</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdr0</span><span class="p">[</span><span class="n">kw</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">ext_1_kws</span><span class="p">:</span>  <span class="c1"># extension 1 keywords</span>
        <span class="k">if</span> <span class="s2">&quot;RMS&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">hdr1</span><span class="p">[</span><span class="n">kw</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">hdr1</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span>
        <span class="n">col_dict</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;RMS_RA&quot;</span><span class="p">,</span> <span class="s2">&quot;RMS_DEC&quot;</span><span class="p">]:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
            <span class="n">hdr1</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1000.0</span> <span class="o">/</span> <span class="n">det_scale</span><span class="p">[</span><span class="n">hdr0</span><span class="p">[</span><span class="s2">&quot;DETECTOR&quot;</span><span class="p">]],</span> <span class="mi">2</span>
        <span class="p">)</span>  <span class="c1"># convert RMS from mas to pixels</span>
        <span class="n">col_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kw</span><span class="si">}</span><span class="s2">_pix&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

<span class="n">wcstable</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">col_dict</span><span class="p">)</span>
<span class="n">wcstable</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><i>Table length=3</i>
<table id="table139745082417040" class="table-striped table-bordered table-condensed">
<thead><tr><th>filename</th><th>DETECTOR</th><th>WCSNAME</th><th>NMATCHES</th><th>RMS_RA</th><th>RMS_DEC</th><th>RMS_RA_pix</th><th>RMS_DEC_pix</th></tr></thead>
<thead><tr><th>str18</th><th>str3</th><th>str30</th><th>int64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>j9irw3fwq_flc.fits</td><td>WFC</td><td>IDC_4bb1536oj-FIT_IMG_GAIAeDR3</td><td>339</td><td>16.4</td><td>15.8</td><td>0.33</td><td>0.32</td></tr>
<tr><td>j9irw4b1q_flc.fits</td><td>WFC</td><td>IDC_4bb1536oj-FIT_REL_GAIAeDR3</td><td>414</td><td>14.3</td><td>11.8</td><td>0.29</td><td>0.24</td></tr>
<tr><td>j9irw5kaq_flc.fits</td><td>WFC</td><td>IDC_4bb1536oj-FIT_IMG_GAIAeDR3</td><td>359</td><td>13.5</td><td>12.6</td><td>0.27</td><td>0.25</td></tr>
</table></div></div></div>
</div>
<p>Here we see that the FLC images from each separate visit have each been fit to the reference catalog GAIA eDR3.</p>
<p>For visits w3 and w5, the WCSNAME ‘FIT_IMG_catalog’ implies that each FLC was aligned separately, whereas for visit w4, the drizzle combined image ‘j9irw4040_drc.fits’ was aligned to GAIA and the solution was propogated back to the FLC exposures. (Note that the number of matches and fit rms values are different for each FLC frame.)</p>
<p>For more details on absolute astrometry in HST images, see <a class="reference external" href="https://hst-docs.stsci.edu/drizzpac/chapter-4-astrometric-information-in-the-header/4-5-absolute-astrometry">Section 4.5 in the DrizzlePac Handbook</a>.</p>
</section>
</section>
<hr class="docutils" />
<section id="align-with-tweakreg-a-id-tweakreg-a">
<h2>2. Align with <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code>  <a id="tweakreg"></a><a class="headerlink" href="#align-with-tweakreg-a-id-tweakreg-a" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Table of Contents</span></p>
<p>In order to combine multiple images into a distortion-free final drizzled product, <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> relies on the World Coordinate System (WCS) information stored in the header of each image. Because the WCS information for an image is tied to the positions of guide stars used for the observation, each visit will have small pointing errors offsets due to the uncertainty in guide star positions.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> software can align a set of HST images to one another with subpixel accuracy (&lt;0.1 pixel). All input images are aligned to one chosen reference image’s WCS. The reference image is typically selected as the first image in the input list, but can be chosen explicitly via the <code class="docutils literal notranslate"><span class="pre">refimage</span></code> parameter, if desired.</p>
<p>Note that since these images are already aligned to GAIA with ~400 matches and fit RMS values ~0.2 pixels.  Therefore, we simply want to check the relative alignment of the FLC frame in the individual visits W3, W4 and W5, building on the eDR3 WCS solution and then testing for any residual offsets between frames.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> algorithm consists of a few steps:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>1. Makes a catalog of source positions for each input (and reference) image using a source finding algorithm        similar to DAOFind. 
2. Converts the pixel position catalogs to sky position catalogs.
3. Finds common source positions between reference and input image catalogs.
4. Calculates the shifts, rotation, and scale needed to align sky positions of sources in the input images.
5. (Optionally) Updates the input image headers with the newly calculated WCS information.
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> has numerous parameters that are listed in the documentation. For this first pass, we will run <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> with default parameters and show how it fails for this dataset. In subsequent attempts, we will change critical parameters and show how this improves the alignment. The 5 parameters listed below are commented out when left at their default values and uncommented when set to non-defaults.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&#39;conv_width&#39; : 2x FWHM (~3.5 pix for point sources in ACS/WFC or WFC3/UVIS, ~2.5 pix for WFC3/IR)
&#39;threshold&#39;  : Signal-to-noise above bkg. Start large and reduce until number of objects is acceptable.
&#39;peakmax&#39;    : Source brightness cutoff, set to avoid saturated sources. 
&#39;searchrad&#39;  : Search radius for finding common sources between images.
&#39;fitgeometry&#39;: Geometry used to fit offsets, rotations and/or scale changes from the matched object lists. 
               The default `fitgeometry` of &#39;rscale&#39; allows for an x/y shift, scale and rotation, and the 
               &#39;general&#39; fit allows for an xy/shift and an independent scale and rotation for each axis.
</pre></div>
</div>
<p>Note that both <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> and <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> will by default load in settings from any existing <code class="docutils literal notranslate"><span class="pre">.cfg</span></code> files if you’ve run them before. Default parameters are restored by setting <code class="docutils literal notranslate"><span class="pre">configobj</span> <span class="pre">=</span> <span class="pre">None</span></code>.</p>
<section id="first-test-use-default-parameters-a-id-default-a">
<h3>2.1 First test: Use ‘default’ parameters. <a id="default"></a><a class="headerlink" href="#first-test-use-default-parameters-a-id-default-a" title="Permalink to this heading">#</a></h3>
<div class="alert alert-block alert-warning" style="color:black" >  NOTE: Do not actually run the cells in this example, as they will use too much memory! </div>
<p>The most basic, out-of-the-box call to TweakReg looks like this. You <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> on your list of input files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># tweakreg.TweakReg(input_flcs)</span>
</pre></div>
</div>
</div>
</div>
<p>Normally, you’ll want to do some customization though. There are a variety of parameters that can be set, see the documenation for all possibilities. Here we will set a few that are helpful. Again, because we aren’t setting any souce finding parameters in showing the basic call to TweakReg, this will likely crash your computer so don’t proceed with caution if you choose to uncomment and run the cell below.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>   &gt; &#39;interactive&#39; is False by default. This switch controls whether the program stops and waits for the user to examine any generated plots before continuing on to the next image. If turned off, plots will still be displayed, but they will also be saved to disk automatically as a PNG image with an autogenerated name without requiring any user input.

   &gt; `shiftfile` is False by default, here we have set it to true to produce an intermediate output product of a file containing the shifts.
   
   &gt; &#39;outshifts&#39; is the name of the output file created when `shiftfile` is set to True.
   
   &gt; &#39;updatehdr&#39; is False by default, and specifies whether or not to update the headers of each input image directly with the shifts that were determined. This will allow the input images to be combined by AstroDrizzle without having to provide the shiftfile as well.
</pre></div>
</div>
<p>There are many more parameters that can be set, but the example below shows how to run <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> and override some of these defaults.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Running tweakreg with some parameters changed from their defaults.</span>
<span class="c1">#</span>
<span class="c1"># tweakreg.TweakReg(input_flcs,</span>
<span class="c1">#                     interactive=True,</span>
<span class="c1">#                     shiftfile=True,</span>
<span class="c1">#                     outshifts=&#39;shift_default.txt&#39;,</span>
<span class="c1">#                     updatehdr=False)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="second-test-set-parameters-for-source-finding-a-id-sources-a">
<h3>2.2 Second test: Set parameters for source finding <a id="sources"></a><a class="headerlink" href="#second-test-set-parameters-for-source-finding-a-id-sources-a" title="Permalink to this heading">#</a></h3>
<p>One of the crucial steps for aligning images is creating a catalog of common sources in each image to do the alignment. <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> uses a set of default parameters to do this source finding, but you will likely want to override these and tailor them to your dataset. As described above, using the defaults on this dataset of a cluster will simply produce too many sources and use too much memory for the average user’s machine. In this example, we will adjust some of these to parameters.</p>
<p>In the above example, none of the source finding parameters were adjusted. <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code>, by default, looks for sources which are 4-sigma above the background, but this <code class="docutils literal notranslate"><span class="pre">threshold</span></code> value is too low, since the catalogs contain ~60,000 objects per chip in each frame, and ~6500 matched sources between each exposure. Setting the <code class="docutils literal notranslate"><span class="pre">threshold</span></code> to a very low value generally does <em>not</em> translate to a better solution, since all sources are weighted equally when computing fits to match catalogs. This is especially relevant for ACS/WFC and WFC3/UVIS data where CTE tails can shift the centroid position slightly along the readout direction for faint sources and potentially bias the fit.</p>
<p>In this test, the <code class="docutils literal notranslate"><span class="pre">threshold</span></code> value is adjusted to a larger value, and the <code class="docutils literal notranslate"><span class="pre">peakmax</span></code> value is set to 70,000 electrons to exclude full-well saturated objects for gain=2. <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> now finds a more reasonable number of sources per ACS chip (~700).</p>
<p>Note that there are other source finding parameters that can be adjusted and that you may need to adjust. For example, you may need to also adjust <code class="docutils literal notranslate"><span class="pre">searchrad</span></code> if your images have large offsets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tweakreg</span><span class="o">.</span><span class="n">TweakReg</span><span class="p">(</span>
    <span class="n">input_flcs</span><span class="p">,</span>
    <span class="n">threshold</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span>
    <span class="n">peakmax</span><span class="o">=</span><span class="mi">70000</span><span class="p">,</span>
    <span class="n">configobj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">shiftfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">outshifts</span><span class="o">=</span><span class="s2">&quot;shift_rscale.txt&quot;</span><span class="p">,</span>
    <span class="n">ylimit</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">fitgeometry</span><span class="o">=</span><span class="s2">&quot;rscale&quot;</span><span class="p">,</span>
    <span class="n">updatehdr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">reusename</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1">#clear_output()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Setting up logfile :  tweakreg.log
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>TweakReg Version 3.9.0 started at: 16:42:28.291 (13/02/2025) 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Version Information
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--------------------
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Python Version 3.11.11 (main, Dec  4 2024, 12:57:43) [GCC 9.4.0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>numpy Version -&gt; 2.2.2 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>astropy Version -&gt; 7.0.1 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>stwcs Version -&gt; 1.7.4 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>photutils Version -&gt; 2.1.0 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Finding shifts for: 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    j9irw3fwq_flc.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    j9irw4b1q_flc.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    j9irw5kaq_flc.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>===  Source finding for image &#39;j9irw3fwq_flc.fits&#39;:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  #  Source finding for &#39;j9irw3fwq_flc.fits&#39;, EXT=(&#39;SCI&#39;, 1) started at: 16:42:28.382 (13/02/2025)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     Found 626 objects.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  #  Source finding for &#39;j9irw3fwq_flc.fits&#39;, EXT=(&#39;SCI&#39;, 2) started at: 16:42:28.739 (13/02/2025)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     Found 408 objects.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>===  FINAL number of objects in image &#39;j9irw3fwq_flc.fits&#39;: 1034
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>===  Source finding for image &#39;j9irw4b1q_flc.fits&#39;:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  #  Source finding for &#39;j9irw4b1q_flc.fits&#39;, EXT=(&#39;SCI&#39;, 1) started at: 16:42:29.340 (13/02/2025)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     Found 708 objects.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  #  Source finding for &#39;j9irw4b1q_flc.fits&#39;, EXT=(&#39;SCI&#39;, 2) started at: 16:42:29.70 (13/02/2025)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     Found 398 objects.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>===  FINAL number of objects in image &#39;j9irw4b1q_flc.fits&#39;: 1106
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>===  Source finding for image &#39;j9irw5kaq_flc.fits&#39;:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  #  Source finding for &#39;j9irw5kaq_flc.fits&#39;, EXT=(&#39;SCI&#39;, 1) started at: 16:42:30.364 (13/02/2025)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     Found 524 objects.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  #  Source finding for &#39;j9irw5kaq_flc.fits&#39;, EXT=(&#39;SCI&#39;, 2) started at: 16:42:30.716 (13/02/2025)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     Found 343 objects.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>===  FINAL number of objects in image &#39;j9irw5kaq_flc.fits&#39;: 867
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>===============================================================
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Performing alignment in the projection plane defined by the WCS
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>derived from &#39;j9irw3fwq_flc.fits&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>===============================================================
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>====================
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Performing fit for: j9irw4b1q_flc.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Matching sources from &#39;j9irw4b1q_flc.fits&#39; with sources from reference image &#39;j9irw3fwq_flc.fits&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computing initial guess for X and Y shifts...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Found initial X and Y shifts of -0.001445, -0.00289 with significance of 665.3 and 692 matches
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Found 691 matches for j9irw4b1q_flc.fits...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computed  rscale  fit for  j9irw4b1q_flc.fits : 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>XSH: -0.0341  YSH: 0.0128    ROT: 359.9998145    SCALE: 0.999991
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>FIT XRMS: 0.042      FIT YRMS: 0.04   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>FIT RMSE: 0.058      FIT MAE: 0.051  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RMS_RA: 5e-07 (deg)   RMS_DEC: 7.9e-07 (deg)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Final solution based on  681  objects.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>wrote XY data to:  j9irw4b1q_flc_catalog_fit.match
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total # points: 681
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span># of points after clipping: 681
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total # points: 681
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span># of points after clipping: 681
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>====================
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Performing fit for: j9irw5kaq_flc.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Matching sources from &#39;j9irw5kaq_flc.fits&#39; with sources from reference image &#39;j9irw3fwq_flc.fits&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computing initial guess for X and Y shifts...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Found initial X and Y shifts of 0, 0.002805 with significance of 690.5 and 713 matches
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Found 713 matches for j9irw5kaq_flc.fits...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computed  rscale  fit for  j9irw5kaq_flc.fits : 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>XSH: 0.0528  YSH: -0.0287    ROT: 359.9993718    SCALE: 1.000004
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>FIT XRMS: 0.049      FIT YRMS: 0.046  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>FIT RMSE: 0.067      FIT MAE: 0.06   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RMS_RA: 5.2e-07 (deg)   RMS_DEC: 9.2e-07 (deg)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Final solution based on  702  objects.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>wrote XY data to:  j9irw5kaq_flc_catalog_fit.match
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total # points: 702
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span># of points after clipping: 702
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total # points: 702
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span># of points after clipping: 702
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Writing out shiftfile : shift_rscale.txt
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Trailer file written to:  tweakreg.log
</pre></div>
</div>
<img alt="../../../_images/9089d96860f20577bf188e93f47300030c805e2bca3f16afd700e791ce9ff149.png" src="../../../_images/9089d96860f20577bf188e93f47300030c805e2bca3f16afd700e791ce9ff149.png" />
<img alt="../../../_images/87f66977a19ace9d5d3d1d2873d5e7b0bfcb3c4abe8330c9837f6b19ae951736.png" src="../../../_images/87f66977a19ace9d5d3d1d2873d5e7b0bfcb3c4abe8330c9837f6b19ae951736.png" />
<img alt="../../../_images/1417c813cae347b01e93d93b09ed3dec1d08c2abab91f45dd8a66a8696485742.png" src="../../../_images/1417c813cae347b01e93d93b09ed3dec1d08c2abab91f45dd8a66a8696485742.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># If the alignment is unsuccessful, stop the notebook</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;shift_rscale.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">shift</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line_number</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shift</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;nan&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;nan found in line </span><span class="si">{}</span><span class="s2"> in shift file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line_number</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="inspect-the-quality-of-the-fit-a-id-fit-quality-a">
<h3>2.3 Inspect the quality of the fit <a id="fit_quality"></a><a class="headerlink" href="#inspect-the-quality-of-the-fit-a-id-fit-quality-a" title="Permalink to this heading">#</a></h3>
<p>In your work, you will likely have to play around with TweakReg parameters to find the optimal set for your data. This requires inspecting the quality of the fit after each run. If you scroll to the bottom of the last cell run, you can see some diagnostic plots there including a residual and vector plot that show the quality of fit. Here, we will inspect some of the outputs that are saved.</p>
<p>The shift file below shows that the xrms and yrms of the computed fit are excellent, around ~0.04 pixels.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create Table from shift_rscale.txt</span>
<span class="n">shift_tab</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
    <span class="s2">&quot;shift_rscale.txt&quot;</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;ascii.no_header&quot;</span><span class="p">,</span>
    <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="s2">&quot;dx&quot;</span><span class="p">,</span> <span class="s2">&quot;dy&quot;</span><span class="p">,</span> <span class="s2">&quot;rot&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="s2">&quot;xrms&quot;</span><span class="p">,</span> <span class="s2">&quot;yrms&quot;</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">formats</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.2f&quot;</span><span class="p">,</span> <span class="s2">&quot;.2f&quot;</span><span class="p">,</span> <span class="s2">&quot;.3f&quot;</span><span class="p">,</span> <span class="s2">&quot;.5f&quot;</span><span class="p">,</span> <span class="s2">&quot;.2f&quot;</span><span class="p">,</span> <span class="s2">&quot;.2f&quot;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shift_tab</span><span class="o">.</span><span class="n">colnames</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
    <span class="n">shift_tab</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="n">shift_tab</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><i>Table length=3</i>
<table id="table139744580515088" class="table-striped table-bordered table-condensed">
<thead><tr><th>file</th><th>dx</th><th>dy</th><th>rot</th><th>scale</th><th>xrms</th><th>yrms</th></tr></thead>
<thead><tr><th>str18</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>j9irw3fwq_flc.fits</td><td>0.00</td><td>0.00</td><td>0.000</td><td>1.00000</td><td>0.00</td><td>0.00</td></tr>
<tr><td>j9irw4b1q_flc.fits</td><td>-0.03</td><td>0.01</td><td>360.000</td><td>0.99999</td><td>0.04</td><td>0.04</td></tr>
<tr><td>j9irw5kaq_flc.fits</td><td>0.05</td><td>-0.03</td><td>359.999</td><td>1.00000</td><td>0.05</td><td>0.05</td></tr>
</table></div></div></div>
</div>
<p>When <code class="docutils literal notranslate"><span class="pre">interactive</span></code> = False, <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> outputs several diagnostic plots in the working directory for you to inspect the fit quality. For each input file, except the reference file, TweakReg creates an x/y plot of fit residuals and a vector plot. Let’s take a look at these.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Give the &#39;fit residual plots&#39; a unique name for comparison with other tests.</span>
<span class="n">rootname_A</span> <span class="o">=</span> <span class="s2">&quot;j9irw4b1q&quot;</span>
<span class="n">rootname_B</span> <span class="o">=</span> <span class="s2">&quot;j9irw5kaq&quot;</span>

<span class="c1"># make a subdirectory for storing images</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;images&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;residuals_</span><span class="si">{</span><span class="n">rootname_A</span><span class="si">}</span><span class="s2">_flc.png&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;images/residuals_</span><span class="si">{</span><span class="n">rootname_A</span><span class="si">}</span><span class="s2">_flc_rscale.png&quot;</span><span class="p">)</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;residuals_</span><span class="si">{</span><span class="n">rootname_B</span><span class="si">}</span><span class="s2">_flc.png&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;images/residuals_</span><span class="si">{</span><span class="n">rootname_B</span><span class="si">}</span><span class="s2">_flc_rscale.png&quot;</span><span class="p">)</span>

<span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;vector_</span><span class="si">{</span><span class="n">rootname_A</span><span class="si">}</span><span class="s2">_flc.png&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;images/vector_</span><span class="si">{</span><span class="n">rootname_A</span><span class="si">}</span><span class="s2">_flc_rscale.png&quot;</span><span class="p">)</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;vector_</span><span class="si">{</span><span class="n">rootname_B</span><span class="si">}</span><span class="s2">_flc.png&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;images/vector_</span><span class="si">{</span><span class="n">rootname_B</span><span class="si">}</span><span class="s2">_flc_rscale.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;images/vector_j9irw5kaq_flc_rscale.png&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># read images</span>
<span class="n">img_A</span> <span class="o">=</span> <span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;images/residuals_</span><span class="si">{</span><span class="n">rootname_A</span><span class="si">}</span><span class="s2">_flc_rscale.png&quot;</span><span class="p">)</span>
<span class="n">img_B</span> <span class="o">=</span> <span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;images/residuals_</span><span class="si">{</span><span class="n">rootname_B</span><span class="si">}</span><span class="s2">_flc_rscale.png&quot;</span><span class="p">)</span>

<span class="c1"># display images</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_A</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_B</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/044bc29ec2cef0bffc67bf42ceea0806a56b0b86718916ec7ddba51f8c7e8129.png" src="../../../_images/044bc29ec2cef0bffc67bf42ceea0806a56b0b86718916ec7ddba51f8c7e8129.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># read images</span>
<span class="n">img_A</span> <span class="o">=</span> <span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;images/vector_</span><span class="si">{</span><span class="n">rootname_A</span><span class="si">}</span><span class="s2">_flc_rscale.png&quot;</span><span class="p">)</span>
<span class="n">img_B</span> <span class="o">=</span> <span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;images/vector_</span><span class="si">{</span><span class="n">rootname_B</span><span class="si">}</span><span class="s2">_flc_rscale.png&quot;</span><span class="p">)</span>

<span class="c1"># display images</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_A</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_B</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/ecdaddb2e66d8f2e7775776da8bb2f8f0a54cc10ee5cd6df91d94fa35d62c7cd.png" src="../../../_images/ecdaddb2e66d8f2e7775776da8bb2f8f0a54cc10ee5cd6df91d94fa35d62c7cd.png" />
</div>
</div>
<p>The residual plots show a fit RMS of ~0.04 pixels, but there is still a systematic skew in the fit residuals, which is believed to be caused by an uncorrected ‘skew’ in the ACS distortion solution.</p>
<p>As of creation of this notebook in 2024, the following calibration reference files were used:</p>
<ul class="simple">
<li><p>IDCTAB   = ‘jref$4bb1536oj_idc.fits’ / Image Distortion Correction Table</p></li>
<li><p>D2IMFILE = ‘jref$4bb15371j_d2i.fits’ / Column Correction Reference File</p></li>
<li><p>NPOLFILE = ‘jref$4bb1536ej_npl.fits’ / Non-polynomial Offsets Reference File (F606W)</p></li>
</ul>
<p>New distortion solutions are in the process of being derived by the ACS team, so observations retrieved from MAST at a later date may or may not show these systematic skew residuals.  Fortunately, these can be corrected by allowing for a higher order <code class="docutils literal notranslate"><span class="pre">fitgeometry</span></code> as shown in the next test.</p>
<p>More information about the distortion reference files used by <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> may be found in the DrizzlePac Handbook <a class="reference external" href="https://hst-docs.stsci.edu/drizzpac/chapter-4-astrometric-information-in-the-header/4-3-distortion-information-in-pipeline-calibrated-images">Section 4.3</a>.</p>
</section>
<section id="fourth-test-adjust-the-fitgeometry-a-id-fit-geom-a">
<h3>2.4 Fourth test: Adjust the <code class="docutils literal notranslate"><span class="pre">fitgeometry</span></code> <a id="fit_geom"></a><a class="headerlink" href="#fourth-test-adjust-the-fitgeometry-a-id-fit-geom-a" title="Permalink to this heading">#</a></h3>
<p>In this test, the <code class="docutils literal notranslate"><span class="pre">fitgeometry</span></code> parameter is changed from the default <code class="docutils literal notranslate"><span class="pre">rscale</span></code> (shift, rotation, scale) to <code class="docutils literal notranslate"><span class="pre">general</span></code> (shift, xrot, yrot, xscale, yscale) in order to correct for residual skew terms.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># run TweakReg</span>
<span class="n">tweakreg</span><span class="o">.</span><span class="n">TweakReg</span><span class="p">(</span>
    <span class="n">input_flcs</span><span class="p">,</span>
    <span class="n">threshold</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span>
    <span class="n">peakmax</span><span class="o">=</span><span class="mi">70000</span><span class="p">,</span>
    <span class="n">configobj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">shiftfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">outshifts</span><span class="o">=</span><span class="s2">&quot;shift_general.txt&quot;</span><span class="p">,</span>
    <span class="n">ylimit</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">fitgeometry</span><span class="o">=</span><span class="s2">&quot;general&quot;</span><span class="p">,</span>
    <span class="n">updatehdr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">reusename</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">clear_output</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create Table from shift_rscale.txt</span>
<span class="n">shift_tab</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
    <span class="s2">&quot;shift_general.txt&quot;</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;ascii.no_header&quot;</span><span class="p">,</span>
    <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="s2">&quot;dx&quot;</span><span class="p">,</span> <span class="s2">&quot;dy&quot;</span><span class="p">,</span> <span class="s2">&quot;rot&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="s2">&quot;xrms&quot;</span><span class="p">,</span> <span class="s2">&quot;yrms&quot;</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">formats</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.2f&quot;</span><span class="p">,</span> <span class="s2">&quot;.2f&quot;</span><span class="p">,</span> <span class="s2">&quot;.3f&quot;</span><span class="p">,</span> <span class="s2">&quot;.5f&quot;</span><span class="p">,</span> <span class="s2">&quot;.2f&quot;</span><span class="p">,</span> <span class="s2">&quot;.2f&quot;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shift_tab</span><span class="o">.</span><span class="n">colnames</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
    <span class="n">shift_tab</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="n">shift_tab</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><i>Table length=3</i>
<table id="table139744323810576" class="table-striped table-bordered table-condensed">
<thead><tr><th>file</th><th>dx</th><th>dy</th><th>rot</th><th>scale</th><th>xrms</th><th>yrms</th></tr></thead>
<thead><tr><th>str18</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>j9irw3fwq_flc.fits</td><td>0.00</td><td>0.00</td><td>0.000</td><td>1.00000</td><td>0.00</td><td>0.00</td></tr>
<tr><td>j9irw4b1q_flc.fits</td><td>-0.03</td><td>0.01</td><td>360.000</td><td>0.99999</td><td>0.03</td><td>0.03</td></tr>
<tr><td>j9irw5kaq_flc.fits</td><td>0.05</td><td>-0.02</td><td>359.999</td><td>1.00000</td><td>0.04</td><td>0.03</td></tr>
</table></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print the number of matches for images 2 and 3 with respect to image1</span>
<span class="n">rootname2</span> <span class="o">=</span> <span class="s2">&quot;j9irw4b1q&quot;</span>
<span class="n">rootname3</span> <span class="o">=</span> <span class="s2">&quot;j9irw5kaq&quot;</span>
<span class="n">match_tab2</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
    <span class="n">rootname2</span> <span class="o">+</span> <span class="s2">&quot;_flc_catalog_fit.match&quot;</span>
<span class="p">)</span>  <span class="c1"># load match file in astropy table</span>
<span class="n">match_tab3</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
    <span class="n">rootname3</span> <span class="o">+</span> <span class="s2">&quot;_flc_catalog_fit.match&quot;</span>
<span class="p">)</span>  <span class="c1"># load match file in astropy table</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rootname2</span><span class="p">,</span> <span class="s2">&quot;     Number of Gaia Matches=&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nb">len</span><span class="p">(</span><span class="n">match_tab2</span><span class="p">)})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rootname3</span><span class="p">,</span> <span class="s2">&quot;     Number of Gaia Matches=&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nb">len</span><span class="p">(</span><span class="n">match_tab3</span><span class="p">)})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>j9irw4b1q      Number of Gaia Matches= {681}
j9irw5kaq      Number of Gaia Matches= {705}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compare with the MAST solutions</span>
<span class="n">wcstable</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><i>Table length=3</i>
<table id="table139745082417040" class="table-striped table-bordered table-condensed">
<thead><tr><th>filename</th><th>DETECTOR</th><th>WCSNAME</th><th>NMATCHES</th><th>RMS_RA</th><th>RMS_DEC</th><th>RMS_RA_pix</th><th>RMS_DEC_pix</th></tr></thead>
<thead><tr><th>str18</th><th>str3</th><th>str30</th><th>int64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>j9irw3fwq_flc.fits</td><td>WFC</td><td>IDC_4bb1536oj-FIT_IMG_GAIAeDR3</td><td>339</td><td>16.4</td><td>15.8</td><td>0.33</td><td>0.32</td></tr>
<tr><td>j9irw4b1q_flc.fits</td><td>WFC</td><td>IDC_4bb1536oj-FIT_REL_GAIAeDR3</td><td>414</td><td>14.3</td><td>11.8</td><td>0.29</td><td>0.24</td></tr>
<tr><td>j9irw5kaq_flc.fits</td><td>WFC</td><td>IDC_4bb1536oj-FIT_IMG_GAIAeDR3</td><td>359</td><td>13.5</td><td>12.6</td><td>0.27</td><td>0.25</td></tr>
</table></div></div></div>
</div>
<p>While the shift file looks nearly identical to the prior run, this is because the axis-dependent rotation and scale values are averaged together in the shiftfile.  To determine the actual values, it is necessary to inspect the ‘tweakreg.log’ logfile.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>j9irw4b1q  SCALE_X: 0.9999720117  SCALE_Y: 1.000014811  ROT_X: 359.9999  ROT_Y:   0.0014   SKEW: -359.9985
j9irw5kaq  SCALE_X: 0.9999851345  SCALE_Y: 1.000030317  ROT_X:   0.0015  ROT_Y: 359.9989   SKEW:  359.9974
</pre></div>
</div>
<p>The ‘general’ fit reduces the fit rms to ~0.03 pixels from the prior value of ~0.05 pixels and removes systematics from the residuals in the plots below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Give the &#39;fit residual plots&#39; a unique name for comparison with other tests.</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;residuals_</span><span class="si">{</span><span class="n">rootname_A</span><span class="si">}</span><span class="s2">_flc.png&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;images/residuals_</span><span class="si">{</span><span class="n">rootname_A</span><span class="si">}</span><span class="s2">_flc_general.png&quot;</span><span class="p">)</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;residuals_</span><span class="si">{</span><span class="n">rootname_B</span><span class="si">}</span><span class="s2">_flc.png&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;images/residuals_</span><span class="si">{</span><span class="n">rootname_B</span><span class="si">}</span><span class="s2">_flc_general.png&quot;</span><span class="p">)</span>

<span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;vector_</span><span class="si">{</span><span class="n">rootname_A</span><span class="si">}</span><span class="s2">_flc.png&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;images/vector_</span><span class="si">{</span><span class="n">rootname_A</span><span class="si">}</span><span class="s2">_flc_general.png&quot;</span><span class="p">)</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;vector_</span><span class="si">{</span><span class="n">rootname_B</span><span class="si">}</span><span class="s2">_flc.png&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;images/vector_</span><span class="si">{</span><span class="n">rootname_B</span><span class="si">}</span><span class="s2">_flc_general.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;images/vector_j9irw5kaq_flc_general.png&#39;
</pre></div>
</div>
</div>
</div>
<p>The plots below shows residuals in X and Y plotted as functions of X and Y. Each point represents a source that was used for the alignment. The residuals should look fairly random - if any correlation is seen, this is an indicator of a poor alignment solution. In some cases you will notice a wavy pattern in the residuals in X and Y. This is often seen for UVIS images and is a result of lithographic patterns of the detector that are not fully corrected for in the distortion solutions. The RMS in X and Y are also printed. For a good alignment, we are looking for an RMS on the order of 0.1 pixel or less.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># read images</span>
<span class="n">img_A</span> <span class="o">=</span> <span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;images/residuals_</span><span class="si">{</span><span class="n">rootname_A</span><span class="si">}</span><span class="s2">_flc_general.png&quot;</span><span class="p">)</span>
<span class="n">img_B</span> <span class="o">=</span> <span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;images/residuals_</span><span class="si">{</span><span class="n">rootname_B</span><span class="si">}</span><span class="s2">_flc_general.png&quot;</span><span class="p">)</span>

<span class="c1"># display images</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_A</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_B</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/9089d96860f20577bf188e93f47300030c805e2bca3f16afd700e791ce9ff149.png" src="../../../_images/9089d96860f20577bf188e93f47300030c805e2bca3f16afd700e791ce9ff149.png" />
<img alt="../../../_images/bc2aec623c619a1814c3da235a93012845d957d6e5f3ba3dcf3c5299f09cd856.png" src="../../../_images/bc2aec623c619a1814c3da235a93012845d957d6e5f3ba3dcf3c5299f09cd856.png" />
<img alt="../../../_images/597ada1e6d3948a60d643da1ccfd3c95478efb4aff0180222c2fa65c270f6257.png" src="../../../_images/597ada1e6d3948a60d643da1ccfd3c95478efb4aff0180222c2fa65c270f6257.png" />
<img alt="../../../_images/fb128426fee7df3afb3bd6391704c12e6f989006e34914fb333cbcc72bb74309.png" src="../../../_images/fb128426fee7df3afb3bd6391704c12e6f989006e34914fb333cbcc72bb74309.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># read images</span>
<span class="n">img_A</span> <span class="o">=</span> <span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;images/vector_</span><span class="si">{</span><span class="n">rootname_A</span><span class="si">}</span><span class="s2">_flc_general.png&quot;</span><span class="p">)</span>
<span class="n">img_B</span> <span class="o">=</span> <span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;images/vector_</span><span class="si">{</span><span class="n">rootname_B</span><span class="si">}</span><span class="s2">_flc_general.png&quot;</span><span class="p">)</span>

<span class="c1"># display images</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_A</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_B</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/910dd3f86268e3ad3ff61fb1ff780ba1a1e6692782e371f437ea9a415b7a3062.png" src="../../../_images/910dd3f86268e3ad3ff61fb1ff780ba1a1e6692782e371f437ea9a415b7a3062.png" />
</div>
</div>
<p>The direction and the magnitude of the arrows in the vector plot above represent the offsets in the source position between the image in question and the reference image. These should visually appear random if the alignment was sucessful.</p>
<p>You may need to run <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> run several times with varying parameters until a good fit is found. Notice in the above tests that <code class="docutils literal notranslate"><span class="pre">updatehdr</span> <span class="pre">=</span> <span class="pre">False</span></code>. This allows you to attempt the alignment and inspect the results without actually updating the WCS to solidify the alignment. Once you are satisfied with the results, <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> is run a final time with <code class="docutils literal notranslate"><span class="pre">updatehdr</span> <span class="pre">=</span> <span class="pre">True</span></code>, and a new WCS will be inserted in the file. The default name of this new WCS is ‘TWEAK’, but can be changed by setting the <code class="docutils literal notranslate"><span class="pre">wcsname</span></code>.</p>
</section>
<section id="overplot-matched-sources-on-the-image-a-id-overplot-a">
<h3>2.5 Overplot Matched Sources on the Image <a id="overplot"></a><a class="headerlink" href="#overplot-matched-sources-on-the-image-a-id-overplot-a" title="Permalink to this heading">#</a></h3>
<p>As a final quality check before updating the image header WCS, we plot the sources that were matched between FLC images in visits W3 and W4.</p>
<p>The cell below shows how to read in the <code class="docutils literal notranslate"><span class="pre">*_fit.match</span></code> file as an <code class="docutils literal notranslate"><span class="pre">astropy</span></code> table. Unfortunately, it doesn’t automatically name columns so you’ll have to look at the header to grab the columns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rootname</span> <span class="o">=</span> <span class="s2">&quot;j9irw4b1q&quot;</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">140</span><span class="p">)</span>

<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rootname</span> <span class="o">+</span> <span class="s2">&quot;_flc.fits&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdulist</span><span class="p">:</span> 
    <span class="n">chip1_data</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="s2">&quot;SCI&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> 
    <span class="n">chip2_data</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="s2">&quot;SCI&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">fullsci</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">chip2_data</span><span class="p">,</span> <span class="n">chip1_data</span><span class="p">])</span>
    <span class="n">zscale</span> <span class="o">=</span> <span class="n">ZScaleInterval</span><span class="p">()</span>
    <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">zscale</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">fullsci</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fullsci</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greys&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">z1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">z2</span><span class="p">)</span>
    
    <span class="n">match_tab</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
        <span class="n">rootname</span> <span class="o">+</span> <span class="s2">&quot;_flc_catalog_fit.match&quot;</span>
    <span class="p">)</span>  <span class="c1"># load match file in astropy table</span>
    <span class="n">match_tab_chip1</span> <span class="o">=</span> <span class="n">match_tab</span><span class="p">[</span>
        <span class="n">match_tab</span><span class="p">[</span><span class="s2">&quot;col15&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="p">]</span>  <span class="c1"># filter table for sources on chip 1 (on ext 4)</span>
    <span class="n">match_tab_chip2</span> <span class="o">=</span> <span class="n">match_tab</span><span class="p">[</span>
        <span class="n">match_tab</span><span class="p">[</span><span class="s2">&quot;col15&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="p">]</span>  <span class="c1"># filter table for sources on chip 1 (on ext 4)</span>
    <span class="n">x_cord1</span><span class="p">,</span> <span class="n">y_cord1</span> <span class="o">=</span> <span class="n">match_tab_chip1</span><span class="p">[</span><span class="s2">&quot;col11&quot;</span><span class="p">],</span> <span class="n">match_tab_chip1</span><span class="p">[</span><span class="s2">&quot;col12&quot;</span><span class="p">]</span>
    <span class="n">x_cord2</span><span class="p">,</span> <span class="n">y_cord2</span> <span class="o">=</span> <span class="n">match_tab_chip2</span><span class="p">[</span><span class="s2">&quot;col11&quot;</span><span class="p">],</span> <span class="n">match_tab_chip2</span><span class="p">[</span><span class="s2">&quot;col12&quot;</span><span class="p">]</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">x_cord1</span><span class="p">,</span>
        <span class="n">y_cord1</span> <span class="o">+</span> <span class="mi">2051</span><span class="p">,</span>
        <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
        <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Matched Sources&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_cord2</span><span class="p">,</span> <span class="n">y_cord2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Matched sources W4 to W3: N = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">match_tab</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/bae3c8d6260f30abb5416be4822bf5088975a247fbe03b3b803b1d196f8333e6.png" src="../../../_images/bae3c8d6260f30abb5416be4822bf5088975a247fbe03b3b803b1d196f8333e6.png" />
</div>
</div>
</section>
<section id="update-header-once-optimal-parameters-are-found-a-id-updatehdr-a">
<h3>2.6 Update header once optimal parameters are found  <a id="updatehdr"></a><a class="headerlink" href="#update-header-once-optimal-parameters-are-found-a-id-updatehdr-a" title="Permalink to this heading">#</a></h3>
<p>Once you’ve decided on the optimal set of parameters for your alignment, it is safe to update the header of the input data. Note that because the first image is already aligned to Gaia, this does not need to be done again and we focus only on improving the relative alignment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tweakreg</span><span class="o">.</span><span class="n">TweakReg</span><span class="p">(</span>
    <span class="n">input_flcs</span><span class="p">,</span>
    <span class="n">threshold</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span>
    <span class="n">peakmax</span><span class="o">=</span><span class="mi">70000</span><span class="p">,</span>
    <span class="n">configobj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">shiftfile</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">ylimit</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">fitgeometry</span><span class="o">=</span><span class="s2">&quot;general&quot;</span><span class="p">,</span>
    <span class="n">updatehdr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># update the header with the new solution</span>
    <span class="n">reusename</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>  

<span class="n">clear_output</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="combine-the-images-using-astrodrizzle-a-id-adriz-a">
<h2>3. Combine the Images using <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> <a id="adriz"></a><a class="headerlink" href="#combine-the-images-using-astrodrizzle-a-id-adriz-a" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Table of Contents</span></p>
<p>Now that the images are aligned to a common WCS, they are ready for combination with <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code>. All of the input exposures taken in a single filter will contribute to a single drizzled output file.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> steps after alignment are summarized below.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>1. A static pixel mask is created to flag bad detector pixels.
2. Sky subtraction is performed on masked images. 
3. Each image is individually drizzled, with geometric distortion corrections, to a common reference frame.
4. The distortion-free drizzled images are combined to create a median image.
5. The median image is blotted, or reverse-drizzled, back to the frame of each input image.
6. By comparing each input image with its counterpart blotted median image, the software locates bad pixels in each of the original frames &amp; creates bad pixel masks (typically CR&#39;s and bad pixels in the detector)
7. In the final step, input images are drizzled together onto a single output image.
</pre></div>
</div>
<p>Let’s first run <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> on the aligned input images in the next cell to create a combined image <code class="docutils literal notranslate"><span class="pre">f606w_combined_drc</span></code>, then go into further detail about the drizzle process.</p>
<p>Note that astrodrizzle supports the loading of a custom configuration file (<code class="docutils literal notranslate"><span class="pre">.cfg</span></code>) files, but we will be using the command-line syntax interface to set the parameters in this example, where parameters are passed into the function directly. Any existing <code class="docutils literal notranslate"><span class="pre">.cfg</span></code> file will be overridden by setting <code class="docutils literal notranslate"><span class="pre">configobj</span> <span class="pre">=</span> <span class="pre">None</span></code> so that unless explicitly set, parameters will be reset to default.</p>
<p>First, we get some recommended values for drizzling from the MDRIZTAB reference file.  The parameters in this file are different for each detector and are based on the number of input frames. These are a good starting point for drizzling and may be adjusted accordingly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The following lines of code find and download the MDRIZTAB reference file.</span>
<span class="n">mdz</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">input_flcs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;MDRIZTAB&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">jref</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;jref&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Searching for the MDRIZTAB file:&#39;</span><span class="p">,</span> <span class="n">mdz</span><span class="p">)</span>
<span class="o">!</span>crds<span class="w"> </span>sync<span class="w"> </span>--hst<span class="w"> </span>--files<span class="w"> </span><span class="o">{</span>mdz<span class="o">}</span><span class="w"> </span>--output-dir<span class="w"> </span><span class="o">{</span>jref<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Searching for the MDRIZTAB file: 37g1550cj_mdz.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CRDS - INFO -  Symbolic context &#39;hst-latest&#39; resolves to &#39;hst_1211.pmap&#39;
CRDS - INFO -  Reorganizing 0 references from &#39;instrument&#39; to &#39;flat&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CRDS - INFO -  Reorganizing from &#39;instrument&#39; to &#39;flat&#39; cache,  removing instrument directories.
CRDS - INFO -  Syncing explicitly listed files.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CRDS - INFO -  Fetching  ./crds_cache/references/hst/acs/37g1550cj_mdz.fits       247.7 K bytes  (1 / 1 files) (0 / 247.7 K bytes)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CRDS - INFO -  0 errors
CRDS - INFO -  0 warnings
CRDS - INFO -  5 infos
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_vals_from_mdriztab</span><span class="p">(</span>
    <span class="n">input_flcs</span><span class="p">,</span>
    <span class="n">kw_list</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;driz_sep_bits&quot;</span><span class="p">,</span>
        <span class="s2">&quot;combine_type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;driz_cr_snr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;driz_cr_scale&quot;</span><span class="p">,</span>
        <span class="s2">&quot;final_bits&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get only selected parameters from. the MDRIZTAB&quot;&quot;&quot;</span>
    <span class="n">mdriz_dict</span> <span class="o">=</span> <span class="n">getMdriztabPars</span><span class="p">(</span><span class="n">input_flcs</span><span class="p">)</span>

    <span class="n">requested_params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Outputting the following parameters:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kw_list</span><span class="p">:</span>
        <span class="n">requested_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdriz_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">mdriz_dict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">requested_params</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">selected_params</span> <span class="o">=</span> <span class="n">get_vals_from_mdriztab</span><span class="p">(</span><span class="n">input_flcs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>- MDRIZTAB: AstroDrizzle parameters read from row 2.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Outputting the following parameters:
driz_sep_bits 336
combine_type minmed
driz_cr_snr 3.5 3.0
driz_cr_scale 1.5 1.2
final_bits 336
</pre></div>
</div>
</div>
</div>
<p>Note that the parameter <code class="docutils literal notranslate"><span class="pre">final_bits</span></code>= ‘336’ is equivalent to <code class="docutils literal notranslate"><span class="pre">final_bits</span></code>= ‘256, 64, 16’.</p>
<p>Since the ACS team now corrects for stable hot pixels (DQ flag=16) via the dark reference files, these pixels can be considered ‘good’. Full well saturated pixels (DQ flag=256) and warm pixels (DQ flag=64) may also be treated as good. More details on the recommended drizzle parameters for ACS may be found in <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2017acs..rept....2H/abstract">ISR 2017-02</a>.</p>
<p>Next we run <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> to remove the sky, flag cosmic rays, and combine the image using the selected parameters.  Note that these may be further refined by uncommenting the lines in the example shown below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To override any of the above values, e.g.:</span>
<span class="c1"># selected_params[&quot;driz_sep_bits&quot;] = &quot;256, 64, 16&quot;</span>
<span class="c1"># selected_params[&quot;final_bits&quot;] = &quot;256, 64, 16&quot;</span>

<span class="n">astrodrizzle</span><span class="o">.</span><span class="n">AstroDrizzle</span><span class="p">(</span>
    <span class="n">input_flcs</span><span class="p">,</span>
    <span class="n">output</span><span class="o">=</span><span class="s2">&quot;f606w_combined&quot;</span><span class="p">,</span>
    <span class="n">preserve</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">build</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">skymethod</span><span class="o">=</span><span class="s2">&quot;match&quot;</span><span class="p">,</span>
    <span class="n">driz_sep_bits</span><span class="o">=</span><span class="n">selected_params</span><span class="p">[</span><span class="s2">&quot;driz_sep_bits&quot;</span><span class="p">],</span>
    <span class="n">driz_cr_corr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">clean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">final_bits</span><span class="o">=</span><span class="n">selected_params</span><span class="p">[</span><span class="s2">&quot;final_bits&quot;</span><span class="p">],</span>
    <span class="n">configobj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">clear_output</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>You will see the following files (among others) output by <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> in the working directory.</p>
<ol class="arabic">
<li><p>‘f606w_combined_drc.fits’ : Multi-extension FITS file.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">build</span> <span class="pre">=</span> <span class="pre">True</span></code>, the drizzled science image, context image, weight image, and median image will be combined into a single multi-extension fits file.  This file contains the following extensions:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span> Final drizzled science image is contained in [&#39;SCI&#39;, 1].
 Final drizzled weight  image is contained in [&#39;WHT&#39;, 1].
 Final drizzled context image is contained in [&#39;CTX&#39;, 1].
</pre></div>
</div>
<p>When <code class="docutils literal notranslate"><span class="pre">build</span> <span class="pre">=</span> <span class="pre">False</span></code>, these will be output as separate files (<code class="docutils literal notranslate"><span class="pre">_sci.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">_wht.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">_ctx.fits</span></code>).</p>
<p>When <code class="docutils literal notranslate"><span class="pre">final_wht_type</span> <span class="pre">=</span> <span class="pre">EXP</span></code> (default), the weight image it is effectively an exposure time map of each pixel in the final drizzled image. Other options are error ‘ERR’ and inverse variance ‘IVM’ weighting, as described <a class="reference external" href="https://drizzlepac.readthedocs.io/en/latest/drizzlepac_api/astrodrizzle.html">in more detail here</a>.</p>
<p>The context image is a map showing which images contribute to the final drizzled stack. Each input image chip is identified by a bit in a 32-bit integer. For example, image1/chip1 = 2^0 = 1, image1/chip2 = 2^1 = 2. Each context image pixel is an additive combination of these bits, depending on which images contributed to the corresponding pixel in the drizzled image.</p>
</li>
<li><p>astrodrizzle.log : Log file containing details of the drizzle processing steps.</p></li>
<li><p>f606w_combined_med.fits : Median image computed from the sky-subtracted, separately-drizzled input images.</p></li>
<li><p>j*_crclean.fits : Cosmic-ray cleaned versions of the original input flc images.</p></li>
</ol>
<p>Because we set <code class="docutils literal notranslate"><span class="pre">clean</span> <span class="pre">=</span> <span class="pre">False</span></code>, there will be various other intermediate output files in the directory, including masks, blotted frames, etc. This behavior can be modified with the <code class="docutils literal notranslate"><span class="pre">clean</span></code> and <code class="docutils literal notranslate"><span class="pre">in_memory</span></code> parameters.</p>
<section id="inspect-the-drizzled-science-image-a-id-science-a">
<h3>3.1 Inspect the drizzled science image <a id="science"></a><a class="headerlink" href="#inspect-the-drizzled-science-image-a-id-science-a" title="Permalink to this heading">#</a></h3>
<p>Finally, we inspect the science and weight images and inspect their data quality.  An imprint of sources in the weight image may indicate an error with the alignment and subsequent cosmic-ray rejection.</p>
<p>For more details on inspecting the drizzled products after reprocessing, see <a class="reference external" href="https://hst-docs.stsci.edu/drizzpac/chapter-7-data-quality-checks-and-trouble-shooting-problems/7-3-inspecting-drizzled-products-after-user-reprocessing">Section 7.3 in the DrizzlePac Handbook</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;f606w_combined_drc.fits&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdulist</span><span class="p">:</span> 
    <span class="n">drc_dat</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="s2">&quot;SCI&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="c1"># final drizzled image in SCI,1 extension</span>
    
    <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">zscale</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">drc_dat</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">drc_dat</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">z1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">z2</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greys&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;F606W drizzled science image&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/9089d96860f20577bf188e93f47300030c805e2bca3f16afd700e791ce9ff149.png" src="../../../_images/9089d96860f20577bf188e93f47300030c805e2bca3f16afd700e791ce9ff149.png" />
<img alt="../../../_images/bc2aec623c619a1814c3da235a93012845d957d6e5f3ba3dcf3c5299f09cd856.png" src="../../../_images/bc2aec623c619a1814c3da235a93012845d957d6e5f3ba3dcf3c5299f09cd856.png" />
<img alt="../../../_images/597ada1e6d3948a60d643da1ccfd3c95478efb4aff0180222c2fa65c270f6257.png" src="../../../_images/597ada1e6d3948a60d643da1ccfd3c95478efb4aff0180222c2fa65c270f6257.png" />
<img alt="../../../_images/6cbe8232a504283b497c8a6ded62ea4a98d7b530e1d4e85115a6d011bd0f024d.png" src="../../../_images/6cbe8232a504283b497c8a6ded62ea4a98d7b530e1d4e85115a6d011bd0f024d.png" />
</div>
</div>
</section>
<section id="inspect-the-final-weight-image-a-id-wht-a">
<h3>3.2 Inspect the final weight image <a id="wht"></a><a class="headerlink" href="#inspect-the-final-weight-image-a-id-wht-a" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;f606w_combined_drc.fits&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdulist</span><span class="p">:</span> 
    <span class="n">drc_dat</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="s2">&quot;WHT&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="c1"># final drizzled image in WHT,1 extension</span>

    <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">zscale</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">drc_dat</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">drc_dat</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">z1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">z2</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greys&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;F606W drizzled weight image&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/040412ff9e301349bff26e6921284325a126b40bb1ceb1680135a8d1f280c84d.png" src="../../../_images/040412ff9e301349bff26e6921284325a126b40bb1ceb1680135a8d1f280c84d.png" />
</div>
</div>
</section>
<section id="discussion-of-astrodrizzle-and-summary-a-id-discussion-a">
<h3>3.3 Discussion of AstroDrizzle and Summary <a id="discussion"></a><a class="headerlink" href="#discussion-of-astrodrizzle-and-summary-a-id-discussion-a" title="Permalink to this heading">#</a></h3>
<p>In this example, we imported and ran the <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> task on our input images, which were previously aligned with <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code>. By setting <code class="docutils literal notranslate"><span class="pre">configobj</span></code> to None, we ensured that <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> was not picking up any existing configuration files and parameters were restored to default values. We then set a select few parameters to non-default values:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">output</span> <span class="pre">=</span> <span class="pre">'f606w_combined'</span></code> : Output file name root (which will be appended with various suffixes). Defaults to input file name.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">driz_sep_bits</span> <span class="pre">=</span> <span class="pre">'256,</span> <span class="pre">64,</span> <span class="pre">16'</span></code> : Data quality flags in the <code class="docutils literal notranslate"><span class="pre">flt.fits</span></code> file, which were set during calibration, can be used as bit mask when drizzling. The user may specify which bit values should actually be considered “good” and included in image combination. In <code class="docutils literal notranslate"><span class="pre">astrodrizzle</span></code>, this parameter may be given as the sum of those DQ flags or as a comma-separated list, as shown in this example. In this example, 64 and 16 are set, so that both warm pixels and stable hot pixels, which are corrected by the dark, are treated as valid input pixels. To avoid flagging saturated pixels as CR’s, dq 256 is also set as a valid input pixel.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">driz_cr_corr</span> <span class="pre">=</span> <span class="pre">True</span></code> : When set to True, the task will create both a cosmic ray mask image (suffix <code class="docutils literal notranslate"><span class="pre">crmask.fits</span></code>) and a clean version of the original input images (suffix <code class="docutils literal notranslate"><span class="pre">crclean.fits</span></code>), where flagged pixels are replaced by pixels from the blotted median. It is strongly recommended that the quality of the cosmic ray masks be verified by blinking the original <code class="docutils literal notranslate"><span class="pre">flt.fits</span></code> input image with both the cosmic ray-cleaned image (<code class="docutils literal notranslate"><span class="pre">crclean.fits</span></code>) and the cosmic-ray mask (<code class="docutils literal notranslate"><span class="pre">crmask.fits</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">final_bits</span> <span class="pre">=</span> <span class="pre">'256,</span> <span class="pre">64,</span> <span class="pre">16'</span></code> : Similar to <code class="docutils literal notranslate"><span class="pre">driz_sep_bits</span></code>, but for the last step when all the input images are combined. To avoid filling the cores of saturated pixels with NaN, dq 256 is set as a valid input pixel.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">clean</span> <span class="pre">=</span> <span class="pre">False</span></code> : intermediate output files (e.g masks) will be kept. If True, only main outputs will be kept. Also see <code class="docutils literal notranslate"><span class="pre">in_memory</span></code> to control this behavior.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">configobj</span> <span class="pre">=</span> <span class="pre">None</span></code> : ignore any custom config files and refresh all parameters to default values.</p></li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> has a large number of parameters, which are <a class="reference external" href="https://drizzlepac.readthedocs.io/en/latest/drizzlepac_api/astrodrizzle.html">described here</a>. Running <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> using default parameter values is not recommended, as these defaults may not provide optimal science products. Users should also inspect the quality of the sky subtraction and cosmic ray rejection. For dithered data, users may experiment with the output <code class="docutils literal notranslate"><span class="pre">final_scale</span></code> and <code class="docutils literal notranslate"><span class="pre">final_pixfrac</span></code> parameters in the <code class="docutils literal notranslate"><span class="pre">final_drizzle</span></code> step. For more details, see the notebook in this repository to ‘Optimize Image Sampling’.</p>
</section>
</section>
<section id="about-this-notebook">
<h2>About this Notebook<a class="headerlink" href="#about-this-notebook" title="Permalink to this heading">#</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Created: 14 Dec 2018;     C. Shanahan &amp; J. Mack
Updated: 17 Sep 2024;     G. Anand &amp; J. Mack 
</pre></div>
</div>
<p><strong>Source:</strong> GitHub <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks">spacetelescope/hst_notebooks</a></p>
<section id="additional-resources-a-id-add-a">
<h3>Additional Resources <a id="add"></a><a class="headerlink" href="#additional-resources-a-id-add-a" title="Permalink to this heading">#</a></h3>
<p>Below are some additional resources that may be helpful. Please send any questions through the <a class="reference external" href="https://stsci.service-now.com/hst">HST Help Desk</a>, selecting the DrizzlePac category.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.stsci.edu/hst/instrumentation/acs">ACS Website</a></p></li>
<li><p><a class="reference external" href="https://hst-docs.stsci.edu/acsihb">ACS Instrument Handbook</a></p></li>
<li><p><a class="reference external" href="https://hst-docs.stsci.edu/acsdhb">ACS Data Handbook</a></p></li>
<li><p><a class="reference external" href="https://www.stsci.edu/hst/instrumentation/wfc3">WFC3 Website</a></p></li>
<li><p><a class="reference external" href="https://hst-docs.stsci.edu/wfc3ihb">WFC3 Instrument Handbook</a></p></li>
<li><p><a class="reference external" href="https://hst-docs.stsci.edu/wfc3dhb">WFC3 Data Handbook</a></p></li>
</ul>
</section>
<section id="citations-a-id-cite-a">
<h3>Citations <a id="cite"></a><a class="headerlink" href="#citations-a-id-cite-a" title="Permalink to this heading">#</a></h3>
<p>If you use Python packages such as <code class="docutils literal notranslate"><span class="pre">astropy</span></code>, <code class="docutils literal notranslate"><span class="pre">astroquery</span></code>, <code class="docutils literal notranslate"><span class="pre">drizzlepac</span></code>, <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code>, or <code class="docutils literal notranslate"><span class="pre">numpy</span></code> for published research, please cite the authors. Follow these links for more information about citing various packages.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.astropy.org/acknowledging.html">Citing <code class="docutils literal notranslate"><span class="pre">astropy</span></code></a></p></li>
<li><p><a class="reference external" href="https://github.com/astropy/astroquery/blob/main/astroquery/CITATION">Citing <code class="docutils literal notranslate"><span class="pre">astroquery</span></code></a></p></li>
<li><p><a class="reference external" href="https://zenodo.org/records/3743274">Citing <code class="docutils literal notranslate"><span class="pre">drizzlepac</span></code></a></p></li>
<li><p><a class="reference external" href="https://matplotlib.org/stable/users/project/citing.html">Citing <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code></a></p></li>
<li><p><a class="reference external" href="https://numpy.org/citing-numpy/">Citing <code class="docutils literal notranslate"><span class="pre">numpy</span></code></a></p></li>
</ul>
<hr class="docutils" />
<p><span class="xref myst">Top of Page</span>
<a class="reference internal" href="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png"><img alt="Space Telescope Logo" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="width: 200px;" /></a></p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/hst_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/DrizzlePac/align_multiple_visits"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../align_sparse_fields/align_sparse_fields.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Aligning Deep Exposures of Sparse Fields</p>
      </div>
    </a>
    <a class="right-next"
       href="../use_ds9_regions_in_tweakreg/use_ds9_regions_in_tweakreg.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">TWEAKREG Tips - Using DS9 Regions for Source Inclusion/Exclusion</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-a-id-intro-a">Introduction <a id="intro"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#download-the-observations-with-astroquery-a-id-download-a">1. Download the Observations with <code class="docutils literal notranslate"><span class="pre">astroquery</span></code> <a id="download"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-image-header-data-a-id-check-keywords-a">1.1 Check image header data <a id="check_keywords"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inspect-the-alignment-a-id-check-wcs-a">1.2 Inspect the Alignment <a id="check_wcs"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#align-with-tweakreg-a-id-tweakreg-a">2. Align with <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> <a id="tweakreg"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#first-test-use-default-parameters-a-id-default-a">2.1 First test: Use ‘default’ parameters. <a id="default"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#second-test-set-parameters-for-source-finding-a-id-sources-a">2.2 Second test: Set parameters for source finding <a id="sources"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inspect-the-quality-of-the-fit-a-id-fit-quality-a">2.3 Inspect the quality of the fit <a id="fit_quality"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fourth-test-adjust-the-fitgeometry-a-id-fit-geom-a">2.4 Fourth test: Adjust the <code class="docutils literal notranslate"><span class="pre">fitgeometry</span></code> <a id="fit_geom"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#overplot-matched-sources-on-the-image-a-id-overplot-a">2.5 Overplot Matched Sources on the Image <a id="overplot"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#update-header-once-optimal-parameters-are-found-a-id-updatehdr-a">2.6 Update header once optimal parameters are found  <a id="updatehdr"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#combine-the-images-using-astrodrizzle-a-id-adriz-a">3. Combine the Images using <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> <a id="adriz"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inspect-the-drizzled-science-image-a-id-science-a">3.1 Inspect the drizzled science image <a id="science"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inspect-the-final-weight-image-a-id-wht-a">3.2 Inspect the final weight image <a id="wht"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discussion-of-astrodrizzle-and-summary-a-id-discussion-a">3.3 Discussion of AstroDrizzle and Summary <a id="discussion"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-resources-a-id-add-a">Additional Resources <a id="add"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#citations-a-id-cite-a">Citations <a id="cite"></a></a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>