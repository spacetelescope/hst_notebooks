

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Aligning HST images to an absolute reference catalog &#8212; HST Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/table.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/DrizzlePac/align_to_catalogs/align_to_catalogs';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Optimizing Image Alignment for Multiple HST Visits" href="../align_multiple_visits/align_multiple_visits.html" />
    <link rel="prev" title="DrizzlePac Initialization" href="../Initialization/Initialization.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../index.html">
                    STScI Notebook Repository Template
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">ACS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../ACS/README.html">ACS Notebooks</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_findsat_mrt/acs_findsat_mrt_example.html">Satellite trail detection in ACS/WFC data using acstools.findsat_mrt</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_saturation_trails/acs_saturation_trails.html">ACS Linearity with Saturated Stars</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_cte_forward_model/acs_cte_forward_model_example.html">Pixel-based ACS/WFC CTE Forward Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_subarrays/acs_subarrays.html">ACS Image Reduction for Subarray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_sbc_dark_analysis/acs_sbc_dark_analysis.html">SBC Dark Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_reduction/acs_reduction.html">ACS/WFC Image Reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_pixel_area_maps/acs_pixel_area_maps.html">Obtaining Pixel Area Maps for ACS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_polarization_tools/acs_polarization_tools.html">Using ACS Polarization Tools</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">COS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../COS/README.html">COS Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../COS/Setup/Setup.html">Setting up your computer environment for working with COS data</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/DataDl/DataDl.html">Downloading COS Data</a></li>




<li class="toctree-l1"><a class="reference internal" href="../../COS/ViewData/ViewData.html">Viewing COS Data</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/AsnFile/AsnFile.html">Modifying or Creating an Association File</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/CalCOS/CalCOS.html">Running the COS Data Pipeline (<code class="docutils literal notranslate"><span class="pre">CalCOS</span></code>)</a></li>






<li class="toctree-l1"><a class="reference internal" href="../../COS/SplitTag/SplitTag.html">Splitting COS Exposures into sub-exposures with <code class="docutils literal notranslate"><span class="pre">splittag</span></code></a></li>







<li class="toctree-l1"><a class="reference internal" href="../../COS/DayNight/DayNight.html">Filtering out COS Data taken during the Day or Night</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../COS/LSF/LSF.html">Working with the COS Line Spread Function (LSF)</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../COS/Extract/Extract.html">Editing the extraction boxes in a spectral extraction file (<code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>)</a></li>







</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">DrizzlePac</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../README.html">DrizzlePac Jupyter Notebook Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Initialization/Initialization.html">DrizzlePac Initialization</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Aligning HST images to an absolute reference catalog</a></li>



<li class="toctree-l1"><a class="reference internal" href="../align_multiple_visits/align_multiple_visits.html">Optimizing Image Alignment for Multiple HST Visits</a></li>

<li class="toctree-l1"><a class="reference internal" href="../align_sparse_fields/align_sparse_fields.html">Aligning Deep Exposures of Sparse Fields</a></li>








<li class="toctree-l1"><a class="reference internal" href="../drizzle_wfpc2/drizzle_wfpc2.html">Drizzling WFPC2 Images to use a Single Zeropoint</a></li>

<li class="toctree-l1"><a class="reference internal" href="../mask_satellite/mask_satellite.html">Satellite Trail Masking Techniques</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimize_image_sampling/optimize_image_sampling.html">Optimizing the Image Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_updated_astrometry_solutions/using_updated_astrometry_solutions.html">Using updated astrometry solutions</a></li>


</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NICMOS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NICMOS/nicmos_unit_conversion/nicmos_unit_conversion.html">Programmatic Replacements for NICMOS Units Conversion Form</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">STIS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../STIS/README.html">STIS-Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/calstis/calstis_2d_ccd.html">Calstis 2-D CCD Data Reduction <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/target_acquisition/target_acquisition.html">Evaluating STIS Target Acquisitions <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/view_data/view_data.html">Viewing STIS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/extraction/1D_Extraction.html">1D Spectra Extraction <a class="tocSkip"></a></a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/spacetelescope/hst_notebooks/blob/main/notebooks/DrizzlePac/align_to_catalogs/align_to_catalogs.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/hst_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/hst_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/DrizzlePac/align_to_catalogs/align_to_catalogs.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/DrizzlePac/align_to_catalogs/align_to_catalogs.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Aligning HST images to an absolute reference catalog</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Aligning HST images to an absolute reference catalog</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#download-the-data">1. Download the Data</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#inspect-the-image-header">Inspect the image header</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#querying-catalogs">2. Querying catalogs</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-identify-coordinates">2a. Identify Coordinates</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#b-sdss-query">2b. SDSS Query</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#c-gaia-query">2c. Gaia Query</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-tweakreg">3. Running TweakReg</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-sdss-alignment">3a. SDSS Alignment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-gaia-alignment">3b. Gaia Alignment</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#drizzle-the-data">4. Drizzle the Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusions">Conclusions</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="aligning-hst-images-to-an-absolute-reference-catalog">
<h1>Aligning HST images to an absolute reference catalog<a class="headerlink" href="#aligning-hst-images-to-an-absolute-reference-catalog" title="Permalink to this heading">#</a></h1>
<hr class="docutils" />
<div class="alert-danger">Note: The notebook in this repository 'Initializtion.ipynb' goes over many of the basic concepts such as the setup of the environment/package installation and should be read first if you are new to HST images, 'DrizzlePac' or 'Astroquery'.</div><div class="alert-warning">Note: This notebook is based on WFC3 ISR 2017-19: <a href="http://www.stsci.edu/hst/wfc3/documents/ISRs/WFC3-2017-19.pdf">Aligning HST Images to Gaia: a Faster Mosaicking Workflow</a> and contains a subset of the information/code found in <a href="https://github.com/spacetelescope/gaia_alignment">the repository here</a>.  For more information, see the notebook in that repository titled 'Gaia_alignment.ipynb'.</div><section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p>The alignment of HST exposures is a critical step in image stacking/combination performed by software such as <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code>.  Generally, a relative alignment is performed that aligns one image (or multiple images) to another image which is designated as the reference image.  This makes it so the images are aligned to each other, but the pointing error of the observatory can still cause the images to have incorrect absolute astrometry.</p>
<p>When absolute astrometry is desired, the images can be aligned to an external catalog that is known to be on an absolute frame.  In this example, we will provide a workflow to query catalogs such as SDSS and Gaia via the astroquery package, and then align the images to that catalog via TweakReg.</p>
<p>For more information about TweakReg, see the other notebooks in this repository or the <strong><a class="reference external" href="https://drizzlepac.readthedocs.io/en/deployment/tweakreg.html">TweakReg Documentation</a></strong>.</p>
<p>For more information on Astroquery, see the other notebooks in this repository or the <strong><a class="reference external" href="https://astroquery.readthedocs.io/en/latest/">Astroquery Documentation</a></strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">astropy.units</span> <span class="kn">import</span> <span class="n">Quantity</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span> <span class="nn">astroquery.gaia</span> <span class="kn">import</span> <span class="n">Gaia</span>
<span class="kn">from</span> <span class="nn">astroquery.mast</span> <span class="kn">import</span> <span class="n">Observations</span>
<span class="kn">from</span> <span class="nn">astroquery.sdss</span> <span class="kn">import</span> <span class="n">SDSS</span>

<span class="kn">from</span> <span class="nn">ccdproc</span> <span class="kn">import</span> <span class="n">ImageFileCollection</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="kn">from</span> <span class="nn">drizzlepac</span> <span class="kn">import</span> <span class="n">tweakreg</span>
<span class="kn">from</span> <span class="nn">drizzlepac</span> <span class="kn">import</span> <span class="n">astrodrizzle</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="download-the-data">
<h1>1. Download the Data<a class="headerlink" href="#download-the-data" title="Permalink to this heading">#</a></h1>
<p>For this example, we will use WFC3/UVIS images of NGC 6791 from Visit 01 of proposal 12692.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the observation records</span>
<span class="n">obsTable</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span><span class="n">obs_id</span><span class="o">=</span><span class="s1">&#39;ibwb01*&#39;</span><span class="p">,</span> <span class="n">proposal_id</span><span class="o">=</span><span class="mi">12692</span><span class="p">,</span> <span class="n">obstype</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="s1">&#39;F606W&#39;</span><span class="p">)</span>

<span class="c1"># Get the listing of data products</span>
<span class="n">products</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span><span class="n">obsTable</span><span class="p">)</span>

<span class="c1"># Filter the products for exposures</span>
<span class="n">filtered_products</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">filter_products</span><span class="p">(</span><span class="n">products</span><span class="p">,</span> <span class="n">productSubGroupDescription</span><span class="o">=</span><span class="s1">&#39;FLC&#39;</span><span class="p">)</span>

<span class="c1"># Show the table</span>
<span class="n">filtered_products</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download all the images above</span>
<span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span><span class="n">filtered_products</span><span class="p">,</span> <span class="n">mrp_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For convenience, move the products into the current directory.</span>
<span class="k">for</span> <span class="n">flc</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;./mastDownload/HST/*/*flc.fits&#39;</span><span class="p">):</span>
    <span class="n">flc_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">flc</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">flc</span><span class="p">,</span> <span class="n">flc_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="inspect-the-image-header">
<h2>Inspect the image header<a class="headerlink" href="#inspect-the-image-header" title="Permalink to this heading">#</a></h2>
<p>The cell below shows how to query information from the image header using <code class="docutils literal notranslate"><span class="pre">ImageFileCollection</span></code> in <code class="docutils literal notranslate"><span class="pre">ccdproc</span></code>.
We see that the 1st exposure is 30 seconds and the 2nd and 3rd exposures are 360 seconds. The 3rd exposure is dithered by ~82” in the Y-direction which is approximately the width of one UVIS chip.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">collec</span> <span class="o">=</span> <span class="n">ImageFileCollection</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="n">glob_include</span><span class="o">=</span><span class="s2">&quot;*flc.fits&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                             <span class="n">keywords</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;targname&quot;</span><span class="p">,</span> <span class="s2">&quot;ra_targ&quot;</span><span class="p">,</span> <span class="s2">&quot;dec_targ&quot;</span><span class="p">,</span> <span class="s2">&quot;filter&quot;</span><span class="p">,</span> <span class="s2">&quot;exptime&quot;</span><span class="p">,</span> <span class="s2">&quot;postarg1&quot;</span><span class="p">,</span> <span class="s2">&quot;postarg2&quot;</span><span class="p">])</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">collec</span><span class="o">.</span><span class="n">summary</span>
<span class="n">table</span><span class="p">[</span><span class="s1">&#39;exptime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;7.1f&#39;</span>
<span class="n">table</span><span class="p">[</span><span class="s1">&#39;ra_targ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;7.7f&#39;</span>
<span class="n">table</span><span class="p">[</span><span class="s1">&#39;dec_targ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;7.7f&#39;</span>
<span class="n">table</span><span class="p">[</span><span class="s1">&#39;postarg1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;7.2f&#39;</span>
<span class="n">table</span><span class="p">[</span><span class="s1">&#39;postarg2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;7.2f&#39;</span>
<span class="n">table</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="querying-catalogs">
<h1>2. Querying catalogs<a class="headerlink" href="#querying-catalogs" title="Permalink to this heading">#</a></h1>
<p>Now that we have the images, we will download the reference catalogs from both SDSS and Gaia using <code class="docutils literal notranslate"><span class="pre">astroquery</span></code>.</p>
<section id="a-identify-coordinates">
<h2>2a. Identify Coordinates<a class="headerlink" href="#a-identify-coordinates" title="Permalink to this heading">#</a></h2>
<p>We will first create a SkyCoord Object to point astroquery to where we are looking on the sky.  Since our example uses data from NGC 6791, we will use the <code class="docutils literal notranslate"><span class="pre">ra_targ</span></code> and <code class="docutils literal notranslate"><span class="pre">dec_targ</span></code> keywords from the first image to get the coordinates of the object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RA</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s1">&#39;ra_targ&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Dec</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s1">&#39;dec_targ&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="b-sdss-query">
<h2>2b. SDSS Query<a class="headerlink" href="#b-sdss-query" title="Permalink to this heading">#</a></h2>
<p>We now give those values to an astropy <code class="docutils literal notranslate"><span class="pre">SkyCoord</span></code> object, which we will pass to the SDSS.  Additionally, we use an astropy <code class="docutils literal notranslate"><span class="pre">Quantity</span></code> object to create a radius for the SDSS query.  We set the radius to 6 arcminutes to comfortably cover the area of our images. For reference UVIS detector field of view is ~2.7’x2.7’ and a y-dither of 82” covers a total area on the sky of ~2.7’x4.1’.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">RA</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">Dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
<span class="n">radius</span> <span class="o">=</span> <span class="n">Quantity</span><span class="p">(</span><span class="mf">6.</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">arcmin</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Then we only need to perform the query via the <code class="docutils literal notranslate"><span class="pre">SDSS.query_region</span></code> method of <code class="docutils literal notranslate"><span class="pre">astroquery.sdss</span></code>. The <code class="docutils literal notranslate"><span class="pre">spectro=False</span></code> keyword argument means we want to exclude spectroscopic objects, as we are looking for objects to match with an image.</p>
<p>In the fields parameter, we specify a list of fields we want returned by the query.  In this case we only need the position, and maybe a magnitude ‘g’ if we want to cut very dim and/or bright objects out of the catalog, as those are likely measured poorly. Details on selecting objects by magnitude may be found in the original <a class="reference external" href="https://github.com/spacetelescope/gaia_alignment">‘Gaia_alignment’ notebook</a>.  Many other fields are available in the SDSS query and are <a class="reference external" href="http://cas.sdss.org/dr7/en/help/browser/description.asp?n=PhotoObj&amp;t=V">documented here</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sdss_query</span> <span class="o">=</span> <span class="n">SDSS</span><span class="o">.</span><span class="n">query_region</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">spectro</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">])</span>
<span class="n">sdss_query</span>
</pre></div>
</div>
</div>
</div>
<p>We then just need to save the catalog to use with TweakReg.  Since the returned value of the query is an <code class="docutils literal notranslate"><span class="pre">astropy.Table</span></code>, saving the file is very straightforward:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sdss_query</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;sdss.cat&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii.commented_header&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="c-gaia-query">
<h2>2c. Gaia Query<a class="headerlink" href="#c-gaia-query" title="Permalink to this heading">#</a></h2>
<p>Similarly to SDSS, we can query Gaia catalogs for our target via <code class="docutils literal notranslate"><span class="pre">astroquery.gaia</span></code>.  We can use the same <code class="docutils literal notranslate"><span class="pre">coord</span></code> and  <code class="docutils literal notranslate"><span class="pre">radius</span></code> from the SDSS query.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gaia_query</span> <span class="o">=</span> <span class="n">Gaia</span><span class="o">.</span><span class="n">query_object_async</span><span class="p">(</span><span class="n">coordinate</span><span class="o">=</span><span class="n">coord</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">)</span>
<span class="n">gaia_query</span>
</pre></div>
</div>
</div>
</div>
<p>This query has returned very large number of columns. We want to pare down the catalog to make it easier to use with <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code>.<br />
We can select only the useful columns via:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reduced_query</span> <span class="o">=</span> <span class="n">gaia_query</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="s1">&#39;phot_g_mean_mag&#39;</span><span class="p">]</span>
<span class="n">reduced_query</span>
</pre></div>
</div>
</div>
</div>
<p>Then we write this catalog to an ascii file for use with <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reduced_query</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;gaia.cat&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii.commented_header&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="running-tweakreg">
<h2>3. Running TweakReg<a class="headerlink" href="#running-tweakreg" title="Permalink to this heading">#</a></h2>
<p>With the catalogs downloaded and the headers populated, we simply need to run TweakReg with each catalog passed into the <code class="docutils literal notranslate"><span class="pre">refcat</span></code> parameter. The steps below compare the astrometric residuals obtained from aligning to each <code class="docutils literal notranslate"><span class="pre">refcat</span></code>. In each test case, we set <code class="docutils literal notranslate"><span class="pre">updatehdr</span></code> to False until we are satisfied with the alignment by inspecting both the shift file and the astrometric residual plots.</p>
<section id="a-sdss-alignment">
<h3>3a. SDSS Alignment<a class="headerlink" href="#a-sdss-alignment" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">refcat</span> <span class="o">=</span> <span class="s1">&#39;sdss.cat&#39;</span>
<span class="n">cw</span> <span class="o">=</span> <span class="mf">3.5</span>  <span class="c1"># Set to two times the FWHM of the PSF of the UVIS detector</span>
<span class="n">wcsname</span> <span class="o">=</span> <span class="s1">&#39;SDSS&#39;</span>  <span class="c1"># Specify the WCS name for this alignment</span>

<span class="n">tweakreg</span><span class="o">.</span><span class="n">TweakReg</span><span class="p">(</span><span class="s1">&#39;*flc.fits&#39;</span><span class="p">,</span>  <span class="c1"># Pass input images</span>
                  <span class="n">updatehdr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># update header with new WCS solution</span>
                  <span class="n">imagefindcfg</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="mf">500.</span><span class="p">,</span> <span class="s1">&#39;conv_width&#39;</span><span class="p">:</span> <span class="n">cw</span><span class="p">},</span>  <span class="c1"># Detection parameters, threshold varies for different data</span>
                  <span class="n">refcat</span><span class="o">=</span><span class="n">refcat</span><span class="p">,</span>  <span class="c1"># Use user supplied catalog (Gaia)</span>
                  <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">see2dplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">shiftfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Save out shift file (so we can look at shifts later)</span>
                  <span class="n">outshifts</span><span class="o">=</span><span class="s1">&#39;SDSS_shifts.txt&#39;</span><span class="p">,</span>  <span class="c1"># name of the shift file</span>
                  <span class="n">wcsname</span><span class="o">=</span><span class="n">wcsname</span><span class="p">,</span>  <span class="c1"># Give our WCS a new name</span>
                  <span class="n">reusename</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">ylimit</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                  <span class="n">fitgeometry</span><span class="o">=</span><span class="s1">&#39;general&#39;</span><span class="p">)</span>  <span class="c1"># Use the 6 parameter fit</span>
</pre></div>
</div>
</div>
</div>
<p>We can look at the shift file to see how well the fit did (or we could open the output png images for more information).</p>
<p>The columns are:</p>
<ul class="simple">
<li><p>Filename</p></li>
<li><p>X Shift [pixels]</p></li>
<li><p>Y Shift [pixels]</p></li>
<li><p>Rotation [degrees]</p></li>
<li><p>Scale</p></li>
<li><p>X RMS [pixels]</p></li>
<li><p>Y RMS [pixels]</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;SDSS_shifts.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Astrometric residual plots</span>
<span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;residuals_ibwb01xqq_flc.png&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;residuals_ibwb01xrq_flc.png&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;residuals_ibwb01xxq_flc.png&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>As we can see, the RMS is fairly large at about 0.5 pixels, which is not a great fit. This is likely because the SDSS astrometric precision is not high enough to get good HST alignment. One approach would be to align the first image to SDSS and then align the remaining HST images to one another. This would improve both the absolute and relative alignment of the individual frames.</p>
</section>
<section id="b-gaia-alignment">
<h3>3b. Gaia Alignment<a class="headerlink" href="#b-gaia-alignment" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">refcat</span> <span class="o">=</span> <span class="s1">&#39;gaia.cat&#39;</span>
<span class="n">cw</span> <span class="o">=</span> <span class="mf">3.5</span>  <span class="c1"># Set to two times the FWHM of the PSF.</span>
<span class="n">wcsname</span> <span class="o">=</span> <span class="s1">&#39;Gaia&#39;</span>  <span class="c1"># Specify the WCS name for this alignment</span>

<span class="n">tweakreg</span><span class="o">.</span><span class="n">TweakReg</span><span class="p">(</span><span class="s1">&#39;*flc.fits&#39;</span><span class="p">,</span>  <span class="c1"># Pass input images</span>
                  <span class="n">updatehdr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># update header with new WCS solution</span>
                  <span class="n">imagefindcfg</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;threshold&#39;</span><span class="p">:</span><span class="mf">500.</span><span class="p">,</span><span class="s1">&#39;conv_width&#39;</span><span class="p">:</span><span class="n">cw</span><span class="p">},</span>  <span class="c1"># Detection parameters, threshold varies for different data</span>
                  <span class="n">refcat</span><span class="o">=</span><span class="n">refcat</span><span class="p">,</span>  <span class="c1"># Use user supplied catalog (Gaia)</span>
                  <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">see2dplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">shiftfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Save out shift file (so we can look at shifts later)</span>
                  <span class="n">outshifts</span><span class="o">=</span><span class="s1">&#39;Gaia_shifts.txt&#39;</span><span class="p">,</span>  <span class="c1"># name of the shift file</span>
                  <span class="n">wcsname</span><span class="o">=</span><span class="n">wcsname</span><span class="p">,</span>  <span class="c1"># Give our WCS a new name</span>
                  <span class="n">reusename</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">sigma</span><span class="o">=</span><span class="mf">2.3</span><span class="p">,</span>
                  <span class="n">ylimit</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                  <span class="n">fitgeometry</span><span class="o">=</span><span class="s1">&#39;general&#39;</span><span class="p">)</span>  <span class="c1"># Use the 6 parameter fit</span>
</pre></div>
</div>
</div>
</div>
<p>We can similarly look at the shift file from alignment to the Gaia catalog:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;Gaia_shifts.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Astrometric residual plots</span>
<span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;residuals_ibwb01xqq_flc.png&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;residuals_ibwb01xrq_flc.png&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;residuals_ibwb01xxq_flc.png&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>As expected, the Gaia catalog does quite a bit better, with rms residuals less tha 0.05 pixels.</p>
<p>To apply these transformations to the image, we simply need to run TweakReg the same as before, but set the parameter <code class="docutils literal notranslate"><span class="pre">updatehdr</span></code> equal to <code class="docutils literal notranslate"><span class="pre">True</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">refcat</span> <span class="o">=</span> <span class="s1">&#39;gaia.cat&#39;</span>
<span class="n">cw</span> <span class="o">=</span> <span class="mf">3.5</span>  <span class="c1"># Set to two times the FWHM of the PSF.</span>
<span class="n">wcsname</span> <span class="o">=</span> <span class="s1">&#39;Gaia&#39;</span>  <span class="c1"># Specify the WCS name for this alignment</span>

<span class="n">tweakreg</span><span class="o">.</span><span class="n">TweakReg</span><span class="p">(</span><span class="s1">&#39;*flc.fits&#39;</span><span class="p">,</span>  <span class="c1"># Pass input images</span>
                  <span class="n">updatehdr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># update header with new WCS solution</span>
                  <span class="n">imagefindcfg</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="mf">500.</span><span class="p">,</span> <span class="s1">&#39;conv_width&#39;</span><span class="p">:</span> <span class="n">cw</span><span class="p">},</span>  <span class="c1"># Detection parameters, threshold varies for different data</span>
                  <span class="n">refcat</span><span class="o">=</span><span class="n">refcat</span><span class="p">,</span>  <span class="c1"># Use user supplied catalog (Gaia)</span>
                  <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">see2dplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">shiftfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Save out shift file (so we can look at shifts later)</span>
                  <span class="n">outshifts</span><span class="o">=</span><span class="s1">&#39;Gaia_shifts.txt&#39;</span><span class="p">,</span>  <span class="c1"># name of the shift file</span>
                  <span class="n">wcsname</span><span class="o">=</span><span class="n">wcsname</span><span class="p">,</span>  <span class="c1"># Give our WCS a new name</span>
                  <span class="n">reusename</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">sigma</span><span class="o">=</span><span class="mf">2.3</span><span class="p">,</span>
                  <span class="n">fitgeometry</span><span class="o">=</span><span class="s1">&#39;general&#39;</span><span class="p">)</span>  <span class="c1"># Use the 6 parameter fit</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="drizzle-the-data">
<h2>4. Drizzle the Data<a class="headerlink" href="#drizzle-the-data" title="Permalink to this heading">#</a></h2>
<p>While the three sets of FLC files are now aligned, we drizzle together only the two long exposures.</p>
<p>When exposures are very different lengths, drizzling them together doesn’t work well when ‘EXP’ weighting is used. For objects that saturate in the long exposures, the problem occurs at the boundary where you transition from only short exposure to short plus long. Here the pixels getting power from long exposure pixels are only getting power from pixels whose centers are outside the ring, and thus they are weighted lower than they would be if they were getting values from both inside and outside the ring. The result is a discontinuity in the PSF radial profile and a resulting flux which is too low in those boundary pixels. For photometry of saturated objects, the short exposures should be drizzled separately from the long exposures.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">astrodrizzle</span><span class="o">.</span><span class="n">AstroDrizzle</span><span class="p">(</span><span class="s1">&#39;ibwb01x[rx]q_flc.fits&#39;</span><span class="p">,</span> 
                          <span class="n">output</span><span class="o">=</span><span class="s1">&#39;f606w&#39;</span><span class="p">,</span>
                          <span class="n">preserve</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">clean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                          <span class="n">build</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">context</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">skymethod</span><span class="o">=</span><span class="s1">&#39;match&#39;</span><span class="p">,</span>
                          <span class="n">driz_sep_bits</span><span class="o">=</span><span class="s1">&#39;64, 32&#39;</span><span class="p">,</span>
                          <span class="n">combine_type</span><span class="o">=</span><span class="s1">&#39;minmed&#39;</span><span class="p">,</span>
                          <span class="n">final_bits</span><span class="o">=</span><span class="s1">&#39;64, 32&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display the combined science and weight images </span>

<span class="n">sci</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="s1">&#39;f606w_drc_sci.fits&#39;</span><span class="p">)</span>
<span class="n">wht</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="s1">&#39;f606w_drc_wht.fits&#39;</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sci</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wht</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="conclusions">
<h2>Conclusions<a class="headerlink" href="#conclusions" title="Permalink to this heading">#</a></h2>
<p>Many other services have interfaces for querying catalogs which could also be used to align HST images.  In general, Gaia works very well for HST due to it’s high precision, but can have a low number of sources in some regions, especially at high galactic latitudes.  Aligning images to an absolute frame provides an easy way to make data comparable across many epochs/detectors/observatories, and in many cases, makes the alignment much easier.</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="about-this-notebook">
<h1>About this Notebook<a class="headerlink" href="#about-this-notebook" title="Permalink to this heading">#</a></h1>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Author: V. Bajaj, STScI WFC3 Team
Updated: December 14, 2018
</pre></div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/hst_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/DrizzlePac/align_to_catalogs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="../Initialization/Initialization.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">DrizzlePac Initialization</p>
      </div>
    </a>
    <a class="right-next"
       href="../align_multiple_visits/align_multiple_visits.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Optimizing Image Alignment for Multiple HST Visits</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Aligning HST images to an absolute reference catalog</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#download-the-data">1. Download the Data</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#inspect-the-image-header">Inspect the image header</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#querying-catalogs">2. Querying catalogs</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-identify-coordinates">2a. Identify Coordinates</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#b-sdss-query">2b. SDSS Query</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#c-gaia-query">2c. Gaia Query</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-tweakreg">3. Running TweakReg</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-sdss-alignment">3a. SDSS Alignment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-gaia-alignment">3b. Gaia Alignment</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#drizzle-the-data">4. Drizzle the Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusions">Conclusions</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>