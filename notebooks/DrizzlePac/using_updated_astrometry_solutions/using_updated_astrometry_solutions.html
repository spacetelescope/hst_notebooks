

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Improving Astrometry Using Alternate WCS Solutions &#8212; HST Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/table.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/DrizzlePac/using_updated_astrometry_solutions/using_updated_astrometry_solutions';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Aligning HST images to an Absolute Reference Catalog" href="../align_to_catalogs/align_to_catalogs.html" />
    <link rel="prev" title="DrizzlePac Notebooks" href="../README.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="HST Notebooks - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="HST Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../index.html">
                    STScI HST Notebook Repository HQ
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">ACS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../ACS/README.html">ACS Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_findsat_mrt/acs_findsat_mrt_example.html">Satellite trail detection in ACS/WFC data using acstools.findsat_mrt</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_saturation_trails/acs_saturation_trails.html">ACS Linearity with Saturated Stars</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_cte_forward_model/acs_cte_forward_model_example.html">Pixel-based ACS/WFC CTE Forward Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_subarrays/acs_subarrays.html">ACS Image Reduction for Subarray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_sbc_dark_analysis/acs_sbc_dark_analysis.html">SBC Dark Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_reduction/acs_reduction.html">ACS/WFC Image Reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_pixel_area_maps/acs_pixel_area_maps.html">ACS Pixel Area Maps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_polarization_tools/acs_polarization_tools.html">Using ACS Polarization Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_focus_diverse_epsfs/acs_focus_diverse_epsfs.html">Focus Diverse ePSFs for ACS/WFC</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">COS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../COS/README.html">COS Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../COS/Setup/Setup.html">Setting up your computer environment for working with COS data</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/DataDl/DataDl.html">Downloading COS Data</a></li>




<li class="toctree-l1"><a class="reference internal" href="../../COS/ViewData/ViewData.html">Viewing COS Data</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/AsnFile/AsnFile.html">Modifying or Creating an Association File</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/CalCOS/CalCOS.html">Running the COS Data Pipeline (<code class="docutils literal notranslate"><span class="pre">CalCOS</span></code>)</a></li>






<li class="toctree-l1"><a class="reference internal" href="../../COS/SplitTag/SplitTag.html">Splitting COS Exposures into sub-exposures with <code class="docutils literal notranslate"><span class="pre">splittag</span></code></a></li>







<li class="toctree-l1"><a class="reference internal" href="../../COS/DayNight/DayNight.html">Filtering out COS Data taken during the Day or Night</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../COS/LSF/LSF.html">Working with the COS Line Spread Function (LSF)</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../COS/Extract/Extract.html">Editing the extraction boxes in a spectral extraction file (<code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>)</a></li>







<li class="toctree-l1"><a class="reference internal" href="../../COS/ExceptionReport/ExceptionReport.html">What to do when you get an Exception Report for COS</a></li>







</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">DrizzlePac</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../README.html">DrizzlePac Notebooks</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Improving Astrometry Using Alternate WCS Solutions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../align_to_catalogs/align_to_catalogs.html">Aligning HST images to an Absolute Reference Catalog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../align_sparse_fields/align_sparse_fields.html">Aligning Deep Exposures of Sparse Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../align_multiple_visits/align_multiple_visits.html">Optimizing Image Alignment for Multiple HST Visits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use_ds9_regions_in_tweakreg/use_ds9_regions_in_tweakreg.html">TWEAKREG Tips - Using DS9 Regions for Source Inclusion/Exclusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimize_image_sampling/optimize_image_sampling.html">Optimizing the Image Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../align_mosaics/align_mosaics.html">Aligning HST Mosaics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sky_matching/sky_matching.html">Sky Matching for HST Mosaics <a id="top"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../mask_satellite/mask_satellite.html">Satellite Trail Masking Techniques</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">HASP</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../HASP/Setup/Setup.html">Installing the Hubble Advanced Spectral Products Script</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../HASP/CoaddTutorial/CoaddTutorial.html">Inputting User Data using the Hubble Advanced Spectral Products Script</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../HASP/FluxScaleTutorial/FluxScaleTutorial.html">Scaling Flux while using the Hubble Advanced Spectral Products Script</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../HASP/DataDiagnostic/DataDiagnostics.html">HASP Data Diagnostic Notebook</a></li>




<li class="toctree-l1"><a class="reference internal" href="../../HASP/WavelengthAdjustment/WavelengthAdjustment.html">Wavelength Adjustments for Running the Hubble Advanced Spectral Products (HASP) Script</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NICMOS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NICMOS/nicmos_unit_conversion/nicmos_unit_conversion.html">Programmatic Replacements for NICMOS Units Conversion Form</a></li>


</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">STIS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../STIS/README.html">STIS Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/cross-correlation/cross-correlation.html">Correcting for Missing Wavecals with Cross-Correlation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/custom_ccd_darks/custom_ccd_darks.html">Custom CCD Darks <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/drizpac_notebook/STIS_DrizzlePac_Tutorial.html">STIS DrizzlePac Tutorial <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/CoronagraphyViz/STIS_Coronagraphy_Visualization_v2.html">STIS Coronagraphy Visualization Tool (v2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/calstis/calstis_2d_ccd.html">Calstis 2-D CCD Data Reduction <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/target_acquisition/target_acquisition.html">Evaluating STIS Target Acquisitions <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/view_data/view_data.html">Viewing STIS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/extraction/1D_Extraction.html">1D Spectra Extraction <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/low_count_uncertainties/Low_Count_Uncertainties.html">Low Count Uncertainties in STIS <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/contrast_sensitivity/STIS_Coronagraphic_Observation_Feasibility.html">STIS Coronagraphic Observation Feasibility</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">WFC3</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/README.html">WFC3 Notebooks</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../WFC3/general_tools.html">General Tools</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/image_displayer_analyzer/wfc3_image_displayer_analyzer.html">WFC3 Image Displayer &amp; Analyzer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/exception_report/wfc3_exception_report.html">Exception Report Checklist - WFC3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/calwf3_v1.0_cte/calwf3_with_v1.0_PCTE.html">Processing WFC3/UVIS Data with <code class="docutils literal notranslate"><span class="pre">calwf3</span></code> Using the v1.0 CTE-Correction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/persistence/wfc3_ir_persistence.html">Masking Persistence in WFC3/IR Images</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../WFC3/ir_tvb.html">WFC3/IR Time Variable Background (TVB)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/ir_ima_visualization/IR_IMA_Visualization_with_an_Example_of_Time_Variable_Background.html">WFC3/IR IMA Visualization Tools with An Example of Time Variable Background</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/calwf3_recalibration/calwf3_recal_tvb.html">Manual Recalibration with calwf3: Turning off the IR Linear Ramp Fit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/tvb_flattenramp/TVB_flattenramp_notebook.html">Correcting for Helium Line Emission Background in IR Exposures using the “Flatten-Ramp” Technique</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/ir_scattered_light_calwf3_corrections/Correcting_for_Scattered_Light_in_IR_Exposures_Using_calwf3_to_Mask_Bad_Reads.html">Correcting for Scattered Light in WFC3/IR Exposures: Using <code class="docutils literal notranslate"><span class="pre">calwf3</span></code> to Mask Bad Reads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/ir_scattered_light_manual_corrections/Correcting_for_Scattered_Light_in_IR_Exposures_by_Manually_Subtracting_Bad_Reads.html">Correcting for Scattered Light in WFC3/IR Exposures: Manually Subtracting Bad Reads</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../WFC3/photometry.html">Photometry</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/filter_transformations/filter_transformations.html">WFC3/UVIS Filter Transformations with stsynphot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/flux_conversion_tool/flux_conversion_tool.html">Flux Unit Conversions with synphot and stsynphot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/photometry_examples/phot_examples.html">Synthetic Photometry Examples for WFC3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/uvis_time_dependent_photometry/uvis_timedep_phot.html">WFC3/UVIS Time-dependent Photometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/zeropoints/zeropoints.html">Calculating WFC3 Zeropoints with STSynphot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/uvis_pam_corrections/WFC3_UVIS_Pixel_Area_Map_Corrections_for_Subarrays.html">WFC3/UVIS Pixel Area Map Corrections for Subarrays</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../WFC3/point_spread_function.html">Point Spread Function (PSF)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/point_spread_function/hst_point_spread_function.html">HST WFC3 Point Spread Function Modeling   </a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/mast_api_psf/download_psf_cutouts.html">Downloading WFC3 and WFPC2 PSF Cutouts from MAST</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/spacetelescope/hst_notebooks/blob/main/notebooks/DrizzlePac/using_updated_astrometry_solutions/using_updated_astrometry_solutions.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/hst_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/hst_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/DrizzlePac/using_updated_astrometry_solutions/using_updated_astrometry_solutions.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/DrizzlePac/using_updated_astrometry_solutions/using_updated_astrometry_solutions.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Improving Astrometry Using Alternate WCS Solutions</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-packages">Import Packages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-data-download">0. Example Data Download</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#new-extensions-on-fits-files">1. New extensions on FITS files</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-different-solutions">2. Exploring different solutions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#applying-a-headerlet-to-the-science-extensions">3. Applying a headerlet to the science extensions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#changing-to-alternate-wcs-solutions">4. Changing to alternate WCS solutions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-rel-gaia-edr3-solution">4.1 FIT-REL Gaia eDR3 solution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-priori-solution">4.2 “a priori” solution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#distortion-only-solution">4.3 “distortion only” solution</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-downloaded-svm-headerlets">5. Using downloaded SVM headerlets</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-astrodrizzle">6. Running <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusions">Conclusions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-resources">Additional Resources</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#citations">Citations</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><a id="top"></a></p>
<section class="tex2jax_ignore mathjax_ignore" id="improving-astrometry-using-alternate-wcs-solutions">
<h1>Improving Astrometry Using Alternate WCS Solutions<a class="headerlink" href="#improving-astrometry-using-alternate-wcs-solutions" title="Permalink to this heading">#</a></h1>
<div class="alert alert-block alert-warning" style="color:black" > <b> This notebook requires creating and activating a virtual environment using the requirements file in this notebook's repository. Please also review the README file before using the notebook.</b> <br> </div>
<section id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Permalink to this heading">#</a></h2>
<p><a id="toc"></a></p>
<p><span class="xref myst">Introduction</span> <br>
<span class="xref myst">Import Packages</span> <br></p>
<ol class="arabic simple" start="0">
<li><p><span class="xref myst">Example Data Download</span></p></li>
<li><p><span class="xref myst">New Extensions on FITS Files</span></p></li>
<li><p><span class="xref myst">Exploring different solutions</span></p></li>
<li><p><span class="xref myst">Applying a headerlet to the science extensions</span></p></li>
<li><p><span class="xref myst">Changing to alternate WCS solutions</span><br>
       4.1 <span class="xref myst">FIT-REL Gaia eDR3 solution</span><br>
       4.2 <span class="xref myst">“a priori” solution</span><br>
       4.3 <span class="xref myst">“distortion-only” solution</span><br>
       4.4 <span class="xref myst">FIT-SVM Gaia DR2 solution</span><br></p></li>
<li><p><span class="xref myst">Using downloaded SVM headerlets</span></p></li>
<li><p><span class="xref myst">Running AstroDrizzle</span></p></li>
</ol>
<p><span class="xref myst">Conclusions</span> <br>
<span class="xref myst">About this Notebook</span></p>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p><a id="intro"></a></p>
<p>Starting in December 2019, improved astrometric solutions for ACS and WFC3 images are available in the World Coordinate System (WCS) of the exposure file (<code class="docutils literal notranslate"><span class="pre">flt.fits</span></code> and <code class="docutils literal notranslate"><span class="pre">flc.fits</span></code>) FITS headers, with alternate WCS solutions appended as additional headerlet extensions. These solutions are also available as separate <a class="reference external" href="https://stwcs.readthedocs.io/en/latest/headerlet.html">headerlet</a> FITS files which may be downloaded and applied to the FITS images. <br><br />
<br>
<b>This notebook shows how to examine different WCS solutions contained in the FITS images and how to improve the relative alignment of exposures in the F225W and F336W filters which were taken in the same visit but which have different active WCS solutions.</b></p>
<p>During the calibration portion of the pipeline processing, the drizzlepac software calls the <a class="reference external" href="https://stwcs.readthedocs.io/en/latest/astrometry_utils.html#usage">updatewcs</a> module to populate the WCS headerlet extensions in the FITS images and then sets the ‘bestSolutionID’ as the active WCS.  The astrometry database captures every unique WCS solution for a given dataset cataloged by ‘ipppssoot’ and includes WCS’s derived from standard (HST) and Hubble Advanced Products (HAP). This gives us a complete  history of the active WCS over time and these solutions can change as the alignment software is improved, as new  distortion reference files are delivered, and/or as new reference catalogs become available.  (A re-alignment is performed ONLY when there is a new distortion solution or absolute reference catalog.)</p>
<div class="alert alert-block alert-warning">
<b>NOTE:</b> While some datasets may have WCS solutions which are aligned to an external reference catalog, such as Gaia eDR3, GSC v2.4.2 or 2MASS, other datasets (even in the same visit) may not! Thus, it is crucial to check which WCS solution is active for all of the exposures. The easiest way to do this is to examine the WCSNAME keyword in the header of the SCI extensions. <br>  
<br>    
<b>Alternatively, a more accurate WCS solution may be available in the HAP Single Visit Mosaic (SVM) products created by MAST. In this workflow, the pipeline first aligns all of the images in a given visit and second aligns the entire group to an external reference catalog.<b>  Here, we show how to download the SVM headerlets and apply them to the FITS data to improve the relative aligment prior to running AstroDrizzle.
</div>
<p>For more information alternate WCS solutions, see <a class="reference external" href="https://hst-docs.stsci.edu/drizzpac/chapter-4-astrometric-information-in-the-header/4-5-absolute-astrometry">Section 4.5</a> of the Drizzlepac Handbook. For more details on the Hubble Advanced Products and Single Visit Mosaics (SVMs), see the following <a class="reference external" href="https://archive.stsci.edu/contents/newsletters/december-2020/hap-single-visit-mosaics-now-available">MAST Newsletter Article</a>.</p>
<p><a id="import"></a></p>
</section>
<section id="import-packages">
<h2>Import Packages<a class="headerlink" href="#import-packages" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Table of Contents</span></p>
<hr>
<p>The following Python packages are required to run the Jupyter Notebook:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.python.org/3/library/os.html"><strong>os</strong></a> - change and make directories</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/glob.html"><strong>glob</strong></a> - gather lists of filenames</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/shutil.html#module-shutil"><strong>shutil</strong></a> - remove directories and files</p></li>
<li><p><a class="reference external" href="https://numpy.org"><strong>numpy</strong></a> - math and array functions</p></li>
<li><p><a class="reference external" href="https://matplotlib.org/stable/tutorials/pyplot.html"><strong>matplotlib</strong></a> - make figures and graphics</p></li>
<li><p><a class="reference external" href="https://www.astropy.org"><strong>astropy</strong></a> - file handling, tables, units, WCS, statistics</p></li>
<li><p><a class="reference external" href="https://astroquery.readthedocs.io/en/latest/"><strong>astroquery</strong></a> - download data and query databases</p></li>
<li><p><a class="reference external" href="https://www.stsci.edu/scientific-community/software/drizzlepac"><strong>drizzlepac</strong></a> - align and combine HST images</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">clear_output</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.wcs</span><span class="w"> </span><span class="kn">import</span> <span class="n">WCS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">ZScaleInterval</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.mast</span><span class="w"> </span><span class="kn">import</span> <span class="n">Observations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">stwcs.wcsutil</span><span class="w"> </span><span class="kn">import</span> <span class="n">headerlet</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">drizzlepac</span><span class="w"> </span><span class="kn">import</span> <span class="n">astrodrizzle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">drizzlepac.processInput</span><span class="w"> </span><span class="kn">import</span> <span class="n">getMdriztabPars</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="o">%</span><span class="k">matplotlib</span> notebook
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39; # Improves the resolution of figures rendered in notebooks.
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<p>Some steps in this notebook require access to HST reference files, so we will create a temporary ‘iref’ directory for these reference files after download. This step is typically done by defining the ‘iref’ path in your bash profile so that all reference files for all datasets can be in one static location, but for the portability of this notebook we will create a directory.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_SERVER_URL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;https://hst-crds.stsci.edu&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_SERVER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;https://hst-crds.stsci.edu&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;./crds_cache&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;iref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;./crds_cache/references/hst/wfc3/&#39;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="example-data-download">
<h2>0. Example Data Download<a class="headerlink" href="#example-data-download" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Table of Contents</span></p>
<hr>
MAST queries may be done using <a href="https://astroquery.readthedocs.io/en/latest/mast/mast_obsquery.html#observation-criteria-queries"> `query_criteria`</a>, where we specify: <br>
<p>    <span class="math notranslate nohighlight">\(\rightarrow\)</span> obs_id, proposal_id, and filters</p>
<p>MAST data products may be downloaded by using <a href="https://astroquery.readthedocs.io/en/latest/mast/mast_obsquery.html#downloading-data"> <code class="docutils literal notranslate"><span class="pre">download_products</span></code></a>, where we specify:<br></p>
<p>    <span class="math notranslate nohighlight">\(\rightarrow\)</span> products = calibrated (FLT, FLC) or drizzled (DRZ, DRC) files</p>
<p>    <span class="math notranslate nohighlight">\(\rightarrow\)</span> type = standard products (CALxxx) or advanced products (HAP-SVM)</p>
<hr>
<p>Let’s find some example HST data from MAST and download it. The example used here is from visit 14 of program <a class="reference external" href="https://www.stsci.edu/hst-program-info/program/?program=16801">16801</a>. The associations IEPW14030 and IEPW14040 each contain two FLC images in the F336W and F225W filters and a single DRC combined image for each filter.  Here we download the FLC, DRC, and ASN files using <code class="docutils literal notranslate"><span class="pre">astroquery</span></code>.</p>
<div class="alert alert-block alert-info" style="color:black" >  Depending on your connection speed this cell may take a few minutes to execute. </div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obs_ids</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;IEPW14030&#39;</span><span class="p">,</span> <span class="s1">&#39;IEPW14040&#39;</span><span class="p">]</span>

<span class="n">obsTable</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span><span class="n">obs_id</span><span class="o">=</span><span class="n">obs_ids</span><span class="p">)</span>
<span class="n">products</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span><span class="n">obsTable</span><span class="p">)</span>

<span class="n">data_prod</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;FLC&#39;</span><span class="p">,</span> <span class="s1">&#39;ASN&#39;</span><span class="p">,</span> <span class="s1">&#39;DRC&#39;</span><span class="p">]</span> <span class="c1"># [&#39;FLC&#39;, &#39;FLT&#39;, &#39;DRC&#39;, &#39;DRZ&#39;]</span>
<span class="n">data_type</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CALWF3&#39;</span><span class="p">]</span> <span class="c1"># [&#39;CALACS&#39;, &#39;CALWF3&#39;, &#39;CALWP2&#39;, &#39;HAP-SVM&#39;]</span>

<span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span><span class="n">products</span><span class="p">,</span> <span class="n">productSubGroupDescription</span><span class="o">=</span><span class="n">data_prod</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/iepw14g4q_flc.fits to ./mastDownload/HST/iepw14g4q/iepw14g4q_flc.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/iepw14g6q_flc.fits to ./mastDownload/HST/iepw14g6q/iepw14g6q_flc.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/iepw14gaq_flc.fits to ./mastDownload/HST/iepw14gaq/iepw14gaq_flc.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/iepw14geq_flc.fits to ./mastDownload/HST/iepw14geq/iepw14geq_flc.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/iepw14030_asn.fits to ./mastDownload/HST/iepw14030/iepw14030_asn.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/iepw14030_drc.fits to ./mastDownload/HST/iepw14030/iepw14030_drc.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/iepw14040_asn.fits to ./mastDownload/HST/iepw14040/iepw14040_asn.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/iepw14040_drc.fits to ./mastDownload/HST/iepw14040/iepw14040_drc.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output text_html"><div><i>Table length=8</i>
<table id="table140235668390096" class="table-striped table-bordered table-condensed">
<thead><tr><th>Local Path</th><th>Status</th><th>Message</th><th>URL</th></tr></thead>
<thead><tr><th>str47</th><th>str8</th><th>object</th><th>object</th></tr></thead>
<tr><td>./mastDownload/HST/iepw14g4q/iepw14g4q_flc.fits</td><td>COMPLETE</td><td>None</td><td>None</td></tr>
<tr><td>./mastDownload/HST/iepw14g6q/iepw14g6q_flc.fits</td><td>COMPLETE</td><td>None</td><td>None</td></tr>
<tr><td>./mastDownload/HST/iepw14gaq/iepw14gaq_flc.fits</td><td>COMPLETE</td><td>None</td><td>None</td></tr>
<tr><td>./mastDownload/HST/iepw14geq/iepw14geq_flc.fits</td><td>COMPLETE</td><td>None</td><td>None</td></tr>
<tr><td>./mastDownload/HST/iepw14030/iepw14030_asn.fits</td><td>COMPLETE</td><td>None</td><td>None</td></tr>
<tr><td>./mastDownload/HST/iepw14030/iepw14030_drc.fits</td><td>COMPLETE</td><td>None</td><td>None</td></tr>
<tr><td>./mastDownload/HST/iepw14040/iepw14040_asn.fits</td><td>COMPLETE</td><td>None</td><td>None</td></tr>
<tr><td>./mastDownload/HST/iepw14040/iepw14040_drc.fits</td><td>COMPLETE</td><td>None</td><td>None</td></tr>
</table></div></div></div>
</div>
<p>Next, we retrieve the Hubble Advanced Product (HAP) headerlets, which we will use to change between different WCS solutions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span><span class="n">products</span><span class="p">,</span> <span class="n">productSubGroupDescription</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HLET&#39;</span><span class="p">],</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HAP-SVM&#39;</span><span class="p">],</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/hst_16801_14_wfc3_uvis_f275w_iepw14ga_hlet.fits to ./mastDownload/HST/hst_16801_14_wfc3_uvis_f275w_iepw14ga/hst_16801_14_wfc3_uvis_f275w_iepw14ga_hlet.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/hst_16801_14_wfc3_uvis_f336w_iepw14g4_hlet.fits to ./mastDownload/HST/hst_16801_14_wfc3_uvis_f336w_iepw14g4/hst_16801_14_wfc3_uvis_f336w_iepw14g4_hlet.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/hst_16801_14_wfc3_uvis_f336w_iepw14g6_hlet.fits to ./mastDownload/HST/hst_16801_14_wfc3_uvis_f336w_iepw14g6/hst_16801_14_wfc3_uvis_f336w_iepw14g6_hlet.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/hst_16801_14_wfc3_uvis_f275w_iepw14ge_hlet.fits to ./mastDownload/HST/hst_16801_14_wfc3_uvis_f275w_iepw14ge/hst_16801_14_wfc3_uvis_f275w_iepw14ge_hlet.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output text_html"><div><i>Table length=4</i>
<table id="table140237066158032" class="table-striped table-bordered table-condensed">
<thead><tr><th>Local Path</th><th>Status</th><th>Message</th><th>URL</th></tr></thead>
<thead><tr><th>str104</th><th>str8</th><th>object</th><th>object</th></tr></thead>
<tr><td>./mastDownload/HST/hst_16801_14_wfc3_uvis_f275w_iepw14ga/hst_16801_14_wfc3_uvis_f275w_iepw14ga_hlet.fits</td><td>COMPLETE</td><td>None</td><td>None</td></tr>
<tr><td>./mastDownload/HST/hst_16801_14_wfc3_uvis_f336w_iepw14g4/hst_16801_14_wfc3_uvis_f336w_iepw14g4_hlet.fits</td><td>COMPLETE</td><td>None</td><td>None</td></tr>
<tr><td>./mastDownload/HST/hst_16801_14_wfc3_uvis_f336w_iepw14g6/hst_16801_14_wfc3_uvis_f336w_iepw14g6_hlet.fits</td><td>COMPLETE</td><td>None</td><td>None</td></tr>
<tr><td>./mastDownload/HST/hst_16801_14_wfc3_uvis_f275w_iepw14ge/hst_16801_14_wfc3_uvis_f275w_iepw14ge_hlet.fits</td><td>COMPLETE</td><td>None</td><td>None</td></tr>
</table></div></div></div>
</div>
<p>Now to make the paths easier to work with, we move those files from their default download location into the notebook directory. In addition, we add one to the headerlet extension numbers because lists are zero indexed while the EXTVER’s extensions are unity based. We do this by defining a small <code class="docutils literal notranslate"><span class="pre">correct_hdrlet_extvers()</span></code> function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">fits_file</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;./mastDownload/HST/*/*.fits&#39;</span><span class="p">):</span>
    <span class="n">fits_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fits_file</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">fits_file</span><span class="p">,</span> <span class="n">fits_name</span><span class="p">)</span>
    
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;mastDownload&#39;</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s1">&#39;mastDownload&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">correct_hdrlet_extvers</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Correctly renumbers hdrlet EXTVER values&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;update&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdulist</span><span class="p">:</span>
        <span class="n">hdrlet_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ext</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hdulist</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;HDRLET&#39;</span><span class="p">:</span>
                <span class="n">hdrlet_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">hdulist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;EXTVER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdrlet_count</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">flc_file</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*flc.fits&#39;</span><span class="p">)):</span>
    <span class="n">correct_hdrlet_extvers</span><span class="p">(</span><span class="n">flc_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can check the active WCS solution in the image header. If the image is aligned to a catalog, we list the number of matches and the fit RMS converted from milliarcseconds to pixels.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ext_0_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DETECTOR&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPTIME&#39;</span><span class="p">,</span> <span class="s1">&#39;FILTER&#39;</span><span class="p">]</span> <span class="c1"># extension 0 keywords.</span>
<span class="n">ext_1_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;WCSNAME&#39;</span><span class="p">,</span> <span class="s1">&#39;NMATCHES&#39;</span><span class="p">,</span> <span class="s1">&#39;RMS_RA&#39;</span><span class="p">,</span> <span class="s1">&#39;RMS_DEC&#39;</span><span class="p">]</span> <span class="c1"># extension 1 keywords.</span>

<span class="c1"># Define the detector plate scales in arcsec per pixel.</span>
<span class="n">DETECTOR_SCALES</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;IR&#39;</span><span class="p">:</span> <span class="mf">0.1283</span><span class="p">,</span> 
  <span class="s1">&#39;UVIS&#39;</span><span class="p">:</span> <span class="mf">0.0396</span><span class="p">,</span> 
  <span class="s1">&#39;WFC&#39;</span><span class="p">:</span> <span class="mf">0.05</span>
<span class="p">}</span>

<span class="n">formatted_data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">column_data</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

<span class="k">for</span> <span class="n">fits_file</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*fl?.fits&#39;</span><span class="p">)):</span>
    <span class="n">column_data</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits_file</span><span class="p">)</span>
    <span class="n">header0</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">fits_file</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">header1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">fits_file</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">ext_0_keywords</span><span class="p">:</span>
        <span class="n">column_data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header0</span><span class="p">[</span><span class="n">keyword</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">ext_1_keywords</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">header1</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;RMS&#39;</span> <span class="ow">in</span> <span class="n">keyword</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">header1</span><span class="p">[</span><span class="n">keyword</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">header1</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>
            <span class="n">column_data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">column_data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            
    <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;RMS_RA&#39;</span><span class="p">,</span> <span class="s1">&#39;RMS_DEC&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">header1</span><span class="p">:</span>
            <span class="n">rms_value</span> <span class="o">=</span> <span class="n">header1</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">DETECTOR_SCALES</span><span class="p">[</span><span class="n">header0</span><span class="p">[</span><span class="s1">&#39;DETECTOR&#39;</span><span class="p">]]</span>
            <span class="n">column_data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s1">_pix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rms_value</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">column_data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s1">_pix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

<span class="n">wcstable</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">column_data</span><span class="p">)</span>
<span class="n">wcstable</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><i>Table length=4</i>
<table id="table140235673417744" class="table-striped table-bordered table-condensed">
<thead><tr><th>filename</th><th>DETECTOR</th><th>EXPTIME</th><th>FILTER</th><th>WCSNAME</th><th>NMATCHES</th><th>RMS_RA</th><th>RMS_DEC</th><th>RMS_RA_pix</th><th>RMS_DEC_pix</th></tr></thead>
<thead><tr><th>str18</th><th>str4</th><th>float64</th><th>str5</th><th>str30</th><th>int64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>iepw14g4q_flc.fits</td><td>UVIS</td><td>178.0</td><td>F336W</td><td>IDC_2731450pi-FIT_REL_GAIAeDR3</td><td>48</td><td>20.5</td><td>17.9</td><td>0.52</td><td>0.45</td></tr>
<tr><td>iepw14g6q_flc.fits</td><td>UVIS</td><td>700.0</td><td>F336W</td><td>IDC_2731450pi-FIT_REL_GAIAeDR3</td><td>48</td><td>20.5</td><td>17.9</td><td>0.52</td><td>0.45</td></tr>
<tr><td>iepw14gaq_flc.fits</td><td>UVIS</td><td>720.0</td><td>F275W</td><td>IDC_2731450pi-FIT_REL_GAIAeDR3</td><td>28</td><td>7.9</td><td>10.8</td><td>0.2</td><td>0.27</td></tr>
<tr><td>iepw14geq_flc.fits</td><td>UVIS</td><td>462.0</td><td>F275W</td><td>IDC_2731450pi-FIT_REL_GAIAeDR3</td><td>28</td><td>7.9</td><td>10.8</td><td>0.2</td><td>0.27</td></tr>
</table></div></div></div>
</div>
<p>Here we see that the first two exposures (F336W) have a fit to ‘Gaia eDR3’ with 46 matches and a fit RMS of ~0.3 pixels.  The next two exposures (F225W) do not have a catalog fit and use the ‘a priori’ correction to the Guide Star Catalog v2.4.  In section 5, we show how to apply the SVM headerlet to align the F225W filter to Gaia eDR3.</p>
</section>
<section id="new-extensions-on-fits-files">
<h2>1. New extensions on FITS files<a class="headerlink" href="#new-extensions-on-fits-files" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Table of Contents</span></p>
<p>Using <code class="docutils literal notranslate"><span class="pre">fits.info</span></code> prints basic information about the extensions in a FITS file.  In the following examples, we show operations for one F336W <code class="docutils literal notranslate"><span class="pre">flc.fits</span></code> file, though the same operations can be repeated in a loop for multiple files. The updated solutions should then show up as extra <code class="docutils literal notranslate"><span class="pre">HDRLET</span></code> extensions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;iepw14g4q_flc.fits&#39;</span>

<span class="n">fits</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Filename: iepw14g4q_flc.fits
No.    Name      Ver    Type      Cards   Dimensions   Format
  0  PRIMARY       1 PrimaryHDU     309   ()      
  1  SCI           1 ImageHDU       223   (4096, 2051)   float32   
  2  ERR           1 ImageHDU        48   (4096, 2051)   float32   
  3  DQ            1 ImageHDU        40   (4096, 2051)   int16   
  4  SCI           2 ImageHDU       221   (4096, 2051)   float32   
  5  ERR           2 ImageHDU        48   (4096, 2051)   float32   
  6  DQ            2 ImageHDU        40   (4096, 2051)   int16   
  7  D2IMARR       1 ImageHDU        16   (64, 32)   float32   
  8  D2IMARR       2 ImageHDU        16   (64, 32)   float32   
  9  D2IMARR       3 ImageHDU        16   (64, 32)   float32   
 10  D2IMARR       4 ImageHDU        16   (64, 32)   float32   
 11  WCSDVARR      1 ImageHDU        16   (64, 32)   float32   
 12  WCSDVARR      2 ImageHDU        16   (64, 32)   float32   
 13  WCSDVARR      3 ImageHDU        16   (64, 32)   float32   
 14  WCSDVARR      4 ImageHDU        16   (64, 32)   float32   
 15  HDRLET        1 HeaderletHDU     26   ()      
 16  WCSCORR       1 BinTableHDU     59   14R x 24C   [40A, I, A, 24A, 24A, 24A, 24A, D, D, D, D, D, D, D, D, 24A, 24A, D, D, D, D, J, 40A, 128A]   
 17  HDRLET        2 HeaderletHDU     26   ()      
 18  HDRLET        3 HeaderletHDU     26   ()      
</pre></div>
</div>
</div>
</div>
<p>As seen above, there are new <code class="docutils literal notranslate"><span class="pre">HDRLET</span></code> extensions in the FITS files (as compared to the pre-2019.3 products. These extensions each contain information used to construct a World Coordinate System (WCS), which is used to transform image coordinates into physical (sky) coordinates.  Each WCS represents a uniquely derived astrometric solution.</p>
</section>
<section id="exploring-different-solutions">
<h2>2. Exploring different solutions<a class="headerlink" href="#exploring-different-solutions" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Table of Contents</span></p>
<p>Each HDRLET extension contains information describing the solution used in its creation. To investigate this we first obtain the extension numbers of the HDRLETs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ext_indices</span> <span class="o">=</span> <span class="n">headerlet</span><span class="o">.</span><span class="n">find_headerlet_HDUs</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">ext_indices</span><span class="p">)</span> <span class="c1"># To show it&#39;s consistent with the fits.info from above.</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[15, 17, 18]
</pre></div>
</div>
</div>
</div>
<p>We can then loop through these extensions to see what WCS solutions are available.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdu</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ext</span><span class="se">\t</span><span class="s1">WCSNAME&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ext_ind</span> <span class="ow">in</span> <span class="n">ext_indices</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ext_ind</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">hdu</span><span class="p">[</span><span class="n">ext_ind</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;WCSNAME&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ext	WCSNAME
15 	 IDC_2731450pi
17 	 IDC_2731450pi-GSC240
18 	 IDC_2731450pi-FIT_REL_GAIAeDR3
</pre></div>
</div>
</div>
</div>
<p>Alternatively, we can use the <code class="docutils literal notranslate"><span class="pre">get_headerlet_kw_names()</span></code> function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_wcsnames</span> <span class="o">=</span> <span class="n">headerlet</span><span class="o">.</span><span class="n">get_headerlet_kw_names</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="s1">&#39;WCSNAME&#39;</span><span class="p">)</span>
<span class="n">new_wcsnames</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;IDC_2731450pi&#39;, &#39;IDC_2731450pi-GSC240&#39;, &#39;IDC_2731450pi-FIT_REL_GAIAeDR3&#39;]
</pre></div>
</div>
</div>
</div>
<p>We can write this into a convenience function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_hdrlet_wcsnames</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print and return list of WCS names in HDRLET extensions of fits file&quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdu</span><span class="p">:</span>
        <span class="n">ext_indices</span> <span class="o">=</span> <span class="n">headerlet</span><span class="o">.</span><span class="n">find_headerlet_HDUs</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ext</span><span class="se">\t</span><span class="s1">WCSNAME&#39;</span><span class="p">)</span>
        <span class="n">new_wcsnames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ext_ind</span> <span class="ow">in</span> <span class="n">ext_indices</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">ext_ind</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;WCSNAME&#39;</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ext_ind</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">new_wcsnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_wcsnames</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_wcsnames</span> <span class="o">=</span> <span class="n">get_hdrlet_wcsnames</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ext	WCSNAME
15 	 IDC_2731450pi
17 	 IDC_2731450pi-GSC240
18 	 IDC_2731450pi-FIT_REL_GAIAeDR3
</pre></div>
</div>
</div>
</div>
<p>We can also see which solution is the “active” solution (the one currently applied to the SCI extensions):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">current_wcs</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;WCSNAME&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">current_wcs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>IDC_2731450pi-FIT_REL_GAIAeDR3
</pre></div>
</div>
</div>
</div>
<p>The nature of each solution is described here: https://drizzlepac.readthedocs.io/en/latest/mast_data_products/astrometry.html#interpreting-wcs-names. In some cases, single-visit mosaic (SVM) solution named FIT-SVM-GAIADR2 might be better than the default active solution of FIT-REL-GAIAeDR3.</p>
</section>
<section id="applying-a-headerlet-to-the-science-extensions">
<h2>3. Applying a headerlet to the science extensions<a class="headerlink" href="#applying-a-headerlet-to-the-science-extensions" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Table of Contents</span></p>
<p>To apply/activate one of the other solutions, we use the <code class="docutils literal notranslate"><span class="pre">restore_from_headerlet()</span></code> function.  This applies the WCS contained in a HDRLET extension to all SCI extensions of the image.  Doing this requires knowing which solution should be applied, which can be obtained in multiple ways. For instance, if the desired solution is <code class="docutils literal notranslate"><span class="pre">IDC_2731450pi-FIT_REL_GAIAeDR3</span></code>, we can find the <code class="docutils literal notranslate"><span class="pre">EXTVER</span></code> of the corresponding HDRLET from the list of wcs names we generated earlier.</p>
<div class="alert alert-block alert-info">
NOTE: This is especially useful in cases where some of the exposures in a visit will have solutions that are aligned to Gaia, but others won't.  This is true for grism images in the same visit as direct images, or shallow/deep exposure combinations.
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Gets the index of list element with value &#39;IDC_2731450pi-GSC240&#39;.</span>
<span class="c1"># The index in this list + 1 is the same as the EXTVER of the corresponding HDRLET.</span>
<span class="c1"># We need to add 1 because lists are 0-indexed, while EXTVER&#39;s are 1 indexed.</span>

<span class="n">chosen_ext</span> <span class="o">=</span> <span class="n">new_wcsnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;IDC_2731450pi-FIT_REL_GAIAeDR3&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">headerlet</span><span class="o">.</span><span class="n">restore_from_headerlet</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">hdrext</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;HDRLET&#39;</span><span class="p">,</span> <span class="n">chosen_ext</span><span class="p">),</span> <span class="n">archive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>In this case we set <code class="docutils literal notranslate"><span class="pre">archive</span></code> keyword argument to <code class="docutils literal notranslate"><span class="pre">False</span></code>.  Setting <code class="docutils literal notranslate"><span class="pre">archive</span></code> to True will preserve the currently active WCS as a new HDRLET extension on the file.  Since in our case the current solution already has a HDRLET, we do not need to archive it.  This may be useful in some cases, such as when the image has been manually aligned/transformed, and keeping a record of that solution is desired.</p>
<p>We can check that the solution was applied:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">current_wcs</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;WCSNAME&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">current_wcs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>IDC_2731450pi-FIT_REL_GAIAeDR3
</pre></div>
</div>
</div>
</div>
<p>We can also apply the solution via the HDRNAME:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hdrlet_hdrnames</span> <span class="o">=</span> <span class="n">headerlet</span><span class="o">.</span><span class="n">get_headerlet_kw_names</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;HDRNAME&#39;</span><span class="p">)</span>
<span class="n">desired_hdrname</span> <span class="o">=</span> <span class="n">hdrlet_hdrnames</span><span class="p">[</span><span class="n">new_wcsnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;IDC_2731450pi-GSC240&#39;</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">desired_hdrname</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>iepw14g4q_flc_d4477c_hlet.fits
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">headerlet</span><span class="o">.</span><span class="n">restore_from_headerlet</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">hdrname</span><span class="o">=</span><span class="n">desired_hdrname</span><span class="p">,</span> <span class="n">archive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can also apply some logic to get the <code class="docutils literal notranslate"><span class="pre">hdrext</span></code> programatically.  For instance, if we only wanted the <code class="docutils literal notranslate"><span class="pre">IDC</span></code> (distortion calibrated) solution with the <code class="docutils literal notranslate"><span class="pre">GSC240</span></code> tag (indicating that this is a ‘a priori’ WCS where the guide star positions had been updated), we can do the following:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">wcsname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_wcsnames</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;IDC&#39;</span> <span class="ow">in</span> <span class="n">wcsname</span> <span class="ow">and</span> <span class="s1">&#39;GSC240&#39;</span> <span class="ow">in</span> <span class="n">wcsname</span><span class="p">:</span>
        <span class="n">chosen_ext</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># Add one due to 0 indexing of enumerate vs 1 indexing of EXTVER</span>
        <span class="k">break</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The desired extension is:&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;HDRLET&#39;</span><span class="p">,</span> <span class="n">chosen_ext</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The desired extension is: (&#39;HDRLET&#39;, 2)
</pre></div>
</div>
</div>
</div>
<p>Finding the solution this way can be easier, as it doesn’t require a full typing out of the IDCTAB name.  However, in the future, if new IDCTABs are created, there may be multiple solutions matching the criteria above, and more sophisticated logic will need to be applied.</p>
</section>
<section id="changing-to-alternate-wcs-solutions">
<h2>4. Changing to alternate WCS solutions<a class="headerlink" href="#changing-to-alternate-wcs-solutions" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Table of Contents</span></p>
<p>Here we look at three WCS solutions and inspect which has the best alignment with respect to stars in the HST image.</p>
<section id="fit-rel-gaia-edr3-solution">
<h3>4.1 FIT-REL Gaia eDR3 solution<a class="headerlink" href="#fit-rel-gaia-edr3-solution" title="Permalink to this heading">#</a></h3>
<p>When the WCS is <code class="docutils literal notranslate"><span class="pre">FIT_REL_eDR3</span></code>, the individual exposures are aligned to one another and then the entire association is aligned to Gaia eDR3.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">chosen_ext</span> <span class="o">=</span> <span class="n">new_wcsnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;IDC_2731450pi-FIT_REL_GAIAeDR3&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">headerlet</span><span class="o">.</span><span class="n">restore_from_headerlet</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">hdrext</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;HDRLET&#39;</span><span class="p">,</span> <span class="n">chosen_ext</span><span class="p">),</span> <span class="n">archive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">current_wcs</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;WCSNAME&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">current_wcs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>IDC_2731450pi-FIT_REL_GAIAeDR3
</pre></div>
</div>
</div>
</div>
</section>
<section id="a-priori-solution">
<h3>4.2 “a priori” solution<a class="headerlink" href="#a-priori-solution" title="Permalink to this heading">#</a></h3>
<p>When the WCS does not have the string <code class="docutils literal notranslate"><span class="pre">FIT</span></code>, but is appended with either <code class="docutils literal notranslate"><span class="pre">GSC240</span> <span class="pre">or</span> <span class="pre">HSC30</span></code>, this is known as an a priori solution which simply corrects the coordinates of the guide stars in use at the time of observation to the coordinates of those stars as determined by Gaia, applying a global offset to the WCS.</p>
<div class="alert alert-block alert-warning">
<b>NOTE:</b> Data taken after October 2017 may not have an a priori solution, as the pointing information of the telescope was already calculated using GSC 2.4.0.  As such, the "old" solution may be of the same form as the a priori solution, i.e.: IDC_xxxxxxxxx-GSC240.
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">chosen_ext</span> <span class="o">=</span> <span class="n">new_wcsnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;IDC_2731450pi-GSC240&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">headerlet</span><span class="o">.</span><span class="n">restore_from_headerlet</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">hdrext</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;HDRLET&#39;</span><span class="p">,</span> <span class="n">chosen_ext</span><span class="p">),</span> <span class="n">archive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">current_wcs</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;WCSNAME&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">current_wcs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>IDC_2731450pi-GSC240
</pre></div>
</div>
</div>
</div>
</section>
<section id="distortion-only-solution">
<h3>4.3 “distortion only” solution<a class="headerlink" href="#distortion-only-solution" title="Permalink to this heading">#</a></h3>
<p>If the original solution is desired, with no updates to the WCS and the original HST pointing information, it can be restored using the methods shown below, by replacing the WCSNAME simply with <code class="docutils literal notranslate"><span class="pre">IDC_2731450pi</span></code>, or whatever is the name of the IDCTAB reference file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">chosen_ext</span> <span class="o">=</span> <span class="n">new_wcsnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;IDC_2731450pi&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">headerlet</span><span class="o">.</span><span class="n">restore_from_headerlet</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">hdrext</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;HDRLET&#39;</span><span class="p">,</span> <span class="n">chosen_ext</span><span class="p">),</span> <span class="n">archive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">current_wcs</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;WCSNAME&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">current_wcs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>IDC_2731450pi
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="using-downloaded-svm-headerlets">
<h2>5. Using downloaded SVM headerlets<a class="headerlink" href="#using-downloaded-svm-headerlets" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Table of Contents</span></p>
<p>In cases like the example provided here, images from the same visit may have different WCS solution types (i.e. F336W is <code class="docutils literal notranslate"><span class="pre">FIT-REL-GAIAeDR3</span></code> while the F225W is <code class="docutils literal notranslate"><span class="pre">GSC240</span></code>).  <br>
<br>However, we can apply the SVM headerlet solutions, which are derived from first relatively aligning the HST images to each other, and then aligning the group to an absolute reference catalog.  Thus, they are often a better solution for datasets with a variety of filters/depths.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hlet_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*hlet.fits&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s look at WCS solutions in the headerlet for each image</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">root_to_hlet_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">hlet</span> <span class="ow">in</span> <span class="n">hlet_files</span><span class="p">:</span>
    <span class="n">dest_image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">hlet</span><span class="p">,</span> <span class="s1">&#39;DESTIM&#39;</span><span class="p">)</span>
    <span class="n">root_to_hlet_dict</span><span class="p">[</span><span class="n">dest_image</span><span class="p">]</span> <span class="o">=</span> <span class="n">hlet</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">hlet</span><span class="p">,</span> <span class="n">dest_image</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">hlet</span><span class="p">,</span> <span class="s1">&#39;WCSNAME&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>hst_16801_14_wfc3_uvis_f275w_iepw14ga_hlet.fits iepw14gaq IDC_2731450pi-FIT_SVM_GAIAeDR3
hst_16801_14_wfc3_uvis_f275w_iepw14ge_hlet.fits iepw14geq IDC_2731450pi-FIT_SVM_GAIAeDR3
hst_16801_14_wfc3_uvis_f336w_iepw14g4_hlet.fits iepw14g4q IDC_2731450pi-FIT_SVM_GAIAeDR3
hst_16801_14_wfc3_uvis_f336w_iepw14g6_hlet.fits iepw14g6q IDC_2731450pi-FIT_SVM_GAIAeDR3
</pre></div>
</div>
</div>
</div>
<p>Now we simply have to match each SVM headerlet to its corresponding flc file, and apply it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">flc</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*flc.fits&#39;</span><span class="p">)):</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">flc</span><span class="p">,</span> <span class="s1">&#39;rootname&#39;</span><span class="p">)</span>
    <span class="n">headerlet</span><span class="o">.</span><span class="n">apply_headerlet_as_primary</span><span class="p">(</span><span class="n">flc</span><span class="p">,</span> <span class="n">hdrlet</span><span class="o">=</span><span class="n">root_to_hlet_dict</span><span class="p">[</span><span class="n">root</span><span class="p">],</span> <span class="n">attach</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Applying hst_16801_14_wfc3_uvis_f336w_iepw14g4_hlet.fits as Primary WCS to iepw14g4q_flc.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Applying hst_16801_14_wfc3_uvis_f336w_iepw14g6_hlet.fits as Primary WCS to iepw14g6q_flc.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Applying hst_16801_14_wfc3_uvis_f275w_iepw14ga_hlet.fits as Primary WCS to iepw14gaq_flc.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Applying hst_16801_14_wfc3_uvis_f275w_iepw14ge_hlet.fits as Primary WCS to iepw14geq_flc.fits
</pre></div>
</div>
</div>
</div>
</section>
<section id="running-astrodrizzle">
<h2>6. Running <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code><a class="headerlink" href="#running-astrodrizzle" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Table of Contents</span></p>
<p>Because the drizzling process is directly affected by the WCS’s of the input FITS images, the WCS of the drizzled image cannot be changed as simply as shown above for FLC images.  <b>To use an astrometric solution (other than the one  applied to the FLT/FLC at the time of drizzling), the images will have to be re-drizzled after activating the desired WCS</b>.</p>
<p>Here we query the association ID of each of the input files and add it to a dictionary.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">asn_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

<span class="k">for</span> <span class="n">flc</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*flc.fits&#39;</span><span class="p">)):</span>
    <span class="n">asn_id</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">flc</span><span class="p">,</span> <span class="s1">&#39;asn_id&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">asn_id</span> <span class="o">==</span> <span class="s1">&#39;NONE&#39;</span><span class="p">:</span>
        <span class="n">asn_id</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">flc</span><span class="p">,</span> <span class="s1">&#39;rootname&#39;</span><span class="p">)</span>
    <span class="n">asn_id</span> <span class="o">=</span> <span class="n">asn_id</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">asn_dict</span><span class="p">[</span><span class="n">asn_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flc</span><span class="p">)</span>
<span class="n">asn_dict</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>defaultdict(list,
            {&#39;iepw14030&#39;: [&#39;iepw14g4q_flc.fits&#39;, &#39;iepw14g6q_flc.fits&#39;],
             &#39;iepw14040&#39;: [&#39;iepw14gaq_flc.fits&#39;, &#39;iepw14geq_flc.fits&#39;]})
</pre></div>
</div>
</div>
</div>
<p>Next, we prepare to drizzle the data, and <b> we get some recommended values for drizzling from the MDRIZTAB reference file.</b>  The parameters in this file are different for each detector and are based on the number of input frames and the filter. These are a good starting point for drizzling and may be adjusted accordingly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_images_f336w</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;iepw14g[46]q_flc.fits&#39;</span><span class="p">))</span>
<span class="n">mdz</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">input_images_f336w</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;MDRIZTAB&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Searching for the MDRIZTAB file:&#39;</span><span class="p">,</span> <span class="n">mdz</span><span class="p">)</span>
<span class="o">!</span>crds<span class="w"> </span>sync<span class="w"> </span>--hst<span class="w"> </span>--files<span class="w"> </span><span class="o">{</span>mdz<span class="o">}</span><span class="w"> </span>--output-dir<span class="w"> </span><span class="o">{</span>os.environ<span class="o">[</span><span class="s1">&#39;iref&#39;</span><span class="o">]}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Searching for the MDRIZTAB file: 2ck18260i_mdz.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CRDS - INFO -  Symbolic context &#39;hst-latest&#39; resolves to &#39;hst_1279.pmap&#39;
CRDS - INFO -  Reorganizing 0 references from &#39;instrument&#39; to &#39;flat&#39;
CRDS - INFO -  Reorganizing from &#39;instrument&#39; to &#39;flat&#39; cache,  removing instrument directories.
CRDS - INFO -  Syncing explicitly listed files.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CRDS - INFO -  Fetching  ./crds_cache/references/hst/wfc3/2ck18260i_mdz.fits      118.1 K bytes  (1 / 1 files) (0 / 118.1 K bytes)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CRDS - INFO -  0 errors
CRDS - INFO -  0 warnings
CRDS - INFO -  5 infos
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_vals_from_mdriztab</span><span class="p">(</span><span class="n">input_images_f336w</span><span class="p">,</span> <span class="n">kw_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;driz_sep_bits&#39;</span><span class="p">,</span> 
                                                        <span class="s1">&#39;combine_type&#39;</span><span class="p">,</span> 
                                                        <span class="s1">&#39;driz_cr_snr&#39;</span><span class="p">,</span> 
                                                        <span class="s1">&#39;driz_cr_scale&#39;</span><span class="p">,</span> 
                                                        <span class="s1">&#39;final_bits&#39;</span><span class="p">]):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Get only selected parameters from the MDRIZTAB.&#39;&#39;&#39;</span>
    <span class="n">mdriz_dict</span> <span class="o">=</span> <span class="n">getMdriztabPars</span><span class="p">(</span><span class="n">input_images_f336w</span><span class="p">)</span>
    
    <span class="n">requested_params</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Outputting the following parameters:&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kw_list</span><span class="p">:</span>
        <span class="n">requested_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdriz_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">mdriz_dict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">requested_params</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">selected_params</span> <span class="o">=</span> <span class="n">get_vals_from_mdriztab</span><span class="p">(</span><span class="n">asn_dict</span><span class="p">[</span><span class="s1">&#39;iepw14030&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>- MDRIZTAB: AstroDrizzle parameters read from row 2.
Outputting the following parameters:
driz_sep_bits 336
combine_type minmed
driz_cr_snr 3.5 3.0
driz_cr_scale 1.5 1.2
final_bits 336
</pre></div>
</div>
</div>
</div>
<p>Here we see the recommended parameters for 2 input FLC frames. These can be modified below by uncommenting the lines below, as needed for optimal cosmic-ray rejection. For details, see the notebook <a class="reference external" href="https://spacetelescope.github.io/hst_notebooks/notebooks/DrizzlePac/align_multiple_visits/align_multiple_visits.html">Aligning Multiple Visits</a> in this notebook repository.</p>
<p>In the cell below, we run <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> once for each filter using the association ID dictionary.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">asn_id</span> <span class="ow">in</span> <span class="n">asn_dict</span><span class="p">:</span>
    
    <span class="n">input_images</span> <span class="o">=</span> <span class="n">asn_dict</span><span class="p">[</span><span class="n">asn_id</span><span class="p">]</span>
    
    <span class="c1"># To override any of the above values:</span>
    <span class="c1"># selected_params[&#39;driz_sep_bits&#39;] = &#39;256, 64, 16&#39;</span>
    <span class="c1"># selected_params[&#39;final_bits&#39;]    = &#39;256, 64, 16&#39;</span>
    <span class="c1"># selected_params[&#39;combine_type&#39;]  = &#39;median&#39;</span>
    <span class="c1"># selected_params[&#39;driz_cr_snr&#39;]   = &#39;4.0 3.5&#39;</span>
    <span class="c1"># selected_params[&#39;driz_cr_scale&#39;] = &#39;1.2 1.0&#39;</span>

    <span class="n">selected_params</span> <span class="o">=</span> <span class="n">get_vals_from_mdriztab</span><span class="p">(</span><span class="n">input_images</span><span class="p">)</span>
    
    <span class="n">astrodrizzle</span><span class="o">.</span><span class="n">AstroDrizzle</span><span class="p">(</span><span class="n">input_images</span><span class="p">,</span> 
                              <span class="n">output</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">asn_id</span><span class="si">}</span><span class="s1">_updated_wcs&#39;</span><span class="p">,</span>
                              <span class="n">preserve</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">clean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                              <span class="n">build</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">context</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">skymethod</span><span class="o">=</span><span class="s1">&#39;match&#39;</span><span class="p">,</span>
                              <span class="n">in_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="o">**</span><span class="n">selected_params</span><span class="p">)</span>
<span class="n">clear_output</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we will display the default pipeline drizzled (DRC) image retrieved from MAST to show the astrometric offset for a zoomed in region of the image. We define the center and scaling to be the same for both sets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">center</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0095776</span><span class="p">,</span> <span class="mf">40.5014080</span><span class="p">]</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">ZScaleInterval</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display the two science images and zoom in on an object to see the astrometric error.</span>
<span class="n">image1</span> <span class="o">=</span> <span class="s1">&#39;iepw14030_drc.fits&#39;</span>
<span class="n">image2</span> <span class="o">=</span> <span class="s1">&#39;iepw14040_drc.fits&#39;</span>

<span class="n">sci_image1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">image1</span><span class="p">)</span>
<span class="n">sci_image2</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">image2</span><span class="p">)</span>
<span class="n">wcs_image1</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">image1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">wcs_image2</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">image2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">wcs_image1</span><span class="o">.</span><span class="n">world_to_pixel_values</span><span class="p">([</span><span class="n">center</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">wcs_image2</span><span class="o">.</span><span class="n">world_to_pixel_values</span><span class="p">([</span><span class="n">center</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">wcs_image1</span><span class="p">)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">wcs_image2</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;WCS: &#39;</span><span class="o">+</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">image1</span><span class="p">,</span> <span class="s1">&#39;WCSNAME&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;WCS: &#39;</span><span class="o">+</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">image2</span><span class="p">,</span> <span class="s1">&#39;WCSNAME&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sci_image1</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">z</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">sci_image1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">z</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">sci_image1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sci_image2</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">z</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">sci_image2</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">z</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">sci_image2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="n">x1</span><span class="o">+</span><span class="mi">50</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y1</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="n">y1</span><span class="o">+</span><span class="mi">50</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="n">x2</span><span class="o">+</span><span class="mi">50</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="n">y2</span><span class="o">+</span><span class="mi">50</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/66e4fa72ea6eb30744e8b2aade065899142a70c2a8d0ce684d3be5f5d34344d0.png" src="../../../_images/66e4fa72ea6eb30744e8b2aade065899142a70c2a8d0ce684d3be5f5d34344d0.png" />
</div>
</div>
<p>Here we see a small misalignment between the two filters in the pipeline drizzled files which have different WCS solutions. <br>
<br>
Finally, we  display the redrizzled image which uses the improved FIT-SVM-GAIAeDR3 WCS, which restores the alignment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display the two science images and zoom in on an object to see the astrometric error.</span>
<span class="n">image1</span> <span class="o">=</span> <span class="s1">&#39;iepw14030_updated_wcs_drc.fits&#39;</span>
<span class="n">image2</span> <span class="o">=</span> <span class="s1">&#39;iepw14040_updated_wcs_drc.fits&#39;</span>

<span class="n">sci_image1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">image1</span><span class="p">)</span>
<span class="n">sci_image2</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">image2</span><span class="p">)</span>
<span class="n">wcs_image1</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">image1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">wcs_image2</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">image2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">wcs_image1</span><span class="o">.</span><span class="n">world_to_pixel_values</span><span class="p">([</span><span class="n">center</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">wcs_image2</span><span class="o">.</span><span class="n">world_to_pixel_values</span><span class="p">([</span><span class="n">center</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">wcs_image1</span><span class="p">)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">wcs_image2</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;WCS: &#39;</span><span class="o">+</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">image1</span><span class="p">,</span> <span class="s1">&#39;WCSNAME&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;WCS: &#39;</span><span class="o">+</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">image2</span><span class="p">,</span> <span class="s1">&#39;WCSNAME&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sci_image1</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">z</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">sci_image1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">z</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">sci_image1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sci_image2</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">z</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">sci_image2</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">z</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">sci_image2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="n">x1</span><span class="o">+</span><span class="mi">50</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y1</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="n">y1</span><span class="o">+</span><span class="mi">50</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="n">x2</span><span class="o">+</span><span class="mi">50</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="n">y2</span><span class="o">+</span><span class="mi">50</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/8a20dd7ab3c45cbd7841f370366adc773b2f1645fd458163362ff59091a5ce9c.png" src="../../../_images/8a20dd7ab3c45cbd7841f370366adc773b2f1645fd458163362ff59091a5ce9c.png" />
</div>
</div>
<p><a id="conclude"></a></p>
</section>
<section id="conclusions">
<h2>Conclusions<a class="headerlink" href="#conclusions" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Table of Contents</span></p>
<p>This notebook demonstrates how to access and apply different WCS solutions from exposure and SVM headerlets. In general, it is always preferred to have consistent WCS solutions across exposures, especially from the same visit. Users can also custom align their exposures to one another, as well as to external catalogs such as SDSS and Gaia. This process is detailed in the <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/blob/main/notebooks/DrizzlePac/align_to_catalogs/align_to_catalogs.ipynb">align_to_catalogs</a> notebook.</p>
<p><a id="about"></a></p>
</section>
<section id="about-this-notebook">
<h2>About this Notebook<a class="headerlink" href="#about-this-notebook" title="Permalink to this heading">#</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Created: 14 Dec 2018;     V. Bajaj
Updated: 31 May 2024;     M. Revalski, V. Bajaj, &amp; J. Mack
</pre></div>
</div>
<p><strong>Source:</strong> GitHub <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks">spacetelescope/hst_notebooks</a></p>
<p><a id="add"></a></p>
</section>
<section id="additional-resources">
<h2>Additional Resources<a class="headerlink" href="#additional-resources" title="Permalink to this heading">#</a></h2>
<p>Below are some additional resources that may be helpful. Please send any questions through the <a class="reference external" href="https://stsci.service-now.com/hst">HST Help Desk</a>, selecting the DrizzlePac category.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.stsci.edu/hst/instrumentation/wfc3">WFC3 Website</a></p></li>
<li><p><a class="reference external" href="https://hst-docs.stsci.edu/wfc3dhb">WFC3 Data Handbook</a></p></li>
<li><p><a class="reference external" href="https://hst-docs.stsci.edu/wfc3ihb">WFC3 Instrument Handbook</a></p></li>
</ul>
<p><a id="cite"></a></p>
</section>
<section id="citations">
<h2>Citations<a class="headerlink" href="#citations" title="Permalink to this heading">#</a></h2>
<p>If you use Python packages such as <code class="docutils literal notranslate"><span class="pre">astropy</span></code>, <code class="docutils literal notranslate"><span class="pre">astroquery</span></code>, <code class="docutils literal notranslate"><span class="pre">drizzlepac</span></code>, <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code>, or <code class="docutils literal notranslate"><span class="pre">numpy</span></code> for published research, please cite the authors.</p>
<p>Follow these links for more information about citing various packages:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.astropy.org/acknowledging.html">Citing <code class="docutils literal notranslate"><span class="pre">astropy</span></code></a></p></li>
<li><p><a class="reference external" href="https://github.com/astropy/astroquery/blob/main/astroquery/CITATION">Citing <code class="docutils literal notranslate"><span class="pre">astroquery</span></code></a></p></li>
<li><p><a class="reference external" href="https://zenodo.org/records/3743274">Citing <code class="docutils literal notranslate"><span class="pre">drizzlepac</span></code></a></p></li>
<li><p><a class="reference external" href="https://matplotlib.org/stable/users/project/citing.html">Citing <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code></a></p></li>
<li><p><a class="reference external" href="https://numpy.org/citing-numpy/">Citing <code class="docutils literal notranslate"><span class="pre">numpy</span></code></a></p></li>
</ul>
<hr>
<p><span class="xref myst">Top of Page</span>
<a class="reference internal" href="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png"><img alt="Space Telescope Logo" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="width: 200px;" /></a></p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/hst_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/DrizzlePac/using_updated_astrometry_solutions"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../README.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">DrizzlePac Notebooks</p>
      </div>
    </a>
    <a class="right-next"
       href="../align_to_catalogs/align_to_catalogs.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Aligning HST images to an Absolute Reference Catalog</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-packages">Import Packages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-data-download">0. Example Data Download</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#new-extensions-on-fits-files">1. New extensions on FITS files</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-different-solutions">2. Exploring different solutions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#applying-a-headerlet-to-the-science-extensions">3. Applying a headerlet to the science extensions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#changing-to-alternate-wcs-solutions">4. Changing to alternate WCS solutions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-rel-gaia-edr3-solution">4.1 FIT-REL Gaia eDR3 solution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-priori-solution">4.2 “a priori” solution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#distortion-only-solution">4.3 “distortion only” solution</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-downloaded-svm-headerlets">5. Using downloaded SVM headerlets</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-astrodrizzle">6. Running <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusions">Conclusions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-resources">Additional Resources</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#citations">Citations</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>