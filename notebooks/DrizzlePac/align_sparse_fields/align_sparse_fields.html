

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Aligning Deep Exposures of Sparse Fields &#8212; HST Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/table.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/DrizzlePac/align_sparse_fields/align_sparse_fields';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Optimizing Image Alignment for Multiple HST Visits" href="../align_multiple_visits/align_multiple_visits.html" />
    <link rel="prev" title="Aligning HST images to an Absolute Reference Catalog" href="../align_to_catalogs/align_to_catalogs.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="HST Notebooks - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="HST Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../index.html">
                    STScI HST Notebook Repository HQ
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">ACS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../ACS/README.html">ACS Notebooks</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_findsat_mrt/acs_findsat_mrt_example.html">Satellite trail detection in ACS/WFC data using acstools.findsat_mrt</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_saturation_trails/acs_saturation_trails.html">ACS Linearity with Saturated Stars</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_cte_forward_model/acs_cte_forward_model_example.html">Pixel-based ACS/WFC CTE Forward Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_subarrays/acs_subarrays.html">ACS Image Reduction for Subarray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_sbc_dark_analysis/acs_sbc_dark_analysis.html">SBC Dark Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_reduction/acs_reduction.html">ACS/WFC Image Reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_pixel_area_maps/acs_pixel_area_maps.html">Obtaining Pixel Area Maps for ACS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_polarization_tools/acs_polarization_tools.html">Using ACS Polarization Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_focus_diverse_epsfs/acs_focus_diverse_epsfs.html">Focus Diverse ePSFs for ACS/WFC</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">COS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../COS/README.html">COS Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../COS/Setup/Setup.html">Setting up your computer environment for working with COS data</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/DataDl/DataDl.html">Downloading COS Data</a></li>




<li class="toctree-l1"><a class="reference internal" href="../../COS/ViewData/ViewData.html">Viewing COS Data</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/AsnFile/AsnFile.html">Modifying or Creating an Association File</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/CalCOS/CalCOS.html">Running the COS Data Pipeline (<code class="docutils literal notranslate"><span class="pre">CalCOS</span></code>)</a></li>






<li class="toctree-l1"><a class="reference internal" href="../../COS/SplitTag/SplitTag.html">Splitting COS Exposures into sub-exposures with <code class="docutils literal notranslate"><span class="pre">splittag</span></code></a></li>







<li class="toctree-l1"><a class="reference internal" href="../../COS/DayNight/DayNight.html">Filtering out COS Data taken during the Day or Night</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../COS/LSF/LSF.html">Working with the COS Line Spread Function (LSF)</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../COS/Extract/Extract.html">Editing the extraction boxes in a spectral extraction file (<code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>)</a></li>







<li class="toctree-l1"><a class="reference internal" href="../../COS/ExceptionReport/ExceptionReport.html">What to do when you get an Exception Report for COS</a></li>







</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">DrizzlePac</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../README.html">DrizzlePac Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_updated_astrometry_solutions/using_updated_astrometry_solutions.html">Improving Astrometry Using Alternate WCS Solutions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../align_to_catalogs/align_to_catalogs.html">Aligning HST images to an Absolute Reference Catalog</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Aligning Deep Exposures of Sparse Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../align_multiple_visits/align_multiple_visits.html">Optimizing Image Alignment for Multiple HST Visits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use_ds9_regions_in_tweakreg/use_ds9_regions_in_tweakreg.html">TWEAKREG Tips - Using DS9 Regions for Source Inclusion/Exclusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimize_image_sampling/optimize_image_sampling.html">Optimizing the Image Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../align_mosaics/align_mosaics.html">Aligning HST Mosaics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sky_matching/sky_matching.html">Sky Matching for HST Mosaics <a id="top"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../mask_satellite/mask_satellite.html">Satellite Trail Masking Techniques</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">HASP</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../HASP/Setup/Setup.html">Installing the Hubble Advanced Spectral Products Script</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../HASP/CoaddTutorial/CoaddTutorial.html">Inputting User Data using the Hubble Advanced Spectral Products Script</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../HASP/FluxScaleTutorial/FluxScaleTutorial.html">Scaling Flux while using the Hubble Advanced Spectral Products Script</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../HASP/DataDiagnostic/DataDiagnostics.html">HASP Data Diagnostic Notebook</a></li>




<li class="toctree-l1"><a class="reference internal" href="../../HASP/WavelengthAdjustment/WavelengthAdjustment.html">Wavelength Adjustments for Running the Hubble Advanced Spectral Products (HASP) Script</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NICMOS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NICMOS/nicmos_unit_conversion/nicmos_unit_conversion.html">Programmatic Replacements for NICMOS Units Conversion Form</a></li>


</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">STIS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../STIS/README.html">STIS-Notebooks</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../STIS/cross-correlation/cross-correlation.html">Correcting for Missing Wavecals with Cross-Correlation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/custom_ccd_darks/custom_ccd_darks.html">Custom CCD Darks <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/drizpac_notebook/STIS_DrizzlePac_Tutorial.html">STIS DrizzlePac Tutorial <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/CoronagraphyViz/STIS_Coronagraphy_Visualization_v2.html">STIS Coronagraphy Visualization Tool (v2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/calstis/calstis_2d_ccd.html">Calstis 2-D CCD Data Reduction <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/target_acquisition/target_acquisition.html">Evaluating STIS Target Acquisitions <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/view_data/view_data.html">Viewing STIS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/extraction/1D_Extraction.html">1D Spectra Extraction <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/low_count_uncertainties/Low_Count_Uncertainties.html">Low Count Uncertainties in STIS <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/contrast_sensitivity/STIS_Coronagraphic_Observation_Feasibility.html">STIS Coronagraphic Observation Feasibility</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">WFC3</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/README.html">WFC3 Notebooks</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../WFC3/general_tools.html">General Tools</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/image_displayer_analyzer/wfc3_image_displayer_analyzer.html">WFC3 Image Displayer &amp; Analyzer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/exception_report/wfc3_exception_report.html">Exception Report Checklist - WFC3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/calwf3_v1.0_cte/calwf3_with_v1.0_PCTE.html">Processing WFC3/UVIS Data with <code class="docutils literal notranslate"><span class="pre">calwf3</span></code> Using the v1.0 CTE-Correction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/persistence/wfc3_ir_persistence.html">Masking Persistence in WFC3/IR Images</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../WFC3/ir_tvb.html">WFC3/IR Time Variable Background (TVB)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/ir_ima_visualization/IR_IMA_Visualization_with_an_Example_of_Time_Variable_Background.html">WFC3/IR IMA Visualization Tools with An Example of Time Variable Background</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/calwf3_recalibration/calwf3_recal_tvb.html">Manual Recalibration with calwf3: Turning off the IR Linear Ramp Fit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/tvb_flattenramp/TVB_flattenramp_notebook.html">Correcting for Helium Line Emission Background in IR Exposures using the “Flatten-Ramp” Technique</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/ir_scattered_light_calwf3_corrections/Correcting_for_Scattered_Light_in_IR_Exposures_Using_calwf3_to_Mask_Bad_Reads.html">Correcting for Scattered Light in WFC3/IR Exposures: Using <code class="docutils literal notranslate"><span class="pre">calwf3</span></code> to Mask Bad Reads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/ir_scattered_light_manual_corrections/Correcting_for_Scattered_Light_in_IR_Exposures_by_Manually_Subtracting_Bad_Reads.html">Correcting for Scattered Light in WFC3/IR Exposures: Manually Subtracting Bad Reads</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../WFC3/photometry.html">Photometry</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/filter_transformations/filter_transformations.html">WFC3/UVIS Filter Transformations with stsynphot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/flux_conversion_tool/flux_conversion_tool.html">Flux Unit Conversions with synphot and stsynphot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/photometry_examples/phot_examples.html">Synthetic Photometry Examples for WFC3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/uvis_time_dependent_photometry/uvis_timedep_phot.html">WFC3/UVIS Time-dependent Photometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/zeropoints/zeropoints.html">Calculating WFC3 Zeropoints with STSynphot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/uvis_pam_corrections/WFC3_UVIS_Pixel_Area_Map_Corrections_for_Subarrays.html">WFC3/UVIS Pixel Area Map Corrections for Subarrays</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../WFC3/point_spread_function.html">Point Spread Function (PSF)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/point_spread_function/hst_point_spread_function.html">HST WFC3 Point Spread Function Modeling   </a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/mast_api_psf/download_psf_cutouts.html">Downloading WFC3 and WFPC2 PSF Cutouts from MAST</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/spacetelescope/hst_notebooks/blob/main/notebooks/DrizzlePac/align_sparse_fields/align_sparse_fields.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/hst_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/hst_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/DrizzlePac/align_sparse_fields/align_sparse_fields.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/DrizzlePac/align_sparse_fields/align_sparse_fields.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Aligning Deep Exposures of Sparse Fields</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-a-id-intro-a">Introduction <a id="intro"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#download-the-observations-with-astroquery-a-id-download-a">1. Download the Observations with <code class="docutils literal notranslate"><span class="pre">astroquery</span></code> <a id="download"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-image-header-data-a-id-check-keywords-a">1.1 Check image header data <a id="check_keywords"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inspect-the-alignment-a-id-check-wcs-a">1.2 Inspect the Alignment <a id="check_wcs"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#align-with-tweakreg-a-id-tweakreg-a">2. Align with <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> <a id="tweakreg"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-default-parameters-test1-a-id-test1-a">2.1 Use ‘default’ parameters (Test1)  <a id="test1"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adjust-conv-width-to-find-extended-objects-test-2-a-id-test2-a">2.2 Adjust <code class="docutils literal notranslate"><span class="pre">conv_width</span></code> to find extended objects (Test 2) <a id="test2"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exclude-flagged-pixels-with-dqbits-test-3-a-id-test3-a">2.3 Exclude flagged pixels with <code class="docutils literal notranslate"><span class="pre">dqbits</span></code> (Test 3) <a id="test3"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#overplot-matched-sources-on-the-image-a-id-overplot-a">2.4 Overplot Matched Sources on the Image <a id="overplot"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rerun-tweakreg-to-update-the-header-wcs-a-id-updatehdr-a">2.5 Rerun TweakReg to update the header WCS <a id="updatehdr"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#combine-the-images-using-astrodrizzle-a-id-adriz-a">3. Combine the Images using <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> <a id="adriz"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#inspect-the-drizzled-science-and-weight-images-a-id-display-a">4. Inspect the drizzled science and weight images  <a id="display"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-resources-a-id-add-a">Additional Resources <a id="add"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#citations-a-id-cite-a">Citations <a id="cite"></a></a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="aligning-deep-exposures-of-sparse-fields">
<h1>Aligning Deep Exposures of Sparse Fields<a class="headerlink" href="#aligning-deep-exposures-of-sparse-fields" title="Permalink to this heading">#</a></h1>
<div class="alert alert-block alert-warning" style="color:black" > <b> This notebook requires creating and activating a virtual environment using the requirements file in this notebook's repository. Please also review the README file before using the notebook.</b> <br> </div><p><a id="toc"></a></p>
<section id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Introduction</span> <br></p>
<p><span class="xref myst">1. Download the Observations with <code class="docutils literal notranslate"><span class="pre">astroquery</span></code></span> <br>
    <span class="xref myst">1.1 Check image header data</span> <br>
    <span class="xref myst">1.2 Inspect the alignment</span> <br></p>
<p><span class="xref myst">2. Align with <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code></span> <br></p>
<p>    <span class="xref myst">2.1 Use ‘default’ parameters (Test1)</span> <br>
    <span class="xref myst">2.2 Adjust conv_width to find extended objects (Test 2)</span> <br>
    <span class="xref myst">2.3 Exclude flagged pixels with <code class="docutils literal notranslate"><span class="pre">dqbits</span></code> (Test 3)</span> <br>
    <span class="xref myst">2.4 Overplot Matched Sources on the Image</span> <br>
    <span class="xref myst">2.5 Rerun TweakReg to update the header WCS</span> <br></p>
<p><span class="xref myst">3. Combine the Images using <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code></span> <br></p>
<p><span class="xref myst">4. Inspect the drizzled science and weight images</span> <br></p>
<p>The following Python packages are required to run the Jupyter Notebook:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.python.org/3/library/collections.html"><strong>collections</strong></a> - include specialized datatypes</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/glob.html"><strong>glob</strong></a> - gather lists of filenames</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/os.html"><strong>os</strong></a> - change and make directories</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/shutil.html"><strong>shutil</strong></a> - perform high-level file operations</p></li>
<li><p><a class="reference external" href="https://ipython.readthedocs.io/en/stable/"><strong>iPython</strong></a> - interactive handling</p></li>
<li><p><a class="reference external" href="https://matplotlib.org"><strong>matplotlib</strong></a> - create graphics</p></li>
<li><p><a class="reference external" href="https://numpy.org"><strong>numpy</strong></a> - math and array functions</p></li>
<li><p><a class="reference external" href="https://www.astropy.org"><strong>astropy</strong></a> - FITS file handling and related operations</p></li>
<li><p><a class="reference external" href="https://astroquery.readthedocs.io/en/latest/"><strong>astroquery</strong></a> - download data and query databases</p></li>
<li><p><a class="reference external" href="https://drizzlepac.readthedocs.io/en/latest/"><strong>drizzlepac</strong></a> - align and combine HST images</p></li>
</ul>
</section>
<section id="introduction-a-id-intro-a">
<h2>Introduction <a id="intro"></a><a class="headerlink" href="#introduction-a-id-intro-a" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Table of Contents</span></p>
<p>This notebook demonstrates aligning long exposures which have relatively few stars and a large number of cosmic rays. It is based on the example described in the ISR linked here (<a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2015acs..rept....4L/abstract">ACS ISR 2015-04: Basic Use of SExtractor Catalogs With TweakReg - I</a>), but uses a much simpler methodology.</p>
<p>Rather than making use of external software (e.g. <a class="reference external" href="http://www.astromatic.net/software/sextractor">SExtractor</a>) and going through the extra steps to create ‘cosmic-ray cleaned’ images for each visit, this notebook demonstrates new features in <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> designed to mitigate false detections.</p>
<p><code class="docutils literal notranslate"><span class="pre">TweakReg</span></code>’s source finding task <code class="docutils literal notranslate"><span class="pre">imagefind</span></code> includes parameters to exclude false detections and allows the software to more easily solve for the image offsets using matched sources lists. For example, <code class="docutils literal notranslate"><span class="pre">dqbits</span></code> is a list of DQ flag values to include as ‘good’ or to exclude as ‘bad’ before generating and matching source lists. For ACS/WFC, setting <code class="docutils literal notranslate"><span class="pre">dqbits=-16</span></code> will mask hot pixels flagged by the instrument team, eliminating a common problem where <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> locks onto hot pixels and solves for the dither pattern. This can occur when users set the detection threshold value too low and hot pixels outnumber astronomical sources. Other new parameters allow selection for sharpness and roundness, which give users better control over source selection criteria and the mitigation of artifacts. More details on imagefindpars options may be found on the following <a class="reference external" href="https://drizzlepac.readthedocs.io/en/latest/user_reprocessing/imagefindpars.html">webpage</a>.</p>
<p>Please also make sure to appropriately set your environment variables to allow Python to locate the appropriate reference files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">clear_output</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">ascii</span><span class="p">,</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">ZScaleInterval</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.mast</span><span class="w"> </span><span class="kn">import</span> <span class="n">Observations</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">drizzlepac</span><span class="w"> </span><span class="kn">import</span> <span class="n">tweakreg</span><span class="p">,</span> <span class="n">astrodrizzle</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39; # Improves the resolution of figures rendered in notebooks.
</pre></div>
</div>
</div>
</div>
<p>Along with the above imports, we also set up the required local reference files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set the locations of reference files to your local computer.</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_SERVER_URL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;https://hst-crds.stsci.edu&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_SERVER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;https://hst-crds.stsci.edu&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;./crds_cache&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;iref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;./crds_cache/references/hst/wfc3/&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;jref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;./crds_cache/references/hst/acs/&#39;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="download-the-observations-with-astroquery-a-id-download-a">
<h2>1. Download the Observations with <code class="docutils literal notranslate"><span class="pre">astroquery</span></code> <a id="download"></a><a class="headerlink" href="#download-the-observations-with-astroquery-a-id-download-a" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Table of Contents</span></p>
<hr>
MAST queries may be done using <a href="https://astroquery.readthedocs.io/en/latest/mast/mast_obsquery.html#observation-criteria-queries"> `query_criteria`</a>, where we specify: <br>
<p>    –&gt; obs_id, proposal_id, and filters</p>
<p>MAST data products may be downloaded by using <a href="https://astroquery.readthedocs.io/en/latest/mast/mast_obsquery.html#downloading-data"> <code class="docutils literal notranslate"><span class="pre">download_products</span></code></a>, where we specify:<br></p>
<p>    –&gt; products = calibrated (FLT, FLC) or drizzled (DRZ, DRC) files</p>
<p>    –&gt; type = standard products (CALxxx) or advanced products (HAP-SVM)</p>
<hr>
The data in this example are comprised of 4 exposures in the F814W filter, all from Visit 0X of HST program 10092. Each exposure was dithered by ~60 pixels along the y-axis in order to obtain coverage in the area of the CCD chip gap. The X and Y dithers are given in arcseconds by the `POSTARG1` and `POSTARG2` keywords recorded in the image header.
<p>The following commands query MAST, download the calibrated, CTE-corrected FLC files, and place them in the same ‘working’ directory as this notebook.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>            j8xi0xs0q_flc.fits
            j8xi0xs3q_flc.fits
            j8xi0xs6q_flc.fits
            j8xi0xsaq_flc.fits
</pre></div>
</div>
<div class="alert alert-block alert-warning" style="color:black" >  Depending on your connection speed, this cell may take a few minutes to execute. </div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obs_ids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;j8xi0x*&quot;</span><span class="p">]</span>
<span class="n">props</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;10092&quot;</span><span class="p">]</span>
<span class="n">filts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;F814W&quot;</span><span class="p">]</span>

<span class="n">obsTable</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span><span class="n">obs_id</span><span class="o">=</span><span class="n">obs_ids</span><span class="p">,</span> <span class="n">proposal_id</span><span class="o">=</span><span class="n">props</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">filts</span><span class="p">)</span>
<span class="n">products</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span><span class="n">obsTable</span><span class="p">)</span>

<span class="n">data_prod</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FLC&quot;</span><span class="p">]</span>  <span class="c1"># [&#39;FLC&#39;,&#39;FLT&#39;,&#39;DRC&#39;,&#39;DRZ&#39;]</span>
<span class="n">data_type</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CALACS&quot;</span><span class="p">]</span>  <span class="c1"># [&#39;CALACS&#39;,&#39;CALWF3&#39;,&#39;CALWP2&#39;,&#39;HAP-SVM&#39;]</span>

<span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span>
    <span class="n">products</span><span class="p">,</span> <span class="n">productSubGroupDescription</span><span class="o">=</span><span class="n">data_prod</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/j8xi0xs0q_flc.fits to ./mastDownload/HST/j8xi0xs0q/j8xi0xs0q_flc.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/j8xi0xs3q_flc.fits to ./mastDownload/HST/j8xi0xs3q/j8xi0xs3q_flc.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/j8xi0xs6q_flc.fits to ./mastDownload/HST/j8xi0xs6q/j8xi0xs6q_flc.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/j8xi0xsaq_flc.fits to ./mastDownload/HST/j8xi0xsaq/j8xi0xsaq_flc.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output text_html"><div><i>Table length=4</i>
<table id="table140682480490896" class="table-striped table-bordered table-condensed">
<thead><tr><th>Local Path</th><th>Status</th><th>Message</th><th>URL</th></tr></thead>
<thead><tr><th>str47</th><th>str8</th><th>object</th><th>object</th></tr></thead>
<tr><td>./mastDownload/HST/j8xi0xs0q/j8xi0xs0q_flc.fits</td><td>COMPLETE</td><td>None</td><td>None</td></tr>
<tr><td>./mastDownload/HST/j8xi0xs3q/j8xi0xs3q_flc.fits</td><td>COMPLETE</td><td>None</td><td>None</td></tr>
<tr><td>./mastDownload/HST/j8xi0xs6q/j8xi0xs6q_flc.fits</td><td>COMPLETE</td><td>None</td><td>None</td></tr>
<tr><td>./mastDownload/HST/j8xi0xsaq/j8xi0xsaq_flc.fits</td><td>COMPLETE</td><td>None</td><td>None</td></tr>
</table></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Move the files to the local working directory</span>
<span class="k">for</span> <span class="n">flc</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;./mastDownload/HST/*/*flc.fits&quot;</span><span class="p">):</span>
    <span class="n">flc_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">flc</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">flc</span><span class="p">,</span> <span class="n">flc_name</span><span class="p">)</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;mastDownload&quot;</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s2">&quot;mastDownload&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="check-image-header-data-a-id-check-keywords-a">
<h3>1.1 Check image header data <a id="check_keywords"></a><a class="headerlink" href="#check-image-header-data-a-id-check-keywords-a" title="Permalink to this heading">#</a></h3>
<p>Here we will look at important keywords in the image headers.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*flc.fits&quot;</span><span class="p">))</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">keywords_ext0</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;ROOTNAME&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ASN_ID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TARGNAME&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DETECTOR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;FILTER2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;exptime&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ra_targ&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dec_targ&quot;</span><span class="p">,</span>
    <span class="s2">&quot;postarg1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;postarg2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DATE-OBS&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">keywords_ext1</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;orientat&quot;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">input_files</span><span class="p">:</span>
    <span class="n">path_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">keywords_ext0</span><span class="p">:</span>
        <span class="n">path_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">keywords_ext1</span><span class="p">:</span>
        <span class="n">path_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_data</span><span class="p">)</span>

<span class="n">keywords</span> <span class="o">=</span> <span class="n">keywords_ext0</span> <span class="o">+</span> <span class="n">keywords_ext1</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
    <span class="n">names</span><span class="o">=</span><span class="n">keywords</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;str&quot;</span><span class="p">,</span>
        <span class="s2">&quot;str&quot;</span><span class="p">,</span>
        <span class="s2">&quot;str&quot;</span><span class="p">,</span>
        <span class="s2">&quot;str&quot;</span><span class="p">,</span>
        <span class="s2">&quot;str&quot;</span><span class="p">,</span>
        <span class="s2">&quot;f8&quot;</span><span class="p">,</span>
        <span class="s2">&quot;f8&quot;</span><span class="p">,</span>
        <span class="s2">&quot;f8&quot;</span><span class="p">,</span>
        <span class="s2">&quot;f8&quot;</span><span class="p">,</span>
        <span class="s2">&quot;f8&quot;</span><span class="p">,</span>
        <span class="s2">&quot;str&quot;</span><span class="p">,</span>
        <span class="s2">&quot;f8&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>
<span class="n">table</span><span class="p">[</span><span class="s2">&quot;exptime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s2">&quot;7.1f&quot;</span>
<span class="n">table</span><span class="p">[</span><span class="s2">&quot;ra_targ&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;dec_targ&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s2">&quot;7.4f&quot;</span>
<span class="n">table</span><span class="p">[</span><span class="s2">&quot;postarg1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;postarg2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s2">&quot;7.3f&quot;</span>
<span class="n">table</span><span class="p">[</span><span class="s2">&quot;orientat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s2">&quot;7.2f&quot;</span>
<span class="n">table</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><i>Table length=4</i>
<table id="table140682523910288" class="table-striped table-bordered table-condensed">
<thead><tr><th>ROOTNAME</th><th>ASN_ID</th><th>TARGNAME</th><th>DETECTOR</th><th>FILTER2</th><th>exptime</th><th>ra_targ</th><th>dec_targ</th><th>postarg1</th><th>postarg2</th><th>DATE-OBS</th><th>orientat</th></tr></thead>
<thead><tr><th>str32</th><th>str32</th><th>str32</th><th>str32</th><th>str32</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>str32</th><th>float64</th></tr></thead>
<tr><td>j8xi0xs0q</td><td>J8XI0X010</td><td>COSMOS23-14</td><td>WFC</td><td>F814W</td><td>507.0</td><td>150.2023</td><td>2.6773</td><td>0.062</td><td>-3.052</td><td>2004-05-15</td><td>97.75</td></tr>
<tr><td>j8xi0xs3q</td><td>J8XI0X010</td><td>COSMOS23-14</td><td>WFC</td><td>F814W</td><td>507.0</td><td>150.2023</td><td>2.6773</td><td>0.310</td><td>0.024</td><td>2004-05-15</td><td>97.76</td></tr>
<tr><td>j8xi0xs6q</td><td>J8XI0X010</td><td>COSMOS23-14</td><td>WFC</td><td>F814W</td><td>507.0</td><td>150.2023</td><td>2.6773</td><td>-0.062</td><td>3.052</td><td>2004-05-15</td><td>97.76</td></tr>
<tr><td>j8xi0xsaq</td><td>J8XI0X010</td><td>COSMOS23-14</td><td>WFC</td><td>F814W</td><td>507.0</td><td>150.2023</td><td>2.6773</td><td>0.186</td><td>6.127</td><td>2004-05-15</td><td>97.76</td></tr>
</table></div></div></div>
</div>
</section>
<section id="inspect-the-alignment-a-id-check-wcs-a">
<h3>1.2 Inspect the Alignment <a id="check_wcs"></a><a class="headerlink" href="#inspect-the-alignment-a-id-check-wcs-a" title="Permalink to this heading">#</a></h3>
<p>Check the active WCS solution in the image header. If the image is aligned to a catalog, list the number of matches and the fit RMS in units of mas. <br></p>
<p>Convert the fit RMS values to pixels for comparison with the alignment results performed later in this notebook.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ext_0_kws</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DETECTOR&quot;</span><span class="p">,</span> <span class="s2">&quot;EXPTIME&quot;</span><span class="p">]</span>
<span class="n">ext_1_kws</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;WCSNAME&quot;</span><span class="p">,</span> <span class="s2">&quot;NMATCHES&quot;</span><span class="p">,</span> <span class="s2">&quot;RMS_RA&quot;</span><span class="p">,</span> <span class="s2">&quot;RMS_DEC&quot;</span><span class="p">]</span>

<span class="n">det_scale</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;IR&quot;</span><span class="p">:</span> <span class="mf">0.1283</span><span class="p">,</span> <span class="s2">&quot;UVIS&quot;</span><span class="p">:</span> <span class="mf">0.0396</span><span class="p">,</span> <span class="s2">&quot;WFC&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">}</span>  <span class="c1"># plate scale (arcsec/pixel)</span>

<span class="n">format_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">col_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*flc.fits&quot;</span><span class="p">)):</span>
    <span class="n">col_dict</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">hdr0</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">hdr1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">ext_0_kws</span><span class="p">:</span>  <span class="c1"># extension 0 keywords</span>
        <span class="n">col_dict</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdr0</span><span class="p">[</span><span class="n">kw</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">ext_1_kws</span><span class="p">:</span>  <span class="c1"># extension 1 keywords</span>
        <span class="k">if</span> <span class="s2">&quot;RMS&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">hdr1</span><span class="p">[</span><span class="n">kw</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">hdr1</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span>
        <span class="n">col_dict</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;RMS_RA&quot;</span><span class="p">,</span> <span class="s2">&quot;RMS_DEC&quot;</span><span class="p">]:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
            <span class="n">hdr1</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1000.0</span> <span class="o">/</span> <span class="n">det_scale</span><span class="p">[</span><span class="n">hdr0</span><span class="p">[</span><span class="s2">&quot;DETECTOR&quot;</span><span class="p">]],</span> <span class="mi">2</span>
        <span class="p">)</span>  <span class="c1"># convert RMS from mas to pixels</span>
        <span class="n">col_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kw</span><span class="si">}</span><span class="s2">_pix&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

<span class="n">wcstable</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">col_dict</span><span class="p">)</span>
<span class="n">wcstable</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><i>Table length=4</i>
<table id="table140682457663632" class="table-striped table-bordered table-condensed">
<thead><tr><th>filename</th><th>DETECTOR</th><th>EXPTIME</th><th>WCSNAME</th><th>NMATCHES</th><th>RMS_RA</th><th>RMS_DEC</th><th>RMS_RA_pix</th><th>RMS_DEC_pix</th></tr></thead>
<thead><tr><th>str18</th><th>str3</th><th>float64</th><th>str28</th><th>int64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>j8xi0xs0q_flc.fits</td><td>WFC</td><td>507.0</td><td>IDC_4bb1536oj-FIT_REL_GSC242</td><td>54</td><td>38.5</td><td>41.9</td><td>0.77</td><td>0.84</td></tr>
<tr><td>j8xi0xs3q_flc.fits</td><td>WFC</td><td>507.0</td><td>IDC_4bb1536oj-FIT_REL_GSC242</td><td>54</td><td>38.5</td><td>41.9</td><td>0.77</td><td>0.84</td></tr>
<tr><td>j8xi0xs6q_flc.fits</td><td>WFC</td><td>507.0</td><td>IDC_4bb1536oj-FIT_REL_GSC242</td><td>54</td><td>38.5</td><td>41.9</td><td>0.77</td><td>0.84</td></tr>
<tr><td>j8xi0xsaq_flc.fits</td><td>WFC</td><td>507.0</td><td>IDC_4bb1536oj-FIT_REL_GSC242</td><td>54</td><td>38.5</td><td>41.9</td><td>0.77</td><td>0.84</td></tr>
</table></div></div></div>
</div>
<p>Here we see that the four FLC images have a “FIT_REL_GSC242” WCS solution, which means they were aligned as a set to the reference catalog ‘GSC v2.4.2’ using the combined drizzled image and that WCS was propogated back to the original FLCs.  This is reflected in the fact that the number of matches and fit rms values are the same for each FLC frame.</p>
<p>For more details on absolute astrometry in HST images, see <a class="reference external" href="https://hst-docs.stsci.edu/drizzpac/chapter-4-astrometric-information-in-the-header/4-5-absolute-astrometry">Section 4.5 in the DrizzlePac Handbook</a>.</p>
<hr>
</section>
</section>
<section id="align-with-tweakreg-a-id-tweakreg-a">
<h2>2. Align with <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code>  <a id="tweakreg"></a><a class="headerlink" href="#align-with-tweakreg-a-id-tweakreg-a" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Table of Contents</span></p>
<p>Here we use <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> to test the relative alignment of the FLC frames based on sources in the image.</p>
<p>Typically, observations taken as part of a dither pattern with small POSTARG offsets (e.g. a few pixels) will have excellent relative astrometry and will not need further tweaks to the alignment. Instead the typical workflow would be to align the combined DRC frames from different visits or filters and then run TweakBack to propogate those solutions back to the FLC frames.   This is recommended when there are not enough point sources to get an accurate FLC solution for each individual frame and ensures that any commanded dithers which carefully subsample the detector pixels are not corrupted with due to uncertainties in alignment of FLC frames.</p>
<p>For this dataset, however, the commanded dithers are large (up to ~120 pixels), and small pointing errors may need to be corrected between FLC frames.</p>
<p>Here, we build on the existing absolute positions based on GSC v2.4.2 and then test for additional errors in the alignment between frames.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> parameter <code class="docutils literal notranslate"><span class="pre">conv_width</span></code> specifies the convolution kernel width in pixels, with recommended values ~2x the PSF FWHM for detecting point sources in the FLC frame. For ACS/WFC &amp; WFC3/UVIS, this parameter is typically set to 3.5 pixels and for WFC3/IR to 2.5 pixels, but the value can be increased in order to use compact objects such as small galaxies for alignment.</p>
<section id="use-default-parameters-test1-a-id-test1-a">
<h3>2.1 Use ‘default’ parameters (Test1)  <a id="test1"></a><a class="headerlink" href="#use-default-parameters-test1-a-id-test1-a" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tweakreg</span><span class="o">.</span><span class="n">TweakReg</span><span class="p">(</span>
    <span class="n">input_files</span><span class="p">,</span>
    <span class="n">imagefindcfg</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;conv_width&quot;</span><span class="p">:</span> <span class="mf">3.5</span><span class="p">},</span>
    <span class="n">shiftfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">outshifts</span><span class="o">=</span><span class="s2">&quot;shift814_flc_test1.txt&quot;</span><span class="p">,</span>
    <span class="n">updatehdr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">ylimit</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
    <span class="n">searchrad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">clear_output</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/5ba4b2edbbc781ed2493efca9574c1b3e681db737d5a58ada7b2badf2b5b5263.png" src="../../../_images/5ba4b2edbbc781ed2493efca9574c1b3e681db737d5a58ada7b2badf2b5b5263.png" />
<img alt="../../../_images/9f502bf76d18facecd425c182ceb515b30f3712cf9663f957313160fb2cc104d.png" src="../../../_images/9f502bf76d18facecd425c182ceb515b30f3712cf9663f957313160fb2cc104d.png" />
<img alt="../../../_images/76c4a63aa4ef3ff82f65495057e5bb6ccda83236885ef3835d1d7048311cdd53.png" src="../../../_images/76c4a63aa4ef3ff82f65495057e5bb6ccda83236885ef3835d1d7048311cdd53.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># If the alignment is unsuccessful, stop the notebook</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;shift814_flc_test1.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">shift</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line_number</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shift</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;nan&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;nan found in line </span><span class="si">{}</span><span class="s2"> in shift file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line_number</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Inspect the shift file for Test 1</span>
<span class="n">shift_table</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
    <span class="s2">&quot;shift814_flc_test1.txt&quot;</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;ascii.no_header&quot;</span><span class="p">,</span>
    <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="s2">&quot;dx&quot;</span><span class="p">,</span> <span class="s2">&quot;dy&quot;</span><span class="p">,</span> <span class="s2">&quot;rot&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="s2">&quot;xrms&quot;</span><span class="p">,</span> <span class="s2">&quot;yrms&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">formats</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.2f&quot;</span><span class="p">,</span> <span class="s2">&quot;.2f&quot;</span><span class="p">,</span> <span class="s2">&quot;.3f&quot;</span><span class="p">,</span> <span class="s2">&quot;.5f&quot;</span><span class="p">,</span> <span class="s2">&quot;.2f&quot;</span><span class="p">,</span> <span class="s2">&quot;.2f&quot;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shift_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
    <span class="n">shift_table</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="n">shift_table</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><i>Table length=4</i>
<table id="table140682318641680" class="table-striped table-bordered table-condensed">
<thead><tr><th>file</th><th>dx</th><th>dy</th><th>rot</th><th>scale</th><th>xrms</th><th>yrms</th></tr></thead>
<thead><tr><th>str18</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>j8xi0xs0q_flc.fits</td><td>0.00</td><td>0.00</td><td>0.000</td><td>1.00000</td><td>0.00</td><td>0.00</td></tr>
<tr><td>j8xi0xs3q_flc.fits</td><td>0.11</td><td>0.00</td><td>0.002</td><td>0.99998</td><td>0.35</td><td>0.22</td></tr>
<tr><td>j8xi0xs6q_flc.fits</td><td>0.08</td><td>0.05</td><td>0.000</td><td>1.00004</td><td>0.43</td><td>0.33</td></tr>
<tr><td>j8xi0xsaq_flc.fits</td><td>-0.19</td><td>-0.13</td><td>360.000</td><td>1.00001</td><td>0.39</td><td>0.29</td></tr>
</table></div></div></div>
</div>
<p>To verify that <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> has found a good fit, it is important to look at the shift file and the fit residuals.</p>
<p>Below are the dx,dy residuals for each FLC file with respect to the reference image <code class="docutils literal notranslate"><span class="pre">j8xi0xsaq_flc.fits</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> finds ~75 matches per frame, but the RMS of the fit residuals is large at ~0.3 pixels, and the points are not nicely clustered around dx,dy=0.0, as expected for a good fit.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Give the &#39;fit residual plots&#39; a unique name for comparison with other tests.</span>
<span class="n">residual_pngs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;residual*png&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">png</span> <span class="ow">in</span> <span class="n">residual_pngs</span><span class="p">:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span> <span class="n">png</span><span class="p">))</span>
    <span class="n">new_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span> <span class="s2">&quot;test1_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">png</span><span class="p">)))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">new_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;test1_residuals_j8xi0xs3q_flc.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/c1ebc80125825eb3a3725d01ef0c5221b1b6bbedef0ff6aff372a41e7a53a4ff.png" src="../../../_images/c1ebc80125825eb3a3725d01ef0c5221b1b6bbedef0ff6aff372a41e7a53a4ff.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;test1_residuals_j8xi0xs6q_flc.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/45431b1341adc9c0257962354f600eecb22c2c03bed32a42c2529f26e190e658.png" src="../../../_images/45431b1341adc9c0257962354f600eecb22c2c03bed32a42c2529f26e190e658.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;test1_residuals_j8xi0xsaq_flc.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/1f80a9806b1214d8880e1c0d25e6f2982c37e907e156959d317233f45546aa7e.png" src="../../../_images/1f80a9806b1214d8880e1c0d25e6f2982c37e907e156959d317233f45546aa7e.png" />
</div>
</div>
</section>
<section id="adjust-conv-width-to-find-extended-objects-test-2-a-id-test2-a">
<h3>2.2 Adjust <code class="docutils literal notranslate"><span class="pre">conv_width</span></code> to find extended objects (Test 2) <a id="test2"></a><a class="headerlink" href="#adjust-conv-width-to-find-extended-objects-test-2-a-id-test2-a" title="Permalink to this heading">#</a></h3>
<p>In order for <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> to use compact galaxies rather than point sources for alignment, we increase the convolution kernel width parameter <code class="docutils literal notranslate"><span class="pre">conv_width</span></code> from 3.5 to 6.0 pixels in order to find sources with a FWHM ~3 pixels in the FLC frames.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tweakreg</span><span class="o">.</span><span class="n">TweakReg</span><span class="p">(</span>
    <span class="n">input_files</span><span class="p">,</span>
    <span class="n">imagefindcfg</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;conv_width&quot;</span><span class="p">:</span> <span class="mf">6.0</span><span class="p">},</span>
    <span class="n">shiftfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">outshifts</span><span class="o">=</span><span class="s2">&quot;shift814_flc_test2.txt&quot;</span><span class="p">,</span>
    <span class="n">updatehdr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">ylimit</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
    <span class="n">searchrad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">clear_output</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Inspect the shift file for Test2</span>
<span class="n">shift_table2</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
    <span class="s2">&quot;shift814_flc_test2.txt&quot;</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;ascii.no_header&quot;</span><span class="p">,</span>
    <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="s2">&quot;dx&quot;</span><span class="p">,</span> <span class="s2">&quot;dy&quot;</span><span class="p">,</span> <span class="s2">&quot;rot&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="s2">&quot;xrms&quot;</span><span class="p">,</span> <span class="s2">&quot;yrms&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">formats</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.2f&quot;</span><span class="p">,</span> <span class="s2">&quot;.2f&quot;</span><span class="p">,</span> <span class="s2">&quot;.3f&quot;</span><span class="p">,</span> <span class="s2">&quot;.5f&quot;</span><span class="p">,</span> <span class="s2">&quot;.2f&quot;</span><span class="p">,</span> <span class="s2">&quot;.2f&quot;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shift_table2</span><span class="o">.</span><span class="n">colnames</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
    <span class="n">shift_table2</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="n">shift_table2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><i>Table length=4</i>
<table id="table140682111138512" class="table-striped table-bordered table-condensed">
<thead><tr><th>file</th><th>dx</th><th>dy</th><th>rot</th><th>scale</th><th>xrms</th><th>yrms</th></tr></thead>
<thead><tr><th>str18</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>j8xi0xs0q_flc.fits</td><td>0.00</td><td>0.00</td><td>0.000</td><td>1.00000</td><td>0.00</td><td>0.00</td></tr>
<tr><td>j8xi0xs3q_flc.fits</td><td>-0.01</td><td>-0.01</td><td>360.000</td><td>1.00000</td><td>0.06</td><td>0.11</td></tr>
<tr><td>j8xi0xs6q_flc.fits</td><td>-0.06</td><td>-0.07</td><td>360.000</td><td>1.00000</td><td>0.18</td><td>0.09</td></tr>
<tr><td>j8xi0xsaq_flc.fits</td><td>-0.06</td><td>-0.14</td><td>359.999</td><td>1.00000</td><td>0.09</td><td>0.10</td></tr>
</table></div></div></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> now matches ~40 objects per frame, and the fit for images 2 and 4 look good, with an RMS ~0.1 pixels and with the residuals dx,dy clustered around 0.0.  For the third image <code class="docutils literal notranslate"><span class="pre">j8xi0xs6q_flc.fits</span></code>, the XRMS is ~0.2 pixels, and the points are not centered around dx,dy=0 pixels.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Give the &#39;fit residual plots&#39; a unique name for comparison with subsequent tests.</span>
<span class="n">residual_pngs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;residual*png&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">png</span> <span class="ow">in</span> <span class="n">residual_pngs</span><span class="p">:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span> <span class="n">png</span><span class="p">))</span>
    <span class="n">new_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span> <span class="s2">&quot;test2_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">png</span><span class="p">)))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">new_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;test2_residuals_j8xi0xs3q_flc.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/e2407ec3f2115de56e47894a96424c5ca9e1bd73c054ee024ba5db6830835b3e.png" src="../../../_images/e2407ec3f2115de56e47894a96424c5ca9e1bd73c054ee024ba5db6830835b3e.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;test2_residuals_j8xi0xs6q_flc.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/d3ce3b85adde86c57fc97636199b7634836b2732e814accfc67e98041ccfdbfe.png" src="../../../_images/d3ce3b85adde86c57fc97636199b7634836b2732e814accfc67e98041ccfdbfe.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;test2_residuals_j8xi0xsaq_flc.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/788ae92ccf315168c016a6fa0be1776e6bd2d609801a142a9ea82d0d4a1dc17a.png" src="../../../_images/788ae92ccf315168c016a6fa0be1776e6bd2d609801a142a9ea82d0d4a1dc17a.png" />
</div>
</div>
</section>
<section id="exclude-flagged-pixels-with-dqbits-test-3-a-id-test3-a">
<h3>2.3 Exclude flagged pixels with <code class="docutils literal notranslate"><span class="pre">dqbits</span></code> (Test 3) <a id="test3"></a><a class="headerlink" href="#exclude-flagged-pixels-with-dqbits-test-3-a-id-test3-a" title="Permalink to this heading">#</a></h3>
<p>To further improve the alignment, we make use of flags in the DQ array of the FLC files. The source finding parameters in <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> may be modified to exclude flagged pixels when generating lists of objects in each image.</p>
<p>Setting the parameter <code class="docutils literal notranslate"><span class="pre">dqbits=0</span></code> will consider all non-zero pixels in the DQ mask to be “bad” pixels, and the corresponding image pixels will not be used for source finding. The default value of <code class="docutils literal notranslate"><span class="pre">None</span></code> will turn off the use of image’s DQ array for source finding.</p>
<p>In this case, <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> was already run by MAST on visit 0X, and cosmic-ray flags were populated in the DQ array of the FLC frames. Since the exposures within this visit were already well aligned, the 4096 flags for cosmic rays are useful for excluding false detections.</p>
<p>Detailed definitions of the ACS DQ flags can be found at <a class="reference external" href="https://www.stsci.edu/hst/instrumentation/acs/data-analysis/dq-flag-definitions">this webpage.</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tweakreg</span><span class="o">.</span><span class="n">TweakReg</span><span class="p">(</span>
    <span class="n">input_files</span><span class="p">,</span>
    <span class="n">imagefindcfg</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;conv_width&quot;</span><span class="p">:</span> <span class="mf">6.0</span><span class="p">,</span> <span class="s2">&quot;dqbits&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
    <span class="n">shiftfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">outshifts</span><span class="o">=</span><span class="s2">&quot;shift814_flc_test3.txt&quot;</span><span class="p">,</span>
    <span class="n">updatehdr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">ylimit</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
    <span class="n">searchrad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">clear_output</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Inspect the shift file for Test2</span>
<span class="n">shift_table3</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
    <span class="s2">&quot;shift814_flc_test3.txt&quot;</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;ascii.no_header&quot;</span><span class="p">,</span>
    <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="s2">&quot;dx&quot;</span><span class="p">,</span> <span class="s2">&quot;dy&quot;</span><span class="p">,</span> <span class="s2">&quot;rot&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="s2">&quot;xrms&quot;</span><span class="p">,</span> <span class="s2">&quot;yrms&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">formats</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.2f&quot;</span><span class="p">,</span> <span class="s2">&quot;.2f&quot;</span><span class="p">,</span> <span class="s2">&quot;.3f&quot;</span><span class="p">,</span> <span class="s2">&quot;.5f&quot;</span><span class="p">,</span> <span class="s2">&quot;.2f&quot;</span><span class="p">,</span> <span class="s2">&quot;.2f&quot;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shift_table3</span><span class="o">.</span><span class="n">colnames</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
    <span class="n">shift_table3</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="n">shift_table3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><i>Table length=4</i>
<table id="table140682109746896" class="table-striped table-bordered table-condensed">
<thead><tr><th>file</th><th>dx</th><th>dy</th><th>rot</th><th>scale</th><th>xrms</th><th>yrms</th></tr></thead>
<thead><tr><th>str18</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>j8xi0xs0q_flc.fits</td><td>0.00</td><td>0.00</td><td>0.000</td><td>1.00000</td><td>0.00</td><td>0.00</td></tr>
<tr><td>j8xi0xs3q_flc.fits</td><td>-0.01</td><td>-0.02</td><td>359.999</td><td>0.99999</td><td>0.04</td><td>0.04</td></tr>
<tr><td>j8xi0xs6q_flc.fits</td><td>-0.10</td><td>-0.04</td><td>360.000</td><td>1.00001</td><td>0.03</td><td>0.03</td></tr>
<tr><td>j8xi0xsaq_flc.fits</td><td>-0.08</td><td>-0.12</td><td>359.999</td><td>1.00000</td><td>0.11</td><td>0.08</td></tr>
</table></div></div></div>
</div>
<p>In this third test, <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> again finds ~40 matches per frame, but with spurious detections eliminated has an easier time locking onto the correct solution.  The fit residuals below all have an RMS ~0.1 pixels and the points are all clustered around dx,dy=0.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Give the &#39;fit residual plots&#39; a unique name for comparison with other tests.</span>
<span class="n">residual_pngs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;residual*png&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">png</span> <span class="ow">in</span> <span class="n">residual_pngs</span><span class="p">:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span> <span class="n">png</span><span class="p">))</span>
    <span class="n">new_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span> <span class="s2">&quot;test3_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">png</span><span class="p">)))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">new_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;test3_residuals_j8xi0xs3q_flc.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/d456085dc32e1359949d1a335231bea8befda409b65804e971849f6b9ddd44a7.png" src="../../../_images/d456085dc32e1359949d1a335231bea8befda409b65804e971849f6b9ddd44a7.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;test3_residuals_j8xi0xs6q_flc.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/945d9cd73088d799b4cf0100678eab6800ecd5e05e12afa22004e4810ec73215.png" src="../../../_images/945d9cd73088d799b4cf0100678eab6800ecd5e05e12afa22004e4810ec73215.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;test3_residuals_j8xi0xsaq_flc.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/954dba08785d55b8d912d014c8439d04229305b28748e87980557596491e4baa.png" src="../../../_images/954dba08785d55b8d912d014c8439d04229305b28748e87980557596491e4baa.png" />
</div>
</div>
<p>Here we compare the accuracy of the <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> solution with the MAST alignment results.</p>
<p>First, we print the number of matches per image and compare with MAST WCS fitting results. Note that MAST finds a larger number of matches but also has a much larger fit RMS ~0.8 pixels.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">match_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*_flc_catalog_fit.match&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">match_files</span><span class="p">:</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of Matches for&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39; = &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of Matches for j8xi0xs3q_flc_catalog_fit.match  =  38
Number of Matches for j8xi0xsaq_flc_catalog_fit.match  =  41
Number of Matches for j8xi0xs6q_flc_catalog_fit.match  =  37
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wcstable</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><i>Table length=4</i>
<table id="table140682457663632" class="table-striped table-bordered table-condensed">
<thead><tr><th>filename</th><th>DETECTOR</th><th>EXPTIME</th><th>WCSNAME</th><th>NMATCHES</th><th>RMS_RA</th><th>RMS_DEC</th><th>RMS_RA_pix</th><th>RMS_DEC_pix</th></tr></thead>
<thead><tr><th>str18</th><th>str3</th><th>float64</th><th>str28</th><th>int64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>j8xi0xs0q_flc.fits</td><td>WFC</td><td>507.0</td><td>IDC_4bb1536oj-FIT_REL_GSC242</td><td>54</td><td>38.5</td><td>41.9</td><td>0.77</td><td>0.84</td></tr>
<tr><td>j8xi0xs3q_flc.fits</td><td>WFC</td><td>507.0</td><td>IDC_4bb1536oj-FIT_REL_GSC242</td><td>54</td><td>38.5</td><td>41.9</td><td>0.77</td><td>0.84</td></tr>
<tr><td>j8xi0xs6q_flc.fits</td><td>WFC</td><td>507.0</td><td>IDC_4bb1536oj-FIT_REL_GSC242</td><td>54</td><td>38.5</td><td>41.9</td><td>0.77</td><td>0.84</td></tr>
<tr><td>j8xi0xsaq_flc.fits</td><td>WFC</td><td>507.0</td><td>IDC_4bb1536oj-FIT_REL_GSC242</td><td>54</td><td>38.5</td><td>41.9</td><td>0.77</td><td>0.84</td></tr>
</table></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shift_table3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><i>Table length=4</i>
<table id="table140682109746896" class="table-striped table-bordered table-condensed">
<thead><tr><th>file</th><th>dx</th><th>dy</th><th>rot</th><th>scale</th><th>xrms</th><th>yrms</th></tr></thead>
<thead><tr><th>str18</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>j8xi0xs0q_flc.fits</td><td>0.00</td><td>0.00</td><td>0.000</td><td>1.00000</td><td>0.00</td><td>0.00</td></tr>
<tr><td>j8xi0xs3q_flc.fits</td><td>-0.01</td><td>-0.02</td><td>359.999</td><td>0.99999</td><td>0.04</td><td>0.04</td></tr>
<tr><td>j8xi0xs6q_flc.fits</td><td>-0.10</td><td>-0.04</td><td>360.000</td><td>1.00001</td><td>0.03</td><td>0.03</td></tr>
<tr><td>j8xi0xsaq_flc.fits</td><td>-0.08</td><td>-0.12</td><td>359.999</td><td>1.00000</td><td>0.11</td><td>0.08</td></tr>
</table></div></div></div>
</div>
<p>These results show that the images with large dithers have small pointing errors ~0.1 pixels which will need to be corrected before recombining the FLC frames.  Before doing that, we do one last quality check to verify that the matched sources used for the fit correspond to real astronomical sources and not image artifacts.</p>
</section>
<section id="overplot-matched-sources-on-the-image-a-id-overplot-a">
<h3>2.4 Overplot Matched Sources on the Image <a id="overplot"></a><a class="headerlink" href="#overplot-matched-sources-on-the-image-a-id-overplot-a" title="Permalink to this heading">#</a></h3>
<p>Let’s plot the sources that were matched between two FLC frames.</p>
<p>The cell below shows how to read in the <code class="docutils literal notranslate"><span class="pre">*_fit.match</span></code> file as an <code class="docutils literal notranslate"><span class="pre">astropy</span></code> table. Unfortunately, it doesn’t automatically name columns so you’ll have to look at the header to grab the columns.</p>
<p>To verify that <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> obtained a good fit between matched source catalogs, it is useful to inspect the results before updating the image header WCS. Below sources matched with Gaia are overplotted on one of the input FLC frames (with the two chips merged together).</p>
<p>It can be useful to check that <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> locked onto stars and not hot pixels or other detector artifacts before proceeding to update the image header.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rootname</span> <span class="o">=</span> <span class="s2">&quot;j8xi0xsaq&quot;</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">140</span><span class="p">)</span>
<span class="n">chip1_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">rootname</span> <span class="o">+</span> <span class="s2">&quot;_flc.fits&quot;</span><span class="p">,</span> <span class="s2">&quot;SCI&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">chip2_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">rootname</span> <span class="o">+</span> <span class="s2">&quot;_flc.fits&quot;</span><span class="p">,</span> <span class="s2">&quot;SCI&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fullsci</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">chip2_data</span><span class="p">,</span> <span class="n">chip1_data</span><span class="p">])</span>
<span class="n">zscale</span> <span class="o">=</span> <span class="n">ZScaleInterval</span><span class="p">()</span>
<span class="n">z1</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">zscale</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">fullsci</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fullsci</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greys&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">z1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">z2</span><span class="p">)</span>

<span class="n">match_tab</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
    <span class="n">rootname</span> <span class="o">+</span> <span class="s2">&quot;_flc_catalog_fit.match&quot;</span>
<span class="p">)</span>  <span class="c1"># load match file in astropy table</span>
<span class="n">match_tab_chip1</span> <span class="o">=</span> <span class="n">match_tab</span><span class="p">[</span>
    <span class="n">match_tab</span><span class="p">[</span><span class="s2">&quot;col15&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
<span class="p">]</span>  <span class="c1"># filter table for sources on chip 1 (on ext 4)</span>
<span class="n">match_tab_chip2</span> <span class="o">=</span> <span class="n">match_tab</span><span class="p">[</span>
    <span class="n">match_tab</span><span class="p">[</span><span class="s2">&quot;col15&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
<span class="p">]</span>  <span class="c1"># filter table for sources on chip 1 (on ext 4)</span>
<span class="n">x_cord1</span><span class="p">,</span> <span class="n">y_cord1</span> <span class="o">=</span> <span class="n">match_tab_chip1</span><span class="p">[</span><span class="s2">&quot;col11&quot;</span><span class="p">],</span> <span class="n">match_tab_chip1</span><span class="p">[</span><span class="s2">&quot;col12&quot;</span><span class="p">]</span>
<span class="n">x_cord2</span><span class="p">,</span> <span class="n">y_cord2</span> <span class="o">=</span> <span class="n">match_tab_chip2</span><span class="p">[</span><span class="s2">&quot;col11&quot;</span><span class="p">],</span> <span class="n">match_tab_chip2</span><span class="p">[</span><span class="s2">&quot;col12&quot;</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">x_cord1</span><span class="p">,</span>
    <span class="n">y_cord1</span> <span class="o">+</span> <span class="mi">2051</span><span class="p">,</span>
    <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
    <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Matched Sources&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_cord2</span><span class="p">,</span> <span class="n">y_cord2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Matched sources FLC to FLC: N = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">match_tab</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/ca4bcf98d5f6b85699dab86f718103a69a4142dbb318b647310c1241f503ff9a.png" src="../../../_images/ca4bcf98d5f6b85699dab86f718103a69a4142dbb318b647310c1241f503ff9a.png" />
<img alt="../../../_images/36476db964d0fbc165d2dff9b317aed85204a0ce2b00e24cec83dc79db15dd70.png" src="../../../_images/36476db964d0fbc165d2dff9b317aed85204a0ce2b00e24cec83dc79db15dd70.png" />
<img alt="../../../_images/a3d9e9a275d9acaee78c8d0cac40fa3194021a653de8574dffe9efcd22470d2a.png" src="../../../_images/a3d9e9a275d9acaee78c8d0cac40fa3194021a653de8574dffe9efcd22470d2a.png" />
<img alt="../../../_images/9a793f6d372ceeb815be6c31cb9f1390776d086143d0f995777b92318ccc64b2.png" src="../../../_images/9a793f6d372ceeb815be6c31cb9f1390776d086143d0f995777b92318ccc64b2.png" />
</div>
</div>
</section>
<section id="rerun-tweakreg-to-update-the-header-wcs-a-id-updatehdr-a">
<h3>2.5 Rerun TweakReg to update the header WCS <a id="updatehdr"></a><a class="headerlink" href="#rerun-tweakreg-to-update-the-header-wcs-a-id-updatehdr-a" title="Permalink to this heading">#</a></h3>
<p>Now run that we are happy with the alignment, we run <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> a final time with <code class="docutils literal notranslate"><span class="pre">updatehdr=True</span></code> to update the image header WCS with the improved solution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tweakreg</span><span class="o">.</span><span class="n">TweakReg</span><span class="p">(</span>
    <span class="n">input_files</span><span class="p">,</span>
    <span class="n">imagefindcfg</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;conv_width&quot;</span><span class="p">:</span> <span class="mf">6.0</span><span class="p">,</span> <span class="s2">&quot;dqbits&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
    <span class="n">shiftfile</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">updatehdr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># update the WCS</span>
    <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">ylimit</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
    <span class="n">searchrad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">clear_output</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="combine-the-images-using-astrodrizzle-a-id-adriz-a">
<h2>3. Combine the Images using <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> <a id="adriz"></a><a class="headerlink" href="#combine-the-images-using-astrodrizzle-a-id-adriz-a" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Table of Contents</span></p>
<p>Finally, we combine the aligned FLC files with <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code>. Before starting, we get some recommended values for drizzling from the MDRIZTAB reference file.  The parameters in this file are different for each detector and are based on the number of input frames. These are a good starting point for drizzling and may be adjusted accordingly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The following lines of code find and download the MDRIZTAB reference file.</span>
<span class="n">mdz</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">input_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;MDRIZTAB&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Searching for the MDRIZTAB file:&#39;</span><span class="p">,</span> <span class="n">mdz</span><span class="p">)</span>
<span class="o">!</span>crds<span class="w"> </span>sync<span class="w"> </span>--hst<span class="w"> </span>--files<span class="w"> </span><span class="o">{</span>mdz<span class="o">}</span><span class="w"> </span>--output-dir<span class="w"> </span><span class="o">{</span>os.environ<span class="o">[</span><span class="s1">&#39;jref&#39;</span><span class="o">]}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Searching for the MDRIZTAB file: 37g1550cj_mdz.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CRDS - INFO -  Symbolic context &#39;hst-latest&#39; resolves to &#39;hst_1279.pmap&#39;
CRDS - INFO -  Reorganizing 0 references from &#39;instrument&#39; to &#39;flat&#39;
CRDS - INFO -  Reorganizing from &#39;instrument&#39; to &#39;flat&#39; cache,  removing instrument directories.
CRDS - INFO -  Syncing explicitly listed files.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CRDS - INFO -  Fetching  ./crds_cache/references/hst/acs/37g1550cj_mdz.fits       247.7 K bytes  (1 / 1 files) (0 / 247.7 K bytes)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CRDS - INFO -  0 errors
CRDS - INFO -  0 warnings
CRDS - INFO -  5 infos
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">drizzlepac.processInput</span><span class="w"> </span><span class="kn">import</span> <span class="n">getMdriztabPars</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_vals_from_mdriztab</span><span class="p">(</span>
    <span class="n">input_files</span><span class="p">,</span>
    <span class="n">kw_list</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;driz_sep_bits&quot;</span><span class="p">,</span>
        <span class="s2">&quot;combine_type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;driz_cr_snr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;driz_cr_scale&quot;</span><span class="p">,</span>
        <span class="s2">&quot;final_bits&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get only selected parameters from. the MDRIZTAB&quot;&quot;&quot;</span>
    <span class="n">mdriz_dict</span> <span class="o">=</span> <span class="n">getMdriztabPars</span><span class="p">(</span><span class="n">input_files</span><span class="p">)</span>

    <span class="n">requested_params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Outputting the following parameters:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kw_list</span><span class="p">:</span>
        <span class="n">requested_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdriz_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">mdriz_dict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">requested_params</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">selected_params</span> <span class="o">=</span> <span class="n">get_vals_from_mdriztab</span><span class="p">(</span><span class="n">input_files</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>- MDRIZTAB: AstroDrizzle parameters read from row 3.
Outputting the following parameters:
driz_sep_bits 336
combine_type median
driz_cr_snr 3.5 3.0
driz_cr_scale 1.5 1.2
final_bits 336
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">selected_params</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;driz_sep_bits&#39;: &#39;336&#39;,
 &#39;combine_type&#39;: &#39;median&#39;,
 &#39;driz_cr_snr&#39;: &#39;3.5 3.0&#39;,
 &#39;driz_cr_scale&#39;: &#39;1.5 1.2&#39;,
 &#39;final_bits&#39;: &#39;336&#39;}
</pre></div>
</div>
</div>
</div>
<p>Note that the parameter final_bits= ‘336’ is equivalent to <code class="docutils literal notranslate"><span class="pre">final_bits</span></code>= ‘256, 64, 16’.</p>
<p>The ACS team now corrects for stable hot pixels (DQ flag=16) via the dark reference files, so these pixels can be considered ‘good’. Full well saturated pixels (DQ flag=256) and warm pixels (DQ flag=64) may also be treated as good. More details on the recommended drizzle parameters for ACS may be found in <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2017acs..rept....2H/abstract">ISR 2017-02</a>.</p>
<p>Next we run <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> to remove the sky, flag cosmic rays, and combine the image using the selected parameters.  Note that these may be further refined in the cell below by uncommenting the line in the example shown below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To override any of the above values:</span>
<span class="c1"># selected_params[&#39;driz_cr_snr&#39;]   = &#39;4.0 3.5&#39;</span>

<span class="n">astrodrizzle</span><span class="o">.</span><span class="n">AstroDrizzle</span><span class="p">(</span>
    <span class="n">input_files</span><span class="p">,</span>
    <span class="n">output</span><span class="o">=</span><span class="s2">&quot;f814w&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">selected_params</span><span class="p">,</span>
    <span class="n">preserve</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">clean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">build</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">context</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">skymethod</span><span class="o">=</span><span class="s2">&quot;match&quot;</span><span class="p">,</span>
    <span class="n">runfile</span><span class="o">=</span><span class="s2">&quot;f814w_driz.log&quot;</span>
<span class="p">)</span>
<span class="n">clear_output</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="inspect-the-drizzled-science-and-weight-images-a-id-display-a">
<h2>4. Inspect the drizzled science and weight images  <a id="display"></a><a class="headerlink" href="#inspect-the-drizzled-science-and-weight-images-a-id-display-a" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Table of Contents</span></p>
<p>Finally, we inspect the science and weight images and inspect their data quality.  An imprint of sources in the weight image may indicate an error with the alignment and subsequent cosmic-ray rejection.</p>
<p>For more details on inspecting the drizzled products after reprocessing, see <a class="reference external" href="https://hst-docs.stsci.edu/drizzpac/chapter-7-data-quality-checks-and-trouble-shooting-problems/7-3-inspecting-drizzled-products-after-user-reprocessing">Section 7.3 in the DrizzlePac Handbook</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sci</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="s2">&quot;f814w_drc_sci.fits&quot;</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sci</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greys_r&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/ca4bcf98d5f6b85699dab86f718103a69a4142dbb318b647310c1241f503ff9a.png" src="../../../_images/ca4bcf98d5f6b85699dab86f718103a69a4142dbb318b647310c1241f503ff9a.png" />
<img alt="../../../_images/36476db964d0fbc165d2dff9b317aed85204a0ce2b00e24cec83dc79db15dd70.png" src="../../../_images/36476db964d0fbc165d2dff9b317aed85204a0ce2b00e24cec83dc79db15dd70.png" />
<img alt="../../../_images/a3d9e9a275d9acaee78c8d0cac40fa3194021a653de8574dffe9efcd22470d2a.png" src="../../../_images/a3d9e9a275d9acaee78c8d0cac40fa3194021a653de8574dffe9efcd22470d2a.png" />
<img alt="../../../_images/68fac93a15cef40bcc238f6c3486f2a12e87f118bc15335201d783716816d981.png" src="../../../_images/68fac93a15cef40bcc238f6c3486f2a12e87f118bc15335201d783716816d981.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sci</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="s2">&quot;f814w_drc_wht.fits&quot;</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sci</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greys_r&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/524b27c8ceed26ce4c9c630d87901ef55c647aee0323f6f1ff7552d482febdfd.png" src="../../../_images/524b27c8ceed26ce4c9c630d87901ef55c647aee0323f6f1ff7552d482febdfd.png" />
</div>
</div>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Table of Contents</span></p>
<p>TweakReg may be used to align HST images based on the position of objects in the frame. Point sources are typically used for this purpose, but compact sources such as background galaxies may also be used by increasing the value of the parameter <code class="docutils literal notranslate"><span class="pre">conv_width</span></code> in <code class="docutils literal notranslate"><span class="pre">imagefindpars</span></code>. The data quality arrays of the input calibrated frames may also be used to further improve the fits by telling TweakReg to ignore pixels with specific flags inthe DQ array via the parameter <code class="docutils literal notranslate"><span class="pre">dqbits</span></code> in <code class="docutils literal notranslate"><span class="pre">imagefindpars</span></code>.</p>
</section>
<section id="about-this-notebook">
<h2>About this Notebook<a class="headerlink" href="#about-this-notebook" title="Permalink to this heading">#</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Created: 08 Jan 2019;     J. Mack
Updated: 20 May 2024;     G. Anand, R. Avila, &amp; J. Mack
</pre></div>
</div>
<p><strong>Source:</strong> GitHub <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks">spacetelescope/hst_notebooks</a></p>
<section id="additional-resources-a-id-add-a">
<h3>Additional Resources <a id="add"></a><a class="headerlink" href="#additional-resources-a-id-add-a" title="Permalink to this heading">#</a></h3>
<p>Below are some additional resources that may be helpful. Please send questions through the <a class="reference external" href="https://stsci.service-now.com/hst">HST Help Desk</a>, selecting the DrizzlePac category.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.stsci.edu/hst/instrumentation/acs">ACS Website</a></p></li>
<li><p><a class="reference external" href="https://hst-docs.stsci.edu/acsihb">ACS Instrument Handbook</a></p></li>
<li><p><a class="reference external" href="https://hst-docs.stsci.edu/acsdhb">ACS Data Handbook</a></p></li>
<li><p><a class="reference external" href="https://www.stsci.edu/hst/instrumentation/wfc3">WFC3 Website</a></p></li>
<li><p><a class="reference external" href="https://hst-docs.stsci.edu/wfc3ihb">WFC3 Instrument Handbook</a></p></li>
<li><p><a class="reference external" href="https://hst-docs.stsci.edu/wfc3dhb">WFC3 Data Handbook</a></p></li>
</ul>
</section>
<section id="citations-a-id-cite-a">
<h3>Citations <a id="cite"></a><a class="headerlink" href="#citations-a-id-cite-a" title="Permalink to this heading">#</a></h3>
<p>If you use Python packages such as <code class="docutils literal notranslate"><span class="pre">astropy</span></code>, <code class="docutils literal notranslate"><span class="pre">astroquery</span></code>, <code class="docutils literal notranslate"><span class="pre">drizzlepac</span></code>, <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code>, or <code class="docutils literal notranslate"><span class="pre">numpy</span></code> for published research, please cite the authors. Follow these links for more information about citing various packages.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.astropy.org/acknowledging.html">Citing <code class="docutils literal notranslate"><span class="pre">astropy</span></code></a></p></li>
<li><p><a class="reference external" href="https://github.com/astropy/astroquery/blob/main/astroquery/CITATION">Citing <code class="docutils literal notranslate"><span class="pre">astroquery</span></code></a></p></li>
<li><p><a class="reference external" href="https://zenodo.org/records/3743274">Citing <code class="docutils literal notranslate"><span class="pre">drizzlepac</span></code></a></p></li>
<li><p><a class="reference external" href="https://matplotlib.org/stable/users/project/citing.html">Citing <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code></a></p></li>
<li><p><a class="reference external" href="https://numpy.org/citing-numpy/">Citing <code class="docutils literal notranslate"><span class="pre">numpy</span></code></a></p></li>
</ul>
<hr>
<p><span class="xref myst">Top of Page</span>
<a class="reference internal" href="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png"><img alt="Space Telescope Logo" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="width: 200px;" /></a></p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/hst_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/DrizzlePac/align_sparse_fields"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../align_to_catalogs/align_to_catalogs.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Aligning HST images to an Absolute Reference Catalog</p>
      </div>
    </a>
    <a class="right-next"
       href="../align_multiple_visits/align_multiple_visits.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Optimizing Image Alignment for Multiple HST Visits</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-a-id-intro-a">Introduction <a id="intro"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#download-the-observations-with-astroquery-a-id-download-a">1. Download the Observations with <code class="docutils literal notranslate"><span class="pre">astroquery</span></code> <a id="download"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-image-header-data-a-id-check-keywords-a">1.1 Check image header data <a id="check_keywords"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inspect-the-alignment-a-id-check-wcs-a">1.2 Inspect the Alignment <a id="check_wcs"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#align-with-tweakreg-a-id-tweakreg-a">2. Align with <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> <a id="tweakreg"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-default-parameters-test1-a-id-test1-a">2.1 Use ‘default’ parameters (Test1)  <a id="test1"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adjust-conv-width-to-find-extended-objects-test-2-a-id-test2-a">2.2 Adjust <code class="docutils literal notranslate"><span class="pre">conv_width</span></code> to find extended objects (Test 2) <a id="test2"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exclude-flagged-pixels-with-dqbits-test-3-a-id-test3-a">2.3 Exclude flagged pixels with <code class="docutils literal notranslate"><span class="pre">dqbits</span></code> (Test 3) <a id="test3"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#overplot-matched-sources-on-the-image-a-id-overplot-a">2.4 Overplot Matched Sources on the Image <a id="overplot"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rerun-tweakreg-to-update-the-header-wcs-a-id-updatehdr-a">2.5 Rerun TweakReg to update the header WCS <a id="updatehdr"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#combine-the-images-using-astrodrizzle-a-id-adriz-a">3. Combine the Images using <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> <a id="adriz"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#inspect-the-drizzled-science-and-weight-images-a-id-display-a">4. Inspect the drizzled science and weight images  <a id="display"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-resources-a-id-add-a">Additional Resources <a id="add"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#citations-a-id-cite-a">Citations <a id="cite"></a></a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>