

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>STIS DrizzlePac Tutorial &#8212; HST Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/table.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/STIS/drizpac_notebook/STIS_DrizzlePac_Tutorial';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="STIS Coronagraphy Visualization Tool (v2)" href="../CoronagraphyViz/STIS_Coronagraphy_Visualization_v2.html" />
    <link rel="prev" title="Custom CCD Darks" href="../custom_ccd_darks/custom_ccd_darks.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="HST Notebooks - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="HST Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../index.html">
                    STScI HST Notebook Repository HQ
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">ACS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../ACS/README.html">ACS Notebooks</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_findsat_mrt/acs_findsat_mrt_example.html">Satellite trail detection in ACS/WFC data using acstools.findsat_mrt</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_saturation_trails/acs_saturation_trails.html">ACS Linearity with Saturated Stars</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_cte_forward_model/acs_cte_forward_model_example.html">Pixel-based ACS/WFC CTE Forward Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_subarrays/acs_subarrays.html">ACS Image Reduction for Subarray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_sbc_dark_analysis/acs_sbc_dark_analysis.html">SBC Dark Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_reduction/acs_reduction.html">ACS/WFC Image Reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_pixel_area_maps/acs_pixel_area_maps.html">Obtaining Pixel Area Maps for ACS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_polarization_tools/acs_polarization_tools.html">Using ACS Polarization Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_focus_diverse_epsfs/acs_focus_diverse_epsfs.html">Focus Diverse ePSFs for ACS/WFC</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">COS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../COS/README.html">COS Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../COS/Setup/Setup.html">Setting up your computer environment for working with COS data</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/DataDl/DataDl.html">Downloading COS Data</a></li>




<li class="toctree-l1"><a class="reference internal" href="../../COS/ViewData/ViewData.html">Viewing COS Data</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/AsnFile/AsnFile.html">Modifying or Creating an Association File</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/CalCOS/CalCOS.html">Running the COS Data Pipeline (<code class="docutils literal notranslate"><span class="pre">CalCOS</span></code>)</a></li>






<li class="toctree-l1"><a class="reference internal" href="../../COS/SplitTag/SplitTag.html">Splitting COS Exposures into sub-exposures with <code class="docutils literal notranslate"><span class="pre">splittag</span></code></a></li>







<li class="toctree-l1"><a class="reference internal" href="../../COS/DayNight/DayNight.html">Filtering out COS Data taken during the Day or Night</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../COS/LSF/LSF.html">Working with the COS Line Spread Function (LSF)</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../COS/Extract/Extract.html">Editing the extraction boxes in a spectral extraction file (<code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>)</a></li>







</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">DrizzlePac</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/README.html">DrizzlePac Jupyter Notebook Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/Initialization/Initialization.html">DrizzlePac Initialization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_to_catalogs/align_to_catalogs.html">Aligning HST images to an absolute reference catalog</a></li>



<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_multiple_visits/align_multiple_visits.html">Optimizing Image Alignment for Multiple HST Visits</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_sparse_fields/align_sparse_fields.html">Aligning Deep Exposures of Sparse Fields</a></li>








<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/drizzle_wfpc2/drizzle_wfpc2.html">Drizzling WFPC2 Images to use a Single Zeropoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/mask_satellite/mask_satellite.html">Satellite Trail Masking Techniques</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/optimize_image_sampling/optimize_image_sampling.html">Optimizing the Image Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/sky_matching/sky_matching.html">Sky Matching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/use_ds9_regions_in_tweakreg/use_ds9_regions_in_tweakreg.html">Using DS9 Regions to Include and Exclude Sources in HST Image Alignment with TWEAKREG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/using_updated_astrometry_solutions/using_updated_astrometry_solutions.html">Using updated astrometry solutions</a></li>


</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">HASP</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../HASP/Setup/Setup.html">Installing the Hubble Advanced Spectral Products Script</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../HASP/CoaddTutorial/CoaddTutorial.html">Inputting User Data using the Hubble Advanced Spectral Products Script</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../HASP/FluxScaleTutorial/FluxScaleTutorial.html">Scaling Flux while using the Hubble Advanced Spectral Products Script</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NICMOS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NICMOS/nicmos_unit_conversion/nicmos_unit_conversion.html">Programmatic Replacements for NICMOS Units Conversion Form</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">STIS</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../README.html">STIS-Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cross-correlation/cross-correlation.html">Correcting for Missing Wavecals with Cross-Correlation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../custom_ccd_darks/custom_ccd_darks.html">Custom CCD Darks <a class="tocSkip"></a></a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">STIS DrizzlePac Tutorial <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../CoronagraphyViz/STIS_Coronagraphy_Visualization_v2.html">STIS Coronagraphy Visualization Tool (v2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../calstis/calstis_2d_ccd.html">Calstis 2-D CCD Data Reduction <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../target_acquisition/target_acquisition.html">Evaluating STIS Target Acquisitions <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../view_data/view_data.html">Viewing STIS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extraction/1D_Extraction.html">1D Spectra Extraction <a class="tocSkip"></a></a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">WFC3</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/README.html">WFC3 Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/calwf3_recalibration/calwf3_recal_tvb.html">Manual Recalibration with calwf3: Turning off the IR Linear Ramp Fit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/calwf3_v1.0_cte/calwf3_with_v1.0_PCTE.html">Processing WFC3/UVIS Data with <code class="docutils literal notranslate"><span class="pre">calwf3</span></code> Using the v1.0 CTE-Correction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/exception_report/wfc3_exception_report.html">Exception Report Checklist - WFC3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/image_displayer_analyzer/wfc3_image_displayer_analyzer.html">WFC3 Image Displayer &amp; Analyzer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/ir_ima_visualization/IR_IMA_Visualization_with_an_Example_of_Time_Variable_Background.html">WFC3/IR IMA Visualization Tools with An Example of Time Variable Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/ir_scattered_light_calwf3_corrections/Correcting_for_Scattered_Light_in_IR_Exposures_Using_calwf3_to_Mask_Bad_Reads.html">Correcting for Scattered Light in WFC3/IR Exposures: Using <code class="docutils literal notranslate"><span class="pre">calwf3</span></code> to Mask Bad Reads</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/ir_scattered_light_manual_corrections/Correcting_for_Scattered_Light_in_IR_Exposures_by_Manually_Subtracting_Bad_Reads.html">Correcting for Scattered Light in WFC3/IR Exposures: Manually Subtracting Bad Reads</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/persistence/wfc3_ir_persistence.html">Masking Persistence in WFC3/IR Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/tvb_flattenramp/TVB_flattenramp_notebook.html">Correcting for Helium Line Emission Background in IR Exposures using the “Flatten-Ramp” Technique</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/photometry_examples/phot_examples.html">Synthetic Photometry Examples for WFC3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/uvis_pam_corrections/WFC3_UVIS_Pixel_Area_Map_Corrections_for_Subarrays.html">WFC3/UVIS Pixel Area Map Corrections for Subarrays</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/uvis_time_dependent_photometry/uvis_timedep_phot.html">WFC3/UVIS Time-dependent Photometry</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/spacetelescope/hst_notebooks/blob/main/notebooks/STIS/drizpac_notebook/STIS_DrizzlePac_Tutorial.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/hst_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/hst_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/STIS/drizpac_notebook/STIS_DrizzlePac_Tutorial.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/STIS/drizpac_notebook/STIS_DrizzlePac_Tutorial.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>STIS DrizzlePac Tutorial <a class="tocSkip"></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><a id='top'></a></p>
<section id="stis-drizzlepac-tutorial-a-class-tocskip">
<h1>STIS DrizzlePac Tutorial <a class="tocSkip"><a class="headerlink" href="#stis-drizzlepac-tutorial-a-class-tocskip" title="Permalink to this heading">#</a></h1>
<p><font color="red">This notebook currently fails to execute, use as reference only</font></p>
<h1>Table of Contents<span class="tocSkip"></span></h1>
<div class="toc"><ul class="toc-item"><li><span><a href="#Learning-Goals" data-toc-modified-id="Learning-Goals-1"><span class="toc-item-num">1&nbsp;&nbsp;</span>Learning Goals</a></span></li><li><span><a href="#Introduction" data-toc-modified-id="Introduction-2"><span class="toc-item-num">2&nbsp;&nbsp;</span>Introduction</a></span><ul class="toc-item"><li><span><a href="#STIS-Data-Formats" data-toc-modified-id="STIS-Data-Formats-2.1"><span class="toc-item-num">2.1&nbsp;&nbsp;</span>STIS Data Formats</a></span></li></ul></li><li><span><a href="#Imports" data-toc-modified-id="Imports-3"><span class="toc-item-num">3&nbsp;&nbsp;</span>Imports</a></span></li><li><span><a href="#Set-&amp;-Make-Directories" data-toc-modified-id="Set-&amp;-Make-Directories-4"><span class="toc-item-num">4&nbsp;&nbsp;</span>Set &amp; Make Directories</a></span></li><li><span><a href="#Setting-Up-Reference-File-Directory" data-toc-modified-id="Setting-Up-Reference-File-Directory-5"><span class="toc-item-num">5&nbsp;&nbsp;</span>Setting Up Reference File Directory</a></span></li><li><span><a href="#Downloading-Data" data-toc-modified-id="Downloading-Data-6"><span class="toc-item-num">6&nbsp;&nbsp;</span>Downloading Data</a></span></li><li><span><a href="#Download-Reference-Files" data-toc-modified-id="Download-Reference-Files-7"><span class="toc-item-num">7&nbsp;&nbsp;</span>Download Reference Files</a></span></li><li><span><a href="#CTI-Correct-CCD-Images" data-toc-modified-id="CTI-Correct-CCD-Images-8"><span class="toc-item-num">8&nbsp;&nbsp;</span>CTI Correct CCD Images</a></span></li><li><span><a href="#File-Information" data-toc-modified-id="File-Information-9"><span class="toc-item-num">9&nbsp;&nbsp;</span>File Information</a></span></li><li><span><a href="#Image-Alignment" data-toc-modified-id="Image-Alignment-10"><span class="toc-item-num">10&nbsp;&nbsp;</span>Image Alignment</a></span><ul class="toc-item"><li><span><a href="#Tips-and-Tricks-for-Using-tweakreg" data-toc-modified-id="Tips-and-Tricks-for-Using-tweakreg-10.1"><span class="toc-item-num">10.1&nbsp;&nbsp;</span>Tips and Tricks for Using <a href="https://drizzlepac.readthedocs.io/en/latest/tweakreg.html" rel="nofollow" target="_blank">tweakreg</a></a></span></li><li><span><a href="#Select-Reference-Images" data-toc-modified-id="Select-Reference-Images-10.2"><span class="toc-item-num">10.2&nbsp;&nbsp;</span>Select Reference Images</a></span></li><li><span><a href="#CCD-(CTI-Corrected)-Image-Alignment" data-toc-modified-id="CCD-(CTI-Corrected)-Image-Alignment-10.3"><span class="toc-item-num">10.3&nbsp;&nbsp;</span>CCD (CTI Corrected) Image Alignment</a></span></li><li><span><a href="#NUV-MAMA-Image-Alignment" data-toc-modified-id="NUV-MAMA-Image-Alignment-10.4"><span class="toc-item-num">10.4&nbsp;&nbsp;</span>NUV MAMA Image Alignment</a></span></li><li><span><a href="#FUV-MAMA-Image-Alignment" data-toc-modified-id="FUV-MAMA-Image-Alignment-10.5"><span class="toc-item-num">10.5&nbsp;&nbsp;</span>FUV MAMA Image Alignment</a></span></li><li><span><a href="#Testing-Alignment-Parameters" data-toc-modified-id="Testing-Alignment-Parameters-10.6"><span class="toc-item-num">10.6&nbsp;&nbsp;</span>Testing Alignment Parameters</a></span></li></ul></li><li><span><a href="#Drizzling-Images" data-toc-modified-id="Drizzling-Images-11"><span class="toc-item-num">11&nbsp;&nbsp;</span>Drizzling Images</a></span><ul class="toc-item"><li><span><a href="#CCD-(CTI-Corrected)-Image-Drizzling" data-toc-modified-id="CCD-(CTI-Corrected)-Image-Drizzling-11.1"><span class="toc-item-num">11.1&nbsp;&nbsp;</span>CCD (CTI Corrected) Image Drizzling</a></span></li><li><span><a href="#NUV-MAMA-Image-Drizzling" data-toc-modified-id="NUV-MAMA-Image-Drizzling-11.2"><span class="toc-item-num">11.2&nbsp;&nbsp;</span>NUV MAMA Image Drizzling</a></span></li><li><span><a href="#FUV-MAMA-Image-Drizzling" data-toc-modified-id="FUV-MAMA-Image-Drizzling-11.3"><span class="toc-item-num">11.3&nbsp;&nbsp;</span>FUV MAMA Image Drizzling</a></span></li></ul></li><li><span><a href="#About-this-Notebook" data-toc-modified-id="About-this-Notebook-12"><span class="toc-item-num">12&nbsp;&nbsp;</span>About this Notebook</a></span></li><li><span><a href="#Citations" data-toc-modified-id="Citations-13"><span class="toc-item-num">13&nbsp;&nbsp;</span>Citations</a></span></li></ul></div><hr class="docutils" />
<section id="learning-goals">
<h2>Learning Goals<a class="headerlink" href="#learning-goals" title="Permalink to this heading">#</a></h2>
<p>By the end of this tutorial, you will:</p>
<ul class="simple">
<li><p>Learn how to download STIS data from <a class="reference external" href="https://mast.stsci.edu/portal/Mashup/Clients/Mast/Portal.html">MAST</a> using <a class="reference external" href="https://astroquery.readthedocs.io/en/latest/mast/mast.html"><code class="docutils literal notranslate"><span class="pre">astroquery</span></code></a>.</p></li>
<li><p>CTI correct STIS CCD data with the new pixel-based CTI code <a class="reference external" href="https://pythonhosted.org/stis_cti/"><code class="docutils literal notranslate"><span class="pre">stis_cti</span></code></a> (see <a class="reference external" href="https://www.stsci.edu/hst/instrumentation/stis/data-analysis-and-software-tools/pixel-based-cti">webpage</a> for more details).</p></li>
<li><p>Align images to sub-pixel accuracy for all three STIS detectors (CCD, NUV MAMA, FUV MAMA) using <a class="reference external" href="https://drizzlepac.readthedocs.io/en/latest/tweakreg.html"><code class="docutils literal notranslate"><span class="pre">tweakreg</span></code></a> from <a class="reference external" href="https://drizzlepac.readthedocs.io/en/latest/index.html">DrizzlePac</a>.</p></li>
<li><p>Combine images using <a class="reference external" href="https://drizzlepac.readthedocs.io/en/latest/astrodrizzle.html"><code class="docutils literal notranslate"><span class="pre">astrodrizzle</span></code></a> from <a class="reference external" href="https://drizzlepac.readthedocs.io/en/latest/index.html">DrizzlePac</a>.</p></li>
</ul>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p>The <a class="reference external" href="https://www.stsci.edu/hst/instrumentation/stis">Space Telescope Imaging Spectrograph (STIS)</a> instrument on board the <em>Hubble Space Telescope</em> (HST) has three detectors: a charge-coupled device (CCD) and two multi-anode microchannel array (MAMA) detectors for near- and far-ultraviolet wavelengths (NUV MAMA and FUV MAMA respectively). The CCD detector suffers from charge transfer inefficiency (CTI) which can be corrected for directly on the CCD images using a pixel-based algorithm (<code class="docutils literal notranslate"><span class="pre">stis_cti</span></code>; based on work by <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2010PASP..122.1035A/abstract">Anderson &amp; Bedin 2010</a>, see <a class="reference external" href="https://www.stsci.edu/hst/instrumentation/stis/data-analysis-and-software-tools/pixel-based-cti">webpage</a>).</p>
<p>In order to maximize the science capabilities of images taken with STIS, they can be accurately aligned and combined (or ‘drizzled’). The codes used to do this are from the DrizzlePac package which has been extensively tested on Wide-Field Camera 3 (WFC3) and Advanced Camera for Surveys (ACS) data but was previously unsupported for STIS. This tutorial gives alignment and drizzling examples for STIS images of standard star fields taken for each of its three detectors. We refer users to the <a class="reference external" href="https://www.stsci.edu/scientific-community/software/drizzlepac.html">DrizzlePac Handbook</a> (Gonzaga et al. 2015, Hoffmann et al. 2021) for more details on the drizzling process and DrizzlePac codes.</p>
<section id="stis-data-formats">
<h3>STIS Data Formats<a class="headerlink" href="#stis-data-formats" title="Permalink to this heading">#</a></h3>
<p><strong>CCD data:</strong> For this example, only post-SM4 CCD data taken on primary science amplifier D are used. These are the best calibrated STIS CCD images, the default for science observations, and can be CTI corrected with the new pixel-based code <code class="docutils literal notranslate"><span class="pre">stis_cti</span></code>. For alignment and drizzling, we use STIS CCD images that have been fully calibrated (sx2.fits images: dark- and bias-subtracted, flat-fielded, sky-subtracted, summed individual cosmic-ray (CR) split images with CR-rejection and distortion corrections already applied) that have also been CTI corrected (s2c.fits images).</p>
<p><strong>MAMA data:</strong> MAMA detectors do not require CTI corrections or CR-rejection, and STIS MAMA imaging is typically taken in single exposures (i.e., not CR split). For this example, we only use MAMA data with one science extension (i.e., three extensions total: <code class="docutils literal notranslate"><span class="pre">SCI</span></code>, <code class="docutils literal notranslate"><span class="pre">ERR</span></code>, <code class="docutils literal notranslate"><span class="pre">DQ</span></code>) as is typical for STIS MAMA data. If the MAMA data has more than one science extension (<code class="docutils literal notranslate"><span class="pre">NEXTEND&gt;3</span></code>), the science extensions can be summed and saved as a new fits file with this as the first (and only) science extension. These should also be available as sfl.fits images from MAST where this is relevant. For alignment and drizzling, we use STIS MAMA images that have been fully calibrated (x2d.fits:  dark- and bias-subtracted, flat-fielded, sky-subtracted, distortion corrections already applied).</p>
<p>Typically <code class="docutils literal notranslate"><span class="pre">tweakreg</span></code> and <code class="docutils literal notranslate"><span class="pre">astrodrizzle</span></code> require individual dark- and bias-subtracted, flat-fielded images (flt.fits), as for WFC3 and ACS. For STIS data, a few workarounds are required to ensure these codes can run on the STIS data. Additionally, specific parameters are set to ensure that additional calibrations (e.g, sky subtraction, CR-rejection, distortion corrections) are not applied to the already calibrated STIS data.</p>
<p>See the <a class="reference external" href="https://hst-docs.stsci.edu/stisihb">STIS Instrument Handbook</a> and <a class="reference external" href="https://hst-docs.stsci.edu/stisdhb">STIS Data Handbook</a> (specifically <a class="reference external" href="https://hst-docs.stsci.edu/stisdhb/chapter-2-stis-data-structure/2-2-types-of-stis-files">Section 2.2</a> on file types) for more information.</p>
</section>
</section>
<hr class="docutils" />
<section id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p><em>os</em> for operating system commands</p></li>
<li><p><em>sys</em> to set system preferences</p></li>
<li><p><em>glob</em> for getting file names</p></li>
<li><p><em>shutil</em> for copying files</p></li>
<li><p><em>subprocess</em> for running system commands in the Notebook</p></li>
<li><p><em>numpy</em> to handle array functions</p></li>
<li><p><em>pandas</em> for dataframe storage and manipulation</p></li>
<li><p><em>matplotlib.pyplot</em> for plotting images</p></li>
<li><p><em>tempfile TemporaryDirectory</em> for creating temporary storage directories while downloading and sorting data</p></li>
<li><p><em>astropy.io fits</em> for working with FITS files</p></li>
<li><p><em>astropy.io ascii</em> for working with ascii files</p></li>
<li><p><em>astropy.table Table</em> for creating tidy tables</p></li>
<li><p><em>astropy.visualization ZScaleInterval</em> for scaling images for display</p></li>
<li><p><em>stis_cti</em> for CTI correcting STIS data</p></li>
<li><p><em>drizzlepac</em> for alignment (<em>tweakreg</em>) and image drizzling (<em>astrodrizzle</em>)</p></li>
<li><p><em>astroquery</em> for querying and downloading data from MAST</p></li>
<li><p><em>copy_files</em> custom function (in directory) for creating directories, checking for data and copying files</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load packages</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">TemporaryDirectory</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">ascii</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">ZScaleInterval</span>

<span class="c1"># STScI packages</span>
<span class="kn">from</span> <span class="nn">drizzlepac</span> <span class="kn">import</span> <span class="n">tweakreg</span>
<span class="kn">from</span> <span class="nn">drizzlepac</span> <span class="kn">import</span> <span class="n">astrodrizzle</span> <span class="k">as</span> <span class="n">ad</span>
<span class="kn">from</span> <span class="nn">astroquery.mast</span> <span class="kn">import</span> <span class="n">Observations</span>

<span class="c1"># Custom package, copy_files.py should be in the same directory</span>
<span class="kn">import</span> <span class="nn">copy_files</span> <span class="k">as</span> <span class="nn">cf</span>

<span class="c1"># STIS packages</span>
<span class="kn">from</span> <span class="nn">stis_cti</span> <span class="kn">import</span> <span class="n">stis_cti</span><span class="p">,</span> <span class="n">archive_dark_query</span>
<span class="kn">from</span> <span class="nn">stis_cti</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">stis_cti_version</span>

<span class="c1"># Notebook settings</span>
<span class="kn">from</span> <span class="nn">IPython.core.interactiveshell</span> <span class="kn">import</span> <span class="n">InteractiveShell</span>
<span class="n">InteractiveShell</span><span class="o">.</span><span class="n">ast_node_interactivity</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;stis_cti v</span><span class="si">{</span><span class="n">stis_cti_version</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set plotting defaults</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.aspect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;equal&#39;</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.cmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;inferno&#39;</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.interpolation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="c1"># Setting pandas display options</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.expand_frame_repr&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="mi">3000</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.width&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="c1"># Set numpy array display options</span>
<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="set-make-directories">
<h2>Set &amp; Make Directories<a class="headerlink" href="#set-make-directories" title="Permalink to this heading">#</a></h2>
<p>Set root directory for project (<code class="docutils literal notranslate"><span class="pre">root_dir</span></code>), a reference file directory (<code class="docutils literal notranslate"><span class="pre">ref_dir</span></code>, explained in more detail below but set this path to any existing reference file directories if present), and a cache directory for temporary data storage for downloads (<code class="docutils literal notranslate"><span class="pre">cache_dir</span></code>). The remaining directories will be nested within the root directory and are created below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">check_mkdir</span><span class="p">(</span><span class="n">new_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check for and make directory.</span>
<span class="sd">    </span>
<span class="sd">    Function to check for a directory and make it if it doesn&#39;t exist.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    new_dir : str</span>
<span class="sd">        Path of directory to check for/make.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Check for directory</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_dir</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Directory exists: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_dir</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Make directory</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">new_dir</span><span class="p">,</span> <span class="mo">0o774</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Created directory: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_dir</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the Notebook current working directory to handle relative paths</span>
<span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

<span class="c1"># Set temporary data download store</span>
<span class="n">cache_dir</span> <span class="o">=</span> <span class="s1">&#39;./data_cache&#39;</span>         <span class="c1"># Update this as needed</span>

<span class="c1"># Set the reference file directory</span>
<span class="n">ref_dir</span> <span class="o">=</span> <span class="s1">&#39;./reference_files&#39;</span>      <span class="c1"># Update this if another reference file directory exists</span>

<span class="c1"># Set root and data directories</span>
<span class="n">root_dir</span> <span class="o">=</span> <span class="s1">&#39;./drizpac&#39;</span>              <span class="c1"># Update this as needed</span>
<span class="n">dat_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>
<span class="n">ccd_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dat_dir</span><span class="p">,</span> <span class="s1">&#39;ccd_data&#39;</span><span class="p">)</span>
<span class="n">mama_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dat_dir</span><span class="p">,</span> <span class="s1">&#39;mama_data&#39;</span><span class="p">)</span>

<span class="c1"># Set directories for CTI correction of CCD data</span>
<span class="n">cti_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dat_dir</span><span class="p">,</span> <span class="s1">&#39;ccd_cti&#39;</span><span class="p">)</span>
<span class="n">science</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cti_dir</span><span class="p">,</span> <span class="s1">&#39;science&#39;</span><span class="p">)</span>
<span class="n">darks</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cti_dir</span><span class="p">,</span> <span class="s1">&#39;darks&#39;</span><span class="p">)</span>
<span class="n">ref_cti</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cti_dir</span><span class="p">,</span> <span class="s1">&#39;ref&#39;</span><span class="p">)</span>

<span class="c1"># Set directories for alignment with tweakreg</span>
<span class="n">ccd_twk</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dat_dir</span><span class="p">,</span> <span class="s1">&#39;ccd_twk&#39;</span><span class="p">)</span>
<span class="n">nuv_twk</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dat_dir</span><span class="p">,</span> <span class="s1">&#39;nuv_twk&#39;</span><span class="p">)</span>
<span class="n">fuv_twk</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dat_dir</span><span class="p">,</span> <span class="s1">&#39;fuv_twk&#39;</span><span class="p">)</span>

<span class="c1"># Set directories for drizzling with astrodrizzle</span>
<span class="n">ccd_drz</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dat_dir</span><span class="p">,</span> <span class="s1">&#39;ccd_drz&#39;</span><span class="p">)</span>
<span class="n">nuv_drz</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dat_dir</span><span class="p">,</span> <span class="s1">&#39;nuv_drz&#39;</span><span class="p">)</span>
<span class="n">fuv_drz</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dat_dir</span><span class="p">,</span> <span class="s1">&#39;fuv_drz&#39;</span><span class="p">)</span>

<span class="c1"># Check for directories and make them if they don&#39;t exist</span>
<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">ref_dir</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">,</span> <span class="n">dat_dir</span><span class="p">,</span> <span class="n">ccd_dir</span><span class="p">,</span> <span class="n">mama_dir</span><span class="p">,</span> <span class="n">cti_dir</span><span class="p">,</span> <span class="n">science</span><span class="p">,</span> <span class="n">darks</span><span class="p">,</span> <span class="n">ref_cti</span><span class="p">,</span> <span class="n">ccd_twk</span><span class="p">,</span> <span class="n">fuv_twk</span><span class="p">,</span> <span class="n">nuv_twk</span><span class="p">,</span> <span class="n">ccd_drz</span><span class="p">,</span> <span class="n">fuv_drz</span><span class="p">,</span> <span class="n">nuv_drz</span><span class="p">]:</span>
    <span class="n">check_mkdir</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="setting-up-reference-file-directory">
<h2>Setting Up Reference File Directory<a class="headerlink" href="#setting-up-reference-file-directory" title="Permalink to this heading">#</a></h2>
<p>STScI codes (e.g., <code class="docutils literal notranslate"><span class="pre">stis_cti</span></code>, <code class="docutils literal notranslate"><span class="pre">DrizzlePac</span></code>) need to access reference files to ensure the HST data they run on are properly calibrated. A local store for the reference files is required and a systerm variable should be set for the codes to access those files. The directory variable for STIS data is called “<code class="docutils literal notranslate"><span class="pre">oref</span></code>” by convention.</p>
<p>We create the <code class="docutils literal notranslate"><span class="pre">oref</span></code> environment variable first and populate it with the necessary reference files later in the Notebook. If you already have the required STIS reference files in an existing <code class="docutils literal notranslate"><span class="pre">oref</span></code> directory, set the <code class="docutils literal notranslate"><span class="pre">oref</span></code> environment variable to that directory path.</p>
<p>We can assign a system variable in three different ways, depending on whether we are working from:</p>
<ol class="arabic simple">
<li><p>The command line</p></li>
<li><p>A Python/Jupyter environment</p></li>
<li><p>A Jupyter Notebook</p></li>
</ol>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Unix-style Command Line</p></th>
<th class="head"><p>Python/Jupyter</p></th>
<th class="head"><p>Jupyter Notebook</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>export oref=’./reference_files/references/…’</p></td>
<td><p>os.environ[‘oref’] = ‘./reference_files/references/…’</p></td>
<td><p>%env oref ./reference_files/references/…</p></td>
</tr>
</tbody>
</table>
<p>Note that this system variable must be set again with every new instance of a terminal or Notebook or the <code class="docutils literal notranslate"><span class="pre">export</span></code> command can be added to your <code class="docutils literal notranslate"><span class="pre">.bash_profile</span></code> or equivalent file.</p>
<p>The <a class="reference external" href="https://hst-crds.stsci.edu/">Calibration Reference Data System (CRDS)</a> both stores the reference files and determines the mapping of reference files to observations. The <code class="docutils literal notranslate"><span class="pre">crds</span></code> tool can find, update, and download the best reference files for a particular observation. The <a class="reference external" href="https://hst-crds.stsci.edu/static/users_guide/index.html">documentation for <code class="docutils literal notranslate"><span class="pre">crds</span></code></a> describes many of the more advanced options. In this Notebook we provide a demonstration on how to obtain updated reference file information stored in the FITS headers of observations and download those files to a local reference file directory.</p>
<p>First the following environment variables are needed:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CRDS_SERVER_URL</span></code>: Location of the CRDS server.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CRDS_PATH</span></code>: Path to where reference files will be downloaded.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">oref</span></code>: Path that the reference files will be downloaded to within <code class="docutils literal notranslate"><span class="pre">CRDS_PATH</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set environment variables</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_SERVER_URL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;https://hst-crds.stsci.edu&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">ref_dir</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;oref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">ref_dir</span><span class="p">),</span> <span class="s1">&#39;references&#39;</span><span class="p">,</span> <span class="s1">&#39;hst&#39;</span><span class="p">,</span> <span class="s1">&#39;stis&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span>   <span class="c1"># Trailing slash important</span>
<span class="c1"># print(&#39;oref: {}&#39;.format(os.environ[&#39;oref&#39;]))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="downloading-data">
<h2>Downloading Data<a class="headerlink" href="#downloading-data" title="Permalink to this heading">#</a></h2>
<p>The data used in this example are from STIS monitoring observations of two standard star fields: NGC 5139 for the CCD and NGC 6681 for the MAMAs. We use two programs for each field from 2010 and 2011. The data are taken at the same position angle (PA) with some dithering and in the following filters:</p>
<ul class="simple">
<li><p>CCD: 50CCD</p></li>
<li><p>NUV MAMA: F25SRF2, F25QTZ, F25CN182</p></li>
<li><p>FUV MAMA: F25SRF2, F25QTZ, 25MAMA</p></li>
</ul>
<p>The data are downloaded from <a class="reference external" href="https://mast.stsci.edu/portal/Mashup/Clients/Mast/Portal.html">MAST</a> using <a class="reference external" href="https://astroquery.readthedocs.io/en/latest/mast/mast.html"><code class="docutils literal notranslate"><span class="pre">astroquery</span></code></a>, ~288 MB of data for the CCD and ~437 MB of data for the MAMAs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set proposal IDs (PIDs)</span>
<span class="n">ccd_pids</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11854</span><span class="p">,</span> <span class="mi">12409</span><span class="p">]</span>
<span class="n">mama_pids</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11856</span><span class="p">,</span> <span class="mi">12413</span><span class="p">]</span>    <span class="c1"># Both NUV &amp; FUV MAMA observations taken in a single PID</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check astroquery Observations options</span>
<span class="n">Observations</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;observations&quot;</span><span class="p">)</span>
<span class="n">Observations</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;products&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_oids</span><span class="p">(</span><span class="n">pids</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get observation IDs from proposal IDs.</span>
<span class="sd">    </span>
<span class="sd">    From a list of input proposal IDs (``pids``) get a list of observation IDs </span>
<span class="sd">    (``oids``) using astroquery.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pids : list or array_like of str or int</span>
<span class="sd">        List or array of proposal IDs to find observation IDs for</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    oids : list of str</span>
<span class="sd">        List of observation IDs within the input proposal IDs</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">oids</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># For each PID get obs IDs</span>
    <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span><span class="n">proposal_id</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span>    
        <span class="n">products</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
        <span class="n">oids</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">products</span><span class="p">[</span><span class="s1">&#39;obs_id&#39;</span><span class="p">]))</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> observation IDs found for </span><span class="si">{}</span><span class="s1"> proposal IDs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">oids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">pids</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">oids</span>


<span class="c1"># Get the obs_id values from the PIDs</span>
<span class="n">ccd_oids</span> <span class="o">=</span> <span class="n">get_oids</span><span class="p">(</span><span class="n">ccd_pids</span><span class="p">)</span>
<span class="n">mama_oids</span> <span class="o">=</span> <span class="n">get_oids</span><span class="p">(</span><span class="n">mama_pids</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">download_data</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">product_types</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Downloads MAST data products into a flattened location.</span>
<span class="sd">    </span>
<span class="sd">    Downloads data products (``product_type``) from input observation IDs (``ids``) </span>
<span class="sd">    from MAST and copies them to a single directory (``destination``) from the </span>
<span class="sd">    temporary download directory (``cache_dir``). Similar to stisteam.getdata(). </span>
<span class="sd">    Written by Sean Lockwood.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ids : list of str</span>
<span class="sd">        List of observation IDs to download data products from</span>
<span class="sd">    destination : str</span>
<span class="sd">        Full path to final destination directory for data</span>
<span class="sd">    product_types : list of str, optional</span>
<span class="sd">        Names of product types to download for each observation ID (default is None, </span>
<span class="sd">        means all data products will be downloaded)</span>
<span class="sd">    cache_dir : str, optional</span>
<span class="sd">        Full path to temporary data download storage directory (default </span>
<span class="sd">        ``cache_dir`` as defined above)</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">destination</span><span class="p">),</span> <span class="s1">&#39;Destination must be a directory&#39;</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Downloading &amp; copying data to </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">destination</span><span class="p">))</span>

    <span class="c1"># Get data products for each observation ID</span>
    <span class="n">obs</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span><span class="n">obs_id</span><span class="o">=</span><span class="n">ids</span><span class="p">)</span>    
    <span class="n">products</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">product_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">products</span> <span class="o">=</span> <span class="n">products</span><span class="p">[[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">product_types</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">products</span><span class="p">[</span><span class="s1">&#39;productSubGroupDescription&#39;</span><span class="p">]]]</span>
    
    <span class="c1"># Download data and combine into the destination directory</span>
    <span class="k">with</span> <span class="n">TemporaryDirectory</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;downloads&#39;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">)</span> <span class="k">as</span> <span class="n">d</span><span class="p">:</span>
        <span class="n">dl</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span><span class="n">products</span><span class="p">,</span> <span class="n">mrp_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">download_dir</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">dl</span><span class="p">[</span><span class="s1">&#39;Local Path&#39;</span><span class="p">]:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">destination</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download and combine CCD data (~288 MB)</span>
<span class="n">download_data</span><span class="p">(</span><span class="n">ccd_oids</span><span class="p">,</span> <span class="n">ccd_dir</span><span class="p">,</span> <span class="n">product_types</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;RAW&#39;</span><span class="p">,</span> <span class="s1">&#39;EPC&#39;</span><span class="p">,</span> <span class="s1">&#39;SPT&#39;</span><span class="p">,</span> <span class="s1">&#39;ASN&#39;</span><span class="p">,</span> <span class="s1">&#39;SX2&#39;</span><span class="p">})</span>

<span class="c1"># Download and combine MAMA data (~437 MB)</span>
<span class="n">download_data</span><span class="p">(</span><span class="n">mama_oids</span><span class="p">,</span> <span class="n">mama_dir</span><span class="p">,</span> <span class="n">product_types</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;X2D&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="download-reference-files">
<h2>Download Reference Files<a class="headerlink" href="#download-reference-files" title="Permalink to this heading">#</a></h2>
<p>The reference files for the STIS images are then updated in the image headers and downloaded (~250 MB). While the <code class="docutils literal notranslate"><span class="pre">crds.bestrefs</span></code> tool is also accessible inside of Python, it was designed with a command line interface in mind, therefore it is easiest to use it this way.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find and update the headers with the best reference files and download them</span>
<span class="k">def</span> <span class="nf">download_ref_files</span><span class="p">(</span><span class="n">image_list</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Downloading reference files for:</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image_list</span><span class="p">))</span>
    <span class="n">images</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_list</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;crds bestrefs --files </span><span class="si">{}</span><span class="s1"> --sync-references=1 --update-bestrefs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">images</span><span class="p">),</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">)</span>


<span class="c1"># Check in the Notebook directory</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

<span class="c1"># Get a list of images for the CCD and download reference files</span>
<span class="n">ccd_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ccd_dir</span><span class="p">,</span> <span class="s1">&#39;*_raw.fits&#39;</span><span class="p">))</span>
<span class="n">download_ref_files</span><span class="p">(</span><span class="n">ccd_list</span><span class="p">)</span>

<span class="c1"># Get a list of images for the MAMAs and download reference files</span>
<span class="n">mama_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mama_dir</span><span class="p">,</span> <span class="s1">&#39;*_x2d.fits&#39;</span><span class="p">))</span>
<span class="n">download_ref_files</span><span class="p">(</span><span class="n">mama_list</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="cti-correct-ccd-images">
<h2>CTI Correct CCD Images<a class="headerlink" href="#cti-correct-ccd-images" title="Permalink to this heading">#</a></h2>
<p>A pixel-based CTI correction is applied to the STIS CCD data with <a class="reference external" href="https://pythonhosted.org/stis_cti/"><code class="docutils literal notranslate"><span class="pre">stis_cti</span></code></a>. At present, this code can only be run on post-Servicing Mission 4 (SM4 in 2009) CCD data taken on the default science amplifier D. For all other CCD data, the previous empricial method (<a class="reference external" href="https://stistools.readthedocs.io/en/latest/ctestis.html"><code class="docutils literal notranslate"><span class="pre">stistools.ctestis</span></code></a>) can be used.</p>
<p>First the necessary files are copied over to the CTI correction directory. Then the darks needed to correct the data are determined and downloaded (about ~1.2 GB of data). Then the <code class="docutils literal notranslate"><span class="pre">stis_cti</span></code> code is run, see this <a class="reference external" href="https://pythonhosted.org/stis_cti/stis_cti.html#stis-cti-stis-cti">webpage</a> for a full description of the parameters. The <code class="docutils literal notranslate"><span class="pre">num_processes</span></code> parameter is the maximum number of parallel processes to use when running <code class="docutils literal notranslate"><span class="pre">stis_cti</span></code>, adjust this as needed for your machine.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set file extensions for CCD image data to copy</span>
<span class="n">exts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*_raw.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;*_epc.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;*_spt.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;*_asn.fits&#39;</span><span class="p">]</span>

<span class="c1"># Copy over all CCD files for each extension to the CTI correction directory</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">exts</span><span class="p">:</span>
    <span class="n">cf</span><span class="o">.</span><span class="n">copy_files_check</span><span class="p">(</span><span class="n">ccd_dir</span><span class="p">,</span> <span class="n">science</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ext</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Determine dark exposures required for CCD data and download them (~1.2 GB)</span>
<span class="n">needed_darks</span> <span class="o">=</span> <span class="n">archive_dark_query</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">science</span><span class="p">,</span> <span class="s1">&#39;*_raw.fits&#39;</span><span class="p">)))</span>

<span class="n">dark_exposures</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="k">for</span> <span class="n">anneal</span> <span class="ow">in</span> <span class="n">needed_darks</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">dark</span> <span class="ow">in</span> <span class="n">anneal</span><span class="p">[</span><span class="s1">&#39;darks&#39;</span><span class="p">]:</span>
        <span class="n">dark_exposures</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dark</span><span class="p">[</span><span class="s1">&#39;exposure&#39;</span><span class="p">])</span>

<span class="n">download_data</span><span class="p">(</span><span class="n">dark_exposures</span><span class="p">,</span> <span class="n">darks</span><span class="p">,</span> <span class="n">product_types</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;FLT&#39;</span><span class="p">,</span> <span class="s1">&#39;EPC&#39;</span><span class="p">,</span> <span class="s1">&#39;SPT&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run the CTI code on the CCD data</span>
<span class="n">stis_cti</span><span class="p">(</span>
    <span class="n">science_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">science</span><span class="p">),</span>
    <span class="n">dark_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">darks</span><span class="p">),</span>
    <span class="n">ref_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">ref_cti</span><span class="p">),</span>
    <span class="n">num_processes</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">clean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">,)</span>
</pre></div>
</div>
</div>
</div>
<p>Run checks on and inspect the CCD CTI corrected images.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print information for each file, check those that have been CTI corrected</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">science</span><span class="p">),</span> <span class="s1">&#39;*raw.fits&#39;</span><span class="p">))</span>
<span class="n">files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

<span class="n">psm4</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ampd</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ampo</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
    
    <span class="c1"># Open file header</span>
    <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># Get year obs</span>
    <span class="n">yr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;TDATEOBS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="c1"># Get file info</span>
    <span class="k">if</span> <span class="n">yr</span> <span class="o">&lt;=</span> <span class="mi">2004</span><span class="p">:</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">...PRE-SM4 (</span><span class="si">{}</span><span class="s1">), NOT CTE CORRECTED...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">yr</span><span class="p">))</span>
        <span class="n">psm4</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;raw.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;cte.fits&#39;</span><span class="p">)):</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">***CTE CORRECTED, AMP </span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">)***&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;CCDAMP&#39;</span><span class="p">],</span> <span class="n">yr</span><span class="p">))</span>
        <span class="n">ampd</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">ampo</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">~NON-CTE CORRECTED, AMP </span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">)~&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;CCDAMP&#39;</span><span class="p">],</span> <span class="n">yr</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FILE: </span><span class="si">{}</span><span class="s1">, PID: </span><span class="si">{}</span><span class="s1">, ROOT: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;PROPOSID&#39;</span><span class="p">],</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;ROOTNAME&#39;</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INST: </span><span class="si">{}</span><span class="s1">, DETECTOR: </span><span class="si">{}</span><span class="s1">, AP: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;INSTRUME&#39;</span><span class="p">],</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;DETECTOR&#39;</span><span class="p">],</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;APERTURE&#39;</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DATE OBS:</span><span class="si">{}</span><span class="s1">, PROCESSED: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;TDATEOBS&#39;</span><span class="p">],</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;DATE&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run checks on data</span>
<span class="n">nraw</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">science</span><span class="p">,</span> <span class="s1">&#39;*raw.fits&#39;</span><span class="p">)))</span>
<span class="n">ncte</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">science</span><span class="p">,</span> <span class="s1">&#39;*cte.fits&#39;</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> raw CCD files, </span><span class="si">{}</span><span class="s1"> CTE corrected files&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nraw</span><span class="p">,</span> <span class="n">ncte</span><span class="p">))</span>   <span class="c1"># Should be equal if all data taken on amp D and post-SM4</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> pre-SM4, </span><span class="si">{}</span><span class="s1"> amp D (CTE corr), </span><span class="si">{}</span><span class="s1"> other amp (non-CTE)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">psm4</span><span class="p">,</span> <span class="n">ampd</span><span class="p">,</span> <span class="n">ampo</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display example CCD images</span>
<span class="n">sci_root</span> <span class="o">=</span> <span class="s1">&#39;obat01050&#39;</span>
<span class="n">sx2_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ccd_dir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_sx2.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sci_root</span><span class="p">))</span>   <span class="c1"># CR rejected, distortion corrected</span>
<span class="n">s2c_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">science</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_s2c.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sci_root</span><span class="p">))</span>   <span class="c1"># CR rejected, distortion corrected, CTI corrected</span>

<span class="n">ccd_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">sx2_file</span><span class="p">]</span>
<span class="n">cti_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">s2c_file</span><span class="p">]</span>

<span class="k">for</span> <span class="n">ccdf</span><span class="p">,</span> <span class="n">ctif</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ccd_files</span><span class="p">,</span> <span class="n">cti_files</span><span class="p">):</span>
    
    <span class="c1"># Plot whole image</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

    <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span>
    <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">ccdf</span><span class="p">,</span> <span class="n">ctif</span><span class="p">],</span> <span class="n">axes</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Zoom in near the bottom center</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

    <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span>
    <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">ccdf</span><span class="p">,</span> <span class="n">ctif</span><span class="p">],</span> <span class="n">axes</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> zoom&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)))</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">800</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="file-information">
<h2>File Information<a class="headerlink" href="#file-information" title="Permalink to this heading">#</a></h2>
<p>Information is pulled from file headers and combined into a dataframe. The information is used for file sorting and determining appropriate alignment and drizzle parameters. We select only CCD data taken with primary science amplifier D and MAMA data with only one science extension for this example (see the <strong>Introduction - STIS Data Formats</strong> section for more details).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make dataframe of image properties</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
<span class="n">det_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">science</span><span class="p">,</span> <span class="n">mama_dir</span><span class="p">]</span>
<span class="n">exts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*_s2c.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;*_x2d.fits&#39;</span><span class="p">]</span>

<span class="c1"># Set variable arrays</span>
<span class="n">fnames</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">det_names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">rnames</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">yrs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">tdats</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">dats</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">dets</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">aps</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">nexs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">texps</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">amps</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">gains</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">pas</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">ras</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">decs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">pt1s</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">pt2s</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Loop over folders and file extensions</span>
<span class="k">for</span> <span class="n">det_dir</span><span class="p">,</span> <span class="n">ext</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">det_dirs</span><span class="p">,</span> <span class="n">exts</span><span class="p">):</span>
    
    <span class="c1"># Get list of file names</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">det_dir</span><span class="p">,</span> <span class="n">ext</span><span class="p">))</span>
    <span class="n">files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    
    <span class="c1"># Loop over each file</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="c1"># Open file header</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Get image properties</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">rname</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;ROOTNAME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;PROPOSID&#39;</span><span class="p">]</span>
        <span class="n">yr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;TDATEOBS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">tdat</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;TDATEOBS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;DATE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">det</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;DETECTOR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">nex</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;NEXTEND&#39;</span><span class="p">]</span>
        <span class="n">texp</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;TEXPTIME&#39;</span><span class="p">]</span>
        <span class="n">ap</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;APERTURE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">pa</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;PA_APER&#39;</span><span class="p">]</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;RA_TARG&#39;</span><span class="p">]</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;DEC_TARG&#39;</span><span class="p">]</span>
        <span class="n">pt1</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;POSTARG1&#39;</span><span class="p">]</span>
        <span class="n">pt2</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;POSTARG2&#39;</span><span class="p">]</span>

        <span class="c1"># For CCD data, store different header information</span>
        <span class="k">if</span> <span class="s1">&#39;CCD&#39;</span> <span class="ow">in</span> <span class="n">det</span><span class="p">:</span>
            <span class="n">amp</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;CCDAMP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">gain</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;CCDGAIN&#39;</span><span class="p">]</span>
            
            <span class="c1"># For CCD data, only using amp D data (i.e., the only data that is CTI corrected)</span>
            <span class="k">if</span> <span class="s1">&#39;D&#39;</span> <span class="ow">in</span> <span class="n">amp</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;*_s2c.fits&#39;</span><span class="p">:</span>
                    <span class="n">det_name</span> <span class="o">=</span> <span class="s1">&#39;ccd_cti&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">det_name</span> <span class="o">=</span> <span class="s1">&#39;ccd&#39;</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="c1"># Name excluded CCD files</span>
                <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;*_s2c.fits&#39;</span><span class="p">:</span>
                    <span class="n">det_name</span> <span class="o">=</span> <span class="s1">&#39;xccd_cti&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">det_name</span> <span class="o">=</span> <span class="s1">&#39;xccd&#39;</span>

        <span class="c1"># Store detector name for MAMAs</span>
        <span class="k">elif</span> <span class="s1">&#39;MAMA&#39;</span> <span class="ow">in</span> <span class="n">det</span><span class="p">:</span> 
            
            <span class="c1"># Take only single SCI exposure MAMA files (i.e. 3 extensions, SCI, ERR, DQ)</span>
            <span class="k">if</span> <span class="n">nex</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;FUV-MAMA&#39;</span> <span class="ow">in</span> <span class="n">det</span><span class="p">:</span>
                    <span class="n">det_name</span> <span class="o">=</span> <span class="s1">&#39;fuv_mama&#39;</span>
                <span class="k">elif</span> <span class="s1">&#39;NUV-MAMA&#39;</span> <span class="ow">in</span> <span class="n">det</span><span class="p">:</span>
                    <span class="n">det_name</span> <span class="o">=</span> <span class="s1">&#39;nuv_mama&#39;</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="k">if</span> <span class="s1">&#39;FUV-MAMA&#39;</span> <span class="ow">in</span> <span class="n">det</span><span class="p">:</span>
                    <span class="n">det_name</span> <span class="o">=</span> <span class="s1">&#39;xfuv_mama&#39;</span>
                <span class="k">elif</span> <span class="s1">&#39;NUV-MAMA&#39;</span> <span class="ow">in</span> <span class="n">det</span><span class="p">:</span>
                    <span class="n">det_name</span> <span class="o">=</span> <span class="s1">&#39;xnuv_mama&#39;</span>
            
            <span class="c1"># MAMAs do not have amp or gain info</span>
            <span class="n">amp</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
            <span class="n">gain</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
        
        <span class="c1"># Save file info</span>
        <span class="n">fnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">det_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">det_name</span><span class="p">)</span>
        <span class="n">rnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rname</span><span class="p">)</span>
        <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">yrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span>
        <span class="n">tdats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tdat</span><span class="p">)</span>
        <span class="n">dats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
        <span class="n">dets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>
        <span class="n">aps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ap</span><span class="p">)</span>
        <span class="n">nexs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nex</span><span class="p">)</span>
        <span class="n">texps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">texp</span><span class="p">)</span>
        <span class="n">amps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span>
        <span class="n">gains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gain</span><span class="p">)</span>
        <span class="n">pas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pa</span><span class="p">)</span>
        <span class="n">ras</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
        <span class="n">decs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
        <span class="n">pt1s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">pt2s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt2</span><span class="p">)</span>

<span class="c1"># Create data frame of image properties</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({})</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fnames</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">det_names</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;rootname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rnames</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pids</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;year_obs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yrs</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;date_obs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tdats</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;date_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dats</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;detector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dets</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;aperture&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aps</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;nextend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nexs</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;texptime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">texps</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;amp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">amps</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;gain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gains</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;pa_aper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pas</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ras</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">decs</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;postarg1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pt1s</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;postarg2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pt2s</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;date_obs&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get exposure times to aid with determining alignment parameters</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">CCD-CTI CORRECTED EXP TIMES (</span><span class="si">{}</span><span class="s1"> files)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ccd_cti&#39;</span><span class="p">])))</span>
<span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;texptime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ccd_cti&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">NUV MAMA EXP TIMES (</span><span class="si">{}</span><span class="s1"> files)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;nuv_mama&#39;</span><span class="p">])))</span>
<span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;texptime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;nuv_mama&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">FUV MAMA EXP TIMES (</span><span class="si">{}</span><span class="s1"> files)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fuv_mama&#39;</span><span class="p">])))</span>
<span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;texptime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fuv_mama&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check for directories, make them if they don&#39;t exist, copy files to alignment directories</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
<span class="n">cf</span><span class="o">.</span><span class="n">copy_files_check</span><span class="p">(</span><span class="n">science</span><span class="p">,</span> <span class="n">ccd_twk</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ccd_cti&#39;</span><span class="p">])</span>    <span class="c1"># s2c: Distortion+CR+CTI corrected CCD</span>
<span class="n">cf</span><span class="o">.</span><span class="n">copy_files_check</span><span class="p">(</span><span class="n">mama_dir</span><span class="p">,</span> <span class="n">nuv_twk</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;nuv_mama&#39;</span><span class="p">])</span>  <span class="c1"># x2d: Distortion corrected NUV-MAMA</span>
<span class="n">cf</span><span class="o">.</span><span class="n">copy_files_check</span><span class="p">(</span><span class="n">mama_dir</span><span class="p">,</span> <span class="n">fuv_twk</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fuv_mama&#39;</span><span class="p">])</span>  <span class="c1"># x2d: Distortion corrected FUV-MAMA</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="image-alignment">
<h2>Image Alignment<a class="headerlink" href="#image-alignment" title="Permalink to this heading">#</a></h2>
<p>Use <code class="docutils literal notranslate"><span class="pre">tweakreg</span></code> to align the images from the three STIS detectors to sub-pixel accuracy.</p>
<section id="tips-and-tricks-for-using-tweakreg">
<h3>Tips and Tricks for Using <a class="reference external" href="https://drizzlepac.readthedocs.io/en/latest/tweakreg.html">tweakreg</a><a class="headerlink" href="#tips-and-tricks-for-using-tweakreg" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>For <code class="docutils literal notranslate"><span class="pre">tweakreg</span></code> to work on the already distortion-corrected STIS data, it needs the missing header keyword <code class="docutils literal notranslate"><span class="pre">IDCSCALE</span></code> (‘default’ plate scale for the detector) as done below.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tweakreg</span></code> can align images to better than 0.1 pixel accuracy but it can vary between ~0.05-0.5 pixels depending on the image/number of sources/relative alignment to the reference image etc.</p></li>
<li><p><strong>NOTE:</strong> <code class="docutils literal notranslate"><span class="pre">tweakreg</span></code> changes the image headers after each run, unless <code class="docutils literal notranslate"><span class="pre">updatehdr=False</span></code> is set. Therefore, for testing alignment parameters, always use <code class="docutils literal notranslate"><span class="pre">updatehdr=False</span></code> until happy with the parameters. For the final run, set <code class="docutils literal notranslate"><span class="pre">updatehdr=True</span></code> to update the image headers with their new WCS solution ready for drizzling.</p></li>
<li><p>Select a good quality reference image, e.g., a deeper exposure, roughly centered within the area covered by the other images, no obvious issues/contamination.</p></li>
<li><p>Testing of parameters should, to first order, improve the accuracy of alignment (<code class="docutils literal notranslate"><span class="pre">XRMS/YRMS</span></code> parameters). But don’t rely on this value alone to verify the quality of fit.</p></li>
<li><p>Pixel shifts (<code class="docutils literal notranslate"><span class="pre">XSH/YSH</span></code> parameters) between images can range between 0-30 pixels (maybe up to 50 pixels). Expected shifts can be sanity checked by eye with an image viewer (e.g. DS9). Very large shifts (100s pixels) likely indicate a false solution.</p></li>
<li><p>The number of sources found in images and used for alignment is less important than the quality of the sources used. See the <strong>Testing Alignment Parameters</strong> section below for code to overplot the sources used for alignment on the images.</p></li>
<li><p>Below are common parameters to adjust to align images (<a class="reference external" href="https://drizzlepac.readthedocs.io/en/latest/imagefindpars.html">input image params</a>/<a class="reference external" href="https://drizzlepac.readthedocs.io/en/latest/refimagefindpars.html">reference image params</a>), trial and error is best for honing in on a solution:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">threshold</span></code>: sigma limit above background for source detection.</p>
<ul>
<li><p>Note that sigma is highly image dependent and can vary widely (e.g. from 0.5 to 200 for the same image and get similar results). It is worth exploring a wide parameter space to find an initial solution.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">minobj</span></code>: Minimum number of objects to be matched between images.</p>
<ul>
<li><p>10 is a reasonable lower limit, sometimes lower is needed (e.g. for FUV MAMA with fewer sources) but be warned of going too low and false detections/solutions will be found</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">peakmax</span></code>: Sets a maximum value of sources in the image.</p>
<ul>
<li><p>Useful for selecting bright stars (needed in FUV-MAMA with so few sources) or avoiding saturated stars.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">use_sharp_round=True</span></code>: Select well-defined sources.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">conv_width</span></code>: Convultion kernel width, recommended 2x the PSF FWHM.</p>
<ul>
<li><p>Sometimes for lower quality/blurrier images this has to be increased to find a solution.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">searchrad</span></code>: Search radius for a match (default units arcsec).</p>
<ul>
<li><p>Sometimes you need to increase this by quite a bit to find a solution. Default 1, but you can use up to 10-20 depending on images.</p></li>
</ul>
</li>
</ul>
</li>
<li><p>There are many more parameters to explore but reasonable alignment solutions should be obtainable for most STIS images with some combination of these.</p></li>
<li><p>If you need to re-run <code class="docutils literal notranslate"><span class="pre">tweakreg</span></code> on already tweaked images (ran with <code class="docutils literal notranslate"><span class="pre">updatehdr=True</span></code>), make a fresh directory and copy over clean files again using the cell above (<code class="docutils literal notranslate"><span class="pre">copy_files_check</span></code>).</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add in missing header keyword &#39;IDCSCALE&#39; for tweakreg to work on STIS images</span>

<span class="c1"># Set tweak directories, file extensions and detector names</span>
<span class="n">twk_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ccd_twk</span><span class="p">,</span> <span class="n">nuv_twk</span><span class="p">,</span> <span class="n">fuv_twk</span><span class="p">]</span>
<span class="n">exts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*_s2c.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;*_x2d.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;*_x2d.fits&#39;</span><span class="p">]</span>
<span class="n">dets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CCD&#39;</span><span class="p">,</span> <span class="s1">&#39;NUV MAMA&#39;</span><span class="p">,</span> <span class="s1">&#39;FUV MAMA&#39;</span><span class="p">]</span>

<span class="c1"># Loop over each detector</span>
<span class="k">for</span> <span class="n">twk_dir</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">det</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">twk_dirs</span><span class="p">,</span> <span class="n">exts</span><span class="p">,</span> <span class="n">dets</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">twk_dir</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Updating headers for </span><span class="si">{}</span><span class="s1"> files in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">twk_dir</span><span class="p">))</span>
    
    <span class="c1"># Loop over each file</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">ext</span><span class="p">)):</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">)</span>
        
        <span class="c1"># Set &#39;default&#39; plate scale for the detector</span>
        <span class="k">if</span> <span class="n">det</span> <span class="o">==</span> <span class="s1">&#39;CCD&#39;</span><span class="p">:</span>
            <span class="n">idc</span> <span class="o">=</span> <span class="mf">0.05072</span>
        <span class="k">elif</span> <span class="n">det</span> <span class="o">==</span> <span class="s1">&#39;NUV MAMA&#39;</span><span class="p">:</span>
            <span class="n">idc</span> <span class="o">=</span> <span class="mf">0.0246037</span>
        <span class="k">elif</span> <span class="n">det</span> <span class="o">==</span> <span class="s1">&#39;FUV MAMA&#39;</span><span class="p">:</span>
            <span class="n">idc</span> <span class="o">=</span> <span class="mf">0.024395</span>
        
        <span class="c1"># Create keyword in header and save</span>
        <span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;IDCSCALE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idc</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="select-reference-images">
<h3>Select Reference Images<a class="headerlink" href="#select-reference-images" title="Permalink to this heading">#</a></h3>
<p>Based on the dataframe of image properties in the <strong>File Summary</strong> section, identify an appropriate reference image (<code class="docutils literal notranslate"><span class="pre">ref_img</span></code>) for each detector (see <strong>Tips and Tricks for Using tweakreg</strong> section above). Adjust <code class="docutils literal notranslate"><span class="pre">tweakreg</span></code> parameters per detector to accurately align images onto the reference image. <strong>Set <code class="docutils literal notranslate"><span class="pre">update=False</span></code> for testing and change to <code class="docutils literal notranslate"><span class="pre">update=True</span></code> for final run to update image headers.</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set the reference files for each detector</span>
<span class="n">ccd_ref</span> <span class="o">=</span> <span class="s1">&#39;obat01050_s2c.fits&#39;</span>
<span class="n">nuv_ref</span> <span class="o">=</span> <span class="s1">&#39;obav01v9q_x2d.fits&#39;</span>
<span class="n">fuv_ref</span> <span class="o">=</span> <span class="s1">&#39;obav01w4q_x2d.fits&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set the reference image paths</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
<span class="n">cref</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ccd_twk</span><span class="p">,</span> <span class="n">ccd_ref</span><span class="p">)</span>
<span class="n">nref</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nuv_twk</span><span class="p">,</span> <span class="n">nuv_ref</span><span class="p">)</span>
<span class="n">fref</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fuv_twk</span><span class="p">,</span> <span class="n">fuv_ref</span><span class="p">)</span>

<span class="c1"># Plot reference images</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">23</span><span class="p">)</span>

<span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span>
<span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">cref</span><span class="p">,</span> <span class="n">nref</span><span class="p">,</span> <span class="n">fref</span><span class="p">],</span> <span class="n">axes</span><span class="p">):</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="ccd-cti-corrected-image-alignment">
<h3>CCD (CTI Corrected) Image Alignment<a class="headerlink" href="#ccd-cti-corrected-image-alignment" title="Permalink to this heading">#</a></h3>
<p>Parameters tested for a couple of different exposure times are given below: &lt;=10s and 60s.</p>
<p>Alignment accuracy for these images ranges between ~0.04–0.2 pixels, with average ~0.11 pixels.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># -------------------</span>
<span class="c1"># CCD - CTI CORRECTED</span>
<span class="c1"># -------------------</span>

<span class="c1"># Keep flag as FALSE until happy with parameters</span>
<span class="c1"># Set to TRUE for final run</span>
<span class="n">update</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Move into tweak directory</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">ccd_twk</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ccd_twk</span><span class="p">)</span>

<span class="c1"># Set reference image and extension name</span>
<span class="n">ref_img</span> <span class="o">=</span> <span class="n">ccd_ref</span>
<span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;*_s2c.fits&#39;</span>

<span class="c1"># Set files to align to reference image (remove ref image from list)</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
<span class="n">files</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ref_img</span><span class="p">)</span>
<span class="n">files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Aligning </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> files to </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="n">ext</span><span class="p">,</span> <span class="n">ref_img</span><span class="p">,</span> <span class="n">files</span><span class="p">))</span>

<span class="c1"># Loop over files, get image info, set parameters, align</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    
    <span class="c1"># Get file info</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">+++++++++++++++++++++++++++++++++++++++++++++++++++&#39;</span><span class="p">)</span>
    <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">texp</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;TEXPTIME&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FILE (</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">): </span><span class="si">{}</span><span class="s1">, ROOT: </span><span class="si">{}</span><span class="s1">, TEXP:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="n">f</span><span class="p">,</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;ROOTNAME&#39;</span><span class="p">],</span> <span class="n">texp</span><span class="p">))</span>
    
    <span class="c1"># Set params based on exposure time, print details</span>
    <span class="k">if</span> <span class="n">texp</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">minobj</span><span class="p">,</span> <span class="n">ithresh</span><span class="p">,</span> <span class="n">rthresh</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">convw</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mf">3.5</span>      <span class="c1"># tested for &lt;=10s CCD exposures</span>
    <span class="k">elif</span> <span class="n">texp</span> <span class="o">==</span> <span class="mi">60</span><span class="p">:</span>
        <span class="n">minobj</span><span class="p">,</span> <span class="n">ithresh</span><span class="p">,</span> <span class="n">rthresh</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">convw</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mf">3.5</span>     <span class="c1"># tested for 60s CCD exposures</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MINOBJ: </span><span class="si">{}</span><span class="s1">, THRESH-IMG: </span><span class="si">{}</span><span class="s1">, THRESH-REF: </span><span class="si">{}</span><span class="s1">, PEAKMAX:</span><span class="si">{}</span><span class="s1">, CONVW: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">minobj</span><span class="p">,</span> <span class="n">ithresh</span><span class="p">,</span> <span class="n">rthresh</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">convw</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># Run tweakreg for each file</span>
    <span class="n">tweakreg</span><span class="o">.</span><span class="n">TweakReg</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">updatehdr</span><span class="o">=</span><span class="n">update</span><span class="p">,</span> <span class="n">conv_width</span><span class="o">=</span><span class="n">convw</span><span class="p">,</span> <span class="n">shiftfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">outshifts</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_shifts.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;ROOTNAME&#39;</span><span class="p">]),</span>
                      <span class="n">refimage</span><span class="o">=</span><span class="n">ref_img</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">minobj</span><span class="o">=</span><span class="n">minobj</span><span class="p">,</span> 
                      <span class="n">searchrad</span><span class="o">=</span><span class="mf">15.0</span><span class="p">,</span> <span class="n">imagefindcfg</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">ithresh</span><span class="p">,</span> <span class="s1">&#39;peakmax&#39;</span><span class="p">:</span> <span class="n">peak</span><span class="p">,</span> <span class="s1">&#39;use_sharp_round&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                      <span class="n">refimagefindcfg</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">rthresh</span><span class="p">,</span> <span class="s1">&#39;peakmax&#39;</span><span class="p">:</span> <span class="n">peak</span><span class="p">,</span> <span class="s1">&#39;use_sharp_round&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="nuv-mama-image-alignment">
<h3>NUV MAMA Image Alignment<a class="headerlink" href="#nuv-mama-image-alignment" title="Permalink to this heading">#</a></h3>
<p>Parameters tested for a couple of different exposure times are given below as a guide: 300 to &lt;1000s (used here) and &gt;=1000s. For other 300s images spanning 25 years of STIS data (only two programs used here), adjusting the convolution width (e.g., <code class="docutils literal notranslate"><span class="pre">conv_width=4.5,</span> <span class="pre">5.5,</span> <span class="pre">6.5</span></code>) for specific files enabled an alignment solution to be found. One file (obmi01xqq_x2d.fits in <code class="docutils literal notranslate"><span class="pre">ofiles</span></code>) has an offset from the reference image and required different parameters to find an alignment solution.</p>
<p>Alignment accuracy for these images ranges between ~0.1–0.5 pixels, with average ~0.3 pixels. These values are higher than the CCD partly due to the larger number of sources and that the MAMA data span three filters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># -------------------</span>
<span class="c1"># NUV MAMA</span>
<span class="c1"># -------------------</span>

<span class="c1"># Keep flag as FALSE until happy with parameters</span>
<span class="c1"># Set to TRUE for final run</span>
<span class="n">update</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Move into tweak directory</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">nuv_twk</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">nuv_twk</span><span class="p">)</span>

<span class="c1"># Set reference image and extension name</span>
<span class="n">ref_img</span> <span class="o">=</span> <span class="n">nuv_ref</span>
<span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;*_x2d.fits&#39;</span>

<span class="c1"># Set files to align to reference image (remove ref image from list)</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
<span class="n">files</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ref_img</span><span class="p">)</span>
<span class="n">files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
<span class="n">ofiles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;obmi01xqq_x2d.fits&#39;</span><span class="p">]</span>  <span class="c1"># file requiring different parameters</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Aligning </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> files to </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="n">ext</span><span class="p">,</span> <span class="n">ref_img</span><span class="p">,</span> <span class="n">files</span><span class="p">))</span>

<span class="c1"># Loop over files, get image info, set parameters, align</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    
    <span class="c1"># Get file info</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">++++++++++++++++++++++++++++++++++++++++++++++++++++++&#39;</span><span class="p">)</span>
    <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">texp</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;TEXPTIME&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FILE (</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">): </span><span class="si">{}</span><span class="s1">, ROOT: </span><span class="si">{}</span><span class="s1">, TEXP:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="n">f</span><span class="p">,</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;ROOTNAME&#39;</span><span class="p">],</span> <span class="n">texp</span><span class="p">))</span>
    
    <span class="c1"># Set params based on exposure time, print details</span>
    <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ofiles</span><span class="p">:</span>
        <span class="n">minobj</span><span class="p">,</span> <span class="n">ithresh</span><span class="p">,</span> <span class="n">rthresh</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">convw</span><span class="p">,</span> <span class="n">sr</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mi">20</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">minobj</span><span class="p">,</span> <span class="n">ithresh</span><span class="p">,</span> <span class="n">rthresh</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">convw</span><span class="p">,</span> <span class="n">sr</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">,</span> <span class="mi">20</span>            <span class="c1"># tested for 300 to &lt;1000s NUV MAMA exposures</span>
    <span class="c1"># minobj, ithresh, rthresh, peak, convw, sr = 10, 300, 200, 300, 4.5, 10                # tested for &gt;=1000s NUV MAMA exposures</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MINOBJ: </span><span class="si">{}</span><span class="s1">, THRESH-IMG: </span><span class="si">{}</span><span class="s1">, THRESH-REF: </span><span class="si">{}</span><span class="s1">, PEAKMAX:</span><span class="si">{}</span><span class="s1">, CONVW: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">minobj</span><span class="p">,</span> <span class="n">ithresh</span><span class="p">,</span> <span class="n">rthresh</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">convw</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># Run tweakreg for each file</span>
    <span class="n">tweakreg</span><span class="o">.</span><span class="n">TweakReg</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">updatehdr</span><span class="o">=</span><span class="n">update</span><span class="p">,</span> <span class="n">conv_width</span><span class="o">=</span><span class="n">convw</span><span class="p">,</span> <span class="n">shiftfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">outshifts</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_shifts.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;ROOTNAME&#39;</span><span class="p">]),</span>
                      <span class="n">refimage</span><span class="o">=</span><span class="n">ref_img</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">minobj</span><span class="o">=</span><span class="n">minobj</span><span class="p">,</span> 
                      <span class="n">searchrad</span><span class="o">=</span><span class="n">sr</span><span class="p">,</span> <span class="n">imagefindcfg</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">ithresh</span><span class="p">,</span> <span class="s1">&#39;peakmax&#39;</span><span class="p">:</span> <span class="n">peak</span><span class="p">,</span> <span class="s1">&#39;use_sharp_round&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                      <span class="n">refimagefindcfg</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">rthresh</span><span class="p">,</span> <span class="s1">&#39;peakmax&#39;</span><span class="p">:</span> <span class="n">peak</span><span class="p">,</span> <span class="s1">&#39;use_sharp_round&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fuv-mama-image-alignment">
<h3>FUV MAMA Image Alignment<a class="headerlink" href="#fuv-mama-image-alignment" title="Permalink to this heading">#</a></h3>
<p>Parameters tested for a couple of different exposure times are given below as a guide: 400s to &lt;1000s (used here), and &gt;=1000s. For other images spanning 25 years of STIS data (only two programs shown here), adjusting the convolution width (e.g., <code class="docutils literal notranslate"><span class="pre">conv_width=4.5,</span> <span class="pre">5.5,</span> <span class="pre">6.5</span></code>) for specific files enabled an alignment solution to be found. Two files (obmi01y8q_x2d.fits, obmi01yaq_x2d.fits in <code class="docutils literal notranslate"><span class="pre">ofiles</span></code>) have an offset from the reference image and required different parameters to find an alignment solution.</p>
<p>Alignment accuracy for these images ranges between ~0.1–0.4 pixels, with average ~0.18 pixels. These values are slightly higher than the CCD as the MAMA data span three filters and the FUV MAMA has a broader PSF.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># -------------------</span>
<span class="c1"># FUV MAMA</span>
<span class="c1"># -------------------</span>

<span class="c1"># Keep flag as FALSE until happy with parameters</span>
<span class="c1"># Set to TRUE for final run</span>
<span class="n">update</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Move into tweak directory</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">fuv_twk</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fuv_twk</span><span class="p">)</span>

<span class="c1"># UPDATE: Set reference image and extension names</span>
<span class="n">ref_img</span> <span class="o">=</span> <span class="n">fuv_ref</span>
<span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;*_x2d.fits&#39;</span>

<span class="c1"># Set files to align to reference image (remove ref image from list)</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
<span class="n">files</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ref_img</span><span class="p">)</span>
<span class="n">files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
<span class="n">ofiles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;obmi01y8q_x2d.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;obmi01yaq_x2d.fits&#39;</span><span class="p">]</span>  <span class="c1"># files requiring different parameters</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Aligning </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> files to </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="n">ext</span><span class="p">,</span> <span class="n">ref_img</span><span class="p">,</span> <span class="n">files</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    
    <span class="c1"># Get file info</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">++++++++++++++++++++++++++++++++++++++++++++++++++++++&#39;</span><span class="p">)</span>
    <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">texp</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;TEXPTIME&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FILE (</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">): </span><span class="si">{}</span><span class="s1">, ROOT: </span><span class="si">{}</span><span class="s1">, TEXP:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="n">f</span><span class="p">,</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;ROOTNAME&#39;</span><span class="p">],</span> <span class="n">texp</span><span class="p">))</span>
    
    <span class="c1"># Set params based on exposure time, print details</span>
    <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ofiles</span><span class="p">:</span>
        <span class="n">minobj</span><span class="p">,</span> <span class="n">ithresh</span><span class="p">,</span> <span class="n">rthresh</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">convw</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="mf">5.5</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">minobj</span><span class="p">,</span> <span class="n">ithresh</span><span class="p">,</span> <span class="n">rthresh</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">convw</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="mf">5.5</span>             <span class="c1"># tested for 400s to &lt;1000s exposures</span>
    <span class="c1"># minobj, ithresh, rthresh, peak, convw = 10, 200, 50, 8000, 5.5                 # tested for &gt;=1000s exposures</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MINOBJ: </span><span class="si">{}</span><span class="s1">, THRESH-IMG: </span><span class="si">{}</span><span class="s1">, THRESH-REF: </span><span class="si">{}</span><span class="s1">, PEAKMAX:</span><span class="si">{}</span><span class="s1">, CONVW: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">minobj</span><span class="p">,</span> <span class="n">ithresh</span><span class="p">,</span> <span class="n">rthresh</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">convw</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># Run tweakreg for each file</span>
    <span class="n">tweakreg</span><span class="o">.</span><span class="n">TweakReg</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">updatehdr</span><span class="o">=</span><span class="n">update</span><span class="p">,</span> <span class="n">conv_width</span><span class="o">=</span><span class="n">convw</span><span class="p">,</span> <span class="n">shiftfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">outshifts</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_shifts.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;ROOTNAME&#39;</span><span class="p">]),</span>
                      <span class="n">refimage</span><span class="o">=</span><span class="n">ref_img</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">minobj</span><span class="o">=</span><span class="n">minobj</span><span class="p">,</span> 
                      <span class="n">searchrad</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span> <span class="n">imagefindcfg</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">ithresh</span><span class="p">,</span> <span class="s1">&#39;peakmax&#39;</span><span class="p">:</span> <span class="n">peak</span><span class="p">,</span> <span class="s1">&#39;use_sharp_round&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                      <span class="n">refimagefindcfg</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">rthresh</span><span class="p">,</span> <span class="s1">&#39;peakmax&#39;</span><span class="p">:</span> <span class="n">peak</span><span class="p">,</span> <span class="s1">&#39;use_sharp_round&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="testing-alignment-parameters">
<h3>Testing Alignment Parameters<a class="headerlink" href="#testing-alignment-parameters" title="Permalink to this heading">#</a></h3>
<p>Below is useful code for testing <code class="docutils literal notranslate"><span class="pre">tweakreg</span></code> alignment parameters. If an image has been able to be matched (even if <code class="docutils literal notranslate"><span class="pre">updatehdr=False</span></code>) a <code class="docutils literal notranslate"><span class="pre">&lt;rootname&gt;_shifts.txt</span></code> file will be created. This code can be used to plot the sources used for alignment on the input image. Use this to verify the quality of sources used for alignment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Overplot sources used for alignment (written by Marc Rafelski)</span>

<span class="c1"># Set input directory, reference image and extension names (example for the CCD)</span>
<span class="n">indir</span> <span class="o">=</span> <span class="n">ccd_twk</span>
<span class="n">ref_img</span> <span class="o">=</span> <span class="n">ccd_ref</span>
<span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;*_s2c.fits&#39;</span>

<span class="c1"># Move into tweak directory</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">indir</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">indir</span><span class="p">)</span>

<span class="c1"># Set files to align to reference image (remove ref image from list)</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
<span class="n">files</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ref_img</span><span class="p">)</span>
<span class="n">files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

<span class="c1"># Get rootnames of files</span>
<span class="n">roots</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">roots</span><span class="p">)</span>

<span class="c1"># Loop over rootnames</span>
<span class="k">for</span> <span class="n">root</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">:</span>
    <span class="c1"># Set input file</span>
    <span class="n">infile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_shifts.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>

    <span class="c1"># Read in table from tweakreg</span>
    <span class="n">shift_tab</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii.no_header&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;dx&#39;</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">,</span> <span class="s1">&#39;rot&#39;</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="s1">&#39;xrms&#39;</span><span class="p">,</span> <span class="s1">&#39;yrms&#39;</span><span class="p">])</span>
    <span class="n">formats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.2f&#39;</span><span class="p">,</span> <span class="s1">&#39;.2f&#39;</span><span class="p">,</span> <span class="s1">&#39;.3f&#39;</span><span class="p">,</span> <span class="s1">&#39;.5f&#39;</span><span class="p">,</span> <span class="s1">&#39;.2f&#39;</span><span class="p">,</span> <span class="s1">&#39;.2f&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shift_tab</span><span class="o">.</span><span class="n">colnames</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="n">shift_tab</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">shift_tab</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">max_lines</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Overplot images with their alignment sources</span>
    <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">shift_tab</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image</span><span class="p">)[</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">zscale</span> <span class="o">=</span> <span class="n">ZScaleInterval</span><span class="p">()</span>
        <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">zscale</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">z1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">z2</span><span class="p">)</span>
        <span class="n">match_tab</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">13</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_catalog_fit.match&#39;</span><span class="p">)</span>
        <span class="n">x_cord</span><span class="p">,</span> <span class="n">y_cord</span> <span class="o">=</span> <span class="n">match_tab</span><span class="p">[</span><span class="s1">&#39;col11&#39;</span><span class="p">],</span> <span class="n">match_tab</span><span class="p">[</span><span class="s1">&#39;col12&#39;</span><span class="p">]</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_cord</span><span class="p">,</span> <span class="n">y_cord</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> matched sources (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">match_tab</span><span class="p">),</span> <span class="n">image</span><span class="p">))</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="drizzling-images">
<h2>Drizzling Images<a class="headerlink" href="#drizzling-images" title="Permalink to this heading">#</a></h2>
<p>Next, the images for each detector are combined using <code class="docutils literal notranslate"><span class="pre">astrodrizzle</span></code>. The high-level concept behind drizzling images is described in detail in <a class="reference external" href="https://hst-docs.stsci.edu/drizzpac/files/60245881/109774911/1/1642098151920/DrizzlePac_Handbook_v2.pdf">Section 3.2 of the DrizzlePac Handbook</a>.</p>
<p>Setting the appropriate <code class="docutils literal notranslate"><span class="pre">final_scale</span></code> and <code class="docutils literal notranslate"><span class="pre">final_pixfrac</span></code> parameters for your images takes some thought and testing to avoid gaps in the data. The figure below shows a basic example of the native pixel scale (red squares), shrink factor <code class="docutils literal notranslate"><span class="pre">final_pixfrac</span></code> (blue squares) and output final pixel scale <code class="docutils literal notranslate"><span class="pre">final_scale</span></code> (grid on right) in a drizzle. For more details on the <code class="docutils literal notranslate"><span class="pre">astrodrizzle</span></code> input parameters, see the the <a class="reference external" href="https://drizzlepac.readthedocs.io/en/latest/astrodrizzle.html">DrizzlePac code webpages</a>.
<img alt="Drizzle" src="../../../_images/drizzle.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">astrodrizzle</span></code> can be used to increase the pixel sampling of data if images have dithering and different position angles (PAs). For the STIS data used here, all images are at the same PA and therefore sub-sampling the data is not possible. The example for the STIS data shown below adopts the native pixel scale of each detector as the <code class="docutils literal notranslate"><span class="pre">final_scale</span></code> and no fractional scaling down of each pixel (<code class="docutils literal notranslate"><span class="pre">final_pixfrac=1.0</span></code>) prior to drizzling. Drizzle in this context is a useful tool for creating mosaics of images aligned with <code class="docutils literal notranslate"><span class="pre">tweakreg</span></code>.</p>
<p>To ensure that <code class="docutils literal notranslate"><span class="pre">astrodrizzle</span></code> does not apply additional calibrations to the already calibrated STIS data, Steps 1-6 can be ‘switched off’ using the appropriate keywords (see <a class="reference external" href="https://drizzlepac.readthedocs.io/en/latest/astrodrizzle.html"><code class="docutils literal notranslate"><span class="pre">astrodrizzle</span></code> webpage</a> for keyword information). The CCD data are already CR-rejected and the MAMA data don’t require this step, therefore many of those first steps (and their associated keywords) are to do with appropriately applying CR-rejection. Therefore the ‘minmed’ warning is not important for the STIS images.</p>
<p>Only data in a single filter for each detector are combined in this example: 50CCD (CCD), F25SRF2 (NUV MAMA), 25MAMA (FUV MAMA). STIS data have cleaned edges after the distortion correction is applied in the <code class="docutils literal notranslate"><span class="pre">calstis</span></code> pipeline. These are adaptively cropped out with the <code class="docutils literal notranslate"><span class="pre">crop_edges</span></code> function defined below for each image to avoid gaps in the final mosaics.</p>
<p><code class="docutils literal notranslate"><span class="pre">astrodrizzle</span></code> changes the input image files, so it’s advisable to first copy the data to a clean directory prior to drizzling (as done below). If you need to repeat the drizzling process, it’s good practice to make another clean directory prior to running <code class="docutils literal notranslate"><span class="pre">astrodrizzle</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Copy over aligned images to a drizzle directory (creates direc. and copies files), single filters for MAMAs</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
<span class="n">cf</span><span class="o">.</span><span class="n">copy_files_check</span><span class="p">(</span><span class="n">ccd_twk</span><span class="p">,</span> <span class="n">ccd_drz</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ccd_cti&#39;</span><span class="p">])</span>
<span class="n">cf</span><span class="o">.</span><span class="n">copy_files_check</span><span class="p">(</span><span class="n">nuv_twk</span><span class="p">,</span> <span class="n">nuv_drz</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;nuv_mama&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;aperture&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;F25SRF2&#39;</span><span class="p">)])</span>  <span class="c1"># x2d: Distortion corrected NUV-MAMA</span>
<span class="n">cf</span><span class="o">.</span><span class="n">copy_files_check</span><span class="p">(</span><span class="n">fuv_twk</span><span class="p">,</span> <span class="n">fuv_drz</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fuv_mama&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;aperture&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;25MAMA&#39;</span><span class="p">)])</span>  <span class="c1"># x2d: Distortion corrected FUV-MAMA</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">crop_edges</span><span class="p">(</span><span class="n">dq</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Crop edges of distortion-corrected STIS data.</span>
<span class="sd">    </span>
<span class="sd">    Function to crop edges of a distortion-corrected STIS image using its data</span>
<span class="sd">    quality (DQ) array to avoid gaps in the drizzled mosaics. Function makes cuts </span>
<span class="sd">    at intervals across the array (default fractions of ``cut=0.2``) and determines </span>
<span class="sd">    the first and last instance of &quot;good&quot; data (DQ=0). The good data footprints in </span>
<span class="sd">    DQ arrays are not perfectly square due to distortion corrections, hence multiple </span>
<span class="sd">    cuts are made to find the smallest region of good data in both the x and y </span>
<span class="sd">    directions to avoid partial data rows/columns. Function returns the indices in y </span>
<span class="sd">    (``ymin``, ``ymax``) and x (``xmin``, ``xmax``) to crop the STIS image data with.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dq : ndarray</span>
<span class="sd">        DQ array of image to crop</span>
<span class="sd">    cut : float, optional</span>
<span class="sd">        Value between 0 and 1, fractional step sizes across array (default 0.2 means </span>
<span class="sd">        cuts through data will be at fractions 0.2, 0.4, 0.6, 0.8 of each axis)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ymin : int</span>
<span class="sd">        Lower index of y axis to crop by</span>
<span class="sd">    ymax : int</span>
<span class="sd">        Upper index of y axis to crop by</span>
<span class="sd">    xmin : int</span>
<span class="sd">        Lower index of x axis to crop by</span>
<span class="sd">    xmax : int</span>
<span class="sd">        Upper index of x axis to crop by</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Set storage arrays</span>
    <span class="n">ylos</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">yhis</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">xlos</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">xhis</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Make several cuts through the data</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cut</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]:</span>
        
        <span class="c1"># Find the index of the row/column</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dq</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">i</span><span class="p">)</span>
        
        <span class="c1"># Get start and end indices of the &quot;good&quot; data (DQ=0) in x &amp; y </span>
        <span class="n">ylos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dq</span><span class="p">[:,</span> <span class="n">val</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">yhis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dq</span><span class="p">[:,</span> <span class="n">val</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">xlos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dq</span><span class="p">[</span><span class="n">val</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">xhis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dq</span><span class="p">[</span><span class="n">val</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Get crop indices: smallest region of good data to avoid partial data rows/columns</span>
    <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ylos</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">yhis</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xlos</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xhis</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cropping indices y= </span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">,  x= </span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">))</span>  
    <span class="k">return</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span>
</pre></div>
</div>
</div>
</div>
<section id="ccd-cti-corrected-image-drizzling">
<h3>CCD (CTI Corrected) Image Drizzling<a class="headerlink" href="#ccd-cti-corrected-image-drizzling" title="Permalink to this heading">#</a></h3>
<p>The CCD images are all observed at a common position angle and RA/Dec with small dithers (hence poorer quality edges in the mosaic below). Sub-sampling the images with <code class="docutils literal notranslate"><span class="pre">astrodrizzle</span></code> is not advisable for these programs as reducing the pixel size results in gaps in the data.</p>
<p>Figure shows the CCD drizzle of NGC 5139 (left) and the individual CCD reference image used for alignment (right).
<img alt="CCD Drizzle" src="../../../_images/ccd_drz.png" /></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Drizzling images together</span>
<span class="c1"># Move into drizzle directory</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">ccd_drz</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ccd_drz</span><span class="p">)</span>

<span class="c1"># Set image extension names</span>
<span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;*_s2c.fits&#39;</span>

<span class="c1"># Set files to drizzle</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>

<span class="c1"># Get pixel scales from images and crop data</span>
<span class="n">ps</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    <span class="c1"># Read in HDU list and header</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;update&#39;</span><span class="p">)</span>
    <span class="n">hdr</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span> <span class="o">+</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
    
    <span class="c1"># Get all image pixel scales (can change slightly between headers)</span>
    <span class="n">ps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;PLATESC&#39;</span><span class="p">])</span>
    
    <span class="c1"># Find cropping indices from DQ array</span>
    <span class="n">dq</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">crop_edges</span><span class="p">(</span><span class="n">dq</span><span class="p">)</span>
    
    <span class="c1"># Crop data down in each extension to remove edges with no data (from STIS distortion corrections)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">hdu</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">]</span>
        <span class="n">hdu</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">hdu</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># Update primary header array size information</span>
    <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SIZAXIS1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SIZAXIS2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
    <span class="c1"># Save changes and close</span>
    <span class="n">hdu</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># Set drizzle parameters</span>
<span class="n">fs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ps</span><span class="p">))</span>   <span class="c1"># Final pixel scale (arcsec) of the output image, native pixel scale: ~0.050777</span>
<span class="n">fp</span> <span class="o">=</span> <span class="mf">1.0</span>                    <span class="c1"># Fraction by which to shrink the input pixels prior to drizzling onto output grid</span>

<span class="c1"># Drizzle images together</span>
<span class="n">ad</span><span class="o">.</span><span class="n">AstroDrizzle</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skysub</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">driz_separate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">median</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">blot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                <span class="n">driz_cr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">driz_combine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">build</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">preserve</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                <span class="n">final_scale</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">final_pixfrac</span><span class="o">=</span><span class="n">fp</span><span class="p">,</span> <span class="n">final_wht_type</span><span class="o">=</span><span class="s1">&#39;ERR&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;ccd_drz&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="nuv-mama-image-drizzling">
<h3>NUV MAMA Image Drizzling<a class="headerlink" href="#nuv-mama-image-drizzling" title="Permalink to this heading">#</a></h3>
<p>The NUV images are all observed at a common position angle with large dithers (hence different image depths in the mosaic below). Sub-sampling the images with <code class="docutils literal notranslate"><span class="pre">astrodrizzle</span></code> is not advisable for these programs as reducing the pixel size results in gaps in the data.</p>
<p>Figure shows the NUV drizzle of NGC 6681 (left) and the individual NUV reference image used for alignment (right).</p>
<img alt="NUV Drizzle" src="../../../_images/nuv_drz.png" />
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Drizzling images together</span>
<span class="c1"># Move into drizzle directory</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">nuv_drz</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">nuv_drz</span><span class="p">)</span>

<span class="c1"># Set image extension names</span>
<span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;*_x2d.fits&#39;</span>

<span class="c1"># Set files to drizzle</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>

<span class="c1"># Get pixel scales from images and crop data</span>
<span class="n">ps</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    <span class="c1"># Read in HDU list and header</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;update&#39;</span><span class="p">)</span>
    <span class="n">hdr</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span> <span class="o">+</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
    
    <span class="c1"># Get all image pixel scales (can change slightly between headers)</span>
    <span class="n">ps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;PLATESC&#39;</span><span class="p">])</span>
    
    <span class="c1"># Find cropping indices from DQ array</span>
    <span class="n">dq</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">crop_edges</span><span class="p">(</span><span class="n">dq</span><span class="p">)</span>
    
    <span class="c1"># Crop data down in each extension to remove edges with no data (from STIS distortion corrections)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">hdu</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">]</span>
        <span class="n">hdu</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">hdu</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># Update primary header array size information</span>
    <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SIZAXIS1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SIZAXIS2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
    <span class="c1"># Save changes and close</span>
    <span class="n">hdu</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
<span class="c1"># Set drizzle parameters</span>
<span class="n">fs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ps</span><span class="p">))</span>   <span class="c1"># Final pixel scale (arcsec) of the output image, native pixel scale: ~0.02475</span>
<span class="n">fp</span> <span class="o">=</span> <span class="mf">1.0</span>                    <span class="c1"># Fraction by which to shrink the input pixels prior to drizzling onto output grid</span>

<span class="c1"># Drizzle images together</span>
<span class="n">ad</span><span class="o">.</span><span class="n">AstroDrizzle</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skysub</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">driz_separate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">median</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">blot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                <span class="n">driz_cr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">driz_combine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">build</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">preserve</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                <span class="n">final_scale</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">final_pixfrac</span><span class="o">=</span><span class="n">fp</span><span class="p">,</span> <span class="n">final_wht_type</span><span class="o">=</span><span class="s1">&#39;ERR&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;nuv_drz&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fuv-mama-image-drizzling">
<h3>FUV MAMA Image Drizzling<a class="headerlink" href="#fuv-mama-image-drizzling" title="Permalink to this heading">#</a></h3>
<p>The FUV images are all observed at a common position angle with large dithers (hence different image depths in the mosaic below). Sub-sampling the images with <code class="docutils literal notranslate"><span class="pre">astrodrizzle</span></code> is not advisable for these programs as reducing the pixel size results in gaps in the data.</p>
<p>Figure shows the FUV drizzle of NGC 6681 (left) and the individual FUV reference image used for alignment (right).
<img alt="FUV Drizzle" src="../../../_images/fuv_drz.png" /></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Drizzling images together</span>
<span class="c1"># Move into drizzle directory</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">fuv_drz</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fuv_drz</span><span class="p">)</span>

<span class="c1"># Set image extension names</span>
<span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;*_x2d.fits&#39;</span>

<span class="c1"># Set files to drizzle</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>

<span class="c1"># Get pixel scales from images and crop data</span>
<span class="n">ps</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    <span class="c1"># Read in HDU list and header</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;update&#39;</span><span class="p">)</span>
    <span class="n">hdr</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span> <span class="o">+</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
    
    <span class="c1"># Get all image pixel scales (can change slightly between headers)</span>
    <span class="n">ps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;PLATESC&#39;</span><span class="p">])</span>
    
    <span class="c1"># Find cropping indices from DQ array</span>
    <span class="n">dq</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">crop_edges</span><span class="p">(</span><span class="n">dq</span><span class="p">)</span>
    
    <span class="c1"># Crop data down in each extension to remove edges with no data (from STIS distortion corrections)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">hdu</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">]</span>
        <span class="n">hdu</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">hdu</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># Update primary header array size information</span>
    <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SIZAXIS1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SIZAXIS2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
    <span class="c1"># Save changes and close</span>
    <span class="n">hdu</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># Set drizzle parameters</span>
<span class="n">fs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ps</span><span class="p">))</span>   <span class="c1"># Final pixel scale (arcsec) of the output image, native pixel scale: ~0.024742</span>
<span class="n">fp</span> <span class="o">=</span> <span class="mf">1.0</span>                    <span class="c1"># Fraction by which to shrink the input pixels prior to drizzling onto output grid</span>

<span class="c1"># Drizzle images together</span>
<span class="n">ad</span><span class="o">.</span><span class="n">AstroDrizzle</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skysub</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">driz_separate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">median</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">blot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                <span class="n">driz_cr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">driz_combine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">build</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">preserve</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                <span class="n">final_scale</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">final_pixfrac</span><span class="o">=</span><span class="n">fp</span><span class="p">,</span> <span class="n">final_wht_type</span><span class="o">=</span><span class="s1">&#39;ERR&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;fuv_drz&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="about-this-notebook">
<h2>About this Notebook<a class="headerlink" href="#about-this-notebook" title="Permalink to this heading">#</a></h2>
<p><strong>Author:</strong> Laura Prichard, Staff Scientist II, STIS Team.</p>
<p><strong>Written</strong>: 2022-03-22</p>
<p>For questions on using the DrizzlePac package with STIS data, contact the <a class="reference external" href="https://stsci.service-now.com/hst">HST Help Desk</a> (help&#64;stsci.edu).</p>
</section>
<section id="citations">
<h2>Citations<a class="headerlink" href="#citations" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://www.stsci.edu/files/live/sites/www/files/home/scientific-community/software/drizzlepac/_documents/drizzlepac-handbook.pdf">The DrizzlePac Handbook</a>: Hoffmann, S. L., Mack, J., et al., 2021, “The DrizzlePac Handbook”, Version, (Baltimore: STScI).</p></li>
<li><p><a class="reference external" href="https://hst-docs.stsci.edu/stisihb">STIS Instrument Handbook</a>: Prichard, L., Welty, D. and Jones, A., et al. 2022 “STIS Instrument Handbook,” Version 21.0, (Baltimore: STScI).</p></li>
<li><p><a class="reference external" href="https://hst-docs.stsci.edu/stisdhb">STIS Data Handbook</a>: Sohn, S. T., et al., 2019, “STIS Data Handbook”, Version 7.0, (Baltimore: STScI).</p></li>
<li><p>See <a class="reference external" href="https://www.astropy.org/acknowledging.html">citing <code class="docutils literal notranslate"><span class="pre">astropy</span></code></a></p></li>
</ul>
<hr class="docutils" />
<p><span class="xref myst">Top of Page</span>
<a class="reference internal" href="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png"><img alt="Space Telescope Logo" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="width: 200px;" /></a></p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/hst_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/STIS/drizpac_notebook"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../custom_ccd_darks/custom_ccd_darks.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Custom CCD Darks <a class="tocSkip"></p>
      </div>
    </a>
    <a class="right-next"
       href="../CoronagraphyViz/STIS_Coronagraphy_Visualization_v2.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">STIS Coronagraphy Visualization Tool (v2)</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>