

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>HST WFC3 Point Spread Function Modeling &#8212; HST Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/table.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/WFC3/point_spread_function/hst_point_spread_function';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Downloading WFC3 and WFPC2 PSF Cutouts from MAST" href="../mast_api_psf/download_psf_cutouts.html" />
    <link rel="prev" title="Point Spread Function (PSF)" href="../point_spread_function.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="HST Notebooks - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="HST Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../index.html">
                    STScI HST Notebook Repository HQ
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">ACS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../ACS/README.html">ACS Notebooks</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_findsat_mrt/acs_findsat_mrt_example.html">Satellite trail detection in ACS/WFC data using acstools.findsat_mrt</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_saturation_trails/acs_saturation_trails.html">ACS Linearity with Saturated Stars</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_cte_forward_model/acs_cte_forward_model_example.html">Pixel-based ACS/WFC CTE Forward Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_subarrays/acs_subarrays.html">ACS Image Reduction for Subarray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_sbc_dark_analysis/acs_sbc_dark_analysis.html">SBC Dark Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_reduction/acs_reduction.html">ACS/WFC Image Reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_pixel_area_maps/acs_pixel_area_maps.html">Obtaining Pixel Area Maps for ACS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_polarization_tools/acs_polarization_tools.html">Using ACS Polarization Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_focus_diverse_epsfs/acs_focus_diverse_epsfs.html">Focus Diverse ePSFs for ACS/WFC</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">COS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../COS/README.html">COS Notebooks</a></li>



<li class="toctree-l1"><a class="reference internal" href="../../COS/Setup/Setup.html">Setting up your computer environment for working with COS data</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/DataDl/DataDl.html">Downloading COS Data</a></li>




<li class="toctree-l1"><a class="reference internal" href="../../COS/ViewData/ViewData.html">Viewing COS Data</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/AsnFile/AsnFile.html">Modifying or Creating an Association File</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../COS/CalCOS/CalCOS.html">Running the COS Data Pipeline (<code class="docutils literal notranslate"><span class="pre">CalCOS</span></code>)</a></li>






<li class="toctree-l1"><a class="reference internal" href="../../COS/SplitTag/SplitTag.html">Splitting COS Exposures into sub-exposures with <code class="docutils literal notranslate"><span class="pre">splittag</span></code></a></li>







<li class="toctree-l1"><a class="reference internal" href="../../COS/DayNight/DayNight.html">Filtering out COS Data taken during the Day or Night</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../COS/LSF/LSF.html">Working with the COS Line Spread Function (LSF)</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../COS/Extract/Extract.html">Editing the extraction boxes in a spectral extraction file (<code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>)</a></li>







<li class="toctree-l1"><a class="reference internal" href="../../COS/ExceptionReport/ExceptionReport.html">What to do when you get an Exception Report for COS</a></li>







</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">DrizzlePac</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/README.html">DrizzlePac Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/using_updated_astrometry_solutions/using_updated_astrometry_solutions.html">Improving Astrometry Using Alternate WCS Solutions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_to_catalogs/align_to_catalogs.html">Aligning HST images to an Absolute Reference Catalog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_sparse_fields/align_sparse_fields.html">Aligning Deep Exposures of Sparse Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_multiple_visits/align_multiple_visits.html">Optimizing Image Alignment for Multiple HST Visits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/use_ds9_regions_in_tweakreg/use_ds9_regions_in_tweakreg.html">TWEAKREG Tips - Using DS9 Regions for Source Inclusion/Exclusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/optimize_image_sampling/optimize_image_sampling.html">Optimizing the Image Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_mosaics/align_mosaics.html">Aligning HST Mosaics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/sky_matching/sky_matching.html">Sky Matching for HST Mosaics <a id="top"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/mask_satellite/mask_satellite.html">Satellite Trail Masking Techniques</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">HASP</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../HASP/Setup/Setup.html">Installing the Hubble Advanced Spectral Products Script</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../HASP/CoaddTutorial/CoaddTutorial.html">Inputting User Data using the Hubble Advanced Spectral Products Script</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../HASP/FluxScaleTutorial/FluxScaleTutorial.html">Scaling Flux while using the Hubble Advanced Spectral Products Script</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../HASP/DataDiagnostic/DataDiagnostics.html">HASP Data Diagnostic Notebook</a></li>




<li class="toctree-l1"><a class="reference internal" href="../../HASP/WavelengthAdjustment/WavelengthAdjustment.html">Wavelength Adjustments for Running the Hubble Advanced Spectral Products (HASP) Script</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NICMOS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NICMOS/nicmos_unit_conversion/nicmos_unit_conversion.html">Programmatic Replacements for NICMOS Units Conversion Form</a></li>


</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">STIS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../STIS/README.html">STIS-Notebooks</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../STIS/cross-correlation/cross-correlation.html">Correcting for Missing Wavecals with Cross-Correlation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/custom_ccd_darks/custom_ccd_darks.html">Custom CCD Darks <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/drizpac_notebook/STIS_DrizzlePac_Tutorial.html">STIS DrizzlePac Tutorial <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/CoronagraphyViz/STIS_Coronagraphy_Visualization_v2.html">STIS Coronagraphy Visualization Tool (v2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/calstis/calstis_2d_ccd.html">Calstis 2-D CCD Data Reduction <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/target_acquisition/target_acquisition.html">Evaluating STIS Target Acquisitions <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/view_data/view_data.html">Viewing STIS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/extraction/1D_Extraction.html">1D Spectra Extraction <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/low_count_uncertainties/Low_Count_Uncertainties.html">Low Count Uncertainties in STIS <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/contrast_sensitivity/STIS_Coronagraphic_Observation_Feasibility.html">STIS Coronagraphic Observation Feasibility</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">WFC3</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../README.html">WFC3 Notebooks</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../general_tools.html">General Tools</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../image_displayer_analyzer/wfc3_image_displayer_analyzer.html">WFC3 Image Displayer &amp; Analyzer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../exception_report/wfc3_exception_report.html">Exception Report Checklist - WFC3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../calwf3_v1.0_cte/calwf3_with_v1.0_PCTE.html">Processing WFC3/UVIS Data with <code class="docutils literal notranslate"><span class="pre">calwf3</span></code> Using the v1.0 CTE-Correction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../persistence/wfc3_ir_persistence.html">Masking Persistence in WFC3/IR Images</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ir_tvb.html">WFC3/IR Time Variable Background (TVB)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../ir_ima_visualization/IR_IMA_Visualization_with_an_Example_of_Time_Variable_Background.html">WFC3/IR IMA Visualization Tools with An Example of Time Variable Background</a></li>
<li class="toctree-l2"><a class="reference internal" href="../calwf3_recalibration/calwf3_recal_tvb.html">Manual Recalibration with calwf3: Turning off the IR Linear Ramp Fit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tvb_flattenramp/TVB_flattenramp_notebook.html">Correcting for Helium Line Emission Background in IR Exposures using the “Flatten-Ramp” Technique</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ir_scattered_light_calwf3_corrections/Correcting_for_Scattered_Light_in_IR_Exposures_Using_calwf3_to_Mask_Bad_Reads.html">Correcting for Scattered Light in WFC3/IR Exposures: Using <code class="docutils literal notranslate"><span class="pre">calwf3</span></code> to Mask Bad Reads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ir_scattered_light_manual_corrections/Correcting_for_Scattered_Light_in_IR_Exposures_by_Manually_Subtracting_Bad_Reads.html">Correcting for Scattered Light in WFC3/IR Exposures: Manually Subtracting Bad Reads</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../photometry.html">Photometry</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../filter_transformations/filter_transformations.html">WFC3/UVIS Filter Transformations with stsynphot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../flux_conversion_tool/flux_conversion_tool.html">Flux Unit Conversions with synphot and stsynphot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../photometry_examples/phot_examples.html">Synthetic Photometry Examples for WFC3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../uvis_time_dependent_photometry/uvis_timedep_phot.html">WFC3/UVIS Time-dependent Photometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../zeropoints/zeropoints.html">Calculating WFC3 Zeropoints with STSynphot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../uvis_pam_corrections/WFC3_UVIS_Pixel_Area_Map_Corrections_for_Subarrays.html">WFC3/UVIS Pixel Area Map Corrections for Subarrays</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../point_spread_function.html">Point Spread Function (PSF)</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">HST WFC3 Point Spread Function Modeling   </a></li>
<li class="toctree-l2"><a class="reference internal" href="../mast_api_psf/download_psf_cutouts.html">Downloading WFC3 and WFPC2 PSF Cutouts from MAST</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/spacetelescope/hst_notebooks/blob/main/notebooks/WFC3/point_spread_function/hst_point_spread_function.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/hst_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/hst_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/WFC3/point_spread_function/hst_point_spread_function.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/WFC3/point_spread_function/hst_point_spread_function.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>HST WFC3 Point Spread Function Modeling   </h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">1. Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#environment-setup">1.1 Environment Setup</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#import-packages">1.2 Import Packages</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#download-data">1.3 Download Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#aperture-photometry">1.4 Aperture Photometry</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exposure-psf-models">2. Exposure PSF Models</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#analytical-psf-models">2.1 Analytical PSF Models</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#empirical-psf-models">2.2 Empirical PSF Models</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#default-models">2.2.1 Default Models</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#focus-perturbation">2.2.2 Focus Perturbation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-perturbation">2.2.3 Spatial Perturbation</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stacked-psf-models">2.3 Stacked PSF Models</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#stellar-stacks">2.3.1 Stellar Stacks</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#mast-stacks">2.3.2 MAST Stacks</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#drizzle-psf-models">3. Drizzle PSF Models</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-drizzle">3.1 Create Drizzle</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stack-stars">3.2 Stack Stars</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusions">Conclusions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-resources">Additional Resources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#software-citations">Software Citations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#version-history">Version History</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><a id="top"></a></p>
<section class="tex2jax_ignore mathjax_ignore" id="hst-wfc3-point-spread-function-modeling-space-telescope-logo">
<h1>HST WFC3 Point Spread Function Modeling   <a class="reference internal" href="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png"><img alt="Space Telescope Logo" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="width: 200px;" /></a><a class="headerlink" href="#hst-wfc3-point-spread-function-modeling-space-telescope-logo" title="Permalink to this heading">#</a></h1>
<hr class="docutils" />
<p><a id="learning"></a></p>
<section id="learning-goals">
<h2>Learning Goals<a class="headerlink" href="#learning-goals" title="Permalink to this heading">#</a></h2>
<p>This notebook demonstrates how to create Point Spread Function (PSF) models for HST <a class="reference external" href="https://www.stsci.edu/hst/instrumentation/wfc3">Wide Field Camera 3 (WFC3)</a> observations.</p>
<p>The tutorial will allow users to complete the following tasks:</p>
<ul class="simple">
<li><p>Perform simple aperture photometry on science images for comparison with PSF photometry.</p></li>
<li><p>Retrieve or create a PSF model for WFC3 single exposures (FLCs) and drizzled (DRZs) images.</p></li>
<li><p>Complete basic science workflows including PSF photometry, subtraction, and decomposition.</p></li>
</ul>
<p><a id="toc"></a></p>
</section>
<section id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Permalink to this heading">#</a></h2>
<p><strong> <span class="xref myst">Learning Goals</span></strong> <br>
<strong> <span class="xref myst">1. Introduction</span></strong> <br>
<strong>     <span class="xref myst">1.1 Environment Setup</span></strong> <br>
<strong>     <span class="xref myst">1.2 Import Packages</span></strong> <br>
<strong>     <span class="xref myst">1.3 Download Data</span></strong> <br>
<strong>     <span class="xref myst">1.4 Aperture Photometry</span></strong> <br>
<strong> <span class="xref myst">2. Exposure PSF Models</span></strong> <br>
<strong>     <span class="xref myst">2.1 Analytical PSF Models</span></strong> <br>
<strong>     <span class="xref myst">2.2 Empirical PSF Models</span></strong> <br>
<strong>         <span class="xref myst">2.2.1 Default Models</span></strong> <br>
<strong>         <span class="xref myst">2.2.2 Focus Perturbation</span></strong> <br>
<strong>         <span class="xref myst">2.2.3 Spatial Perturbation</span></strong> <br>
<strong>     <span class="xref myst">2.3 Stacked PSF Models</span></strong> <br>
<strong>         <span class="xref myst">2.3.1 Stellar Stacks</span></strong> <br>
<strong>         <span class="xref myst">2.3.2 MAST Stacks</span></strong> <br>
<strong> <span class="xref myst">3. Drizzle PSF Models</span></strong> <br>
<strong>     <span class="xref myst">3.1 Create Drizzle</span></strong> <br>
<strong>     <span class="xref myst">3.2 Stack Stars</span></strong> <br>
<strong> <span class="xref myst">Conclusions</span></strong> <br>
<strong> <span class="xref myst">About this Notebook</span></strong> <br>
<strong>     <span class="xref myst">Additional Resources</span></strong> <br>
<strong>     <span class="xref myst">Software Citations</span></strong> <br></p>
<p><strong>Acronyms:</strong></p>
<ul class="simple">
<li><p>Point Spread Function (PSF)</p></li>
<li><p>Hubble Space Telescope (HST)</p></li>
<li><p>Wide Field Camera 3 (WFC3)</p></li>
<li><p>WFC3 InfraRed detector (IR)</p></li>
<li><p>WFC3 Ultraviolet and VISable detector (UVIS)</p></li>
<li><p>Advanced Camera for Surveys (ACS)</p></li>
<li><p>Wide Field and Planetary Camera 2 (WFPC2)</p></li>
<li><p>Mikulski Archive for Space Telescopes (MAST)</p></li>
<li><p>Flexible Image Transport System (FITS)</p></li>
<li><p>Instrument Science Report (ISR)</p></li>
<li><p>Full Width at Half Maximum (FWHM)</p></li>
<li><p>Signal-to-Noise (S/N)</p></li>
</ul>
<p><a id="introduction"></a></p>
</section>
<section id="introduction">
<h2>1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Table of Contents</span></p>
<hr class="docutils" />
<p><strong>What is the Point Spread Function and why do we want to model it?</strong></p>
<p>The purpose of a telescope is to collect, magnify, and record the intensity of light from astronomical sources. A telescope’s ability to resolve the size of objects is limited by its spatial resolution, which is determined by its aperture and the wavelength of light being observed, such that every telescope is fundamentally limited by the diffraction nature of light. The minimum size of an image that the light can be focused onto is known as the Airy disk. In addition, the shape of the image will be altered by any optical aberrations in the telescope’s system of mirrors, lenses, filters, and camera detectors. When observing unresolved point sources such as stars, these factors determine the size and shape of the focused image. This distribution of light as a function of position on the telescopes detectors is known as the Point Spread Function (PSF). More simply, the PSF describes how the light from an unresolved source is distributed across multiple pixels when it is recorded by the telescope’s camera.</p>
<p>While a well-focused telescope produces a very small image of point sources, the shape will be distorted and the light is effectively scattered to an infinite radius. Therefore, a model of the PSF is required to accurately measure astrometry (positions) and photometry (brightnesses) of objects in astronomical images. In the case of the HST WFC3 this is especially important because the images are undersampled, which means the telescope is capable of delivering higher resolution than the detector pixels can record. The PSF will vary depending on the telescopes focus, and also significantly with location on the WFC3 detector due to optical distortions in the light path that are designed to minimize light loss by reducing the number of optical reflections. For these reasons, the WFC3 team has produced a library of PSF models and tools for users on the <a class="reference external" href="https://www.stsci.edu/hst/instrumentation/wfc3/data-analysis/psf">WFC3 PSF webpage</a>.</p>
<p>Finally, astrometric and photometric measurements can generally be made either from individual calibrated exposures known as <a class="reference external" href="https://hst-docs.stsci.edu/wfc3dhb/chapter-2-wfc3-data-structure/2-1-types-of-wfc3-files">FLTs and FLCs</a> for WFC3, or exposures that are combined into a mosaic through drizzling. In theory, modeling individual exposures is always preferable because these images are on the telescope’s intrinsic pixel grid without any modification. However, this requires bright unresolved sources that have been observed with a relatively short exposure time, so that images are not strongly affected by cosmic rays. In addition, many astronomical sources are very faint, requiring a combination of multiple dithered exposures to obtain sufficient signal-to-noise (S/N) for analysis. For these reasons, we will demonstrate techniques for constructing PSF models for both individual calibrated exposures and drizzled mosaics.</p>
<p>Users looking for a fundamental introduction to <a class="reference external" href="https://boyce-astro.org/aperture-photometry/">aperture photometry</a> and <a class="reference external" href="https://boyce-astro.org/point-spread-function-psf/">PSF photometry</a> may find this excellent series of <a class="reference external" href="https://boyce-astro.org/videos/photometry/">video tutorials</a> by Boyce-Astro helpful, as well as this description of the <a class="reference external" href="https://www.edmundoptics.com/knowledge-center/application-notes/imaging/limitations-on-resolution-and-contrast-the-airy-disk/">Airy Disk</a> by Edmund Optics. In addition, detailed information on WFC3 can be found on the <a class="reference external" href="https://www.stsci.edu/hst/instrumentation/wfc3">WFC3 Website</a>, <a class="reference external" href="https://www.stsci.edu/hst/instrumentation/wfc3/data-analysis/psf">WFC3 PSF Webpage</a>, <a class="reference external" href="https://hst-docs.stsci.edu/wfc3ihb">WFC3 Instrument Handbook</a>, and <a class="reference external" href="https://hst-docs.stsci.edu/wfc3dhb">WFC3 Data Handbook</a>. In addition, the publication by <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2000PASP..112.1360A/abstract">Anderson &amp; King 2000</a> provides information about the effects of undersampling on the HST PSF. Finally, we note that the flux measured for each source will depend on the radial extent of the PSF model. Specifically, models truncated at a given radius will encompass a fraction of the total electrons from each star, which can be accounted for by using an encircled energy ratio correction. See <a class="reference external" href="https://hst-docs.stsci.edu/wfc3dhb/chapter-9-wfc3-data-analysis/9-1-photometry#id-9.1Photometry-9.1.89.1.8ApertureCorrections">Section 9.1.8</a> of the WFC3 Data Handbook, <a class="reference external" href="https://www.stsci.edu/files/live/sites/www/files/home/hst/instrumentation/wfc3/documentation/instrument-science-reports-isrs/_documents/2022/WFC3-ISR-2022-02.pdf">WFC3 ISR 2022-02</a>, and the WFC3 <a class="reference external" href="https://www.stsci.edu/hst/instrumentation/wfc3/data-analysis/photometric-calibration/uvis-encircled-energy">UVIS</a> and <a class="reference external" href="https://www.stsci.edu/hst/instrumentation/wfc3/data-analysis/photometric-calibration/ir-encircled-energy">IR</a> encircled energy webpages for more information.</p>
<p>We hope this notebook provides valuable information and examples for constructing HST WFC3 PSF models. While the focus in this notebook is for the WFC3 instrument, the majority of the code also applies to HST Advanced Camera for Surveys (ACS) observations, as well as archival Wide Field and Planetary Camera 2 (WFPC2) observations. See <a class="reference external" href="https://www.stsci.edu/files/live/sites/www/files/home/hst/instrumentation/acs/documentation/instrument-science-reports-isrs/_documents/isr0601.pdf">ACS ISR 2006-01</a> and <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/blob/main/notebooks/ACS/acs_focus_diverse_epsfs/acs_focus_diverse_epsfs.ipynb">acs_focus_diverse_epsfs.ipynb</a> for more information on the ACS PSF models. Finally, users may find several helpful resources on the <a class="reference external" href="https://www.stsci.edu/hst/instrumentation/wfc3/software-tools">WFC3 Software webpage</a>.</p>
<p><a id="environment"></a></p>
<section id="environment-setup">
<h3>1.1 Environment Setup<a class="headerlink" href="#environment-setup" title="Permalink to this heading">#</a></h3>
<p><span class="xref myst">Table of Contents</span></p>
<hr class="docutils" />
<p>This Jupyter Notebook requires users to install the packages listed in the <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> file located in the main notebook directory. Installing the <code class="docutils literal notranslate"><span class="pre">stenv</span></code> Python environment maintained by STScI will often fulfill most of these requirements. Please see the <code class="docutils literal notranslate"><span class="pre">stenv</span></code> <a class="reference external" href="https://stenv.readthedocs.io/en/latest/getting_started.html">readthedocs</a> for more information. In this workflow, we will install the required packages using the <code class="docutils literal notranslate"><span class="pre">conda</span></code> package manager. To check whether you have <code class="docutils literal notranslate"><span class="pre">conda</span></code> installed, open a terminal window and type <code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">-V</span></code>, <code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">--version</span></code>, or run the next cell. If your <code class="docutils literal notranslate"><span class="pre">conda</span></code> is installed and working, the terminal or cell will return the current version of <code class="docutils literal notranslate"><span class="pre">conda</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>conda<span class="w"> </span>-V
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>conda 25.7.0
</pre></div>
</div>
</div>
</div>
<p>If you receive a message that the command is unknown or not found, you must install <code class="docutils literal notranslate"><span class="pre">conda</span></code>. We recommend installing either the <a class="reference external" href="https://www.anaconda.com/docs/getting-started/anaconda/install">Anaconda</a> or <a class="reference external" href="https://www.anaconda.com/docs/getting-started/miniconda/main">Minicoda</a> distributions. See <a class="reference external" href="https://stenv.readthedocs.io/en/latest/getting_started.html#getting-started">this page</a> for additional instructions. You can create the required <code class="docutils literal notranslate"><span class="pre">conda</span></code> environment by first opening your terminal application, likely <code class="docutils literal notranslate"><span class="pre">Terminal</span></code> or <code class="docutils literal notranslate"><span class="pre">iTerm</span></code> on a Mac, or <code class="docutils literal notranslate"><span class="pre">Windows</span> <span class="pre">Terminal</span></code> or <code class="docutils literal notranslate"><span class="pre">Powershell</span></code> on Windows. Next, add the <code class="docutils literal notranslate"><span class="pre">conda-forge</span></code> channel to <code class="docutils literal notranslate"><span class="pre">conda</span></code>’s channel list, which allows <code class="docutils literal notranslate"><span class="pre">conda</span></code> to find the packages that we want to install.</p>
<p><code class="docutils literal notranslate"> <span class="pre">$</span> <span class="pre">conda</span> <span class="pre">config</span> <span class="pre">--add</span> <span class="pre">channels</span> <span class="pre">conda-forge</span></code></p>
<p>Now we can create the new environment. We’ll call it <code class="docutils literal notranslate"><span class="pre">psf_analysis</span></code>, and initialize it with <code class="docutils literal notranslate"><span class="pre">Python</span></code> version <code class="docutils literal notranslate"><span class="pre">3.12</span></code>.</p>
<!-- Substitute for working astroconda - This will revert to using astroconda once the astroconda software is updated  -->
<p><code class="docutils literal notranslate"> <span class="pre">$</span> <span class="pre">conda</span> <span class="pre">create</span> <span class="pre">-n</span> <span class="pre">psf_analysis</span> <span class="pre">python=3.12</span></code></p>
<p>Allow <code class="docutils literal notranslate"><span class="pre">conda</span></code> to install some necessary packages (when prompted, type <code class="docutils literal notranslate"><span class="pre">y</span></code> then enter/return). Then, <code class="docutils literal notranslate"><span class="pre">conda</span></code> will need a few minutes (depending on the internet speed) to complete the installation. After the installation finishes, you can see all of your environments with <code class="docutils literal notranslate"> <span class="pre">$</span> <span class="pre">conda</span> <span class="pre">env</span> <span class="pre">list</span></code>. Now, activate your new environment with:</p>
<p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">conda</span> <span class="pre">activate</span> <span class="pre">psf_analysis</span></code></p>
<p>Note that you will need to activate the environment every time you open a new terminal or shell using <code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">activate</span> <span class="pre">psf_analysis</span></code> before starting a Jupyter Notebook kernel in that terminal. Finally, install packages from the <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> file using <code class="docutils literal notranslate"><span class="pre">conda</span></code> or <code class="docutils literal notranslate"><span class="pre">pip</span></code>:</p>
<p><code class="docutils literal notranslate"> <span class="pre">$</span> <span class="pre">pip</span> <span class="pre">install</span> <span class="pre">-r</span> <span class="pre">requirements.txt</span></code></p>
<div class="alert alert-block alert-info"><b>NOTE:</b> The following non-Python tools are needed to run some advanced features of the Jupyter Notebook. Specifically, a FORTRAN compiler and the hst1pass code are only required for PSF perturbation with individual exposures (FLCs). These tools are not required for stacking stars or creating PSF models for drizzled images (DRZs). <b>The code will automatically compile hst1pass. If this step encounters errors, then manual instructions for installing FORTRAN and hst1pass are included below:</b> </div>
<ul class="simple">
<li><p><a class="reference external" href="https://www.stsci.edu/~jayander/HST1PASS/"><strong>hst1pass</strong></a> - FORTRAN code for performing photometry and PSF perturbation as documented in <a class="reference external" href="https://www.stsci.edu/files/live/sites/www/files/home/hst/instrumentation/wfc3/documentation/instrument-science-reports-isrs/_documents/2022/WFC3-ISR-2022-05.pdf">WFC3 ISR 2022-05</a>.</p></li>
</ul>
<p>FORTRAN can be installed by typing the command <code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">install</span> <span class="pre">-c</span> <span class="pre">conda-forge</span> <span class="pre">gfortran</span></code> into a terminal. If the installation is successful, then typing <code class="docutils literal notranslate"><span class="pre">gfortran</span> <span class="pre">--version</span></code> should return a message similar to the following: <code class="docutils literal notranslate"><span class="pre">GNU</span> <span class="pre">Fortran</span> <span class="pre">(GCC)</span> <span class="pre">13.2.0</span> <span class="pre">Copyright</span> <span class="pre">(C)</span> <span class="pre">2023</span> <span class="pre">Free</span> <span class="pre">Software</span> <span class="pre">Foundation,</span> <span class="pre">Inc.</span></code>.</p>
<p>Next, to install hst1pass proceed to <a class="reference external" href="https://www.stsci.edu/~jayander/HST1PASS/CODE/hst1pass/">https://www.stsci.edu/~jayander/HST1PASS/CODE/hst1pass/</a> and download the latest version of <code class="docutils literal notranslate"><span class="pre">hst1pass.F</span></code>, e.g. <code class="docutils literal notranslate"><span class="pre">hst1pass.2023.11.07_v1f.F</span></code>, or use the version in this notebook’s repository. Save this to your computer and compile the code using the command: <code class="docutils literal notranslate"><span class="pre">gfortran</span> <span class="pre">hst1pass.2023.11.07_v1f.F</span> <span class="pre">-o</span> <span class="pre">hst1pass.e</span></code>.</p>
<p><a id="import"></a></p>
</section>
<section id="import-packages">
<h3>1.2 Import Packages<a class="headerlink" href="#import-packages" title="Permalink to this heading">#</a></h3>
<p><span class="xref myst">Table of Contents</span></p>
<hr class="docutils" />
<p>The following Python packages are required to run the Jupyter Notebook:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.python.org/3/library/os.html"><strong>os</strong></a> - change and make directories</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/glob.html"><strong>glob</strong></a> - gather lists of filenames</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/shutil.html"><strong>shutil</strong></a> - copy files between folders</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/tarfile.html"><strong>tarfile</strong></a> - read and write compressed tar files</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/urllib.html"><strong>urllib</strong></a> - download files hosted online</p></li>
<li><p><a class="reference external" href="https://ipython.org"><strong>ipython</strong></a> - cell formatting and interactives</p>
<ul>
<li><p><a class="reference external" href="http://ipython.org/ipython-doc/dev/api/generated/IPython.display.html#IPython.display.clear_output">display.clear_output</a> - clear text from cells</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://numpy.org"><strong>numpy</strong></a> - math and array functions</p>
<ul>
<li><p><a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.percentile.html">percentile</a> - lognorm percentile clipping</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://matplotlib.org"><strong>matplotlib</strong></a> - create graphics</p>
<ul>
<li><p><a class="reference external" href="https://matplotlib.org/stable/tutorials/pyplot.html">pyplot</a> - make figures and graphics</p></li>
<li><p><a class="reference external" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.colors.LogNorm.html">colors.LogNorm</a> - display image normalization</p></li>
<li><p><a class="reference external" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.patches.Rectangle.html">patches.Rectangle</a> - overlay rectangular regions</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://astroquery.readthedocs.io/en/latest/"><strong>astroquery</strong></a> - download astronomical data</p>
<ul>
<li><p><a class="reference external" href="https://astroquery.readthedocs.io/en/latest/mast/mast_obsquery.html">mast.Observations</a> - query MAST database</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://www.astropy.org"><strong>astropy</strong></a> - model fitting and file handling</p>
<ul>
<li><p><a class="reference external" href="https://docs.astropy.org/en/stable/io/fits/">io.fits</a> - import FITS files</p></li>
<li><p><a class="reference external" href="https://docs.astropy.org/en/stable/api/astropy.table.QTable.html">table.QTable</a> - tables with physical units</p></li>
<li><p><a class="reference external" href="https://docs.astropy.org/en/stable/modeling/models.html">modeling.models</a> - Gaussian and Moffat models</p></li>
<li><p><a class="reference external" href="https://docs.astropy.org/en/stable/modeling/fitting.html">modeling.fitting</a> - fitting methods for models</p></li>
<li><p><a class="reference external" href="https://docs.astropy.org/en/stable/api/astropy.visualization.mpl_normalize.simple_norm.html">visualization.simple_norm</a> - display image normalization</p></li>
<li><p><a class="reference external" href="https://docs.astropy.org/en/stable/api/astropy.stats.sigma_clipped_stats.html">stats.sigma_clipped_stats</a> - mean, median, and standard deviation</p></li>
<li><p><a class="reference external" href="https://docs.astropy.org/en/stable/api/astropy.stats.SigmaClip.html">stats.SigmaClip</a> - sigma-clip provided data</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://photutils.readthedocs.io/en/stable/index.html"><strong>photutils</strong></a> - aperture and PSF photometry tools</p>
<ul>
<li><p><a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.detection.DAOStarFinder.html#photutils.detection.DAOStarFinder">detection.DAOStarFinder</a> - finding stars in images</p></li>
<li><p><a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.detection.find_peaks.html#photutils.detection.find_peaks">detection.find_peaks</a> - finding peaks in images</p></li>
<li><p><a class="reference external" href="https://photutils.readthedocs.io/en/stable/centroids.html">photutils.centroids</a> - finding stellar centroids</p></li>
<li><p><a class="reference external" href="https://photutils.readthedocs.io/en/stable/aperture.html">photutils.aperture</a> - aperture photometry tools</p>
<ul>
<li><p><a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.aperture.aperture_photometry.html#photutils.aperture.aperture_photometry">aperture_photometry</a> - measure aperture photometry</p></li>
<li><p><a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.aperture.CircularAperture.html">CircularAperture</a> - measure photometry in circle</p></li>
<li><p><a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.aperture.CircularAnnulus.html">CircularAnnulus</a> - measure photometry in annulus</p></li>
<li><p><a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.aperture.ApertureStats.html">ApertureStats</a> - calculate aperture statistics</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://photutils.readthedocs.io/en/stable/psf.html">photutils.psf</a> - PSF photometry tools</p>
<ul>
<li><p><a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.psf.PSFPhotometry.html#photutils.psf.PSFPhotometry">PSFPhotometry</a> - perform PSF photometry</p></li>
<li><p><a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.psf.SourceGrouper.html#photutils.psf.SourceGrouper">SourceGrouper</a> - group sources for fitting</p></li>
<li><p><a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.psf.IntegratedGaussianPRF.html">IntegratedGaussianPRF</a> - Gaussian model for PSF fitter</p></li>
<li><p><a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.psf.GriddedPSFModel.html#photutils.psf.GriddedPSFModel">GriddedPSFModel</a> - enables spatially-dependent PSF grids</p></li>
<li><p><a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.psf.STDPSFGrid.html#photutils.psf.STDPSFGrid">STDPSFGrid</a> - reads STScI standard PSF models into a grid</p></li>
<li><p><a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.psf.stdpsf_reader.html#photutils.psf.stdpsf_reader">stdpsf_reader</a> - reads STScI standard PSF format models</p></li>
<li><p><a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.psf.FittableImageModel.html#photutils.psf.FittableImageModel">FittableImageModel</a> - convert stacked stars to fitable model</p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference external" href="https://scipy.org"><strong>scipy</strong></a> - mathematical interpolation and shift functions</p>
<ul>
<li><p><a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.ndimage.shift.html">ndimage.shift</a> - fractional array shifts</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://www.stsci.edu/scientific-community/software/drizzlepac"><strong>drizzlepac</strong></a> - combine HST images into mosaics</p>
<ul>
<li><p><a class="reference external" href="https://drizzlepac.readthedocs.io/en/deployment/astrodrizzle.html">astrodrizzle</a> - combine exposures by drizzling</p></li>
<li><p><a class="reference external" href="https://drizzlepac.readthedocs.io/en/deployment/tweakreg.html">tweakreg</a> - align exposures to a common WCS</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tarfile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">clear_output</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogNorm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">Rectangle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.mast</span><span class="w"> </span><span class="kn">import</span> <span class="n">Observations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">QTable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">simple_norm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">sigma_clipped_stats</span><span class="p">,</span> <span class="n">SigmaClip</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.detection</span><span class="w"> </span><span class="kn">import</span> <span class="n">DAOStarFinder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.aperture</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">ApertureStats</span><span class="p">,</span> <span class="n">CircularAnnulus</span><span class="p">,</span>
                                <span class="n">CircularAperture</span><span class="p">,</span> <span class="n">aperture_photometry</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.psf</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">FittableImageModel</span><span class="p">,</span> <span class="n">GriddedPSFModel</span><span class="p">,</span> <span class="n">IntegratedGaussianPRF</span><span class="p">,</span> 
                           <span class="n">PSFPhotometry</span><span class="p">,</span> <span class="n">SourceGrouper</span><span class="p">,</span> <span class="n">STDPSFGrid</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">drizzlepac</span><span class="w"> </span><span class="kn">import</span> <span class="n">tweakreg</span><span class="p">,</span> <span class="n">astrodrizzle</span>

<span class="c1"># Custom functions written in psf_utilities.py.</span>
<span class="c1"># Contains functions for making various figures and maniputlating science images.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">psf_utilities</span><span class="w"> </span><span class="kn">import</span> <span class="n">save_figure</span><span class="p">,</span> <span class="n">setup_matplotlib</span><span class="p">,</span> <span class="n">create_mask</span><span class="p">,</span> <span class="n">plot_apertures</span><span class="p">,</span> \
    <span class="n">plot_psf_results</span><span class="p">,</span> <span class="n">download_psf_model</span><span class="p">,</span> <span class="n">make_cutouts</span><span class="p">,</span> <span class="n">stack_cutouts</span><span class="p">,</span> <span class="n">plot_cutout_grid</span>

<span class="c1"># Custom functions written in mast_api_psf.py.</span>
<span class="c1"># Contains functions for downloading image cutouts from the MAST PSF library server.</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mast_api_psf</span>
</pre></div>
</div>
</div>
</div>
<p>Note that we can access the helpful documentation string for any of the custom-defined functions using help(). For example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">help</span><span class="p">(</span><span class="n">save_figure</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Help on function save_figure in module psf_utilities:

save_figure(figure, filename, show_figure)
    Save the current figure and display or close the file.
    There are no returns, the filepath is simply printed.
    
    Parameters
    ----------
    figure : matplotlib.figure.Figure
        The matplotlib image that the user would like to save.
    filename : str
        The full filepath including the desired filename to save.
    show_figure : bool
        The figure will be shown in the notebook if set to True.
</pre></div>
</div>
</div>
</div>
<p>Set the main code, data, PSF, plot, AstroDrizzle, and TweakReg directories. Set the backend configuration to ‘retina’, which improves the resolution of figures in notebooks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">code_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;/&#39;</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="n">code_dir</span><span class="o">+</span><span class="s1">&#39;data/&#39;</span>
<span class="n">psfs_dir</span> <span class="o">=</span> <span class="n">code_dir</span><span class="o">+</span><span class="s1">&#39;psfs/&#39;</span>
<span class="n">plot_dir</span> <span class="o">=</span> <span class="n">code_dir</span><span class="o">+</span><span class="s1">&#39;plot/&#39;</span>
<span class="n">driz_dir</span> <span class="o">=</span> <span class="n">code_dir</span><span class="o">+</span><span class="s1">&#39;driz/&#39;</span>
<span class="n">tweak_dir</span> <span class="o">=</span> <span class="n">code_dir</span><span class="o">+</span><span class="s1">&#39;tweak/&#39;</span>

<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">code_dir</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">The code_dir is:&#39;</span><span class="p">,</span> <span class="n">code_dir</span><span class="p">)</span>

<span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;psfs&#39;</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">,</span> <span class="s1">&#39;driz&#39;</span><span class="p">,</span> <span class="s1">&#39;tweak&#39;</span><span class="p">]:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s1"> directory exists.&#39;</span><span class="p">)</span>

<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The code_dir is: /home/runner/work/hst_notebooks/hst_notebooks/notebooks/WFC3/point_spread_function/
</pre></div>
</div>
</div>
</div>
<p><a id="data"></a></p>
</section>
<section id="download-data">
<h3>1.3 Download Data<a class="headerlink" href="#download-data" title="Permalink to this heading">#</a></h3>
<p><span class="xref myst">Table of Contents</span></p>
<hr class="docutils" />
<p>In this example, we will be using HST WFC3 imaging of the globular cluster Omega Centauri (NGC 5139). Specifically, utilizing exposures that are not centered on the cluster core so there is a moderate density of bright stars. This source was chosen because it serves as a frequent target for both science and calibration exposures, and has been observed with every UVIS and IR filter onboard WFC3. A complete list of WFC3 filters is available in the Data Handbook for the <a class="reference external" href="https://hst-docs.stsci.edu/wfc3ihb/chapter-6-uvis-imaging-with-wfc3/6-5-uvis-spectral-elements">UVIS</a> and <a class="reference external" href="https://hst-docs.stsci.edu/wfc3ihb/chapter-7-ir-imaging-with-wfc3/7-5-ir-spectral-elements">IR</a> channels. First, we use astroquery to retrieve the calibrated exposure from MAST.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hst_wfc3_f606w_file</span> <span class="o">=</span> <span class="s1">&#39;id8048dyq_flc.fits&#39;</span>

<span class="n">Observations</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;mast:HST/product/&#39;</span><span class="o">+</span><span class="n">hst_wfc3_f606w_file</span><span class="p">,</span> <span class="n">local_path</span><span class="o">=</span><span class="n">data_dir</span><span class="o">+</span><span class="n">hst_wfc3_f606w_file</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/id8048dyq_flc.fits to /home/runner/work/hst_notebooks/hst_notebooks/notebooks/WFC3/point_spread_function/data/id8048dyq_flc.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;COMPLETE&#39;, None, None)
</pre></div>
</div>
</div>
</div>
<p>Next, let’s display the image of Omega Centauri and add a rectangle showing the region of the image that we will focus on in this analysis. We select a small region of the image that contains isolated and blended stars to highlight key concepts in aperture and PSF photometry. The WFC3/UVIS pixel scale is 0.03962 arcseconds per pixel so selecting a region of 75 pixels corresponds to approximately 3 arcseconds. The UVIS detector has two chips that can be accessed in the FITS files from extensions <code class="docutils literal notranslate"><span class="pre">['SCI',</span> <span class="pre">1]</span></code> for UVIS2 and <code class="docutils literal notranslate"><span class="pre">['SCI',</span> <span class="pre">2]</span></code> for UVIS1. The lower-left corner of the detector is the location (0, 0) pixels, so we use the <code class="docutils literal notranslate"><span class="pre">origin</span> <span class="pre">=</span> <span class="pre">'lower'</span></code> option. Finally, we display the image on a logarithmic scale to view both very faint and bright stars simultaneously.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">data_dir</span><span class="o">+</span><span class="n">hst_wfc3_f606w_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
    <span class="n">sci_data</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The image dimensions are:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">sci_data</span><span class="p">))</span>

<span class="n">my_figure_size</span><span class="p">,</span> <span class="n">my_fontsize</span> <span class="o">=</span> <span class="n">setup_matplotlib</span><span class="p">(</span><span class="s1">&#39;notebook&#39;</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
<span class="n">figure</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">my_figure_size</span><span class="p">)</span>
<span class="n">cutout_size</span> <span class="o">=</span> <span class="mi">75</span> <span class="c1"># 75 WFC3 UVIS pixels = 3 arcseconds.</span>

<span class="n">axes</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">((</span><span class="mi">1818</span><span class="o">-</span><span class="n">cutout_size</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">986</span><span class="o">-</span><span class="n">cutout_size</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="n">cutout_size</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">cutout_size</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">))</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">))</span>
<span class="n">axes</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The image dimensions are: (2051, 4096)
</pre></div>
</div>
<img alt="../../../_images/c707f663518e06fa4bd7f9b51a3fd2bedefab7ec61e28265c1d8221bb5e6f5f2.png" src="../../../_images/c707f663518e06fa4bd7f9b51a3fd2bedefab7ec61e28265c1d8221bb5e6f5f2.png" />
</div>
</div>
<p><a id="aperture"></a></p>
</section>
<section id="aperture-photometry">
<h3>1.4 Aperture Photometry<a class="headerlink" href="#aperture-photometry" title="Permalink to this heading">#</a></h3>
<p><span class="xref myst">Table of Contents</span></p>
<hr class="docutils" />
<p>First, we can perform simple aperture photometry on the image. This consists of detecting stars in the image, assigning them an aperture within which to measure the enclosed flux, and creating a background annulus that is used to subtract the background level. In ground-based astronomy this is commonly referred to as the “sky” level. In this example, we create a mask so that we only find and measure the properties of stars that are within our selected box region.</p>
<p>The cell below first calculates the mean, median, and standard deviation for the background, initializes the star finder function with a threshold of 500 electrons and a FWHM of three pixels, and then creates a mask so that the star finding algorithm will only search within our zoomed-in box region. Next, the <code class="docutils literal notranslate"><span class="pre">DAOStarFinder</span></code> function searches for peaks and returns a list of sources. We then assign to the position of each source a circular annulus designed to measure the flux of the star, and a background annulus that measures the local background flux.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
<span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">roundhi</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">create_mask</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">cutout_size</span><span class="p">,</span> <span class="mi">1818</span><span class="p">,</span> <span class="mi">986</span><span class="p">)</span>
<span class="n">sources</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">sci_data</span> <span class="o">-</span> <span class="n">median</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]))</span>
<span class="n">apertures_stellar</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">apertures_annulus</span> <span class="o">=</span> <span class="n">CircularAnnulus</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r_in</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">r_out</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">phot_table</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">apertures_stellar</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we use the aperture and annulus measurement for each star to calculate the sigma-clipped background flux, and subtract it to obtain only the flux of each star.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">aperture_stats</span> <span class="o">=</span> <span class="n">ApertureStats</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">apertures_stellar</span><span class="p">,</span> <span class="n">sigma_clip</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">background_stats</span> <span class="o">=</span> <span class="n">ApertureStats</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">apertures_annulus</span><span class="p">,</span> <span class="n">sigma_clip</span><span class="o">=</span><span class="n">SigmaClip</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="n">total_background</span> <span class="o">=</span> <span class="n">background_stats</span><span class="o">.</span><span class="n">median</span> <span class="o">*</span> <span class="n">aperture_stats</span><span class="o">.</span><span class="n">sum_aper_area</span><span class="o">.</span><span class="n">value</span> <span class="c1"># area of annulus.</span>
<span class="n">flux_background_sub</span> <span class="o">=</span> <span class="n">aperture_stats</span><span class="o">.</span><span class="n">sum</span> <span class="o">-</span> <span class="n">total_background</span>
<span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;total_background&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_background</span>
<span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;flux_background_sub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux_background_sub</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">phot_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>  
    <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;npix&#39;</span><span class="p">):</span>
        <span class="n">phot_table</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we display the flux measurements in a table and create a figure showing the science data, stellar apertures (green circles) and background annuli (white circles).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">phot_table</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">plot_apertures</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">sci_data</span><span class="p">,</span> 
               <span class="n">xcenter</span><span class="o">=</span><span class="mi">1818</span><span class="p">,</span> 
               <span class="n">ycenter</span><span class="o">=</span><span class="mi">986</span><span class="p">,</span> 
               <span class="n">cutout_size</span><span class="o">=</span><span class="n">cutout_size</span><span class="p">,</span> 
               <span class="n">apertures_stellar</span><span class="o">=</span><span class="n">apertures_stellar</span><span class="p">,</span> 
               <span class="n">apertures_annulus</span><span class="o">=</span><span class="n">apertures_annulus</span><span class="p">)</span>

<span class="n">save_figure</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="n">plot_dir</span><span class="o">+</span><span class="s1">&#39;fig1_aperture_photometry.pdf&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  id xcenter ycenter aperture_sum total_background flux_background_sub
--- ------- ------- ------------ ---------------- -------------------
  1 1822.05  963.68     33720.33           989.01            32731.32
  2 1836.63  986.73     32338.86           970.57            31368.29
  3 1803.54 1003.36     63426.72          1303.54            62123.18
  4 1812.01 1004.03     34106.74          1261.96            32844.78 
</pre></div>
</div>
<img alt="../../../_images/13d85bd3258de226d3c76cc41679f9ac126347bc562c9666abacfb35de49f885.png" src="../../../_images/13d85bd3258de226d3c76cc41679f9ac126347bc562c9666abacfb35de49f885.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Figure saved as: /home/runner/work/hst_notebooks/hst_notebooks/notebooks/WFC3/point_spread_function/plot/fig1_aperture_photometry.pdf
</pre></div>
</div>
</div>
</div>
<p><a id="mainc"></a></p>
</section>
</section>
<section id="exposure-psf-models">
<h2>2. Exposure PSF Models<a class="headerlink" href="#exposure-psf-models" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Table of Contents</span></p>
<hr class="docutils" />
<p>As described in the <span class="xref myst">Introduction</span>, we may perform PSF modeling, photometry, and astrometry on either individual exposures or mosaics that combine exposures through drizzling. The sections below contain several different workflows with various options depending on your science goals and the available data. The flowchart below is meant as a general guide for deciding which sections are most relevant for your project. We highlight that several different paths may be applicable to a single dataset and users are encouraged to experiment with the options below.</p>
<div class="alert alert-block alert-info"><b>NOTE:</b> Users that are creating PSF models for drizzled images and not single exposures can proceed to the section on Drizzle PSF Models. </div>
<p><img alt="This flowchart provides users with a general guide for deciding which PSF modeling technique is the most relevant based on their dataset and science goals. The top of the chart asks users if they are modeling at the exposure or drizzle level. The drizzle workflow forks to the right, and asks users how many bright, isolated stars are in their image. If there are fewer than 10 stars, they can fit an analytical profile or download custom tools as described below. If they have 10 or more stars, they can extract and stack stars as described in Section 3. If users are working at the exposure level, then the diagram forks to the left. If the user's goal is focused on high-accuracy photometry and astrometry of stars, then they follow the left fork. If their goals are to model the extended wings and diffraction spikes of the PSF, they follow the fork right. In following the left fork for precision photometry and astrometry, users are asked if an empirical model from the WFC3 team exists. If it does, then they can run hst1pass and examine the residuals. If there is not an empirical model, they can use the model for the closest filter and perturb it with hst1pass if there are at least 10 stars. In following the right fork for modeling extended wing emission and diffraction spikes, users are asked if they have more or less than 10 stars in their image. If they have fewer than 10, they can use the MAST cutout service to retrieve and stack stars from other observations. If they have at least 10 stars, then they can stack stars directly from their observations. This flowchart is a general guide, and we note that several different paths may be applicable to a single dataset. Users are encouraged to experiment with the options below." src="../../../_images/workflow.png" /></p>
<p>Note that the left fork under the drizzle level branch is an advanced workflow that involves drizzling the empirical models provided by the WFC3 team into FLC files. This requires installing the <a class="reference external" href="https://github.com/spacetelescope/wfc3_photometry">wfc3_photometry</a> package, running the <code class="docutils literal notranslate"><span class="pre">make_model_star_image()</span></code> function within <code class="docutils literal notranslate"><span class="pre">PSFUtils.py</span></code>, and then stacking the drizzled models. This functionality is under development and not yet officially supported.</p>
<p><a id="analytical"></a></p>
<section id="analytical-psf-models">
<h3>2.1 Analytical PSF Models<a class="headerlink" href="#analytical-psf-models" title="Permalink to this heading">#</a></h3>
<p><span class="xref myst">Table of Contents</span></p>
<hr class="docutils" />
<p>The example above demonstrates how to perform basic aperture photometry of sources. However, we can see that two of the stars overlap in the image and their fluxes are blended. Therefore, aperture photometry cannot be used reliably for crowded fields, and requires corrections when using multiple filters as the apertures do not account for changing resolution with wavelength. Without any knowledge of the intrinsic shape of the PSF, we can first fit purely analytical functions such as a Gaussian, Moffat, Lorentzian, or Voigt profile to each star. While the majority of our functions are specified in the <code class="docutils literal notranslate"><span class="pre">psf_utilities.py</span></code> module, we explicitly define two common photometry functions here so users can easily experiment and change common options depending on their data and goals.</p>
<p>Critically, we note that the size of the <code class="docutils literal notranslate"><span class="pre">fit_shape</span></code> variable (in pixels) determines the number of pixels used to constrain the fit. If the value is small, the core pixels of the source will dominate the fit, while larger values will weight more wing emission when determining the best fit model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">calculate_photometry</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">psf_model</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A function that performs PSF photometry given a science image, </span>
<span class="sd">    a list of sources, and a PSF model in the PSFPhotometry format. </span>
<span class="sd">    See the photutils documentation below for additional examples:</span>
<span class="sd">    </span>
<span class="sd">    https://photutils.readthedocs.io/en/stable/psf.html</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sci_data : np.ndarray</span>
<span class="sd">        The np.ndarray containing the array of science data.</span>
<span class="sd">    sources : astropy.table.table.QTable</span>
<span class="sd">        The astropy table of sources from the daofind function.</span>
<span class="sd">    psf_model : photutils.psf.GriddedPSFModel</span>
<span class="sd">        An astropy compatible model PSF or grid of PSFs.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    phot : astropy.table.table.QTable</span>
<span class="sd">        An astropy quantity table with measured source photometry.</span>
<span class="sd">    psfphot : photutils.psf.PSFPhotometry</span>
<span class="sd">        Contains results of PSF fitting for use with other functions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Perform PSF fitting using an 9x9 pixel region.    </span>
    <span class="n">fit_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
    <span class="n">grouper</span> <span class="o">=</span> <span class="n">SourceGrouper</span><span class="p">(</span><span class="n">min_separation</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">finder</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">roundhi</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">psfphot</span> <span class="o">=</span> <span class="n">PSFPhotometry</span><span class="p">(</span><span class="n">psf_model</span><span class="p">,</span> <span class="n">fit_shape</span><span class="p">,</span> <span class="n">finder</span><span class="o">=</span><span class="n">finder</span><span class="p">,</span> <span class="n">aperture_radius</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">grouper</span><span class="o">=</span><span class="n">grouper</span><span class="p">)</span>
    
    <span class="n">init_params</span> <span class="o">=</span> <span class="n">QTable</span><span class="p">()</span>
    <span class="n">init_params</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">]</span>
    <span class="n">init_params</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]</span>
    <span class="n">phot</span> <span class="o">=</span> <span class="n">psfphot</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">init_params</span><span class="o">=</span><span class="n">init_params</span><span class="p">)</span>
    <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;x_fit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;.2f&#39;</span>
    <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;y_fit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;.2f&#39;</span>
    <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;.2f&#39;</span>
    <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;qfit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;.3f&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1m&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">PSF Photometry (before subtraction):</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">phot</span><span class="p">[(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;x_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;y_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;qfit&#39;</span><span class="p">)])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">phot</span><span class="p">,</span> <span class="n">psfphot</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">calculate_residuals</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">sources</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A function that calculates the residual flux at the </span>
<span class="sd">    locations of stars in a given PSF-subtracted image.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    resid : np.ndarray</span>
<span class="sd">        A residual image created by psfphot.make_residual_image().</span>
<span class="sd">    sources : astropy.table.table.QTable</span>
<span class="sd">        The astropy table of sources from the daofind function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    phot_table : astropy.table.table.QTable</span>
<span class="sd">        Prints an astropy table with measured source photometry.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Use the PSF fitting residuals to calculate remaining fluxes.</span>
    <span class="n">phot_table</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">apertures_stellar</span><span class="p">)</span>
    <span class="n">aperture_stats</span> <span class="o">=</span> <span class="n">ApertureStats</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">apertures_stellar</span><span class="p">,</span> <span class="n">sigma_clip</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">background_stats</span> <span class="o">=</span> <span class="n">ApertureStats</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">apertures_annulus</span><span class="p">,</span> <span class="n">sigma_clip</span><span class="o">=</span><span class="n">SigmaClip</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">total_background</span> <span class="o">=</span> <span class="n">background_stats</span><span class="o">.</span><span class="n">median</span> <span class="o">*</span> <span class="n">aperture_stats</span><span class="o">.</span><span class="n">sum_aper_area</span><span class="o">.</span><span class="n">value</span> <span class="c1"># area of annulus.</span>
    <span class="n">flux_background_sub</span> <span class="o">=</span> <span class="n">aperture_stats</span><span class="o">.</span><span class="n">sum</span> <span class="o">-</span> <span class="n">total_background</span>
    <span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;total_background&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_background</span>
    <span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;flux_background_sub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux_background_sub</span>
    
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">phot_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>  
        <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;npix&#39;</span><span class="p">):</span>
            <span class="n">phot_table</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1m&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Aperture Photometry (after subtraction):</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="nb">print</span><span class="p">(</span><span class="n">phot_table</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>In this first analytical example, we fit Gaussian profiles to the four stars in our subimage and display the data, model, and residuals. We provide an initial guess for the width (sigma) using an approximate full width at half maximum (FWHM) of 2 pixels, where <span class="math notranslate nohighlight">\(\sigma\)</span> = FWHM/2.355. Users are encouraged to experiment with this value to see how the resulting fit and residuals change. First, the <code class="docutils literal notranslate"><span class="pre">calculate_photometry</span></code> function uses the provided PSF model with the photutils <code class="docutils literal notranslate"><span class="pre">PSFPhotometry</span></code> function to fit the model to the stars. In essence, the flux of the normalized PSF model is scaled up to match the flux of each star. In this case, neighboring stars are fit simultaneously. The <code class="docutils literal notranslate"><span class="pre">make_residual_image</span></code> function then subtracts the best fit model so the flux residuals can be examined. Finally, we call the <code class="docutils literal notranslate"><span class="pre">calculate_residuals</span></code> function with the exact same stellar and background photometry apertures used in <span class="xref myst">Section 1.4</span> in order to measure the residual fluxes. A smaller residual flux generally implies a better fit, but the residuals should be inspected as over and undersubtractions from different portions of the star can also yield a small net residual flux.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">psf_model</span> <span class="o">=</span> <span class="n">IntegratedGaussianPRF</span><span class="p">(</span><span class="n">flux</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">2.355</span><span class="p">)</span>
<span class="n">photometry</span><span class="p">,</span> <span class="n">psfphot</span> <span class="o">=</span> <span class="n">calculate_photometry</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">psf_model</span><span class="p">)</span>
<span class="n">resid</span> <span class="o">=</span> <span class="n">psfphot</span><span class="o">.</span><span class="n">make_residual_image</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">psf_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="mi">19</span><span class="p">))</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">plot_psf_results</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">resid</span><span class="p">,</span> <span class="mi">1818</span><span class="p">,</span> <span class="mi">986</span><span class="p">,</span> <span class="n">cutout_size</span><span class="p">)</span>
<span class="n">save_figure</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="n">plot_dir</span><span class="o">+</span><span class="s1">&#39;fig2_gaussian_model.pdf&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">calculate_residuals</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">sources</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">PSF Photometry (before subtraction):</span>

 id  x_fit   y_fit  flux_fit  qfit
--- ------- ------- -------- -----
  1 1822.08  963.69 20526.43 0.747
  2 1836.70  986.77 19707.67 0.735
  3 1803.57 1003.37 38347.68 0.732
  4 1812.03 1004.04 19604.58 0.848
</pre></div>
</div>
<img alt="../../../_images/7c6262a7657b1b701cf0edeef405b75e74e1b85eae7975f15f06b69ee33037f1.png" src="../../../_images/7c6262a7657b1b701cf0edeef405b75e74e1b85eae7975f15f06b69ee33037f1.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Figure saved as: /home/runner/work/hst_notebooks/hst_notebooks/notebooks/WFC3/point_spread_function/plot/fig2_gaussian_model.pdf

<span class=" -Color -Color-Bold">Aperture Photometry (after subtraction):</span>

 id xcenter ycenter aperture_sum total_background flux_background_sub
--- ------- ------- ------------ ---------------- -------------------
  1 1822.05  963.68     13193.91           989.01            12204.90
  2 1836.63  986.73     12631.20           970.57            11660.63
  3 1803.54 1003.36     25078.53          1303.54            23774.99
  4 1812.01 1004.03     14498.24          1261.96            13236.27 
</pre></div>
</div>
</div>
</div>
<p>In this case, the Gaussian fit leaves significant residual flux in the stellar wings, and has oversubtracted the emission in the core. The three panels above are shown with the same minimum and maximum flux values, so the residuals can be directly compared with the data and model. In the next section, we improve this using models of HST data.</p>
<p><a id="empirical"></a></p>
</section>
<section id="empirical-psf-models">
<h3>2.2 Empirical PSF Models<a class="headerlink" href="#empirical-psf-models" title="Permalink to this heading">#</a></h3>
<p><span class="xref myst">Table of Contents</span></p>
<hr class="docutils" />
<p>The example above demonstrates how a Gaussian profile can determine reasonable centroids for stellar sources, but they fail to accurately model the radial light distribution. While it is possible to use more advanced analytical forms such as <a class="reference external" href="https://docs.astropy.org/en/stable/api/astropy.modeling.functional_models.Moffat2D.html">Moffat profiles</a>, the overall shape can be more accurately represented by models constructed from bright stars in the field of view. The examples below demonstrate how to use pre-generated PSF models provided by the WFC3 team, as well as how to extract and stack stars from your observations. As described below, the pre-generated models are excellent for precision astrometry and photometry of unresolved sources, while stacking stars can be more beneficial for accurately modeling the PSF wings and diffraction spikes.</p>
<p>First, we display the pre-generated PSF models provided by the WFC3 team, which are stored in a standard format known as “STDPSF_WFC3”. The FITS file for each filter contains a grid of models that represents the PSF at regularly spaced intervals of a few hundred pixels across the detector, as shown below. The models are oversampled by a factor of 4x to account for the fact that the morphology of the PSF changes depending on where a star falls within a given pixel. These models are tapered to zero flux at large radii to prevent discontinuities in image subtraction, at the expense of PSF wing accuracy. The specific details of these models are provided on the <a class="reference external" href="https://www.stsci.edu/hst/instrumentation/wfc3/data-analysis/psf">WFC3 PSF webpage</a>, as well as in <a class="reference external" href="https://www.stsci.edu/files/live/sites/www/files/home/hst/instrumentation/wfc3/documentation/instrument-science-reports-isrs/_documents/2016/WFC3-2016-12.pdf">WFC3 ISR 2016-12</a>. The models are retrieved from <a class="reference external" href="https://www.stsci.edu/~jayander/HST1PASS/LIB/PSFs/STDPSFs/">https://www.stsci.edu/~jayander/HST1PASS/LIB/PSFs/STDPSFs/</a>, and we save them to the main directory for access by hst1pass.</p>
<p>There are also “focus-diverse” models for commonly used filters with an additional dimension containing the same grids at different focus intervals. The best fit model can be determined experimentally, or by running the hst1pass code to measure the focus. However, if there are a sufficient number of stars to measure the focus then hst1pass can “perturb” the pre-generated PSF models to best match the data. As this approach is generalized for any filter we do not use the focus-diverse models in this notebook. Users can find information in <a class="reference external" href="https://www.stsci.edu/files/live/sites/www/files/home/hst/instrumentation/wfc3/documentation/instrument-science-reports-isrs/_documents/2018/WFC3-2018-14.pdf">WFC3 ISR 2018-14</a>. In addition, similar focus-diverse models exist for <a class="reference external" href="http://acspsf.stsci.edu">ACS</a> as described in <a class="reference external" href="https://www.stsci.edu/files/live/sites/www/files/home/hst/instrumentation/acs/documentation/instrument-science-reports-isrs/_documents/isr2306.pdf">ACS ISR 2023-06</a>.</p>
<p>Finally, in the examples below we complete a single iteration in the PSF fitting, but it is possible to recover faint blended stars iteratively using <a class="reference external" href="https://photutils.readthedocs.io/en/latest/api/photutils.psf.IterativePSFPhotometry.html#photutils.psf.IterativePSFPhotometry">IterativePSFPhotometry</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hst_wfc3_f606w_psf_model</span> <span class="o">=</span> <span class="n">download_psf_model</span><span class="p">(</span><span class="n">psfs_dir</span><span class="p">,</span> <span class="s1">&#39;WFC3UV&#39;</span><span class="p">,</span> <span class="s1">&#39;F606W&#39;</span><span class="p">)</span>
<span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">psfs_dir</span><span class="o">+</span><span class="n">hst_wfc3_f606w_psf_model</span><span class="p">,</span> <span class="n">ignore_missing_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">setup_matplotlib</span><span class="p">(</span><span class="s1">&#39;notebook&#39;</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">)</span>
<span class="n">psfgrid</span> <span class="o">=</span> <span class="n">STDPSFGrid</span><span class="p">(</span><span class="n">psfs_dir</span><span class="o">+</span><span class="n">hst_wfc3_f606w_psf_model</span><span class="p">)</span><span class="o">.</span><span class="n">plot_grid</span><span class="p">()</span>
<span class="n">save_figure</span><span class="p">(</span><span class="n">psfgrid</span><span class="p">,</span> <span class="n">plot_dir</span><span class="o">+</span><span class="s1">&#39;fig3_empirical_grid.pdf&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading: https://www.stsci.edu/~jayander/HST1PASS/LIB/PSFs/STDPSFs/WFC3UV/STDPSF_WFC3UV_F606W.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Validation complete, the PSF file is readable.
</pre></div>
</div>
<img alt="../../../_images/77a140a9404cb79f27668076b71f8e7a2352a1694dcfcaea835d5cc74149013b.png" src="../../../_images/77a140a9404cb79f27668076b71f8e7a2352a1694dcfcaea835d5cc74149013b.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Figure saved as: /home/runner/work/hst_notebooks/hst_notebooks/notebooks/WFC3/point_spread_function/plot/fig3_empirical_grid.pdf
</pre></div>
</div>
</div>
</div>
<p><a id="empirical-1"></a></p>
<section id="default-models">
<h4>2.2.1 Default Models<a class="headerlink" href="#default-models" title="Permalink to this heading">#</a></h4>
<p><span class="xref myst">Table of Contents</span></p>
<hr class="docutils" />
<p>First, we can simply use the pre-generated PSF models provided by the WFC3 team. In many cases, these models will be sufficient for measuring very accurate astrometry and photometry of stellar sources in individual exposures (FLTs/FLCs) without further modifications. We utilize functions within the Astropy-affiliated <a class="reference external" href="https://photutils.readthedocs.io/en/stable/">photutils</a> package to read the models into a recognized format for the PSF fitter. As noted in the packages <a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.psf.stdpsf_reader.html">documentation</a>, for ACS/WFC and WFC3/UVIS the detector value should be “1” for WFC2, UVIS2 (sci, 1), and “2” for WFC1, UVIS1 (sci, 2).</p>
<p>In the examples below we only utilize the <code class="docutils literal notranslate"><span class="pre">['SCI',</span> <span class="pre">1]</span></code> extension of the science image, so the hst1pass and array image coordinates will match. When analyzing <code class="docutils literal notranslate"><span class="pre">['SCI',</span> <span class="pre">2]</span></code> (<code class="docutils literal notranslate"><span class="pre">k</span> <span class="pre">=</span> <span class="pre">1</span></code> in hst1pass catalogs) users must subtract 2048 from the hst1pass <code class="docutils literal notranslate"><span class="pre">y</span></code> coordinates so they match the array coordinates. This is because hst1pass detects over the full 4096x2048 dimensions of the detector, but each chip is read in as a 2048x2048 array.</p>
<p>We now read in the model and use it with the PSF fitter to calculate the best fit model and residuals.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_uvis1</span> <span class="o">=</span> <span class="n">GriddedPSFModel</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">psfs_dir</span><span class="o">+</span><span class="n">hst_wfc3_f606w_psf_model</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;stdpsf&#39;</span><span class="p">,</span> <span class="n">detector_id</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># model_uvis2 = GriddedPSFModel.read(psfs_dir+hst_wfc3_f606w_psf_model, format=&#39;stdpsf&#39;, detector_id=1) # Would be used for UVIS2.</span>
<span class="n">photometry</span><span class="p">,</span> <span class="n">psfphot</span> <span class="o">=</span> <span class="n">calculate_photometry</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">psf_model</span><span class="o">=</span><span class="n">model_uvis1</span><span class="p">)</span>
<span class="n">resid</span> <span class="o">=</span> <span class="n">psfphot</span><span class="o">.</span><span class="n">make_residual_image</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">psf_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">plot_psf_results</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">resid</span><span class="p">,</span> <span class="mi">1818</span><span class="p">,</span> <span class="mi">986</span><span class="p">,</span> <span class="n">cutout_size</span><span class="p">)</span>
<span class="n">save_figure</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="n">plot_dir</span><span class="o">+</span><span class="s1">&#39;fig4_empirical_default.pdf&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">calculate_residuals</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">sources</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">PSF Photometry (before subtraction):</span>

 id  x_fit   y_fit  flux_fit  qfit
--- ------- ------- -------- -----
  1 1822.10  963.69 25316.78 0.401
  2 1836.67  986.75 24332.61 0.398
  3 1803.57 1003.39 47598.92 0.399
  4 1812.04 1004.05 24039.17 0.418
</pre></div>
</div>
<img alt="../../../_images/61fd9a819ee5c29d97ce99330b554f848bb1050b426ef1234eebba5af30d68fe.png" src="../../../_images/61fd9a819ee5c29d97ce99330b554f848bb1050b426ef1234eebba5af30d68fe.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Figure saved as: /home/runner/work/hst_notebooks/hst_notebooks/notebooks/WFC3/point_spread_function/plot/fig4_empirical_default.pdf

<span class=" -Color -Color-Bold">Aperture Photometry (after subtraction):</span>

 id xcenter ycenter aperture_sum total_background flux_background_sub
--- ------- ------- ------------ ---------------- -------------------
  1 1822.05  963.68      8473.11           989.01             7484.10
  2 1836.63  986.73      8079.56           970.57             7108.99
  3 1803.54 1003.36     15958.52          1311.52            14647.01
  4 1812.01 1004.03      9729.13          1271.65             8457.48 
</pre></div>
</div>
</div>
</div>
<p><a id="empirical-2"></a></p>
</section>
<section id="focus-perturbation">
<h4>2.2.2 Focus Perturbation<a class="headerlink" href="#focus-perturbation" title="Permalink to this heading">#</a></h4>
<p><span class="xref myst">Table of Contents</span></p>
<hr class="docutils" />
<p>In the case above, the pre-generated PSF model subtraction has substantial flux remaining in the residual image. We can use the perturbation feature within hst1pass to modify the shape of the PSF to account for the focus of these specific observations, as well as other effects such as minor modulations due to guiding accuracy. As described in Section 3.3 of <a class="reference external" href="https://www.stsci.edu/~jayander/JWST1PASS/DOCs/ISR_HST1PASS.pdf">WFC3 ISR 2022-05</a>, the routine has a <code class="docutils literal notranslate"><span class="pre">PERT</span></code> option that can modify the library PSF if there are at least 10 relatively bright, isolated stars in the field. If <code class="docutils literal notranslate"><span class="pre">PERT=1</span></code>, then hst1pass constructs a single PSF that applies across the entire image. This often provides the best results, but <code class="docutils literal notranslate"><span class="pre">PERT=2</span></code> can be specified to generate an NxN array of PSFs spaced evenly across the detector. This requires ample bright, isolated stars across the detector. In general, it is recommended that users begin with the unaltered PSFs before utilizing the focus or spatially-dependent perturbed PSFs. The perturbed models have a small effect on astrometry and moderate on photometry.</p>
<p>The commands below assume that you have followed the instructions for installing hst1pass given in the <span class="xref myst">Environment Setup</span> section. The executable can be in the same directory as assumed below, or you can provide the full path to the location of the executable. We now attempt to compile and call hst1pass with <code class="docutils literal notranslate"><span class="pre">PERT=1</span></code> to construct a single perturbed PSF model that applies at all locations on the detector. We make a copy of the model because it will be overwritten by hst1pass, but call the original file for compatibility with <code class="docutils literal notranslate"><span class="pre">GriddedPSFModel</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">code_dir</span><span class="o">+</span><span class="s1">&#39;hst1pass.e&#39;</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">code_dir</span><span class="p">)</span>
    <span class="o">!</span>gfortran<span class="w"> </span>hst1pass.2023.11.07_v1f.F<span class="w"> </span>-o<span class="w"> </span>hst1pass.e
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The hst1pass.e has been compiled.&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The executable already exists.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The hst1pass.e has been compiled.
</pre></div>
</div>
</div>
</div>
<p>We now call hst1pass and specify the minimum isolation distance in pixels from the next brightest pixel (<code class="docutils literal notranslate"><span class="pre">HMIN</span></code>), the minimum source flux in counts in the central pixel (<code class="docutils literal notranslate"><span class="pre">FMIN</span></code>), and the maximum source flux in the central pixel (<code class="docutils literal notranslate"><span class="pre">PMAX</span></code>). These arguments are followed by the <code class="docutils literal notranslate"><span class="pre">OUT</span></code> output columns of the resulting catalog, followed by the PSF model to use, and the FLC file to be analyzed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
<span class="o">!</span>./../hst1pass.e<span class="w"> </span><span class="nv">HMIN</span><span class="o">=</span><span class="m">5</span><span class="w"> </span><span class="nv">FMIN</span><span class="o">=</span><span class="m">1000</span>.0<span class="w"> </span><span class="nv">PMAX</span><span class="o">=</span><span class="m">66000</span>.0<span class="w"> </span><span class="nv">PERT</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">OUT</span><span class="o">=</span>xympqks<span class="w"> </span><span class="nv">PSF</span><span class="o">=</span>./../psfs/STDPSF_WFC3UV_F606W.fits<span class="w"> </span>id8048dyq_flc.fits
<span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s1">&#39;id8048dyq_psf.fits&#39;</span><span class="p">,</span> <span class="n">psfs_dir</span><span class="o">+</span><span class="s1">&#39;id8048dyq_psf_pert1.fits&#39;</span><span class="p">)</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s1">&#39;id8048dyq_flc.xympqks&#39;</span><span class="p">,</span> <span class="s1">&#39;id8048dyq_flc_pert1.xympqks&#39;</span><span class="p">)</span>
<span class="n">clear_output</span><span class="p">()</span> <span class="c1"># Remove this line to see the hst1pass log.</span>
</pre></div>
</div>
</div>
</div>
<p>Read in the perturbed model and examine the residuals.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">psf_model_perturbed_1</span> <span class="o">=</span> <span class="n">data_dir</span><span class="o">+</span><span class="s1">&#39;id8048dyq_psf.fits&#39;</span>
<span class="n">model_uvis1</span> <span class="o">=</span> <span class="n">GriddedPSFModel</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">psf_model_perturbed_1</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;stdpsf&#39;</span><span class="p">,</span> <span class="n">detector_id</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># model_uvis2 = GriddedPSFModel.read(psf_model_perturbed_1, format=&#39;stdpsf&#39;, detector_id=1) # Would be used for UVIS2.</span>
<span class="n">photometry</span><span class="p">,</span> <span class="n">psfphot</span> <span class="o">=</span> <span class="n">calculate_photometry</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">psf_model</span><span class="o">=</span><span class="n">model_uvis1</span><span class="p">)</span>
<span class="n">resid</span> <span class="o">=</span> <span class="n">psfphot</span><span class="o">.</span><span class="n">make_residual_image</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">psf_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">plot_psf_results</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">resid</span><span class="p">,</span> <span class="mi">1818</span><span class="p">,</span> <span class="mi">986</span><span class="p">,</span> <span class="n">cutout_size</span><span class="p">)</span>
<span class="n">save_figure</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="n">plot_dir</span><span class="o">+</span><span class="s1">&#39;fig5_empirical_focus.pdf&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">calculate_residuals</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">sources</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">PSF Photometry (before subtraction):</span>

 id  x_fit   y_fit  flux_fit  qfit
--- ------- ------- -------- -----
  1 1822.09  963.70 30925.27 0.114
  2 1836.67  986.76 29751.53 0.113
  3 1803.57 1003.39 58024.04 0.110
  4 1812.03 1004.05 29320.87 0.130
</pre></div>
</div>
<img alt="../../../_images/2b624ded5928e91ccb6166d9d37a618350f1fad2f1b7a164a1d248979fbd606c.png" src="../../../_images/2b624ded5928e91ccb6166d9d37a618350f1fad2f1b7a164a1d248979fbd606c.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Figure saved as: /home/runner/work/hst_notebooks/hst_notebooks/notebooks/WFC3/point_spread_function/plot/fig5_empirical_focus.pdf

<span class=" -Color -Color-Bold">Aperture Photometry (after subtraction):</span>

 id xcenter ycenter aperture_sum total_background flux_background_sub
--- ------- ------- ------------ ---------------- -------------------
  1 1822.05  963.68      2896.46           989.01             1907.45
  2 1836.63  986.73      2673.58           970.57             1703.01
  3 1803.54 1003.36      5503.94          1303.54             4200.41
  4 1812.01 1004.03      3958.08          1266.56             2691.52 
</pre></div>
</div>
</div>
</div>
<p>We see that the residual flux is smaller than when using the default models, and visually the subtraction is improved by accounting for the focus of these observations.</p>
<p><a id="empirical-3"></a></p>
</section>
<section id="spatial-perturbation">
<h4>2.2.3 Spatial Perturbation<a class="headerlink" href="#spatial-perturbation" title="Permalink to this heading">#</a></h4>
<p><span class="xref myst">Table of Contents</span></p>
<hr class="docutils" />
<p>In general, using hst1pass with <code class="docutils literal notranslate"><span class="pre">PERT=1</span></code> to construct a single, focus-dependent PSF model that applies across the detector will provide the best results. However, for specialized use cases with many bright, isolated stars that are located near one location on the detector, or dispersed across the entire detector, hst1pass can create a spatially-dependent PSF model in the same NxN array format as the STDPSF_WFC3 standard models. We now use hst1pass with <code class="docutils literal notranslate"><span class="pre">PERT=2</span></code> to generate a grid of spatially-dependent PSF models optimized for the focus of this exposure at each location on the detector.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
<span class="o">!</span>./../hst1pass.e<span class="w"> </span><span class="nv">HMIN</span><span class="o">=</span><span class="m">5</span><span class="w"> </span><span class="nv">FMIN</span><span class="o">=</span><span class="m">1000</span>.0<span class="w"> </span><span class="nv">PMAX</span><span class="o">=</span><span class="m">66000</span>.0<span class="w"> </span><span class="nv">PERT</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">OUT</span><span class="o">=</span>xympqks<span class="w"> </span><span class="nv">PSF</span><span class="o">=</span>./../psfs/STDPSF_WFC3UV_F606W.fits<span class="w"> </span>id8048dyq_flc.fits
<span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s1">&#39;id8048dyq_psf.fits&#39;</span><span class="p">,</span> <span class="n">psfs_dir</span><span class="o">+</span><span class="s1">&#39;id8048dyq_psf_pert2.fits&#39;</span><span class="p">)</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s1">&#39;id8048dyq_flc.xympqks&#39;</span><span class="p">,</span> <span class="s1">&#39;id8048dyq_flc_pert2.xympqks&#39;</span><span class="p">)</span>
<span class="n">clear_output</span><span class="p">()</span> <span class="c1"># Remove this line to see the hst1pass log.</span>
</pre></div>
</div>
</div>
</div>
<p>Read in the perturbed model and examine the residuals.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">psf_model_perturbed_2</span> <span class="o">=</span> <span class="n">data_dir</span><span class="o">+</span><span class="s1">&#39;id8048dyq_psf.fits&#39;</span>
<span class="n">model_uvis1</span> <span class="o">=</span> <span class="n">GriddedPSFModel</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">psf_model_perturbed_2</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;stdpsf&#39;</span><span class="p">,</span> <span class="n">detector_id</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># model_uvis2 = GriddedPSFModel.read(psf_model_perturbed_2, format=&#39;stdpsf&#39;, detector_id=1) # Would be used for UVIS 2.</span>
<span class="n">photometry</span><span class="p">,</span> <span class="n">psfphot</span> <span class="o">=</span> <span class="n">calculate_photometry</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">psf_model</span><span class="o">=</span><span class="n">model_uvis1</span><span class="p">)</span>
<span class="n">resid</span> <span class="o">=</span> <span class="n">psfphot</span><span class="o">.</span><span class="n">make_residual_image</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">psf_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">plot_psf_results</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">resid</span><span class="p">,</span> <span class="mi">1818</span><span class="p">,</span> <span class="mi">986</span><span class="p">,</span> <span class="n">cutout_size</span><span class="p">)</span>
<span class="n">save_figure</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="n">plot_dir</span><span class="o">+</span><span class="s1">&#39;fig6_empirical_spatial.pdf&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">calculate_residuals</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">sources</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">PSF Photometry (before subtraction):</span>

 id  x_fit   y_fit  flux_fit  qfit
--- ------- ------- -------- -----
  1 1822.09  963.70 30722.70 0.123
  2 1836.67  986.76 29525.76 0.122
  3 1803.57 1003.39 57580.61 0.121
  4 1812.03 1004.05 29140.63 0.139
</pre></div>
</div>
<img alt="../../../_images/9bde25a73d743b783e587355301b9ec4ee6276b596cb1669892f09a96763c5d5.png" src="../../../_images/9bde25a73d743b783e587355301b9ec4ee6276b596cb1669892f09a96763c5d5.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Figure saved as: /home/runner/work/hst_notebooks/hst_notebooks/notebooks/WFC3/point_spread_function/plot/fig6_empirical_spatial.pdf

<span class=" -Color -Color-Bold">Aperture Photometry (after subtraction):</span>

 id xcenter ycenter aperture_sum total_background flux_background_sub
--- ------- ------- ------------ ---------------- -------------------
  1 1822.05  963.68      3087.55           989.01             2098.54
  2 1836.63  986.73      2891.86           970.57             1921.29
  3 1803.54 1003.36      5937.79          1303.54             4634.25
  4 1812.01 1004.03      4184.46          1276.73             2907.72 
</pre></div>
</div>
</div>
</div>
<p>Interestingly, the residual flux is minutely larger when using the spatially-dependent model with this dataset, which can be seen by comparing the <code class="docutils literal notranslate"><span class="pre">flux_background_sub</span></code> values for each star in the above tables. This is primarily due to the fact that there are an insufficient number of bright, isolated stars to accurately constrain the PSF model at each location on the detector. Thus, the best solution is produced by using <code class="docutils literal notranslate"><span class="pre">PERT=1</span></code> with hst1pass.</p>
<p>In summary, the default models will work well for many science cases. If there are substantial residuals, then hst1pass can apply a perturbation that slightly changes the PSF model shape to compensate for different focus positions (<code class="docutils literal notranslate"><span class="pre">PERT=1</span></code>). It is also possible to account for both the focus and spatial variation of the PSF across the detector (<code class="docutils literal notranslate"><span class="pre">PERT=2</span></code>). However, changes in the PSF due to focus are generally more significant than the spatial variations unless sources are close to the edges of the detector, and accounting for both effects requires a very large number of bright, isolated stars.</p>
<p>Finally, we copy the hst1pass catalog generated with <code class="docutils literal notranslate"><span class="pre">PERT=1</span></code> so the best catalog is used later in the stacking analysis. We also copy the catalog to the main directory so users who are unable to run hst1pass can complete the tutorial. Users can change this cell to experiment with catalogs made by running hst1pass with different settings.</p>
<p>This concludes the section on using empirical PSF models provided by the WFC3 team.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_dir</span><span class="o">+</span><span class="s1">&#39;id8048dyq_flc_pert1.xympqks&#39;</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data_dir</span><span class="o">+</span><span class="s1">&#39;id8048dyq_flc_pert1.xympqks&#39;</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">+</span><span class="s1">&#39;id8048dyq_flc.xympqks&#39;</span><span class="p">)</span> <span class="c1"># Used below for source selection.</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">code_dir</span><span class="o">+</span><span class="s1">&#39;id8048dyq_flc.xympqks&#39;</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">+</span><span class="s1">&#39;id8048dyq_flc.xympqks&#39;</span><span class="p">)</span> <span class="c1"># Included in the Github repository.</span>
</pre></div>
</div>
</div>
</div>
<p><a id="stacked"></a></p>
</section>
</section>
<section id="stacked-psf-models">
<h3>2.3 Stacked PSF Models<a class="headerlink" href="#stacked-psf-models" title="Permalink to this heading">#</a></h3>
<p><span class="xref myst">Table of Contents</span></p>
<hr class="docutils" />
<p>The empirical models used above that are provided by the WFC3 team can provide excellent fits at the exposure level for very accurate astrometry and photometry. However, these models have three limitations for specific science cases. First, the models are intentionally tapered to zero flux at large radii to prevent oversubtraction and fitting of noise at large radii, which means they cannot accurately capture very extended emission of bright sources. Second, while these models are available for the majority of commonly used filters on WFC3, models are not available for more specialized narrowband and quadrant filters. Third, these models are generated in the exposure frame, and so do not accurately represent the PSF in drizzled image mosaics, which will differ depending on how the drizzle was created.</p>
<p>With these considerations, we now explore extracting and stacking stars from both individual exposures and drizzled mosaics. Stacking a large number of sources allows for efficient outlier rejection and can produce a high quality PSF that extends to large radii, but can inherently smear or broaden the PSF at a miniscule level depending on how the sources are aligned. In this example, we will first extract stars from our image of Omega Cen and stack them to produce a PSF model. Next, we will examine the case where there are insufficient stars in an image, and retrieve stellar cutouts from the MAST database to construct a model. <strong>In this case the images have a very low background flux, but images with a high background would require users to background subtract their data and/or PSF model for proper fitting and photometric accuracy.</strong></p>
<p>In summary, users may wish to stack stars if 1) there is no empirical model available for their filter, 2) they are interested in extended wing emission and diffraction spikes, or 3) they need to generate a PSF model for a drizzled mosaic, including those with diffraction spikes at multiple angles. Users can stack stars extracted from their images, or use the MAST database cutout service to retrieve observations of a similar focus and quality for their science. We will use the hst1pass catalogs produced above for examples on the exposure level, which are the same as the centroids provided by the <a class="reference external" href="https://mast.stsci.edu/portal/Mashup/Clients/Mast/Portal.html">MAST</a> cutout service, but users can provide coordinates from an external catalog (e.g. SourceExtractor, photutils) if desired.</p>
<p><a id="stellar"></a></p>
<section id="stellar-stacks">
<h4>2.3.1 Stellar Stacks<a class="headerlink" href="#stellar-stacks" title="Permalink to this heading">#</a></h4>
<p><span class="xref myst">Table of Contents</span></p>
<hr class="docutils" />
<p>In this example, we use the hst1pass catalog to extract and stack stars from the FLC exposure of Omega Centauri. The hst1pass catalog columns are described in Section 2.3 of <a class="reference external" href="https://www.stsci.edu/~jayander/JWST1PASS/DOCs/ISR_HST1PASS.pdf">WFC3 ISR 2022-05</a> and include <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> detector coordinates, <code class="docutils literal notranslate"><span class="pre">m</span></code>:magnitude, <code class="docutils literal notranslate"><span class="pre">p</span></code>:peak flux, <code class="docutils literal notranslate"><span class="pre">q</span></code>:quality of fit, <code class="docutils literal notranslate"><span class="pre">k</span></code>:chip number, and <code class="docutils literal notranslate"><span class="pre">s</span></code>:sky value. We note that running hst1pass is not required, and users can use an external catalog generated with photutils or other packages provided the catalog contains accurate <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> coordinates. An example of this is shown in the section on <span class="xref myst">Drizzle PSF Models</span>.</p>
<p>We first read the hst1pass catalog and select bright stars with excellent qfit values on chip two. We also require a low sky value to remove some cutouts with many neighboring stars, and create a buffer around the edges of the detector so all cutouts contain a full array of data. The <code class="docutils literal notranslate"><span class="pre">rpix</span></code> parameter sets the radius of the cutout in pixels. For example, <code class="docutils literal notranslate"><span class="pre">rpix</span> <span class="pre">=</span> <span class="pre">19</span></code> produces a 39x39 pixel PSF model, corresponding to a size of 1.54<span class="math notranslate nohighlight">\(\times\)</span>1.54 arcseconds.</p>
<div class="alert alert-block alert-warning"><b>NOTE:</b> Users who are unable to run hst1pass can continue the tutorial using the included catalog file id8048dyq_flc.xympqks that is automatically copied to the data_dir. </div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read the hst1pass catalog and select stars.</span>
<span class="n">hst1pass_cat</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">data_dir</span><span class="o">+</span><span class="s1">&#39;id8048dyq_flc.xympqks&#39;</span><span class="p">,</span> 
                          <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> 
                          <span class="n">guess</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                          <span class="n">fast_reader</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                          <span class="n">data_start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                          <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The original catalog has&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hst1pass_cat</span><span class="p">),</span> <span class="s1">&#39;entries.&#39;</span><span class="p">)</span>

<span class="n">rpix</span> <span class="o">=</span> <span class="mi">19</span> <span class="c1"># Set the radius in pixels for the cutouts and resulting PSF.</span>

<span class="c1"># Select sources with specific brightness, qfit, and location criteria.</span>
<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">hst1pass_cat</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">rpix</span><span class="p">)</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">hst1pass_cat</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">4096.0</span><span class="o">-</span><span class="n">rpix</span><span class="p">)</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">hst1pass_cat</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">rpix</span><span class="p">)</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">hst1pass_cat</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">2048.0</span><span class="o">-</span><span class="n">rpix</span><span class="p">)</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">hst1pass_cat</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">10000.0</span><span class="p">)</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">hst1pass_cat</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">63300.0</span><span class="p">)</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">hst1pass_cat</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.035</span><span class="p">)</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">hst1pass_cat</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">hst1pass_cat</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">100.0</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">hst1pass_cat</span> <span class="o">=</span> <span class="n">hst1pass_cat</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

<span class="n">star_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hst1pass_cat</span><span class="p">)))</span>

<span class="n">hst1pass_cat</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The original catalog has 2397 entries.
</pre></div>
</div>
<div class="output text_html"><div><i>Table length=34</i>
<table id="table140642011025808" class="table-striped table-bordered table-condensed">
<thead><tr><th>x</th><th>y</th><th>m</th><th>p</th><th>q</th><th>k</th><th>s</th></tr></thead>
<thead><tr><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>int64</th><th>float64</th></tr></thead>
<tr><td>1286.7318</td><td>32.5184</td><td>-13.268</td><td>21134.07</td><td>0.025</td><td>2</td><td>16.4</td></tr>
<tr><td>929.775</td><td>33.3364</td><td>-12.665</td><td>14191.36</td><td>0.023</td><td>2</td><td>16.39</td></tr>
<tr><td>1241.7439</td><td>60.5701</td><td>-14.294</td><td>55280.03</td><td>0.024</td><td>2</td><td>29.08</td></tr>
<tr><td>911.0856</td><td>64.5218</td><td>-13.009</td><td>18216.32</td><td>0.027</td><td>2</td><td>13.52</td></tr>
<tr><td>731.933</td><td>73.6137</td><td>-12.53</td><td>12454.2</td><td>0.033</td><td>2</td><td>15.09</td></tr>
<tr><td>1187.3088</td><td>135.9943</td><td>-13.123</td><td>21676.56</td><td>0.031</td><td>2</td><td>15.37</td></tr>
<tr><td>444.3915</td><td>242.3671</td><td>-14.106</td><td>46620.75</td><td>0.03</td><td>2</td><td>29.63</td></tr>
<tr><td>755.6099</td><td>291.1403</td><td>-13.051</td><td>20003.39</td><td>0.025</td><td>2</td><td>15.43</td></tr>
<tr><td>305.463</td><td>393.9442</td><td>-13.474</td><td>29141.48</td><td>0.028</td><td>2</td><td>15.78</td></tr>
<tr><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
<tr><td>790.3328</td><td>1556.8351</td><td>-12.878</td><td>17708.8</td><td>0.03</td><td>2</td><td>14.56</td></tr>
<tr><td>527.3823</td><td>1618.9103</td><td>-12.904</td><td>18090.87</td><td>0.027</td><td>2</td><td>16.95</td></tr>
<tr><td>474.7753</td><td>1697.0492</td><td>-12.765</td><td>16793.74</td><td>0.035</td><td>2</td><td>14.77</td></tr>
<tr><td>931.1865</td><td>1793.3379</td><td>-12.479</td><td>11992.43</td><td>0.032</td><td>2</td><td>15.93</td></tr>
<tr><td>958.9084</td><td>1837.1936</td><td>-13.257</td><td>26489.8</td><td>0.034</td><td>2</td><td>16.6</td></tr>
<tr><td>1210.0345</td><td>1857.8748</td><td>-12.383</td><td>12469.67</td><td>0.03</td><td>2</td><td>15.13</td></tr>
<tr><td>660.1707</td><td>1879.8505</td><td>-12.358</td><td>11823.76</td><td>0.034</td><td>2</td><td>10.48</td></tr>
<tr><td>976.6851</td><td>1930.8593</td><td>-13.243</td><td>24624.58</td><td>0.032</td><td>2</td><td>19.3</td></tr>
<tr><td>315.5191</td><td>2009.2579</td><td>-12.381</td><td>10412.01</td><td>0.025</td><td>2</td><td>16.62</td></tr>
<tr><td>1206.7129</td><td>2013.9739</td><td>-12.821</td><td>17920.06</td><td>0.031</td><td>2</td><td>16.08</td></tr>
</table></div></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">make_cutouts</span></code> function uses the science image and catalog coordinates to extract cutouts of the stars meeting the criteria set by the mask in the cell above. The <code class="docutils literal notranslate"><span class="pre">scale_stars</span></code> option will normalize the flux of each star, which is generally recommended for proper averaging. The <code class="docutils literal notranslate"><span class="pre">sub_pixel</span></code> option uses the user-supplied <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> coordinates to align the cutouts at the subpixel level and should always be used except for testing. When <code class="docutils literal notranslate"><span class="pre">verbose</span></code> is True, additional diagnostic messages will be printed. Specifically, after performing the subpixel alignment, the function will calculate the center of mass using the inner five pixels. This value should generally be very close to the user-suppled <code class="docutils literal notranslate"><span class="pre">rpix</span></code> value, but will deviate minutely depending on how the <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> centroids were calculated.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">star_cutouts</span> <span class="o">=</span> <span class="n">make_cutouts</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">sci_data</span><span class="p">,</span> 
                            <span class="n">star_ids</span><span class="o">=</span><span class="n">star_ids</span><span class="p">,</span> 
                            <span class="n">xis</span><span class="o">=</span><span class="n">hst1pass_cat</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> 
                            <span class="n">yis</span><span class="o">=</span><span class="n">hst1pass_cat</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> 
                            <span class="n">rpix</span><span class="o">=</span><span class="n">rpix</span><span class="p">,</span> 
                            <span class="n">scale_stars</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                            <span class="n">sub_pixel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                            <span class="n">show_figs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                            <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">clear_output</span><span class="p">()</span> <span class="c1"># Remove this line to see all 34 cutouts.</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">stack_cutouts</span></code> function then combines the array of cutouts into a single mean or median stack, with the option to normalize the flux. In general, using a <code class="docutils literal notranslate"><span class="pre">stack_type</span></code> of median is recommended to reject contaminating sources. Similarly, setting <code class="docutils literal notranslate"><span class="pre">scale_flux</span></code> to True is recommended so that all sources have normalized fluxes, which prevents biased weighting by S/N and produces a normalized PSF, which is typically required by many photometric tools.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">star_stack</span> <span class="o">=</span> <span class="n">stack_cutouts</span><span class="p">(</span><span class="n">star_cutouts</span><span class="p">,</span> 
                           <span class="n">rpix</span><span class="o">=</span><span class="n">rpix</span><span class="p">,</span> 
                           <span class="n">stack_type</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> 
                           <span class="n">scale_flux</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                           <span class="n">export_file</span><span class="o">=</span><span class="n">psfs_dir</span><span class="o">+</span><span class="s1">&#39;hst_wfc3_uvis_f606w_star_psf_model.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Calling stack_cutouts with 34 sources.

Creating a median image stack.
Scaling the total flux to one.
The total image flux is = 1.0
</pre></div>
</div>
<img alt="../../../_images/38480bb1828759fe2f0c1f7a862ba7c377525ee9007aa4d291819b4519efabfa.png" src="../../../_images/38480bb1828759fe2f0c1f7a862ba7c377525ee9007aa4d291819b4519efabfa.png" />
</div>
</div>
<p>Finally, we provide our stacked model to the photutils <a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.psf.FittableImageModel.html">FittableImageModel</a> function, which allows it to be used with the PSF fitter. While the core emission was better fit using the empirical models in the previous section, using the stacked model that is not tapered to zero flux allows us to fit out to large radii, which is set to 19 pixels below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">star_stack_psf</span> <span class="o">=</span> <span class="n">FittableImageModel</span><span class="p">(</span><span class="n">star_stack</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">photometry</span><span class="p">,</span> <span class="n">psfphot</span> <span class="o">=</span> <span class="n">calculate_photometry</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">psf_model</span><span class="o">=</span><span class="n">star_stack_psf</span><span class="p">)</span>
<span class="n">resid</span> <span class="o">=</span> <span class="n">psfphot</span><span class="o">.</span><span class="n">make_residual_image</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">psf_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="mi">19</span><span class="p">))</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">plot_psf_results</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">resid</span><span class="p">,</span> <span class="mi">1818</span><span class="p">,</span> <span class="mi">986</span><span class="p">,</span> <span class="n">cutout_size</span><span class="p">)</span>
<span class="n">save_figure</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="n">plot_dir</span><span class="o">+</span><span class="s1">&#39;fig7_star_stack.pdf&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">calculate_residuals</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">sources</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">PSF Photometry (before subtraction):</span>

 id  x_fit   y_fit  flux_fit  qfit
--- ------- ------- -------- -----
  1 1822.07  963.70 38502.79 0.089
  2 1836.67  986.76 37021.88 0.089
  3 1803.57 1003.38 72023.97 0.083
  4 1812.01 1004.04 36210.23 0.094
</pre></div>
</div>
<img alt="../../../_images/dc90bbdfbdd01ee21e9d6f9695acc1109b980ad493da623c5e739d4d7e13528d.png" src="../../../_images/dc90bbdfbdd01ee21e9d6f9695acc1109b980ad493da623c5e739d4d7e13528d.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Figure saved as: /home/runner/work/hst_notebooks/hst_notebooks/notebooks/WFC3/point_spread_function/plot/fig7_star_stack.pdf

<span class=" -Color -Color-Bold">Aperture Photometry (after subtraction):</span>

 id xcenter ycenter aperture_sum total_background flux_background_sub
--- ------- ------- ------------ ---------------- -------------------
  1 1822.05  963.68      1629.97           726.81              903.16
  2 1836.63  986.73      1477.78           725.84              751.94
  3 1803.54 1003.36      2666.58           750.59             1915.99
  4 1812.01 1004.03      1520.94           769.32              751.61 
</pre></div>
</div>
</div>
</div>
<p><a id="mast"></a></p>
</section>
<section id="mast-stacks">
<h4>2.3.2 MAST Stacks<a class="headerlink" href="#mast-stacks" title="Permalink to this heading">#</a></h4>
<p><span class="xref myst">Table of Contents</span></p>
<hr class="docutils" />
<p>The example above demonstrates how to extract and stack stars from a provided exposure. However, in many cases there may be an insufficient number of stars to create a high-quality median stack. In those cases, users can utilize the MAST cutout database described in <a class="reference external" href="https://www.stsci.edu/files/live/sites/www/files/home/hst/instrumentation/wfc3/documentation/instrument-science-reports-isrs/_documents/2021/ISR_2021_12.pdf">WFC3 ISR 2021-12</a>, with access instructions provided on the <a class="reference external" href="https://www.stsci.edu/hst/instrumentation/wfc3/data-analysis/psf/psf-search">PSF Search webpage</a>. The MAST API commands are listed on <a class="reference external" href="https://mast.stsci.edu/api/v0/pyex.html#MastCatalogsFilteredWfc3PsfUvisPy">this webpage</a>, with parameter options on <a class="reference external" href="https://mast.stsci.edu/api/v0/_w_f_c3__p_s_ffields.html">this webpage</a>. The examples below utilize sections of code from the <code class="docutils literal notranslate"><span class="pre">download_psf_cutouts.ipynb</span></code> developed by Dauphin et al. (2024) that is available on <a class="reference external" href="https://spacetelescope.github.io/hst_notebooks/notebooks/WFC3/mast_api_psf/download_psf_cutouts.html">Github</a>. In this case, we set limits on the x and y detector locations, quality of fit, exposure time, isolation index, integrated flux (in electrons for WFC3/UVIS and WFPC2, and in electrons per second for WFC3/IR), the central pixel flux, sky flux, and exclude subarrays. The stellar centroids provided in the MAST database were calculated using hst1pass and the empirical PSF models described in <span class="xref myst">Section 2.2</span>. See <a class="reference external" href="https://www.stsci.edu/files/live/sites/www/files/home/hst/instrumentation/wfc3/documentation/instrument-science-reports-isrs/_documents/2021/ISR_2021_12.pdf">WFC3 ISR 2021-12</a> for additional information.</p>
<div class="alert alert-block alert-info"><b>NOTE:</b> We explicitly assume that users have familiarized themselves with the contents of the "download_psf_cutouts.ipynb" notebook for this section. </div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">code_dir</span><span class="p">)</span>

<span class="c1"># Searching a larger radius around the cutout for a sufficient number of stars.</span>
<span class="n">x_min_max</span> <span class="o">=</span> <span class="n">mast_api_psf</span><span class="o">.</span><span class="n">set_min_max</span><span class="p">(</span><span class="mi">1818</span><span class="o">-</span><span class="n">cutout_size</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1818</span><span class="o">+</span><span class="n">cutout_size</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
<span class="n">y_min_max</span> <span class="o">=</span> <span class="n">mast_api_psf</span><span class="o">.</span><span class="n">set_min_max</span><span class="p">(</span><span class="mi">986</span><span class="o">-</span><span class="n">cutout_size</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="mi">986</span><span class="o">+</span><span class="n">cutout_size</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
<span class="n">qfit_min_max</span> <span class="o">=</span> <span class="n">mast_api_psf</span><span class="o">.</span><span class="n">set_min_max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
<span class="n">exp_time</span> <span class="o">=</span> <span class="n">mast_api_psf</span><span class="o">.</span><span class="n">set_min_max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30000</span><span class="p">)</span>
<span class="n">iso_index</span> <span class="o">=</span> <span class="n">mast_api_psf</span><span class="o">.</span><span class="n">set_min_max</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
<span class="n">psf_flux</span> <span class="o">=</span> <span class="n">mast_api_psf</span><span class="o">.</span><span class="n">set_min_max</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1000000000</span><span class="p">)</span> <span class="c1"># This is an integrated value so set an arbitarily large upper bound.</span>
<span class="n">pixc</span> <span class="o">=</span> <span class="n">mast_api_psf</span><span class="o">.</span><span class="n">set_min_max</span><span class="p">(</span><span class="mi">59000</span><span class="p">,</span> <span class="mi">63300</span><span class="p">)</span>
<span class="n">sky_flux</span> <span class="o">=</span> <span class="n">mast_api_psf</span><span class="o">.</span><span class="n">set_min_max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">focus</span> <span class="o">=</span> <span class="n">mast_api_psf</span><span class="o">.</span><span class="n">set_min_max</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="c1"># Change these values to see the effects of focus.</span>
<span class="n">subarray</span> <span class="o">=</span> <span class="n">mast_api_psf</span><span class="o">.</span><span class="n">set_min_max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">detector</span> <span class="o">=</span> <span class="s1">&#39;UVIS&#39;</span>

<span class="c1"># Set the parameters, noting that the last four are not set above.</span>
<span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;psf_x_center&#39;</span><span class="p">:</span> <span class="n">x_min_max</span><span class="p">,</span> 
    <span class="s1">&#39;psf_y_center&#39;</span><span class="p">:</span> <span class="n">y_min_max</span><span class="p">,</span> 
    <span class="s1">&#39;qfit&#39;</span><span class="p">:</span> <span class="n">qfit_min_max</span><span class="p">,</span> 
    <span class="s1">&#39;exptime&#39;</span><span class="p">:</span> <span class="n">exp_time</span><span class="p">,</span> 
    <span class="s1">&#39;iso_index&#39;</span><span class="p">:</span> <span class="n">iso_index</span><span class="p">,</span> 
    <span class="s1">&#39;psf_flux&#39;</span><span class="p">:</span> <span class="n">psf_flux</span><span class="p">,</span> 
    <span class="s1">&#39;pixc&#39;</span><span class="p">:</span> <span class="n">pixc</span><span class="p">,</span> 
    <span class="s1">&#39;sky&#39;</span><span class="p">:</span> <span class="n">sky_flux</span><span class="p">,</span> 
    <span class="s1">&#39;focus&#39;</span><span class="p">:</span> <span class="n">focus</span><span class="p">,</span> 
    <span class="s1">&#39;subarray&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">],</span>
    <span class="s1">&#39;n_sat_pixels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">],</span> 
    <span class="s1">&#39;filter&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;F606W&#39;</span><span class="p">],</span> 
    <span class="s1">&#39;mtflag&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">],</span>
<span class="p">}</span>

<span class="n">filts</span> <span class="o">=</span> <span class="n">mast_api_psf</span><span class="o">.</span><span class="n">set_filters</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
<span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;rootname&#39;</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="s1">&#39;chip&#39;</span><span class="p">,</span> <span class="s1">&#39;exptime&#39;</span><span class="p">,</span> <span class="s1">&#39;psf_x_center&#39;</span><span class="p">,</span> <span class="s1">&#39;psf_y_center&#39;</span><span class="p">,</span> <span class="s1">&#39;pixc&#39;</span><span class="p">,</span> <span class="s1">&#39;sky&#39;</span><span class="p">,</span> <span class="s1">&#39;qfit&#39;</span><span class="p">,</span> <span class="s1">&#39;iso_index&#39;</span><span class="p">,</span> <span class="s1">&#39;subarray&#39;</span><span class="p">,</span> <span class="s1">&#39;x_raw&#39;</span><span class="p">,</span> <span class="s1">&#39;y_raw&#39;</span><span class="p">,</span> <span class="s1">&#39;x_cal&#39;</span><span class="p">,</span> <span class="s1">&#39;y_cal&#39;</span><span class="p">]</span>
<span class="n">obs</span> <span class="o">=</span> <span class="n">mast_api_psf</span><span class="o">.</span><span class="n">mast_query_psf_database</span><span class="p">(</span><span class="n">detector</span><span class="o">=</span><span class="n">detector</span><span class="p">,</span> <span class="n">filts</span><span class="o">=</span><span class="n">filts</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
<span class="n">obs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><i>Table masked=True length=50</i>
<table id="table140642650534544" class="table-striped table-bordered table-condensed">
<thead><tr><th>id</th><th>rootname</th><th>filter</th><th>chip</th><th>exptime</th><th>psf_x_center</th><th>psf_y_center</th><th>pixc</th><th>sky</th><th>qfit</th><th>iso_index</th><th>subarray</th><th>x_raw</th><th>y_raw</th><th>x_cal</th><th>y_cal</th></tr></thead>
<thead><tr><th>int64</th><th>str9</th><th>str5</th><th>str1</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>int64</th><th>int64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>21965947</td><td>icc303kcq</td><td>F606W</td><td>2</td><td>560.0</td><td>1958.563</td><td>930.7289</td><td>63243.29</td><td>45.94</td><td>0.042</td><td>24</td><td>0</td><td>1982.563</td><td>929.7289</td><td>1957.563</td><td>929.7289</td></tr>
<tr><td>24704924</td><td>icqx12bmq</td><td>F606W</td><td>2</td><td>40.0</td><td>1940.4401</td><td>1052.1364</td><td>59501.67</td><td>46.45</td><td>0.043</td><td>24</td><td>0</td><td>1964.4401</td><td>1051.1364</td><td>1939.4401</td><td>1051.1364</td></tr>
<tr><td>24883910</td><td>icqx02bvq</td><td>F606W</td><td>2</td><td>40.0</td><td>2026.3932</td><td>772.9385</td><td>62638.16</td><td>47.94</td><td>0.043</td><td>24</td><td>0</td><td>2050.3932</td><td>771.9385</td><td>2025.3932</td><td>771.9385</td></tr>
<tr><td>26385576</td><td>ibc602v7q</td><td>F606W</td><td>2</td><td>360.0</td><td>2116.5151</td><td>1143.5637</td><td>63022.99</td><td>32.91</td><td>0.05</td><td>24</td><td>0</td><td>2200.5151</td><td>1142.5637</td><td>2115.5151</td><td>1142.5637</td></tr>
<tr><td>22392319</td><td>iexu12wsq</td><td>F606W</td><td>2</td><td>348.0</td><td>1604.7406</td><td>1343.4912</td><td>60461.44</td><td>36.34</td><td>0.047</td><td>24</td><td>0</td><td>1628.7406</td><td>1342.4912</td><td>1603.7406</td><td>1342.4912</td></tr>
<tr><td>20334003</td><td>ibm503jzq</td><td>F606W</td><td>2</td><td>40.0</td><td>2114.4614</td><td>689.2773</td><td>62039.21</td><td>49.11</td><td>0.034</td><td>24</td><td>0</td><td>2198.4614</td><td>688.2773</td><td>2113.4614</td><td>688.2773</td></tr>
<tr><td>26113796</td><td>ibnh13h2q</td><td>F606W</td><td>2</td><td>348.0</td><td>1727.7864</td><td>708.8348</td><td>61216.02</td><td>34.74</td><td>0.042</td><td>24</td><td>0</td><td>1751.7864</td><td>707.8348</td><td>1726.7864</td><td>707.8348</td></tr>
<tr><td>20504234</td><td>iedx05r0q</td><td>F606W</td><td>2</td><td>415.0</td><td>2122.1753</td><td>1326.8822</td><td>62098.94</td><td>33.2</td><td>0.035</td><td>24</td><td>0</td><td>2206.1753</td><td>1325.8822</td><td>2121.1753</td><td>1325.8822</td></tr>
<tr><td>22694839</td><td>icc303kjq</td><td>F606W</td><td>2</td><td>570.0</td><td>1958.4135</td><td>930.4946</td><td>62666.45</td><td>48.78</td><td>0.029</td><td>24</td><td>0</td><td>1982.4135</td><td>929.4946</td><td>1957.4135</td><td>929.4946</td></tr>
<tr><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
<tr><td>21918234</td><td>iedx01anq</td><td>F606W</td><td>2</td><td>407.0</td><td>1800.5421</td><td>739.1125</td><td>61941.66</td><td>38.65</td><td>0.037</td><td>24</td><td>0</td><td>1824.5421</td><td>738.1125</td><td>1799.5421</td><td>738.1125</td></tr>
<tr><td>26755911</td><td>ibc302jcq</td><td>F606W</td><td>2</td><td>40.0</td><td>1889.7075</td><td>943.8731</td><td>61900.36</td><td>39.15</td><td>0.015</td><td>24</td><td>0</td><td>1913.7075</td><td>942.8731</td><td>1888.7075</td><td>942.8731</td></tr>
<tr><td>22056475</td><td>ic8x01mfq</td><td>F606W</td><td>2</td><td>50.0</td><td>2191.8518</td><td>1087.7273</td><td>59502.78</td><td>31.68</td><td>0.035</td><td>24</td><td>0</td><td>2275.8518</td><td>1086.7273</td><td>2190.8518</td><td>1086.7273</td></tr>
<tr><td>25899670</td><td>ibcd40kvq</td><td>F606W</td><td>2</td><td>450.0</td><td>1827.2809</td><td>776.5402</td><td>61432.53</td><td>32.99</td><td>0.043</td><td>24</td><td>0</td><td>1851.2809</td><td>775.5402</td><td>1826.2809</td><td>775.5402</td></tr>
<tr><td>20277208</td><td>ib2o01ssq</td><td>F606W</td><td>2</td><td>600.0</td><td>1942.1887</td><td>944.2888</td><td>59100.43</td><td>45.41</td><td>0.048</td><td>24</td><td>0</td><td>1966.1887</td><td>943.2888</td><td>1941.1887</td><td>943.2888</td></tr>
<tr><td>23179989</td><td>ibc302j7q</td><td>F606W</td><td>2</td><td>40.0</td><td>1533.0767</td><td>983.4271</td><td>60506.57</td><td>45.06</td><td>0.028</td><td>24</td><td>0</td><td>1557.0767</td><td>982.4271</td><td>1532.0767</td><td>982.4271</td></tr>
<tr><td>23821761</td><td>iddk01mbq</td><td>F606W</td><td>2</td><td>40.0</td><td>1730.7775</td><td>732.3746</td><td>61253.79</td><td>36.33</td><td>0.043</td><td>24</td><td>0</td><td>1754.7775</td><td>731.3746</td><td>1729.7775</td><td>731.3746</td></tr>
<tr><td>25454731</td><td>icqx12bbq</td><td>F606W</td><td>2</td><td>40.0</td><td>1940.3081</td><td>1052.2091</td><td>62857.78</td><td>42.5</td><td>0.043</td><td>24</td><td>0</td><td>1964.3081</td><td>1051.2091</td><td>1939.3081</td><td>1051.2091</td></tr>
<tr><td>26765366</td><td>ic3f22meq</td><td>F606W</td><td>2</td><td>50.0</td><td>1832.6663</td><td>1161.4025</td><td>61014.33</td><td>32.28</td><td>0.045</td><td>24</td><td>0</td><td>1856.6663</td><td>1160.4025</td><td>1831.6663</td><td>1160.4025</td></tr>
<tr><td>28058025</td><td>id1x15wcq</td><td>F606W</td><td>2</td><td>40.0</td><td>1881.6022</td><td>1333.9424</td><td>61112.78</td><td>49.87</td><td>0.05</td><td>24</td><td>0</td><td>1905.6022</td><td>1332.9424</td><td>1880.6022</td><td>1332.9424</td></tr>
</table></div></div></div>
</div>
<p>As described and detailed in the <a class="reference external" href="https://spacetelescope.github.io/hst_notebooks/notebooks/WFC3/mast_api_psf/download_psf_cutouts.html"><code class="docutils literal notranslate"><span class="pre">download_psf_cutouts.ipynb</span></code></a>, the below cell constructs the filepaths for the cutouts, requests to download them from the MAST cutout service, and then extracts the files from a compressed tar folder. Finally, the filepaths for each cutout are saved to a list in <code class="docutils literal notranslate"><span class="pre">path_data</span></code> and passed to an array.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
<span class="n">file_suffix</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;flc&#39;</span><span class="p">]</span>
<span class="n">dataURIs</span> <span class="o">=</span> <span class="n">mast_api_psf</span><span class="o">.</span><span class="n">make_dataURIs</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">detector</span><span class="o">=</span><span class="n">detector</span><span class="p">,</span> <span class="n">file_suffix</span><span class="o">=</span><span class="n">file_suffix</span><span class="p">)</span>
<span class="n">filename</span> <span class="o">=</span> <span class="n">mast_api_psf</span><span class="o">.</span><span class="n">download_request_bundle</span><span class="p">(</span><span class="n">dataURIs</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;mastDownload.tar.gz&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r:gz&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
    <span class="n">path_mast</span> <span class="o">=</span> <span class="n">tar</span><span class="o">.</span><span class="n">getnames</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
<span class="n">path_data</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path_mast</span><span class="si">}</span><span class="s1">/*/*&#39;</span><span class="p">))</span>
<span class="n">mast_cutouts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">path_data</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/50 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 50/50 [00:00&lt;00:00, 11792.35it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<p>Next we visually inspect all of the downloaded cutouts, where each panel shows the cutout, and any additional sources identified at &gt; 10<span class="math notranslate nohighlight">\(\sigma\)</span> above the background in green circles. Users may wish to manually or automatically filter the results to create a sample with fewer contaminants.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
<span class="n">plot_cutout_grid</span><span class="p">(</span><span class="n">cutouts</span><span class="o">=</span><span class="n">mast_cutouts</span><span class="p">,</span> <span class="n">path_data</span><span class="o">=</span><span class="n">path_data</span><span class="p">,</span> <span class="n">max_cutouts</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">save_figure</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="n">plot_dir</span><span class="o">+</span><span class="s1">&#39;fig8_mast_grid.pdf&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/cb5db51509ae5a2be6ffd7de1131a14f1150f8275efaf3bcb074dd7f9a49f83b.png" src="../../../_images/cb5db51509ae5a2be6ffd7de1131a14f1150f8275efaf3bcb074dd7f9a49f83b.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Figure saved as: /home/runner/work/hst_notebooks/hst_notebooks/notebooks/WFC3/point_spread_function/plot/fig8_mast_grid.pdf
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mast_stack</span> <span class="o">=</span> <span class="n">stack_cutouts</span><span class="p">(</span><span class="n">mast_cutouts</span><span class="p">,</span> 
                           <span class="n">rpix</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> 
                           <span class="n">stack_type</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> 
                           <span class="n">scale_flux</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                           <span class="n">export_file</span><span class="o">=</span><span class="n">psfs_dir</span><span class="o">+</span><span class="s1">&#39;hst_wfc3_uvis_f606w_mast_psf_model.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Calling stack_cutouts with 50 sources.

Creating a median image stack.
Scaling the total flux to one.
The total image flux is = 1.0
</pre></div>
</div>
<img alt="../../../_images/bd395e76a10f28d60a3ad60f634563e87919e4039c68a2e3bd4b56efaf920e81.png" src="../../../_images/bd395e76a10f28d60a3ad60f634563e87919e4039c68a2e3bd4b56efaf920e81.png" />
</div>
</div>
<p>We now use this model to perform PSF fitting and subtraction on the science image. We see that the cutouts retrieved and stacked from MAST only marginally fit the shapes of the stars in this particular exposure, similar to the results that we obtained with the empirical model before perturbation. The model could be revised by querying the MAST cutout service with different parameters and/or carefully selecting cutouts based on their FWHM. The optimal workflow will depend on the data and science goals.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mast_stack_psf</span> <span class="o">=</span> <span class="n">FittableImageModel</span><span class="p">(</span><span class="n">mast_stack</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">photometry</span><span class="p">,</span> <span class="n">psfphot</span> <span class="o">=</span> <span class="n">calculate_photometry</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">psf_model</span><span class="o">=</span><span class="n">mast_stack_psf</span><span class="p">)</span>
<span class="n">resid</span> <span class="o">=</span> <span class="n">psfphot</span><span class="o">.</span><span class="n">make_residual_image</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">psf_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">plot_psf_results</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">resid</span><span class="p">,</span> <span class="mi">1818</span><span class="p">,</span> <span class="mi">986</span><span class="p">,</span> <span class="n">cutout_size</span><span class="p">)</span>
<span class="n">save_figure</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="n">plot_dir</span><span class="o">+</span><span class="s1">&#39;fig9_mast_stack.pdf&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">calculate_residuals</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">sources</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">PSF Photometry (before subtraction):</span>

 id  x_fit   y_fit  flux_fit  qfit
--- ------- ------- -------- -----
  1 1822.19  963.62 34783.39 0.260
  2 1836.74  986.68 33352.77 0.261
  3 1803.63 1003.33 64960.87 0.262
  4 1812.14 1003.96 32572.61 0.277
</pre></div>
</div>
<img alt="../../../_images/d856cbb179f826cfbbc3eced158037e9d0ef11a7e704fb79ce7ae822d1142627.png" src="../../../_images/d856cbb179f826cfbbc3eced158037e9d0ef11a7e704fb79ce7ae822d1142627.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Figure saved as: /home/runner/work/hst_notebooks/hst_notebooks/notebooks/WFC3/point_spread_function/plot/fig9_mast_stack.pdf

<span class=" -Color -Color-Bold">Aperture Photometry (after subtraction):</span>

 id xcenter ycenter aperture_sum total_background flux_background_sub
--- ------- ------- ------------ ---------------- -------------------
  1 1822.05  963.68      7460.07           989.01             6471.06
  2 1836.63  986.73      7154.81           970.57             6184.25
  3 1803.54 1003.36     14306.37          1322.93            12983.43
  4 1812.01 1004.03      8927.04          1261.96             7665.08 
</pre></div>
</div>
</div>
</div>
<p><a id="drizzles"></a></p>
</section>
</section>
</section>
<section id="drizzle-psf-models">
<h2>3. Drizzle PSF Models<a class="headerlink" href="#drizzle-psf-models" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Table of Contents</span></p>
<hr class="docutils" />
<p>The examples in Section 2 apply to PSF modeling at the exposure level. However, in many cases with faint astronomical sources, multiple exposures are combined through drizzling to yield an image mosaic with increased signal-to-noise that is free from artifacts such as cosmic rays and hot pixels. This process changes the shape of the PSF due to resampling, so dedicated models are required. The process of drizzling is beyond the scope of this notebook, and users can find more information on the <a class="reference external" href="https://www.stsci.edu/scientific-community/software/drizzlepac">DrizzlePac Website</a>, including a series of <a class="reference external" href="https://spacetelescope.github.io/hst_notebooks/notebooks/DrizzlePac/README.html">tutorial notebooks</a> available on <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/tree/main/notebooks/DrizzlePac">Github</a> with useful examples, and a brief explanation <a class="reference external" href="https://www.stsci.edu/~fruchter/dither/drizzle.html?fbclid=IwAR3mrcUR7kxAZuDk7l6GUQtuJKrs-ecvv5YHSmWYfM64EgXP3unqp02Rdpk">here</a>. In this case, it is sufficient to note that drizzling allows us to account for undersampling of the WFC3 detectors to recover the full spatial resolution of HST, and account for distortion across the field of view to provide a flux-conserved, geometrically rectified mosaic generated from the individual exposures. In this case, we combine three F606W exposures covering the same area of Omega Cen, and focused on the same four stars shown in <span class="xref myst">Section 1.4</span>.</p>
<p><a id="create"></a></p>
<section id="create-drizzle">
<h3>3.1 Create Drizzle<a class="headerlink" href="#create-drizzle" title="Permalink to this heading">#</a></h3>
<p><span class="xref myst">Table of Contents</span></p>
<hr class="docutils" />
<p>In the cell below, we first download the three F606W exposures and copy them to a new directory because their headers will be modified in the alignment and drizzling process. Next, we use <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> to find sources in common between the images and align them to the first exposure. See the <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> <a class="reference external" href="https://drizzlepac.readthedocs.io/en/deployment/tweakreg.html">readthedocs</a> for more information on each parameter. Note also that users can utilize hst1pass catalogs of their FLC files to perform high-accuracy alignments if there are a sufficient number of stars.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>

<span class="n">tweak_files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;id8048e0q_flc.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;id8048dyq_flc.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;id8048e3q_flc.fits&#39;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">tweak_file</span> <span class="ow">in</span> <span class="n">tweak_files</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Copying&#39;</span><span class="p">,</span> <span class="n">tweak_file</span><span class="p">)</span>
    <span class="n">Observations</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;mast:HST/product/&#39;</span><span class="o">+</span><span class="n">tweak_file</span><span class="p">,</span> <span class="n">local_path</span><span class="o">=</span><span class="n">data_dir</span><span class="o">+</span><span class="n">tweak_file</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">tweak_file</span><span class="p">,</span> <span class="n">tweak_dir</span><span class="p">)</span>
    
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">tweak_dir</span><span class="p">)</span>

<span class="c1"># Call TweakReg.</span>
<span class="n">tweakreg</span><span class="o">.</span><span class="n">TweakReg</span><span class="p">(</span><span class="n">tweak_files</span><span class="p">,</span>
                  <span class="n">refimage</span><span class="o">=</span><span class="n">tweak_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                  <span class="n">expand_refcat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">clean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">updatehdr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">reusename</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">wcsname</span><span class="o">=</span><span class="s1">&#39;TWEAK&#39;</span><span class="p">,</span> 
                  <span class="n">descrip</span><span class="o">=</span><span class="s1">&#39;HST WFC3 PSF Notebook Example&#39;</span><span class="p">,</span>
                  <span class="n">catalog</span><span class="o">=</span><span class="n">tweak_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                  <span class="n">shiftfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">outshifts</span><span class="o">=</span><span class="s1">&#39;tweakreg_shifts.dat&#39;</span><span class="p">,</span>
                  <span class="n">minobj</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                  <span class="n">searchrad</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
                  <span class="n">searchunits</span><span class="o">=</span><span class="s1">&#39;arcseconds&#39;</span><span class="p">,</span>
                  <span class="n">fitgeometry</span><span class="o">=</span><span class="s1">&#39;rscale&#39;</span><span class="p">,</span>
                  <span class="n">nclip</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                  <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
                  <span class="n">imagefindcfg</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;peakmax&#39;</span><span class="p">:</span> <span class="mi">62000</span><span class="p">,</span> <span class="s1">&#39;use_sharp_round&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                  <span class="n">refimagefindcfg</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;peakmax&#39;</span><span class="p">:</span> <span class="mi">62000</span><span class="p">,</span> <span class="s1">&#39;use_sharp_round&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

<span class="n">clear_output</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/c103a3a45c0b35e2fca89fa3e2484ba0ffddc0b7df09e74858fbd718e418a60b.png" src="../../../_images/c103a3a45c0b35e2fca89fa3e2484ba0ffddc0b7df09e74858fbd718e418a60b.png" />
<img alt="../../../_images/420428a05b8b86850c57815b12c22b29303036178cfaf3d5790b95b8ff4f1a4c.png" src="../../../_images/420428a05b8b86850c57815b12c22b29303036178cfaf3d5790b95b8ff4f1a4c.png" />
<img alt="../../../_images/80dc9a2b47ebb10155312e11b2823769cd78eea6bef2de63e179e86043ee82bf.png" src="../../../_images/80dc9a2b47ebb10155312e11b2823769cd78eea6bef2de63e179e86043ee82bf.png" />
</div>
</div>
<p>Now, we examine the <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> residuals to confirm they are small. The columns are filename, shift in x, shift in y, rotation in degrees, plate scale, and the x and y RMS errors on the shift. In general, RMS values below <span class="math notranslate nohighlight">\(\approx\)</span> 0.1 pixels are desired for a quality alignment solution. A value of NaN indicates a failure and the search parameters must be adjusted.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">tweak_dir</span><span class="p">)</span>
<span class="n">shift_table</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;tweakreg_shifts.dat&#39;</span><span class="p">,</span> 
                         <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii.no_header&#39;</span><span class="p">,</span>
                         <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;dx&#39;</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">,</span> <span class="s1">&#39;rot&#39;</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="s1">&#39;xrms&#39;</span><span class="p">,</span> <span class="s1">&#39;yrms&#39;</span><span class="p">])</span>

<span class="n">formats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.2f&#39;</span><span class="p">,</span> <span class="s1">&#39;.2f&#39;</span><span class="p">,</span> <span class="s1">&#39;.3f&#39;</span><span class="p">,</span> <span class="s1">&#39;.5f&#39;</span><span class="p">,</span> <span class="s1">&#39;.2f&#39;</span><span class="p">,</span> <span class="s1">&#39;.2f&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shift_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
    <span class="n">shift_table</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">shift_table</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>       file         dx    dy    rot    scale  xrms yrms
------------------ ---- ----- ------- ------- ---- ----
id8048e0q_flc.fits 0.00  0.00   0.000 1.00000 0.00 0.00
id8048dyq_flc.fits 0.08 -0.02 359.999 1.00002 0.04 0.04
id8048e3q_flc.fits 0.09  0.01   0.000 1.00001 0.05 0.05
</pre></div>
</div>
</div>
</div>
<p>In this case, the exposures are already well aligned as the shifts are less than <span class="math notranslate nohighlight">\(\approx\)</span> 0.1 pixels. Because the errors on the shifts are generally smaller than the measured shifts, we adopt the shifted values. Next, we use <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> to combine the aligned exposures into a single mosaic. See the <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> <a class="reference external" href="https://drizzlepac.readthedocs.io/en/deployment/astrodrizzle.html">readthedocs</a> for more information on each parameter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">tweak_dir</span><span class="p">)</span>

<span class="k">for</span> <span class="n">driz_file</span> <span class="ow">in</span> <span class="n">tweak_files</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Copying&#39;</span><span class="p">,</span> <span class="n">driz_file</span><span class="p">,</span> <span class="s1">&#39;to the drizzle directory.&#39;</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">driz_file</span><span class="p">,</span> <span class="n">driz_dir</span><span class="p">)</span>
    
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">driz_dir</span><span class="p">)</span>

<span class="c1"># Run AstroDrizzle.</span>
<span class="n">astrodrizzle</span><span class="o">.</span><span class="n">AstroDrizzle</span><span class="p">(</span><span class="n">tweak_files</span><span class="p">,</span>
                          <span class="n">output</span><span class="o">=</span><span class="s1">&#39;omega_cen_f606w_drz.fits&#39;</span><span class="p">,</span> <span class="c1"># The output filename.</span>
                          <span class="n">wcskey</span><span class="o">=</span><span class="s1">&#39;TWEAK&#39;</span><span class="p">,</span>              <span class="c1"># Use tweakreg WCS solution.</span>
                          <span class="n">build</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>                  <span class="c1"># Save combined SCI and WHT.</span>
                          <span class="n">updatewcs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>             <span class="c1"># Don&#39;t run updatewcs again.</span>
                          <span class="n">stepsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>                  <span class="c1"># Don&#39;t interpolate the WCS.</span>
                          <span class="n">num_cores</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>                 <span class="c1"># Single core saves memory.</span>
                          <span class="n">preserve</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>              <span class="c1"># We save the files separately.</span>
                          <span class="n">clean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>                  <span class="c1"># We don&#39;t need the mask files.</span>
                          <span class="n">skysub</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>                 <span class="c1"># Definitely subtract the sky.</span>
                          <span class="n">skymethod</span><span class="o">=</span><span class="s1">&#39;globalmin+match&#39;</span><span class="p">,</span> <span class="c1"># Recommended for diffuse data.</span>
                          <span class="n">combine_type</span><span class="o">=</span><span class="s1">&#39;iminmed&#39;</span><span class="p">,</span>      <span class="c1"># &#39;iminmed&#39; for &lt; 10 images.</span>
                          <span class="n">driz_cr_corr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>          <span class="c1"># Save the cosmic-ray masks.</span>
                          <span class="n">driz_combine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>           <span class="c1"># Use all images in drizzle.</span>
                          <span class="n">final_wht_type</span><span class="o">=</span><span class="s1">&#39;EXP&#39;</span><span class="p">,</span>        <span class="c1"># EXP weight for bright objects.</span>
                          <span class="n">final_pixfrac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>           <span class="c1"># Fraction to shrink drops by.</span>
                          <span class="n">final_units</span><span class="o">=</span><span class="s1">&#39;cps&#39;</span><span class="p">)</span>           <span class="c1"># Set units to counts per second.</span>

<span class="n">clear_output</span><span class="p">()</span> <span class="c1"># Remove this line to see the DrizzlePac log.</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we can display the drizzled image and highlight the same boxed region shown in Sections 1-2. The mosaic displays a significantly smoother background than the individual exposures, without significant cosmic rays or hot pixels. Stars that were saturated in the original FLCs contain artifacts and therefore should not be stacked.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">driz_dir</span><span class="o">+</span><span class="s1">&#39;omega_cen_f606w_drz.fits&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
    <span class="n">sci_driz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The image dimensions are:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">sci_driz</span><span class="p">))</span>

<span class="n">my_figure_size</span><span class="p">,</span> <span class="n">my_fontsize</span> <span class="o">=</span> <span class="n">setup_matplotlib</span><span class="p">(</span><span class="s1">&#39;notebook&#39;</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
<span class="n">figure</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">my_figure_size</span><span class="p">)</span>
<span class="n">cutout_size</span> <span class="o">=</span> <span class="mi">75</span> <span class="c1"># 75 WFC3 UVIS pixels = 3 arcseconds.</span>

<span class="c1"># The same box is at: 1823.5781, 1096.5125 in the drizzled mosaic.</span>
<span class="n">axes</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">((</span><span class="mf">1823.5781</span><span class="o">-</span><span class="n">cutout_size</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mf">1096.5125</span><span class="o">-</span><span class="n">cutout_size</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="n">cutout_size</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">cutout_size</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">))</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">sci_driz</span><span class="p">,</span> <span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.8</span><span class="o">-</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sci_driz</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The image dimensions are: (4520, 4345)
</pre></div>
</div>
<img alt="../../../_images/170b0d228268a67c6bcdd9deeeaeb3895575791452c7e2548773f956957e1514.png" src="../../../_images/170b0d228268a67c6bcdd9deeeaeb3895575791452c7e2548773f956957e1514.png" />
</div>
</div>
<p><a id="stack"></a></p>
</section>
<section id="stack-stars">
<h3>3.2 Stack Stars<a class="headerlink" href="#stack-stars" title="Permalink to this heading">#</a></h3>
<p><span class="xref myst">Table of Contents</span></p>
<hr class="docutils" />
<p>Next, we want to detect stars that surround the location of interest, and stack them to construct a PSF model. In this case we have a sufficient number of stars (&gt; 10) that are near the location on the detector for which we want to construct a PSF model. In this case we select a 525<span class="math notranslate nohighlight">\(\times\)</span>525 pixel region near the four stars shown above. The functionality of the code below is described in more detail in <span class="xref myst">Section 1.4</span>, and the resulting stellar flux measurements can be shown by adding <code class="docutils literal notranslate"><span class="pre">print(phot_table)</span></code>. <strong>In this case the drizzles have been background-subtracted, but images with a high background would require users to background subtract their data and/or PSF model for proper fitting and photometric accuracy.</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate statistics for the background, initialize the star finder, locate the stars, and assign flux apertures.</span>
<span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">sci_driz</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
<span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">roundhi</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">create_mask</span><span class="p">(</span><span class="n">sci_driz</span><span class="p">,</span> <span class="n">cutout_size</span><span class="o">=</span><span class="n">cutout_size</span><span class="o">*</span><span class="mf">7.0</span><span class="p">,</span> <span class="n">xcenter</span><span class="o">=</span><span class="mi">1823</span><span class="p">,</span> <span class="n">ycenter</span><span class="o">=</span><span class="mi">1096</span><span class="p">)</span>
<span class="n">sources</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">sci_driz</span> <span class="o">-</span> <span class="n">median</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]))</span>
<span class="n">apertures_stellar</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">apertures_annulus</span> <span class="o">=</span> <span class="n">CircularAnnulus</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r_in</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">r_out</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">phot_table</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span><span class="n">sci_driz</span><span class="p">,</span> <span class="n">apertures_stellar</span><span class="p">)</span>

<span class="c1"># Calculate the sigma-clipped background levels and subtract that from the flux measured within the stellar aperture.</span>
<span class="n">aperture_stats</span> <span class="o">=</span> <span class="n">ApertureStats</span><span class="p">(</span><span class="n">sci_driz</span><span class="p">,</span> <span class="n">apertures_stellar</span><span class="p">,</span> <span class="n">sigma_clip</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">background_stats</span> <span class="o">=</span> <span class="n">ApertureStats</span><span class="p">(</span><span class="n">sci_driz</span><span class="p">,</span> <span class="n">apertures_annulus</span><span class="p">,</span> <span class="n">sigma_clip</span><span class="o">=</span><span class="n">SigmaClip</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="n">total_background</span> <span class="o">=</span> <span class="n">background_stats</span><span class="o">.</span><span class="n">median</span> <span class="o">*</span> <span class="n">aperture_stats</span><span class="o">.</span><span class="n">sum_aper_area</span><span class="o">.</span><span class="n">value</span> <span class="c1"># area of annulus.</span>
<span class="n">flux_background_sub</span> <span class="o">=</span> <span class="n">aperture_stats</span><span class="o">.</span><span class="n">sum</span> <span class="o">-</span> <span class="n">total_background</span>
<span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;total_background&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_background</span>
<span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;flux_background_sub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux_background_sub</span>

<span class="c1"># Display the science image and photometric apertures.</span>
<span class="n">plot_apertures</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">sci_driz</span><span class="p">,</span> 
               <span class="n">xcenter</span><span class="o">=</span><span class="mi">1823</span><span class="p">,</span> 
               <span class="n">ycenter</span><span class="o">=</span><span class="mi">1096</span><span class="p">,</span> 
               <span class="n">cutout_size</span><span class="o">=</span><span class="n">cutout_size</span><span class="o">*</span><span class="mf">7.0</span><span class="p">,</span> 
               <span class="n">apertures_stellar</span><span class="o">=</span><span class="n">apertures_stellar</span><span class="p">,</span> 
               <span class="n">apertures_annulus</span><span class="o">=</span><span class="n">apertures_annulus</span><span class="p">)</span>

<span class="n">save_figure</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="n">plot_dir</span><span class="o">+</span><span class="s1">&#39;fig10_drizzle_sources.pdf&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/3850f67302cbab27a2d4c581dbd500c7ae07e7fae79248925108326de41124a8.png" src="../../../_images/3850f67302cbab27a2d4c581dbd500c7ae07e7fae79248925108326de41124a8.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Figure saved as: /home/runner/work/hst_notebooks/hst_notebooks/notebooks/WFC3/point_spread_function/plot/fig10_drizzle_sources.pdf
</pre></div>
</div>
</div>
</div>
<p>Now we use the photometric catalog to select stars from the drizzled image for stacking. In this case we shift the catalog coordinates by one pixel so that the image and catalog both have the same origin of one, rather than being zero based. Here we use the centroids obtained directly from the photometric catalog, which yields coordinates that agree with the center of mass within <span class="math notranslate nohighlight">\(\lesssim\)</span> 0.05 pixels. This is sufficient for many science cases, but it may be possible to improve the alignment by using the stacked model to fit the stars with the <a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.psf.PSFPhotometry.html#photutils.psf.PSFPhotometry">PSFPhotometry</a> package and iterating the fits until the centroids converge to stable values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">star_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="n">xis</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;xcenter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)]</span>
<span class="n">yis</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;ycenter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)]</span>

<span class="n">driz_cutouts</span> <span class="o">=</span> <span class="n">make_cutouts</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">sci_driz</span><span class="p">,</span> 
                            <span class="n">star_ids</span><span class="o">=</span><span class="n">star_ids</span><span class="p">,</span> 
                            <span class="n">xis</span><span class="o">=</span><span class="n">xis</span><span class="p">,</span> 
                            <span class="n">yis</span><span class="o">=</span><span class="n">yis</span><span class="p">,</span> 
                            <span class="n">rpix</span><span class="o">=</span><span class="n">rpix</span><span class="p">,</span> 
                            <span class="n">scale_stars</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                            <span class="n">show_figs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                            <span class="n">sub_pixel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">clear_output</span><span class="p">()</span> <span class="c1"># Remove this line to see all 46 cutouts.</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">driz_stack</span> <span class="o">=</span> <span class="n">stack_cutouts</span><span class="p">(</span><span class="n">driz_cutouts</span><span class="p">,</span> 
                           <span class="n">rpix</span><span class="o">=</span><span class="n">rpix</span><span class="p">,</span> 
                           <span class="n">stack_type</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> 
                           <span class="n">scale_flux</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                           <span class="n">export_file</span><span class="o">=</span><span class="n">psfs_dir</span><span class="o">+</span><span class="s1">&#39;hst_wfc3_uvis_f606w_driz_psf_model.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Calling stack_cutouts with 45 sources.

Creating a median image stack.
Scaling the total flux to one.
The total image flux is = 1.0
</pre></div>
</div>
<img alt="../../../_images/c000cc04bcccc0ba0ad6bae5ceb2af1070f8f27ca61e6cd6bb370574dd004983.png" src="../../../_images/c000cc04bcccc0ba0ad6bae5ceb2af1070f8f27ca61e6cd6bb370574dd004983.png" />
</div>
</div>
<p>We now isolate the same four stars show at the exposure level in Sections 1-2. The drizzled image has a substantially smoother background with cosmic ray and hot pixel artifacts removed by the drizzling process. In addition, a faint fifth star that was barely detectable at the exposure level is now readily visible and can also be analyzed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate statistics for the background, initialize the star finder, locate the stars, and assign flux apertures.</span>
<span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">sci_driz</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
<span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">roundhi</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">create_mask</span><span class="p">(</span><span class="n">sci_driz</span><span class="p">,</span> <span class="n">cutout_size</span><span class="p">,</span> <span class="mi">1823</span><span class="p">,</span> <span class="mi">1096</span><span class="p">)</span>
<span class="n">sources</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">sci_driz</span> <span class="o">-</span> <span class="n">median</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]))</span>
<span class="n">apertures_stellar</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">apertures_annulus</span> <span class="o">=</span> <span class="n">CircularAnnulus</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r_in</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">r_out</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">phot_table</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span><span class="n">sci_driz</span><span class="p">,</span> <span class="n">apertures_stellar</span><span class="p">)</span>

<span class="c1"># Calculate the sigma-clipped background levels and subtract that from the flux measured within the stellar aperture.</span>
<span class="n">aperture_stats</span> <span class="o">=</span> <span class="n">ApertureStats</span><span class="p">(</span><span class="n">sci_driz</span><span class="p">,</span> <span class="n">apertures_stellar</span><span class="p">,</span> <span class="n">sigma_clip</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">background_stats</span> <span class="o">=</span> <span class="n">ApertureStats</span><span class="p">(</span><span class="n">sci_driz</span><span class="p">,</span> <span class="n">apertures_annulus</span><span class="p">,</span> <span class="n">sigma_clip</span><span class="o">=</span><span class="n">SigmaClip</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="n">total_background</span> <span class="o">=</span> <span class="n">background_stats</span><span class="o">.</span><span class="n">median</span> <span class="o">*</span> <span class="n">aperture_stats</span><span class="o">.</span><span class="n">sum_aper_area</span><span class="o">.</span><span class="n">value</span> <span class="c1"># area of annulus.</span>
<span class="n">flux_background_sub</span> <span class="o">=</span> <span class="n">aperture_stats</span><span class="o">.</span><span class="n">sum</span> <span class="o">-</span> <span class="n">total_background</span>
<span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;total_background&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_background</span>
<span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;flux_background_sub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux_background_sub</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">phot_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>  
    <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;npix&#39;</span><span class="p">):</span>
        <span class="n">phot_table</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">phot_table</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">plot_apertures</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">sci_driz</span><span class="p">,</span> 
               <span class="n">xcenter</span><span class="o">=</span><span class="mi">1823</span><span class="p">,</span> 
               <span class="n">ycenter</span><span class="o">=</span><span class="mi">1096</span><span class="p">,</span> 
               <span class="n">cutout_size</span><span class="o">=</span><span class="n">cutout_size</span><span class="p">,</span> 
               <span class="n">apertures_stellar</span><span class="o">=</span><span class="n">apertures_stellar</span><span class="p">,</span> 
               <span class="n">apertures_annulus</span><span class="o">=</span><span class="n">apertures_annulus</span><span class="p">)</span>

<span class="n">save_figure</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="n">plot_dir</span><span class="o">+</span><span class="s1">&#39;fig11_aperture_photometry.pdf&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  id xcenter ycenter aperture_sum total_background flux_background_sub
--- ------- ------- ------------ ---------------- -------------------
  1 1827.58 1074.49       307.78             2.99              304.80
  2 1801.48 1096.63        13.97             0.86               13.11
  3 1842.42 1098.51       290.16             2.75              287.41
  4 1809.12 1113.28       566.93             5.82              561.11
  5 1817.76 1114.25       287.04             4.56              282.49 
</pre></div>
</div>
<img alt="../../../_images/5b647bb568b07d15f27e6a976ad2a4974a12924a12af37ec9763771efe2aaf60.png" src="../../../_images/5b647bb568b07d15f27e6a976ad2a4974a12924a12af37ec9763771efe2aaf60.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Figure saved as: /home/runner/work/hst_notebooks/hst_notebooks/notebooks/WFC3/point_spread_function/plot/fig11_aperture_photometry.pdf
</pre></div>
</div>
</div>
</div>
<p>Finally, we use the stacked model from the drizzled image to perform a PSF fit and subtraction of the same stars examined earlier, with the addition of a faint fifth star on the left of the image. Overall, the model accurately encapsulates the total flux of each star, but some artifacts remain because drizzled images resample the observations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">driz_stack_psf</span> <span class="o">=</span> <span class="n">FittableImageModel</span><span class="p">(</span><span class="n">driz_stack</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">photometry</span><span class="p">,</span> <span class="n">psfphot</span> <span class="o">=</span> <span class="n">calculate_photometry</span><span class="p">(</span><span class="n">sci_driz</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">psf_model</span><span class="o">=</span><span class="n">driz_stack_psf</span><span class="p">)</span>
<span class="n">resid</span> <span class="o">=</span> <span class="n">psfphot</span><span class="o">.</span><span class="n">make_residual_image</span><span class="p">(</span><span class="n">sci_driz</span><span class="p">,</span> <span class="n">psf_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">17</span><span class="p">))</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">plot_psf_results</span><span class="p">(</span><span class="n">sci_driz</span><span class="p">,</span> <span class="n">resid</span><span class="p">,</span> <span class="mi">1823</span><span class="p">,</span> <span class="mi">1096</span><span class="p">,</span> <span class="n">cutout_size</span><span class="p">)</span>
<span class="n">save_figure</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="n">plot_dir</span><span class="o">+</span><span class="s1">&#39;fig12_driz_stack.pdf&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">calculate_residuals</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">sources</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">PSF Photometry (before subtraction):</span>

 id  x_fit   y_fit  flux_fit  qfit
--- ------- ------- -------- -----
  1 1827.59 1074.43   346.46 0.069
  2 1801.53 1096.64    13.71 0.090
  3 1842.40 1098.52   332.21 0.063
  4 1809.11 1113.38   616.49 0.150
  5 1817.76 1114.27   280.68 0.130
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING: AstropyDeprecationWarning: The FittableImageModel class is deprecated and may be removed in a future version.
        Use `ImagePSF` instead. [warnings]
</pre></div>
</div>
<img alt="../../../_images/385820bdbc996870a3f37460f4fa9ced48b895a10e03c0ad4c1f986a670ab731.png" src="../../../_images/385820bdbc996870a3f37460f4fa9ced48b895a10e03c0ad4c1f986a670ab731.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Figure saved as: /home/runner/work/hst_notebooks/hst_notebooks/notebooks/WFC3/point_spread_function/plot/fig12_driz_stack.pdf

<span class=" -Color -Color-Bold">Aperture Photometry (after subtraction):</span>

 id xcenter ycenter aperture_sum total_background flux_background_sub
--- ------- ------- ------------ ---------------- -------------------
  1 1827.58 1074.49        -2.00             2.65               -4.65
  2 1801.48 1096.63         1.71             0.86                0.85
  3 1842.42 1098.51        -6.84             2.34               -9.18
  4 1809.12 1113.28        11.69             4.77                6.92
  5 1817.76 1114.25        24.02             3.86               20.16 
</pre></div>
</div>
</div>
</div>
<p>If users have fewer than approximately 5-10 stars in their drizzled images and cannot create a stacked model, then it is possible to drizzle the empirical models provided by the WFC3 team into FLC files. This requires installing the <a class="reference external" href="https://github.com/spacetelescope/wfc3_photometry">wfc3_photometry</a> package, running the included <code class="docutils literal notranslate"><span class="pre">make_model_star_image()</span></code> function within <code class="docutils literal notranslate"><span class="pre">PSFUtils.py</span></code> on the FLC files, and then extracting and stacking the drizzled models. This functionality is under development and not yet officially supported.</p>
<p><a id="conclusions"></a></p>
</section>
</section>
<section id="conclusions">
<h2>Conclusions<a class="headerlink" href="#conclusions" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Table of Contents</span></p>
<hr class="docutils" />
<p>We hope this tutorial provides you with valuable tools and techniques for PSF modeling of HST observations. In summary, we have shown several different workflows for generating PSF models depending on the available observations. First, we demonstrated in <span class="xref myst">Section 2.1</span> that analytical models such as Gaussian profiles fail to characterize the complex shape of the HST PSF. In <span class="xref myst">Section 2.2</span>, we used empirical models provided by the WFC3 team to accurately characterize the shape of the PSF. We explored using the <span class="xref myst">default models</span>, as well as those modified to match the <span class="xref myst">focus</span> of specific observations, and characterize <span class="xref myst">spatial variations</span> of the PSF across the detector. These models provide high-accuracy astrometry and photometry of stellar sources, but do not account for extended wing emission or diffraction spikes. We tackled this issue in <span class="xref myst">Section 2.3</span> by stacking stars <span class="xref myst">extracted from</span> the observations, or by <span class="xref myst">retrieving cutouts</span> from MAST. Stacking a large number of sources allows for efficient outlier rejection and can produce a high quality PSF that extends to large radii, but can also broaden the PSF core depending on how the sources are aligned. Finally, we extended this process to drizzled images in <span class="xref myst">Section 3</span>. In some cases, more than one workflow is possible for a given set of observations, and users are encouraged to experiment with these tools to develop the best PSF models for their science goals.</p>
<p><a id="about"></a></p>
</section>
<section id="about-this-notebook">
<h2>About this Notebook<a class="headerlink" href="#about-this-notebook" title="Permalink to this heading">#</a></h2>
<p><span class="xref myst">Table of Contents</span></p>
<hr class="docutils" />
<p><strong>Author:</strong> Mitchell Revalski<br>
<strong>Created:</strong> 15 Apr 2024<br>
<strong>Updated:</strong> 22 May 2025<br>
<strong>Source:</strong> <a class="github reference external" href="https://github.com/spacetelescope/hst_notebooks">spacetelescope/hst_notebooks</a></p>
<p><a id="additional"></a></p>
<section id="additional-resources">
<h3>Additional Resources<a class="headerlink" href="#additional-resources" title="Permalink to this heading">#</a></h3>
<p>Below are some additional resources that may be helpful. Please send any questions to the <a class="reference external" href="https://stsci.service-now.com/hst">HST Help Desk</a>.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.stsci.edu/hst/instrumentation/wfc3">WFC3 Website</a></p></li>
<li><p><a class="reference external" href="https://www.stsci.edu/hst/instrumentation/wfc3/data-analysis/psf">WFC3 PSF Webpage</a></p></li>
<li><p><a class="reference external" href="https://hst-docs.stsci.edu/wfc3dhb">WFC3 Data Handbook</a></p></li>
<li><p><a class="reference external" href="https://hst-docs.stsci.edu/wfc3ihb">WFC3 Instrument Handbook</a></p></li>
<li><p><a class="reference external" href="https://www.stsci.edu/hst/instrumentation/wfc3/software-tools">WFC3 Software Tools Webpage</a></p></li>
<li><p><a class="reference external" href="https://boyce-astro.org/point-spread-function-psf/">Introduction to PSF photometry</a></p></li>
<li><p>HST PSF: <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2000PASP..112.1360A/abstract">Anderson &amp; King (2000)</a></p></li>
</ul>
<p><a id="cite"></a></p>
</section>
<section id="software-citations">
<h3>Software Citations<a class="headerlink" href="#software-citations" title="Permalink to this heading">#</a></h3>
<p>If you use Python packages such as <code class="docutils literal notranslate"><span class="pre">astropy</span></code>, <code class="docutils literal notranslate"><span class="pre">astroquery</span></code>, <code class="docutils literal notranslate"><span class="pre">drizzlepac</span></code>, <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code>, or <code class="docutils literal notranslate"><span class="pre">numpy</span></code> for published research, please cite the authors. Follow the links below for more information about citing various packages:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.astropy.org/acknowledging.html">Citing <code class="docutils literal notranslate"><span class="pre">astropy</span></code></a></p></li>
<li><p><a class="reference external" href="https://github.com/astropy/astroquery/blob/main/astroquery/CITATION">Citing <code class="docutils literal notranslate"><span class="pre">astroquery</span></code></a></p></li>
<li><p><a class="reference external" href="https://drizzlepac.readthedocs.io/en/latest/getting_started/citing_drizzlepac.html">Citing <code class="docutils literal notranslate"><span class="pre">drizzlepac</span></code></a></p></li>
<li><p><a class="reference external" href="https://matplotlib.org/stable/users/project/citing.html">Citing <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code></a></p></li>
<li><p><a class="reference external" href="https://numpy.org/citing-numpy/">Citing <code class="docutils literal notranslate"><span class="pre">numpy</span></code></a></p></li>
<li><p><a class="reference external" href="https://photutils.readthedocs.io/en/stable/getting_started/citation.html">Citing <code class="docutils literal notranslate"><span class="pre">photutils</span></code></a></p></li>
</ul>
<p><a id="history"></a></p>
</section>
<section id="version-history">
<h3>Version History<a class="headerlink" href="#version-history" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>05 Jun 2024: First release of the <code class="docutils literal notranslate"><span class="pre">hst_point_spread_function.ipynb</span></code> notebook, which utilizes <code class="docutils literal notranslate"><span class="pre">astropy</span> <span class="pre">v6.0.1</span></code>, <code class="docutils literal notranslate"><span class="pre">numpy</span> <span class="pre">v1.26.4</span></code>, and <code class="docutils literal notranslate"><span class="pre">photutils</span> <span class="pre">v1.12.0</span></code>.</p></li>
<li><p>02 Apr 2025: Updated the functions in <code class="docutils literal notranslate"><span class="pre">mast_api_psf.py</span></code>, and the corresponding function calls in the notebook, to match those published in <a class="reference external" href="https://spacetelescope.github.io/hst_notebooks/notebooks/WFC3/mast_api_psf/download_psf_cutouts.html">download_psf_cutouts.ipynb</a>.</p></li>
<li><p>17 Apr 2025: Added <code class="docutils literal notranslate"><span class="pre">tqdm&gt;=4.66.2</span></code> to the requirements.txt file, which is needed by <code class="docutils literal notranslate"><span class="pre">mast_api_psf.py</span></code>, and is required to pass the repositories continuous integration (CI).</p></li>
<li><p>22 May 2025: Packages are no longer pinned so the CI can use the most recent versions. Calls to <code class="docutils literal notranslate"><span class="pre">make_residual_image</span></code> were fixed for compatibility with <code class="docutils literal notranslate"><span class="pre">photutils</span> <span class="pre">v2.2.0</span></code>.</p></li>
</ul>
<hr class="docutils" />
<p><span class="xref myst">Top of Page</span>
<a class="reference internal" href="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png"><img alt="Space Telescope Logo" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="width: 200px;" /></a></p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/hst_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/WFC3/point_spread_function"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../point_spread_function.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Point Spread Function (PSF)</p>
      </div>
    </a>
    <a class="right-next"
       href="../mast_api_psf/download_psf_cutouts.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Downloading WFC3 and WFPC2 PSF Cutouts from MAST</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">1. Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#environment-setup">1.1 Environment Setup</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#import-packages">1.2 Import Packages</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#download-data">1.3 Download Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#aperture-photometry">1.4 Aperture Photometry</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exposure-psf-models">2. Exposure PSF Models</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#analytical-psf-models">2.1 Analytical PSF Models</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#empirical-psf-models">2.2 Empirical PSF Models</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#default-models">2.2.1 Default Models</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#focus-perturbation">2.2.2 Focus Perturbation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-perturbation">2.2.3 Spatial Perturbation</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stacked-psf-models">2.3 Stacked PSF Models</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#stellar-stacks">2.3.1 Stellar Stacks</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#mast-stacks">2.3.2 MAST Stacks</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#drizzle-psf-models">3. Drizzle PSF Models</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-drizzle">3.1 Create Drizzle</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stack-stars">3.2 Stack Stars</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusions">Conclusions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-resources">Additional Resources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#software-citations">Software Citations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#version-history">Version History</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>