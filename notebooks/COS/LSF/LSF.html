

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Working with the COS Line Spread Function (LSF) &#8212; HST Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/table.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/COS/LSF/LSF';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Editing the extraction boxes in a spectral extraction file (XTRACTAB)" href="../Extract/Extract.html" />
    <link rel="prev" title="Filtering out COS Data taken during the Day or Night" href="../DayNight/DayNight.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="HST Notebooks - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="HST Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../index.html">
                    STScI HST Notebook Repository HQ
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">ACS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../ACS/README.html">ACS Notebooks</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_findsat_mrt/acs_findsat_mrt_example.html">Satellite trail detection in ACS/WFC data using acstools.findsat_mrt</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_saturation_trails/acs_saturation_trails.html">ACS Linearity with Saturated Stars</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_cte_forward_model/acs_cte_forward_model_example.html">Pixel-based ACS/WFC CTE Forward Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_subarrays/acs_subarrays.html">ACS Image Reduction for Subarray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_sbc_dark_analysis/acs_sbc_dark_analysis.html">SBC Dark Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_reduction/acs_reduction.html">ACS/WFC Image Reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_pixel_area_maps/acs_pixel_area_maps.html">Obtaining Pixel Area Maps for ACS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_polarization_tools/acs_polarization_tools.html">Using ACS Polarization Tools</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">COS</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../README.html">COS Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Setup/Setup.html">Setting up your computer environment for working with COS data</a></li>





<li class="toctree-l1"><a class="reference internal" href="../DataDl/DataDl.html">Downloading COS Data</a></li>




<li class="toctree-l1"><a class="reference internal" href="../ViewData/ViewData.html">Viewing COS Data</a></li>





<li class="toctree-l1"><a class="reference internal" href="../AsnFile/AsnFile.html">Modifying or Creating an Association File</a></li>





<li class="toctree-l1"><a class="reference internal" href="../CalCOS/CalCOS.html">Running the COS Data Pipeline (<code class="docutils literal notranslate"><span class="pre">CalCOS</span></code>)</a></li>






<li class="toctree-l1"><a class="reference internal" href="../SplitTag/SplitTag.html">Splitting COS Exposures into sub-exposures with <code class="docutils literal notranslate"><span class="pre">splittag</span></code></a></li>







<li class="toctree-l1"><a class="reference internal" href="../DayNight/DayNight.html">Filtering out COS Data taken during the Day or Night</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Working with the COS Line Spread Function (LSF)</a></li>

<li class="toctree-l1"><a class="reference internal" href="../Extract/Extract.html">Editing the extraction boxes in a spectral extraction file (<code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>)</a></li>







</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">DrizzlePac</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/README.html">DrizzlePac Jupyter Notebook Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/Initialization/Initialization.html">DrizzlePac Initialization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_to_catalogs/align_to_catalogs.html">Aligning HST images to an absolute reference catalog</a></li>



<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_multiple_visits/align_multiple_visits.html">Optimizing Image Alignment for Multiple HST Visits</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_sparse_fields/align_sparse_fields.html">Aligning Deep Exposures of Sparse Fields</a></li>








<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/drizzle_wfpc2/drizzle_wfpc2.html">Drizzling WFPC2 Images to use a Single Zeropoint</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/mask_satellite/mask_satellite.html">Satellite Trail Masking Techniques</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/optimize_image_sampling/optimize_image_sampling.html">Optimizing the Image Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/using_updated_astrometry_solutions/using_updated_astrometry_solutions.html">Using updated astrometry solutions</a></li>


</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NICMOS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NICMOS/nicmos_unit_conversion/nicmos_unit_conversion.html">Programmatic Replacements for NICMOS Units Conversion Form</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">STIS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../STIS/README.html">STIS-Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/cross-correlation/cross-correlation.html">Correcting for Missing Wavecals with Cross-Correlation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/custom_ccd_darks/custom_ccd_darks.html">Custom CCD Darks <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/drizpac_notebook/STIS_DrizzlePac_Tutorial.html">STIS DrizzlePac Tutorial <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/CoronagraphyViz/STIS_Coronagraphy_Visualization_v2.html">STIS Coronagraphy Visualization Tool (v2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/calstis/calstis_2d_ccd.html">Calstis 2-D CCD Data Reduction <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/target_acquisition/target_acquisition.html">Evaluating STIS Target Acquisitions <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/view_data/view_data.html">Viewing STIS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/extraction/1D_Extraction.html">1D Spectra Extraction <a class="tocSkip"></a></a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">WFC3</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/README.html">WFC3 Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/calwf3_recalibration/calwf3_recal_tvb.html">Manual Recalibration with calwf3: Turning off the IR Linear Ramp Fit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/calwf3_v1.0_cte/calwf3_with_v1.0_PCTE.html">Processing WFC3/UVIS Data with <code class="docutils literal notranslate"><span class="pre">calwf3</span></code> Using the v1.0 CTE-Correction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/exception_report/wfc3_exception_report.html">Exception Report Checklist - WFC3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/persistence/wfc3_ir_persistence.html">Masking Persistence in WFC3/IR Images</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/spacetelescope/hst_notebooks/blob/main/notebooks/COS/LSF/LSF.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/hst_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/hst_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/COS/LSF/LSF.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/COS/LSF/LSF.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Working with the COS Line Spread Function (LSF)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Working with the COS Line Spread Function (LSF)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">0. Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#we-will-import-the-following-packages">We will import the following packages:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#we-will-also-define-a-few-directories-we-will-need">We will also define a few directories we will need:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#and-we-will-need-to-download-the-data-we-wish-to-filter-and-analyze">And we will need to download the data we wish to filter and analyze</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-the-line-spread-function">1. Understanding the Line Spread Function</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-an-lsf">1.1. What is an LSF?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#center-table-1-1-line-spread-function-lsf-kernel-parameters-for-the-cos-instrument-center"><center> Table 1.1: Line Spread Function (LSF) kernel parameters for the COS instrument</center></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-the-files-you-need">1.2. Getting the files you need</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#center-fig-1-1-screenshot-of-the-cos-spectral-resolution-site-center"><center> Fig 1.1: Screenshot of the COS Spectral Resolution Site</center></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#center-fig-1-2-screenshot-of-the-cos-spectral-resolution-site-focus-on-lp-pos-3-center"><center>Fig 1.2: Screenshot of the COS Spectral Resolution Site - Focus on LP-POS 3</center></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#taking-a-look-at-the-lsf-kernels">2. Taking a look at the LSF kernels</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-in-an-lsf">2.1. Reading in an LSF</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-an-lsf-kernel">2.2. Plotting an LSF kernel</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#we-will-also-demonstrate-all-of-the-above-for-a-nuv-dataset">We will also demonstrate all of the above for a NUV dataset:</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#convolving-an-lsf">3. Convolving an LSF</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-some-functions-for-lsf-convolution">3.1. Defining some functions for LSF convolution</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-the-dispersion-relationship-parameters">3.1.1. Getting the dispersion relationship parameters</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#redefining-the-lsf-in-terms-of-wavelength">3.1.2. Redefining the LSF in terms of wavelength</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#applying-the-convolution">3.1.3. Applying the convolution</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#convolving-simple-line-profiles">3.2. Convolving simple line profiles</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#convolving-real-data-from-stis">3.3. Convolving real data from STIS</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#we-ll-do-something-similar-again-for-the-nuv">We’ll do something similar again for the NUV:</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#in-review">In review:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#congratulations-you-finished-this-notebook">Congratulations! You finished this Notebook!</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#citations">Citations</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <p><a id="topL"></a></p>
<section class="tex2jax_ignore mathjax_ignore" id="working-with-the-cos-line-spread-function-lsf">
<h1>Working with the COS Line Spread Function (LSF)<a class="headerlink" href="#working-with-the-cos-line-spread-function-lsf" title="Permalink to this heading">#</a></h1>
<section id="learning-goals">
<h2>Learning Goals<a class="headerlink" href="#learning-goals" title="Permalink to this heading">#</a></h2>
<p><font size="4"> This Notebook is designed to walk the user (<em>you</em>) through: <b>Working with the COS Line Spread Function (<em>LSF</em>) to simulate, fit, or model COS observations</b>. </font></p>
<p><strong>1. <span class="xref myst">Understanding the Line Spread Function</span></strong></p>
<p>- 1.1. <span class="xref myst">What is an LSF?</span></p>
<p>- 1.2. <span class="xref myst">Getting the files you need</span></p>
<p><strong>2. <span class="xref myst">Taking a look at the LSF kernels</span></strong></p>
<p>- 2.1. <span class="xref myst">Reading in an LSF</span></p>
<p>- 2.2. <span class="xref myst">Plotting an LSF kernel</span></p>
<p><strong>3. <span class="xref myst">Convolving an LSF</span></strong></p>
<p>- 3.1. <span class="xref myst">Defining some functions for LSF convolution</span></p>
<blockquote>
<div><p>3.1.1 <span class="xref myst"><code class="docutils literal notranslate"><span class="pre">get_disp_params</span></code>: Getting the dispersion relationship parameters</span></p>
</div></blockquote>
<blockquote>
<div><p>3.1.2 <span class="xref myst"><code class="docutils literal notranslate"><span class="pre">redefine_lsf</span></code>: Redefining the LSF in terms of wavelength</span></p>
</div></blockquote>
<blockquote>
<div><p>3.1.3 <span class="xref myst"><code class="docutils literal notranslate"><span class="pre">convolve_lsf</span></code>: Applying the convolution</span></p>
</div></blockquote>
<p>- 3.2. <span class="xref myst">Convolving simple line profiles</span></p>
<p>- 3.3. <span class="xref myst">Convolving real data from STIS</span></p>
</section>
<section id="introduction">
<h2>0. Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p><strong>The Cosmic Origins Spectrograph (<a class="reference external" href="https://www.nasa.gov/content/hubble-space-telescope-cosmic-origins-spectrograph"><em>COS</em></a>) is an ultraviolet spectrograph on-board the Hubble Space Telescope (<a class="reference external" href="https://www.stsci.edu/hst/about"><em>HST</em></a>) with capabilities in the near ultraviolet (<em>NUV</em>) and far ultraviolet (<em>FUV</em>).</strong></p>
<p><strong>This tutorial aims to prepare you to work with the COS data of your choice by walking you through convolving a template or high-resolution spectrum with the COS LSF - both for far-ultraviolet (FUV) and near-ultraviolet (NUV) data.</strong> This is an important step for many spectral applications, notably fitting spectral lines.</p>
<ul class="simple">
<li><p>For an in-depth manual to working with COS data and a discussion of caveats and user tips, see the <a class="reference external" href="https://hst-docs.stsci.edu/display/COSDHB/">COS Data Handbook</a>.</p></li>
<li><p>For a detailed overview of the COS instrument, see the <a class="reference external" href="https://hst-docs.stsci.edu/display/COSIHB/">COS Instrument Handbook</a>.</p></li>
</ul>
<section id="we-will-import-the-following-packages">
<h3>We will import the following packages:<a class="headerlink" href="#we-will-import-the-following-packages" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">numpy</span></code> to handle arrays and functions</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">astropy.io</span> <span class="pre">fits</span></code> and <code class="docutils literal notranslate"><span class="pre">astropy.table</span> <span class="pre">Table</span></code> for accessing FITS files</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">astropy.modeling</span> <span class="pre">functional_models</span></code> to generate synthetic spectral line shapes</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">astropy.convolution</span> <span class="pre">convolve</span></code> for a convolution of two discretized functions</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">astroquery.mast</span> <span class="pre">Mast</span></code> and <code class="docutils literal notranslate"><span class="pre">Observations</span></code> for finding and downloading data from the <a class="reference external" href="https://mast.stsci.edu/search/ui/#/hst">MAST</a> archive</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">scipy.interpolate</span> <span class="pre">interp1d</span></code> for interpolating two discretized functions to the same sampling</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">matplotlib.pyplot</span></code> for plotting</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">urllib</span></code> for downloading files stored at a web address online</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pathlib</span> <span class="pre">Path</span></code> for managing system paths</p></li>
</ul>
<p>If you have an existing astroconda environment, it may or may not already have the necessary packages to run this Notebook. To create a Python environment capable of running all the data analyses in these COS Notebooks, please see Section 1 of our Notebook tutorial on <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/blob/main/notebooks/COS/Setup/Setup.ipynb">setting up an environment</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import for array manipulation</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Import for reading FITS files</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>

<span class="c1"># Import for line profile functions</span>
<span class="kn">from</span> <span class="nn">astropy.modeling</span> <span class="kn">import</span> <span class="n">functional_models</span>

<span class="c1"># Import for convolutions</span>
<span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="kn">import</span> <span class="n">convolve</span>

<span class="c1"># Import for downloading the data</span>
<span class="kn">from</span> <span class="nn">astroquery.mast</span> <span class="kn">import</span> <span class="n">Observations</span>

<span class="c1"># Import for interpolating a discretized function</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

<span class="c1"># Import for plotting</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="c1"># Import for downloading COS&#39; LSF files within python</span>
<span class="kn">import</span> <span class="nn">urllib</span>

<span class="c1"># Import for working with system paths</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="we-will-also-define-a-few-directories-we-will-need">
<h3>We will also define a few directories we will need:<a class="headerlink" href="#we-will-also-define-a-few-directories-we-will-need" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># These will be important directories for the Notebook</span>
<span class="n">cwd</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
<span class="n">datadir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">)</span>
<span class="n">outputdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./output&quot;</span><span class="p">)</span>
<span class="n">plotsdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./output/plots&quot;</span><span class="p">)</span>

<span class="c1"># Make the directories if they don&#39;t exist</span>
<span class="n">datadir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">outputdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plotsdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="and-we-will-need-to-download-the-data-we-wish-to-filter-and-analyze">
<h3>And we will need to download the data we wish to filter and analyze<a class="headerlink" href="#and-we-will-need-to-download-the-data-we-wish-to-filter-and-analyze" title="Permalink to this heading">#</a></h3>
<p>We choose the exposures with the association obs_id: <code class="docutils literal notranslate"><span class="pre">LCRS51010</span></code>, because we know there is also STIS data on the source, AV75. For more information on downloading COS data, see our <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/blob/main/notebooks/COS/DataDl/DataDl.ipynb">notebook tutorial on downloading COS data</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Search for obs_id of files, generate data product list</span>
<span class="n">pl</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span>
    <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span>
        <span class="n">obs_id</span><span class="o">=</span><span class="s2">&quot;LCRS51010&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Filter and download searched files</span>
<span class="n">download</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span>
    <span class="n">pl</span><span class="p">[</span><span class="n">pl</span><span class="p">[</span><span class="s2">&quot;productSubGroupDescription&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;X1DSUM&quot;</span><span class="p">],</span>
    <span class="n">download_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">datadir</span><span class="p">),</span>
<span class="p">)</span>

<span class="c1"># Give the program the path to your downloaded data</span>
<span class="n">fuvFile</span> <span class="o">=</span> <span class="n">download</span><span class="p">[</span><span class="s2">&quot;Local Path&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/lcrs51010_x1dsum.fits to data/mastDownload/HST/lcrs51010/lcrs51010_x1dsum.fits ... [Done]
</pre></div>
</div>
</div>
</div>
<p><a id = undL></a></p>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="understanding-the-line-spread-function">
<h1>1. Understanding the Line Spread Function<a class="headerlink" href="#understanding-the-line-spread-function" title="Permalink to this heading">#</a></h1>
<p>Each COS observation is taken with a specific <strong>grating</strong> and a specific <strong>central wavelength setting</strong> (<strong>cenwave</strong>). Each such configuration (grating and cenwave) and - thus each COS dataset - has a set of corresponding Line Spread Functions (LSFs).</p>
<p><a id = whatL></a></p>
<section id="what-is-an-lsf">
<h2>1.1. What is an LSF?<a class="headerlink" href="#what-is-an-lsf" title="Permalink to this heading">#</a></h2>
<p>A Line Spread Function (LSF) is a model of a spectrograph’s response to a monochromatic light source: it explains how an infinitely thin spectral line (a <a class="reference external" href="https://en.wikipedia.org/wiki/Dirac_delta_function">delta function</a>) input into the spectrograph would be output at the focal plane. A spectrum with infinite spectral resolution convolved with the COS LSF will reproduce the COS spectral line profiles:</p>
<div class="math notranslate nohighlight">
\[True\ Input\ Spectrum \ast COS\ LSF = True\ Output\ Spectrum\]</div>
<p>Of course, we don’t have access to a “true”, infinite resolution input spectrum, nor can we know the infinite resolution LSF. The best we can do is use a model spectrum, or a spectrum from a higher resolution spectrograph (STIS often works well) and convolve it with a kernel of our LSF model. Convolving these yields our model output spectrum:</p>
<div class="math notranslate nohighlight">
\[Model\ Input\ Spectrum \ast COS\ LSF\ Model = Model\ Output\ Spectrum\]</div>
<p><em><strong>Note</strong></em> <em>that there is a corresponding spread function in the cross-dispersion direction, known as the cross-dispersion spread function (CDSF). These functions are also modelled by the COS team and hosted on their website listed below. Working with the CDSFs is out of the scope of this Notebook.</em></p>
<p><font size="4 "> <b>How does COS handle the LSF?</b></font></p>
<p>The COS LSFs are generated using an optical model of the spectrograph in the program <a class="reference external" href="https://www.synopsys.com/optical-solutions/codev.html">Code V</a>, and are then validated using real spectral data obtained with the instrument. The LSF kernels are sampled at regular intervals over the wavelength range of each COS configuration. Each of these wavelengths thus corresponds to an LSF kernel. The kernel size (in <a class="reference external" href="https://hst-docs.stsci.edu/cosihb/glossary">COS “pixels”</a>) of each LSF varies for the near ultraviolet (NUV) and far ultraviolet (FUV) modes, as does the sample rate (how many Angstroms between sampled kernels). These values are shown below:</p>
<section id="center-table-1-1-line-spread-function-lsf-kernel-parameters-for-the-cos-instrument-center">
<h3><center> Table 1.1: Line Spread Function (LSF) kernel parameters for the COS instrument</center><a class="headerlink" href="#center-table-1-1-line-spread-function-lsf-kernel-parameters-for-the-cos-instrument-center" title="Permalink to this heading">#</a></h3>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p></p></th>
<th class="head"><p>LSF kernels sampled every… (Å)</p></th>
<th class="head"><p>Actual kernel size (pixels)</p></th>
<th class="head"><p>Approximate kernel size in wavelength space(Å)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>COS/NUV</strong></p></td>
<td><p>100 Å</p></td>
<td><p>101 <em>pixels</em></p></td>
<td><p>-</p></td>
</tr>
<tr class="row-odd"><td><p><em><strong>NUV M Gratings</strong></em></p></td>
<td><p>100 Å</p></td>
<td><p>101 <em>pixels</em></p></td>
<td><p>3.7 Å</p></td>
</tr>
<tr class="row-even"><td><p><em><strong>NUV L Gratings</strong></em></p></td>
<td><p>100 Å</p></td>
<td><p>101 <em>pixels</em></p></td>
<td><p>39 Å</p></td>
</tr>
<tr class="row-odd"><td><p></p></td>
<td><p></p></td>
<td><p></p></td>
<td><p></p></td>
</tr>
<tr class="row-even"><td><p><strong>COS/FUV</strong></p></td>
<td><p>5 Å</p></td>
<td><p>321 <em>pixels</em></p></td>
<td><p>-</p></td>
</tr>
<tr class="row-odd"><td><p><em><strong>FUV M Gratings</strong></em></p></td>
<td><p>5 Å</p></td>
<td><p>321 <em>pixels</em></p></td>
<td><p>3.5 Å</p></td>
</tr>
<tr class="row-even"><td><p><em><strong>FUV L Gratings</strong></em></p></td>
<td><p>5 Å</p></td>
<td><p>321 <em>pixels</em></p></td>
<td><p>26 Å</p></td>
</tr>
</tbody>
</table>
<p><font size="4 "> <b>How are the LSF files structured?</b></font></p>
<p>In short, the LSF files are structured as a list of LSF profile kernels. It begins with a space-separated list of central sample wavelengths and the input monochromatic lines used by Code V. These are not to be confused with COS central wavelength settings, or cenwaves. To avoid confusing the two concepts, we’ll call the central wavelengths of the LSF kernels the <strong>LSF wavelengths</strong>.</p>
<p><a id = whichL></a></p>
</section>
</section>
<section id="getting-the-files-you-need">
<h2>1.2. Getting the files you need<a class="headerlink" href="#getting-the-files-you-need" title="Permalink to this heading">#</a></h2>
<p><font size="4 "><b>Which LSF files will you need?</b></font></p>
<p>This depends on your data’s parameters, specifically those listed in Table 1.2.</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Parameter</strong></p></th>
<th class="head"><p><strong>Corresponding Header Keyword</strong></p></th>
<th class="head"><p><strong>Example used in this Notebook</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Wavelength range</p></td>
<td><p><em>DETECTOR</em></p></td>
<td><p>FUV</p></td>
</tr>
<tr class="row-odd"><td><p>COS lifetime position</p></td>
<td><p><em>LIFE_ADJ</em></p></td>
<td><p>3</p></td>
</tr>
<tr class="row-even"><td><p>Grating</p></td>
<td><p><em>OPT_ELEM</em></p></td>
<td><p>G130M</p></td>
</tr>
<tr class="row-odd"><td><p>Central wavelength setting</p></td>
<td><p><em>CENWAVE</em></p></td>
<td><p>1291</p></td>
</tr>
</tbody>
</table>
<p>If your data was taken in COS’ NUV configuration, there’s only one NUV LSF file which contains all the LSF profiles for the entire NUV. FUV data is more complicated: you will need to choose an LSF file based on the <a class="reference external" href="https://hst-docs.stsci.edu/cosdhb/appendix-a-cos-lifetime-positions/a-1-cos-lifetime-positions">COS Lifetime position (LP)</a>, <a class="reference external" href="https://hst-docs.stsci.edu/cosihb/chapter-13-cos-reference-material/13-3-gratings">grating</a>, and <a class="reference external" href="https://hst-docs.stsci.edu/cosihb/chapter-5-spectroscopy-with-cos/5-5-spanning-the-gap-with-multiple-cenwave-settings">central wavelength setting (cenwave)</a> used to capture your data.</p>
<p>You’ll also need to get the <a class="reference external" href="https://hst-docs.stsci.edu/cosdhb/chapter-3-cos-calibration/3-7-reference-files#id-3.7ReferenceFiles-3.7.11DISPTAB:DispersionCoefficientTable:~:text=Wavecal%20spectrum%20array-,3.7.11%20DISPTAB%3A%20Dispersion%20Coefficient%20Table,-File%20Suffix%3A">DISPTAB</a> file associated with your data. This Dispersion Coefficient Table, or DISPTAB, file contains polynomial coefficients to convert from pixel number to wavelength. You can find the relevant DISPTAB in your data’s primary FITS header. You can figure out the relevant DISPTAB file by examining your data’s header in <a class="reference external" href="https://sites.google.com/cfa.harvard.edu/saoimageds9">DS9</a> or other software, but we’ll briefly do this programmatically below.</p>
<p><em>Note</em> that you should always ensure that your LSF kernels are normalized such that they integrate to 1. The files we use in this Notebook are normalized to this constraint.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select the primary header</span>
<span class="n">fuvHeader0</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">fuvFile</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For the file </span><span class="si">{</span><span class="n">fuvFile</span><span class="si">}</span><span class="s2">, the relevant parameters are: &quot;</span><span class="p">)</span>

<span class="c1"># Make a dictionary to store what you find here</span>
<span class="n">param_dict</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># We want data for the FUV detector, G130M grating at LP3 cenwave 1291</span>
<span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DETECTOR&quot;</span><span class="p">,</span> <span class="s2">&quot;OPT_ELEM&quot;</span><span class="p">,</span> <span class="s2">&quot;LIFE_ADJ&quot;</span><span class="p">,</span> <span class="s2">&quot;CENWAVE&quot;</span><span class="p">,</span> <span class="s2">&quot;DISPTAB&quot;</span><span class="p">]</span>

<span class="c1"># Print out the relevant values:</span>
<span class="k">for</span> <span class="n">hdrKeyword</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
    <span class="c1"># For DISPTAB</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Save the key/value pairs to the dictionary</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">fuvHeader0</span><span class="p">[</span><span class="n">hdrKeyword</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># DISPTAB needs the split here</span>
        <span class="n">param_dict</span><span class="p">[</span><span class="n">hdrKeyword</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="c1"># For other params</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
        <span class="c1"># Save the key/value pairs to the dictionary</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">fuvHeader0</span><span class="p">[</span><span class="n">hdrKeyword</span><span class="p">]</span>
        <span class="n">param_dict</span><span class="p">[</span><span class="n">hdrKeyword</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1"># Print the key/value pairs</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hdrKeyword</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>For the file data/mastDownload/HST/lcrs51010/lcrs51010_x1dsum.fits, the relevant parameters are: 
DETECTOR = FUV
OPT_ELEM = G130M
LIFE_ADJ = 3
CENWAVE = 1291
DISPTAB = 5b919205l_disp.fits
</pre></div>
</div>
</div>
</div>
<p><strong>Now that you know <em>which</em> LSF files you need, we’ll go gather them from the COS team’s website:</strong></p>
<p><font size="4 "><b>Where can you find the LSF files?</b></font>
The COS team maintains up-to-date LSF files on the <a class="reference external" href="https://www.stsci.edu/hst/instrumentation/cos/performance/spectral-resolution">COS Spectral Resolution page</a>. Opening up this link leads to a page like that shown in Fig. 1.1, where the LSF files are discussed in detail. The bottom part of this page has links to all the relavent files. The links at the top of the page will take you to the relevant section. In Fig. 1.1, we have circled in black the link to the section pertaining to our data: FUV at the Lifetime Position: 3.</p>
<section id="center-fig-1-1-screenshot-of-the-cos-spectral-resolution-site-center">
<h3><center> Fig 1.1: Screenshot of the COS Spectral Resolution Site</center><a class="headerlink" href="#center-fig-1-1-screenshot-of-the-cos-spectral-resolution-site-center" title="Permalink to this heading">#</a></h3>
<center><img src=./figures/LSFHomepage.png width ="900" title="COS Spectral Resolution Site"> </center>
<p>Clicking on the circled link takes us to the table of hyperlinks to all the files perataining to data taken with the FUV, Lifetime Postition 3 configutation, shown in Fig. 1.2:</p>
</section>
<section id="center-fig-1-2-screenshot-of-the-cos-spectral-resolution-site-focus-on-lp-pos-3-center">
<h3><center>Fig 1.2: Screenshot of the COS Spectral Resolution Site - Focus on LP-POS 3</center><a class="headerlink" href="#center-fig-1-2-screenshot-of-the-cos-spectral-resolution-site-focus-on-lp-pos-3-center" title="Permalink to this heading">#</a></h3>
<center><img src=./figures/LSFHomepage2.png width ="900" title="COS Spectral Resolution Site - Lifetime Position 3"> </center>
<p>Circled in solid red is the button to download the LSF file we need for our data with CENWAVE = 1291. Circled in dashed black is the corresponding CDSF.</p>
<p>You can click on the solid red circled button to download the LSF file and move it to this current working directory <strong>or</strong> right-click and select “Download Linked File As…” and download directly to this directory.</p>
<ul class="simple">
<li><p><em>This step may look somewhat different depending on your browser</em></p></li>
<li><p><em>If you’re unsure of the current working directory, un-comment the <code class="docutils literal notranslate"><span class="pre">print</span></code> statement in the next cell, and run the cell.</em></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># equivalent of !pwd</span>
<span class="c1"># print(cwd.resolve())</span>
</pre></div>
</div>
</div>
</div>
<p>These files can also be downloaded programmatically from with python, with the function we define below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fetch_files</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="n">grating</span><span class="p">,</span> <span class="n">lpPos</span><span class="p">,</span> <span class="n">cenwave</span><span class="p">,</span> <span class="n">disptab</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given all the inputs, this will download both</span>
<span class="sd">    the LSF and Disptab files to use in the convolution and return their paths.</span>

<span class="sd">    Input: </span>
<span class="sd">    det (str): The detector used</span>
<span class="sd">    grating (str): Type of grating used</span>
<span class="sd">    lpPos (str): Lifetime position used</span>
<span class="sd">    cenwave (str): Central wavelength used</span>
<span class="sd">    disptab (str): DISPTAB used (will get the path in the function)</span>

<span class="sd">    Returns:</span>
<span class="sd">    LSF_file_name (str): filename of the new downloaded LSF file</span>
<span class="sd">    disptab_path (str): path to the new downloaded disptab file</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Link to where all the files live</span>
    <span class="n">COS_site_rootname</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;https://www.stsci.edu/files/live/sites/www/files/&quot;</span>
        <span class="s2">&quot;home/hst/instrumentation/cos/&quot;</span>
        <span class="s2">&quot;performance/spectral-resolution/_documents/&quot;</span>
    <span class="p">)</span>  

    <span class="c1"># Only one file for NUV</span>
    <span class="k">if</span> <span class="n">det</span> <span class="o">==</span> <span class="s2">&quot;NUV&quot;</span><span class="p">:</span>
        <span class="n">LSF_file_name</span> <span class="o">=</span> <span class="s2">&quot;nuv_model_lsf.dat&quot;</span>

    <span class="c1"># FUV files follow a naming pattern</span>
    <span class="k">elif</span> <span class="n">det</span> <span class="o">==</span> <span class="s2">&quot;FUV&quot;</span><span class="p">:</span>
        <span class="n">LSF_file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;aa_LSFTable_</span><span class="si">{</span><span class="n">grating</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cenwave</span><span class="si">}</span><span class="s2">_LP</span><span class="si">{</span><span class="n">lpPos</span><span class="si">}</span><span class="s2">_cn.dat&quot;</span>

    <span class="c1"># Where to find file online</span>
    <span class="n">LSF_file_webpath</span> <span class="o">=</span> <span class="n">COS_site_rootname</span> <span class="o">+</span> <span class="n">LSF_file_name</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span>
        <span class="n">LSF_file_webpath</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">datadir</span> <span class="o">/</span> <span class="n">LSF_file_name</span><span class="p">)</span>
    <span class="p">)</span>
    
    <span class="c1"># Where to save file to locally</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded LSF file to </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">datadir</span><span class="o">/</span><span class="w"> </span><span class="n">LSF_file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># And we&#39;ll need to get the DISPTAB file as well</span>
    <span class="n">disptab_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datadir</span> <span class="o">/</span> <span class="n">disptab</span><span class="p">)</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;https://hst-crds.stsci.edu/unchecked_get/references/hst/</span><span class="si">{</span><span class="n">disptab</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">disptab_path</span>
    <span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded DISPTAB file to </span><span class="si">{</span><span class="n">disptab_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">LSF_file_name</span><span class="p">,</span> <span class="n">disptab_path</span>
</pre></div>
</div>
</div>
</div>
<p>We’ll run this function with the parameters we saved earlier to gather the proper LSF file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We&#39;ll pass that fetch function the parameters we determined earlier</span>
<span class="c1"># This &quot;unpacked argument&quot; phrasing works because of the order in which we added the params to the dict</span>
<span class="n">LSF_file_name</span><span class="p">,</span> <span class="n">disptab_path</span> <span class="o">=</span> <span class="n">fetch_files</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">param_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloaded LSF file to data/aa_LSFTable_G130M_1291_LP3_cn.dat
Downloaded DISPTAB file to data/5b919205l_disp.fits
</pre></div>
</div>
</div>
</div>
<p><a id = lookL></a></p>
</section>
</section>
<section id="taking-a-look-at-the-lsf-kernels">
<h2>2. Taking a look at the LSF kernels<a class="headerlink" href="#taking-a-look-at-the-lsf-kernels" title="Permalink to this heading">#</a></h2>
<p><a id = readL></a></p>
<section id="reading-in-an-lsf">
<h3>2.1. Reading in an LSF<a class="headerlink" href="#reading-in-an-lsf" title="Permalink to this heading">#</a></h3>
<p><strong>Below, we create a simple function to read in an LSF file as an astropy table:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">read_lsf</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="c1"># This is the table of all the LSFs: called &quot;lsf&quot;</span>
    <span class="c1"># The first column is a list of the wavelengths corresponding to the line profile, so we set our header accordingly</span>
    <span class="c1"># If its an NUV file, header starts 1 line later</span>
    <span class="k">if</span> <span class="s2">&quot;nuv_&quot;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
        <span class="n">ftype</span> <span class="o">=</span> <span class="s2">&quot;nuv&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detector used: </span><span class="si">{</span><span class="n">ftype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">hs</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Otherwise, assume its an FUV file</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ftype</span> <span class="o">=</span> <span class="s2">&quot;fuv&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detector used: </span><span class="si">{</span><span class="n">ftype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">hs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">lsf</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span>
                     <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">,</span>
                     <span class="n">header_start</span><span class="o">=</span><span class="n">hs</span><span class="p">)</span>

    <span class="c1"># This is the range of each LSF in pixels (for FUV from -160 to +160, inclusive)</span>
    <span class="c1"># The middle pixel of the lsf is considered zero; the center is relative zero</span>

    <span class="c1"># Integer division to yield whole pixels</span>
    <span class="n">pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lsf</span><span class="p">))</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">lsf</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="c1"># The column names returned as integers.</span>
    <span class="n">lsf_wvlns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lsf</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>

    <span class="k">return</span> <span class="n">lsf</span><span class="p">,</span> <span class="n">pix</span><span class="p">,</span> <span class="n">lsf_wvlns</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Now let’s read the LSF file we downloaded and display the first 5 columns:</strong></p>
<p><em>Because this is an FUV file, the columns are 321 values long, corresponding to the 321 pixel size of an LSF kernal in the FUV.</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lsf</span><span class="p">,</span> <span class="n">pix</span><span class="p">,</span> <span class="n">lsf_wvlns</span> <span class="o">=</span> <span class="n">read_lsf</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datadir</span> <span class="o">/</span> <span class="n">LSF_file_name</span><span class="p">))</span>
<span class="n">lsf</span><span class="p">[</span><span class="n">lsf</span><span class="o">.</span><span class="n">colnames</span><span class="p">[:</span><span class="mi">5</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Detector used: fuv
</pre></div>
</div>
<div class="output text_html"><div><i>Table length=321</i>
<table id="table140624635260368" class="table-striped table-bordered table-condensed">
<thead><tr><th>1134</th><th>1139</th><th>1144</th><th>1149</th><th>1154</th></tr></thead>
<thead><tr><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>4.885797114010963e-06</td><td>4.787755984607906e-06</td><td>4.713489842513227e-06</td><td>4.735199692705489e-06</td><td>4.7784485923017495e-06</td></tr>
<tr><td>4.916023102906068e-06</td><td>4.873309105308387e-06</td><td>4.752957668230419e-06</td><td>4.749528365900715e-06</td><td>4.8460096205578055e-06</td></tr>
<tr><td>4.941950149310319e-06</td><td>4.954122351536572e-06</td><td>4.829737664959035e-06</td><td>4.819638005845053e-06</td><td>4.959435869169078e-06</td></tr>
<tr><td>4.975031355401172e-06</td><td>5.043803066313383e-06</td><td>4.943558000555235e-06</td><td>4.944166202963326e-06</td><td>5.105983074318574e-06</td></tr>
<tr><td>5.024945714942217e-06</td><td>5.132957330887238e-06</td><td>5.08655216831887e-06</td><td>5.110203690134147e-06</td><td>5.257588174065823e-06</td></tr>
<tr><td>5.1062647374008795e-06</td><td>5.226843223712312e-06</td><td>5.249334040421822e-06</td><td>5.292011369183484e-06</td><td>5.4004601352656915e-06</td></tr>
<tr><td>5.22334211429479e-06</td><td>5.329101494747061e-06</td><td>5.421819580311945e-06</td><td>5.476126509683101e-06</td><td>5.537769117220119e-06</td></tr>
<tr><td>5.363562444717191e-06</td><td>5.438680038755283e-06</td><td>5.589977083978292e-06</td><td>5.661455266614987e-06</td><td>5.679786309281309e-06</td></tr>
<tr><td>5.503054802394619e-06</td><td>5.554937875874203e-06</td><td>5.742187109577016e-06</td><td>5.841583683466683e-06</td><td>5.828667384063064e-06</td></tr>
<tr><td>5.624258813784741e-06</td><td>5.675603233615175e-06</td><td>5.872209611591034e-06</td><td>5.9970180710284226e-06</td><td>5.968283703978237e-06</td></tr>
<tr><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
<tr><td>5.538829078895442e-06</td><td>5.61452382644541e-06</td><td>5.785171777030175e-06</td><td>5.938726800824539e-06</td><td>6.006545611677446e-06</td></tr>
<tr><td>5.4710939230511685e-06</td><td>5.533244491994195e-06</td><td>5.726741058629339e-06</td><td>5.822288317661374e-06</td><td>5.894784543374904e-06</td></tr>
<tr><td>5.387839481809153e-06</td><td>5.458103038764225e-06</td><td>5.6470377934756154e-06</td><td>5.691283605758636e-06</td><td>5.750873288909732e-06</td></tr>
<tr><td>5.2992064517062305e-06</td><td>5.387313076900991e-06</td><td>5.540020267903346e-06</td><td>5.551977719200976e-06</td><td>5.5868670831158e-06</td></tr>
<tr><td>5.221160697526395e-06</td><td>5.320366681451691e-06</td><td>5.415092210912367e-06</td><td>5.402179516688138e-06</td><td>5.4169404397396914e-06</td></tr>
<tr><td>5.164281884145832e-06</td><td>5.2577636408949785e-06</td><td>5.289233084543136e-06</td><td>5.246140365509941e-06</td><td>5.258296979675213e-06</td></tr>
<tr><td>5.127032374917626e-06</td><td>5.1935627777544765e-06</td><td>5.173617813851988e-06</td><td>5.106882557229389e-06</td><td>5.115096193521994e-06</td></tr>
<tr><td>5.0992742707624055e-06</td><td>5.125375786306556e-06</td><td>5.076003036824709e-06</td><td>5.01082452583297e-06</td><td>4.988808887440265e-06</td></tr>
<tr><td>5.061823427754464e-06</td><td>5.04372509224167e-06</td><td>4.984863851741219e-06</td><td>4.952955359048715e-06</td><td>4.883922635184996e-06</td></tr>
<tr><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td></tr>
</table></div></div></div>
</div>
<p><a id = plotL></a></p>
</section>
<section id="plotting-an-lsf-kernel">
<h3>2.2. Plotting an LSF kernel<a class="headerlink" href="#plotting-an-lsf-kernel" title="Permalink to this heading">#</a></h3>
<p><strong>We can plot the LSF kernels themselves and take a look.</strong></p>
<p>Here’s a very simple plot of the first LSF kernel sampled at 1134 Å:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up the figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Fill the figure with a plot of the data</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">lsf</span><span class="p">[</span><span class="s2">&quot;1134&quot;</span><span class="p">])</span>

<span class="c1"># Give figure the title and labels</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Figure 2.1</span><span class="se">\n</span><span class="s2">COS FUV LSF kernel sampled at 1134 Å&quot;</span><span class="p">,</span>
          <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Pixel&quot;</span><span class="p">,</span>
           <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Flux [$normalized,unitless$]&quot;</span><span class="p">,</span>
           <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="c1"># Format and save the figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">plotsdir</span> <span class="o">/</span> <span class="s2">&quot;oneKernel.png&quot;</span><span class="p">),</span>
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/10294ab20c45c24bb5b567835375955e67b7b32b1b7a260a872b7460f1d70813.png" src="../../../_images/10294ab20c45c24bb5b567835375955e67b7b32b1b7a260a872b7460f1d70813.png" />
</div>
</div>
<p><strong>We’ll now make a more complex plot showing all of the lines contained in the LSF file, distributed in wavelength space.</strong></p>
<p><em>Note</em> that while the centers of the lines are correctly mapped to the LSF wavelength at which they were sampled, their kernel width <em>in pixels</em> has only been roughly translated to a wavelength range in Å. In short, the x-axis is not strictly to-scale. This will be rectified by the remapping shown in Fig 3.1.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                               <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
                               <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="c1"># Loop through the lsf kernels</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lsf</span><span class="o">.</span><span class="n">colnames</span><span class="p">):</span>
    <span class="c1"># Central position</span>
    <span class="n">line_wvln</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="c1"># Actual shape</span>
    <span class="n">contents</span> <span class="o">=</span> <span class="n">lsf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

    <span class="c1"># Split into the FUVB segment</span>
    <span class="k">if</span> <span class="n">line_wvln</span> <span class="o">&lt;</span> <span class="mi">1291</span><span class="p">:</span>
        <span class="c1"># ROUGHLY convert pix to wvln</span>
        <span class="n">xrange</span> <span class="o">=</span> <span class="mf">0.00997</span> <span class="o">*</span> <span class="n">pix</span> <span class="o">+</span> <span class="n">line_wvln</span>

        <span class="c1"># Plot the kernel</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xrange</span><span class="p">,</span> <span class="n">contents</span><span class="p">,</span>
                 <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        
        <span class="c1"># Plot the LSF wvln as a faded line</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">line_wvln</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="c1"># Split into the FUVA segment</span>
    <span class="k">elif</span> <span class="n">line_wvln</span> <span class="o">&gt;</span> <span class="mi">1291</span><span class="p">:</span>
        <span class="c1"># ROUGHLY convert pix to wvln</span>
        <span class="n">xrange</span> <span class="o">=</span> <span class="mf">0.00997</span> <span class="o">*</span> <span class="n">pix</span> <span class="o">+</span> <span class="n">line_wvln</span>
        
        <span class="c1"># Plot the kernel</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xrange</span><span class="p">,</span> <span class="n">contents</span><span class="p">,</span>
                 <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        
        <span class="c1"># Plot the LSF wvln as a faded line</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">line_wvln</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="c1"># Format the figure</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">1290</span><span class="p">,</span> <span class="mi">1435</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">1125</span><span class="p">,</span> <span class="mi">1295</span><span class="p">)</span>

<span class="c1"># Add labels, titles and text</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fig 2.2</span><span class="se">\n</span><span class="s2">All the LSF kernels in </span><span class="si">{</span><span class="n">LSF_file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
             <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;FUVB Detector&quot;</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;FUVA Detector&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Approximate Wavelength [$\AA$]&quot;</span><span class="p">,</span>
               <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="s2">&quot;Flux [$normalized,unitless$]&quot;</span><span class="p">,</span>
         <span class="n">x</span><span class="o">=-</span><span class="mf">0.01</span><span class="p">,</span>
         <span class="n">y</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span>
         <span class="n">rotation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span>
         <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># Save the figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">plotsdir</span> <span class="o">/</span> <span class="s2">&quot;allKernels.png&quot;</span><span class="p">),</span>
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/b0e88971ab81e90ef879a51cace1e4a16abbe9d909c1a4f11be19ab302d652e7.png" src="../../../_images/b0e88971ab81e90ef879a51cace1e4a16abbe9d909c1a4f11be19ab302d652e7.png" />
</div>
</div>
<section id="we-will-also-demonstrate-all-of-the-above-for-a-nuv-dataset">
<h4>We will also demonstrate all of the above for a NUV dataset:<a class="headerlink" href="#we-will-also-demonstrate-all-of-the-above-for-a-nuv-dataset" title="Permalink to this heading">#</a></h4>
<p><strong>First, downloading the NUV data and getting the relevant header parameters:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># NUV: download the data</span>
<span class="n">pl</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span>
    <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span><span class="n">obs_id</span><span class="o">=</span><span class="s2">&quot;LBY606010&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="c1"># Search for file, generate data product list</span>
<span class="n">download</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span>
    <span class="c1"># Filter and download searched files</span>
    <span class="n">pl</span><span class="p">[</span><span class="n">pl</span><span class="p">[</span><span class="s2">&quot;productSubGroupDescription&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;X1DSUM&quot;</span><span class="p">],</span>
    <span class="n">download_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">datadir</span><span class="p">),</span>
<span class="p">)</span>

<span class="c1"># Give the program the path to your downloaded data</span>
<span class="n">nuvFile</span> <span class="o">=</span> <span class="n">download</span><span class="p">[</span><span class="s2">&quot;Local Path&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>


<span class="c1"># NUV: get relavent params:</span>
<span class="c1"># Select the primary header</span>
<span class="n">nuvHeader0</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">nuvFile</span><span class="p">,</span>
                            <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For the file </span><span class="si">{</span><span class="n">nuvFile</span><span class="si">}</span><span class="s2">, the relevant parameters are: &quot;</span><span class="p">)</span>

<span class="c1"># Make a dict to store what you find here</span>
<span class="n">nuv_param_dict</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">hdrKeyword</span> <span class="ow">in</span> <span class="p">[</span>
    <span class="s2">&quot;DETECTOR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;OPT_ELEM&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LIFE_ADJ&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CENWAVE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DISPTAB&quot;</span><span class="p">,</span>
<span class="p">]:</span>
    <span class="c1"># For DISPTAB</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Save the key/value pairs to the dictionary</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">nuvHeader0</span><span class="p">[</span><span class="n">hdrKeyword</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># DISPTAB needs the split here</span>
        <span class="n">nuv_param_dict</span><span class="p">[</span><span class="n">hdrKeyword</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="c1"># For other params</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
        <span class="c1"># Save the key/value pairs to the dictionary</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">nuvHeader0</span><span class="p">[</span><span class="n">hdrKeyword</span><span class="p">]</span>
        <span class="n">nuv_param_dict</span><span class="p">[</span><span class="n">hdrKeyword</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1"># Print the key/value pairs</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hdrKeyword</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/lby606010_x1dsum.fits to data/mastDownload/HST/lby606010/lby606010_x1dsum.fits ... [Done]
For the file data/mastDownload/HST/lby606010/lby606010_x1dsum.fits, the relevant parameters are: 
DETECTOR = NUV
OPT_ELEM = G185M
LIFE_ADJ = 1
CENWAVE = 1921
DISPTAB = 63p1559jl_disp.fits
</pre></div>
</div>
</div>
</div>
<p><strong>Downloading the disptab and LSF files:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># NUV: Fetch disptab + LSF files</span>
<span class="c1"># We&#39;ll pass that fetch function the parameters we determined earlier</span>
<span class="c1"># This phrasing works because of the order in which we added the params to the dict</span>
<span class="n">nuv_LSF_file_name</span><span class="p">,</span> <span class="n">nuv_disptab_path</span> <span class="o">=</span> <span class="n">fetch_files</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">nuv_param_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloaded LSF file to data/nuv_model_lsf.dat
Downloaded DISPTAB file to data/63p1559jl_disp.fits
</pre></div>
</div>
</div>
</div>
<p><strong>Read in the NUV LSF kernels and plot them:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read in the NUV LSF kernels:</span>
<span class="n">lsf_nuv</span><span class="p">,</span> <span class="n">pix_nuv</span><span class="p">,</span> <span class="n">colnames_nuv</span> <span class="o">=</span> <span class="n">read_lsf</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datadir</span> <span class="o">/</span> <span class="n">nuv_LSF_file_name</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Detector used: nuv
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up the figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Fill the figure with a plot of the data</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pix_nuv</span><span class="p">,</span> <span class="n">lsf_nuv</span><span class="p">[</span><span class="s2">&quot;1800&quot;</span><span class="p">])</span>

<span class="c1"># Give fig the title and labels</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Figure 2.3</span><span class="se">\n</span><span class="s2">COS NUV LSF kernel sampled at 1800 Å&quot;</span><span class="p">,</span>
          <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Pixel&quot;</span><span class="p">,</span>
           <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Flux [$normalized,unitless$]&quot;</span><span class="p">,</span>
           <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="c1"># format and save the figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">plotsdir</span> <span class="o">/</span> <span class="s2">&quot;oneKernel_nuv.png&quot;</span><span class="p">),</span>
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/2a3a7db0009415e1846821ae7743df66e6a16a8931474d51037d9d5c744197b4.png" src="../../../_images/2a3a7db0009415e1846821ae7743df66e6a16a8931474d51037d9d5c744197b4.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the approximate NUV dispersion to convert pixel --&gt; wavelength</span>
<span class="n">nuv_dtab</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">nuv_disptab_path</span><span class="p">)</span>
<span class="n">approx_disp</span> <span class="o">=</span> <span class="n">nuv_dtab</span><span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="p">(</span><span class="n">nuv_dtab</span><span class="p">[</span><span class="s2">&quot;CENWAVE&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1921</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">nuv_dtab</span><span class="p">[</span><span class="s2">&quot;SEGMENT&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;NUVB&quot;</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">nuv_dtab</span><span class="p">[</span><span class="s2">&quot;APERTURE&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;PSA&quot;</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">][</span><span class="s2">&quot;COEFF&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Now plot:</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax0</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                          <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                          <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="c1"># Loop through the lsf kernels:</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lsf_nuv</span><span class="o">.</span><span class="n">colnames</span><span class="p">):</span>
    <span class="c1"># Central position</span>
    <span class="n">line_wvln</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>  
    <span class="c1"># Actual data on line shape</span>
    <span class="n">contents</span> <span class="o">=</span> <span class="n">lsf_nuv</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

    <span class="c1"># Roughly convert pix to wvln</span>
    <span class="n">xrange</span> <span class="o">=</span> <span class="n">approx_disp</span> <span class="o">*</span> <span class="n">pix_nuv</span> <span class="o">+</span> <span class="n">line_wvln</span>  
    <span class="c1"># Plot the kernel</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xrange</span><span class="p">,</span> <span class="n">contents</span><span class="p">,</span>
             <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>  
    <span class="c1"># Plot the LSF wvln as a faded line</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">line_wvln</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>  

<span class="c1"># Add labels, titles and text</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fig 2.4</span><span class="se">\n</span><span class="s2">All the NUV LSF kernels in </span><span class="si">{</span><span class="n">nuv_LSF_file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
             <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength [$\AA$]&quot;</span><span class="p">,</span>
               <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Flux [$normalized,unitless$]&quot;</span><span class="p">,</span>
               <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="c1"># Format and save the figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">plotsdir</span> <span class="o">/</span> <span class="s2">&quot;allKernels_nuv.png&quot;</span><span class="p">),</span>
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/8a33bbf6a387ed3ef98b6527641dd212931a3bb9898ca81f369a75012d47bda5.png" src="../../../_images/8a33bbf6a387ed3ef98b6527641dd212931a3bb9898ca81f369a75012d47bda5.png" />
</div>
</div>
<p><a id = convL></a></p>
</section>
</section>
</section>
<section id="convolving-an-lsf">
<h2>3. Convolving an LSF<a class="headerlink" href="#convolving-an-lsf" title="Permalink to this heading">#</a></h2>
<p>Now we come to the <strong>central goal of the Notebook, convolving a spectrum with the COS LSF.</strong> We’ll begin by defining some functions we’ll use for the convolution.</p>
<p><a id = funcL></a></p>
<section id="defining-some-functions-for-lsf-convolution">
<h3>3.1. Defining some functions for LSF convolution<a class="headerlink" href="#defining-some-functions-for-lsf-convolution" title="Permalink to this heading">#</a></h3>
<p>We’ve already defined a function to read in the LSF file, but we’ll need the main function to take a spectrum and convolve it with the LSF kernel. We’ll call this function: <code class="docutils literal notranslate"><span class="pre">convolve_lsf</span></code>. This function will, in turn, call two short functions: <code class="docutils literal notranslate"><span class="pre">get_disp_params</span></code> and <code class="docutils literal notranslate"><span class="pre">redefine_lsf</span></code>.</p>
<p><a id = fndispL></a></p>
<section id="getting-the-dispersion-relationship-parameters">
<h4>3.1.1. Getting the dispersion relationship parameters<a class="headerlink" href="#getting-the-dispersion-relationship-parameters" title="Permalink to this heading">#</a></h4>
<p>First, we’ll define a function, <code class="docutils literal notranslate"><span class="pre">get_disp_params</span></code>, to interpret the DISPTAB to find the dispersion relationship.
If provided with a range of pixel values, it will apply the dispersion relationship to those values and return the equivalent wavelength values as well as the dispersion coefficients.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_disp_params</span><span class="p">(</span><span class="n">disptab</span><span class="p">,</span> <span class="n">cenwave</span><span class="p">,</span> <span class="n">segment</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to redefine_lsf(). Reads through a DISPTAB file and gives relevant</span>
<span class="sd">    dispersion relationship/wavelength solution over input pixels.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    disptab (str): Path to your DISPTAB file.</span>
<span class="sd">    cenwave (str): Cenwave for calculation of dispersion relationship.</span>
<span class="sd">    segment (str): FUVA or FUVB?</span>
<span class="sd">    x (list): Range in pixels over which to calculate wvln with dispersion relationship (optional).</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    disp_coeff (list): Coefficients of the relevant polynomial dispersion relationship</span>
<span class="sd">    wavelength (list; if applicable): Wavelengths corresponding to input x pixels </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">disptab</span><span class="p">)</span> <span class="k">as</span> <span class="n">d</span><span class="p">:</span>
        <span class="n">wh_disp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cenwave&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cenwave</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;segment&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">segment</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;aperture&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;PSA&quot;</span><span class="p">)</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># 0 is needed as this returns nested list [[arr]]</span>
        <span class="n">disp_coeff</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">wh_disp</span><span class="p">][</span><span class="s2">&quot;COEFF&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># If given a pixel range, build up a polynomial wvln solution pix -&gt; λ</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">wavelength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">disp_coeff</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">16384</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">disp_coeff</span><span class="p">,</span> <span class="n">wavelength</span>
    
    <span class="c1"># If x is empty:</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">disp_coeff</span>
</pre></div>
</div>
</div>
</div>
<p><a id="fnredefL"></a></p>
</section>
<section id="redefining-the-lsf-in-terms-of-wavelength">
<h4>3.1.2. Redefining the LSF in terms of wavelength<a class="headerlink" href="#redefining-the-lsf-in-terms-of-wavelength" title="Permalink to this heading">#</a></h4>
<p>Now, we’ll define a function, <code class="docutils literal notranslate"><span class="pre">redefine_lsf</span></code>, to apply the dispersion relationship to the LSF kernels.
This effectively converts an LSF kernel from a function of pixel to a function of wavelength, making it compatible with a spectrum.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">redefine_lsf</span><span class="p">(</span><span class="n">lsf_file</span><span class="p">,</span> <span class="n">cenwave</span><span class="p">,</span> <span class="n">disptab</span><span class="p">,</span> <span class="n">detector</span><span class="o">=</span><span class="s2">&quot;FUV&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to convolve_lsf(). Converts the LSF kernels in the LSF file from a fn(pixel) -&gt; fn(λ)</span>
<span class="sd">    which can then be used by convolve_lsf() and re-bins the kernels.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    lsf_file (str): path to your LSF file</span>
<span class="sd">    cenwave (str): Cenwave for calculation of dispersion relationship</span>
<span class="sd">    disptab (str): path to your DISPTAB file</span>
<span class="sd">    detector (str): FUV or NUV?</span>

<span class="sd">    Returns:</span>
<span class="sd">    new_lsf (numpy.ndarray): Remapped LSF kernels.</span>
<span class="sd">    new_w (numpy.ndarray): New LSF kernel&#39;s LSF wavelengths.</span>
<span class="sd">    step (float): first order coefficient of the FUVA dispersion relationship; proxy for Δλ/Δpixel.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">detector</span> <span class="o">==</span> <span class="s2">&quot;FUV&quot;</span><span class="p">:</span>
        <span class="n">xfull</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">16384</span><span class="p">)</span>

        <span class="c1"># Read in the dispersion relationship here for the segments</span>
        <span class="c1"># FUVA is simple</span>
        <span class="n">disp_coeff_a</span><span class="p">,</span> <span class="n">wavelength_a</span> <span class="o">=</span> <span class="n">get_disp_params</span><span class="p">(</span><span class="n">disptab</span><span class="p">,</span>
                                                     <span class="n">cenwave</span><span class="p">,</span>
                                                     <span class="s2">&quot;FUVA&quot;</span><span class="p">,</span>
                                                     <span class="n">x</span><span class="o">=</span><span class="n">xfull</span><span class="p">)</span>
        
        <span class="c1"># FUVB isn&#39;t taken for cenwave 1105, nor 800:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cenwave</span> <span class="o">!=</span> <span class="mi">1105</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cenwave</span> <span class="o">!=</span> <span class="mi">800</span><span class="p">):</span>
            <span class="n">disp_coeff_b</span><span class="p">,</span> <span class="n">wavelength_b</span> <span class="o">=</span> <span class="n">get_disp_params</span><span class="p">(</span><span class="n">disptab</span><span class="p">,</span>
                                                         <span class="n">cenwave</span><span class="p">,</span>
                                                         <span class="s2">&quot;FUVB&quot;</span><span class="p">,</span>
                                                         <span class="n">x</span><span class="o">=</span><span class="n">xfull</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">cenwave</span> <span class="o">==</span> <span class="mi">1105</span><span class="p">:</span>
            <span class="c1"># 1105 doesn&#39;t have an FUVB so set it to something arbitrary and clearly not real:</span>
            <span class="n">wavelength_b</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">99.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>

        <span class="c1"># Get the step size info from the FUVA 1st order dispersion coefficient</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">disp_coeff_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Read in the lsf file</span>
        <span class="n">lsf</span><span class="p">,</span> <span class="n">pix</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">read_lsf</span><span class="p">(</span><span class="n">lsf_file</span><span class="p">)</span>

        <span class="c1"># Take median spacing between original LSF kernels</span>
        <span class="n">deltaw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>

        <span class="c1"># Resamples if the spacing of the original LSF wvlns is too narrow</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">deltaw</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pix</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span> <span class="o">*</span> <span class="mi">2</span><span class="p">):</span>  
            <span class="c1"># This is all a set up of the bins we want to use</span>
            <span class="c1"># The wvln difference between kernels of the new LSF should be about twice their width</span>
            <span class="n">new_deltaw</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pix</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">)</span>  

            <span class="c1"># nw = Number of LSF wavelengths</span>
            <span class="n">new_nw</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> <span class="o">/</span> <span class="n">new_deltaw</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  

            <span class="c1"># New version of lsf_wvlns</span>
            <span class="n">new_w</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">new_nw</span><span class="p">)</span> <span class="o">*</span> <span class="n">new_deltaw</span>  

            <span class="c1"># Populating the lsf with the proper bins:</span>
            <span class="c1"># Empty 2-D array to populate</span>
            <span class="n">new_lsf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">pix</span><span class="p">),</span> <span class="n">new_nw</span><span class="p">))</span> 

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">current_w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_w</span><span class="p">):</span>
                <span class="c1"># Find closest original LSF wavelength to new LSF wavelength</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">current_w</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span>  
                <span class="n">lsf_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
                <span class="c1"># Column name corresponding to closest orig LSF wvln</span>
                <span class="n">orig_lsf_wvln_key</span> <span class="o">=</span> <span class="n">lsf</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">lsf_index</span><span class="p">]</span>  
                <span class="c1"># Assign new LSF wvln the kernel of the closest original lsf wvln</span>
                <span class="n">new_lsf</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lsf</span><span class="p">[</span><span class="n">orig_lsf_wvln_key</span><span class="p">])</span>  

        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_lsf</span> <span class="o">=</span> <span class="n">lsf</span>
            <span class="n">new_w</span> <span class="o">=</span> <span class="n">w</span>

        <span class="k">return</span> <span class="n">new_lsf</span><span class="p">,</span> <span class="n">new_w</span><span class="p">,</span> <span class="n">step</span>

    <span class="k">elif</span> <span class="n">detector</span> <span class="o">==</span> <span class="s2">&quot;NUV&quot;</span><span class="p">:</span>
        <span class="n">xfull</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>

        <span class="c1"># Read in the dispersion relationship here for the segments</span>
        <span class="n">disp_coeff_a</span><span class="p">,</span> <span class="n">wavelength_a</span> <span class="o">=</span> <span class="n">get_disp_params</span><span class="p">(</span><span class="n">disptab</span><span class="p">,</span>
                                                     <span class="n">cenwave</span><span class="p">,</span>
                                                     <span class="s2">&quot;NUVA&quot;</span><span class="p">,</span>
                                                     <span class="n">x</span><span class="o">=</span><span class="n">xfull</span><span class="p">)</span>
        
        <span class="n">disp_coeff_b</span><span class="p">,</span> <span class="n">wavelength_b</span> <span class="o">=</span> <span class="n">get_disp_params</span><span class="p">(</span><span class="n">disptab</span><span class="p">,</span>
                                                     <span class="n">cenwave</span><span class="p">,</span>
                                                     <span class="s2">&quot;NUVB&quot;</span><span class="p">,</span>
                                                     <span class="n">x</span><span class="o">=</span><span class="n">xfull</span><span class="p">)</span>
        
        <span class="n">disp_coeff_c</span><span class="p">,</span> <span class="n">wavelength_c</span> <span class="o">=</span> <span class="n">get_disp_params</span><span class="p">(</span><span class="n">disptab</span><span class="p">,</span>
                                                     <span class="n">cenwave</span><span class="p">,</span>
                                                     <span class="s2">&quot;NUVC&quot;</span><span class="p">,</span>
                                                     <span class="n">x</span><span class="o">=</span><span class="n">xfull</span><span class="p">)</span>

        <span class="c1"># Get the step size info from the NUVB 1st order dispersion coefficient</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">disp_coeff_b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Read in the lsf file</span>
        <span class="n">lsf</span><span class="p">,</span> <span class="n">pix</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">read_lsf</span><span class="p">(</span><span class="n">lsf_file</span><span class="p">)</span>

        <span class="c1"># Take median spacing between original LSF kernels</span>
        <span class="n">deltaw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>

        <span class="c1"># This section is a set up of the new bins we want to use:</span>
        <span class="c1"># The wvln difference between kernels of the new LSF should be about twice their width</span>
        <span class="n">new_deltaw</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pix</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">)</span> 

        <span class="c1"># nw = Number of LSF wavelengths</span>
        <span class="n">new_nw</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> <span class="o">/</span> <span class="n">new_deltaw</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  

        <span class="c1"># New version of lsf_wvlns</span>
        <span class="n">new_w</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">new_nw</span><span class="p">)</span> <span class="o">*</span> <span class="n">new_deltaw</span>  

        <span class="c1"># Populating the lsf with the proper bins:</span>
        <span class="c1"># Empty 2-D array to populate</span>
        <span class="n">new_lsf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">pix</span><span class="p">),</span> <span class="n">new_nw</span><span class="p">))</span>  

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">current_w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_w</span><span class="p">):</span>
            <span class="c1"># Find closest original LSF wavelength to new LSF wavelength</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">current_w</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span>  
            <span class="n">lsf_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>

            <span class="c1"># Column name corresponding to closest orig LSF wvln</span>
            <span class="n">orig_lsf_wvln_key</span> <span class="o">=</span> <span class="n">lsf</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">lsf_index</span><span class="p">]</span>  
            
            <span class="c1"># Assign new LSF wvln the kernel of the closest original lsf wvln</span>
            <span class="n">new_lsf</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lsf</span><span class="p">[</span><span class="n">orig_lsf_wvln_key</span><span class="p">])</span>  
            
        <span class="k">return</span> <span class="n">new_lsf</span><span class="p">,</span> <span class="n">new_w</span><span class="p">,</span> <span class="n">step</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Let’s make a version of the Fig. 2.2 with these newly remapped LSF kernels:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate the redefined lsf for the plot</span>
<span class="n">new_lsf</span><span class="p">,</span> <span class="n">new_w</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="n">redefine_lsf</span><span class="p">(</span>
    <span class="nb">str</span><span class="p">(</span><span class="n">datadir</span> <span class="o">/</span> <span class="n">LSF_file_name</span><span class="p">),</span>
    <span class="n">param_dict</span><span class="p">[</span><span class="s2">&quot;CENWAVE&quot;</span><span class="p">],</span>
    <span class="nb">str</span><span class="p">(</span><span class="n">datadir</span> <span class="o">/</span> <span class="n">param_dict</span><span class="p">[</span><span class="s2">&quot;DISPTAB&quot;</span><span class="p">]),</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                               <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
                               <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="c1"># Loop through the new remapped lsf kernels</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_w</span><span class="p">):</span>
    <span class="c1"># Central position</span>
    <span class="n">line_wvln</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="c1"># Actual shape  </span>
    <span class="n">contents</span> <span class="o">=</span> <span class="n">new_lsf</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>  

    <span class="c1"># Split into the FUVB segment</span>
    <span class="k">if</span> <span class="n">line_wvln</span> <span class="o">&lt;</span> <span class="mi">1291</span><span class="p">:</span>  
        <span class="c1"># ROUGHLY convert pix to wvln</span>
        <span class="n">xrange</span> <span class="o">=</span> <span class="n">new_w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">pix</span> <span class="o">*</span> <span class="n">step</span>  
        
        <span class="c1"># Plot the kernel</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xrange</span><span class="p">,</span> <span class="n">contents</span><span class="p">,</span>
                 <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>  
        
        <span class="c1"># Plot the LSF wvln as a faded line</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">line_wvln</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> 
         
    <span class="c1"># Split into the FUVA segment</span>
    <span class="k">elif</span> <span class="n">line_wvln</span> <span class="o">&gt;</span> <span class="mi">1291</span><span class="p">:</span>  
        <span class="c1"># ROUGHLY convert pix to wvln</span>
        <span class="n">xrange</span> <span class="o">=</span> <span class="n">new_w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">pix</span> <span class="o">*</span> <span class="n">step</span>  
        <span class="c1"># Plot the kernel</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xrange</span><span class="p">,</span> <span class="n">contents</span><span class="p">,</span>
                 <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>  
        <span class="c1"># Plot the LSF wvln as a faded line</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">line_wvln</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>  

<span class="c1"># Add labels, titles and text</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fig 3.1</span><span class="se">\n</span><span class="s2">All the $remapped$ LSF kernels in </span><span class="si">{</span><span class="n">LSF_file_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;FUVB Detector&quot;</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;FUVA Detector&quot;</span><span class="p">)</span>

<span class="n">ax0</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">1290</span><span class="p">,</span> <span class="mi">1435</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">1125</span><span class="p">,</span> <span class="mi">1295</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength [$\AA$]&quot;</span><span class="p">,</span>
               <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="s2">&quot;Flux [$normalized,unitless$]&quot;</span><span class="p">,</span>
         <span class="n">x</span><span class="o">=-</span><span class="mf">0.01</span><span class="p">,</span>
         <span class="n">y</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span>
         <span class="n">rotation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span>
         <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="c1"># format and save the figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">plotsdir</span> <span class="o">/</span> <span class="s2">&quot;allKernels_new.png&quot;</span><span class="p">),</span>
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Detector used: fuv
</pre></div>
</div>
<img alt="../../../_images/24e171b0b2e6ce330a36716e268ed681e8213eb0e1a68227051052b3c9e0b7ac.png" src="../../../_images/24e171b0b2e6ce330a36716e268ed681e8213eb0e1a68227051052b3c9e0b7ac.png" />
</div>
</div>
<p><a id = fnconvL></a></p>
</section>
<section id="applying-the-convolution">
<h4>3.1.3. Applying the convolution<a class="headerlink" href="#applying-the-convolution" title="Permalink to this heading">#</a></h4>
<p>Finally, we’ll define the main function, <code class="docutils literal notranslate"><span class="pre">convolve_lsf</span></code>, to convolve the template spectrum with the redefined LSF:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">convolve_lsf</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">cenwave</span><span class="p">,</span> <span class="n">lsf_file</span><span class="p">,</span> <span class="n">disptab</span><span class="p">,</span> <span class="n">detector</span><span class="o">=</span><span class="s2">&quot;FUV&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main function; Convolves an input spectrum - i.e. template or STIS spectrum - with the COS LSF.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    wavelength (list or array): Wavelengths of the spectrum to convolve.</span>
<span class="sd">    spec (list or array): Fluxes or intensities of the spectrum to convolve.</span>
<span class="sd">    cenwave (str): Cenwave for calculation of dispersion relationship</span>
<span class="sd">    lsf_file (str): Path to your LSF file</span>
<span class="sd">    disptab (str): Path to your DISPTAB file</span>
<span class="sd">    detector (str) : Assumes an FUV detector, but you may specify &#39;NUV&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    wave_cos (numpy.ndarray): Wavelengths of convolved spectrum.!Different length from input wvln</span>
<span class="sd">    final_spec (numpy.ndarray): New LSF kernel&#39;s LSF wavelengths.!Different length from input spec</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># First calls redefine to get right format of LSF kernels</span>
    <span class="n">new_lsf</span><span class="p">,</span> <span class="n">new_w</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="n">redefine_lsf</span><span class="p">(</span><span class="n">lsf_file</span><span class="p">,</span>
                                        <span class="n">cenwave</span><span class="p">,</span>
                                        <span class="n">disptab</span><span class="p">,</span>
                                        <span class="n">detector</span><span class="o">=</span><span class="n">detector</span><span class="p">)</span>

    <span class="c1"># Sets up new wavelength scale used in the convolution</span>
    <span class="n">nstep</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">wavelength</span><span class="p">))</span> <span class="o">/</span> <span class="n">step</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">wave_cos</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nstep</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span>

    <span class="c1"># Resampling onto the input spectrum&#39;s wavelength scale:</span>
    <span class="c1"># Builds up interpolated function from input spectrum</span>
    <span class="n">interp_func</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>  

    <span class="c1"># Builds interpolated initial spectrum at COS&#39; wavelength scale for convolution</span>
    <span class="n">spec_cos</span> <span class="o">=</span> <span class="n">interp_func</span><span class="p">(</span><span class="n">wave_cos</span><span class="p">)</span>  

    <span class="c1"># Initializes final spectrum to the interpolated input spectrum</span>
    <span class="n">final_spec</span> <span class="o">=</span> <span class="n">interp_func</span><span class="p">(</span><span class="n">wave_cos</span><span class="p">)</span>  

    <span class="c1"># Loop through the redefined LSF kernels:</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_w</span><span class="p">):</span>  
        <span class="c1"># First need to find the boundaries of each kernel&#39;s &quot;jurisdiction&quot;: where it applies</span>
        <span class="c1"># The first and last elements need to be treated separately</span>

        <span class="c1"># First kernel:</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  
            <span class="n">diff_wave_left</span> <span class="o">=</span> <span class="mi">500</span>
            <span class="n">diff_wave_right</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_w</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="c1"># Last kernel</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_w</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>  
            <span class="n">diff_wave_right</span> <span class="o">=</span> <span class="mi">500</span>
            <span class="n">diff_wave_left</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="n">new_w</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="c1"># All other kernels</span>
        <span class="k">else</span><span class="p">:</span>  
            <span class="n">diff_wave_left</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="n">new_w</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">diff_wave_right</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_w</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="c1"># Splitting up the spectrum into slices around the redefined LSF kernel wvlns</span>
        <span class="c1"># Will apply the kernel corresponding to that chunk to that region of the spectrum - its &quot;jurisdiction&quot;</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">wave_cos</span> <span class="o">&lt;</span> <span class="n">w</span> <span class="o">+</span> <span class="n">diff_wave_right</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wave_cos</span> <span class="o">&gt;=</span> <span class="n">w</span> <span class="o">-</span> <span class="n">diff_wave_left</span><span class="p">)</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Off the edge, go to the next chunk</span>
            <span class="k">continue</span>

        <span class="c1"># Selects the current kernel</span>
        <span class="n">current_lsf</span> <span class="o">=</span> <span class="n">new_lsf</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>  

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">current_lsf</span>
        <span class="p">):</span>  <span class="c1"># Makes sure that the kernel is smaller than the chunk</span>
            <span class="n">final_spec</span><span class="p">[</span><span class="n">chunk</span><span class="p">]</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span>
                <span class="n">spec_cos</span><span class="p">[</span><span class="n">chunk</span><span class="p">],</span>
                <span class="c1"># Applies the actual convolution</span>
                <span class="n">current_lsf</span><span class="p">,</span>  
                <span class="n">boundary</span><span class="o">=</span><span class="s2">&quot;extend&quot;</span><span class="p">,</span>
                <span class="n">normalize_kernel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># Remember, not the same length as input spectrum data!</span>
    <span class="k">return</span> <span class="n">wave_cos</span><span class="p">,</span> <span class="n">final_spec</span>  
</pre></div>
</div>
</div>
</div>
<p><a id = picketL></a></p>
</section>
</section>
<section id="convolving-simple-line-profiles">
<h3>3.2. Convolving simple line profiles<a class="headerlink" href="#convolving-simple-line-profiles" title="Permalink to this heading">#</a></h3>
<p>Let’s demonstrate the convolution with a quick initial plot.</p>
<p>The cell below first creates a simple synthetic spectrum (with a wavelength range from 1147-1153Å and a Voigt profile emission line at 1150Å), then convolves it with the COS LSF. The next cell then plots the two spectra together.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate data:</span>
<span class="c1"># Define a model spectral line with a Voigt profile</span>
<span class="n">voigt_shape</span> <span class="o">=</span> <span class="n">functional_models</span><span class="o">.</span><span class="n">Voigt1D</span><span class="p">(</span><span class="n">x_0</span><span class="o">=</span><span class="mi">1150</span><span class="p">,</span>
                                        <span class="n">amplitude_L</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                        <span class="n">fwhm_G</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                                        <span class="n">fwhm_L</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>

<span class="c1"># Make a simple spectrum with just that line at 1150 Å:</span>
<span class="c1"># Generate x data - Minimum size of Δ6Å for the kernel to apply here.</span>
<span class="n">wvln_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1147</span><span class="p">,</span> <span class="mi">1153</span><span class="p">,</span>
                      <span class="nb">int</span><span class="p">(</span><span class="mf">1e5</span><span class="p">))</span>  

<span class="c1"># Generate the y data</span>
<span class="n">spec_in</span> <span class="o">=</span> <span class="n">voigt_shape</span><span class="p">(</span><span class="n">wvln_in</span><span class="p">)</span>  

<span class="c1"># Normalize the y data to a max of 1</span>
<span class="n">spec_in</span> <span class="o">/=</span> <span class="nb">max</span><span class="p">(</span><span class="n">spec_in</span><span class="p">)</span> 

<span class="c1"># Run the convolution:</span>
<span class="n">wvln_out</span><span class="p">,</span> <span class="n">spec_out</span> <span class="o">=</span> <span class="n">convolve_lsf</span><span class="p">(</span>
    <span class="n">wvln_in</span><span class="p">,</span>
    <span class="n">spec_in</span><span class="p">,</span>
    <span class="mi">1291</span><span class="p">,</span>
    <span class="nb">str</span><span class="p">(</span><span class="n">datadir</span> <span class="o">/</span> <span class="n">LSF_file_name</span><span class="p">),</span>
    <span class="nb">str</span><span class="p">(</span><span class="n">datadir</span> <span class="o">/</span> <span class="n">param_dict</span><span class="p">[</span><span class="s2">&quot;DISPTAB&quot;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Detector used: fuv
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make a plot from the data generated above:</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Plot the two spectra</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wvln_in</span><span class="p">,</span> <span class="n">spec_in</span><span class="p">,</span>
         <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Un-Convolved Voigt line spectrum&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">wvln_out</span><span class="p">,</span> <span class="n">spec_out</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Convolved Voigt line spectrum&quot;</span><span class="p">,)</span>

<span class="c1"># Format and give fig the title and labels</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Figure 3.2</span><span class="se">\n</span><span class="s2">Convolution applied to a single synthetic line in the FUV&quot;</span><span class="p">,</span>
          <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength [$\AA$]&quot;</span><span class="p">,</span>
           <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Flux [$normalized,unitless$]&quot;</span><span class="p">,</span>
           <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="c1"># Add a legend</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
           <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>

<span class="c1"># Save the figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">plotsdir</span> <span class="o">/</span> <span class="s2">&quot;applyConv1.png&quot;</span><span class="p">),</span>
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/e8dbfcf4a8e95784920e36a50b705e38dba3f1e080cff4c3e598134a3ecb0516.png" src="../../../_images/e8dbfcf4a8e95784920e36a50b705e38dba3f1e080cff4c3e598134a3ecb0516.png" />
</div>
</div>
<p>As shown above, the LSF pushes power from the line’s peak into the wings of the line profile.</p>
<p>And, as we confirm below, the total flux has not changed, but has just been spread out:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">integral1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">wvln_in</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">spec_in</span><span class="p">)</span>
<span class="n">integral2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">wvln_out</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">spec_out</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The integrated fluxes are within </span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">integral1</span><span class="o">-</span><span class="n">integral2</span><span class="p">)</span><span class="o">/</span><span class="n">integral2</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> % of eachother&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The integrated fluxes are within 0.06 % of eachother
</pre></div>
</div>
</div>
</div>
<p><strong>We can now examine how the convolution differs across the spectrum.</strong>
We do this by creating a <a class="reference external" href="https://en.wikipedia.org/wiki/Frequency_comb">“picket fence”/”frequency comb”</a>-like spectrum of evenly-spaced, identical, normalized Voigt profiles. Each of these lines is normalized to a maximum of 1.</p>
<p>We’ll make our synthetic spectrum slightly more realistic by converting from emission lines to absorption lines on a flat spectrum. To do this, we define a simple function, <code class="docutils literal notranslate"><span class="pre">emit2abs()</span></code>, which defines a flat continuum of 1, then multiplies this continuum by <span class="math notranslate nohighlight">\(e^{-emission\ spectrum}\)</span></p>
<p>We then use <code class="docutils literal notranslate"><span class="pre">convolve_lsf</span></code> to convolve each of these synthetic spectral lines with the LSF kernel under whose “jurisdiction” they fall. For each line, we plot <em>pre-</em> and <em>post-</em> convolution spectrum in the 8 smaller panels. In the bottom, larger panel, we also plot the entire spectrum of all the lines.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">emit2abs</span><span class="p">(</span><span class="n">emitspec</span><span class="p">,</span> <span class="n">continuum</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes an emission spectrum and &quot;reverses&quot; it, that is it:</span>
<span class="sd">    Makes a default flat continuum of 1 and subtracts exp(line)</span>
<span class="sd">    </span>
<span class="sd">    Inputs:</span>
<span class="sd">    emitspec (1D arraylike): the emission spectrum</span>
<span class="sd">    continuum (array or -1) : if -1, default of continuum of 1, \</span>
<span class="sd">        otherwise must be same length as emitspec</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">continuum</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">continuum</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">continuum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">emitspec</span><span class="p">))</span>
            
    <span class="n">abs_spec</span> <span class="o">=</span> <span class="n">continuum</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">emitspec</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">abs_spec</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build up a synthetic wavelength range comparable to a real COS spectrum</span>
<span class="n">wvln</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1120</span><span class="p">,</span> <span class="mi">1442</span><span class="p">,</span> <span class="mi">16384</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>  

<span class="c1"># Initialize the spectrum to continuum of zero, we&#39;ll build it up with a series of Voigt profiles</span>
<span class="n">flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">wvln</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="c1"># A copy of flux that we&#39;ll add each new line&#39;s flux to, in turn</span>
<span class="n">combo_flux</span> <span class="o">=</span> <span class="n">flux</span>  

<span class="c1"># Set up figure</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>

<span class="c1"># Using gridspec to control panel sizes and locations</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>  

<span class="c1"># Loop through the input spectrum&#39;s wavelength range and place a synthetic Voigt line every 40 Å</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">discrete_wvln</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">wvln</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">wvln</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">40</span><span class="p">)):</span>
    <span class="n">voigt_shape</span> <span class="o">=</span> <span class="n">functional_models</span><span class="o">.</span><span class="n">Voigt1D</span><span class="p">(</span>
        <span class="c1"># Center a Voigt profile there</span>
        <span class="n">x_0</span><span class="o">=</span><span class="n">discrete_wvln</span><span class="p">,</span>  
        <span class="n">amplitude_L</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">fwhm_G</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
        <span class="n">fwhm_L</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    
    <span class="c1"># Evaluate flux from that Voigt profile function</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">voigt_shape</span><span class="p">(</span><span class="n">wvln</span><span class="p">)</span> 

    <span class="c1"># Normalize that line&#39;s flux</span>
    <span class="n">flux</span> <span class="o">/=</span> <span class="nb">max</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>  

    <span class="c1"># Add each line&#39;s flux to total summed flux</span>
    <span class="n">combo_flux</span> <span class="o">=</span> <span class="n">combo_flux</span> <span class="o">+</span> <span class="n">flux</span>  

<span class="c1"># &quot;Reverse&quot; emission spectrum to absorption spectrum</span>
<span class="n">combo_flux</span> <span class="o">=</span> <span class="n">emit2abs</span><span class="p">(</span><span class="n">combo_flux</span><span class="p">)</span>

<span class="c1"># Apply the convolution to the combined (many-line) synthetic spectrum to create an lsf_convolved wvln and flux</span>
<span class="n">lwvln</span><span class="p">,</span> <span class="n">lsf_combo_flux</span> <span class="o">=</span> <span class="n">convolve_lsf</span><span class="p">(</span>
    <span class="n">wvln</span><span class="p">,</span>
    <span class="n">combo_flux</span><span class="p">,</span>
    <span class="mi">1291</span><span class="p">,</span>
    <span class="nb">str</span><span class="p">(</span><span class="n">datadir</span> <span class="o">/</span> <span class="n">LSF_file_name</span><span class="p">),</span>
    <span class="nb">str</span><span class="p">(</span><span class="n">datadir</span> <span class="o">/</span> <span class="n">param_dict</span><span class="p">[</span><span class="s2">&quot;DISPTAB&quot;</span><span class="p">]))</span>

<span class="c1"># Make the plots</span>

<span class="c1"># Loop through again to build up the plots</span>
<span class="c1"># This will make 8 subplots</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">discrete_wvln</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">wvln</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">wvln</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
<span class="p">):</span>  
    <span class="c1"># Build the small subplots for each line:</span>
    <span class="c1"># Add a plot at the correct position on the grid</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span>
        <span class="n">gs</span><span class="p">[</span><span class="mi">4</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">4</span><span class="p">):</span><span class="mi">4</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">4</span><span class="p">:(</span><span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>  
    
    <span class="c1"># First plot the original, unconvolved line at each position</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">wvln</span><span class="p">,</span> <span class="n">combo_flux</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Un-convolved&quot;</span><span class="p">)</span>
      
    <span class="c1"># Now plot the convolved line</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lwvln</span><span class="p">,</span> <span class="n">lsf_combo_flux</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;LSF-convolved&quot;</span><span class="p">)</span>  

    <span class="c1"># Now add the peak wvln</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">discrete_wvln</span><span class="p">,</span>
               <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span>
               <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">,</span>
               <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
               <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Peak of Voigt&quot;</span><span class="p">)</span>  

    <span class="c1"># Some formatting</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">discrete_wvln</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">discrete_wvln</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
                        <span class="n">style</span><span class="o">=</span><span class="s2">&quot;plain&quot;</span><span class="p">,</span>
                        <span class="n">useOffset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">useMathText</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Add a legend to the first subplot</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                  <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>

<span class="c1"># Build up lower plot of all the lines:</span>
<span class="n">low_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">8</span><span class="p">:,</span> <span class="p">:])</span>

<span class="n">low_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wvln</span><span class="p">,</span> <span class="n">combo_flux</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Un-convolved&quot;</span><span class="p">)</span>

<span class="n">low_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lwvln</span><span class="p">,</span> <span class="n">lsf_combo_flux</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;LSF-convolved&quot;</span><span class="p">)</span>

<span class="n">low_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
              <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
    <span class="s1">&#39;Fig 3.3</span><span class="se">\n</span><span class="s1">Comparison of convolutions across a &quot;picket fence&quot; of absorption lines in the FUV</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;Wavelength [$\AA$]&quot;</span><span class="p">,</span>
         <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
         <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span>
         <span class="sa">r</span><span class="s2">&quot;Flux [$normalized,\ unitless$]&quot;</span><span class="p">,</span>
         <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
         <span class="n">rotation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span>
         <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">plotsdir</span> <span class="o">/</span> <span class="s2">&quot;applyConv_picketFence.png&quot;</span><span class="p">),</span>
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span>
            <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Detector used: fuv
</pre></div>
</div>
<img alt="../../../_images/0080e5cec8a715c1fa36e4bc08fd1a276039d6d69faf1efab7eb224049c0cad4.png" src="../../../_images/0080e5cec8a715c1fa36e4bc08fd1a276039d6d69faf1efab7eb224049c0cad4.png" />
</div>
</div>
<p><strong>The figure above demonstrates the way in which the LSF changes significantly throughout the wavelength range of a spectrum.</strong></p>
<p>It can be difficult to distinguish the LSFs plotted on their own; however, the results of their convolution with a synthetic line shows some are more sharply peaked, or contain more flux in the wings, etc.</p>
<p><strong>We’ll finish this section with a brief example of convolving a line <em>in the NUV</em> with the relevant LSF:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate data:</span>
<span class="c1"># Define a model spectral line with a Voigt profile</span>
<span class="n">voigt_shape</span> <span class="o">=</span> <span class="n">functional_models</span><span class="o">.</span><span class="n">Voigt1D</span><span class="p">(</span><span class="n">x_0</span><span class="o">=</span><span class="mi">1803</span><span class="p">,</span>
                                        <span class="n">amplitude_L</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                        <span class="n">fwhm_G</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                                        <span class="n">fwhm_L</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>

<span class="c1"># Make a simple spectrum with just that line at 1150 Å:</span>
<span class="c1"># Generate x data - Minimum size of Δ6Å for the kernel to apply here.</span>
<span class="n">wvln_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1800</span><span class="p">,</span> <span class="mi">1806</span><span class="p">,</span>
                      <span class="nb">int</span><span class="p">(</span><span class="mf">1e4</span><span class="p">))</span>

<span class="c1"># Generate the y data</span>
<span class="n">spec_in</span> <span class="o">=</span> <span class="n">voigt_shape</span><span class="p">(</span><span class="n">wvln_in</span><span class="p">)</span>  

<span class="c1"># Normalize the y data to a max of 1</span>
<span class="n">spec_in</span> <span class="o">/=</span> <span class="nb">max</span><span class="p">(</span><span class="n">spec_in</span><span class="p">)</span>

<span class="c1"># Run the convolution:</span>
<span class="n">wvln_out</span><span class="p">,</span> <span class="n">spec_out</span> <span class="o">=</span> <span class="n">convolve_lsf</span><span class="p">(</span><span class="n">wavelength</span><span class="o">=</span><span class="n">wvln_in</span><span class="p">,</span>
                                  <span class="n">spec</span><span class="o">=</span><span class="n">spec_in</span><span class="p">,</span>
                                  <span class="n">cenwave</span><span class="o">=</span><span class="mi">1786</span><span class="p">,</span>
                                  <span class="n">lsf_file</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">datadir</span> <span class="o">/</span> <span class="n">nuv_LSF_file_name</span><span class="p">),</span>
                                  <span class="n">disptab</span><span class="o">=</span><span class="n">nuv_disptab_path</span><span class="p">,</span>
                                  <span class="n">detector</span><span class="o">=</span><span class="s2">&quot;NUV&quot;</span><span class="p">)</span>

<span class="c1"># Make a plot from that data:</span>
<span class="c1"># Set up figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Plot the two spectra</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wvln_in</span><span class="p">,</span> <span class="n">spec_in</span><span class="p">,</span>
         <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Un-Convolved Voigt line spectrum&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wvln_out</span><span class="p">,</span> <span class="n">spec_out</span><span class="p">,</span>
         <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
         <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
         <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
         <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Convolved Voigt line spectrum&quot;</span><span class="p">)</span>

<span class="c1"># Add a legend</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
           <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>

<span class="c1"># Give fig the title and labels</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Figure 3.4</span><span class="se">\n</span><span class="s2">Convolution applied to a single synthetic line in the NUV&quot;</span><span class="p">,</span>
          <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength [$\AA$]&quot;</span><span class="p">,</span>
           <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Flux [$normalized,unitless$]&quot;</span><span class="p">,</span>
           <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="c1"># Format and save the figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">plotsdir</span> <span class="o">/</span> <span class="s2">&quot;applyConv_nuv1.png&quot;</span><span class="p">),</span>
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>

<span class="c1"># Give the user a heads-up that the integrated fluxes should agree:</span>
<span class="n">integral1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">wvln_in</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">spec_in</span><span class="p">)</span>
<span class="n">integral2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">wvln_out</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">spec_out</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The integrated fluxes are within </span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">integral1</span><span class="o">-</span><span class="n">integral2</span><span class="p">)</span><span class="o">/</span><span class="n">integral2</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> % of eachother&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Detector used: nuv
The integrated fluxes are within 0.12 % of eachother
</pre></div>
</div>
<img alt="../../../_images/706e72d56c6b052c9c3d61c4622a1cd9a6ece65041b7c8a25ff4413619481fa8.png" src="../../../_images/706e72d56c6b052c9c3d61c4622a1cd9a6ece65041b7c8a25ff4413619481fa8.png" />
</div>
</div>
<p><strong>And we’ll create an <em>NUV</em> equivalent of Fig. 3.3:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up the DATA:</span>
<span class="c1"># Build up a synthetic wavelength range comparable to a real COS spectrum</span>
<span class="n">wvln</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1600</span><span class="p">,</span> <span class="mi">3300</span><span class="p">,</span>
                   <span class="nb">int</span><span class="p">(</span><span class="mf">1e6</span><span class="p">))</span>

<span class="c1"># Initialize the spectrum to zero, we&#39;ll build it up with a series of Voigt profiles</span>
<span class="n">flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">wvln</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># A copy of flux that we&#39;ll add each new line&#39;s flux to, in turn</span>
<span class="n">combo_flux</span> <span class="o">=</span> <span class="n">flux</span>

<span class="c1"># Set up figure</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="c1"># Using gridspec to let us control panel sizes and locations</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="c1"># Loop through the input spectrum&#39;s wavelength range and place a synthetic Voigt line every 40 Å</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">discrete_wvln</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">wvln</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">wvln</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">240</span><span class="p">)):</span>
    <span class="c1"># Center a Voigt profile there</span>
    <span class="n">voigt_shape</span> <span class="o">=</span> <span class="n">functional_models</span><span class="o">.</span><span class="n">Voigt1D</span><span class="p">(</span><span class="n">x_0</span><span class="o">=</span><span class="n">discrete_wvln</span><span class="p">,</span>
                                            <span class="n">amplitude_L</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                            <span class="n">fwhm_G</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                                            <span class="n">fwhm_L</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    
    <span class="c1"># Evaluate flux from that Voigt profile function</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">voigt_shape</span><span class="p">(</span><span class="n">wvln</span><span class="p">)</span>
    <span class="c1"># Normalize that line&#39;s flux</span>
    <span class="n">flux</span> <span class="o">/=</span> <span class="nb">max</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
    <span class="c1"># Add each line&#39;s flux to total summed flux</span>
    <span class="n">combo_flux</span> <span class="o">=</span> <span class="n">combo_flux</span> <span class="o">+</span> <span class="n">flux</span>

<span class="c1"># Reverse emit -&gt; abs spectrum</span>
<span class="n">combo_flux</span> <span class="o">=</span> <span class="n">emit2abs</span><span class="p">(</span><span class="n">combo_flux</span><span class="p">)</span>

<span class="c1"># Apply the convolution to the combined (many-line) synthetic spectrum to create an lsf_convolved wvln and flux</span>
<span class="n">lwvln</span><span class="p">,</span> <span class="n">lsf_combo_flux</span> <span class="o">=</span> <span class="n">convolve_lsf</span><span class="p">(</span><span class="n">wvln</span><span class="p">,</span>
                                     <span class="n">combo_flux</span><span class="p">,</span>
                                     <span class="mf">1786.0</span><span class="p">,</span>
                                     <span class="n">lsf_file</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">datadir</span> <span class="o">/</span> <span class="n">nuv_LSF_file_name</span><span class="p">),</span>
                                     <span class="n">disptab</span><span class="o">=</span><span class="n">nuv_disptab_path</span><span class="p">,</span>
                                     <span class="n">detector</span><span class="o">=</span><span class="s2">&quot;NUV&quot;</span><span class="p">)</span>

<span class="c1"># Make the plots:</span>
<span class="c1"># Loop through again to build up the 8 plots</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">discrete_wvln</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">wvln</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">wvln</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">240</span><span class="p">)</span>
<span class="p">):</span>
    <span class="c1"># Build the small subplots for each line:</span>
    <span class="c1"># Add a plot at the right position on the grid</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">4</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">4</span><span class="p">):</span><span class="mi">4</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">4</span><span class="p">:(</span><span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

    <span class="c1"># First plot the original, unconvolved line at each position</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wvln</span><span class="p">,</span> <span class="n">combo_flux</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Un-convolved&quot;</span><span class="p">)</span>

    <span class="c1"># Now plot the convolved line</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lwvln</span><span class="p">,</span> <span class="n">lsf_combo_flux</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;LSF-convolved&quot;</span><span class="p">)</span>
    
    <span class="c1"># Now add the peak wvln</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">discrete_wvln</span><span class="p">,</span>
               <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span>
               <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">,</span>
               <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
               <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Peak of Voigt&quot;</span><span class="p">)</span>
    
    <span class="c1"># Apply some formatting</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">discrete_wvln</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">discrete_wvln</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
                        <span class="n">style</span><span class="o">=</span><span class="s2">&quot;plain&quot;</span><span class="p">,</span>
                        <span class="n">useOffset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">useMathText</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Add a legend to the first subplot</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                  <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span>
        <span class="c1"># Rotate tick labels</span>
        <span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;right&quot;</span>
    <span class="p">)</span>

<span class="c1"># Build up lower plot of all the lines:</span>
<span class="n">low_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">8</span><span class="p">:,</span> <span class="p">:])</span>

<span class="n">low_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wvln</span><span class="p">,</span> <span class="n">combo_flux</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Un-convolved&quot;</span><span class="p">)</span>

<span class="n">low_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lwvln</span><span class="p">,</span> <span class="n">lsf_combo_flux</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;LSF-convolved&quot;</span><span class="p">)</span>

<span class="c1"># Add legend</span>
<span class="n">low_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
              <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
    <span class="s1">&#39;Fig 3.5</span><span class="se">\n</span><span class="s1">Comparison of convolutions across a &quot;picket fence&quot; of absorption lines in the NUV</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">,</span>
         <span class="sa">r</span><span class="s2">&quot;Wavelength [$\AA$]&quot;</span><span class="p">,</span>
         <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
         <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span>
         <span class="sa">r</span><span class="s2">&quot;Flux [$normalized,\ unitless$]&quot;</span><span class="p">,</span>
         <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
         <span class="n">rotation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span>
         <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">plotsdir</span> <span class="o">/</span> <span class="s2">&quot;applyConv_picketFence_nuv_absorb.png&quot;</span><span class="p">),</span>
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span>
            <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Detector used: nuv
</pre></div>
</div>
<img alt="../../../_images/0ecd770d85c9d518d10401ffcad2865dbd20425df174cf087ee5963fdd663829.png" src="../../../_images/0ecd770d85c9d518d10401ffcad2865dbd20425df174cf087ee5963fdd663829.png" />
</div>
</div>
<p><a id = stisL></a></p>
</section>
<section id="convolving-real-data-from-stis">
<h3>3.3. Convolving real data from STIS<a class="headerlink" href="#convolving-real-data-from-stis" title="Permalink to this heading">#</a></h3>
<p><strong>Let’s first read in the COS FUV spectrum.</strong> For more information, see our Notebook on <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/blob/main/notebooks/COS/ViewData/ViewData.ipynb">Reading-in and Plotting data COS in Python</a>. Ignore any <code class="docutils literal notranslate"><span class="pre">UnitsWarning</span></code>s.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reading in the FUV spectrum</span>
<span class="n">cos_table</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fuvFile</span><span class="p">)</span>

<span class="n">COS_wvln</span><span class="p">,</span> <span class="n">COS_flux</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

<span class="c1"># The COS segment at index 0 has a longer wvln domain</span>
<span class="k">for</span> <span class="n">cos_segment</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>  
    <span class="n">COS_wvln_</span><span class="p">,</span> <span class="n">COS_flux_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cos_table</span><span class="p">[</span><span class="n">cos_segment</span><span class="p">][</span><span class="s2">&quot;WAVELENGTH&quot;</span><span class="p">,</span> <span class="s2">&quot;FLUX&quot;</span><span class="p">])</span>
    
    <span class="n">COS_dqw_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cos_table</span><span class="p">[</span><span class="n">cos_segment</span><span class="p">][</span><span class="s2">&quot;DQ_WGT&quot;</span><span class="p">],</span>
                          <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    
    <span class="n">COS_wvln</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">COS_wvln_</span><span class="p">[</span><span class="n">COS_dqw_</span><span class="p">])</span>
    <span class="n">COS_flux</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">COS_flux_</span><span class="p">[</span><span class="n">COS_dqw_</span><span class="p">])</span>

<span class="n">COS_wvln</span><span class="p">,</span> <span class="n">COS_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">COS_wvln</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">COS_flux</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING: UnitsWarning: &#39;erg /s /cm**2 /angstrom&#39; contains multiple slashes, which is discouraged by the FITS standard [astropy.units.format.generic]
</pre></div>
</div>
</div>
</div>
<p><strong>Now, we download the STIS FUV spectrum</strong>, using astroquery, as demonstrated in our Notebook on <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/blob/main/notebooks/COS/DataDl/DataDl.ipynb">Downloading data from the archive</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Search for the file</span>
<span class="n">pl</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span>
    <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span><span class="n">obs_id</span><span class="o">=</span><span class="s2">&quot;O4WR11010&quot;</span><span class="p">,</span>
                                <span class="n">instrument_name</span><span class="o">=</span><span class="s2">&quot;STIS/FUV-MAMA&quot;</span><span class="p">))</span>  

<span class="c1"># Filter and download searched files</span>
<span class="n">download</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span>
    <span class="n">pl</span><span class="p">[</span><span class="n">pl</span><span class="p">[</span><span class="s2">&quot;productSubGroupDescription&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;X1D&quot;</span><span class="p">],</span>  
    <span class="n">download_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">datadir</span><span class="p">),</span>
<span class="p">)</span>

<span class="c1"># Give the program the path to your downloaded data</span>
<span class="n">stisfile</span> <span class="o">=</span> <span class="n">download</span><span class="p">[</span><span class="s2">&quot;Local Path&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/o4wr11010_x1d.fits to data/mastDownload/HST/o4wr11010/o4wr11010_x1d.fits ... [Done]
</pre></div>
</div>
</div>
</div>
<p><strong>We now read in the STIS spectrum.</strong></p>
<p>This is a bit trickier than with the COS data, as there are many more segments of the STIS data (one per echelle order), each represented by a row of the table. We choose to combine them all here and sort by wavelength, but this may or may not be the right choice for your data. For more information on working with STIS data, see the <a class="reference external" href="https://hst-docs.stsci.edu/stisdhb">STIS Instrument Handbook</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># read the fits to an astropy Table</span>
<span class="n">stis_table</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">stisfile</span><span class="p">)</span> 

<span class="c1"># Empty list to populate</span>
<span class="n">STIS_wvln</span><span class="p">,</span> <span class="n">STIS_flux</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span> 

<span class="c1"># go through Echelle order rows + populate</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stis_table</span><span class="p">)):</span> 
    <span class="c1"># We&#39;ll filter to only data with no identified quality issues</span>
    <span class="n">stis_chunk_mask</span> <span class="o">=</span> <span class="n">stis_table</span><span class="p">[</span><span class="s1">&#39;DQ&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> 

    <span class="n">STIS_wvln</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">stis_table</span><span class="p">[</span><span class="s1">&#39;WAVELENGTH&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">stis_chunk_mask</span><span class="p">])</span>
    <span class="n">STIS_flux</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">stis_table</span><span class="p">[</span><span class="s1">&#39;FLUX&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">stis_chunk_mask</span><span class="p">])</span>

<span class="c1"># Sort by wvln to work out order overlaps - blunt fix</span>
<span class="n">sort_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">STIS_wvln</span><span class="p">)</span> 

<span class="c1"># Get STIS spec as sorted array</span>
<span class="n">STIS_wvln</span><span class="p">,</span> <span class="n">STIS_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">STIS_wvln</span><span class="p">)[</span><span class="n">sort_order</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">STIS_flux</span><span class="p">)[</span><span class="n">sort_order</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING: UnitsWarning: &#39;Angstroms&#39; did not parse as fits unit: At col 0, Unit &#39;Angstroms&#39; not supported by the FITS standard. Did you mean Angstrom or angstrom? If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;Counts/s&#39; did not parse as fits unit: At col 0, Unit &#39;Counts&#39; not supported by the FITS standard. Did you mean count? If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;erg/s/cm**2/Angstrom&#39; contains multiple slashes, which is discouraged by the FITS standard [astropy.units.format.generic]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run the actual convolution on the STIS data - a simple task once we have those functions defined</span>
<span class="n">STIS_lwvln</span><span class="p">,</span> <span class="n">STIS_lflux</span> <span class="o">=</span> <span class="n">convolve_lsf</span><span class="p">(</span>
    <span class="n">STIS_wvln</span><span class="p">,</span>
    <span class="n">STIS_flux</span><span class="p">,</span>
    <span class="mi">1291</span><span class="p">,</span>
    <span class="nb">str</span><span class="p">(</span><span class="n">datadir</span> <span class="o">/</span> <span class="n">LSF_file_name</span><span class="p">),</span>
    <span class="nb">str</span><span class="p">(</span><span class="n">datadir</span> <span class="o">/</span> <span class="n">param_dict</span><span class="p">[</span><span class="s2">&quot;DISPTAB&quot;</span><span class="p">]),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Detector used: fuv
</pre></div>
</div>
</div>
</div>
<p><strong>We’ll plot the COS spectra with the STIS spectra</strong>, (both pre- and post- convolution,) to demonstrate the effect on our data.
We’ll first plot the entire spectrum:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Plot each of the spectra</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">STIS_wvln</span><span class="p">,</span> <span class="n">STIS_flux</span><span class="p">,</span>
         <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
         <span class="n">c</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span>
         <span class="n">label</span><span class="o">=</span><span class="s2">&quot;STIS Un-convolved&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">STIS_lwvln</span><span class="p">,</span> <span class="n">STIS_lflux</span><span class="p">,</span>
         <span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
         <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
         <span class="n">c</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span>
         <span class="n">label</span><span class="o">=</span><span class="s2">&quot;STIS Convolved&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">COS_wvln</span><span class="p">,</span> <span class="n">COS_flux</span><span class="p">,</span>
         <span class="n">markersize</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
         <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
         <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
         <span class="n">label</span><span class="o">=</span><span class="s2">&quot;COS&quot;</span><span class="p">)</span>

<span class="c1"># Set ybounds to avoid spike at shorter wvln side</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1E-13</span><span class="p">,</span> <span class="mf">1E-12</span><span class="p">)</span>

<span class="c1"># Add a legend</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
           <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

<span class="c1"># Give fig the title and labels</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Figure 3.6</span><span class="se">\n</span><span class="s2">COS FUV LSF kernel sampled at 1134 Å&quot;</span><span class="p">,</span>
          <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength [$\AA$]&quot;</span><span class="p">,</span>
           <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Flux [$erg\ \AA^{-1}\ cm^{-2}\ s^{-1}$]&quot;</span><span class="p">,</span>
           <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="c1"># Format and save the figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">plotsdir</span> <span class="o">/</span> <span class="s1">&#39;COS_STIS_compare_wide.png&#39;</span><span class="p">),</span>
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/5012ef5ceb6d35128d324ee9b62cf0cc31eac443b0fb13e16f41b7108ce69644.png" src="../../../_images/5012ef5ceb6d35128d324ee9b62cf0cc31eac443b0fb13e16f41b7108ce69644.png" />
</div>
</div>
<p>We can tell that the peaks have been cut shorter in the STIS convolved spectrum.</p>
<p>However, to see a bit more detail, let’s make plots zooming in on spectral lines. We arbitrarily selected a few spectral lines in the UV from Table 1 of <a class="reference external" href="https://iopscience.iop.org/article/10.1088/0004-6256/141/2/37/meta">Leitherer et al.’s “An ultraviolet spectroscopic atlas of local starbursts and star-forming galaxies: the legacy of FOS and GHRS.” The Astronomical Journal 141, no. 2 (2011): 37.</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select a few UV lines from the table in Leitherer et al, 2011</span>
<span class="n">lines</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;S II&quot;</span><span class="p">:</span> <span class="mf">1250.58</span><span class="p">,</span> <span class="s2">&quot;Si II&quot;</span><span class="p">:</span> <span class="mf">1304.37</span><span class="p">,</span> <span class="s2">&quot;C II&quot;</span><span class="p">:</span> <span class="mf">1335.71</span><span class="p">,</span> <span class="s2">&quot;Si IV&quot;</span><span class="p">:</span> <span class="mf">1393.76</span><span class="p">}</span>

<span class="c1"># Set up figure</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

<span class="c1"># Using gridspec to let us control panel sizes and locations</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  

<span class="c1"># For each line:</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">linename</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>  

    <span class="c1"># Add a plot at the correct position on the grid</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> 

    <span class="c1"># Plot all the spectra for each line</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">STIS_wvln</span><span class="p">,</span> <span class="n">STIS_flux</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-.&quot;</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span>  
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;STIS Un-convolved&quot;</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">STIS_lwvln</span><span class="p">,</span> <span class="n">STIS_lflux</span><span class="p">,</span>
            <span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;STIS Convolved&quot;</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">COS_wvln</span><span class="p">,</span> <span class="n">COS_flux</span><span class="p">,</span> 
            <span class="n">markersize</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> 
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;COS&quot;</span><span class="p">)</span>
    
    <span class="c1"># Add a vertical line at the reference frame wavelength of the line</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">line</span><span class="p">,</span>
               <span class="n">c</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
               <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
               <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">linename</span><span class="si">}</span><span class="s2"> line at </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">Å&quot;</span><span class="p">)</span>

    <span class="c1"># Set bounds and add legends</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1e-13</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
              <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>

<span class="c1"># Give fig the title and labels</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Fig. 3.7</span><span class="se">\n</span><span class="s2">A series of UV lines with COS</span><span class="se">\n</span><span class="s2"> and STIS spectra convolved with COS LSFs</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
             <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">,)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength [$\AA$]&quot;</span><span class="p">,</span>
              <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Flux [$erg\ \AA^{-1}\ cm^{-2}\ s^{-1}$]&quot;</span><span class="p">,</span>
         <span class="n">x</span><span class="o">=-</span><span class="mf">0.018</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
         <span class="n">rotation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span>
         <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="c1"># Format and save the figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">plotsdir</span> <span class="o">/</span> <span class="s2">&quot;COS_STIS_compare.png&quot;</span><span class="p">),</span>
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/31103dd2f1ee7011c6124de3a1f426d37a51a0735788760ae6f792480dd28e01.png" src="../../../_images/31103dd2f1ee7011c6124de3a1f426d37a51a0735788760ae6f792480dd28e01.png" />
</div>
</div>
<section id="we-ll-do-something-similar-again-for-the-nuv">
<h4>We’ll do something similar again for the NUV:<a class="headerlink" href="#we-ll-do-something-similar-again-for-the-nuv" title="Permalink to this heading">#</a></h4>
<p><strong>First downloading the NUV data to compare.</strong></p>
<p>Note we’re downloading a STIS spectrum from the ULLYSES high level science products archive:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Downloading ULLYSES STIS data from mast using the URI and saving the local path</span>
<span class="n">Observations</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span>
    <span class="n">uri</span><span class="o">=</span><span class="s2">&quot;mast:HLSP/ullyses/bi173/dr6/hlsp_ullyses_hst_stis_bi173_e230m_dr6_cspec.fits&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">stis_nuv_cspec</span> <span class="o">=</span> <span class="s2">&quot;./hlsp_ullyses_hst_stis_bi173_e230m_dr6_cspec.fits&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HLSP/ullyses/bi173/dr6/hlsp_ullyses_hst_stis_bi173_e230m_dr6_cspec.fits to /home/runner/work/hst_notebooks/hst_notebooks/notebooks/COS/LSF/hlsp_ullyses_hst_stis_bi173_e230m_dr6_cspec.fits ... [Done]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Now downloading COS</span>
<span class="n">nuv_cos_x1dsum</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span>
    <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span><span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span><span class="n">obs_id</span><span class="o">=</span><span class="s2">&quot;LBY615010&quot;</span><span class="p">)),</span>
    <span class="n">mrp_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;Local Path&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/lby615010_asn.fits to ./mastDownload/HST/lby615010/lby615010_asn.fits ... [Done]
Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/lby615010_x1dsum.fits to ./mastDownload/HST/lby615010/lby615010_x1dsum.fits ... [Done]
</pre></div>
</div>
</div>
</div>
<p><strong>Now read in all the COS and STIS data and convolve the STIS data with the COS NUV LSFs:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read in both COS and STIS NUV data:</span>
<span class="c1"># COS we need to build up from 3 stripes</span>
<span class="n">cos_nuv_table</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">nuv_cos_x1dsum</span><span class="p">)</span>

<span class="n">COS_nuv_wvln</span><span class="p">,</span> <span class="n">COS_nuv_flux</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

<span class="c1"># The COS segment at index 0 has a longer wvln domain</span>
<span class="k">for</span> <span class="n">cos_segment</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>  
    <span class="n">COS_wvln_</span><span class="p">,</span> <span class="n">COS_flux_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cos_nuv_table</span><span class="p">[</span><span class="n">cos_segment</span><span class="p">][</span><span class="s2">&quot;WAVELENGTH&quot;</span><span class="p">,</span> <span class="s2">&quot;FLUX&quot;</span><span class="p">])</span>
    <span class="n">COS_dqw_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cos_nuv_table</span><span class="p">[</span><span class="n">cos_segment</span><span class="p">][</span><span class="s2">&quot;DQ_WGT&quot;</span><span class="p">],</span>
                          <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    
    <span class="n">COS_nuv_wvln</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">COS_wvln_</span><span class="p">[</span><span class="n">COS_dqw_</span><span class="p">])</span>
    <span class="n">COS_nuv_flux</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">COS_flux_</span><span class="p">[</span><span class="n">COS_dqw_</span><span class="p">])</span>
    
<span class="n">COS_nuv_wvln</span><span class="p">,</span> <span class="n">COS_nuv_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">COS_nuv_wvln</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">COS_nuv_flux</span><span class="p">)</span>

<span class="c1"># Read STIS:</span>
<span class="n">STIS_nuv_wvln</span><span class="p">,</span> <span class="n">STIS_nuv_flux</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">stis_nuv_cspec</span><span class="p">)[</span><span class="s2">&quot;WAVELENGTH&quot;</span><span class="p">,</span> <span class="s2">&quot;FLUX&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Convolve STIS with COS&#39; LSFs:</span>
<span class="n">STIS_nuv_lwvln</span><span class="p">,</span> <span class="n">STIS_nuv_lflux</span> <span class="o">=</span> <span class="n">convolve_lsf</span><span class="p">(</span><span class="n">STIS_nuv_wvln</span><span class="p">,</span>
                                              <span class="n">STIS_nuv_flux</span><span class="p">,</span>
                                              <span class="mi">1921</span><span class="p">,</span>
                                              <span class="nb">str</span><span class="p">(</span><span class="n">datadir</span> <span class="o">/</span> <span class="n">nuv_LSF_file_name</span><span class="p">),</span>
                                              <span class="n">nuv_disptab_path</span><span class="p">,</span>
                                              <span class="n">detector</span><span class="o">=</span><span class="s2">&quot;NUV&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Detector used: nuv
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING: UnitsWarning: &#39;erg /s /cm**2 /angstrom&#39; contains multiple slashes, which is discouraged by the FITS standard [astropy.units.format.generic]
WARNING: hdu= was not specified but multiple tables are present, reading in first available table (hdu=1) [astropy.io.fits.connect]
WARNING: UnitsWarning: &#39;erg /s /cm**2 /Angstrom&#39; contains multiple slashes, which is discouraged by the FITS standard [astropy.units.format.generic]
</pre></div>
</div>
</div>
</div>
<p><strong>Finally, generate a plot like Fig 3.7, but for this NUV data:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select a few NUV lines from the table in Leitherer et al, 2011</span>
<span class="n">lines</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Si II (Milky Way)&quot;</span><span class="p">:</span> <span class="mf">1808.01</span><span class="p">,</span> <span class="s2">&quot;Si II (LMC)&quot;</span><span class="p">:</span> <span class="mf">1809.5</span><span class="p">,</span> <span class="s2">&quot;Zn II&quot;</span><span class="p">:</span> <span class="mf">2026.14</span><span class="p">}</span>

<span class="c1"># Set up figure</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

<span class="c1"># Using gridspec to let us control panel sizes and locations</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  

<span class="c1"># For each line:</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">linename</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>  
    <span class="c1"># Add a plot at the correct position on the grid</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>  

    <span class="c1"># Plot all the spectra for each line</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">STIS_nuv_wvln</span><span class="p">,</span> <span class="n">STIS_nuv_flux</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-.&quot;</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span>  
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;STIS Un-convolved&quot;</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">STIS_nuv_lwvln</span><span class="p">,</span> <span class="n">STIS_nuv_lflux</span><span class="p">,</span>
            <span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;STIS Convolved&quot;</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">COS_nuv_wvln</span><span class="p">,</span> <span class="n">COS_nuv_flux</span><span class="p">,</span> 
            <span class="n">markersize</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> 
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;COS&quot;</span><span class="p">)</span>
    
    <span class="c1"># Add a vertical line at the reference frame wavelength of the line</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">line</span><span class="p">,</span>
               <span class="n">c</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
               <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
               <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">linename</span><span class="si">}</span><span class="s2"> line at </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">Å&quot;</span><span class="p">)</span>

    <span class="c1"># Set bounds and add legends</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">line</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">line</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">5e-15</span><span class="p">,</span> <span class="mf">5.5e-13</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
              <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>

<span class="c1"># Give fig the title and labels</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
    <span class="s2">&quot;Fig. 3.8</span><span class="se">\n</span><span class="s2">A series of NUV lines with COS</span><span class="se">\n</span><span class="s2"> and STIS spectra convolved with COS NUV LSFs</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength [$\AA$]&quot;</span><span class="p">,</span>
              <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Flux [$erg\ \AA^{-1}\ cm^{-2}\ s^{-1}$]&quot;</span><span class="p">,</span>
         <span class="n">x</span><span class="o">=-</span><span class="mf">0.018</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.38</span><span class="p">,</span>
         <span class="n">rotation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span>
         <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="c1"># Format and save the figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">plotsdir</span> <span class="o">/</span> <span class="s2">&quot;COS_STIS_compare_nuv.png&quot;</span><span class="p">),</span>
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/0638c4a6a6c4cf78f018505ed5c0dc52a00df9a2826ce11bcca5816e01ec80e2.png" src="../../../_images/0638c4a6a6c4cf78f018505ed5c0dc52a00df9a2826ce11bcca5816e01ec80e2.png" />
</div>
</div>
</section>
</section>
</section>
<section id="in-review">
<h2>In review:<a class="headerlink" href="#in-review" title="Permalink to this heading">#</a></h2>
<p>We’ve learned…</p>
<ul class="simple">
<li><p>What a Line Spread Function (LSF) is and why we might need to use it</p></li>
<li><p>How to determine the correct LSF for your COS data and find it on the <a class="reference external" href="https://www.stsci.edu/hst/instrumentation/cos/performance/spectral-resolution">COS Spectral Resolution Website</a></p></li>
<li><p>How to convolve LSFs with a template spectrum</p></li>
</ul>
</section>
<section id="congratulations-you-finished-this-notebook">
<h2>Congratulations! You finished this Notebook!<a class="headerlink" href="#congratulations-you-finished-this-notebook" title="Permalink to this heading">#</a></h2>
<p><font size="5">There are more COS data walkthrough Notebooks on different topics. You can find them <a href="https://github.com/spacetelescope/hst_notebooks/tree/main/notebooks/COS">here</a>.</font></p>
</section>
<hr class="docutils" />
<section id="about-this-notebook">
<h2>About this Notebook<a class="headerlink" href="#about-this-notebook" title="Permalink to this heading">#</a></h2>
<p><strong>Author:</strong> Nat Kerman <a class="reference external" href="mailto:nkerman&#37;&#52;&#48;stsci&#46;edu">nkerman<span>&#64;</span>stsci<span>&#46;</span>edu</a></p>
<p><strong>Contributors:</strong> Rachel Plesha, Julia Roman-Duval</p>
<p><strong>Updated On:</strong> 2023-06-29</p>
<blockquote>
<div><p><em>This tutorial was generated to be in compliance with the <a class="reference external" href="https://github.com/spacetelescope/style-guides">STScI style guides</a> and would like to cite the <a class="reference external" href="https://github.com/spacetelescope/style-guides/blob/master/templates/example_notebook.ipynb">Jupyter guide</a> in particular.</em></p>
</div></blockquote>
</section>
<section id="citations">
<h2>Citations<a class="headerlink" href="#citations" title="Permalink to this heading">#</a></h2>
<p>If you use <code class="docutils literal notranslate"><span class="pre">astropy</span></code>, <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code>, <code class="docutils literal notranslate"><span class="pre">astroquery</span></code>, or <code class="docutils literal notranslate"><span class="pre">numpy</span></code> for published research, please cite the
authors. Follow these links for more information about citations:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.astropy.org/en/stable/index.html">Citing <code class="docutils literal notranslate"><span class="pre">astropy</span></code></a></p></li>
<li><p><a class="reference external" href="https://numpy.org/citing-numpy/">Citing <code class="docutils literal notranslate"><span class="pre">numpy</span></code></a></p></li>
<li><p><a class="reference external" href="https://matplotlib.org/">Citing <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code></a></p></li>
<li><p><a class="reference external" href="https://astroquery.readthedocs.io/en/latest/">Citing <code class="docutils literal notranslate"><span class="pre">astroquery</span></code></a></p></li>
</ul>
<hr class="docutils" />
<p><span class="xref myst">Top of Page</span>
<img style="float: right;" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" alt="Space Telescope Logo" width="200px"/></p>
<p><br></br>
<br></br>
<br></br></p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/hst_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/COS/LSF"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../DayNight/DayNight.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Filtering out COS Data taken during the Day or Night</p>
      </div>
    </a>
    <a class="right-next"
       href="../Extract/Extract.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Editing the extraction boxes in a spectral extraction file (<code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>)</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Working with the COS Line Spread Function (LSF)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">0. Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#we-will-import-the-following-packages">We will import the following packages:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#we-will-also-define-a-few-directories-we-will-need">We will also define a few directories we will need:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#and-we-will-need-to-download-the-data-we-wish-to-filter-and-analyze">And we will need to download the data we wish to filter and analyze</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-the-line-spread-function">1. Understanding the Line Spread Function</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-an-lsf">1.1. What is an LSF?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#center-table-1-1-line-spread-function-lsf-kernel-parameters-for-the-cos-instrument-center"><center> Table 1.1: Line Spread Function (LSF) kernel parameters for the COS instrument</center></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-the-files-you-need">1.2. Getting the files you need</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#center-fig-1-1-screenshot-of-the-cos-spectral-resolution-site-center"><center> Fig 1.1: Screenshot of the COS Spectral Resolution Site</center></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#center-fig-1-2-screenshot-of-the-cos-spectral-resolution-site-focus-on-lp-pos-3-center"><center>Fig 1.2: Screenshot of the COS Spectral Resolution Site - Focus on LP-POS 3</center></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#taking-a-look-at-the-lsf-kernels">2. Taking a look at the LSF kernels</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-in-an-lsf">2.1. Reading in an LSF</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-an-lsf-kernel">2.2. Plotting an LSF kernel</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#we-will-also-demonstrate-all-of-the-above-for-a-nuv-dataset">We will also demonstrate all of the above for a NUV dataset:</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#convolving-an-lsf">3. Convolving an LSF</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-some-functions-for-lsf-convolution">3.1. Defining some functions for LSF convolution</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-the-dispersion-relationship-parameters">3.1.1. Getting the dispersion relationship parameters</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#redefining-the-lsf-in-terms-of-wavelength">3.1.2. Redefining the LSF in terms of wavelength</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#applying-the-convolution">3.1.3. Applying the convolution</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#convolving-simple-line-profiles">3.2. Convolving simple line profiles</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#convolving-real-data-from-stis">3.3. Convolving real data from STIS</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#we-ll-do-something-similar-again-for-the-nuv">We’ll do something similar again for the NUV:</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#in-review">In review:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#congratulations-you-finished-this-notebook">Congratulations! You finished this Notebook!</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#citations">Citations</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>