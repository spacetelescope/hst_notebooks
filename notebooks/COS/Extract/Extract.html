

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Editing the extraction boxes in a spectral extraction file (XTRACTAB) &#8212; HST Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/table.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/COS/Extract/Extract';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="DrizzlePac Jupyter Notebook Tutorials" href="../../DrizzlePac/README.html" />
    <link rel="prev" title="Working with the COS Line Spread Function (LSF)" href="../LSF/LSF.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="HST Notebooks - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="HST Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../index.html">
                    STScI HST Notebook Repository HQ
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">ACS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../ACS/README.html">ACS Notebooks</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_findsat_mrt/acs_findsat_mrt_example.html">Satellite trail detection in ACS/WFC data using acstools.findsat_mrt</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_saturation_trails/acs_saturation_trails.html">ACS Linearity with Saturated Stars</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_cte_forward_model/acs_cte_forward_model_example.html">Pixel-based ACS/WFC CTE Forward Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_subarrays/acs_subarrays.html">ACS Image Reduction for Subarray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_sbc_dark_analysis/acs_sbc_dark_analysis.html">SBC Dark Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_reduction/acs_reduction.html">ACS/WFC Image Reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_pixel_area_maps/acs_pixel_area_maps.html">Obtaining Pixel Area Maps for ACS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_polarization_tools/acs_polarization_tools.html">Using ACS Polarization Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_focus_diverse_epsfs/acs_focus_diverse_epsfs.html">Focus Diverse ePSFs for ACS/WFC</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">COS</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../README.html">COS Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Setup/Setup.html">Setting up your computer environment for working with COS data</a></li>





<li class="toctree-l1"><a class="reference internal" href="../DataDl/DataDl.html">Downloading COS Data</a></li>




<li class="toctree-l1"><a class="reference internal" href="../ViewData/ViewData.html">Viewing COS Data</a></li>





<li class="toctree-l1"><a class="reference internal" href="../AsnFile/AsnFile.html">Modifying or Creating an Association File</a></li>





<li class="toctree-l1"><a class="reference internal" href="../CalCOS/CalCOS.html">Running the COS Data Pipeline (<code class="docutils literal notranslate"><span class="pre">CalCOS</span></code>)</a></li>






<li class="toctree-l1"><a class="reference internal" href="../SplitTag/SplitTag.html">Splitting COS Exposures into sub-exposures with <code class="docutils literal notranslate"><span class="pre">splittag</span></code></a></li>







<li class="toctree-l1"><a class="reference internal" href="../DayNight/DayNight.html">Filtering out COS Data taken during the Day or Night</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LSF/LSF.html">Working with the COS Line Spread Function (LSF)</a></li>

<li class="toctree-l1 current active"><a class="current reference internal" href="#">Editing the extraction boxes in a spectral extraction file (<code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>)</a></li>







</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">DrizzlePac</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/README.html">DrizzlePac Jupyter Notebook Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/using_updated_astrometry_solutions/using_updated_astrometry_solutions.html">Improving Astrometry Using Alternate WCS Solutions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_to_catalogs/align_to_catalogs.html">Aligning HST images to an Absolute Reference Catalog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_sparse_fields/align_sparse_fields.html">Aligning Deep Exposures of Sparse Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_multiple_visits/align_multiple_visits.html">Optimizing Image Alignment for Multiple HST Visits</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/use_ds9_regions_in_tweakreg/use_ds9_regions_in_tweakreg.html">TWEAKREG Tips - Using DS9 Regions for Source Inclusion/Exclusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/optimize_image_sampling/optimize_image_sampling.html">Optimizing the Image Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_mosaics/align_mosaics.html">Aligning HST Mosaics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/sky_matching/sky_matching.html">Sky Matching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/mask_satellite/mask_satellite.html">Satellite Trail Masking Techniques</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">HASP</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../HASP/Setup/Setup.html">Installing the Hubble Advanced Spectral Products Script</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../HASP/CoaddTutorial/CoaddTutorial.html">Inputting User Data using the Hubble Advanced Spectral Products Script</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../HASP/FluxScaleTutorial/FluxScaleTutorial.html">Scaling Flux while using the Hubble Advanced Spectral Products Script</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../HASP/DataDiagnostic/DataDiagnostics.html">HASP Data Diagnostic Notebook</a></li>




</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NICMOS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NICMOS/nicmos_unit_conversion/nicmos_unit_conversion.html">Programmatic Replacements for NICMOS Units Conversion Form</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">STIS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../STIS/README.html">STIS-Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/cross-correlation/cross-correlation.html">Correcting for Missing Wavecals with Cross-Correlation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/custom_ccd_darks/custom_ccd_darks.html">Custom CCD Darks <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/drizpac_notebook/STIS_DrizzlePac_Tutorial.html">STIS DrizzlePac Tutorial <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/CoronagraphyViz/STIS_Coronagraphy_Visualization_v2.html">STIS Coronagraphy Visualization Tool (v2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/calstis/calstis_2d_ccd.html">Calstis 2-D CCD Data Reduction <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/target_acquisition/target_acquisition.html">Evaluating STIS Target Acquisitions <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/view_data/view_data.html">Viewing STIS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/extraction/1D_Extraction.html">1D Spectra Extraction <a class="tocSkip"></a></a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">WFC3</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/README.html">WFC3 Notebooks</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../WFC3/general_tools.html">General Tools</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/image_displayer_analyzer/wfc3_image_displayer_analyzer.html">WFC3 Image Displayer &amp; Analyzer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/exception_report/wfc3_exception_report.html">Exception Report Checklist - WFC3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/calwf3_v1.0_cte/calwf3_with_v1.0_PCTE.html">Processing WFC3/UVIS Data with <code class="docutils literal notranslate"><span class="pre">calwf3</span></code> Using the v1.0 CTE-Correction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/persistence/wfc3_ir_persistence.html">Masking Persistence in WFC3/IR Images</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../WFC3/ir_tvb.html">WFC3/IR Time Variable Background (TVB)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/ir_ima_visualization/IR_IMA_Visualization_with_an_Example_of_Time_Variable_Background.html">WFC3/IR IMA Visualization Tools with An Example of Time Variable Background</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/calwf3_recalibration/calwf3_recal_tvb.html">Manual Recalibration with calwf3: Turning off the IR Linear Ramp Fit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/tvb_flattenramp/TVB_flattenramp_notebook.html">Correcting for Helium Line Emission Background in IR Exposures using the “Flatten-Ramp” Technique</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/ir_scattered_light_calwf3_corrections/Correcting_for_Scattered_Light_in_IR_Exposures_Using_calwf3_to_Mask_Bad_Reads.html">Correcting for Scattered Light in WFC3/IR Exposures: Using <code class="docutils literal notranslate"><span class="pre">calwf3</span></code> to Mask Bad Reads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/ir_scattered_light_manual_corrections/Correcting_for_Scattered_Light_in_IR_Exposures_by_Manually_Subtracting_Bad_Reads.html">Correcting for Scattered Light in WFC3/IR Exposures: Manually Subtracting Bad Reads</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../WFC3/photometry.html">Photometry</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/filter_transformations/filter_transformations.html">WFC3/UVIS Filter Transformations with stsynphot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/flux_conversion_tool/flux_conversion_tool.html">Flux Unit Conversions with synphot and stsynphot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/photometry_examples/phot_examples.html">Synthetic Photometry Examples for WFC3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/uvis_time_dependent_photometry/uvis_timedep_phot.html">WFC3/UVIS Time-dependent Photometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/zeropoints/zeropoints.html">Calculating WFC3 Zeropoints with STSynphot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/uvis_pam_corrections/WFC3_UVIS_Pixel_Area_Map_Corrections_for_Subarrays.html">WFC3/UVIS Pixel Area Map Corrections for Subarrays</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../WFC3/point_spread_function.html">HST WFC3 Point Spread Function Modeling</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../WFC3/point_spread_function/hst_point_spread_function.html">HST WFC3 Point Spread Function Modeling   </a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/spacetelescope/hst_notebooks/blob/main/notebooks/COS/Extract/Extract.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/hst_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/hst_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/COS/Extract/Extract.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/COS/Extract/Extract.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Editing the extraction boxes in a spectral extraction file (XTRACTAB)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Editing the extraction boxes in a spectral extraction file (<code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">0. Introduction</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#we-will-import-the-following-packages">We will import the following packages:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#we-will-also-define-a-few-directories-we-will-need">We will also define a few directories we will need:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#and-we-will-need-to-download-the-data-we-wish-to-work-with">And we will need to download the data we wish to work with:</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#investigating-the-exposure">1. Investigating the exposure</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-the-xtractab-and-examining-a-2d-spectrum">1.1. Understanding the <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code> and examining a 2D spectrum</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#if-you-have-an-existing-lref-directory-with-a-cache-of-reference-files"><strong>If you have an existing <code class="docutils literal notranslate"><span class="pre">lref</span></code> directory with a cache of reference files:</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#if-you-do-not-have-an-existing-lref-directory-with-a-cache-of-reference-files"><strong>If you DO NOT have an existing <code class="docutils literal notranslate"><span class="pre">lref</span></code> directory with a cache of reference files:</strong></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-some-useful-functions">1.2. Defining some useful functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#examining-the-extraction-boxes">1.3. Examining the extraction boxes</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#editing-the-extraction-boxes">2. Editing the extraction boxes</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-an-editing-function">2.1. Defining an editing function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#making-the-edits">2.2. Making the edits</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#confirming-the-changes">2.3. Confirming the changes</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-calcos-pipeline-with-the-new-xtractab">3. Running the CalCOS Pipeline with the new <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#editing-the-xtractab-header-value">3.1. Editing the <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code> header value</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-pipeline">3.2. Running the pipeline</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#example-using-fuv-data">4. Example using FUV data</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#in-conclusion">In conclusion</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#congratulations-you-finished-this-notebook">Congratulations! You finished this Notebook!</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#there-are-more-cos-data-walkthrough-notebooks-on-different-topics-you-can-find-them-here">There are more COS data walkthrough Notebooks on different topics. You can find them here.</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#citations">Citations</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><a id="topE"></a></p>
<section class="tex2jax_ignore mathjax_ignore" id="editing-the-extraction-boxes-in-a-spectral-extraction-file-xtractab">
<h1>Editing the extraction boxes in a spectral extraction file (<code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>)<a class="headerlink" href="#editing-the-extraction-boxes-in-a-spectral-extraction-file-xtractab" title="Permalink to this heading">#</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="learning-goals">
<h1>Learning Goals<a class="headerlink" href="#learning-goals" title="Permalink to this heading">#</a></h1>
<p><font size="4 "> This Notebook is designed to walk the user (<em>you</em>) through: <b>Altering the extraction box used to extract your spectrum from a COS <code class="docutils literal notranslate"><span class="pre">TIME-TAG</span></code> exposure file.</b></font></p>
<p><strong>1. <span class="xref myst">Investigating the exposure</span></strong></p>
<p>- 1.1. <span class="xref myst">Understanding the <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code> and examining a 2D spectrum</span></p>
<p>- 1.2. <span class="xref myst">Defining some useful functions</span></p>
<p>- 1.3. <span class="xref myst">Examining the extraction boxes</span></p>
<p><strong>2. <span class="xref myst">Editing the extraction boxes</span></strong></p>
<p>- 2.1. <span class="xref myst">Defining an editing function</span></p>
<p>- 2.2. <span class="xref myst">Making the edits</span></p>
<p>- 2.3. <span class="xref myst">Confirming the changes</span></p>
<p><strong>3. <span class="xref myst">Running the CalCOS Pipeline with the new <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code></span></strong></p>
<p>- 3.1. <span class="xref myst">Editing the <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code> header value</span></p>
<p>- 3.2. <span class="xref myst">Running the pipeline</span></p>
<p><strong>4. <span class="xref myst">Example using FUV Data</span></strong></p>
<p><font color="red">This notebook currently fails to execute, use as reference only</font></p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="introduction">
<h1>0. Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h1>
<p><strong>The Cosmic Origins Spectrograph (<a class="reference external" href="https://www.nasa.gov/content/hubble-space-telescope-cosmic-origins-spectrograph"><em>COS</em></a>) is an ultraviolet spectrograph on-board the Hubble Space Telescope (<a class="reference external" href="https://www.stsci.edu/hst/about"><em>HST</em></a>) with capabilities in the near ultraviolet (<em>NUV</em>) and far ultraviolet (<em>FUV</em>).</strong></p>
<p><strong>This tutorial aims to prepare you to work with the COS data of your choice by walking you through altering the extraction box sizes in the <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>/<code class="docutils literal notranslate"><span class="pre">_1dx</span></code> file to make sure you are extracting the cleanest possible signal from your source and background.</strong> We will demonstrate this in both the NUV and FUV.</p>
<p><em>Note</em> that some COS modes which use the FUV detector can be better extracted using the <a class="reference external" href="https://hst-docs.stsci.edu/cosdhb/chapter-3-cos-calibration/3-2-pipeline-processing-overview">TWOZONE method</a>, which is not directly discussed in this Notebook. All COS/NUV modes use the <a class="reference external" href="https://hst-docs.stsci.edu/cosdhb/chapter-3-cos-calibration/3-2-pipeline-processing-overview#id-3.2PipelineProcessingOverview-3.2.1OverviewofTWOZONEextraction">BOXCAR method</a> discussed in this Notebook.</p>
<ul class="simple">
<li><p>For an in-depth manual to working with COS data and a discussion of caveats and user tips, see the <a class="reference external" href="https://hst-docs.stsci.edu/display/COSDHB/">COS Data Handbook</a>.</p></li>
<li><p>For a detailed overview of the COS instrument, see the <a class="reference external" href="https://hst-docs.stsci.edu/display/COSIHB/">COS Instrument Handbook</a>.</p></li>
</ul>
<section id="we-will-import-the-following-packages">
<h2>We will import the following packages:<a class="headerlink" href="#we-will-import-the-following-packages" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">numpy</span></code> to handle arrays and functions</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">astropy.io</span> <span class="pre">fits</span></code> and <code class="docutils literal notranslate"><span class="pre">astropy.table</span> <span class="pre">Table</span></code> for accessing FITS files</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">glob</span></code>, <code class="docutils literal notranslate"><span class="pre">os</span></code> for working with system files</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">astroquery.mast</span> <span class="pre">Observations</span></code> for finding and downloading data from the <a class="reference external" href="https://mast.stsci.edu/portal/Mashup/Clients/Mast/Portal.html">MAST</a> archive</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">matplotlib.pyplot</span></code> for plotting</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">matplotlib.image</span></code> for reading in images</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">calcos</span></code> to run the CalCOS pipeline for COS data reduction</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">scipy.interpolate</span> <span class="pre">interp1d</span></code> for interpolating datasets to the same sampling</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pathlib</span> <span class="pre">Path</span></code> for managing system paths</p></li>
</ul>
<p>New versions of <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> are currently incompatible with astroconda. To create a Python environment capable of running all the data analyses in these COS Notebooks, please see Section 1 of our Notebook tutorial on <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/blob/master/notebooks/COS/Setup/Setup.ipynb">setting up an environment</a>.</p>
<p>We’ll also filter out two unhelpful warnings about a deprecation and dividing by zero which do not affect our data processing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import for array manipulation</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Import for reading FITS files</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>

<span class="c1"># Import for downloading the data</span>
<span class="kn">from</span> <span class="nn">astroquery.mast</span> <span class="kn">import</span> <span class="n">Observations</span>

<span class="c1"># Import for plotting</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="c1"># Import for showing images from within Python</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">image</span> <span class="k">as</span> <span class="n">mpimg</span>

<span class="c1"># Import for dealing with system files</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="c1"># Import for running the CalCOS pipeline</span>
<span class="kn">import</span> <span class="nn">calcos</span>

<span class="c1"># Import for comparing the old and new CalCOS values</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span> 

<span class="c1"># Import for working with system paths</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># We will also suppress a warning that won&#39;t affect our data processing</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span> 
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span>
                        <span class="n">category</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">VisibleDeprecationWarning</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="we-will-also-define-a-few-directories-we-will-need">
<h2>We will also define a few directories we will need:<a class="headerlink" href="#we-will-also-define-a-few-directories-we-will-need" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># These will be important directories for the notebook</span>
<span class="n">datadir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./data/&#39;</span><span class="p">)</span>
<span class="n">outputdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./output/&#39;</span><span class="p">)</span>
<span class="n">plotsdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./output/plots/&#39;</span><span class="p">)</span>

<span class="c1"># Make the directories if they don&#39;t exist</span>
<span class="n">datadir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">outputdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plotsdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="and-we-will-need-to-download-the-data-we-wish-to-work-with">
<h2>And we will need to download the data we wish to work with:<a class="headerlink" href="#and-we-will-need-to-download-the-data-we-wish-to-work-with" title="Permalink to this heading">#</a></h2>
<p>We choose the exposures with the association obs_id: <code class="docutils literal notranslate"><span class="pre">LE4B04010</span></code> and download all the <code class="docutils literal notranslate"><span class="pre">_rawtag</span></code> data. This dataset happens to be COS/NUV data taken with the G185M grating, observing the star: <a class="reference external" href="https://simbad.u-strasbg.fr/simbad/sim-id?Ident=%402582869&amp;Name=LS%20%20IV%20-13%20%20%2030&amp;submit=submit">LS IV -13 30</a>.
For more information on downloading COS data, see our <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/blob/main/notebooks/COS/DataDl/DataDl.ipynb">notebook tutorial on downloading COS data</a>.</p>
<p><em>Note</em>, we’re working with the <code class="docutils literal notranslate"><span class="pre">_rawtags</span></code> because they are smaller files and quicker to download than the <code class="docutils literal notranslate"><span class="pre">_corrtag</span></code> files. However, this workflow translates very well to using <code class="docutils literal notranslate"><span class="pre">_corrtag</span></code> files, as you likely will want to do when working with your actual data. If you wish to use the default corrections converting from raw to corrected <code class="docutils literal notranslate"><span class="pre">TIME-TAG</span></code> data, you may instead download and work with <code class="docutils literal notranslate"><span class="pre">CORRTAG</span></code> files directly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Querying our exposures with the association observation ID LE4B04010</span>
<span class="n">productlist</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span><span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span>
                                                <span class="n">obs_id</span><span class="o">=</span><span class="s1">&#39;LE4B04010&#39;</span><span class="p">))</span>

<span class="c1"># Getting only the RAWTAG, ASN, and X1DSUM files</span>
<span class="n">masked_productlist</span> <span class="o">=</span> <span class="n">productlist</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">productlist</span><span class="p">[</span><span class="s1">&#39;productSubGroupDescription&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;RAWTAG&#39;</span><span class="p">,</span> <span class="s1">&#39;ASN&#39;</span><span class="p">,</span> <span class="s1">&#39;X1DSUM&#39;</span><span class="p">])]</span>

<span class="c1"># Now download the files</span>
<span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span><span class="n">masked_productlist</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We gather a list of all the <code class="docutils literal notranslate"><span class="pre">_rawtag</span></code> files we have downloaded, as well as the <code class="docutils literal notranslate"><span class="pre">_asnfile</span></code> and <code class="docutils literal notranslate"><span class="pre">_x1dsum</span></code> file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Getting a list of the RAWTAG, ASN, and X1DSUM files</span>
<span class="n">rawtags</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;./mastDownload/HST/**/*_rawtag.fits&#39;</span><span class="p">,</span> 
                    <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">asnfile</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;./mastDownload/HST/**/*_asn.fits&#39;</span><span class="p">,</span> 
                    <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">old_x1dsum</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;./mastDownload/HST/**/*_x1dsum.fits&#39;</span><span class="p">,</span> 
                       <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p><a id = invE></a></p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="investigating-the-exposure">
<h1>1. Investigating the exposure<a class="headerlink" href="#investigating-the-exposure" title="Permalink to this heading">#</a></h1>
<p><a id = lookE></a></p>
<section id="understanding-the-xtractab-and-examining-a-2d-spectrum">
<h2>1.1. Understanding the <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code> and examining a 2D spectrum<a class="headerlink" href="#understanding-the-xtractab-and-examining-a-2d-spectrum" title="Permalink to this heading">#</a></h2>
<p>The raw data from the COS instrument is a series of events, each corresponding to a photon interacting with the detector at a specific X, Y point, (<em>and at a specific time if in <code class="docutils literal notranslate"><span class="pre">TIME-TAG</span></code> mode</em>). We generally wish to translate this to a 1-dimensional spectrum (<em><strong>Flux</strong> or Intensity on the y axis vs. <strong>Wavelength</strong> on the x axis</em>). To do this, we can first make a 2-dimensional spectrum, by plotting all the X and Y points of the spectrum onto a 2D image of the detector. The different spectra (i.e. of the NUV of FUV target, the wavelength calibration source) then appear of stripes of high count density on this image. We can then simply draw extraction boxes around these stripes, and integrate to collapse the data onto the wavelenth axis.</p>
<p><strong>The <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code> is a FITS file which contains a series of parallelogram “boxes” to be used for different COS modes.</strong></p>
<p>These are the boxes which we collapse to create a 1-dimensional spectrum. For each combination of COS lifetime position, grating, cenwave, etc., the extraction box is specified by giving the slope and y-intercept of a line, and the height of the parallelogram which should be centered on the line. Similar boxes are specified for background regions. For more information on the <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>, see the <a class="reference external" href="https://hst-docs.stsci.edu/cosdhb/chapter-3-cos-calibration/3-7-reference-files#id-3.7ReferenceFiles-3.7.12XTRACTAB:1-DSpectralExtractionTablehttps://hst-docs.stsci.edu/cosdhb/chapter-3-cos-calibration/3-7-reference-files#id-3.7ReferenceFiles-3.7.12XTRACTAB:1-DSpectralExtractionTable">COS Data Handbook</a>.</p>
<p><strong>For many reasons, we may wish to use an extraction box different from the one specified by the default XTRACTAB, and instead set the boxes manually.</strong></p>
<p>We need to see where the NUV stripes fall in order to determine where we should place the extraction boxes. First, let’s plot this as a 2D image of the raw counts.
To begin, we select and plot the raw counts data from the 0th rawtag file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read the data from the first rawtag</span>
<span class="n">rawtag</span> <span class="o">=</span> <span class="n">rawtags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">rt_data</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">rawtag</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Setting up the figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Plot the raw counts</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">rt_data</span><span class="p">[</span><span class="s1">&#39;RAWX&#39;</span><span class="p">],</span> <span class="n">rt_data</span><span class="p">[</span><span class="s1">&#39;RAWY&#39;</span><span class="p">],</span> 
            <span class="c1"># Size of data points</span>
            <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
            <span class="c1"># Transparency of data points</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
            <span class="c1"># Color of data points</span>
            <span class="n">c</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>

<span class="c1"># Plot lines roughly centered on the three NUV stripes (units are pixels)</span>
<span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="mi">187</span><span class="p">,</span> <span class="mi">285</span><span class="p">,</span> <span class="mi">422</span><span class="p">]</span>
<span class="n">label</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NUVA&#39;</span><span class="p">,</span> <span class="s1">&#39;NUVB&#39;</span><span class="p">,</span> <span class="s1">&#39;NUVC&#39;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span> 
    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;myr&#39;</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> 
                <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> 
                <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="c1"># Setting plot axis limits</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>

<span class="c1"># Adding labels to axes and plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Dispersion axis Pixel&#39;</span><span class="p">,</span> 
           <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cross-dispersion axis Pixel&#39;</span><span class="p">,</span> 
           <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Fig 1.1</span><span class="se">\n</span><span class="s2">2D spectrum of all raw (unfiltered) counts&quot;</span><span class="p">,</span> 
          <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>

<span class="c1"># Adding a legend</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

<span class="c1"># Working with plot formatting</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># Showing the plot below</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p><strong>The dense stripes in the lower half of Fig 1.1 (<em>highlighted by the dotted lines</em>) are the actual science data raw counts, while the <em>patched</em> stripes towards the top of the plot are the wavelength calibration counts.</strong> For a diagram of a NUV 2D spectrum, see COS Data Handbook <a class="reference external" href="https://hst-docs.stsci.edu/cosdhb/chapter-1-cos-overview/1-2-cos-physical-configuration#id-1.2COSPhysicalConfiguration-Figure1.10">Figure 1.10</a>.</p>
<p>Now we’ll need to see where the original <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code> places its extraction boxes:</p>
<p>Find the name of the <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code> used by this first <code class="docutils literal notranslate"><span class="pre">_rawtag</span></code> file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">orig_xtractab</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">rawtag</span><span class="p">)[</span><span class="s1">&#39;XTRACTAB&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<section id="if-you-have-an-existing-lref-directory-with-a-cache-of-reference-files">
<h3><strong>If you have an existing <code class="docutils literal notranslate"><span class="pre">lref</span></code> directory with a cache of reference files:</strong><a class="headerlink" href="#if-you-have-an-existing-lref-directory-with-a-cache-of-reference-files" title="Permalink to this heading">#</a></h3>
<p>Give the system the <code class="docutils literal notranslate"><span class="pre">lref</span></code> system variable, which points to the reference file directory. Create a cell and run the code below, replacing <code class="docutils literal notranslate"><span class="pre">&lt;YOUR_EXISTING_LREF_PATH&gt;</span></code> with the actual path to your <code class="docutils literal notranslate"><span class="pre">lref</span></code> reference files.</p>
<p>If you do NOT have an existing <code class="docutils literal notranslate"><span class="pre">lref</span> <span class="pre">variable</span></code>, DO NOT do this step. We will setup the reference files used in this notebook in the cell after this one.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lref</span> <span class="o">=</span> <span class="s2">&quot;YOUR_EXISTING_LREF_PATH&quot;</span>
<span class="o">%</span><span class="n">env</span> <span class="n">lref</span> <span class="n">YOUR_EXISTING_LREF_PATH</span>

<span class="n">orig_xtractab</span> <span class="o">=</span> <span class="n">lref</span> <span class="o">+</span> <span class="n">orig_xtractab</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="if-you-do-not-have-an-existing-lref-directory-with-a-cache-of-reference-files">
<h3><strong>If you DO NOT have an existing <code class="docutils literal notranslate"><span class="pre">lref</span></code> directory with a cache of reference files:</strong><a class="headerlink" href="#if-you-do-not-have-an-existing-lref-directory-with-a-cache-of-reference-files" title="Permalink to this heading">#</a></h3>
<p>If you do not have an existing <code class="docutils literal notranslate"><span class="pre">lref</span></code> directory, then we will create one now. Run the cells below to create your <code class="docutils literal notranslate"><span class="pre">lref</span></code> directory. This directory will point to the reference files that are used for COS data processing. We can see the most recent files on the <a class="reference external" href="https://hst-crds.stsci.edu/">HST CRDS website</a>.</p>
<p>Please check out our <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/blob/main/notebooks/COS/Setup/Setup.ipynb">Setup notebook</a>, as it explains in-depth details about the CRDS website and <code class="docutils literal notranslate"><span class="pre">lref</span></code> specifics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Getting your home environment</span>
<span class="n">home_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;HOME&quot;</span><span class="p">]</span>
<span class="c1"># Then we will set the CRDS_PATH environment_variable</span>
<span class="c1"># Creating path to where the files are saved</span>
<span class="n">crds_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home_dir</span><span class="p">,</span> <span class="s2">&quot;crds_cache&quot;</span><span class="p">)</span>
<span class="c1"># Setting the environment variable CRDS_PATH to our CRDS path</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CRDS_PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crds_path</span>

<span class="c1"># Set the CRDS_SERVER_URL environment_variable:</span>
<span class="c1"># URL for the STScI CRDS page</span>
<span class="n">crds_server_url</span> <span class="o">=</span> <span class="s2">&quot;https://hst-crds.stsci.edu&quot;</span>
<span class="c1"># Setting env variable to URL</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CRDS_SERVER_URL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crds_server_url</span>
</pre></div>
</div>
</div>
</div>
<p>We can now sync the files we need by running the command in the cell below.</p>
<p><strong>NOTE:</strong> The <code class="docutils literal notranslate"><span class="pre">context</span> <span class="pre">number</span></code> (last four digits of <code class="docutils literal notranslate"><span class="pre">hst_cos_CONTEXTNUM.imap</span></code>) will likely have changed by the time this notebook is published. You will want to check that you have the most up-to-date context number by going to the <a class="reference external" href="https://hst-crds.stsci.edu/">HST CRDS website</a> and clicking the dropdown for COS.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>crds<span class="w"> </span>sync<span class="w"> </span>--contexts<span class="w"> </span>hst_cos_0352.imap<span class="w"> </span>--fetch-references
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set the lref environment variable</span>
<span class="n">lref</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">crds_path</span><span class="p">,</span> <span class="s2">&quot;references/hst/cos/&quot;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;lref&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lref</span>

<span class="n">orig_xtractab</span> <span class="o">=</span> <span class="n">lref</span> <span class="o">+</span> <span class="n">orig_xtractab</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p><a id = funE></a></p>
</section>
</section>
<section id="defining-some-useful-functions">
<h2>1.2. Defining some useful functions<a class="headerlink" href="#defining-some-useful-functions" title="Permalink to this heading">#</a></h2>
<p>We’ll define a few functions to:</p>
<ul class="simple">
<li><p>Read in the data rows containing relevant extraction boxes from an <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code> file</p></li>
<li><p>Plot these extraction boxes over a spectrum</p>
<ul>
<li><p><em>For clarity and signal to noise, we’ll collapse this spectrum onto the y (cross-dispersion) axis</em></p></li>
</ul>
</li>
</ul>
<p><strong>First, we’ll write a function to read in the relavent extraction boxes from an <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">readxtractab</span><span class="p">(</span><span class="n">xtractab</span><span class="p">,</span> <span class="n">grat</span><span class="p">,</span> <span class="n">cw</span><span class="p">,</span> <span class="n">aper</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads in an XTRACTAB row of a particular COS mode and</span>
<span class="sd">    returns extraction box sizes and locations.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    xtractab (str) : path to XTRACTAB file.</span>
<span class="sd">    raw (bool) : default False, meaning that the data is assumed to be corrtag.</span>
<span class="sd">    grat (string) : grating of relavent row (i.e. &quot;G185M&quot;)</span>
<span class="sd">    cw (int or numerical) : cenwave of relavent row (i.e. (1786))</span>
<span class="sd">    aper (str) : aperture of relavent row (i.e. &quot;PSA&quot;)</span>

<span class="sd">    Returns:</span>
<span class="sd">    y locations of bottoms/tops of extraction boxes</span>
<span class="sd">        if NUV: stripe NUVA/B/C, and 2 background boxes</span>
<span class="sd">        elif FUV: FUVA/B, and 2 background boxes for each FUVA/B.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Read the XTRACTAB FITS data</span>
    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">xtractab</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">xtrdata</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> 
    
    <span class="c1"># Check if the detector is the FUV or NUV detector</span>
    <span class="n">isFUV</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">xtractab</span><span class="p">)[</span><span class="s1">&#39;DETECTOR&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FUV&#39;</span>
    
    <span class="c1"># If it&#39;s the NUV detector, then:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isFUV</span><span class="p">:</span>
        <span class="c1"># Find NUVA of the right row</span>
        <span class="n">sel_nuva</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;segment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NUVA&#39;</span><span class="p">)</span> <span class="o">&amp;</span> 
                            <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;aperture&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">aper</span><span class="p">)</span> <span class="o">&amp;</span> 
                            <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;opt_elem&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">grat</span><span class="p">)</span> <span class="o">&amp;</span>
                            <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;cenwave&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cw</span><span class="p">))</span>
        
        <span class="c1"># Now NUVB</span>
        <span class="n">sel_nuvb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;segment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NUVB&#39;</span><span class="p">)</span> <span class="o">&amp;</span> 
                            <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;aperture&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">aper</span><span class="p">)</span> <span class="o">&amp;</span>
                            <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;opt_elem&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">grat</span><span class="p">)</span> <span class="o">&amp;</span>
                            <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;cenwave&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cw</span><span class="p">))</span>
        
        <span class="c1"># Now NUVC</span>
        <span class="n">sel_nuvc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;segment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NUVC&#39;</span><span class="p">)</span> <span class="o">&amp;</span> 
                            <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;aperture&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">aper</span><span class="p">)</span> <span class="o">&amp;</span>
                            <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;opt_elem&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">grat</span><span class="p">)</span> <span class="o">&amp;</span>
                            <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;cenwave&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cw</span><span class="p">))</span>

        <span class="c1"># Find heights of the spec extract boxes</span>
        <span class="n">hgta</span> <span class="o">=</span> <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;HEIGHT&#39;</span><span class="p">][</span><span class="n">sel_nuva</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 
        <span class="n">hgtb</span> <span class="o">=</span> <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;HEIGHT&#39;</span><span class="p">][</span><span class="n">sel_nuvb</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 
        <span class="n">hgtc</span> <span class="o">=</span> <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;HEIGHT&#39;</span><span class="p">][</span><span class="n">sel_nuvc</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Get the y-intercept (b) of the spec</span>
        <span class="n">bspeca</span> <span class="o">=</span> <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_SPEC&#39;</span><span class="p">][</span><span class="n">sel_nuva</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 
        <span class="n">bspecb</span> <span class="o">=</span> <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_SPEC&#39;</span><span class="p">][</span><span class="n">sel_nuvb</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 
        <span class="n">bspecc</span> <span class="o">=</span> <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_SPEC&#39;</span><span class="p">][</span><span class="n">sel_nuvc</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Determine the y bounds of boxes </span>
        <span class="n">boundsa</span> <span class="o">=</span> <span class="p">[</span><span class="n">bspeca</span> <span class="o">-</span> <span class="n">hgta</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">bspeca</span> <span class="o">+</span> <span class="n">hgta</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> 
        <span class="n">boundsb</span> <span class="o">=</span> <span class="p">[</span><span class="n">bspecb</span> <span class="o">-</span> <span class="n">hgtb</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">bspecb</span> <span class="o">+</span> <span class="n">hgtb</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">boundsc</span> <span class="o">=</span> <span class="p">[</span><span class="n">bspecc</span> <span class="o">-</span> <span class="n">hgtc</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">bspecc</span> <span class="o">+</span> <span class="n">hgtc</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Do the same for the bkg extract boxes</span>
        <span class="n">bkg1a</span> <span class="o">=</span> <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_BKG1&#39;</span><span class="p">][</span><span class="n">sel_nuva</span><span class="p">]</span> 
        <span class="n">bkg2a</span> <span class="o">=</span> <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_BKG2&#39;</span><span class="p">][</span><span class="n">sel_nuva</span><span class="p">]</span>
        <span class="n">bhgta</span> <span class="o">=</span> <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;BHEIGHT&#39;</span><span class="p">][</span><span class="n">sel_nuva</span><span class="p">]</span>

        <span class="n">bkg1boundsa</span> <span class="o">=</span> <span class="p">[</span><span class="n">bkg1a</span> <span class="o">-</span> <span class="n">bhgta</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">bkg1a</span> <span class="o">+</span> <span class="n">bhgta</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">bkg2boundsa</span> <span class="o">=</span> <span class="p">[</span><span class="n">bkg2a</span> <span class="o">-</span> <span class="n">bhgta</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">bkg2a</span> <span class="o">+</span> <span class="n">bhgta</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># The background locations are by default the same for all stripes</span>
        <span class="k">return</span> <span class="n">boundsa</span><span class="p">,</span> <span class="n">boundsb</span><span class="p">,</span> <span class="n">boundsc</span><span class="p">,</span> <span class="n">bkg1boundsa</span><span class="p">,</span> <span class="n">bkg2boundsa</span>
    
    <span class="c1"># If it&#39;s the FUV detector, then:</span>
    <span class="k">elif</span> <span class="n">isFUV</span><span class="p">:</span> 
        <span class="c1"># Find FUVA of the right row</span>
        <span class="n">sel_fuva</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;segment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FUVA&#39;</span><span class="p">)</span> <span class="o">&amp;</span> 
                            <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;aperture&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">aper</span><span class="p">)</span> <span class="o">&amp;</span>  
                            <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;opt_elem&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">grat</span><span class="p">)</span> <span class="o">&amp;</span>
                            <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;cenwave&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cw</span><span class="p">))</span>

        <span class="c1"># Now FUVB</span>
        <span class="n">sel_fuvb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;segment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FUVB&#39;</span><span class="p">)</span> <span class="o">&amp;</span> 
                            <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;aperture&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">aper</span><span class="p">)</span> <span class="o">&amp;</span>
                            <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;opt_elem&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">grat</span><span class="p">)</span> <span class="o">&amp;</span>
                            <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;cenwave&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cw</span><span class="p">))</span>
        
        <span class="c1"># Find heights of the spec extract boxes</span>
        <span class="n">hgta</span> <span class="o">=</span> <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;HEIGHT&#39;</span><span class="p">][</span><span class="n">sel_fuva</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 
        <span class="n">hgtb</span> <span class="o">=</span> <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;HEIGHT&#39;</span><span class="p">][</span><span class="n">sel_fuvb</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 

        <span class="c1"># Get the y-intercept (b) of the spec boxes</span>
        <span class="n">bspeca</span> <span class="o">=</span> <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_SPEC&#39;</span><span class="p">][</span><span class="n">sel_fuva</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 
        <span class="n">bspecb</span> <span class="o">=</span> <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_SPEC&#39;</span><span class="p">][</span><span class="n">sel_fuvb</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 

        <span class="c1"># Determine the y bounds of the boxes </span>
        <span class="n">boundsa</span> <span class="o">=</span> <span class="p">[</span><span class="n">bspeca</span> <span class="o">-</span> <span class="n">hgta</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">bspeca</span> <span class="o">+</span> <span class="n">hgta</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> 
        <span class="n">boundsb</span> <span class="o">=</span> <span class="p">[</span><span class="n">bspecb</span> <span class="o">-</span> <span class="n">hgtb</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">bspecb</span> <span class="o">+</span> <span class="n">hgtb</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Do the same for the bkg extract boxes</span>
        <span class="n">bkg1a</span> <span class="o">=</span> <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_BKG1&#39;</span><span class="p">][</span><span class="n">sel_fuva</span><span class="p">]</span> 
        <span class="n">bkg2a</span> <span class="o">=</span> <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_BKG2&#39;</span><span class="p">][</span><span class="n">sel_fuva</span><span class="p">]</span>
        <span class="n">bhgt1a</span> <span class="o">=</span> <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_HGT1&#39;</span><span class="p">][</span><span class="n">sel_fuva</span><span class="p">]</span>
        <span class="n">bhgt2a</span> <span class="o">=</span> <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_HGT2&#39;</span><span class="p">][</span><span class="n">sel_fuva</span><span class="p">]</span>

        <span class="c1"># Determine the y bounds of the bkg extract boxes</span>
        <span class="n">bkg1boundsa</span> <span class="o">=</span> <span class="p">[</span><span class="n">bkg1a</span> <span class="o">-</span> <span class="n">bhgt1a</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">bkg1a</span> <span class="o">+</span> <span class="n">bhgt1a</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">bkg2boundsa</span> <span class="o">=</span> <span class="p">[</span><span class="n">bkg2a</span> <span class="o">-</span> <span class="n">bhgt2a</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">bkg2a</span> <span class="o">+</span> <span class="n">bhgt2a</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="n">bkg1b</span> <span class="o">=</span> <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_BKG1&#39;</span><span class="p">][</span><span class="n">sel_fuvb</span><span class="p">]</span>
        <span class="n">bkg2b</span> <span class="o">=</span> <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_BKG2&#39;</span><span class="p">][</span><span class="n">sel_fuvb</span><span class="p">]</span>
        <span class="n">bhgt1b</span> <span class="o">=</span> <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_HGT1&#39;</span><span class="p">][</span><span class="n">sel_fuvb</span><span class="p">]</span>
        <span class="n">bhgt2b</span> <span class="o">=</span> <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_HGT2&#39;</span><span class="p">][</span><span class="n">sel_fuvb</span><span class="p">]</span>

        <span class="n">bkg1boundsb</span> <span class="o">=</span> <span class="p">[</span><span class="n">bkg1b</span> <span class="o">-</span> <span class="n">bhgt1b</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">bkg1b</span> <span class="o">+</span> <span class="n">bhgt1b</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">bkg2boundsb</span> <span class="o">=</span> <span class="p">[</span><span class="n">bkg2b</span> <span class="o">-</span> <span class="n">bhgt2b</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">bkg2b</span> <span class="o">+</span> <span class="n">bhgt2b</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">boundsa</span><span class="p">,</span> <span class="n">boundsb</span><span class="p">,</span> <span class="n">bkg1boundsa</span><span class="p">,</span> <span class="n">bkg2boundsa</span><span class="p">,</span> <span class="n">bkg1boundsb</span><span class="p">,</span> <span class="n">bkg2boundsb</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We&#39;ll note the returned values correspond to these extraction boxes</span>
<span class="n">box_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NUVA&#39;</span><span class="p">,</span> <span class="s1">&#39;NUVB&#39;</span><span class="p">,</span> <span class="s1">&#39;NUVC&#39;</span><span class="p">,</span> <span class="s1">&#39;BKG-1&#39;</span><span class="p">,</span> <span class="s1">&#39;BKG-2&#39;</span><span class="p">]</span>
<span class="n">box_names_fuv</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;FUVA&#39;</span><span class="p">,</span> <span class="s1">&#39;FUVB&#39;</span><span class="p">,</span> <span class="s1">&#39;BKG-1A&#39;</span><span class="p">,</span> <span class="s1">&#39;BKG-2A&#39;</span><span class="p">,</span> <span class="s1">&#39;BKG-1B&#39;</span><span class="p">,</span> <span class="s1">&#39;BKG-2B&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p><strong>We’ll now need two functions in order to plot.</strong></p>
<p>The first function: <code class="docutils literal notranslate"><span class="pre">makeims()</span></code> is a helper function for the second: <code class="docutils literal notranslate"><span class="pre">collapsey()</span></code>.</p>
<p>The second function: <code class="docutils literal notranslate"><span class="pre">collapsey()</span></code> takes a list of either <code class="docutils literal notranslate"><span class="pre">_rawtag</span></code> or <code class="docutils literal notranslate"><span class="pre">_corrtag</span></code> exposure files, as well as an <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code> file, and creates a summary plot, with the 2D spectrum collapsed onto the y-axis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">makeims</span><span class="p">(</span><span class="n">xarr</span><span class="p">,</span> <span class="n">yarr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function for collapsey(): converts list of counts to image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Size of the new image we will create</span>
    <span class="n">new_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">))</span>
 
    <span class="n">xbin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">xarr</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)),</span> 
                      <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">ybin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">yarr</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)),</span> 
                      <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Add a count for each x, y pair</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xbin</span><span class="p">,</span> <span class="n">ybin</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_img</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">continue</span>

    <span class="k">return</span> <span class="n">new_img</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Define the “collapse on y axis” function</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># collapsey() assumes corrtag, but will work with rawtag if raw=True</span>
<span class="k">def</span> <span class="nf">collapsey</span><span class="p">(</span><span class="n">tagfiles</span><span class="p">,</span> <span class="n">xtractab</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">savename</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fignum</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes a corrtag (default) or RAWTAG and makes a plot of the 2D spectrum collapsed to the y axis</span>
<span class="sd">    i.e. summed over rows of pixels along the dispersion direction</span>
<span class="sd">    then it overplots the extraction regions from a provided XTRACTAB.</span>
<span class="sd">    The behavior is the same for CORRTAG/RAWTAG, only the data columns differ.</span>
<span class="sd">    </span>
<span class="sd">    Inputs:</span>
<span class="sd">    tagfiles (list of str) : List of RAWTAG or CORRTAG file paths.</span>
<span class="sd">    xtractab (str) : Path to XTRACTAB.</span>
<span class="sd">    raw (bool) : Default False, meaning that the data is assumed to be CORRTAG.</span>
<span class="sd">    save (bool) : Do you want to save the image of the plot? Default True</span>
<span class="sd">    savename (str if specified) : Name to save file as in plotsdir, if save == True.</span>
<span class="sd">    display (bool) : Display the image? Default True.</span>
<span class="sd">    fignum  (str if specified) : Figure number to include in figtitle. Dafault is False.</span>
<span class="sd">    </span>
<span class="sd">    Outputs:</span>
<span class="sd">    yprof (numpy array of floats) : the 2D spectrum collapsed onto the y axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Setting up the figure</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

    <span class="c1"># Go through all the tag files</span>
    <span class="k">for</span> <span class="n">numfile</span><span class="p">,</span> <span class="n">myfile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tagfiles</span><span class="p">):</span> 
        <span class="c1"># Read data from the file</span>
        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">myfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> 
            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="n">h0</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

        <span class="c1"># Find important header keys to determine row</span>
        <span class="n">fppos</span> <span class="o">=</span> <span class="n">h0</span><span class="p">[</span><span class="s1">&#39;FPPOS&#39;</span><span class="p">]</span> 
        <span class="n">rootname</span> <span class="o">=</span> <span class="n">h0</span><span class="p">[</span><span class="s1">&#39;ROOTNAME&#39;</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">h0</span><span class="p">[</span><span class="s1">&#39;TARGNAME&#39;</span><span class="p">]</span>
        <span class="n">grating</span> <span class="o">=</span> <span class="n">h0</span><span class="p">[</span><span class="s1">&#39;OPT_ELEM&#39;</span><span class="p">]</span>
        <span class="n">cenwave</span> <span class="o">=</span> <span class="n">h0</span><span class="p">[</span><span class="s1">&#39;CENWAVE&#39;</span><span class="p">]</span>
        
        <span class="c1"># Select corrected or raw time-tag points x and y locations</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">raw</span><span class="p">:</span> 
            <span class="n">xcorr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;XCORR&#39;</span><span class="p">]</span>
            <span class="n">ycorr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;YCORR&#39;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">raw</span><span class="p">:</span>
            <span class="n">rawx</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;RAWX&#39;</span><span class="p">]</span>
            <span class="n">rawy</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;RAWY&#39;</span><span class="p">]</span>
        
        <span class="c1"># Call the helper function on timetag data</span>
        <span class="k">if</span> <span class="n">raw</span><span class="p">:</span> 
            <span class="n">nuvim</span> <span class="o">=</span> <span class="n">makeims</span><span class="p">(</span><span class="n">rawx</span><span class="p">,</span> <span class="n">rawy</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nuvim</span> <span class="o">=</span> <span class="n">makeims</span><span class="p">(</span><span class="n">xcorr</span><span class="p">,</span> <span class="n">ycorr</span><span class="p">)</span>

        <span class="c1"># Collapse onto the y axis</span>
        <span class="n">yprof</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nuvim</span><span class="p">,</span> 
                       <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 

        <span class="c1"># Make the main y-axis spectrum plot</span>
        <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>

        <span class="c1"># Plot the newly collapsed spectrum plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">yprof</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> 
                 <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rootname</span><span class="si">}</span><span class="s1"> fppos=</span><span class="si">{</span><span class="n">fppos</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Add in the plot formatting/titles</span>
        <span class="k">if</span> <span class="n">numfile</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
            <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;RAWY Pixel&#39;</span><span class="p">,</span> 
                           <span class="n">size</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;YCORR Pixel&#39;</span><span class="p">,</span> 
                           <span class="n">size</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Counts summed along X&#39;</span><span class="p">,</span> 
                       <span class="n">size</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
            
            <span class="n">fig_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Target: </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> spectrum;&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;XTRACTAB: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">xtractab</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="n">fignum</span><span class="p">:</span>
                <span class="n">fig_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Fig </span><span class="si">{</span><span class="n">fignum</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">fig_title</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">fig_title</span><span class="p">,</span> 
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">23</span><span class="p">)</span>

            <span class="c1"># Get the extraction box sizes and locations for the science and wavecal apertures</span>
            <span class="n">psaboundsa</span><span class="p">,</span> <span class="n">psaboundsb</span><span class="p">,</span> <span class="n">psaboundsc</span><span class="p">,</span> <span class="n">psabkg1</span><span class="p">,</span> <span class="n">psabkg2</span> <span class="o">=</span> <span class="n">readxtractab</span><span class="p">(</span><span class="n">xtractab</span><span class="p">,</span> <span class="n">grating</span><span class="p">,</span> <span class="n">cenwave</span><span class="p">,</span> <span class="s1">&#39;PSA&#39;</span><span class="p">)</span>
            <span class="n">wcaboundsa</span><span class="p">,</span> <span class="n">wcaboundsb</span><span class="p">,</span> <span class="n">wcaboundsc</span><span class="p">,</span> <span class="n">wcabkg1</span><span class="p">,</span> <span class="n">wcabkg2</span> <span class="o">=</span> <span class="n">readxtractab</span><span class="p">(</span><span class="n">xtractab</span><span class="p">,</span> <span class="n">grating</span><span class="p">,</span> <span class="n">cenwave</span><span class="p">,</span> <span class="s1">&#39;WCA&#39;</span><span class="p">)</span>

            <span class="c1"># Adding shading to show the PSA/WCA regions on the image</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">psaboundsa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">psaboundsa</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="c1"># Color of shaded region</span>
                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> 
                        <span class="c1"># Label</span>
                        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;PSA Regions&#39;</span><span class="p">,</span> 
                        <span class="c1"># Transparency</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">psaboundsb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">psaboundsb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> 
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">psaboundsc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">psaboundsc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> 
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">wcaboundsa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wcaboundsa</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> 
                        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;WCA regions&#39;</span><span class="p">,</span> 
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">wcaboundsb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wcaboundsb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> 
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">wcaboundsc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wcaboundsc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> 
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
    
    <span class="c1"># Add a legend</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
    
    <span class="c1"># More formatting</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Saving the figure</span>
    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="c1"># Save in the default manner</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">savename</span><span class="p">:</span> 
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">plotsdir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">_regions.png&quot;</span><span class="p">),</span> 
                        <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> 
                        <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

        <span class="c1"># Save with input savename</span>
        <span class="k">elif</span> <span class="n">savename</span><span class="p">:</span> 
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">plotsdir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">savename</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">),</span> 
                        <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> 
                        <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            
    <span class="c1"># If specified, show the image</span>
    <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">yprof</span>
</pre></div>
</div>
</div>
</div>
<p><a id = boxE></a></p>
</section>
<section id="examining-the-extraction-boxes">
<h2>1.3. Examining the extraction boxes<a class="headerlink" href="#examining-the-extraction-boxes" title="Permalink to this heading">#</a></h2>
<p>Now let’s make a plot showing where these original <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code> boxes fall on the raw count image:</p>
<p><em>It’s important to note that each extraction box also has a slope associated with it.</em> This slope is generally very small, and we will not plot the boxes with their slopes while determining the box centers and heights. However, for the purposes of actual extractions, these slopes should be incorporated to determine final extraction bounds.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Bounds of all boxes for these conditions</span>
<span class="n">read_bounds</span> <span class="o">=</span> <span class="n">readxtractab</span><span class="p">(</span><span class="n">orig_xtractab</span><span class="p">,</span> 
                           <span class="n">grat</span><span class="o">=</span><span class="s1">&#39;G185M&#39;</span><span class="p">,</span> 
                           <span class="n">cw</span><span class="o">=</span><span class="mi">1786</span><span class="p">,</span> 
                           <span class="n">aper</span><span class="o">=</span><span class="s1">&#39;PSA&#39;</span><span class="p">)</span> 

<span class="c1"># Set up figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> 

<span class="c1"># Image of the raw counts</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">rt_data</span><span class="p">[</span><span class="s1">&#39;RAWX&#39;</span><span class="p">],</span> <span class="n">rt_data</span><span class="p">[</span><span class="s1">&#39;RAWY&#39;</span><span class="p">],</span> 
            <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
            <span class="n">c</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>

<span class="c1"># Add all boxes</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">read_bounds</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">read_bounds</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;myr&quot;</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">box_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="c1"># Add a legend to the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span> 

<span class="c1"># Add x and y axis ranges</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>

<span class="c1"># Add labels and titles</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Dispersion axis Pixel&#39;</span><span class="p">,</span> 
           <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cross-dispersion axis Pixel&#39;</span><span class="p">,</span> 
           <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Fig 1.2</span><span class="se">\n</span><span class="s2">2D spectrum of all raw (unfiltered) counts</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
             <span class="s2">&quot;with original extraction boxes&quot;</span><span class="p">,</span> 
             <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>

<span class="c1"># Work with formatting</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># Save figure to our plots directory</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">plotsdir</span> <span class="o">/</span> <span class="s1">&#39;2D_spec_orig_boxes.png&#39;</span><span class="p">),</span> 
            <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> 
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run the function to plot the original boxes over the y-axis spectrum</span>
<span class="n">flat_yspec</span> <span class="o">=</span> <span class="n">collapsey</span><span class="p">(</span><span class="n">tagfiles</span><span class="o">=</span><span class="n">rawtags</span><span class="p">,</span> 
                       <span class="n">xtractab</span><span class="o">=</span><span class="n">orig_xtractab</span><span class="p">,</span> 
                       <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                       <span class="n">savename</span><span class="o">=</span><span class="s2">&quot;orig_xtractab_col_y&quot;</span><span class="p">,</span> 
                       <span class="n">fignum</span><span class="o">=</span><span class="s2">&quot;1.3&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a id = editE></a></p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="editing-the-extraction-boxes">
<h1>2. Editing the extraction boxes<a class="headerlink" href="#editing-the-extraction-boxes" title="Permalink to this heading">#</a></h1>
<p>Now that we know how to show the location of the extraction boxes, we can begin actually editing the <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code> file.</p>
<p>We’ll define another function to edit the existing <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code> and save to a new file:</p>
<p><a id = edfnE></a></p>
<section id="defining-an-editing-function">
<h2>2.1. Defining an editing function<a class="headerlink" href="#defining-an-editing-function" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">edit_xtractab</span><span class="p">(</span><span class="n">xtractab</span><span class="p">,</span> <span class="n">gratlist</span><span class="p">,</span> <span class="n">cwlist</span><span class="p">,</span> <span class="n">h_dict</span><span class="p">,</span> <span class="n">b_dict</span><span class="p">,</span> <span class="n">new_filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to actually edit the XTRACTAB itself.</span>
<span class="sd">    Change the height and y-intercepts of the extraction boxes,</span>
<span class="sd">    and save to new XTRACTAB (1dx) file.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    xtractab (str) : path to the XTRACTAB to edit</span>
<span class="sd">    gratlist (list of str) : all the gratings whose rows you would like to edit</span>
<span class="sd">    cwlist (list of str) : all the cenwave whose rows you would like to edit</span>
<span class="sd">    h_dict (dict of numerical) : heights of NUV A,B,C extraction boxes. Should be ODD!</span>
<span class="sd">    b_dict (dict) : dict of the y-intercepts - i.e. box center locations</span>
<span class="sd">    new_filename : filename/local path to new XTRACTAB file to create</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Opening the XTRACTAB file and getting its data</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">xtractab</span><span class="p">)</span>
    <span class="n">xtrdata</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

    <span class="c1"># Is it FUV or NUV?</span>
    <span class="n">isFUV</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">xtractab</span><span class="p">)[</span><span class="s1">&#39;DETECTOR&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FUV&#39;</span>
    
    <span class="c1"># Print warning if even height is specified</span>
    <span class="k">for</span> <span class="n">height</span> <span class="ow">in</span> <span class="n">h_dict</span><span class="p">:</span> 
        <span class="k">if</span> <span class="n">h_dict</span><span class="p">[</span><span class="n">height</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING &quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Height of </span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s2"> is currently even (</span><span class="si">{</span><span class="n">h_dict</span><span class="p">[</span><span class="n">height</span><span class="p">]</span><span class="si">}</span><span class="s2">), but &quot;</span> <span class="o">+</span>
                  <span class="s2">&quot;should be ODD. Allowed change, but unadvised.&quot;</span><span class="p">)</span>
    
    <span class="c1"># Going through all gratings that you wish to edit</span>
    <span class="k">for</span> <span class="n">grat</span> <span class="ow">in</span> <span class="n">gratlist</span><span class="p">:</span>
        <span class="c1"># Going through all cenwaves that you wish to edit</span>
        <span class="k">for</span> <span class="n">cw</span> <span class="ow">in</span> <span class="n">cwlist</span><span class="p">:</span>
            <span class="c1"># For NUV data, changing all three gratings and cenwaves</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isFUV</span><span class="p">:</span> 

                <span class="n">sel_nuva</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;segment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NUVA&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                                    <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;aperture&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PSA&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                                    <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;opt_elem&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">grat</span><span class="p">)</span> <span class="o">&amp;</span>
                                    <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;cenwave&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cw</span><span class="p">))</span>

                <span class="n">sel_nuvb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;segment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NUVB&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                                    <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;aperture&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PSA&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                                    <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;opt_elem&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">grat</span><span class="p">)</span> <span class="o">&amp;</span>
                                    <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;cenwave&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cw</span><span class="p">))</span>

                <span class="n">sel_nuvc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;segment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NUVC&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                                    <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;aperture&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PSA&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                                    <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;opt_elem&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">grat</span><span class="p">)</span> <span class="o">&amp;</span>
                                    <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;cenwave&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cw</span><span class="p">))</span>

                <span class="c1"># Change the background region locations:</span>
                <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_BKG1&#39;</span><span class="p">][</span><span class="n">sel_nuva</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_dict</span><span class="p">[</span><span class="s1">&#39;bbkg1&#39;</span><span class="p">]</span>
                <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_BKG2&#39;</span><span class="p">][</span><span class="n">sel_nuva</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_dict</span><span class="p">[</span><span class="s1">&#39;bbkg2&#39;</span><span class="p">]</span>

                <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_BKG1&#39;</span><span class="p">][</span><span class="n">sel_nuvb</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_dict</span><span class="p">[</span><span class="s1">&#39;bbkg1&#39;</span><span class="p">]</span>
                <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_BKG2&#39;</span><span class="p">][</span><span class="n">sel_nuvb</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_dict</span><span class="p">[</span><span class="s1">&#39;bbkg2&#39;</span><span class="p">]</span>

                <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_BKG1&#39;</span><span class="p">][</span><span class="n">sel_nuvc</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_dict</span><span class="p">[</span><span class="s1">&#39;bbkg1&#39;</span><span class="p">]</span>
                <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_BKG2&#39;</span><span class="p">][</span><span class="n">sel_nuvc</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_dict</span><span class="p">[</span><span class="s1">&#39;bbkg2&#39;</span><span class="p">]</span>

                <span class="c1"># Change the extraction heights</span>
                <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;HEIGHT&#39;</span><span class="p">][</span><span class="n">sel_nuva</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_dict</span><span class="p">[</span><span class="s1">&#39;h_a&#39;</span><span class="p">]</span>
                <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;HEIGHT&#39;</span><span class="p">][</span><span class="n">sel_nuvb</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_dict</span><span class="p">[</span><span class="s1">&#39;h_b&#39;</span><span class="p">]</span>
                <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;HEIGHT&#39;</span><span class="p">][</span><span class="n">sel_nuvc</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_dict</span><span class="p">[</span><span class="s1">&#39;h_c&#39;</span><span class="p">]</span>

                <span class="c1"># Change the B_SPEC</span>
                <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_SPEC&#39;</span><span class="p">][</span><span class="n">sel_nuva</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_dict</span><span class="p">[</span><span class="s1">&#39;bspa&#39;</span><span class="p">]</span>
                <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_SPEC&#39;</span><span class="p">][</span><span class="n">sel_nuvb</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_dict</span><span class="p">[</span><span class="s1">&#39;bspb&#39;</span><span class="p">]</span>
                <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_SPEC&#39;</span><span class="p">][</span><span class="n">sel_nuvc</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_dict</span><span class="p">[</span><span class="s1">&#39;bspc&#39;</span><span class="p">]</span>
                
            <span class="c1"># For FUV data</span>
            <span class="k">elif</span> <span class="n">isFUV</span><span class="p">:</span> 
                <span class="n">sel_fuva</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;segment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FUVA&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                                    <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;aperture&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PSA&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                                    <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;opt_elem&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">grat</span><span class="p">)</span> <span class="o">&amp;</span>
                                    <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;cenwave&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cw</span><span class="p">))</span>

                <span class="n">sel_fuvb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;segment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FUVB&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                                    <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;aperture&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PSA&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                                    <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;opt_elem&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">grat</span><span class="p">)</span> <span class="o">&amp;</span>
                                    <span class="p">(</span><span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;cenwave&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cw</span><span class="p">))</span>
                
                <span class="c1"># Change the background region locations:</span>
                <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_BKG1&#39;</span><span class="p">][</span><span class="n">sel_fuva</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_dict</span><span class="p">[</span><span class="s1">&#39;bbkg1a&#39;</span><span class="p">]</span>
                <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_BKG2&#39;</span><span class="p">][</span><span class="n">sel_fuva</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_dict</span><span class="p">[</span><span class="s1">&#39;bbkg2a&#39;</span><span class="p">]</span>
                
                <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_BKG1&#39;</span><span class="p">][</span><span class="n">sel_fuvb</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_dict</span><span class="p">[</span><span class="s1">&#39;bbkg1b&#39;</span><span class="p">]</span>
                <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_BKG2&#39;</span><span class="p">][</span><span class="n">sel_fuvb</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_dict</span><span class="p">[</span><span class="s1">&#39;bbkg2b&#39;</span><span class="p">]</span>
                <span class="c1"># Change the extraction heights</span>
                <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;HEIGHT&#39;</span><span class="p">][</span><span class="n">sel_fuva</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_dict</span><span class="p">[</span><span class="s1">&#39;h_a&#39;</span><span class="p">]</span>
                <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;HEIGHT&#39;</span><span class="p">][</span><span class="n">sel_fuvb</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_dict</span><span class="p">[</span><span class="s1">&#39;h_b&#39;</span><span class="p">]</span>
                <span class="c1"># Change the B_SPEC</span>
                <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_SPEC&#39;</span><span class="p">][</span><span class="n">sel_fuva</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_dict</span><span class="p">[</span><span class="s1">&#39;bspa&#39;</span><span class="p">]</span>
                <span class="n">xtrdata</span><span class="p">[</span><span class="s1">&#39;B_SPEC&#39;</span><span class="p">][</span><span class="n">sel_fuvb</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_dict</span><span class="p">[</span><span class="s1">&#39;bspb&#39;</span><span class="p">]</span>
                
    <span class="c1"># Save and close the file</span>
    <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_filename</span><span class="p">,</span> 
              <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span>
</pre></div>
</div>
</div>
</div>
<p><a id = mkedE></a></p>
</section>
<section id="making-the-edits">
<h2>2.2. Making the edits<a class="headerlink" href="#making-the-edits" title="Permalink to this heading">#</a></h2>
<p>Now we’ll edit the <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code> file to have different sizes and locations of the extraction boxes using <code class="docutils literal notranslate"><span class="pre">edit_xtractab()</span></code>.</p>
<p>For the purposes of this example, we’ll <strong>arbitrarily</strong> set our y-intercepts and heights, just trying to roughly cover the NUV stripes, and show the different heights we can set the boxes to. <em>Note</em> that this function does not stop us from setting the boxes to overlap - but, dependent on your data, this may be a bad idea.</p>
<p>The scope of this Notebook is merely to explain <em>how</em> to alter the extraction boxes, not to determine the best box locations for any given dataset. While we cannot give specific rules to fit every single dataset, the general rules suggest you:</p>
<ul class="simple">
<li><p>Define spectral extraction boxes which contain as much flux from the target as possible while including very little of the background region.</p></li>
<li><p>Define background extraction boxes as close to your target as possible without the possibility of overlap.</p></li>
<li><p>Avoid detector hotspots and regions of poor sensitivity.</p></li>
<li><p>Box heights should be odd, so that there is a central pixel.</p></li>
</ul>
<p>First we’ll set up the values to which we’ll edit the box parameters, and then run the function on the original XTRACTAB to change our G185M extraction boxes in the rows for cenwaves 1786 and 1817:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The values we set the box params to:</span>
<span class="c1"># Centers of the background extract regions</span>
<span class="n">intercept_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;bbkg1&quot;</span><span class="p">:</span> <span class="mf">900.</span><span class="p">,</span> <span class="s2">&quot;bbkg2&quot;</span><span class="p">:</span> <span class="mf">60.</span><span class="p">,</span> 
                  <span class="c1"># Centers of NUV stripe extract regions</span>
                  <span class="s1">&#39;bspa&#39;</span><span class="p">:</span> <span class="mf">195.</span><span class="p">,</span> <span class="s1">&#39;bspb&#39;</span><span class="p">:</span> <span class="mf">285.</span><span class="p">,</span> <span class="s1">&#39;bspc&#39;</span><span class="p">:</span> <span class="mf">415.</span><span class="p">}</span> 

<span class="n">hgt_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;h_a&#39;</span><span class="p">:</span> <span class="mi">41</span><span class="p">,</span> <span class="s1">&#39;h_b&#39;</span><span class="p">:</span> <span class="mi">51</span><span class="p">,</span> <span class="s1">&#39;h_c&#39;</span><span class="p">:</span> <span class="mi">61</span><span class="p">}</span>

<span class="c1"># Now edit using the edit_xtractab() function;</span>
<span class="c1"># We&#39;ll change G185M grating for cenwaves 1786, 1817:</span>
<span class="n">edit_xtractab</span><span class="p">(</span><span class="n">xtractab</span><span class="o">=</span><span class="n">orig_xtractab</span><span class="p">,</span> 
              <span class="c1"># We&#39;re changing the G185M grating</span>
              <span class="n">gratlist</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;G185M&#39;</span><span class="p">],</span> 
              <span class="c1"># We&#39;re changing the 1786 and 1817 cenwaves for this grating</span>
              <span class="n">cwlist</span><span class="o">=</span><span class="p">[</span><span class="mi">1786</span><span class="p">,</span> <span class="mi">1817</span><span class="p">],</span> 
              <span class="c1"># New (arbitrary) heights to set boxes to</span>
              <span class="n">h_dict</span><span class="o">=</span><span class="n">hgt_dict</span><span class="p">,</span> 
              <span class="c1"># New y-intercepts for boxes</span>
              <span class="n">b_dict</span><span class="o">=</span><span class="n">intercept_dict</span><span class="p">,</span> 
              <span class="n">new_filename</span><span class="o">=</span><span class="s1">&#39;./edit_1dx.fits&#39;</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<p><a id = confE></a></p>
</section>
<section id="confirming-the-changes">
<h2>2.3. Confirming the changes<a class="headerlink" href="#confirming-the-changes" title="Permalink to this heading">#</a></h2>
<p><strong>Now we plot the old and new extraction boxes side-by-side to compare:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up the plot, we&#39;re going to have 2 subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> 
                               <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> 
                               <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Add raw count images to both subplots</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">rt_data</span><span class="p">[</span><span class="s1">&#39;RAWX&#39;</span><span class="p">],</span> <span class="n">rt_data</span><span class="p">[</span><span class="s1">&#39;RAWY&#39;</span><span class="p">],</span> 
            <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
            <span class="n">c</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">rt_data</span><span class="p">[</span><span class="s1">&#39;RAWX&#39;</span><span class="p">],</span> <span class="n">rt_data</span><span class="p">[</span><span class="s1">&#39;RAWY&#39;</span><span class="p">],</span> 
            <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
            <span class="n">c</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>

<span class="c1"># First plot the boxes from the original XTRACTAB </span>
<span class="n">read_bounds_old</span> <span class="o">=</span> <span class="n">readxtractab</span><span class="p">(</span><span class="n">orig_xtractab</span><span class="p">,</span> 
                               <span class="n">grat</span><span class="o">=</span><span class="s1">&#39;G185M&#39;</span><span class="p">,</span> 
                               <span class="n">cw</span><span class="o">=</span><span class="mi">1786</span><span class="p">,</span> 
                               <span class="n">aper</span><span class="o">=</span><span class="s1">&#39;PSA&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">read_bounds_old</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">read_bounds_old</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;myr&quot;</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">box_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_old&quot;</span><span class="p">)</span>

<span class="c1"># Hatches will help differentiate between the old and new boxes</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;hatch.linewidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Now with the newly edited XTRACTAB</span>
<span class="n">read_bounds_new</span> <span class="o">=</span> <span class="n">readxtractab</span><span class="p">(</span><span class="s1">&#39;./edit_1dx.fits&#39;</span><span class="p">,</span> 
                               <span class="n">grat</span><span class="o">=</span><span class="s1">&#39;G185M&#39;</span><span class="p">,</span> 
                               <span class="n">cw</span><span class="o">=</span><span class="mi">1786</span><span class="p">,</span> 
                               <span class="n">aper</span><span class="o">=</span><span class="s1">&#39;PSA&#39;</span><span class="p">)</span>
  
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">read_bounds_new</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">read_bounds_new</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;myr&quot;</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                <span class="c1"># Specifying the hatch</span>
                <span class="n">hatch</span><span class="o">=</span><span class="s2">&quot;x*&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">box_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_new&quot;</span><span class="p">)</span>

<span class="c1"># Now some plot formatting</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

<span class="n">ax0</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">ax0</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">())</span>

<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.42</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">,</span>
         <span class="s1">&#39;Dispersion axis Pixel&#39;</span><span class="p">,</span> 
         <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cross-dispersion axis Pixel&#39;</span><span class="p">,</span> 
               <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Fig 2.1</span><span class="se">\n</span><span class="s2">2D spectrum of all raw (unfiltered) counts</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
             <span class="s2">&quot;with original ($left$) and new ($right$) extraction boxes&quot;</span><span class="p">,</span> 
             <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">plotsdir</span> <span class="o">/</span> <span class="s1">&#39;2D_spec_both_box_sets.png&#39;</span><span class="p">),</span> 
            <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> 
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>We’ll also make a plot of the new boxes over the spectrum collapsed onto the y-axis, and we’ll plot it side-by-side with Fig 1.3, which shows the original extraction boxes:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run the function to plot the original boxes over the y-axis spectrum</span>
<span class="n">flat_yspec</span> <span class="o">=</span> <span class="n">collapsey</span><span class="p">(</span><span class="n">tagfiles</span><span class="o">=</span><span class="n">rawtags</span><span class="p">,</span> 
                       <span class="n">xtractab</span><span class="o">=</span><span class="s1">&#39;./edit_1dx.fits&#39;</span><span class="p">,</span> 
                       <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                       <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                       <span class="n">savename</span><span class="o">=</span><span class="s2">&quot;edit_xtractab_col_y&quot;</span><span class="p">,</span> 
                       <span class="n">fignum</span><span class="o">=</span><span class="s2">&quot;2.2&quot;</span><span class="p">)</span>

<span class="c1"># Now plot both together</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                               <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">18</span><span class="p">))</span>

<span class="n">ax0</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">&#39;./output/plots/orig_xtractab_col_y.png&#39;</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">&#39;./output/plots/edit_xtractab_col_y.png&#39;</span><span class="p">))</span>

<span class="n">ax0</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p><a id = calexE></a></p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="running-the-calcos-pipeline-with-the-new-xtractab">
<h1>3. Running the CalCOS Pipeline with the new <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code><a class="headerlink" href="#running-the-calcos-pipeline-with-the-new-xtractab" title="Permalink to this heading">#</a></h1>
<p><a id = edhdrE></a></p>
<section id="editing-the-xtractab-header-value">
<h2>3.1. Editing the <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code> header value<a class="headerlink" href="#editing-the-xtractab-header-value" title="Permalink to this heading">#</a></h2>
<p>More detailed information on changing header parameters can be found in our <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/blob/master/notebooks/COS/CalCOS/CalCOS.ipynb">walkthrough Notebook on <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code></a>.</p>
<p>Here, we just need to tell the pipeline to use our newly edited <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>. We do this by editing one of the header key values in all of the affected files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span> 
    <span class="k">for</span> <span class="n">rawtag</span> <span class="ow">in</span> <span class="n">rawtags</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rawtag</span><span class="p">,</span> <span class="n">datadir</span> <span class="o">/</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">rawtag</span><span class="p">))</span>
<span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No files&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span> 
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">asnfile</span><span class="p">,</span> <span class="n">datadir</span> <span class="o">/</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">asnfile</span><span class="p">))</span>
<span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No files&#39;</span><span class="p">)</span>
    
<span class="n">rawtags</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datadir</span> <span class="o">/</span> <span class="s1">&#39;*rawtag*&#39;</span><span class="p">))</span>
<span class="n">asnfile</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datadir</span> <span class="o">/</span> <span class="s1">&#39;*asn*&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">rawtag</span> <span class="ow">in</span> <span class="n">rawtags</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;changing XTRACTAB for &quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">rawtag</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Originally: &quot;</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">rawtag</span><span class="p">)[</span><span class="s1">&#39;XTRACTAB&#39;</span><span class="p">])</span>

    <span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">rawtag</span><span class="p">,</span> 
                <span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;XTRACTAB&#39;</span><span class="p">,</span> 
                <span class="n">value</span><span class="o">=</span><span class="s1">&#39;./edit_1dx.fits&#39;</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Now set to: &quot;</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">rawtag</span><span class="p">)[</span><span class="s1">&#39;XTRACTAB&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p><a id = runcE></a></p>
</section>
<section id="running-the-pipeline">
<h2>3.2. Running the pipeline<a class="headerlink" href="#running-the-pipeline" title="Permalink to this heading">#</a></h2>
<p>We will also largely gloss over the details of running the pipeline, <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code>, in this Notebook. Once again, much more detailed information on running the <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> pipeline can be found in our <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/blob/master/notebooks/COS/CalCOS/CalCOS.ipynb">walkthrough Notebook on using <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code></a>.</p>
<p><strong>If you don’t have an <code class="docutils literal notranslate"><span class="pre">lref</span></code> directory with all your COS reference files, the following cells will fail to run</strong> and you should see our tutorial on <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/blob/master/hst_notebooks/COS/Setup/Setup.ipynb">Setting up an environment to work with COS data</a>.</p>
<p>Note too that if you’ve already run calcos in this cell, it will fail to run again unless you clear the directory that the products are in.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span> cap --no-stderr 
<span class="c1"># Above ^ capture the output and save it in the next cell</span>

<span class="c1"># Checking if there&#39;s output already</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outputdir</span> <span class="o">/</span> <span class="s2">&quot;calcos_run1&quot;</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">outputdir</span> <span class="o">/</span> <span class="s2">&quot;calcos_run1&quot;</span><span class="p">)</span>

<span class="c1"># This line actually runs the pipeline:</span>
<span class="n">calcos</span><span class="o">.</span><span class="n">calcos</span><span class="p">(</span><span class="n">asnfile</span><span class="p">,</span> 
              <span class="n">verbosity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
              <span class="n">outdir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">outputdir</span> <span class="o">/</span> <span class="s2">&quot;calcos_run1&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>This file now contains the output of the last cell:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">outputdir</span><span class="o">/</span><span class="s1">&#39;output_calcos_1.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> 
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>We’ll finish up by plotting the new and original <code class="docutils literal notranslate"><span class="pre">x1dsum</span></code> spectra as extracted with the new and original extraction boxes:</strong></p>
<p><em>Note</em> that we can ignore the UnitsWarning.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up figure:</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

<span class="c1"># Using gridspec to control panel sizes and locations</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                      <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> 

<span class="c1"># Going through each NUV stripe</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="c1"># Creating two subplots, one with the X1DSUM data and the other a residual plot</span>
    <span class="n">ax0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>

    <span class="c1"># Getting the newly created (edited) X1DSUM&#39;s data</span>
    <span class="n">new_wvln</span><span class="p">,</span> <span class="n">new_flux</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;./output/calcos_run1/le4b04010_x1dsum.fits&#39;</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;WAVELENGTH&#39;</span><span class="p">,</span> <span class="s1">&#39;FLUX&#39;</span><span class="p">]</span>
    <span class="c1"># Getting the old X1DSUM&#39;s data</span>
    <span class="n">old_wvln</span><span class="p">,</span> <span class="n">old_flux</span><span class="p">,</span> <span class="n">seg</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">old_x1dsum</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;WAVELENGTH&#39;</span><span class="p">,</span> <span class="s1">&#39;FLUX&#39;</span><span class="p">,</span> <span class="s1">&#39;SEGMENT&#39;</span><span class="p">]</span>
    
    <span class="c1"># Interpolate the new wvln onto the old wvln&#39;s sampling:</span>
    <span class="n">new_flux_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">new_wvln</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">new_flux</span><span class="p">,</span> 
                               <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)(</span><span class="n">old_wvln</span><span class="p">)</span>

    <span class="c1"># Print max difference to user:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stripe </span><span class="si">{</span><span class="n">seg</span><span class="si">}</span><span class="s2"> differs by up to: </span><span class="se">\</span>
<span class="s2">    </span><span class="si">{</span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">new_flux</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">old_flux</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">old_flux</span><span class="p">))</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

    <span class="c1"># Plotting upper panel</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">new_wvln</span><span class="p">,</span> <span class="n">new_flux</span><span class="p">,</span> 
             <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$New$ extracted spectrum&#39;</span><span class="p">)</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">old_wvln</span><span class="p">,</span> <span class="n">old_flux</span><span class="p">,</span> 
             <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$Original$ extracted spectrum&#39;</span><span class="p">)</span>

    <span class="c1"># Plotting lower panel</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">new_wvln</span><span class="p">,</span> <span class="n">old_flux</span> <span class="o">-</span> <span class="n">new_flux_interp</span><span class="p">,</span> 
             <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Residual&#39;</span><span class="p">)</span>

    <span class="c1"># Formatting:</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Segment </span><span class="si">{</span><span class="n">seg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
                  <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

    <span class="n">ax0</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>

    <span class="c1"># Adding a legend</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower center&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower center&#39;</span><span class="p">)</span>

    <span class="c1"># Add axis labels to the plot</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Flux\n[$erg\ \AA^{-1}\ cm^{-2}\ s^{-1}$]&quot;</span><span class="p">,</span> 
                       <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Wavelength&quot;</span><span class="p">,</span> 
                   <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Fig 3.1</span><span class="se">\n</span><span class="s2">Comparing the old and new extracted spectra for each segment&quot;</span><span class="p">,</span> 
             <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>

<span class="c1"># More formatting</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># Save the figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">plotsdir</span> <span class="o">/</span> <span class="s2">&quot;comp_extracted.png&quot;</span><span class="p">),</span> 
            <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a id = fuvE></a></p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="example-using-fuv-data">
<h1>4. Example using FUV data<a class="headerlink" href="#example-using-fuv-data" title="Permalink to this heading">#</a></h1>
<p>Let’s go through doing all of the above with an FUV dataset and corresponding FUV <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>.</p>
<p>First download the FUV data; we’ll select an FUV/G160M/C1533 dataset from the same proposal as the NUV dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Querying the PID&#39;s data</span>
<span class="n">pl</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span>
                        <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span>
                            <span class="n">proposal_id</span><span class="o">=</span><span class="mi">15869</span><span class="p">,</span> 
                            <span class="n">obs_id</span><span class="o">=</span><span class="s1">&#39;LE4B01040&#39;</span><span class="p">))</span>

<span class="c1"># Getting only the RAWTAG, ASN, and X1DSUM files</span>
<span class="n">masked_pl</span> <span class="o">=</span> <span class="n">pl</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">pl</span><span class="p">[</span><span class="s1">&#39;productSubGroupDescription&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;RAWTAG_A&#39;</span><span class="p">,</span> <span class="s1">&#39;RAWTAG_B&#39;</span><span class="p">,</span> <span class="s1">&#39;ASN&#39;</span><span class="p">,</span> <span class="s1">&#39;X1DSUM&#39;</span><span class="p">])]</span>

<span class="c1"># Now download the files</span>
<span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span><span class="n">masked_pl</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>We gather a list of all the <code class="docutils literal notranslate"><span class="pre">_rawtag</span></code> files we have downloaded, as well as the <code class="docutils literal notranslate"><span class="pre">_asnfile</span></code> and <code class="docutils literal notranslate"><span class="pre">_x1dsum</span></code> file:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rawtags_a</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;./mastDownload/HST/le4b01*/**/*_rawtag_a.fits&#39;</span><span class="p">,</span> 
                      <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">rawtags_b</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;./mastDownload/HST/le4b01*/**/*_rawtag_b.fits&#39;</span><span class="p">,</span> 
                      <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">rawtags_ab</span> <span class="o">=</span> <span class="n">rawtags_a</span> <span class="o">+</span> <span class="n">rawtags_b</span>

<span class="n">asnfile</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;./mastDownload/HST/le4b01040/**/*_asn.fits&#39;</span><span class="p">,</span> 
                    <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">old_x1dsum</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;./mastDownload/HST/le4b01040/**/*_x1dsum.fits&#39;</span><span class="p">,</span> 
                       <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Move the files and index them again:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Aggregate all this FUV data, except the calibrated x1dsum</span>
<span class="n">fdatadir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./fuv_data/&#39;</span><span class="p">)</span> 
<span class="n">fdatadir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rta</span><span class="p">,</span> <span class="n">fdatadir</span> <span class="o">/</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">rta</span><span class="p">))</span> <span class="k">for</span> <span class="n">rta</span> <span class="ow">in</span> <span class="n">rawtags_a</span><span class="p">]</span>
<span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rtb</span><span class="p">,</span> <span class="n">fdatadir</span> <span class="o">/</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">rtb</span><span class="p">))</span> <span class="k">for</span> <span class="n">rtb</span> <span class="ow">in</span> <span class="n">rawtags_b</span><span class="p">]</span>

<span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">asnfile</span><span class="p">,</span> <span class="n">fdatadir</span> <span class="o">/</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">asnfile</span><span class="p">))</span>

<span class="c1"># Re-find all the data now that it&#39;s moved</span>
<span class="n">rawtags_a</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fdatadir</span><span class="o">/</span><span class="s1">&#39;*_rawtag_a.fits&#39;</span><span class="p">),</span> 
                      <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">rawtags_b</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fdatadir</span><span class="o">/</span><span class="s1">&#39;*_rawtag_b.fits&#39;</span><span class="p">),</span> 
                      <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">rawtags_ab</span> <span class="o">=</span> <span class="n">rawtags_a</span> <span class="o">+</span> <span class="n">rawtags_b</span>

<span class="n">asnfile</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fdatadir</span><span class="o">/</span><span class="s1">&#39;*_asn.fits&#39;</span><span class="p">),</span> 
                    <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p><strong>We need to see where the FUV spectra fall in order to determine where we should place the extraction boxes.</strong></p>
<p>We’ll first plot this as a 2D image of the raw counts.
We select and plot the raw counts data from the 0th <code class="docutils literal notranslate"><span class="pre">rawtag_a</span></code> and <code class="docutils literal notranslate"><span class="pre">rawtag_b</span></code> files:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find the data from the first rawtag_a/b file</span>
<span class="n">rtda</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">rawtags_a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">rtdb</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">rawtags_b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Creating our figure</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                               <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">ax0</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">rtdb</span><span class="p">[</span><span class="s1">&#39;RAWX&#39;</span><span class="p">],</span> <span class="n">rtdb</span><span class="p">[</span><span class="s1">&#39;RAWY&#39;</span><span class="p">],</span> 
            <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
            <span class="n">c</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">rtda</span><span class="p">[</span><span class="s1">&#39;RAWX&#39;</span><span class="p">],</span> <span class="n">rtda</span><span class="p">[</span><span class="s1">&#39;RAWY&#39;</span><span class="p">],</span> 
            <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
            <span class="n">c</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>

<span class="n">ax0</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Segment FUVB&quot;</span><span class="p">,</span> 
              <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Segment FUVA&quot;</span><span class="p">,</span> 
              <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">ax0</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Dispersion axis Pixel&#39;</span><span class="p">,</span>
               <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Dispersion axis Pixel&#39;</span><span class="p">,</span>
               <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cross-dispersion axis Pixel&#39;</span><span class="p">,</span> 
               <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Fig 4.1</span><span class="se">\n</span><span class="s2">2D spectrum of all raw (unfiltered) counts&quot;</span><span class="p">,</span> 
             <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">plotsdir</span> <span class="o">/</span> <span class="s1">&#39;fuv_2Dspectrum.png&#39;</span><span class="p">),</span>
            <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>We now need to download the correct <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>.</strong></p>
<p>The next cell tells you what this <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code> <em>should</em> be, and you download it in the cell that follows. Make sure these filenames match, as the reference files may have changed since this tutorial was created.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">correct_fuv_1dx</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">rawtags_a</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="s1">&#39;XTRACTAB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Make sure the next line is set to download: &quot;</span><span class="p">,</span> <span class="n">correct_fuv_1dx</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span><span class="w"> </span>crds<span class="w"> </span>sync<span class="w"> </span>--files<span class="o">=</span>2bj2256il_1dx.fits
</pre></div>
</div>
</div>
</div>
<p><strong>Now we can plot the original fuv boxes:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Getting our XTRACTAB reference file for the FUV</span>
<span class="n">fuv_xtractab</span> <span class="o">=</span> <span class="n">lref</span> <span class="o">+</span> <span class="n">correct_fuv_1dx</span>

<span class="n">read_bounds</span> <span class="o">=</span> <span class="n">readxtractab</span><span class="p">(</span><span class="n">fuv_xtractab</span><span class="p">,</span>
                           <span class="n">grat</span><span class="o">=</span><span class="s1">&#39;G160M&#39;</span><span class="p">,</span>
                           <span class="n">cw</span><span class="o">=</span><span class="mi">1533</span><span class="p">,</span>
                           <span class="n">aper</span><span class="o">=</span><span class="s1">&#39;PSA&#39;</span><span class="p">)</span>

<span class="c1"># Setting up a figure with two subplots, top being FUVA and bottom being FUVB</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                               <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
                               <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Getting an image of the raw counts (RAWTAG A)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">rtda</span><span class="p">[</span><span class="s1">&#39;RAWX&#39;</span><span class="p">],</span> <span class="n">rtda</span><span class="p">[</span><span class="s1">&#39;RAWY&#39;</span><span class="p">],</span>
            <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>

<span class="c1"># Getting an image of the raw counts (RAWTAG B)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">rtdb</span><span class="p">[</span><span class="s1">&#39;RAWX&#39;</span><span class="p">],</span> <span class="n">rtdb</span><span class="p">[</span><span class="s1">&#39;RAWY&#39;</span><span class="p">],</span>
            <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>

<span class="c1"># Plotting the boxes for FUVA and FUVB (not background)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="c1"># If it&#39;s the FUVB box:</span>
    <span class="k">if</span> <span class="s1">&#39;A&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">box_names_fuv</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">read_bounds</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">read_bounds</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cm&#39;</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">hatch</span><span class="o">=</span><span class="s1">&#39;/+x+x&#39;</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">box_names_fuv</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="c1"># If it&#39;s the FUVA box</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">read_bounds</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">read_bounds</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cm&#39;</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">hatch</span><span class="o">=</span><span class="s1">&#39;/+x+x&#39;</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">box_names_fuv</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="c1"># Add plot formatting</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

<span class="n">ax0</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">920</span><span class="p">,</span> <span class="mi">15450</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">700</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ax0</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">())</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Dispersion axis Pixel&#39;</span><span class="p">,</span>
               <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span>
         <span class="s1">&#39;Cross-dispersion axis Pixel&#39;</span><span class="p">,</span>
         <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
         <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Fig 4.2</span><span class="se">\n</span><span class="s2">2D spectrum of all raw (unfiltered) counts</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
             <span class="s2">&quot;with original extraction boxes in the FUV&quot;</span><span class="p">,</span>
             <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># Save the figure to the plots directory</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">plotsdir</span> <span class="o">/</span> <span class="s1">&#39;2D_spec_orig_boxes_fuv.png&#39;</span><span class="p">),</span>
            <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Here we make the edits to the FUV <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># These will be the values we set the box params to:</span>
<span class="c1"># Centers of the background extract regions</span>
<span class="n">intercept_dict_fuv</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;bbkg1a&quot;</span><span class="p">:</span> <span class="mf">550.</span><span class="p">,</span> <span class="s2">&quot;bbkg2a&quot;</span><span class="p">:</span> <span class="mf">340.</span><span class="p">,</span>
                      <span class="s2">&quot;bbkg1b&quot;</span><span class="p">:</span> <span class="mf">350.</span><span class="p">,</span> <span class="s2">&quot;bbkg2b&quot;</span><span class="p">:</span> <span class="mf">665.</span><span class="p">,</span>
                      <span class="c1"># Centers of NUV stripe extract regions</span>
                      <span class="s1">&#39;bspa&#39;</span><span class="p">:</span> <span class="mf">415.</span><span class="p">,</span> <span class="s1">&#39;bspb&#39;</span><span class="p">:</span> <span class="mf">469.</span><span class="p">}</span>

<span class="n">hgt_dict_fuv</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;h_a&#39;</span><span class="p">:</span> <span class="mi">51</span><span class="p">,</span> <span class="s1">&#39;h_b&#39;</span><span class="p">:</span> <span class="mi">41</span><span class="p">}</span>

<span class="c1"># Now edit using the edit_xtractab() function</span>
<span class="n">edit_xtractab</span><span class="p">(</span><span class="n">xtractab</span><span class="o">=</span><span class="n">fuv_xtractab</span><span class="p">,</span>
              <span class="n">gratlist</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;G160M&#39;</span><span class="p">],</span>
              <span class="n">cwlist</span><span class="o">=</span><span class="p">[</span><span class="mi">1533</span><span class="p">],</span>
              <span class="n">h_dict</span><span class="o">=</span><span class="n">hgt_dict_fuv</span><span class="p">,</span>
              <span class="n">b_dict</span><span class="o">=</span><span class="n">intercept_dict_fuv</span><span class="p">,</span>
              <span class="n">new_filename</span><span class="o">=</span><span class="s1">&#39;./edit_fuv_1dx.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>We’ll create a plot showing the old and new extraction boxes side-by-side:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Original boxes</span>
<span class="n">read_bounds</span> <span class="o">=</span> <span class="n">readxtractab</span><span class="p">(</span><span class="n">fuv_xtractab</span><span class="p">,</span>
                           <span class="n">grat</span><span class="o">=</span><span class="s1">&#39;G160M&#39;</span><span class="p">,</span>
                           <span class="n">cw</span><span class="o">=</span><span class="mi">1533</span><span class="p">,</span>
                           <span class="n">aper</span><span class="o">=</span><span class="s1">&#39;PSA&#39;</span><span class="p">)</span>

<span class="c1"># Edited boxes</span>
<span class="n">read_bounds_fuv_edit</span> <span class="o">=</span> <span class="n">readxtractab</span><span class="p">(</span><span class="s1">&#39;./edit_fuv_1dx.fits&#39;</span><span class="p">,</span>
                                    <span class="n">grat</span><span class="o">=</span><span class="s1">&#39;G160M&#39;</span><span class="p">,</span>
                                    <span class="n">cw</span><span class="o">=</span><span class="mi">1533</span><span class="p">,</span>
                                    <span class="n">aper</span><span class="o">=</span><span class="s1">&#39;PSA&#39;</span><span class="p">)</span>

<span class="c1"># Orig = ax0, ax1; New/Edited = ax2, ax3</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">),</span> <span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                                             <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
                                             <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># The original:</span>
<span class="c1"># Images of the raw counts:</span>
<span class="c1"># RAWTAG A</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">rtda</span><span class="p">[</span><span class="s1">&#39;RAWX&#39;</span><span class="p">],</span> <span class="n">rtda</span><span class="p">[</span><span class="s1">&#39;RAWY&#39;</span><span class="p">],</span>
            <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>

<span class="c1"># RAWTAG B</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">rtdb</span><span class="p">[</span><span class="s1">&#39;RAWX&#39;</span><span class="p">],</span> <span class="n">rtdb</span><span class="p">[</span><span class="s1">&#39;RAWY&#39;</span><span class="p">],</span>
            <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>

<span class="c1"># RAWTAG A</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">rtda</span><span class="p">[</span><span class="s1">&#39;RAWX&#39;</span><span class="p">],</span> <span class="n">rtda</span><span class="p">[</span><span class="s1">&#39;RAWY&#39;</span><span class="p">],</span>
            <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>

<span class="c1"># RAWTAG B</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">rtdb</span><span class="p">[</span><span class="s1">&#39;RAWX&#39;</span><span class="p">],</span> <span class="n">rtdb</span><span class="p">[</span><span class="s1">&#39;RAWY&#39;</span><span class="p">],</span>
            <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>

<span class="c1"># Add all the boxes onto each subplots&#39; image</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">oldbox</span><span class="p">,</span> <span class="n">newbox</span><span class="p">,</span> <span class="n">bname</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">read_bounds</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">read_bounds_fuv_edit</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">box_names_fuv</span><span class="p">[:</span><span class="mi">2</span><span class="p">])):</span>
    <span class="c1"># FUVA in ax0, ax1 (top left/right)</span>
    <span class="k">if</span> <span class="s1">&#39;A&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bname</span><span class="p">:</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">oldbox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">oldbox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cmkyky&#39;</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">hatch</span><span class="o">=</span><span class="s1">&#39;/+x+x&#39;</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">bname</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">newbox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">newbox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cmkyky&#39;</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">hatch</span><span class="o">=</span><span class="s1">&#39;/+x+x&#39;</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">bname</span><span class="p">)</span>

    <span class="c1"># FUVB in ax2, ax3 (bottom left/right)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">oldbox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">oldbox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cmkyky&#39;</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">hatch</span><span class="o">=</span><span class="s1">&#39;/+x+x&#39;</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">bname</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">newbox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">newbox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cmkyky&#39;</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">hatch</span><span class="o">=</span><span class="s1">&#39;/+x+x&#39;</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">bname</span><span class="p">)</span>

<span class="c1"># Add plot formatting</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

<span class="n">ax0</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">920</span><span class="p">,</span> <span class="mi">15450</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">700</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ax0</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">())</span>

<span class="n">ax0</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original extraction boxes&quot;</span><span class="p">,</span>
              <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edited extraction boxes&quot;</span><span class="p">,</span>
              <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;Cross-dispersion axis Pixel&#39;</span><span class="p">,</span>
         <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
         <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.45</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="s1">&#39;Dispersion axis Pixel&#39;</span><span class="p">,</span>
         <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Fig 4.3</span><span class="se">\n</span><span class="s2">2D spectrum of all raw (unfiltered) counts</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
             <span class="s2">&quot;with original and edited extraction boxes in the FUV&quot;</span><span class="p">,</span>
             <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># Saving the figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">plotsdir</span> <span class="o">/</span> <span class="s1">&#39;2D_spec_origedit_boxes_fuv.png&#39;</span><span class="p">),</span>
            <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Before we could run CalCOS on this file with the new <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>, (or <em>any</em> <code class="docutils literal notranslate"><span class="pre">BOXCAR</span></code> extraction file, for that matter,) you must change the relevant calibration switches in the file’s primary fits header to…</strong></p>
<ol class="arabic simple">
<li><p>perform a <code class="docutils literal notranslate"><span class="pre">BOXCAR</span></code> extraction</p></li>
<li><p>use the newly edited <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code> file.</p></li>
</ol>
<p>We must set the switches as follows in the Table:</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Header Keyword</p></th>
<th class="head"><p>Possible Values</p></th>
<th class="head"><p>Value to set in order to apply this <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code></p></th>
<th class="head"><p>What does it tell CalCOS to do?</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">XTRCTALG</span></code></p></td>
<td><p><strong><code class="docutils literal notranslate"><span class="pre">BOXCAR</span></code></strong>/<code class="docutils literal notranslate"><span class="pre">TWOZONE</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">BOXCAR</span></code></p></td>
<td><p>Which extraction method to apply</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">TRCECORR</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">PERFORM</span></code>/<strong><code class="docutils literal notranslate"><span class="pre">OMIT</span></code></strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">OMIT</span></code></p></td>
<td><p>Whether to perform or omit the <a class="reference external" href="https://hst-docs.stsci.edu/cosdhb/chapter-3-cos-calibration/3-4-descriptions-of-spectroscopic-calibration-steps#id-3.4DescriptionsofSpectroscopicCalibrationSteps-3.4.14TRCECORR:ApplyTraceCorrection">trace correction</a></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ALGNCORR</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">PERFORM</span></code>/<strong><code class="docutils literal notranslate"><span class="pre">OMIT</span></code></strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">OMIT</span></code></p></td>
<td><p>Whether to perform or omit the <a class="reference external" href="https://hst-docs.stsci.edu/cosdhb/chapter-3-cos-calibration/3-4-descriptions-of-spectroscopic-calibration-steps#id-3.4DescriptionsofSpectroscopicCalibrationSteps-3.4.15ALGNCORR:AlignmentCorrection">align correction</a></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code></p></td>
<td><p>Local path to any valid <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code> file</p></td>
<td><p>./edit_fuv_1dx.fits</p></td>
<td><p>Where to find a local copy of the <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code> to use</p></td>
</tr>
</tbody>
</table>
</div>
<p>We set the switches below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dictionary we&#39;ll use to set the values of the header calib switches</span>
<span class="n">fuv_keys_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;XTRCTALG&#39;</span><span class="p">:</span> <span class="s1">&#39;BOXCAR&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TRCECORR&#39;</span><span class="p">:</span> <span class="s1">&#39;OMIT&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ALGNCORR&#39;</span><span class="p">:</span> <span class="s1">&#39;OMIT&#39;</span><span class="p">,</span>
    <span class="s1">&#39;XTRACTAB&#39;</span><span class="p">:</span> <span class="s1">&#39;./edit_fuv_1dx.fits&#39;</span><span class="p">}</span>

<span class="c1"># Change this to True if you want to see the changes</span>
<span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Loop through the rawtag A/B files</span>
<span class="k">for</span> <span class="n">rawtag</span> <span class="ow">in</span> <span class="n">rawtags_ab</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;changing header switches for &quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">rawtag</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">fuv_key</span><span class="p">,</span> <span class="n">fuv_val</span> <span class="ow">in</span> <span class="n">fuv_keys_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Originally: &quot;</span><span class="p">,</span> <span class="n">fuv_key</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">rawtag</span><span class="p">)[</span><span class="n">fuv_key</span><span class="p">])</span>

        <span class="c1"># Change the value of the FITS file</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">rawtag</span><span class="p">,</span>
                    <span class="n">keyword</span><span class="o">=</span><span class="n">fuv_key</span><span class="p">,</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">fuv_val</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">       Now: &quot;</span><span class="p">,</span> <span class="n">fuv_key</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">rawtag</span><span class="p">)[</span><span class="n">fuv_key</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p><strong>You may now run <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> using this new FUV <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>.</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span> cap --no-stderr
<span class="c1"># Above ^ capture the output and save it in the next cell</span>

<span class="c1"># Checking if there&#39;s output already</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outputdir</span> <span class="o">/</span> <span class="s2">&quot;calcos_fuv_run1&quot;</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">outputdir</span> <span class="o">/</span> <span class="s2">&quot;calcos_fuv_run1&quot;</span><span class="p">)</span>

<span class="c1"># This line actually runs the pipeline:</span>
<span class="n">calcos</span><span class="o">.</span><span class="n">calcos</span><span class="p">(</span><span class="n">asnfile</span><span class="p">,</span>
              <span class="n">verbosity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
              <span class="n">outdir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">outputdir</span> <span class="o">/</span> <span class="s2">&quot;calcos_fuv_run1&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This file now contains the output of the last cell</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">outputdir</span><span class="o">/</span><span class="s1">&#39;output_calcos_fuv_1.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Now let’s compare the FUV spectra extracted with the original and new <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>s:</strong></p>
<p><em>Note</em> again, that we can ignore the UnitsWarning.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up figure</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

<span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                      <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Use i,j to plot FUVA on the right, not the left, by inverting subplot index</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
    <span class="n">ax0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>

    <span class="c1"># Get the new and old flux/wavelength data to be plotted</span>
    <span class="n">new_wvln</span><span class="p">,</span> <span class="n">new_flux</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;./output/calcos_fuv_run1/le4b01040_x1dsum.fits&#39;</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;WAVELENGTH&#39;</span><span class="p">,</span> <span class="s1">&#39;FLUX&#39;</span><span class="p">]</span>
    <span class="n">old_wvln</span><span class="p">,</span> <span class="n">old_flux</span><span class="p">,</span> <span class="n">seg</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">old_x1dsum</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;WAVELENGTH&#39;</span><span class="p">,</span> <span class="s1">&#39;FLUX&#39;</span><span class="p">,</span> <span class="s1">&#39;SEGMENT&#39;</span><span class="p">]</span>

    <span class="c1"># Interpolate the new wvln onto the old wvln&#39;s sampling:</span>
    <span class="n">new_flux_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">new_wvln</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">new_flux</span><span class="p">,</span>
                               <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)(</span><span class="n">old_wvln</span><span class="p">)</span>

    <span class="c1"># Print the max difference</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stripe </span><span class="si">{</span><span class="n">seg</span><span class="si">}</span><span class="s2"> differs by up to: </span><span class="se">\</span>
<span class="s2">    </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">new_flux</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">old_flux</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">old_flux</span><span class="p">))</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

    <span class="c1"># Plotting the upper panel</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">new_wvln</span><span class="p">,</span> <span class="n">new_flux</span><span class="p">,</span>
             <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
             <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
             <span class="n">c</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$New$ extracted spectrum&#39;</span><span class="p">)</span>

    <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">old_wvln</span><span class="p">,</span> <span class="n">old_flux</span><span class="p">,</span>
             <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
             <span class="n">c</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span>
             <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span>
             <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$Original$ extracted spectrum&#39;</span><span class="p">)</span>

    <span class="c1"># Plotting the lower panel</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">new_wvln</span><span class="p">,</span> <span class="n">old_flux</span> <span class="o">-</span> <span class="n">new_flux_interp</span><span class="p">,</span>
             <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Residual&#39;</span><span class="p">)</span>

    <span class="c1"># Some formatting:</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Segment </span><span class="si">{</span><span class="n">seg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                  <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

    <span class="n">ax0</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>

    <span class="n">ax0</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower center&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower center&#39;</span><span class="p">)</span>

    <span class="c1"># Add axis labels to the plot</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Flux\n[$erg\ \AA^{-1}\ cm^{-2}\ s^{-1}$]&quot;</span><span class="p">,</span>
                       <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Wavelength&quot;</span><span class="p">,</span>
                   <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Fig 4.4</span><span class="se">\n</span><span class="s2">Comparing the old and new extracted spectra for each segment in the FUV&quot;</span><span class="p">,</span>
             <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># Saving the figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">plotsdir</span> <span class="o">/</span> <span class="s2">&quot;comp_fuv_extracted.png&quot;</span><span class="p">),</span>
            <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="in-conclusion">
<h1>In conclusion<a class="headerlink" href="#in-conclusion" title="Permalink to this heading">#</a></h1>
<ul class="simple">
<li><p>We have learned what the <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code> file is and how it affects your calibration of COS spectra</p></li>
<li><p>We have learned how to edit your <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code> to tailor how <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> extracts the spectrum of the source and background</p></li>
<li><p>We have shown examples of changing the <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code> and reprocessing the data with the altered extraction boxes in both the FUV and NUV</p></li>
</ul>
<section id="congratulations-you-finished-this-notebook">
<h2>Congratulations! You finished this Notebook!<a class="headerlink" href="#congratulations-you-finished-this-notebook" title="Permalink to this heading">#</a></h2>
<section id="there-are-more-cos-data-walkthrough-notebooks-on-different-topics-you-can-find-them-here">
<h3>There are more COS data walkthrough Notebooks on different topics. You can find them <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/tree/main/notebooks/COS">here</a>.<a class="headerlink" href="#there-are-more-cos-data-walkthrough-notebooks-on-different-topics-you-can-find-them-here" title="Permalink to this heading">#</a></h3>
</section>
</section>
<hr class="docutils" />
<section id="about-this-notebook">
<h2>About this Notebook<a class="headerlink" href="#about-this-notebook" title="Permalink to this heading">#</a></h2>
<p><strong>Author:</strong> Nat Kerman <a class="reference external" href="mailto:nkerman&#37;&#52;&#48;stsci&#46;edu">nkerman<span>&#64;</span>stsci<span>&#46;</span>edu</a></p>
<p><strong>Contributors:</strong> Elaine Mae Frazer</p>
<p><strong>Updated On:</strong> 2023-07-27</p>
<blockquote>
<div><p><em>This tutorial was generated to be in compliance with the <a class="reference external" href="https://github.com/spacetelescope/style-guides">STScI style guides</a> and would like to cite the <a class="reference external" href="https://github.com/spacetelescope/style-guides/blob/master/templates/example_notebook.ipynb">Jupyter guide</a> in particular.</em></p>
</div></blockquote>
</section>
<section id="citations">
<h2>Citations<a class="headerlink" href="#citations" title="Permalink to this heading">#</a></h2>
<p>If you use <code class="docutils literal notranslate"><span class="pre">astropy</span></code>, <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code>, <code class="docutils literal notranslate"><span class="pre">astroquery</span></code>, or <code class="docutils literal notranslate"><span class="pre">numpy</span></code> for published research, please cite the
authors. Follow these links for more information about citations:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.astropy.org/en/stable/index.html">Citing <code class="docutils literal notranslate"><span class="pre">astropy</span></code></a></p></li>
<li><p><a class="reference external" href="https://numpy.org/citing-numpy/">Citing <code class="docutils literal notranslate"><span class="pre">numpy</span></code></a></p></li>
<li><p><a class="reference external" href="https://matplotlib.org/">Citing <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code></a></p></li>
<li><p><a class="reference external" href="https://astroquery.readthedocs.io/en/latest/">Citing <code class="docutils literal notranslate"><span class="pre">astroquery</span></code></a></p></li>
</ul>
<hr class="docutils" />
<p><span class="xref myst">Top of Page</span>
<a class="reference internal" href="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png"><img alt="Space Telescope Logo" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="width: 200px;" /></a></p>
<p><br></br>
<br></br>
<br></br></p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/hst_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/COS/Extract"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../LSF/LSF.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Working with the COS Line Spread Function (LSF)</p>
      </div>
    </a>
    <a class="right-next"
       href="../../DrizzlePac/README.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">DrizzlePac Jupyter Notebook Tutorials</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Editing the extraction boxes in a spectral extraction file (<code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">0. Introduction</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#we-will-import-the-following-packages">We will import the following packages:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#we-will-also-define-a-few-directories-we-will-need">We will also define a few directories we will need:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#and-we-will-need-to-download-the-data-we-wish-to-work-with">And we will need to download the data we wish to work with:</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#investigating-the-exposure">1. Investigating the exposure</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-the-xtractab-and-examining-a-2d-spectrum">1.1. Understanding the <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code> and examining a 2D spectrum</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#if-you-have-an-existing-lref-directory-with-a-cache-of-reference-files"><strong>If you have an existing <code class="docutils literal notranslate"><span class="pre">lref</span></code> directory with a cache of reference files:</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#if-you-do-not-have-an-existing-lref-directory-with-a-cache-of-reference-files"><strong>If you DO NOT have an existing <code class="docutils literal notranslate"><span class="pre">lref</span></code> directory with a cache of reference files:</strong></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-some-useful-functions">1.2. Defining some useful functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#examining-the-extraction-boxes">1.3. Examining the extraction boxes</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#editing-the-extraction-boxes">2. Editing the extraction boxes</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-an-editing-function">2.1. Defining an editing function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#making-the-edits">2.2. Making the edits</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#confirming-the-changes">2.3. Confirming the changes</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-calcos-pipeline-with-the-new-xtractab">3. Running the CalCOS Pipeline with the new <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#editing-the-xtractab-header-value">3.1. Editing the <code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code> header value</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-pipeline">3.2. Running the pipeline</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#example-using-fuv-data">4. Example using FUV data</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#in-conclusion">In conclusion</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#congratulations-you-finished-this-notebook">Congratulations! You finished this Notebook!</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#there-are-more-cos-data-walkthrough-notebooks-on-different-topics-you-can-find-them-here">There are more COS data walkthrough Notebooks on different topics. You can find them here.</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#citations">Citations</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>