

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Modifying or Creating an Association File &#8212; HST Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=ac02cc09edc035673794" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/table.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794" />
  <script src="../../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=ac02cc09edc035673794"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/COS/AsnFile/AsnFile';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Running the COS Data Pipeline (CalCOS)" href="../CalCOS/CalCOS.html" />
    <link rel="prev" title="Viewing COS Data" href="../ViewData/ViewData.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../index.html">
                    STScI HST Notebook Repository HQ
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">ACS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../ACS/README.html">ACS Notebooks</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_findsat_mrt/acs_findsat_mrt_example.html">Satellite trail detection in ACS/WFC data using acstools.findsat_mrt</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_saturation_trails/acs_saturation_trails.html">ACS Linearity with Saturated Stars</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_cte_forward_model/acs_cte_forward_model_example.html">Pixel-based ACS/WFC CTE Forward Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_subarrays/acs_subarrays.html">ACS Image Reduction for Subarray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_sbc_dark_analysis/acs_sbc_dark_analysis.html">SBC Dark Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_reduction/acs_reduction.html">ACS/WFC Image Reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_pixel_area_maps/acs_pixel_area_maps.html">Obtaining Pixel Area Maps for ACS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ACS/acs_polarization_tools/acs_polarization_tools.html">Using ACS Polarization Tools</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">COS</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../README.html">COS Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Setup/Setup.html">Setting up your computer environment for working with COS data</a></li>





<li class="toctree-l1"><a class="reference internal" href="../DataDl/DataDl.html">Downloading COS Data</a></li>




<li class="toctree-l1"><a class="reference internal" href="../ViewData/ViewData.html">Viewing COS Data</a></li>





<li class="toctree-l1 current active"><a class="current reference internal" href="#">Modifying or Creating an Association File</a></li>





<li class="toctree-l1"><a class="reference internal" href="../CalCOS/CalCOS.html">Running the COS Data Pipeline (<code class="docutils literal notranslate"><span class="pre">CalCOS</span></code>)</a></li>






<li class="toctree-l1"><a class="reference internal" href="../SplitTag/SplitTag.html">Splitting COS Exposures into sub-exposures with <code class="docutils literal notranslate"><span class="pre">splittag</span></code></a></li>







<li class="toctree-l1"><a class="reference internal" href="../DayNight/DayNight.html">Filtering out COS Data taken during the Day or Night</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LSF/LSF.html">Working with the COS Line Spread Function (LSF)</a></li>

<li class="toctree-l1"><a class="reference internal" href="../Extract/Extract.html">Editing the extraction boxes in a spectral extraction file (<code class="docutils literal notranslate"><span class="pre">XTRACTAB</span></code>)</a></li>







</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">DrizzlePac</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/README.html">DrizzlePac Jupyter Notebook Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/Initialization/Initialization.html">DrizzlePac Initialization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_to_catalogs/align_to_catalogs.html">Aligning HST images to an absolute reference catalog</a></li>



<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_multiple_visits/align_multiple_visits.html">Optimizing Image Alignment for Multiple HST Visits</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/align_sparse_fields/align_sparse_fields.html">Aligning Deep Exposures of Sparse Fields</a></li>








<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/drizzle_wfpc2/drizzle_wfpc2.html">Drizzling WFPC2 Images to use a Single Zeropoint</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/mask_satellite/mask_satellite.html">Satellite Trail Masking Techniques</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/optimize_image_sampling/optimize_image_sampling.html">Optimizing the Image Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DrizzlePac/using_updated_astrometry_solutions/using_updated_astrometry_solutions.html">Using updated astrometry solutions</a></li>


</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NICMOS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NICMOS/nicmos_unit_conversion/nicmos_unit_conversion.html">Programmatic Replacements for NICMOS Units Conversion Form</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">STIS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../STIS/README.html">STIS-Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/cross-correlation/cross-correlation.html">Correcting for Missing Wavecals with Cross-Correlation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/custom_ccd_darks/custom_ccd_darks.html">Custom CCD Darks <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/drizpac_notebook/STIS_DrizzlePac_Tutorial.html">STIS DrizzlePac Tutorial <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/CoronagraphyViz/STIS_Coronagraphy_Visualization_v2.html">STIS Coronagraphy Visualization Tool (v2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/calstis/calstis_2d_ccd.html">Calstis 2-D CCD Data Reduction <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/target_acquisition/target_acquisition.html">Evaluating STIS Target Acquisitions <a class="tocSkip"></a></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/view_data/view_data.html">Viewing STIS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../STIS/extraction/1D_Extraction.html">1D Spectra Extraction <a class="tocSkip"></a></a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">WFC3</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../WFC3/README.html">WFC3Library</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/spacetelescope/hst_notebooks/blob/main/notebooks/COS/AsnFile/AsnFile.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/hst_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/hst_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/COS/AsnFile/AsnFile.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/COS/AsnFile/AsnFile.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Modifying or Creating an Association File</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Modifying or Creating an Association File</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">0. Introduction</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#we-will-import-the-following-packages">We will import the following packages:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#we-will-also-define-a-few-directories-we-will-need">We will also define a few directories we will need:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#and-we-will-need-to-download-the-data-we-wish-to-filter-and-analyze">And we will need to download the data we wish to filter and analyze</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#examining-an-association-file">1. Examining an association file</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#editing-an-existing-association-file">2. Editing an existing association file</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-an-exposure">2.1. Removing an exposure</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-a-bad-exposure">2.1.1. Removing a bad exposure</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-1-comparison-of-fluxes-between-the-data-retrieved-from-mast-and-the-same-data-reprocessed-after-removing-the-bad-exposure">Figure 1. Comparison of fluxes between the data retrieved from MAST, and the same data reprocessed after removing the bad exposure</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#filtering-to-a-single-exposure-e-g-for-lp6-data">2.1.2. Filtering to a single exposure (e.g. for LP6 data)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-an-exposure">2.2. Adding an exposure</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-an-entirely-new-association-file">3. Creating an entirely new association file</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simplest-method">3.1. Simplest method</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#with-fits-header-metadata">3.2. With FITS header metadata</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#association-files-for-non-tagflash-datasets">3.3. Association files for non-TAGFLASH datasets</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#table-1-comparison-of-wavelength-calibration-modes">Table 1. Comparison of wavelength calibration modes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gathering-the-exposure-information">3.3.1. Gathering the exposure information</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-the-split-wavecal-association-file">3.3.2. Creating the <code class="docutils literal notranslate"><span class="pre">SPLIT</span></code> wavecal association file</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#congratulations-you-finished-this-notebook">Congratulations! You finished this Notebook!</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#citations">Citations</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <p><a id="topAF"></a></p>
<section class="tex2jax_ignore mathjax_ignore" id="modifying-or-creating-an-association-file">
<h1>Modifying or Creating an Association File<a class="headerlink" href="#modifying-or-creating-an-association-file" title="Permalink to this heading">#</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="learning-goals">
<h1>Learning Goals<a class="headerlink" href="#learning-goals" title="Permalink to this heading">#</a></h1>
<p><font size="4"> This Notebook is designed to walk the user (<em>you</em>) through: <b>Creating or altering the association (<tt>asn</tt>) file used by the Cosmic Origins Spectrograph (<em>COS</em>) pipeline to determine which data to process:</b> </font><br></p>
<p><strong>1. <span class="xref myst">Examining an association file</span></strong></p>
<p><strong>2. <span class="xref myst">Editing an existing association file</span></strong></p>
<p>- 2.1. <span class="xref myst">Removing an exposure</span></p>
<p>+ 2.1.1. <span class="xref myst">Removing a bad exposure</span></p>
<p>+ 2.1.2. <span class="xref myst">Filtering to a single exposure (e.g. for LP6 data)</span></p>
<p>- 2.2. <span class="xref myst">Adding an exposure</span></p>
<p><strong>3. <span class="xref myst">Creating an entirely new association file</span></strong></p>
<p>- 3.1. <span class="xref myst">Simplest method</span></p>
<p>- 3.2. <span class="xref myst">With FITS header metadata</span></p>
<p>- 3.3. <span class="xref myst">Association files for non-TAGFLASH datasets</span></p>
<p>+ 3.3.1. <span class="xref myst">Gathering the exposure information</span></p>
<p>+ 3.3.2. <span class="xref myst">Creating the <code class="docutils literal notranslate"><span class="pre">SPLIT</span></code> wavecal association file</span></p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="introduction">
<h1>0. Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h1>
<p><strong>The Cosmic Origins Spectrograph (<a class="reference external" href="https://www.nasa.gov/content/hubble-space-telescope-cosmic-origins-spectrograph"><em>COS</em></a>) is an ultraviolet spectrograph on-board the Hubble Space Telescope (<a class="reference external" href="https://www.stsci.edu/hst/about"><em>HST</em></a>) with capabilities in the near ultraviolet (<em>NUV</em>) and far ultraviolet (<em>FUV</em>).</strong></p>
<p><strong>This tutorial aims to prepare you to alter the association file used by the <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> pipeline.</strong> Association files are <code class="docutils literal notranslate"><span class="pre">fits</span></code> files containing a binary table extension, which list their “member” files: science and calibration exposures which the pipeline will process together into spectral data products.</p>
<ul class="simple">
<li><p>For an in-depth manual to working with COS data and a discussion of caveats and user tips, see the <a class="reference external" href="https://hst-docs.stsci.edu/display/COSDHB/">COS Data Handbook</a>.</p></li>
<li><p>For a detailed overview of the COS instrument, see the <a class="reference external" href="https://hst-docs.stsci.edu/display/COSIHB/">COS Instrument Handbook</a>.</p></li>
</ul>
<p>We’ll demonstrate creating an <code class="docutils literal notranslate"><span class="pre">asn</span></code> file in three ways: First, we’ll demonstrate <span class="xref myst">editing an existing <code class="docutils literal notranslate"><span class="pre">asn</span></code> file to add or remove an exposure</span>. Second, we’ll show how to <span class="xref myst">create an entirely new <code class="docutils literal notranslate"><span class="pre">asn</span></code> file</span>. Finally, we’ll show an example of <span class="xref myst">creating an <code class="docutils literal notranslate"><span class="pre">asn</span></code> file for use with SPLIT wavecal data</span>, such as that obtained at COS lifetime position 6 (LP6).</p>
<section id="we-will-import-the-following-packages">
<h2>We will import the following packages:<a class="headerlink" href="#we-will-import-the-following-packages" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">numpy</span></code> to handle array functions</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">astropy.io</span> <span class="pre">fits</span></code> and <code class="docutils literal notranslate"><span class="pre">astropy.table</span> <span class="pre">Table</span></code> for accessing FITS files</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">glob</span></code>, <code class="docutils literal notranslate"><span class="pre">os</span></code>, and <code class="docutils literal notranslate"><span class="pre">shutil</span></code> for working with system files</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">glob</span></code> helps us search for filenames</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">os</span></code> and <code class="docutils literal notranslate"><span class="pre">shutil</span></code> for moving files and deleting folders, respectively</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">astroquery.mast</span> <span class="pre">Mast</span></code> and <code class="docutils literal notranslate"><span class="pre">Observations</span></code> for finding and downloading data from the <a class="reference external" href="https://mast.stsci.edu/portal/Mashup/Clients/Mast/Portal.html">MAST</a> archive</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">datetime</span></code> for updating FITS headers with today’s date</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pathlib</span> <span class="pre">Path</span></code> for managing system paths</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pandas</span></code> for data table manipulation</p></li>
</ul>
<p>If you have an existing astroconda environment, it may or may not already have the necessary packages to run this Notebook. To create a Python environment capable of running all the data analyses in these COS Notebooks, please see Section 1 of our Notebook tutorial on <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/blob/main/notebooks/COS/Setup/Setup.ipynb">setting up an environment</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">astroquery.mast</span> <span class="kn">import</span> <span class="n">Observations</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="we-will-also-define-a-few-directories-we-will-need">
<h2>We will also define a few directories we will need:<a class="headerlink" href="#we-will-also-define-a-few-directories-we-will-need" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># These will be important directories for the Notebook</span>
<span class="n">datadir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./data/&#39;</span><span class="p">)</span>
<span class="n">outputdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./output/&#39;</span><span class="p">)</span>
<span class="n">plotsdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./output/plots/&#39;</span><span class="p">)</span>

<span class="c1"># Make the directories if they don&#39;t already exist</span>
<span class="n">datadir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">outputdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plotsdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Made the following directories:&quot;</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &quot;</span><span class="p">,</span>
      <span class="sa">f</span><span class="s1">&#39;./</span><span class="si">{</span><span class="n">datadir</span><span class="si">}</span><span class="s1">, ./</span><span class="si">{</span><span class="n">outputdir</span><span class="si">}</span><span class="s1">, ./</span><span class="si">{</span><span class="n">plotsdir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="and-we-will-need-to-download-the-data-we-wish-to-filter-and-analyze">
<h2>And we will need to download the data we wish to filter and analyze<a class="headerlink" href="#and-we-will-need-to-download-the-data-we-wish-to-filter-and-analyze" title="Permalink to this heading">#</a></h2>
<p>We choose the exposures with the association obs_ids: <code class="docutils literal notranslate"><span class="pre">ldif01010</span></code> and <code class="docutils literal notranslate"><span class="pre">ldif02010</span></code> because we happen to know that some of the exposures in these groups failed, which gives us a real-world use case for editing an association file. Both <code class="docutils literal notranslate"><span class="pre">ldif01010</span></code> and <code class="docutils literal notranslate"><span class="pre">ldif02010</span></code> are far-ultraviolet (FUV) datasets on the quasi-stellar object (QSO) <a class="reference external" href="https://doi.org/10.1051/0004-6361/201935524">PDS 456</a>.</p>
<p>For more information on downloading COS data, see our <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/blob/main/notebooks/COS/DataDl/DataDl.ipynb">Notebook tutorial on downloading COS data</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Search for the correct obs_ids and get the product list</span>
<span class="n">pl</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span>
                            <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span>
                                <span class="n">obs_id</span><span class="o">=</span><span class="s1">&#39;ldif0*10&#39;</span><span class="p">))</span>

<span class="c1"># filter to rawtag and asn files in the product list</span>
<span class="n">fpl</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">filter_products</span><span class="p">(</span>
                    <span class="n">pl</span><span class="p">,</span>
                    <span class="n">productSubGroupDescription</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RAWTAG_A&#39;</span><span class="p">,</span> <span class="s1">&#39;RAWTAG_B&#39;</span><span class="p">,</span> <span class="s1">&#39;ASN&#39;</span><span class="p">])</span>

<span class="c1"># Download these chosen products</span>
<span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span>
                            <span class="n">fpl</span><span class="p">,</span>
                            <span class="n">download_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">datadir</span><span class="p">))</span>

<span class="c1"># Move all FITS files in this set to the base data directory</span>
<span class="k">for</span> <span class="n">gfile</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;**/ldif*/*.fits&quot;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">gfile</span><span class="p">,</span> <span class="n">datadir</span> <span class="o">/</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">gfile</span><span class="p">))</span>

<span class="c1"># Delete the now-empty, nested mastDownload directory</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">datadir</span> <span class="o">/</span> <span class="s1">&#39;mastDownload&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a id = examAF></a></p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="examining-an-association-file">
<h1>1. Examining an association file<a class="headerlink" href="#examining-an-association-file" title="Permalink to this heading">#</a></h1>
<p>Association files are lists of “member” files - science and wavelength calibration exposures - which the <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> pipeline will process together.
Above, we downloaded two association files and the rawtag data files which are their members. We will begin by searching for the association files and reading one of them (with observation ID <code class="docutils literal notranslate"><span class="pre">LDIF01010</span></code>). We could just as easily pick <code class="docutils literal notranslate"><span class="pre">ldif02010</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># There will be two (ldif01010_asn.fits and ldif02010_asn.fits)</span>
<span class="n">asnfiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;**/*ldif*asn*&quot;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="c1"># We want to work primarily with ldif01010_asn.fits</span>
<span class="n">asnfile</span> <span class="o">=</span> <span class="n">asnfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Gets the contents of the asn file</span>
<span class="n">asn_contents</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">asnfile</span><span class="p">)</span>

<span class="c1"># Display these contents</span>
<span class="n">asn_contents</span>
</pre></div>
</div>
</div>
</div>
<p>The association file has three columns: <code class="docutils literal notranslate"><span class="pre">MEMNAME</span></code>, <code class="docutils literal notranslate"><span class="pre">MEMTYPE</span></code>, <code class="docutils literal notranslate"><span class="pre">MEMPRSNT</span></code> which we describe below. More information can be found in <a class="reference external" href="https://hst-docs.stsci.edu/cosdhb/chapter-3-cos-calibration">Section 3 of the COS Data Handbook</a>.</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MEMNAME</span></code> (<em>short for “member name”</em>): The rootname of the file, e.g. <code class="docutils literal notranslate"><span class="pre">ldif01u0q</span></code> for the file <code class="docutils literal notranslate"><span class="pre">ldif01u0q_rawtag_a.fits</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MEMTYPE</span></code> (<em>“membership type”</em>): Whether the item is a science exposure (<code class="docutils literal notranslate"><span class="pre">EXP-FP</span></code>), a wavecal exposure (<code class="docutils literal notranslate"><span class="pre">EXP-SWAVE</span></code>/<code class="docutils literal notranslate"><span class="pre">EXP-GWAVE</span></code>/<code class="docutils literal notranslate"><span class="pre">EXP-AWAVE</span></code>), or the output product (<code class="docutils literal notranslate"><span class="pre">PROD-FP</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MEMPRSNT</span></code> (<em>“member present”</em>): Whether to include the file in <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code>’ processing</p></li>
</ol>
<p>We also see that this association file has five rows: four science exposures denoted with the <code class="docutils literal notranslate"><span class="pre">MEMTYPE</span></code> = <code class="docutils literal notranslate"><span class="pre">EXP-FP</span></code>, and an output product with <code class="docutils literal notranslate"><span class="pre">MEMTYPE</span></code> = <code class="docutils literal notranslate"><span class="pre">PROD-FP</span></code>.</p>
<p>In the cell below, we examine a bit about each of the exposures as a diagnostic:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Cycles through each file in asn table</span>
<span class="k">for</span> <span class="n">memname</span><span class="p">,</span> <span class="n">memtype</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">asn_contents</span><span class="p">[</span><span class="s1">&#39;MEMNAME&#39;</span><span class="p">],</span> <span class="n">asn_contents</span><span class="p">[</span><span class="s2">&quot;MEMTYPE&quot;</span><span class="p">]):</span>
    <span class="c1"># Find file names in lower case letters</span>
    <span class="n">memname</span> <span class="o">=</span> <span class="n">memname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="c1"># We only want to look at the exposure files</span>
    <span class="k">if</span> <span class="n">memtype</span> <span class="o">==</span> <span class="s1">&#39;EXP-FP&#39;</span><span class="p">:</span>
        <span class="c1"># Find the actual filepath of the memname for rawtag_a and rawtag_b</span>
        <span class="n">rt_a</span> <span class="o">=</span> <span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**/*</span><span class="si">{</span><span class="n">memname</span><span class="si">}</span><span class="s2">*rawtag_a*&quot;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rt_b</span> <span class="o">=</span> <span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**/*</span><span class="si">{</span><span class="n">memname</span><span class="si">}</span><span class="s2">*rawtag_b*&quot;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Now print all these diagnostics:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Association </span><span class="si">{</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">rt_a</span><span class="p">))[</span><span class="s1">&#39;ASN_ID&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> has </span><span class="si">{</span><span class="n">memtype</span><span class="si">}</span><span class="s2"> &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;exposure </span><span class="si">{</span><span class="n">memname</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> with exptime &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">rt_a</span><span class="p">,</span><span class="w"> </span><span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">))[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;sec at cenwave </span><span class="si">{</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">rt_a</span><span class="p">,</span><span class="w"> </span><span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="s1">&#39;CENWAVE&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
              <span class="sa">f</span><span class="s2">&quot;Å and FP-POS </span><span class="si">{</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">rt_a</span><span class="p">,</span><span class="w"> </span><span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="s1">&#39;FPPOS&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>We notice that something seems amiss with the science exposure LDIF01TYQ</strong>:
This file has an exposure time of 0.0 seconds - something has gone wrong. In this case, there was a guide star acquisition failure as described on the <a class="reference external" href="http://archive.stsci.edu/cgi-bin/mastpreview?mission=hst&amp;dataid=LDIF01010">data preview page</a>.</p>
<p>In the next section, we will correct this lack of data by removing the bad exposure and combining in exposures from the other association group.</p>
<p><a id = editAF></a></p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="editing-an-existing-association-file">
<h1>2. Editing an existing association file<a class="headerlink" href="#editing-an-existing-association-file" title="Permalink to this heading">#</a></h1>
<p><a id = subAF></a></p>
<section id="removing-an-exposure">
<h2>2.1. Removing an exposure<a class="headerlink" href="#removing-an-exposure" title="Permalink to this heading">#</a></h2>
<p><a id = removebadAF></a></p>
<section id="removing-a-bad-exposure">
<h3>2.1.1. Removing a bad exposure<a class="headerlink" href="#removing-a-bad-exposure" title="Permalink to this heading">#</a></h3>
<p>We know that at least one of our exposures - <code class="docutils literal notranslate"><span class="pre">ldif01tyq</span></code> - is not suited for combination into the final product. It has an exposure time of 0.0 seconds, in this case from a guide star acquisition failure. This is a generalizable issue, as you may often know an exposure is “<em>bad</em>” for many reasons: perhaps it was taken with the shutter closed, or with anomolously high background noise, or any number of reasons we may wish to exclude an exposure from our data. To do this, we will need to alter our existing association file before we re-run <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code>. Afterwards we will compare the flux of the resulting spectrum made without the bad exposure to the same dataset with the bad exposure. The flux levels should match closely.</p>
<p>We again see the contents of our main association file below. Note that <code class="docutils literal notranslate"><span class="pre">True/False</span></code> and <code class="docutils literal notranslate"><span class="pre">1/0</span></code> are essentially interchangable in the <code class="docutils literal notranslate"><span class="pre">MEMPRSNT</span></code> column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">asnfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>We can set the <code class="docutils literal notranslate"><span class="pre">MEMPRSNT</span></code> value to <code class="docutils literal notranslate"><span class="pre">False</span></code> or <code class="docutils literal notranslate"><span class="pre">0</span></code> for our bad exposure. If we were to run the <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> pipeline on the edited association file, it would not be processed. <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> can take a long time to run. To avoid slowing down this Notebook, the code to run <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> on the association files we have created has been spun out into <code class="docutils literal notranslate"><span class="pre">Python</span></code> files in this directory with the names <code class="docutils literal notranslate"><span class="pre">test_&lt;type</span> <span class="pre">of</span> <span class="pre">association</span> <span class="pre">file&gt;.py</span></code> (in this case, <code class="docutils literal notranslate"><span class="pre">test_removed_exposure_asn.py</span></code>). If you wish to re-run the analysis within, you will need to specify a valid cache of CRDS reference files (see our <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/blob/main/notebooks/COS/Setup/Setup.ipynb">Setup Notebook</a> for details on downloading reference files) in the <code class="docutils literal notranslate"><span class="pre">Python</span></code> file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We need to change values with the asnfile opened and in &#39;update&#39; mode</span>
<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">asnfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;update&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdulist</span><span class="p">:</span>
    <span class="c1"># This is where the table data is read into</span>
    <span class="n">tbdata</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="c1"># Check if each file is one of the bad ones</span>
    <span class="k">for</span> <span class="n">expfile</span> <span class="ow">in</span> <span class="n">tbdata</span><span class="p">:</span>
        <span class="c1"># If so, set MEMPRSNT to False AKA 0</span>
        <span class="k">if</span> <span class="n">expfile</span><span class="p">[</span><span class="s1">&#39;MEMNAME&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;LDIF01TYQ&#39;</span><span class="p">]:</span>
            <span class="n">expfile</span><span class="p">[</span><span class="s1">&#39;MEMPRSNT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Copy this file we will edit, in case we want to run CalCOS on it.</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">asnfile</span><span class="p">,</span> <span class="n">datadir</span> <span class="o">/</span> <span class="s2">&quot;removed_badfile_asn.fits&quot;</span><span class="p">)</span>

<span class="c1"># Re-read the table to see the change</span>
<span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">asnfile</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>To show what would happen if we run <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> on this association file, we include Figure 1. This figure shows that the flux level of the spectrum retrieved from MAST matches that which was processed after removing the bad exposure. Slight differences in the two spectra may arise from MAST using a different random seed value. What matters for this comparison is that the fluxes match well, as they should because the empty exposure adds 0 counts over 0 time. Thus, for the purposes of flux calibration, it should be ignored. Other types of bad exposures, for instance those taken with the source at the edge of COS’s aperture, would impact the fluxes.</p>
</section>
<section id="figure-1-comparison-of-fluxes-between-the-data-retrieved-from-mast-and-the-same-data-reprocessed-after-removing-the-bad-exposure">
<h3>Figure 1. Comparison of fluxes between the data retrieved from MAST, and the same data reprocessed after removing the bad exposure<a class="headerlink" href="#figure-1-comparison-of-fluxes-between-the-data-retrieved-from-mast-and-the-same-data-reprocessed-after-removing-the-bad-exposure" title="Permalink to this heading">#</a></h3>
<img src=./figures/compare_fluxes_after_removing_badfile.png width=60% title='Comparison of fluxes' alt='A comparison between the fluxes of our data. One dataset if without our bad exposure removed, and the other is with our bad exposure removed. Both plots are relatively the same, as they should be.'><p><a id = removefiltAF></a></p>
<section id="filtering-to-a-single-exposure-e-g-for-lp6-data">
<h4>2.1.2. Filtering to a single exposure (e.g. for LP6 data)<a class="headerlink" href="#filtering-to-a-single-exposure-e-g-for-lp6-data" title="Permalink to this heading">#</a></h4>
<p>Another situation when users often wish to remove exposures from an association file is when re-processing individual exposures taken at COS’s lifetime position 6 (LP6) or other modes at which the wavelength calibration data is not contained by the science exposures’ <code class="docutils literal notranslate"><span class="pre">rawtag</span></code> files.</p>
<p>Often users wish to process a single exposure’s file with <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code>. With the <a class="reference external" href="https://hst-docs.stsci.edu/cosihb/chapter-5-spectroscopy-with-cos/5-7-internal-wavelength-calibration-exposures#id-5.7InternalWavelengthCalibrationExposures-Section5.7.15.7.1ConcurrentWavelengthCalibrationwithTAGFLASH"><code class="docutils literal notranslate"><span class="pre">TAGFLASH</span></code> wavelength calibration method</a> standard at all lifetime positions prior to LP6, the wavelength calibration data was taken concurrently with the science data and was contained by the same <code class="docutils literal notranslate"><span class="pre">rawtag</span></code> data files. However, as described in this <a class="reference external" href="https://aas240-aas.ipostersessions.com/default.aspx?s=06-68-AE-28-CC-4A-12-7A-B0-4F-02-46-BC-D1-BE-7E">COS 2030 plan poster</a>, this is not possible at LP6. Instead, separate wavelength calibration exposures are taken at separate lifetime positions in a process known as <a class="reference external" href="https://hst-docs.stsci.edu/cosihb/chapter-5-spectroscopy-with-cos/5-7-internal-wavelength-calibration-exposures#id-5.7InternalWavelengthCalibrationExposures-Section5.7.65.7.6SPLITWavecals(defaultnon-concurrentwavelengthcalibrationatLP6)">SPLIT wavecals</a>. As a result, the wavelength calibration data no longer exists in the same file as the science data for such exposures.</p>
<p>For <code class="docutils literal notranslate"><span class="pre">TAGFLASH</span></code> data, users could run <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> directly on their <code class="docutils literal notranslate"><span class="pre">rawtag</span></code> file of interest (though using an association file was always recommended). However, doing so with LP6 data would not allow the proper wavelength calibration. Instead, users should create a custom association file created by removing exposures from the default association file. We demonstrate this below.</p>
<p>We’ll alter an LP6 association file with the observation ID <code class="docutils literal notranslate"><span class="pre">letc01010</span></code>.
Let’s begin by downloading the default LP6 association file from MAST and displaying it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Search for the correct obs_ids and get the list of data products</span>
<span class="n">lp6_observation_products</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span>
                                <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span>
                                    <span class="n">obs_id</span><span class="o">=</span><span class="s1">&#39;letc01010&#39;</span><span class="p">),</span>
<span class="p">)</span>

<span class="c1"># Download the asnfile product list, then get the 0th element of the</span>
<span class="c1"># resulting path list, since there&#39;s only 1 asn file</span>
<span class="n">lp6_original_asnfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
    <span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span>
        <span class="n">Observations</span><span class="o">.</span><span class="n">filter_products</span><span class="p">(</span>
            <span class="n">lp6_observation_products</span><span class="p">,</span>
            <span class="n">productSubGroupDescription</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ASN&#39;</span><span class="p">],</span>
        <span class="p">),</span>
        <span class="n">download_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">datadir</span><span class="p">)</span>
    <span class="p">)[</span><span class="s1">&#39;Local Path&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Show the default association file for the LP6 dataset.</span>
<span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">lp6_original_asnfile</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>As expected, we see 4 <code class="docutils literal notranslate"><span class="pre">EXP-FP</span></code> members, which are the science exposures at COS’s 4 <a class="reference external" href="https://hst-docs.stsci.edu/cosdhb/chapter-1-cos-overview/1-1-instrument-capabilities-and-design">fixed-pattern noise positions (<code class="docutils literal notranslate"><span class="pre">FP-POS</span></code>)</a>. Each is bracketed by a SPLIT wavecal wavelength calibration exposure on each side (<code class="docutils literal notranslate"><span class="pre">EXP-SWAVE</span></code>).</p>
<p>If we only wish to process one of the science exposures, (along with its wavelength calibration exposures,) we turn off all the other exposures by setting their <code class="docutils literal notranslate"><span class="pre">MEMPRSNT</span></code> values to 0/<code class="docutils literal notranslate"><span class="pre">False</span></code>. The product file (<code class="docutils literal notranslate"><span class="pre">PROD-FP</span></code>) must also be turned on, and should be renamed to show that it will only include data from a single exposure. Below, we do so, assuming we wish to process only the <code class="docutils literal notranslate"><span class="pre">FP-POS</span> <span class="pre">=</span> <span class="pre">3</span></code> science exposure: <code class="docutils literal notranslate"><span class="pre">LETC01MTQ</span></code> (and its wavelength calibration exposures: <code class="docutils literal notranslate"><span class="pre">LETC01M6Q</span></code> and <code class="docutils literal notranslate"><span class="pre">LETC01MVQ</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># WAVECAL -&gt; SCIENCE -&gt; WAVECAL</span>
<span class="n">exposures_to_use</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LETC01M6Q&#39;</span><span class="p">,</span> <span class="s1">&#39;LETC01MTQ&#39;</span><span class="p">,</span> <span class="s1">&#39;LETC01MVQ&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;We will turn off the input exposures except for: </span><span class="si">{</span><span class="n">exposures_to_use</span><span class="si">}</span><span class="s2">.&quot;</span>
      <span class="sa">f</span><span class="s2">&quot; We will also leave the output product file turned on.&quot;</span><span class="p">)</span>

<span class="c1"># Make a copy of the original asn file with a name to</span>
<span class="c1"># indicate it will only process a single chosen exposure:</span>
<span class="n">lp6_1exposure_asnfile</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">lp6_original_asnfile</span><span class="p">,</span>
                                    <span class="n">datadir</span> <span class="o">/</span> <span class="s1">&#39;letc01mtq_only_asn.fits&#39;</span><span class="p">)</span>

<span class="c1"># Turn off all the other exposures in the copy</span>
<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">lp6_1exposure_asnfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;update&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdulist</span><span class="p">:</span>
    <span class="n">tbdata</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="c1"># Turn off files except those listed here</span>
    <span class="k">for</span> <span class="n">expfile</span> <span class="ow">in</span> <span class="n">tbdata</span><span class="p">:</span>
        <span class="c1"># If file isn&#39;t what we&#39;re going to use, set MEMPRSNT to False AKA 0</span>
        <span class="k">if</span> <span class="n">expfile</span><span class="p">[</span><span class="s1">&#39;MEMNAME&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exposures_to_use</span><span class="p">:</span>
            <span class="n">expfile</span><span class="p">[</span><span class="s1">&#39;MEMPRSNT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Turn on and rename the product file to indicate</span>
        <span class="c1"># it will only include the chosen exposure:</span>
        <span class="k">if</span> <span class="n">expfile</span><span class="p">[</span><span class="s1">&#39;MEMTYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PROD-FP&#39;</span><span class="p">:</span>
            <span class="c1"># Turn on the product file</span>
            <span class="n">expfile</span><span class="p">[</span><span class="s1">&#39;MEMPRSNT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># Rename the product file</span>
            <span class="n">expfile</span><span class="p">[</span><span class="s1">&#39;MEMNAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;LETC01MTQ_only&quot;</span>

<span class="c1"># Re-read the table to see the change</span>
<span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">lp6_1exposure_asnfile</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a id = addAF></a></p>
</section>
</section>
</section>
<section id="adding-an-exposure">
<h2>2.2. Adding an exposure<a class="headerlink" href="#adding-an-exposure" title="Permalink to this heading">#</a></h2>
<p>In section 2.1.1, we removed the failed exposure taken with <code class="docutils literal notranslate"><span class="pre">FP-POS</span> <span class="pre">=</span> <span class="pre">1</span></code> from our <code class="docutils literal notranslate"><span class="pre">ldif01010</span></code> association file. When possible, we usually want to combine one or more of each of the four FP-POS types. In this example scenario, let’s add the <code class="docutils literal notranslate"><span class="pre">FP-POS</span> <span class="pre">=</span> <span class="pre">1</span></code> exposure from the other association group. Please note that combining data from separate visits with different target acquisitions can result in true errors which are higher than those calculated by <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code>.
We combine the datasets here as an example only and do not specifically endorse combining these exposures.
Also note that you should only combine files taken using the same grating and central wavelength settings in this manner.</p>
<p>In the cell below, we determine which exposure from <code class="docutils literal notranslate"><span class="pre">LDIF02010</span></code> was taken with <code class="docutils literal notranslate"><span class="pre">FP-POS</span> <span class="pre">=</span> <span class="pre">1</span></code>.</p>
<ul class="simple">
<li><p><em>It does this by looping through the files listed in <code class="docutils literal notranslate"><span class="pre">LDIF02010</span></code>’s association file, and then reading in that file’s header to check if its <code class="docutils literal notranslate"><span class="pre">FPPOS</span> <span class="pre">=</span> <span class="pre">1</span></code>.</em></p></li>
<li><p><em>It also prints some diagnostic information about all of the exposure files.</em></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reads the contents of the 2nd asn file</span>
<span class="n">asn_con_2</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">asnfiles</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># Loops through each file in asn table for `LDIF02010`</span>
<span class="k">for</span> <span class="n">memname</span><span class="p">,</span> <span class="n">memtype</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">asn_con_2</span><span class="p">[</span><span class="s1">&#39;MEMNAME&#39;</span><span class="p">],</span> <span class="n">asn_con_2</span><span class="p">[</span><span class="s2">&quot;MEMTYPE&quot;</span><span class="p">]):</span>
    <span class="c1"># Convert file names to lower case letters, as in actual filenames</span>
    <span class="n">memname</span> <span class="o">=</span> <span class="n">memname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="c1"># We only want to look at the exposure files</span>
    <span class="k">if</span> <span class="n">memtype</span> <span class="o">==</span> <span class="s1">&#39;EXP-FP&#39;</span><span class="p">:</span>
        <span class="c1"># Search for the actual filepath of the memname for rawtag_a &amp; rawtag_b</span>
        <span class="n">rt_a</span> <span class="o">=</span> <span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**/*</span><span class="si">{</span><span class="n">memname</span><span class="si">}</span><span class="s2">*rawtag_a*&quot;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rt_b</span> <span class="o">=</span> <span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**/*</span><span class="si">{</span><span class="n">memname</span><span class="si">}</span><span class="s2">*rawtag_b*&quot;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Now print all these diagnostics:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Association </span><span class="si">{</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">rt_a</span><span class="p">))[</span><span class="s1">&#39;ASN_ID&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> has </span><span class="si">{</span><span class="n">memtype</span><span class="si">}</span><span class="s2"> &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;exposure </span><span class="si">{</span><span class="n">memname</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> with &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;exptime </span><span class="si">{</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">rt_a</span><span class="p">,</span><span class="w"> </span><span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">))[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> seconds&quot;</span>
              <span class="sa">f</span><span class="s2">&quot; at cenwave </span><span class="si">{</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">rt_a</span><span class="p">,</span><span class="w"> </span><span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="s1">&#39;CENWAVE&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> Å and &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;FP-POS </span><span class="si">{</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">rt_a</span><span class="p">,</span><span class="w"> </span><span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="s1">&#39;FPPOS&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="c1"># Checking if the file is FP-POS = 1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">rt_a</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="s1">&#39;FPPOS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;^^ The one above this has the FP-POS &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;we are looking for (</span><span class="si">{</span><span class="n">memname</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">)^^^</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Save the right file basename in a variable</span>
            <span class="n">asn2_fppos1_name</span> <span class="o">=</span> <span class="n">memname</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>There’s a slightly different procedure to add a new exposure to the list rather than remove one.</p>
<p>Here we will read the table in the FITS association file into an <code class="docutils literal notranslate"><span class="pre">astropy</span></code> Table. We can then add a row into the right spot, filling it with the new file’s <code class="docutils literal notranslate"><span class="pre">MEMNAME</span></code>, <code class="docutils literal notranslate"><span class="pre">MEMTYPE</span></code>, and <code class="docutils literal notranslate"><span class="pre">MEMPRSNT</span></code>. Finally, we have to save this table into the existing FITS association file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read in original data from the file</span>
<span class="n">asn_orig_table</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">asnfile</span><span class="p">)</span>

<span class="c1"># Add a row with the right name after all the original EXP-FP&#39;s</span>
<span class="n">asn_orig_table</span><span class="o">.</span><span class="n">insert_row</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asn_orig_table</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">asn2_fppos1_name</span><span class="p">,</span> <span class="s1">&#39;EXP-FP&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="c1"># Turn this into a FITS Binary Table HDU</span>
<span class="n">new_table</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="p">(</span><span class="n">asn_orig_table</span><span class="p">)</span>

<span class="c1"># We need to change data with the asnfile opened and in &#39;update&#39; mode</span>
<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">asnfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;update&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdulist</span><span class="p">:</span>
    <span class="c1"># Change the orig file&#39;s data to the new table data we made</span>
    <span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">new_table</span><span class="o">.</span><span class="n">data</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added </span><span class="si">{</span><span class="n">asn2_fppos1_name</span><span class="si">}</span><span class="s2"> to the association file.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, we can see there is a new row with our exposure from the other <code class="docutils literal notranslate"><span class="pre">asn</span></code> file group: <code class="docutils literal notranslate"><span class="pre">LDIF02NMQ</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">asnfile</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><font size="4 "><b>Excellent.</b> In the next section we will create a new association file from scratch.</font></p>
<p><a id = newAF></a></p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="creating-an-entirely-new-association-file">
<h1>3. Creating an entirely new association file<a class="headerlink" href="#creating-an-entirely-new-association-file" title="Permalink to this heading">#</a></h1>
<p>Users will rarely need to create an entirely new association file. Much more often, they should alter an existing one found on MAST. However, a user may wish to create a new association file if they are combining altered exposures, perhaps after using the <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/blob/main/notebooks/COS/SplitTag/SplitTag.ipynb"><code class="docutils literal notranslate"><span class="pre">costools.splittag</span></code> tool</a>. This section describes how to make one from scratch.</p>
<p>For the sake of demonstration, we will generate a new association file with four exposure members: even-numbered <code class="docutils literal notranslate"><span class="pre">FP-POS</span></code> (2,4) from the first original association (<code class="docutils literal notranslate"><span class="pre">LDIF01010</span></code>), and odd-numbered <code class="docutils literal notranslate"><span class="pre">FP-POS</span></code> (1,3) from from the second original association (<code class="docutils literal notranslate"><span class="pre">LDIF02010</span></code>).</p>
<p>From <span class="xref myst">Section 2</span>, we see that this corresponds to :</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Original asn</p></th>
<th class="head"><p>FP-POS</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>LDIF02010</p></td>
<td><p>LDIF02NMQ</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>LDIF01010</p></td>
<td><p>LDIF01U0Q</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-even"><td><p>LDIF02010</p></td>
<td><p>LDIF02NUQ</p></td>
<td><p>3</p></td>
</tr>
<tr class="row-odd"><td><p>LDIF01010</p></td>
<td><p>LDIF01U4Q</p></td>
<td><p>4</p></td>
</tr>
</tbody>
</table>
<p><a id = simpleAF></a></p>
<section id="simplest-method">
<h2>3.1. Simplest method<a class="headerlink" href="#simplest-method" title="Permalink to this heading">#</a></h2>
<p>Below, we manually build up an association file from the three necessary columns (<code class="docutils literal notranslate"><span class="pre">MEMNAME</span></code>, <code class="docutils literal notranslate"><span class="pre">MEMTYPE</span></code>, <code class="docutils literal notranslate"><span class="pre">MEMPRSNT</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Adding the exposure file details to the association table</span>
<span class="c1"># MEMNAME:</span>
<span class="n">new_asn_memnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LDIF02NMQ&#39;</span><span class="p">,</span> <span class="s1">&#39;LDIF01U0Q&#39;</span><span class="p">,</span> <span class="s1">&#39;LDIF02NUQ&#39;</span><span class="p">,</span> <span class="s1">&#39;LDIF01U4Q&#39;</span><span class="p">]</span>
<span class="c1"># MEMTYPE:</span>
<span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;EXP-FP&#39;</span><span class="p">,</span> <span class="s1">&#39;EXP-FP&#39;</span><span class="p">,</span> <span class="s1">&#39;EXP-FP&#39;</span><span class="p">,</span> <span class="s1">&#39;EXP-FP&#39;</span><span class="p">]</span>
<span class="c1"># MEMPRSNT</span>
<span class="n">included</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>

<span class="c1"># Adding the ASN details to the end of the association table</span>
<span class="c1"># MEMNAME column:</span>
<span class="n">new_asn_memnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ldifcombo&#39;</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
<span class="c1"># MEMTYPE column:</span>
<span class="n">types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;PROD-FP&#39;</span><span class="p">)</span>
<span class="c1"># MEMPRSNT column</span>
<span class="n">included</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Putting together the FITS table:</span>
<span class="c1">#   40 is the number of characters allowed in this</span>
<span class="c1">#   field with the MEMNAME format = 40A. If your rootname</span>
<span class="c1">#   is longer than 40, you will need to increase this.</span>
<span class="n">c1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;MEMNAME&#39;</span><span class="p">,</span>
                 <span class="n">array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_asn_memnames</span><span class="p">),</span>
                 <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;40A&#39;</span><span class="p">)</span>

<span class="n">c2</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;MEMTYPE&#39;</span><span class="p">,</span>
                 <span class="n">array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">types</span><span class="p">),</span>
                 <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;14A&#39;</span><span class="p">)</span>

<span class="n">c3</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;MEMPRSNT&#39;</span><span class="p">,</span>
                 <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span>
                 <span class="n">array</span><span class="o">=</span><span class="n">included</span><span class="p">)</span>

<span class="n">asn_table</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="o">.</span><span class="n">from_columns</span><span class="p">([</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">])</span>

<span class="c1"># Writing the fits table</span>
<span class="n">asn_table</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">outputdir</span> <span class="o">/</span> <span class="s1">&#39;ldifcombo_asn.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saved &#39;</span> <span class="o">+</span> <span class="s1">&#39;ldifcombo_asn.fits&#39;</span>
      <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; in the output directory: </span><span class="si">{</span><span class="n">outputdir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Examining the file we have created:</strong></p>
<p>We see that the data looks correct - exactly the table we want!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">outputdir</span> <span class="o">/</span> <span class="s1">&#39;ldifcombo_asn.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>However, the 0th and 1st fits headers no longer contain useful information about the data.</strong>
While <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> will process these files, vital header keys may not be propagated. If it’s important to preserve the header information, you may follow the steps in the next section.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">outputdir</span> <span class="o">/</span> <span class="s1">&#39;ldifcombo_asn.fits&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">outputdir</span> <span class="o">/</span> <span class="s1">&#39;ldifcombo_asn.fits&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a id = metaAF></a></p>
</section>
<section id="with-fits-header-metadata">
<h2>3.2. With FITS header metadata<a class="headerlink" href="#with-fits-header-metadata" title="Permalink to this heading">#</a></h2>
<p><strong>We can instead build up a new file with our old file’s FITS header, and alter it to reflect our changes.</strong></p>
<p>We first build a new association file, a piecewise combination of our original file’s headers and our new table.</p>
<p>A FITS header is essentially a section of data and its associated metadata. See <a class="reference external" href="https://fits.gsfc.nasa.gov/fits_primer.html">this site</a> for info on FITS structures.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Open up the old asn file</span>
<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">asnfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;readonly&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdulist</span><span class="p">:</span>
    <span class="c1"># Shows the first hdu is empty except for the header we want</span>
    <span class="n">hdulist</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
    <span class="c1"># We want to directly copy over the old 0th header/data-unit AKA &quot;hdu&quot;.</span>
    <span class="n">hdu0</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Gather the data from the header/data unit to allow the readout</span>
    <span class="n">d0</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="c1"># Gather the header from the 1st header/data unit to copy to our new file</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

<span class="c1"># Put together new 1st hdu from old header and new data</span>
<span class="n">hdu1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="o">.</span><span class="n">from_columns</span><span class="p">([</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">],</span>
                                     <span class="n">header</span><span class="o">=</span><span class="n">h1</span><span class="p">)</span>

<span class="c1"># New HDUList from old HDU 0 and new combined HDU 1</span>
<span class="n">new_HDUlist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span><span class="n">hdu0</span><span class="p">,</span> <span class="n">hdu1</span><span class="p">])</span>

<span class="c1"># Write this out to a new file</span>
<span class="n">new_HDUlist</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">outputdir</span> <span class="o">/</span> <span class="s1">&#39;ldifcombo_2_asn.fits&#39;</span><span class="p">,</span>
                    <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># Path to this new file</span>
<span class="n">new_asnfile</span> <span class="o">=</span> <span class="n">outputdir</span> <span class="o">/</span> <span class="s1">&#39;ldifcombo_2_asn.fits&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Saved &#39;</span> <span class="o">+</span> <span class="s1">&#39;ldifcombo_2_asn.fits&#39;</span>
      <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;in the output directory: </span><span class="si">{</span><span class="n">outputdir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Now we edit the relevant values in our FITS headers that are different from the original.</strong></p>
<p><em>Note: It is possible that a generic FITS file may have different values you may wish to change. It is highly recommended to examine your FITS headers.</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find today&#39;s date</span>
<span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
<span class="c1"># Below, make a dict of what header values we want to change,</span>
<span class="c1"># corresponding to [new value, ext. the value lives in, 2nd ext. if applies]</span>
<span class="n">keys_to_change</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;DATE&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">date</span><span class="o">.</span><span class="n">month</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">date</span><span class="o">.</span><span class="n">day</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                  <span class="s1">&#39;FILENAME&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;ldifcombo_2_asn.fits&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                  <span class="s1">&#39;ROOTNAME&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;ldifcombo_2&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                  <span class="s1">&#39;ASN_ID&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;ldifcombo_2&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                  <span class="s1">&#39;ASN_TAB&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;ldifcombo_2_asn.fits&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                  <span class="s1">&#39;ASN_PROD&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;False&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                  <span class="s1">&#39;EXTVER&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                  <span class="s1">&#39;EXPNAME&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;ldifcombo_2&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]}</span>

<span class="c1"># Actually change the values below (verbosely):</span>
<span class="k">for</span> <span class="n">keyval</span> <span class="ow">in</span> <span class="n">keys_to_change</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Editing </span><span class="si">{</span><span class="n">keyval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> in Extension </span><span class="si">{</span><span class="n">keyval</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">new_asnfile</span><span class="p">,</span>
                <span class="n">keyword</span><span class="o">=</span><span class="n">keyval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">value</span><span class="o">=</span><span class="n">keyval</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">ext</span><span class="o">=</span><span class="n">keyval</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="c1"># Below is necessary as some keys are repeated in both headers (&#39;ROOTNAME&#39;)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keyval</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Editing </span><span class="si">{</span><span class="n">keyval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> in Extension </span><span class="si">{</span><span class="n">keyval</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">new_asnfile</span><span class="p">,</span>
                    <span class="n">keyword</span><span class="o">=</span><span class="n">keyval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">keyval</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">ext</span><span class="o">=</span><span class="n">keyval</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p><font size="4 "><b>And now we have created our new association file.</b> The file is now ready to be used in the <code>CalCOS</code> pipeline!</font></p>
<p>If you’re interested in testing your file by running it through the <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> pipeline, you may wish to run the <code class="docutils literal notranslate"><span class="pre">test_asn.py</span> <span class="pre">file</span></code> included in this subdirectory of the GitHub repository. i.e. from the command line:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>python<span class="w"> </span>test_asn.py
</pre></div>
</div>
<p><em>Note</em> that you must first…</p>
<ol class="arabic simple">
<li><p>Have created the file by running this Notebook</p></li>
<li><p>Alter line 21 of <code class="docutils literal notranslate"><span class="pre">test_asn.py</span></code> to set the lref directory to wherever you have your cache of CRDS reference files (see our <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/blob/main/notebooks/COS/Setup/Setup.ipynb">Setup Notebook</a>).</p></li>
</ol>
<p>If the test runs successfully, it will create a plot in the subdirectory <code class="docutils literal notranslate"><span class="pre">./output/plots/</span></code> .</p>
<p><a id = nontagAF></a></p>
</section>
<section id="association-files-for-non-tagflash-datasets">
<h2>3.3. Association files for non-TAGFLASH datasets<a class="headerlink" href="#association-files-for-non-tagflash-datasets" title="Permalink to this heading">#</a></h2>
<p>As touched upon in <span class="xref myst">Section 2.1.2.</span>, most COS exposures contain the calibration lamp data necessary to perform wavelength calibration; however, exposures taken at LP6 and those taken with <a class="reference external" href="https://hst-docs.stsci.edu/cosihb/chapter-5-spectroscopy-with-cos/5-7-internal-wavelength-calibration-exposures#id-5.7InternalWavelengthCalibrationExposures-Section5.7.25.7.2AUTOWavecals(whenTAGFLASHisnotused)">AUTO and GO wavecals</a> (including BOA and ACCUM mode exposures) have separate exposures for wavelength calibration. Table 1 below summarizes the types of wavelength calibration modes. More information may be found in <a class="reference external" href="https://hst-docs.stsci.edu/cosihb/chapter-5-spectroscopy-with-cos/5-7-internal-wavelength-calibration-exposures">Section 5.7 of the COS Instrument Handbook</a>.</p>
<section id="table-1-comparison-of-wavelength-calibration-modes">
<h3>Table 1. Comparison of wavelength calibration modes<a class="headerlink" href="#table-1-comparison-of-wavelength-calibration-modes" title="Permalink to this heading">#</a></h3>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Wavelength calibration mode</strong></p></th>
<th class="head"><p></p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">TAGFLASH</span></code></p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">SPLIT</span></code> Wavecal</p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">AUTO</span></code> Wavecal</p></th>
<th class="head"><p>GO Wavecal</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>When used</strong></p></td>
<td><p></p></td>
<td><p>Default for LP1-LP5</p></td>
<td><p>Default for LP6</p></td>
<td><p>Used for LP1-LP5 non-TAGFLASH exposures</p></td>
<td><p>User specified (rare)</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Description</strong></p></td>
<td><p></p></td>
<td><p>Wavelength calibration lamp flashes concurrently with science exposure</p></td>
<td><p>Wavelength calibration lamp flashes at another LP</p></td>
<td><p>Wavelength calibration lamp flashes separately from science exposure</p></td>
<td><p>Wavelength calibration lamp flashes separately from science exposure</p></td>
</tr>
<tr class="row-even"><td><p><strong>Additional wavelength calibration file in the association table</strong></p></td>
<td><p></p></td>
<td><p>None - wavelength calibration data included in the <code class="docutils literal notranslate"><span class="pre">EXP-FP</span></code>s of the science exposures</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">EXP-SWAVE</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">EXP-AWAVE</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">EXP-GWAVE</span></code></p></td>
</tr>
</tbody>
</table>
<p>Non-<code class="docutils literal notranslate"><span class="pre">TAGFLASH</span></code> datasets must be processed from a single association file which includes all the science and wavelength calibration exposures, properly labeled with the correct <code class="docutils literal notranslate"><span class="pre">MEMTYPE</span></code>s.</p>
<p>Users will rarely need to build an entirely new association file for non-TAGFLASH datasets. The most common reason for a user to have non-TAGFLASH data is that the exposures were obtained using the <code class="docutils literal notranslate"><span class="pre">SPLIT</span></code> wavecal method at LP6. The association files for these files are correctly created and made available in the MAST archive. Removing specific exposures can most easily be done as in <span class="xref myst">Section 2.1.2</span>. However, if a user needed to craft a completely customized <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> run, for instance to combine multiple non-TAGFLASH datasets, they can follow this section.</p>
<p>In this section we will manually recreate the association file for the <code class="docutils literal notranslate"><span class="pre">SPLIT</span></code> wavecal data from the same dataset whose association file we altered as part of <span class="xref myst">Section 2.1.2</span>. We could just as easily do so with <code class="docutils literal notranslate"><span class="pre">AUTO</span></code> or GO wavecal data. We will first select and examine the relevant exposures, then we will combine them into an association file.</p>
<p><a id = 331-gathering-the-exposure-informationAF></a></p>
</section>
<section id="gathering-the-exposure-information">
<h3>3.3.1. Gathering the exposure information<a class="headerlink" href="#gathering-the-exposure-information" title="Permalink to this heading">#</a></h3>
<p>We begin by downloading the data from a visit which utilized COS’ LP6 split wavecal mode (proposal ID: <code class="docutils literal notranslate"><span class="pre">16907</span></code>, observation ID: <code class="docutils literal notranslate"><span class="pre">letc01010</span></code>). We previously downloaded the association file for this dataset in <span class="xref myst">Section 2.1.2</span>, but here we download the rest of the data products we will need.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Search for the correct obs_ids and get the list of data products</span>
<span class="n">lp6_observation_products</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span>
                                    <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span>
                                        <span class="n">obs_id</span><span class="o">=</span><span class="s1">&#39;letc01010&#39;</span><span class="p">),</span>
<span class="p">)</span>

<span class="c1"># Filter &amp; download the rawtag files and asn file in the product list from MAST</span>
<span class="c1"># First filter to just the rawtag products</span>
<span class="n">lp6_rawtags_pl</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">filter_products</span><span class="p">(</span>
                    <span class="n">lp6_observation_products</span><span class="p">,</span>
                    <span class="n">productSubGroupDescription</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RAWTAG_A&#39;</span><span class="p">,</span> <span class="s1">&#39;RAWTAG_B&#39;</span><span class="p">])</span>

<span class="c1"># Download these chosen rawtag products</span>
<span class="n">lp6_rawtags</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span>
                                    <span class="n">lp6_rawtags_pl</span><span class="p">,</span>
                                    <span class="n">download_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">datadir</span><span class="p">))[</span><span class="s1">&#39;Local Path&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We’ll begin by taking a look at the original association file from MAST in the cell below. Note that the exposures are ordered in groups of a single <code class="docutils literal notranslate"><span class="pre">EXP-FP</span></code> (also known as science or <code class="docutils literal notranslate"><span class="pre">EXTERNAL/SCI</span></code>) exposure bracketed on both sides by an <code class="docutils literal notranslate"><span class="pre">EXP-SWAVE</span></code> (<code class="docutils literal notranslate"><span class="pre">SPLIT</span></code> wavecal) exposure (i.e. <code class="docutils literal notranslate"><span class="pre">WAVECAL</span></code>–&gt; <code class="docutils literal notranslate"><span class="pre">SCIENCE</span></code> –&gt; <code class="docutils literal notranslate"><span class="pre">WAVECAL</span></code>). This is often the case for non-<code class="docutils literal notranslate"><span class="pre">TAGFLASH</span></code> files, especially for exposures longer than ~600 seconds.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">lp6_original_asnfile</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We’ll simulate an occasion on which we would need to create our own association file by supposing we want to process only data from this observation taken in the <code class="docutils literal notranslate"><span class="pre">FP-POS</span> <span class="pre">=</span> <span class="pre">1</span></code> or <code class="docutils literal notranslate"><span class="pre">FP-POS</span> <span class="pre">=</span> <span class="pre">3</span></code> configuration. We could achieve the same result by taking the default association file from MAST and turning the <code class="docutils literal notranslate"><span class="pre">MEMPRSNT</span></code> value to False for all the <code class="docutils literal notranslate"><span class="pre">FP-POS</span> <span class="pre">=</span> <span class="pre">2</span></code> and <code class="docutils literal notranslate"><span class="pre">FP-POS</span> <span class="pre">=</span> <span class="pre">4</span></code> files, similarly to in <span class="xref myst">Section 2.1.2</span>.</p>
<p>Below, we filter to such exposures and check whether they meet our expectations for <code class="docutils literal notranslate"><span class="pre">SPLIT</span></code> wavecal data. Namely, we check that:</p>
<ol class="arabic simple">
<li><p>The files are listed in chronological order.</p></li>
<li><p>All science (<code class="docutils literal notranslate"><span class="pre">EXTERNAL/SCI</span></code>) exposures are bracketed by a <code class="docutils literal notranslate"><span class="pre">WAVECAL</span></code> exposure on either side.</p></li>
<li><p>The data is organized into groups of 3 exposures with the grouping described in test 2 (<code class="docutils literal notranslate"><span class="pre">WAVECAL</span></code>–&gt;<code class="docutils literal notranslate"><span class="pre">EXTERNAL/SCI</span></code>–&gt;<code class="docutils literal notranslate"><span class="pre">WAVECAL</span></code>).</p></li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> does not strictly need the files to be arranged in chronological order; however, it is a helpful exercise to make sure we include all the files we need to calibrate this dataset. We can investigate the files manually and diagnose any failures in the table printed by the following cell.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Filter the rawtag files to exposures at FP1 and FP3</span>
<span class="n">lp6_rawtags_fp13</span> <span class="o">=</span> <span class="p">[</span><span class="n">rt</span> <span class="k">for</span> <span class="n">rt</span> <span class="ow">in</span> <span class="n">lp6_rawtags</span>
                    <span class="k">if</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="s2">&quot;FPPOS&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span>

<span class="c1"># Gather information on all the exposures</span>
<span class="n">rawtag_a_exptypes_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">rt</span><span class="p">:</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="s2">&quot;EXPTYPE&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">rt</span> <span class="ow">in</span> <span class="n">lp6_rawtags_fp13</span> <span class="k">if</span> <span class="s2">&quot;rawtag_a&quot;</span> <span class="ow">in</span> <span class="n">rt</span><span class="p">}</span>

<span class="n">rawtag_a_rootnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="s2">&quot;ROOTNAME&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">rt</span> <span class="ow">in</span> <span class="n">lp6_rawtags_fp13</span> <span class="k">if</span> <span class="s2">&quot;rawtag_a&quot;</span> <span class="ow">in</span> <span class="n">rt</span><span class="p">]</span>

<span class="n">rawtag_a_exptypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="s2">&quot;EXPTYPE&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">rt</span> <span class="ow">in</span> <span class="n">lp6_rawtags_fp13</span> <span class="k">if</span> <span class="s2">&quot;rawtag_a&quot;</span> <span class="ow">in</span> <span class="n">rt</span><span class="p">]</span>

<span class="n">rawtag_a_expstart_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="s2">&quot;EXPSTART&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">rt</span> <span class="ow">in</span> <span class="n">lp6_rawtags_fp13</span> <span class="k">if</span> <span class="s2">&quot;rawtag_a&quot;</span> <span class="ow">in</span> <span class="n">rt</span><span class="p">]</span>

<span class="c1"># Test 1</span>
<span class="c1"># Check chronological sorting</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">rawtag_a_expstart_times</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;These exposures are not ordered by start time.&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Passed Test #1: The exposures are in chronological order.&quot;</span><span class="p">)</span>

<span class="c1"># Test 2</span>
<span class="c1"># Check science exposures are bracketed by wavecals</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rta_type</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rawtag_a_exptypes</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">rta_type</span> <span class="o">==</span> <span class="s2">&quot;EXTERNAL/SCI&quot;</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">rawtag_a_exptypes</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;WAVECAL&quot;</span><span class="p">,</span> <span class="s2">&quot;EXTERNAL/SCI exposure not preceded by a WAVECAL exposure&quot;</span>
        <span class="k">assert</span> <span class="n">rawtag_a_exptypes</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;WAVECAL&quot;</span><span class="p">,</span> <span class="s2">&quot;EXTERNAL/SCI exposure not followed by a WAVECAL exposure&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Passed Test #2: Each EXTERNAL/SCI is bracketted on both sides by a WAVECAL exposure.&quot;</span><span class="p">)</span>

<span class="c1"># Test 3 </span>
<span class="c1"># Check that only these groups of exposures exist (WAVECAL--&gt;EXTERNAL/SCI--&gt;WAVECAL)</span>
<span class="k">for</span> <span class="n">group_of_3</span> <span class="ow">in</span> <span class="p">[</span><span class="n">rawtag_a_exptypes</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rawtag_a_exptypes</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">))]:</span>
    <span class="k">assert</span> <span class="n">group_of_3</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;WAVECAL&#39;</span><span class="p">,</span> <span class="s1">&#39;EXTERNAL/SCI&#39;</span><span class="p">,</span> <span class="s1">&#39;WAVECAL&#39;</span><span class="p">],</span> <span class="s2">&quot;Incorrect groupings of exposures&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Passed Test #3: No unexpected groupings of files were found.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Below, we may inspect these files by eye, and see that they are indeed ordered correctly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s2">&quot;Rootname&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">rawtag_a_rootnames</span><span class="p">],</span> 
    <span class="s2">&quot;Exposure_type&quot;</span><span class="p">:</span> <span class="n">rawtag_a_exptypes</span><span class="p">,</span>
    <span class="c1"># Date in MJD</span>
    <span class="s2">&quot;Exposure_start_date&quot;</span><span class="p">:</span> <span class="n">rawtag_a_expstart_times</span><span class="p">,</span>
    <span class="s2">&quot;Seconds_since_first_exposure&quot;</span><span class="p">:</span>\
    <span class="c1"># Convert time since the first exposure into seconds</span>
    <span class="mi">86400</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">rawtag_a_expstart_times</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">rawtag_a_expstart_times</span><span class="p">))</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>Once we are sure that the correct exposures are selected, we gather the information we need for an association table:</p>
<ul class="simple">
<li><p>The exposure ID (<code class="docutils literal notranslate"><span class="pre">ROOTNAME</span></code>) of each exposure.</p>
<ul>
<li><p>When capitalized, this is the same as the <code class="docutils literal notranslate"><span class="pre">MEMNAME</span></code> we find in association files.</p></li>
</ul>
</li>
<li><p>The exposure type (<code class="docutils literal notranslate"><span class="pre">EXPTYPE</span></code>) of each exposure.</p>
<ul>
<li><p>We will need to convert from the way that exposure types are written in the FITS header to the way <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> will recognize them in the association file.</p></li>
</ul>
</li>
</ul>
<p>To prevent duplication, we only gather this information from either the <code class="docutils literal notranslate"><span class="pre">rawtag_a</span></code> or <code class="docutils literal notranslate"><span class="pre">rawtag_b</span></code> files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Choose either rawtag_a (default) of rawtag_b files if no rawtag_a files found</span>
<span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="s2">&quot;rawtag_a&quot;</span> <span class="ow">in</span> <span class="n">rt</span> <span class="k">for</span> <span class="n">rt</span> <span class="ow">in</span> <span class="n">lp6_rawtags_fp13</span><span class="p">]):</span>
    <span class="n">seg_found</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>
<span class="k">elif</span> <span class="nb">any</span><span class="p">([</span><span class="s2">&quot;rawtag_b&quot;</span> <span class="ow">in</span> <span class="n">rt</span> <span class="k">for</span> <span class="n">rt</span> <span class="ow">in</span> <span class="n">lp6_rawtags_fp13</span><span class="p">]):</span>
    <span class="n">seg_found</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Neither rawtag_a nor rawtag_b found.&quot;</span><span class="p">)</span>

<span class="n">lp6_fp13_memnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="s2">&quot;ROOTNAME&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                     <span class="k">for</span> <span class="n">rt</span> <span class="ow">in</span> <span class="n">lp6_rawtags_fp13</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;rawtag_</span><span class="si">{</span><span class="n">seg_found</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">rt</span><span class="p">]</span>

<span class="n">lp6_fp13_exptypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="s2">&quot;EXPTYPE&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">rt</span> <span class="ow">in</span> <span class="n">lp6_rawtags_fp13</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;rawtag_</span><span class="si">{</span><span class="n">seg_found</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">rt</span><span class="p">]</span>

<span class="c1"># We need to change the wavecals&#39; MEMTYPE to &quot;EXP-SWAVE&quot;</span>
<span class="c1"># and the sciences&#39; to &quot;EXP-FP&quot;:</span>
<span class="n">lp6_fp13_exptypes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;EXP-SWAVE&quot;</span> <span class="k">if</span> <span class="n">etype</span> <span class="o">==</span> <span class="s2">&quot;WAVECAL&quot;</span>
    <span class="k">else</span> <span class="s2">&quot;EXP-FP&quot;</span> <span class="k">if</span> <span class="n">etype</span> <span class="o">==</span> <span class="s2">&quot;EXTERNAL/SCI&quot;</span>
    <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">etype</span> <span class="ow">in</span> <span class="n">lp6_fp13_exptypes</span>
<span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Gathered exposure information for creating a new non-TAGFLASH association file.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a id = 332-creating-the-split-wavecal-association-fileAF></a></p>
</section>
<section id="creating-the-split-wavecal-association-file">
<h3>3.3.2. Creating the <code class="docutils literal notranslate"><span class="pre">SPLIT</span></code> wavecal association file<a class="headerlink" href="#creating-the-split-wavecal-association-file" title="Permalink to this heading">#</a></h3>
<p>Now that we’ve gathered <code class="docutils literal notranslate"><span class="pre">MEMNAME</span></code>s and <code class="docutils literal notranslate"><span class="pre">MEMTYPE</span></code>s of our exposures, we can create the association file. This very closely mirrors <span class="xref myst">Section 3.2</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Adding the exposure file details to the association table</span>
<span class="c1"># MEMNAME:</span>
<span class="n">new_asn_memnames</span> <span class="o">=</span> <span class="n">lp6_fp13_memnames</span>
<span class="c1"># MEMTYPE</span>
<span class="n">types</span> <span class="o">=</span> <span class="n">lp6_fp13_exptypes</span>
<span class="c1"># MEMPRSNT</span>
<span class="n">included</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">lp6_fp13_memnames</span><span class="p">)</span>

<span class="c1"># Adding the output science product details to the</span>
<span class="c1"># end of the association table columns:</span>

<span class="c1"># MEMNAME column:</span>
<span class="n">new_asn_memnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;splitwave&#39;</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
<span class="c1"># MEMTYPE column:</span>
<span class="n">types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;PROD-FP&#39;</span><span class="p">)</span>
<span class="c1"># MEMPRSNT column:</span>
<span class="n">included</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Convert the columns into a the necessary form for a FITS file</span>
<span class="n">c1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;MEMNAME&#39;</span><span class="p">,</span>
                 <span class="n">array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_asn_memnames</span><span class="p">),</span>
                 <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;40A&#39;</span><span class="p">)</span>

<span class="n">c2</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;MEMTYPE&#39;</span><span class="p">,</span>
                 <span class="n">array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">types</span><span class="p">),</span>
                 <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;14A&#39;</span><span class="p">)</span>

<span class="n">c3</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;MEMPRSNT&#39;</span><span class="p">,</span>
                 <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span>
                 <span class="n">array</span><span class="o">=</span><span class="n">included</span><span class="p">)</span>

<span class="c1"># Open up the old asn file:</span>
<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">lp6_original_asnfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;readonly&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdulist</span><span class="p">:</span>
    <span class="c1"># Shows the first hdu is empty except for the header we want</span>
    <span class="n">hdulist</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
    <span class="c1"># We want to directly copy over the old 0th header/data-unit</span>
    <span class="n">hdu0</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Gather the data from the header/data unit to allow the readout</span>
    <span class="n">d0</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="c1"># Gather the header from the 1st header/data unit to copy to our new file</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

<span class="c1"># Put together new 1st hdu from old header and new data</span>
<span class="n">hdu1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="o">.</span><span class="n">from_columns</span><span class="p">([</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">],</span>
                                     <span class="n">header</span><span class="o">=</span><span class="n">h1</span><span class="p">)</span>

<span class="c1"># New HDUList from old HDU 0 and new combined HDU 1</span>
<span class="n">new_HDUlist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span><span class="n">hdu0</span><span class="p">,</span> <span class="n">hdu1</span><span class="p">])</span>

<span class="c1"># Write this out to a new file</span>
<span class="n">new_HDUlist</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">outputdir</span> <span class="o">/</span> <span class="s1">&#39;splitwave_asn.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># Path to this new file</span>
<span class="n">new_asnfile</span> <span class="o">=</span> <span class="n">outputdir</span> <span class="o">/</span> <span class="s1">&#39;splitwave_asn.fits&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Saved &#39;</span> <span class="o">+</span> <span class="s1">&#39;splitwave_asn.fits&#39;</span>
      <span class="sa">f</span><span class="s2">&quot; in the output directory: </span><span class="si">{</span><span class="n">outputdir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">outputdir</span><span class="o">/</span><span class="s2">&quot;splitwave_asn.fits&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Well done - you have now successfully created the association file you need to process your <code class="docutils literal notranslate"><span class="pre">SPLIT</span></code> wavecal data. If you wish to test it by running the <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> data calibration pipeline on it, you may run the file <code class="docutils literal notranslate"><span class="pre">test_splitwave_asn.py</span></code> in this directory. Note the following requirements:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">test_splitwave_asn.py</span></code> can only be run after creating the <code class="docutils literal notranslate"><span class="pre">asn</span></code> files in Section 3.3 of this Notebook.</p></li>
<li><p>Your version of <code class="docutils literal notranslate"><span class="pre">CalCOS</span></code> must be ≥ 3.4. This version introduced the ability to process <code class="docutils literal notranslate"><span class="pre">SPLIT</span></code> wavecal data to the pipeline. You can check your version with <code class="docutils literal notranslate"><span class="pre">calcos</span> <span class="pre">--version</span></code> from the command line.</p></li>
<li><p>You must first update the <code class="docutils literal notranslate"><span class="pre">lref</span></code> environment variable set in <code class="docutils literal notranslate"><span class="pre">test_splitwave_asn.py</span></code> to the path to a directory containing all of your reference files. For more information on setting up such a directory, see <a class="reference external" href="https://github.com/spacetelescope/hst_notebooks/blob/main/notebooks/COS/Setup/Setup.ipynb">our Notebook on setting up an environment for COS data analysis</a>.</p></li>
</ol>
</section>
</section>
<section id="congratulations-you-finished-this-notebook">
<h2>Congratulations! You finished this Notebook!<a class="headerlink" href="#congratulations-you-finished-this-notebook" title="Permalink to this heading">#</a></h2>
<p><font size="5">There are more COS data walkthrough Notebooks on different topics. You can find them <a href="https://github.com/spacetelescope/hst_notebooks/tree/main/notebooks/COS">here</a>.</font></p>
</section>
<hr class="docutils" />
<section id="about-this-notebook">
<h2>About this Notebook<a class="headerlink" href="#about-this-notebook" title="Permalink to this heading">#</a></h2>
<p><strong>Author:</strong> Nat Kerman: <a class="reference external" href="mailto:nkerman&#37;&#52;&#48;stsci&#46;edu">nkerman<span>&#64;</span>stsci<span>&#46;</span>edu</a></p>
<p><strong>Contributors:</strong> Elaine Mae Frazer, Travis Fischer</p>
<p><strong>Updated On:</strong> 2023-03-27</p>
<blockquote>
<div><p><em>This tutorial was generated to be in compliance with the <a class="reference external" href="https://github.com/spacetelescope/style-guides">STScI style guides</a> and would like to cite the <a class="reference external" href="https://github.com/spacetelescope/style-guides/blob/master/templates/example_notebook.ipynb">Jupyter guide</a> in particular.</em></p>
</div></blockquote>
</section>
<section id="citations">
<h2>Citations<a class="headerlink" href="#citations" title="Permalink to this heading">#</a></h2>
<p>If you use <code class="docutils literal notranslate"><span class="pre">astropy</span></code>, <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code>, <code class="docutils literal notranslate"><span class="pre">astroquery</span></code>, or <code class="docutils literal notranslate"><span class="pre">numpy</span></code> for published research, please cite the
authors. Follow these links for more information about citations:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.astropy.org/en/stable/index.html">Citing <code class="docutils literal notranslate"><span class="pre">astropy</span></code></a></p></li>
<li><p><a class="reference external" href="https://numpy.org/citing-numpy/">Citing <code class="docutils literal notranslate"><span class="pre">numpy</span></code></a></p></li>
<li><p><a class="reference external" href="https://matplotlib.org/">Citing <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code></a></p></li>
<li><p><a class="reference external" href="https://astroquery.readthedocs.io/en/latest/">Citing <code class="docutils literal notranslate"><span class="pre">astroquery</span></code></a></p></li>
</ul>
<hr class="docutils" />
<p><span class="xref myst">Top of Page</span>
<img style="float: right;" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" alt="Space Telescope Logo" width="200px"/></p>
<p><br></br>
<br></br>
<br></br></p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/hst_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/COS/AsnFile"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="../ViewData/ViewData.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Viewing COS Data</p>
      </div>
    </a>
    <a class="right-next"
       href="../CalCOS/CalCOS.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Running the COS Data Pipeline (<code class="docutils literal notranslate"><span class="pre">CalCOS</span></code>)</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Modifying or Creating an Association File</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">0. Introduction</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#we-will-import-the-following-packages">We will import the following packages:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#we-will-also-define-a-few-directories-we-will-need">We will also define a few directories we will need:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#and-we-will-need-to-download-the-data-we-wish-to-filter-and-analyze">And we will need to download the data we wish to filter and analyze</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#examining-an-association-file">1. Examining an association file</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#editing-an-existing-association-file">2. Editing an existing association file</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-an-exposure">2.1. Removing an exposure</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-a-bad-exposure">2.1.1. Removing a bad exposure</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-1-comparison-of-fluxes-between-the-data-retrieved-from-mast-and-the-same-data-reprocessed-after-removing-the-bad-exposure">Figure 1. Comparison of fluxes between the data retrieved from MAST, and the same data reprocessed after removing the bad exposure</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#filtering-to-a-single-exposure-e-g-for-lp6-data">2.1.2. Filtering to a single exposure (e.g. for LP6 data)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-an-exposure">2.2. Adding an exposure</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-an-entirely-new-association-file">3. Creating an entirely new association file</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simplest-method">3.1. Simplest method</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#with-fits-header-metadata">3.2. With FITS header metadata</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#association-files-for-non-tagflash-datasets">3.3. Association files for non-TAGFLASH datasets</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#table-1-comparison-of-wavelength-calibration-modes">Table 1. Comparison of wavelength calibration modes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gathering-the-exposure-information">3.3.1. Gathering the exposure information</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-the-split-wavecal-association-file">3.3.2. Creating the <code class="docutils literal notranslate"><span class="pre">SPLIT</span></code> wavecal association file</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#congratulations-you-finished-this-notebook">Congratulations! You finished this Notebook!</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#citations">Citations</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>